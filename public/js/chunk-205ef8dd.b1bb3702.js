(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-205ef8dd"],{"0bd4":function(t,o,e){"use strict";e.r(o);var a=e("e11e"),h=e.n(a),m=(e("6cc5"),e("be3b")),a=e("8fad"),a={name:"photoMap",props:{borderRadius:{default:"20px",type:String},albumId:{default:"",Type:String},libraryId:{default:"",Type:String},ordinaryAlbumId:{default:"",Type:String}},components:{albumDetail:a.default},data(){return{albumFirstPhoto:null,showPhotoGeo:!1,map:null,markerGroup:null,clickGeohash:null,selectPositionStr:"",currentMaxZoom:8,moveTimer:null}},mounted(){this.getZoomInfo(),window.addEventListener("popstate",this.onPopstate)},beforeDestroy(){window.removeEventListener("popstate",this.onPopstate)},methods:{onPopstate(){this.showPhotoGeo?(this.showPhotoGeo=!1,this.$bus.$emit("closePhotoGallery")):this.$router.go(-1)},getZoomInfo(){this.api.get("/api/mapApi/getZoom",{}).then(t=>{t.code||(this.currentMaxZoom=parseInt(t.zoomInfo.maxZoom),this.initMap(parseInt(t.zoomInfo.minZoom),parseInt(t.zoomInfo.maxZoom)))}).catch(t=>{})},initMap(t,o){var e=m.a.mapUrl,e=new h.a.TileLayer(e,{minZoom:t=t<2?2:t,maxZoom:o,attribution:"NORMAL"});e.setZIndex(1);let a=localStorage.getItem("map-center-lat"),i=localStorage.getItem("map-center-lng"),n=38.8225909761771,s=105.380859375;a&&i&&(n=a,s=i);var t=new h.a.LatLng(n,s),r=h.a.latLng(-90,-360),l=h.a.latLng(90,360),r=h.a.latLngBounds(r,l);this.map=new h.a.Map("mainmap",{maxBounds:r,center:t,zoom:parseInt(o/2),attributionControl:!1,layers:[e]}),this.albumId||this.ordinaryAlbumId||this.libraryId?this.getAlbumPhotoList():(this.map.on("moveend",o=>{this.moveTimer&&clearTimeout(this.moveTimer),this.moveTimer=setTimeout(()=>{var t=this.map.getCenter();localStorage.setItem("map-center-lat",t.lat),localStorage.setItem("map-center-lng",t.lng),this.getHashBox(o)},600)}),this.map.zoomIn()),this.markerGroup=h.a.layerGroup().addTo(this.map)},onModalShow(t){if(t){var o=document.getElementsByClassName("ivu-modal-body");for(let t=0;t<o.length;t++)o[t]&&o[t].style&&(o[t].style.padding=0)}},dealPhotoMap(a,i){for(var n in this.markerGroup.clearLayers(),i){let o=i[n],t=document.createElement("img"),e=(t.src=m.a.getImgFullPath(o.id,!0),t.style="width: 100%;height: 100%; object-fit: cover;padding:2%",9*a);(e=75<e?75:e)<35&&(e=35);n=h.a.divIcon({iconSize:[e,e],html:t});if((0!=o.latitude||0!=o.longitude)&&"undefined"!=o.latitude&&"undefined"!=o.longitude){this.albumFirstPhoto=o;try{var s=h.a.marker([o.latitude,o.longitude],{icon:n,indexId:o.id});s.on("click",t=>{this.api.post("/api/mapApi/getLocationStr",{indexId:o.id}).then(t=>{t.code||(this.selectPositionStr=t.geo.name+" "+t.geo.cn_name,this.clickGeohash=o.geohash,this.showPhotoGeo=!0,this.pushState())}).catch(t=>{})}),s.addTo(this.markerGroup)}catch(t){}}}var t;(this.albumId||this.ordinaryAlbumId)&&this.albumFirstPhoto&&(t=new h.a.LatLng(this.albumFirstPhoto.latitude,this.albumFirstPhoto.longitude),this.map.flyTo(t))},getAlbumPhotoList(){var t={};this.albumId?t.albumId=this.albumId:this.ordinaryAlbumId?t.ordinaryAlbumId=this.ordinaryAlbumId:this.libraryId&&(t.libraryId=this.libraryId),this.api.post("/api/photoApi/getAlbumPhotoForMap",t).then(t=>{t.code||this.dealPhotoMap(2,t.mapPhoto)}).catch(t=>{this.showVsNotification(JSON.stringify(t))})},getHashBox(t){let o=t.target._zoom,e=this.map.getBounds(),a=e._southWest,i=e._northEast,n=(a.lat<i.lat?a:i).lat,s=(i.lat>a.lat?i:a).lat,r=(a.lng<i.lng?a:i).lng,l=(i.lng>a.lng?i:a).lng,h={hideLoading:!0,minLat:n,minLng:r,maxLat:s,maxLng:l,zoom:o};this.api.post("/api/photoApi/getBoundsPhoto",h).then(t=>{t.code||this.dealPhotoMap(o,t.mapPhoto)}).catch(t=>{})}}},e=(e("c6d3"),e("2877")),e=Object(e.a)(a,function(){var o=this,t=o.$createElement,t=o._self._c||t;return t("div",{staticClass:"map-root"},[o.isMobile?t("div",{staticClass:"map-content",attrs:{id:"mainmap"}}):t("div",{staticClass:"map-content",style:{"border-top-left-radius":o.borderRadius,"border-top-right-radius":o.borderRadius},attrs:{id:"mainmap"}}),o.map&&o.map._zoom&&!o.ordinaryAlbumId&&!o.albumId?t("div",{staticClass:"zoom-title-root"},[t("p",[o._v(" "+o._s(o.$t("map.currentZoomLevel",{zoom:Math.ceil(o.map._zoom)})))]),o.currentMaxZoom<9?t("a",{on:{click:function(t){return o.goToSetting("nasAccount")}}},[o._v(o._s(o.$t("map.upgradeZoom")))]):o._e()]):o._e(),t("Modal",{ref:"myModal",attrs:{"footer-hide":"",fullscreen:"",closable:!1},on:{"on-visible-change":o.onModalShow},model:{value:o.showPhotoGeo,callback:function(t){o.showPhotoGeo=t},expression:"showPhotoGeo"}},[o.showPhotoGeo?t("album-detail",{attrs:{propsNearMode:!0,propsShowSearchBtn:!1,propsTitle:o.selectPositionStr,propsGeoHash:o.clickGeohash},on:{onClose:function(t){o.showPhotoGeo=!1}}}):o._e()],1)],1)},[],!1,null,"5818a79b",null);o.default=e.exports},c6d3:function(t,o,e){"use strict";e("cc80")},cc80:function(t,o,e){}}]);