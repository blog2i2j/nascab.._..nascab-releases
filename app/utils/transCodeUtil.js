const _0xd22c5b=_0x4021;(function(_0x3438af,_0x5d7acd){const _0x47109c=_0x4021,_0x460935=_0x3438af();while(!![]){try{const _0x54066c=parseInt(_0x47109c(0x200))/0x1*(parseInt(_0x47109c(0x1f8))/0x2)+parseInt(_0x47109c(0x1d8))/0x3+parseInt(_0x47109c(0x216))/0x4+-parseInt(_0x47109c(0x1ea))/0x5*(-parseInt(_0x47109c(0x1d1))/0x6)+parseInt(_0x47109c(0x226))/0x7+parseInt(_0x47109c(0x1e1))/0x8*(-parseInt(_0x47109c(0x203))/0x9)+-parseInt(_0x47109c(0x1c0))/0xa*(parseInt(_0x47109c(0x1e6))/0xb);if(_0x54066c===_0x5d7acd)break;else _0x460935['push'](_0x460935['shift']());}catch(_0x4277bd){_0x460935['push'](_0x460935['shift']());}}}(_0x4835,0x74453));let path=require('path'),fs=require('fs');const Database=require('better-sqlite3');function _0x4021(_0x4bc4cb,_0x15a60c){const _0x483548=_0x4835();return _0x4021=function(_0x4021c4,_0x44ee06){_0x4021c4=_0x4021c4-0x1b3;let _0x51f7d5=_0x483548[_0x4021c4];return _0x51f7d5;},_0x4021(_0x4bc4cb,_0x15a60c);}let transCodeUtil={};function _0x4835(){const _0x260b5f=['indexId','undefined','../db/dbPrivateSpaceTable','../libs/nasTrans','path','yuv422p','../myConfig/config','p016le','transCodeParams-readrate','r_frame_rate','getById','getFps','stream读取失败','ffprobe','parseVideoFullPath','nvenc_h264','6IFEylk','join','getTokenObjByToken','./videoStreamUtil','decryptString','sha256','then','2582259inxDGs','yuv422p10le','yuv444p16le','get','getIndexTableNameByType','coderName','parseStreamList','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','\x5c\x5c?\x5c','2776ywZVAP','parseVideoWH','pragma','tokenPwdEncryptKey','avg_frame_rate','2177879wyLCTO','qsv','transcodeSpeed','dealFFmpegPath','859780MbLgqY','err','scale=','yuv420p','length','error','serverType','spaceIndexId','y210le','child_process','CPU','filePath','../express-server/utils/fileUtils','index\x20isn\x27t\x20video','1052146DAkrWJ','h.264','ultrafast','rgb0','prepare','transCodeParams-CoderNameHevc','getVideoBitrate','high\x20efficiency\x20video\x20coding','1KxgNjG','N/A','parse','1818snVXZu','bit_rate','decoderSupportPixFormat','spaceToken','split','decodePath','libx264','nv20le','getPrivateDbPath','duration','yuvj444p','cuda','veryfast','value','stream_info','transCodeParams-CoderNameH264','stat','journal_mode\x20=\x20WAL','hevc','1274076oqiQta','yuvj422p','spaceId','sep','win32','HEVC','findByTitle','yuv420p10le','yuv444p','type','getTranscodeSpeed','pwd','log','../db/dbFileIndexTable','stream\x20info\x20is\x20null','H264','5928405KAtUKK','toLowerCase','getPixFmt','close','push',':-2','gray','bgr0','indexOf','folder_path','space\x20does\x20not\x20exist','h264_qsv','streams','crf','d3d11','nv21','medium','pix_fmt','nv12','platform','p010le','ceil','getScaleOption','FFmpeg','codec_long_name','slow','token\x20expired','h264','gray10le','getDurationFromStream','exports','includes','dxva2_vld','parseSubtitle','nv16','codec_name','110OFsPYA'];_0x4835=function(){return _0x260b5f;};return _0x4835();}const config=require(_0xd22c5b(0x1c7));let fileUtil=require(_0xd22c5b(0x1f6));const dbConfigTable=require('../db/dbConfigTable'),chldProcess=require(_0xd22c5b(0x1f3));let nasTrans=require(_0xd22c5b(0x1c4)),FFmpeg=nasTrans[_0xd22c5b(0x1b3)];const dbFileIndexTable=require(_0xd22c5b(0x223));let dbPrivateSpaceTable=require(_0xd22c5b(0x1c3)),sha256=require(_0xd22c5b(0x1d6)),cryptoUtils=require('../express-server/utils/cryptoUtils');const os=require('os');let platform=os[_0xd22c5b(0x239)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0xd22c5b(0x1d4));let pixFormatList={'h264_nvenc':[_0xd22c5b(0x1ed),'nv12',_0xd22c5b(0x23a),_0xd22c5b(0x21e),_0xd22c5b(0x1c8),_0xd22c5b(0x1da),_0xd22c5b(0x22d),_0xd22c5b(0x1fb),'cuda',_0xd22c5b(0x234)],'nvenc_h264':[_0xd22c5b(0x1ed),_0xd22c5b(0x238),_0xd22c5b(0x23a),_0xd22c5b(0x21e),_0xd22c5b(0x1c8),_0xd22c5b(0x1da),'bgr0',_0xd22c5b(0x1fb),'cuda',_0xd22c5b(0x234)],'h264_qsv':['nv12','p010le',_0xd22c5b(0x1e7),'yuv420p'],'hevc_qsv':[_0xd22c5b(0x238),_0xd22c5b(0x23a),'yuyv422',_0xd22c5b(0x1f2),_0xd22c5b(0x1e7)],'h264_mf':[_0xd22c5b(0x238),'yuv420p'],'h264_amf':[_0xd22c5b(0x238),_0xd22c5b(0x1ed),'d3d11',_0xd22c5b(0x1bc)],'libopenh264':['yuv420p'],'libx264':[_0xd22c5b(0x1ed),_0xd22c5b(0x1c6),_0xd22c5b(0x217),_0xd22c5b(0x21e),_0xd22c5b(0x20d),_0xd22c5b(0x238),_0xd22c5b(0x1be),_0xd22c5b(0x235),_0xd22c5b(0x21d),_0xd22c5b(0x1d9),'yuv444p10le',_0xd22c5b(0x20a),_0xd22c5b(0x22c),_0xd22c5b(0x1b8)],'h264_vaapi':['vaapi_vld',_0xd22c5b(0x1ed)],'h264_cuvid':[_0xd22c5b(0x20e),_0xd22c5b(0x238),_0xd22c5b(0x23a),_0xd22c5b(0x1c8)],'hevc_cuvid':[_0xd22c5b(0x20e),_0xd22c5b(0x238),'p010le','p016le']};function getPwdFromToken(_0x384a56,_0x539d5c,_0x8e1e11){const _0x21d25d=_0xd22c5b;let _0x51639f=dbPrivateSpaceTable[_0x21d25d(0x1d3)](_0x539d5c,_0x384a56);!_0x51639f&&_0x8e1e11(_0x21d25d(0x1b6),pwd);let _0x5f468d=_0x51639f[_0x21d25d(0x221)];cryptoUtils[_0x21d25d(0x1d5)](config[_0x21d25d(0x1e4)],_0x5f468d)[_0x21d25d(0x1d7)](_0x579374=>{_0x8e1e11(![],_0x579374);});}transCodeUtil[_0xd22c5b(0x1e9)]=function(_0x50808e){const _0x2db1b0=_0xd22c5b;if(typeof _0x50808e!=='string')return _0x50808e;return platform==_0x2db1b0(0x21a)&&_0x50808e[_0x2db1b0(0x1ee)]>0x103?_0x2db1b0(0x1e0)+_0x50808e:_0x50808e;},transCodeUtil[_0xd22c5b(0x1cf)]=function(_0x2c2bb0,_0x261479,_0x44ca88){return new Promise((_0x1fbbaf,_0x120758)=>{const _0x540b19=_0x4021;if(_0x44ca88[_0x540b19(0x1c1)]&&!_0x44ca88['spaceId']){let _0x3e21d7=dbFileIndexTable[_0x540b19(0x1dc)](_0x44ca88[_0x540b19(0x1f0)]),_0x21d7bd=dbFileIndexTable[_0x540b19(0x1cb)](_0x2c2bb0,_0x44ca88['indexId'],_0x3e21d7);if(!_0x21d7bd)return _0x120758('index\x20does\x20not\x20exist');if(_0x21d7bd[_0x540b19(0x21f)]!=0x2)return _0x120758(_0x540b19(0x1f7));if(_0x21d7bd[_0x540b19(0x211)]==_0x540b19(0x1c2))return _0x120758(_0x540b19(0x224));let _0x3ccb8f=JSON[_0x540b19(0x202)](_0x21d7bd[_0x540b19(0x211)]),_0xc4b6a5=_0x21d7bd[_0x540b19(0x1c5)]+path[_0x540b19(0x219)]+_0x21d7bd['filename'];return _0x1fbbaf({'fullpath':_0xc4b6a5,'streamList':_0x3ccb8f,'duration':_0x21d7bd[_0x540b19(0x20c)]});}else{if(_0x44ca88['filePath']&&!_0x44ca88[_0x540b19(0x218)]){let _0x26b9e5=fileUtil['decodePath'](_0x44ca88[_0x540b19(0x1f5)]);fs['stat'](_0x26b9e5,(_0x1e6d63,_0x30951f)=>{const _0x273587=_0x540b19;if(_0x1e6d63)return _0x120758('file\x20does\x20not\x20exist');else FFmpeg()['input'](transCodeUtil['dealFFmpegPath'](_0x26b9e5))[_0x273587(0x1ce)]((_0x479407,_0x1ceb5e)=>{const _0x1cbc4f=_0x273587;if(_0x479407)return console[_0x1cbc4f(0x222)](_0x479407),_0x120758(_0x1cbc4f(0x1cd));else{let _0x248535=videoStreamUtil[_0x1cbc4f(0x1b9)](_0x1ceb5e),_0x1c9e51=_0x1ceb5e[_0x1cbc4f(0x232)];return _0x1fbbaf({'fullpath':_0x26b9e5,'streamList':_0x1c9e51,'duration':_0x248535});}});});}else{if(_0x44ca88[_0x540b19(0x218)]){let _0x410c8a=_0x44ca88['spaceId'],_0x11f0fb=dbPrivateSpaceTable[_0x540b19(0x1cb)](_0x261479,_0x410c8a);if(!_0x11f0fb)return _0x120758(_0x540b19(0x230));let _0xe01d3a=path[_0x540b19(0x1d2)](_0x11f0fb[_0x540b19(0x22f)],fileUtil[_0x540b19(0x208)](_0x44ca88['filePath']));fs[_0x540b19(0x213)](_0xe01d3a,(_0x3bf5bf,_0x5bf466)=>{const _0x3121b6=_0x540b19;if(_0x3bf5bf)return _0x120758('file\x20does\x20not\x20exist');getPwdFromToken(_0x44ca88[_0x3121b6(0x206)],_0x261479,(_0x1fe1e0,_0x22ca40)=>{const _0x5cf89d=_0x3121b6;if(_0x1fe1e0)return _0x120758(_0x5cf89d(0x1eb));let _0x333330=config[_0x5cf89d(0x20b)](_0x11f0fb[_0x5cf89d(0x22f)]),_0x3b339c=new Database(_0x333330,{});_0x3b339c[_0x5cf89d(0x1e3)](_0x5cf89d(0x214));let _0x3b8891=_0x3b339c[_0x5cf89d(0x1fc)]('SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?')[_0x5cf89d(0x1db)](_0x44ca88[_0x5cf89d(0x1f1)]);if(!_0x3b8891||!_0x3b8891[_0x5cf89d(0x211)])return _0x120758('index\x20id\x20does\x20not\x20exist');_0x3b339c[_0x5cf89d(0x229)]();let _0x426514=JSON[_0x5cf89d(0x202)](_0x3b8891[_0x5cf89d(0x211)]);return _0x1fbbaf({'fullpath':_0xe01d3a,'streamList':_0x426514,'needDecrypt':!![],'pwd':_0x22ca40,'duration':_0x3b8891['duration']});});});}}}});},transCodeUtil[_0xd22c5b(0x1cc)]=function(_0x1864cd){const _0x51c6ab=_0xd22c5b;let _0x3a51f2=0x1e,_0x1ee1c8=![];try{if(_0x1864cd[_0x51c6ab(0x1ca)]){let _0x255465=_0x1864cd[_0x51c6ab(0x1ca)][_0x51c6ab(0x207)]('/');(_0x255465[_0x51c6ab(0x1ee)]=0x2)&&(_0x1ee1c8=Math[_0x51c6ab(0x23b)](parseInt(_0x255465[0x0])/parseInt(_0x255465[0x1])));}if(!_0x1ee1c8){if(_0x1864cd[_0x51c6ab(0x1e5)]){let _0x61e737=_0x1864cd[_0x51c6ab(0x1e5)][_0x51c6ab(0x207)]('/');(_0x61e737[_0x51c6ab(0x1ee)]=0x2)&&(_0x1ee1c8=Math[_0x51c6ab(0x23b)](parseInt(_0x61e737[0x0])/parseInt(_0x61e737[0x1])));}}}catch(_0x59c21e){console[_0x51c6ab(0x222)](_0x51c6ab(0x1ef),_0x59c21e);}return _0x1ee1c8&&_0x1ee1c8<=0x3c&&(_0x3a51f2=_0x1ee1c8),_0x3a51f2;},transCodeUtil[_0xd22c5b(0x1bd)]=function(_0x1bd08d,_0x126b05){const _0x47ab98=_0xd22c5b;let _0x51935e=[];for(let _0x4cdd96=0x0;_0x4cdd96<_0x1bd08d[_0x47ab98(0x1ee)];_0x4cdd96++){let _0xa2a8eb=_0x1bd08d[_0x4cdd96];_0xa2a8eb['codec_type']=='subtitle'&&_0x51935e['push'](_0xa2a8eb);}if(_0x51935e[_0x47ab98(0x1ee)]>_0x126b05)return _0x51935e[_0x126b05];return null;},transCodeUtil[_0xd22c5b(0x1de)]=function(_0x46bb21){const _0x3c8e13=_0xd22c5b;let _0x250f85=videoStreamUtil[_0x3c8e13(0x1e2)](_0x46bb21);return _0x250f85;},transCodeUtil[_0xd22c5b(0x23c)]=function(_0x325b22,_0xaa88f7,_0x53702f){const _0xa3436c=_0xd22c5b;let _0x101f48=null;if(_0xaa88f7&&_0x53702f&&_0x325b22)_0x325b22>_0xaa88f7&&_0x325b22>_0x53702f&&(_0x325b22=_0xaa88f7>_0x53702f?_0xaa88f7:_0x53702f),_0xaa88f7>_0x53702f?_0x101f48=_0xa3436c(0x1ec)+_0x325b22+_0xa3436c(0x22b):_0x101f48='scale=-2:'+_0x325b22;else{}return _0x101f48;},transCodeUtil[_0xd22c5b(0x1fe)]=function(_0x5514ee,_0x10e0cb){const _0x302db9=_0xd22c5b;return _0x10e0cb==-0x1&&(_0x5514ee&&_0x5514ee[_0x302db9(0x204)]&&_0x5514ee['bit_rate']>0xf4240&&_0x5514ee['bit_rate']!=_0x302db9(0x201)?(_0x10e0cb=_0x5514ee[_0x302db9(0x204)]/0x3e8,_0x10e0cb>BITRATE_MAX&&(_0x10e0cb=BITRATE_MAX)):_0x10e0cb=BITRATE_DEFAULT),_0x10e0cb;},transCodeUtil['getCrf']=function(_0x43f04b){const _0x166209=_0xd22c5b;let _0x4e0999=0x17,_0x22dbe0=dbConfigTable[_0x166209(0x21c)](_0x43f04b,_0x166209(0x233));return _0x22dbe0&&(_0x22dbe0[_0x166209(0x210)]>=0x1&&_0x22dbe0[_0x166209(0x210)]<=0x33&&(_0x4e0999=_0x22dbe0[_0x166209(0x210)])),_0x4e0999;},transCodeUtil[_0xd22c5b(0x220)]=function(_0x5530cf,_0x278f93){const _0x395a70=_0xd22c5b;let _0x3b2a73=dbConfigTable[_0x395a70(0x21c)](_0x5530cf,_0x395a70(0x1e8)),_0x278739=[_0x395a70(0x1fa),'fast',_0x395a70(0x236),_0x395a70(0x1b5)];function _0x2a2dd8(_0xaff82c){const _0x138556=_0x395a70;if((_0x278f93=='h264_nvenc'||_0x278f93==_0x138556(0x1d0))&&_0xaff82c==_0x138556(0x1fa))return'p1';if(_0x278f93==_0x138556(0x231)&&(_0xaff82c==_0x138556(0x1fa)||_0xaff82c=='superfast'))return _0x138556(0x20f);return _0xaff82c;}return _0x3b2a73&&_0x3b2a73[_0x395a70(0x210)]&&_0x278739[_0x395a70(0x1bb)](_0x3b2a73[_0x395a70(0x210)])?_0x2a2dd8(_0x3b2a73[_0x395a70(0x210)]):_0x395a70(0x236);},transCodeUtil['getCoderConfig']=function(_0x11c566,_0x55768f){const _0x5b3f26=_0xd22c5b;let _0x5dc3a2='';if(_0x55768f){if(_0x55768f[_0x5b3f26(0x1bf)]){let _0xe8886a=_0x55768f[_0x5b3f26(0x1bf)][_0x5b3f26(0x227)]();(_0xe8886a[_0x5b3f26(0x22e)]('h264')!=-0x1||_0xe8886a[_0x5b3f26(0x22e)](_0x5b3f26(0x1f9))!=-0x1)&&(_0x5dc3a2='H264'),_0xe8886a['indexOf']('hevc')!=-0x1&&(_0x5dc3a2=_0x5b3f26(0x21b));}if(!_0x5dc3a2&&_0x55768f[_0x5b3f26(0x1b4)]){let _0x391d76=_0x55768f[_0x5b3f26(0x1b4)][_0x5b3f26(0x227)]();(_0x391d76[_0x5b3f26(0x22e)](_0x5b3f26(0x1b7))!=-0x1||_0x391d76['indexOf'](_0x5b3f26(0x1f9))!=-0x1)&&(_0x5dc3a2=_0x5b3f26(0x225)),(_0x391d76[_0x5b3f26(0x22e)](_0x5b3f26(0x215))!=-0x1||_0x391d76[_0x5b3f26(0x22e)](_0x5b3f26(0x1ff))!=-0x1)&&(_0x5dc3a2=_0x5b3f26(0x21b));}}!_0x5dc3a2&&(console['log'](_0x5b3f26(0x1df)),_0x5dc3a2='HEVC');let _0x4d532a={'decoderCommand':'','encoderName':_0x5b3f26(0x209),'coderName':_0x5b3f26(0x1f4)},_0x3fa127=dbConfigTable[_0x5b3f26(0x21c)](_0x11c566,'transCodeParams-coderList'),_0x20f425='';if(_0x5dc3a2=='HEVC'){let _0x34a4b9=dbConfigTable['findByTitle'](_0x11c566,_0x5b3f26(0x1fd));_0x34a4b9&&_0x34a4b9[_0x5b3f26(0x210)]&&(_0x20f425=_0x34a4b9[_0x5b3f26(0x210)]);}else{if(_0x5dc3a2==_0x5b3f26(0x225)){let _0x21724d=dbConfigTable[_0x5b3f26(0x21c)](_0x11c566,_0x5b3f26(0x212));_0x21724d&&_0x21724d['value']&&(_0x20f425=_0x21724d[_0x5b3f26(0x210)]);}}if(_0x3fa127&&_0x3fa127[_0x5b3f26(0x210)])try{let _0x57df94=[];_0x3fa127=JSON[_0x5b3f26(0x202)](_0x3fa127[_0x5b3f26(0x210)]);for(let _0x43947d of _0x3fa127){_0x43947d['decoderType']==_0x5dc3a2&&_0x57df94[_0x5b3f26(0x22a)](_0x43947d);}if(_0x57df94['length']>0x0){if(!_0x20f425)_0x4d532a=_0x57df94[0x0];else{let _0x7380ec=![];for(let _0x6a45e3 of _0x57df94){if(_0x6a45e3[_0x5b3f26(0x1dd)]==_0x20f425){_0x4d532a=_0x6a45e3,_0x7380ec=!![];break;}}!_0x7380ec&&(console['log']('用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器',_0x57df94[0x0]),_0x4d532a=_0x57df94[0x0]);}}}catch(_0x2e5602){console[_0x5b3f26(0x222)](_0x2e5602);}return _0x4d532a;},transCodeUtil['getReadRate']=function(_0x26fb95){const _0x2b8973=_0xd22c5b;let _0x5956ff=0x5,_0x433b50=_0x5956ff,_0x3ca521=dbConfigTable['findByTitle'](_0x26fb95,_0x2b8973(0x1c9));if(_0x3ca521&&_0x3ca521[_0x2b8973(0x210)])try{_0x433b50=parseInt(_0x3ca521[_0x2b8973(0x210)]),(_0x433b50<0x2||_0x433b50>0x1e)&&(_0x433b50=_0x5956ff);}catch(_0xc4191d){return _0x5956ff;}return _0x433b50;},transCodeUtil[_0xd22c5b(0x228)]=function(_0x53e568,_0x23abd5){return'yuv420p';},transCodeUtil[_0xd22c5b(0x205)]=function(_0x68738,_0x4ce68e){const _0xfec8c0=_0xd22c5b;let _0x125709=_0x68738[_0xfec8c0(0x237)];if(_0x125709){_0x125709=_0x125709['trim']();if(pixFormatList[_0x4ce68e]){if(!pixFormatList[_0x4ce68e][_0xfec8c0(0x1bb)](_0x125709))return![];}}return!![];},module[_0xd22c5b(0x1ba)]=transCodeUtil;