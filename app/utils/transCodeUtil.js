const _0x301b7d=_0x3a62;(function(_0x4f451d,_0x666b95){const _0xb213b4=_0x3a62,_0x2c5fe0=_0x4f451d();while(!![]){try{const _0x3df05d=parseInt(_0xb213b4(0x25b))/0x1+parseInt(_0xb213b4(0x24a))/0x2+parseInt(_0xb213b4(0x218))/0x3*(-parseInt(_0xb213b4(0x215))/0x4)+-parseInt(_0xb213b4(0x267))/0x5*(parseInt(_0xb213b4(0x221))/0x6)+-parseInt(_0xb213b4(0x260))/0x7*(-parseInt(_0xb213b4(0x251))/0x8)+parseInt(_0xb213b4(0x20b))/0x9+parseInt(_0xb213b4(0x1ed))/0xa;if(_0x3df05d===_0x666b95)break;else _0x2c5fe0['push'](_0x2c5fe0['shift']());}catch(_0x28bd4a){_0x2c5fe0['push'](_0x2c5fe0['shift']());}}}(_0x3852,0x22c17));let path=require(_0x301b7d(0x23e)),fs=require('fs');const Database=require(_0x301b7d(0x238));let transCodeUtil={};function _0x3852(){const _0x92c6d0=['spaceIndexId','getIndexTableNameByType','212169Fhbfbs','exports','transCodeParams-readrate','index\x20does\x20not\x20exist','codec_long_name','hevc','yuv422p','stream读取失败','stream\x20info\x20is\x20null','107196oihfmz','../express-server/utils/cryptoUtils','nv12','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','N/A','decryptString','stream_info','getDurationFromStream','decoderSupportPixFormat','indexId','cuda','child_process','yuv444p16le','yuv444p','split','trim','length','space\x20does\x20not\x20exist','high\x20efficiency\x20video\x20coding','duration','nv21','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','d3d11','better-sqlite3','rgb0','../db/dbFileIndexTable','FFmpeg','string','includes','path','file\x20does\x20not\x20exist','bit_rate','nv20le','pwd','ffprobe','getCoderConfig','folder_path','transcodeSpeed','scale=-2:','coderName','vaapi_vld','97076myafPb','p016le','medium','decodePath','filePath','parseSubtitle','yuvj422p','51992TJcTbE','../db/dbPrivateSpaceTable','spaceToken','parse','nvenc_h264','bgr0','getScaleOption','transCodeParams-coderList','slow','fast','19175gHtZBN','libx264','undefined','sha256','nv16','70XTjmxg','findByTitle','y210le','spaceId','getById','parseVideoWH','log','20WEtRpX','H264','err','codec_name','index\x20isn\x27t\x20video','serverType','decoderType','get','../db/dbConfigTable','push','subtitle','transCodeParams-CoderNameH264','prepare','crf','2268120RiFCEv','type','yuv422p10le','r_frame_rate','h264','parseVideoFullPath','indexOf','input','close','./videoStreamUtil','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','pix_fmt','yuv420p','join','h264_nvenc','ultrafast','getReadRate','then','tokenPwdEncryptKey','h264_qsv','qsv','error','dealFFmpegPath','ceil','value','token\x20expired','../express-server/utils/fileUtils','HEVC','veryfast','\x5c\x5c?\x5c','1234800Rtticd','yuv444p10le','getCrf','sep','filename',':-2','CPU','../myConfig/config','codec_type','p010le','16vRmcBi'];_0x3852=function(){return _0x92c6d0;};return _0x3852();}const config=require(_0x301b7d(0x212));let fileUtil=require(_0x301b7d(0x207));const dbConfigTable=require(_0x301b7d(0x26f)),chldProcess=require(_0x301b7d(0x22c));let nasTrans=require('../libs/nasTrans'),FFmpeg=nasTrans[_0x301b7d(0x23b)];function _0x3a62(_0x43fabf,_0x5e2c6e){const _0x385278=_0x3852();return _0x3a62=function(_0x3a627f,_0x41d21b){_0x3a627f=_0x3a627f-0x1ec;let _0x12ddc1=_0x385278[_0x3a627f];return _0x12ddc1;},_0x3a62(_0x43fabf,_0x5e2c6e);}const dbFileIndexTable=require(_0x301b7d(0x23a));let dbPrivateSpaceTable=require(_0x301b7d(0x252)),sha256=require(_0x301b7d(0x25e)),cryptoUtils=require(_0x301b7d(0x222));const os=require('os');let platform=os['platform']();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x301b7d(0x1f6));let pixFormatList={'h264_nvenc':[_0x301b7d(0x1f9),_0x301b7d(0x223),_0x301b7d(0x214),'yuv444p',_0x301b7d(0x24b),_0x301b7d(0x22d),_0x301b7d(0x256),_0x301b7d(0x239),'cuda',_0x301b7d(0x237)],'nvenc_h264':[_0x301b7d(0x1f9),_0x301b7d(0x223),_0x301b7d(0x214),_0x301b7d(0x22e),'p016le',_0x301b7d(0x22d),_0x301b7d(0x256),_0x301b7d(0x239),_0x301b7d(0x22b),_0x301b7d(0x237)],'h264_qsv':[_0x301b7d(0x223),'p010le',_0x301b7d(0x201),_0x301b7d(0x1f9)],'hevc_qsv':['nv12',_0x301b7d(0x214),'yuyv422',_0x301b7d(0x262),_0x301b7d(0x201)],'h264_mf':['nv12',_0x301b7d(0x1f9)],'h264_amf':['nv12',_0x301b7d(0x1f9),_0x301b7d(0x237),'dxva2_vld'],'libopenh264':[_0x301b7d(0x1f9)],'libx264':[_0x301b7d(0x1f9),_0x301b7d(0x21e),_0x301b7d(0x250),_0x301b7d(0x22e),'yuvj444p',_0x301b7d(0x223),_0x301b7d(0x25f),_0x301b7d(0x235),'yuv420p10le',_0x301b7d(0x1ef),_0x301b7d(0x20c),_0x301b7d(0x241),'gray','gray10le'],'h264_vaapi':[_0x301b7d(0x249),_0x301b7d(0x1f9)],'h264_cuvid':[_0x301b7d(0x22b),_0x301b7d(0x223),_0x301b7d(0x214),_0x301b7d(0x24b)],'hevc_cuvid':[_0x301b7d(0x22b),_0x301b7d(0x223),_0x301b7d(0x214),_0x301b7d(0x24b)]};function getPwdFromToken(_0x4f7893,_0x4e3c23,_0x24cb8a){const _0x198f75=_0x301b7d;let _0x5f5b17=dbPrivateSpaceTable['getTokenObjByToken'](_0x4e3c23,_0x4f7893);!_0x5f5b17&&_0x24cb8a(_0x198f75(0x206),pwd);let _0x582fbc=_0x5f5b17[_0x198f75(0x242)];cryptoUtils[_0x198f75(0x226)](config[_0x198f75(0x1ff)],_0x582fbc)[_0x198f75(0x1fe)](_0x192bbf=>{_0x24cb8a(![],_0x192bbf);});}transCodeUtil[_0x301b7d(0x203)]=function(_0x139f06){const _0x57e3fd=_0x301b7d;if(typeof _0x139f06!==_0x57e3fd(0x23c))return _0x139f06;return platform=='win32'&&_0x139f06[_0x57e3fd(0x231)]>0x103?_0x57e3fd(0x20a)+_0x139f06:_0x139f06;},transCodeUtil[_0x301b7d(0x1f2)]=function(_0x581456,_0x5d24cd,_0x1d89fb){return new Promise((_0x23c042,_0x560573)=>{const _0x296ef3=_0x3a62;if(_0x1d89fb[_0x296ef3(0x22a)]&&!_0x1d89fb[_0x296ef3(0x263)]){let _0x8aa23=dbFileIndexTable[_0x296ef3(0x217)](_0x1d89fb[_0x296ef3(0x26c)]),_0x32c429=dbFileIndexTable[_0x296ef3(0x264)](_0x581456,_0x1d89fb[_0x296ef3(0x22a)],_0x8aa23);if(!_0x32c429)return _0x560573(_0x296ef3(0x21b));if(_0x32c429[_0x296ef3(0x1ee)]!=0x2)return _0x560573(_0x296ef3(0x26b));if(_0x32c429[_0x296ef3(0x227)]==_0x296ef3(0x25d))return _0x560573(_0x296ef3(0x220));let _0x1d03e9=JSON[_0x296ef3(0x254)](_0x32c429[_0x296ef3(0x227)]),_0x327398=_0x32c429[_0x296ef3(0x23e)]+path[_0x296ef3(0x20e)]+_0x32c429[_0x296ef3(0x20f)];return _0x23c042({'fullpath':_0x327398,'streamList':_0x1d03e9,'duration':_0x32c429[_0x296ef3(0x234)]});}else{if(_0x1d89fb[_0x296ef3(0x24e)]&&!_0x1d89fb[_0x296ef3(0x263)]){let _0x4605a6=fileUtil[_0x296ef3(0x24d)](_0x1d89fb[_0x296ef3(0x24e)]);fs['stat'](_0x4605a6,(_0x2d7d30,_0x8cbda7)=>{const _0x3acae2=_0x296ef3;if(_0x2d7d30)return _0x560573(_0x3acae2(0x23f));else FFmpeg()[_0x3acae2(0x1f4)](transCodeUtil['dealFFmpegPath'](_0x4605a6))[_0x3acae2(0x243)]((_0x39f690,_0x5e2722)=>{const _0xd9ff99=_0x3acae2;if(_0x39f690)return console[_0xd9ff99(0x266)](_0x39f690),_0x560573(_0xd9ff99(0x21f));else{let _0x3b0ad4=videoStreamUtil[_0xd9ff99(0x228)](_0x5e2722),_0x27964f=_0x5e2722['streams'];return _0x23c042({'fullpath':_0x4605a6,'streamList':_0x27964f,'duration':_0x3b0ad4});}});});}else{if(_0x1d89fb[_0x296ef3(0x263)]){let _0x17df76=_0x1d89fb[_0x296ef3(0x263)],_0x4510ac=dbPrivateSpaceTable[_0x296ef3(0x264)](_0x5d24cd,_0x17df76);if(!_0x4510ac)return _0x560573(_0x296ef3(0x232));let _0x508beb=path[_0x296ef3(0x1fa)](_0x4510ac[_0x296ef3(0x245)],fileUtil[_0x296ef3(0x24d)](_0x1d89fb[_0x296ef3(0x24e)]));fs['stat'](_0x508beb,(_0x561fbf,_0x240f93)=>{const _0x5c8693=_0x296ef3;if(_0x561fbf)return _0x560573(_0x5c8693(0x23f));getPwdFromToken(_0x1d89fb[_0x5c8693(0x253)],_0x5d24cd,(_0x44f98c,_0x5217fa)=>{const _0x4413f7=_0x5c8693;if(_0x44f98c)return _0x560573(_0x4413f7(0x269));let _0x24ffe2=config['getPrivateDbPath'](_0x4510ac['folder_path']),_0x368d61=new Database(_0x24ffe2,{});_0x368d61['pragma']('journal_mode\x20=\x20WAL');let _0x18b38f=_0x368d61[_0x4413f7(0x273)](_0x4413f7(0x236))[_0x4413f7(0x26e)](_0x1d89fb[_0x4413f7(0x216)]);if(!_0x18b38f||!_0x18b38f[_0x4413f7(0x227)])return _0x560573('index\x20id\x20does\x20not\x20exist');_0x368d61[_0x4413f7(0x1f5)]();let _0x367116=JSON[_0x4413f7(0x254)](_0x18b38f['stream_info']);return _0x23c042({'fullpath':_0x508beb,'streamList':_0x367116,'needDecrypt':!![],'pwd':_0x5217fa,'duration':_0x18b38f[_0x4413f7(0x234)]});});});}}}});},transCodeUtil['getFps']=function(_0x13990d){const _0x5ac9c6=_0x301b7d;let _0x4c171b=0x1e,_0x4bdf00=![];try{if(_0x13990d[_0x5ac9c6(0x1f0)]){let _0x34ffb4=_0x13990d['r_frame_rate']['split']('/');(_0x34ffb4[_0x5ac9c6(0x231)]=0x2)&&(_0x4bdf00=Math[_0x5ac9c6(0x204)](parseInt(_0x34ffb4[0x0])/parseInt(_0x34ffb4[0x1])));}if(!_0x4bdf00){if(_0x13990d['avg_frame_rate']){let _0x413215=_0x13990d['avg_frame_rate'][_0x5ac9c6(0x22f)]('/');(_0x413215['length']=0x2)&&(_0x4bdf00=Math[_0x5ac9c6(0x204)](parseInt(_0x413215[0x0])/parseInt(_0x413215[0x1])));}}}catch(_0x5702c4){console[_0x5ac9c6(0x266)](_0x5ac9c6(0x202),_0x5702c4);}return _0x4bdf00&&_0x4bdf00<=0x3c&&(_0x4c171b=_0x4bdf00),_0x4c171b;},transCodeUtil[_0x301b7d(0x24f)]=function(_0x467fe4,_0x291015){const _0x3e3f2b=_0x301b7d;let _0x175734=[];for(let _0x5f3e53=0x0;_0x5f3e53<_0x467fe4['length'];_0x5f3e53++){let _0x5115be=_0x467fe4[_0x5f3e53];_0x5115be[_0x3e3f2b(0x213)]==_0x3e3f2b(0x271)&&_0x175734[_0x3e3f2b(0x270)](_0x5115be);}if(_0x175734['length']>_0x291015)return _0x175734[_0x291015];return null;},transCodeUtil['parseStreamList']=function(_0x4da590){const _0x340363=_0x301b7d;let _0xfb0a5=videoStreamUtil[_0x340363(0x265)](_0x4da590);return _0xfb0a5;},transCodeUtil[_0x301b7d(0x257)]=function(_0x1fd60c,_0x1d3479,_0x276bf7){const _0x3059d2=_0x301b7d;let _0x5bbd83=null;if(_0x1d3479&&_0x276bf7&&_0x1fd60c)_0x1fd60c>_0x1d3479&&_0x1fd60c>_0x276bf7&&(_0x1fd60c=_0x1d3479>_0x276bf7?_0x1d3479:_0x276bf7),_0x1d3479>_0x276bf7?_0x5bbd83='scale='+_0x1fd60c+_0x3059d2(0x210):_0x5bbd83=_0x3059d2(0x247)+_0x1fd60c;else{}return _0x5bbd83;},transCodeUtil['getVideoBitrate']=function(_0x114777,_0x4bc2e6){const _0x5013a1=_0x301b7d;return _0x4bc2e6==-0x1&&(_0x114777&&_0x114777['bit_rate']&&_0x114777[_0x5013a1(0x240)]>0xf4240&&_0x114777[_0x5013a1(0x240)]!=_0x5013a1(0x225)?(_0x4bc2e6=_0x114777[_0x5013a1(0x240)]/0x3e8,_0x4bc2e6>BITRATE_MAX&&(_0x4bc2e6=BITRATE_MAX)):_0x4bc2e6=BITRATE_DEFAULT),_0x4bc2e6;},transCodeUtil[_0x301b7d(0x20d)]=function(_0x143111){const _0x45a0da=_0x301b7d;let _0x4aea94=0x17,_0x1e327a=dbConfigTable[_0x45a0da(0x261)](_0x143111,_0x45a0da(0x1ec));return _0x1e327a&&(_0x1e327a[_0x45a0da(0x205)]>=0x1&&_0x1e327a['value']<=0x33&&(_0x4aea94=_0x1e327a['value'])),_0x4aea94;},transCodeUtil['getTranscodeSpeed']=function(_0x451fe2,_0x3e0a0a){const _0x50f573=_0x301b7d;let _0x2b5de7=dbConfigTable['findByTitle'](_0x451fe2,_0x50f573(0x246)),_0xfc5f0e=[_0x50f573(0x1fc),_0x50f573(0x25a),_0x50f573(0x24c),_0x50f573(0x259)];function _0x9c10ce(_0x5350d2){const _0x2589b9=_0x50f573;if((_0x3e0a0a==_0x2589b9(0x1fb)||_0x3e0a0a==_0x2589b9(0x255))&&_0x5350d2=='ultrafast')return'p1';if(_0x3e0a0a==_0x2589b9(0x200)&&(_0x5350d2==_0x2589b9(0x1fc)||_0x5350d2=='superfast'))return _0x2589b9(0x209);return _0x5350d2;}return _0x2b5de7&&_0x2b5de7[_0x50f573(0x205)]&&_0xfc5f0e[_0x50f573(0x23d)](_0x2b5de7[_0x50f573(0x205)])?_0x9c10ce(_0x2b5de7[_0x50f573(0x205)]):_0x50f573(0x24c);},transCodeUtil[_0x301b7d(0x244)]=function(_0x49bd17,_0x47d962){const _0x2684c6=_0x301b7d;let _0x8d3f0c='';if(_0x47d962){if(_0x47d962[_0x2684c6(0x26a)]){let _0x1ea90f=_0x47d962[_0x2684c6(0x26a)]['toLowerCase']();(_0x1ea90f[_0x2684c6(0x1f3)](_0x2684c6(0x1f1))!=-0x1||_0x1ea90f['indexOf']('h.264')!=-0x1)&&(_0x8d3f0c=_0x2684c6(0x268)),_0x1ea90f[_0x2684c6(0x1f3)](_0x2684c6(0x21d))!=-0x1&&(_0x8d3f0c=_0x2684c6(0x208));}if(!_0x8d3f0c&&_0x47d962['codec_long_name']){let _0x410577=_0x47d962[_0x2684c6(0x21c)]['toLowerCase']();(_0x410577['indexOf']('h264')!=-0x1||_0x410577['indexOf']('h.264')!=-0x1)&&(_0x8d3f0c=_0x2684c6(0x268)),(_0x410577['indexOf'](_0x2684c6(0x21d))!=-0x1||_0x410577[_0x2684c6(0x1f3)](_0x2684c6(0x233))!=-0x1)&&(_0x8d3f0c='HEVC');}}!_0x8d3f0c&&(console[_0x2684c6(0x266)](_0x2684c6(0x224)),_0x8d3f0c=_0x2684c6(0x208));let _0x223065={'decoderCommand':'','encoderName':_0x2684c6(0x25c),'coderName':_0x2684c6(0x211)},_0x114015=dbConfigTable[_0x2684c6(0x261)](_0x49bd17,_0x2684c6(0x258)),_0x1fe99b='';if(_0x8d3f0c==_0x2684c6(0x208)){let _0x49a9db=dbConfigTable[_0x2684c6(0x261)](_0x49bd17,'transCodeParams-CoderNameHevc');_0x49a9db&&_0x49a9db['value']&&(_0x1fe99b=_0x49a9db[_0x2684c6(0x205)]);}else{if(_0x8d3f0c=='H264'){let _0x43bbe3=dbConfigTable[_0x2684c6(0x261)](_0x49bd17,_0x2684c6(0x272));_0x43bbe3&&_0x43bbe3[_0x2684c6(0x205)]&&(_0x1fe99b=_0x43bbe3[_0x2684c6(0x205)]);}}if(_0x114015&&_0x114015['value'])try{let _0x4045c4=[];_0x114015=JSON['parse'](_0x114015[_0x2684c6(0x205)]);for(let _0x247c3b of _0x114015){_0x247c3b[_0x2684c6(0x26d)]==_0x8d3f0c&&_0x4045c4[_0x2684c6(0x270)](_0x247c3b);}if(_0x4045c4[_0x2684c6(0x231)]>0x0){if(!_0x1fe99b)_0x223065=_0x4045c4[0x0];else{let _0x5d533a=![];for(let _0x3b28c6 of _0x4045c4){if(_0x3b28c6[_0x2684c6(0x248)]==_0x1fe99b){_0x223065=_0x3b28c6,_0x5d533a=!![];break;}}!_0x5d533a&&(console[_0x2684c6(0x266)](_0x2684c6(0x1f7),_0x4045c4[0x0]),_0x223065=_0x4045c4[0x0]);}}}catch(_0x1f9ed0){console[_0x2684c6(0x266)](_0x1f9ed0);}return _0x223065;},transCodeUtil[_0x301b7d(0x1fd)]=function(_0x22d6d7){const _0x1052d2=_0x301b7d;let _0xfd38ed=0x5,_0x22e063=_0xfd38ed,_0x113c05=dbConfigTable[_0x1052d2(0x261)](_0x22d6d7,_0x1052d2(0x21a));if(_0x113c05&&_0x113c05['value'])try{_0x22e063=parseInt(_0x113c05[_0x1052d2(0x205)]),(_0x22e063<0x2||_0x22e063>0x1e)&&(_0x22e063=_0xfd38ed);}catch(_0x5eeae9){return _0xfd38ed;}return _0x22e063;},transCodeUtil['getPixFmt']=function(_0x4d2314,_0x3883a0){const _0x4a6de1=_0x301b7d;return _0x4a6de1(0x1f9);},transCodeUtil[_0x301b7d(0x229)]=function(_0x3be6e0,_0x4c6015){const _0x29b20a=_0x301b7d;let _0x309332=_0x3be6e0[_0x29b20a(0x1f8)];if(_0x309332){_0x309332=_0x309332[_0x29b20a(0x230)]();if(pixFormatList[_0x4c6015]){if(!pixFormatList[_0x4c6015][_0x29b20a(0x23d)](_0x309332))return![];}}return!![];},module[_0x301b7d(0x219)]=transCodeUtil;