const _0xe5600b=_0x2ed1;(function(_0x38173c,_0x53ee49){const _0x609b52=_0x2ed1,_0x43f013=_0x38173c();while(!![]){try{const _0x47fb1d=parseInt(_0x609b52(0x1d3))/0x1*(parseInt(_0x609b52(0x1d4))/0x2)+-parseInt(_0x609b52(0x1d9))/0x3+-parseInt(_0x609b52(0x1ac))/0x4+parseInt(_0x609b52(0x181))/0x5+-parseInt(_0x609b52(0x174))/0x6*(-parseInt(_0x609b52(0x1bc))/0x7)+-parseInt(_0x609b52(0x189))/0x8+parseInt(_0x609b52(0x1d2))/0x9;if(_0x47fb1d===_0x53ee49)break;else _0x43f013['push'](_0x43f013['shift']());}catch(_0x133682){_0x43f013['push'](_0x43f013['shift']());}}}(_0x2f65,0x2e7bd));let path=require(_0xe5600b(0x186)),fs=require('fs');const Database=require(_0xe5600b(0x18d));let transCodeUtil={};const config=require('../myConfig/config');let fileUtil=require(_0xe5600b(0x173));const dbConfigTable=require('../db/dbConfigTable'),chldProcess=require('child_process');let nasTrans=require(_0xe5600b(0x1a8)),FFmpeg=nasTrans[_0xe5600b(0x1a6)];const dbFileIndexTable=require(_0xe5600b(0x17e));let dbPrivateSpaceTable=require(_0xe5600b(0x19b)),sha256=require('sha256'),cryptoUtils=require('../express-server/utils/cryptoUtils');function _0x2f65(){const _0x3089db=['y210le','yuvj422p','codec_name','yuv422p10le','decodePath','undefined','input','scale=-2:','findByTitle','push','nv21','parseSubtitle','tokenPwdEncryptKey','yuv444p16le','string','toLowerCase','filePath','h.264','avg_frame_rate','../express-server/utils/fileUtils','174piTqmK','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','indexOf','getCrf','codec_long_name','fast','sep','vaapi_vld','index\x20does\x20not\x20exist','getTranscodeSpeed','../db/dbFileIndexTable','d3d11','qsv','677360wZsVcW','yuv422p','indexId','rgb0','getDurationFromStream','path','streams','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器','2831008ArNLdY','get','HEVC','nv12','better-sqlite3','ffprobe','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','decoderType','r_frame_rate','crf','stream\x20info\x20is\x20null','yuv444p10le','medium','getFps','yuv420p','dealFFmpegPath','file\x20does\x20not\x20exist','bit_rate','../db/dbPrivateSpaceTable','slow','nvenc_h264','spaceId','type','yuv444p','p016le','yuvj444p','length','H264','prepare','FFmpeg','getCoderConfig','../libs/nasTrans','high\x20efficiency\x20video\x20coding','stream读取失败','hevc','1064308HvRFbj','index\x20id\x20does\x20not\x20exist','getIndexTableNameByType','split','folder_path','dxva2_vld','getPrivateDbPath','N/A','cuda','libx264','CPU','veryfast','duration','ultrafast','transcodeSpeed','nv16','40229ByRMes','./videoStreamUtil','filename','getById','includes','\x5c\x5c?\x5c','h264','exports','index\x20isn\x27t\x20video','trim','decryptString','spaceIndexId','coderName','parse','yuv420p10le','stream_info','gray10le','close','pragma','join','stat','transCodeParams-coderList','2768553bbUBsd','401FQrxat','1694lYmmiA','p010le','parseStreamList','getScaleOption','getReadRate','417147zLXfAs','ceil','gray','serverType','nv20le','space\x20does\x20not\x20exist','getPixFmt','subtitle','log','win32','value','transCodeParams-CoderNameHevc','transCodeParams-readrate','journal_mode\x20=\x20WAL','h264_qsv'];_0x2f65=function(){return _0x3089db;};return _0x2f65();}const os=require('os');function _0x2ed1(_0x3f982f,_0x378096){const _0x2f657b=_0x2f65();return _0x2ed1=function(_0x2ed133,_0x17bbb2){_0x2ed133=_0x2ed133-0x171;let _0x1bd393=_0x2f657b[_0x2ed133];return _0x1bd393;},_0x2ed1(_0x3f982f,_0x378096);}let platform=os['platform']();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0xe5600b(0x1bd));let pixFormatList={'h264_nvenc':[_0xe5600b(0x197),_0xe5600b(0x18c),_0xe5600b(0x1d5),_0xe5600b(0x1a0),_0xe5600b(0x1a1),_0xe5600b(0x1f5),'bgr0',_0xe5600b(0x184),'cuda','d3d11'],'nvenc_h264':[_0xe5600b(0x197),_0xe5600b(0x18c),_0xe5600b(0x1d5),_0xe5600b(0x1a0),_0xe5600b(0x1a1),_0xe5600b(0x1f5),'bgr0','rgb0',_0xe5600b(0x1b4),'d3d11'],'h264_qsv':[_0xe5600b(0x18c),_0xe5600b(0x1d5),_0xe5600b(0x180),_0xe5600b(0x197)],'hevc_qsv':['nv12','p010le','yuyv422',_0xe5600b(0x1e8),_0xe5600b(0x180)],'h264_mf':[_0xe5600b(0x18c),_0xe5600b(0x197)],'h264_amf':['nv12',_0xe5600b(0x197),_0xe5600b(0x17f),_0xe5600b(0x1b1)],'libopenh264':[_0xe5600b(0x197)],'libx264':[_0xe5600b(0x197),_0xe5600b(0x182),_0xe5600b(0x1e9),_0xe5600b(0x1a0),_0xe5600b(0x1a2),_0xe5600b(0x18c),_0xe5600b(0x1bb),_0xe5600b(0x1f2),_0xe5600b(0x1ca),_0xe5600b(0x1eb),_0xe5600b(0x194),_0xe5600b(0x1dd),_0xe5600b(0x1db),_0xe5600b(0x1cc)],'h264_vaapi':[_0xe5600b(0x17b),'yuv420p'],'h264_cuvid':[_0xe5600b(0x1b4),_0xe5600b(0x18c),_0xe5600b(0x1d5),_0xe5600b(0x1a1)],'hevc_cuvid':[_0xe5600b(0x1b4),_0xe5600b(0x18c),_0xe5600b(0x1d5),'p016le']};function getPwdFromToken(_0x1fe196,_0x30b599,_0x2cb9b8){const _0x59ec40=_0xe5600b;let _0x40bd5d=dbPrivateSpaceTable['getTokenObjByToken'](_0x30b599,_0x1fe196);!_0x40bd5d&&_0x2cb9b8('token\x20expired',pwd);let _0x385a46=_0x40bd5d['pwd'];cryptoUtils[_0x59ec40(0x1c6)](config[_0x59ec40(0x1f4)],_0x385a46)['then'](_0x4223d8=>{_0x2cb9b8(![],_0x4223d8);});}transCodeUtil[_0xe5600b(0x198)]=function(_0x221e88){const _0x21f5e1=_0xe5600b;if(typeof _0x221e88!==_0x21f5e1(0x1f6))return _0x221e88;return platform==_0x21f5e1(0x1e2)&&_0x221e88['length']>0x103?_0x21f5e1(0x1c1)+_0x221e88:_0x221e88;},transCodeUtil['parseVideoFullPath']=function(_0xdeb219,_0x3a8b6f,_0x1178fe){return new Promise((_0x1c5583,_0x55f187)=>{const _0x2714a8=_0x2ed1;if(_0x1178fe[_0x2714a8(0x183)]&&!_0x1178fe[_0x2714a8(0x19e)]){let _0x22a447=dbFileIndexTable[_0x2714a8(0x1ae)](_0x1178fe[_0x2714a8(0x1dc)]),_0x45cd0b=dbFileIndexTable[_0x2714a8(0x1bf)](_0xdeb219,_0x1178fe['indexId'],_0x22a447);if(!_0x45cd0b)return _0x55f187(_0x2714a8(0x17c));if(_0x45cd0b[_0x2714a8(0x19f)]!=0x2)return _0x55f187(_0x2714a8(0x1c4));if(_0x45cd0b[_0x2714a8(0x1cb)]==_0x2714a8(0x1ed))return _0x55f187(_0x2714a8(0x193));let _0x1dd3b7=JSON[_0x2714a8(0x1c9)](_0x45cd0b[_0x2714a8(0x1cb)]),_0x397584=_0x45cd0b[_0x2714a8(0x186)]+path[_0x2714a8(0x17a)]+_0x45cd0b[_0x2714a8(0x1be)];return _0x1c5583({'fullpath':_0x397584,'streamList':_0x1dd3b7,'duration':_0x45cd0b['duration']});}else{if(_0x1178fe[_0x2714a8(0x1f8)]&&!_0x1178fe['spaceId']){let _0xdc22f1=fileUtil[_0x2714a8(0x1ec)](_0x1178fe[_0x2714a8(0x1f8)]);fs['stat'](_0xdc22f1,(_0x4e7b4e,_0x406341)=>{const _0x10593f=_0x2714a8;if(_0x4e7b4e)return _0x55f187(_0x10593f(0x199));else FFmpeg()[_0x10593f(0x1ee)](transCodeUtil[_0x10593f(0x198)](_0xdc22f1))[_0x10593f(0x18e)]((_0x55fe88,_0x27c7d4)=>{const _0x128f69=_0x10593f;if(_0x55fe88)return console[_0x128f69(0x1e1)](_0x55fe88),_0x55f187(_0x128f69(0x1aa));else{let _0x388ea1=videoStreamUtil[_0x128f69(0x185)](_0x27c7d4),_0x5b6964=_0x27c7d4[_0x128f69(0x187)];return _0x1c5583({'fullpath':_0xdc22f1,'streamList':_0x5b6964,'duration':_0x388ea1});}});});}else{if(_0x1178fe[_0x2714a8(0x19e)]){let _0x1c6ae1=_0x1178fe['spaceId'],_0x5a99d8=dbPrivateSpaceTable['getById'](_0x3a8b6f,_0x1c6ae1);if(!_0x5a99d8)return _0x55f187(_0x2714a8(0x1de));let _0xcc44b1=path[_0x2714a8(0x1cf)](_0x5a99d8[_0x2714a8(0x1b0)],fileUtil['decodePath'](_0x1178fe[_0x2714a8(0x1f8)]));fs[_0x2714a8(0x1d0)](_0xcc44b1,(_0x34a427,_0x458920)=>{if(_0x34a427)return _0x55f187('file\x20does\x20not\x20exist');getPwdFromToken(_0x1178fe['spaceToken'],_0x3a8b6f,(_0x5dc2cd,_0x9e0fe5)=>{const _0x241ffb=_0x2ed1;if(_0x5dc2cd)return _0x55f187('err');let _0x24de37=config[_0x241ffb(0x1b2)](_0x5a99d8[_0x241ffb(0x1b0)]),_0x166242=new Database(_0x24de37,{});_0x166242[_0x241ffb(0x1ce)](_0x241ffb(0x1e6));let _0x89408c=_0x166242[_0x241ffb(0x1a5)](_0x241ffb(0x18f))[_0x241ffb(0x18a)](_0x1178fe[_0x241ffb(0x1c7)]);if(!_0x89408c||!_0x89408c[_0x241ffb(0x1cb)])return _0x55f187(_0x241ffb(0x1ad));_0x166242[_0x241ffb(0x1cd)]();let _0x5e43c4=JSON[_0x241ffb(0x1c9)](_0x89408c[_0x241ffb(0x1cb)]);return _0x1c5583({'fullpath':_0xcc44b1,'streamList':_0x5e43c4,'needDecrypt':!![],'pwd':_0x9e0fe5,'duration':_0x89408c[_0x241ffb(0x1b8)]});});});}}}});},transCodeUtil[_0xe5600b(0x196)]=function(_0x1bc67a){const _0x4a6b31=_0xe5600b;let _0x1a45a9=0x1e,_0x44c1a7=![];try{if(_0x1bc67a[_0x4a6b31(0x191)]){let _0x5b9b91=_0x1bc67a['r_frame_rate']['split']('/');(_0x5b9b91['length']=0x2)&&(_0x44c1a7=Math[_0x4a6b31(0x1da)](parseInt(_0x5b9b91[0x0])/parseInt(_0x5b9b91[0x1])));}if(!_0x44c1a7){if(_0x1bc67a['avg_frame_rate']){let _0xab265c=_0x1bc67a[_0x4a6b31(0x172)][_0x4a6b31(0x1af)]('/');(_0xab265c[_0x4a6b31(0x1a3)]=0x2)&&(_0x44c1a7=Math[_0x4a6b31(0x1da)](parseInt(_0xab265c[0x0])/parseInt(_0xab265c[0x1])));}}}catch(_0x3be81b){console[_0x4a6b31(0x1e1)]('error',_0x3be81b);}return _0x44c1a7&&_0x44c1a7<=0x3c&&(_0x1a45a9=_0x44c1a7),_0x1a45a9;},transCodeUtil[_0xe5600b(0x1f3)]=function(_0x4006c4,_0x51e67e){const _0x102db5=_0xe5600b;let _0x186efa=[];for(let _0xfda563=0x0;_0xfda563<_0x4006c4[_0x102db5(0x1a3)];_0xfda563++){let _0xca2755=_0x4006c4[_0xfda563];_0xca2755['codec_type']==_0x102db5(0x1e0)&&_0x186efa['push'](_0xca2755);}if(_0x186efa['length']>_0x51e67e)return _0x186efa[_0x51e67e];return null;},transCodeUtil[_0xe5600b(0x1d6)]=function(_0xbdbd68){let _0x40e192=videoStreamUtil['parseVideoWH'](_0xbdbd68);return _0x40e192;},transCodeUtil[_0xe5600b(0x1d7)]=function(_0x367dfe,_0x44f2ab,_0x114410){const _0x52d4d6=_0xe5600b;let _0x2cb150=null;if(_0x44f2ab&&_0x114410&&_0x367dfe)_0x367dfe>_0x44f2ab&&_0x367dfe>_0x114410&&(_0x367dfe=_0x44f2ab>_0x114410?_0x44f2ab:_0x114410),_0x44f2ab>_0x114410?_0x2cb150='scale='+_0x367dfe+':-2':_0x2cb150=_0x52d4d6(0x1ef)+_0x367dfe;else{}return _0x2cb150;},transCodeUtil['getVideoBitrate']=function(_0x4efa40,_0x22fb0f){const _0xd1773b=_0xe5600b;return _0x22fb0f==-0x1&&(_0x4efa40&&_0x4efa40[_0xd1773b(0x19a)]&&_0x4efa40[_0xd1773b(0x19a)]>0xf4240&&_0x4efa40['bit_rate']!=_0xd1773b(0x1b3)?(_0x22fb0f=_0x4efa40[_0xd1773b(0x19a)]/0x3e8,_0x22fb0f>BITRATE_MAX&&(_0x22fb0f=BITRATE_MAX)):_0x22fb0f=BITRATE_DEFAULT),_0x22fb0f;},transCodeUtil[_0xe5600b(0x177)]=function(_0x34543b){const _0x531155=_0xe5600b;let _0xdd6138=0x17,_0xc5da6e=dbConfigTable[_0x531155(0x1f0)](_0x34543b,_0x531155(0x192));return _0xc5da6e&&(_0xc5da6e[_0x531155(0x1e3)]>=0x1&&_0xc5da6e[_0x531155(0x1e3)]<=0x33&&(_0xdd6138=_0xc5da6e[_0x531155(0x1e3)])),_0xdd6138;},transCodeUtil[_0xe5600b(0x17d)]=function(_0x303a38,_0x3cc450){const _0x3fc35d=_0xe5600b;let _0x19f0cf=dbConfigTable[_0x3fc35d(0x1f0)](_0x303a38,_0x3fc35d(0x1ba)),_0x4d616d=['ultrafast',_0x3fc35d(0x179),_0x3fc35d(0x195),_0x3fc35d(0x19c)];function _0x429dbb(_0x36fb39){const _0x2b59cd=_0x3fc35d;if((_0x3cc450=='h264_nvenc'||_0x3cc450==_0x2b59cd(0x19d))&&_0x36fb39==_0x2b59cd(0x1b9))return'p1';if(_0x3cc450==_0x2b59cd(0x1e7)&&(_0x36fb39==_0x2b59cd(0x1b9)||_0x36fb39=='superfast'))return _0x2b59cd(0x1b7);return _0x36fb39;}return _0x19f0cf&&_0x19f0cf[_0x3fc35d(0x1e3)]&&_0x4d616d[_0x3fc35d(0x1c0)](_0x19f0cf[_0x3fc35d(0x1e3)])?_0x429dbb(_0x19f0cf[_0x3fc35d(0x1e3)]):_0x3fc35d(0x195);},transCodeUtil[_0xe5600b(0x1a7)]=function(_0x4e3643,_0x569fab){const _0x4ae6fd=_0xe5600b;let _0x287fe1='';if(_0x569fab){if(_0x569fab[_0x4ae6fd(0x1ea)]){let _0x265a0d=_0x569fab['codec_name']['toLowerCase']();(_0x265a0d[_0x4ae6fd(0x176)](_0x4ae6fd(0x1c2))!=-0x1||_0x265a0d[_0x4ae6fd(0x176)](_0x4ae6fd(0x171))!=-0x1)&&(_0x287fe1=_0x4ae6fd(0x1a4)),_0x265a0d[_0x4ae6fd(0x176)](_0x4ae6fd(0x1ab))!=-0x1&&(_0x287fe1=_0x4ae6fd(0x18b));}if(!_0x287fe1&&_0x569fab[_0x4ae6fd(0x178)]){let _0x8a6ece=_0x569fab[_0x4ae6fd(0x178)][_0x4ae6fd(0x1f7)]();(_0x8a6ece[_0x4ae6fd(0x176)]('h264')!=-0x1||_0x8a6ece['indexOf']('h.264')!=-0x1)&&(_0x287fe1='H264'),(_0x8a6ece[_0x4ae6fd(0x176)]('hevc')!=-0x1||_0x8a6ece[_0x4ae6fd(0x176)](_0x4ae6fd(0x1a9))!=-0x1)&&(_0x287fe1='HEVC');}}!_0x287fe1&&(console['log'](_0x4ae6fd(0x175)),_0x287fe1=_0x4ae6fd(0x18b));let _0xa6af1a={'decoderCommand':'','encoderName':_0x4ae6fd(0x1b5),'coderName':_0x4ae6fd(0x1b6)},_0x4a60cc=dbConfigTable[_0x4ae6fd(0x1f0)](_0x4e3643,_0x4ae6fd(0x1d1)),_0x61c9e8='';if(_0x287fe1==_0x4ae6fd(0x18b)){let _0x3d4772=dbConfigTable['findByTitle'](_0x4e3643,_0x4ae6fd(0x1e4));_0x3d4772&&_0x3d4772[_0x4ae6fd(0x1e3)]&&(_0x61c9e8=_0x3d4772[_0x4ae6fd(0x1e3)]);}else{if(_0x287fe1==_0x4ae6fd(0x1a4)){let _0x455ffb=dbConfigTable[_0x4ae6fd(0x1f0)](_0x4e3643,'transCodeParams-CoderNameH264');_0x455ffb&&_0x455ffb[_0x4ae6fd(0x1e3)]&&(_0x61c9e8=_0x455ffb[_0x4ae6fd(0x1e3)]);}}if(_0x4a60cc&&_0x4a60cc[_0x4ae6fd(0x1e3)])try{let _0x2ee146=[];_0x4a60cc=JSON[_0x4ae6fd(0x1c9)](_0x4a60cc[_0x4ae6fd(0x1e3)]);for(let _0x2842aa of _0x4a60cc){_0x2842aa[_0x4ae6fd(0x190)]==_0x287fe1&&_0x2ee146[_0x4ae6fd(0x1f1)](_0x2842aa);}if(_0x2ee146['length']>0x0){if(!_0x61c9e8)_0xa6af1a=_0x2ee146[0x0];else{let _0x149907=![];for(let _0x43ee5e of _0x2ee146){if(_0x43ee5e[_0x4ae6fd(0x1c8)]==_0x61c9e8){_0xa6af1a=_0x43ee5e,_0x149907=!![];break;}}!_0x149907&&(console[_0x4ae6fd(0x1e1)](_0x4ae6fd(0x188),_0x2ee146[0x0]),_0xa6af1a=_0x2ee146[0x0]);}}}catch(_0x22dfbe){console[_0x4ae6fd(0x1e1)](_0x22dfbe);}return _0xa6af1a;},transCodeUtil[_0xe5600b(0x1d8)]=function(_0x871c9e){const _0x1ea158=_0xe5600b;let _0x1758d3=0x5,_0x4ce195=_0x1758d3,_0xdf0deb=dbConfigTable[_0x1ea158(0x1f0)](_0x871c9e,_0x1ea158(0x1e5));if(_0xdf0deb&&_0xdf0deb[_0x1ea158(0x1e3)])try{_0x4ce195=parseInt(_0xdf0deb[_0x1ea158(0x1e3)]),(_0x4ce195<0x2||_0x4ce195>0x1e)&&(_0x4ce195=_0x1758d3);}catch(_0x5ebdfd){return _0x1758d3;}return _0x4ce195;},transCodeUtil[_0xe5600b(0x1df)]=function(_0x1ffc81,_0x457edb){const _0xdf6aa0=_0xe5600b;return _0xdf6aa0(0x197);},transCodeUtil['decoderSupportPixFormat']=function(_0x330706,_0x2c893e){const _0x5b56ac=_0xe5600b;let _0x23d128=_0x330706['pix_fmt'];if(_0x23d128){_0x23d128=_0x23d128[_0x5b56ac(0x1c5)]();if(pixFormatList[_0x2c893e]){if(!pixFormatList[_0x2c893e]['includes'](_0x23d128))return![];}}return!![];},module[_0xe5600b(0x1c3)]=transCodeUtil;