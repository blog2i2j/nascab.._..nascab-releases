const _0x1de127=_0x2f11;(function(_0x45a86c,_0x286c0d){const _0x34acc3=_0x2f11,_0x330219=_0x45a86c();while(!![]){try{const _0x154f47=parseInt(_0x34acc3(0x175))/0x1+parseInt(_0x34acc3(0x150))/0x2*(-parseInt(_0x34acc3(0x168))/0x3)+parseInt(_0x34acc3(0x10c))/0x4*(parseInt(_0x34acc3(0x177))/0x5)+-parseInt(_0x34acc3(0x16a))/0x6+parseInt(_0x34acc3(0x179))/0x7+-parseInt(_0x34acc3(0x187))/0x8*(-parseInt(_0x34acc3(0x11c))/0x9)+parseInt(_0x34acc3(0x114))/0xa*(parseInt(_0x34acc3(0x180))/0xb);if(_0x154f47===_0x286c0d)break;else _0x330219['push'](_0x330219['shift']());}catch(_0x17dfa8){_0x330219['push'](_0x330219['shift']());}}}(_0x32f3,0x6f13e));let path=require(_0x1de127(0x13f)),fs=require('fs');const Database=require(_0x1de127(0x12a));let transCodeUtil={};function _0x2f11(_0x5c850a,_0x2106b2){const _0x32f391=_0x32f3();return _0x2f11=function(_0x2f1137,_0x1bd157){_0x2f1137=_0x2f1137-0x10a;let _0x492af2=_0x32f391[_0x2f1137];return _0x492af2;},_0x2f11(_0x5c850a,_0x2106b2);}const config=require('../myConfig/config');let fileUtil=require(_0x1de127(0x14f));const dbConfigTable=require(_0x1de127(0x125)),chldProcess=require(_0x1de127(0x164));let nasTrans=require(_0x1de127(0x192)),FFmpeg=nasTrans[_0x1de127(0x157)];const dbFileIndexTable=require(_0x1de127(0x142));let dbPrivateSpaceTable=require('../db/dbPrivateSpaceTable'),sha256=require(_0x1de127(0x130)),cryptoUtils=require('../express-server/utils/cryptoUtils');const os=require('os');let platform=os[_0x1de127(0x144)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x1de127(0x13a));let pixFormatList={'h264_nvenc':['yuv420p',_0x1de127(0x10f),_0x1de127(0x18e),_0x1de127(0x173),_0x1de127(0x14d),_0x1de127(0x133),_0x1de127(0x123),_0x1de127(0x147),'cuda',_0x1de127(0x11f)],'nvenc_h264':[_0x1de127(0x167),_0x1de127(0x10f),'p010le',_0x1de127(0x173),_0x1de127(0x14d),_0x1de127(0x133),_0x1de127(0x123),_0x1de127(0x147),'cuda','d3d11'],'h264_qsv':[_0x1de127(0x10f),_0x1de127(0x18e),_0x1de127(0x136),_0x1de127(0x167)],'hevc_qsv':[_0x1de127(0x10f),_0x1de127(0x18e),_0x1de127(0x132),_0x1de127(0x159),'qsv'],'h264_mf':[_0x1de127(0x10f),_0x1de127(0x167)],'h264_amf':['nv12','yuv420p',_0x1de127(0x11f),_0x1de127(0x172)],'libopenh264':[_0x1de127(0x167)],'libx264':[_0x1de127(0x167),'yuv422p',_0x1de127(0x166),_0x1de127(0x173),'yuvj444p','nv12',_0x1de127(0x15e),_0x1de127(0x13b),_0x1de127(0x16d),'yuv422p10le','yuv444p10le',_0x1de127(0x121),'gray',_0x1de127(0x160)],'h264_vaapi':[_0x1de127(0x14b),_0x1de127(0x167)],'h264_cuvid':[_0x1de127(0x174),'nv12',_0x1de127(0x18e),'p016le'],'hevc_cuvid':['cuda','nv12',_0x1de127(0x18e),_0x1de127(0x14d)]};function getPwdFromToken(_0x4c8ec7,_0x511a06,_0x104310){const _0x450868=_0x1de127;let _0x3a062d=dbPrivateSpaceTable[_0x450868(0x13e)](_0x511a06,_0x4c8ec7);!_0x3a062d&&_0x104310(_0x450868(0x16e),pwd);let _0x4e71a3=_0x3a062d[_0x450868(0x17b)];cryptoUtils[_0x450868(0x18b)](config[_0x450868(0x14a)],_0x4e71a3)[_0x450868(0x15a)](_0x4dcf92=>{_0x104310(![],_0x4dcf92);});}transCodeUtil[_0x1de127(0x186)]=function(_0x3fa606){const _0x2e9d45=_0x1de127;if(typeof _0x3fa606!==_0x2e9d45(0x10d))return _0x3fa606;return platform==_0x2e9d45(0x17d)&&_0x3fa606[_0x2e9d45(0x12f)]>0x103?'\x5c\x5c?\x5c'+_0x3fa606:_0x3fa606;},transCodeUtil[_0x1de127(0x128)]=function(_0x2801dd,_0x39fb70,_0x1f2d2a){return new Promise((_0x13e0ac,_0x490f84)=>{const _0x106a3f=_0x2f11;if(_0x1f2d2a[_0x106a3f(0x17f)]&&!_0x1f2d2a['spaceId']){let _0x42c187=dbFileIndexTable[_0x106a3f(0x140)](_0x1f2d2a['serverType']),_0x23328d=dbFileIndexTable[_0x106a3f(0x10a)](_0x2801dd,_0x1f2d2a[_0x106a3f(0x17f)],_0x42c187);if(!_0x23328d)return _0x490f84(_0x106a3f(0x143));if(_0x23328d[_0x106a3f(0x178)]!=0x2)return _0x490f84('index\x20isn\x27t\x20video');if(_0x23328d[_0x106a3f(0x15f)]==_0x106a3f(0x188))return _0x490f84(_0x106a3f(0x10b));let _0x3608e9=JSON['parse'](_0x23328d[_0x106a3f(0x15f)]),_0x2f354e=_0x23328d[_0x106a3f(0x13f)]+path[_0x106a3f(0x146)]+_0x23328d[_0x106a3f(0x169)];return _0x13e0ac({'fullpath':_0x2f354e,'streamList':_0x3608e9,'duration':_0x23328d[_0x106a3f(0x13d)]});}else{if(_0x1f2d2a['filePath']&&!_0x1f2d2a[_0x106a3f(0x127)]){let _0x5ac00d=fileUtil[_0x106a3f(0x14e)](_0x1f2d2a[_0x106a3f(0x111)]);fs[_0x106a3f(0x131)](_0x5ac00d,(_0xe22fdd,_0x3c32b6)=>{const _0x4df250=_0x106a3f;if(_0xe22fdd)return _0x490f84('file\x20does\x20not\x20exist');else FFmpeg()['input'](transCodeUtil[_0x4df250(0x186)](_0x5ac00d))['ffprobe']((_0xfa4a4b,_0x159e91)=>{const _0xd538d3=_0x4df250;if(_0xfa4a4b)return console[_0xd538d3(0x116)](_0xfa4a4b),_0x490f84(_0xd538d3(0x165));else{let _0x5a639d=videoStreamUtil[_0xd538d3(0x18d)](_0x159e91),_0x1d71fc=_0x159e91[_0xd538d3(0x182)];return _0x13e0ac({'fullpath':_0x5ac00d,'streamList':_0x1d71fc,'duration':_0x5a639d});}});});}else{if(_0x1f2d2a['spaceId']){let _0x3c44f9=_0x1f2d2a[_0x106a3f(0x127)],_0x1746cd=dbPrivateSpaceTable['getById'](_0x39fb70,_0x3c44f9);if(!_0x1746cd)return _0x490f84(_0x106a3f(0x139));let _0x15f687=path['join'](_0x1746cd[_0x106a3f(0x18f)],fileUtil[_0x106a3f(0x14e)](_0x1f2d2a['filePath']));fs[_0x106a3f(0x131)](_0x15f687,(_0x37faad,_0x4b3c04)=>{const _0x34c476=_0x106a3f;if(_0x37faad)return _0x490f84(_0x34c476(0x13c));getPwdFromToken(_0x1f2d2a[_0x34c476(0x17e)],_0x39fb70,(_0x52ade4,_0xea961b)=>{const _0x3544ad=_0x34c476;if(_0x52ade4)return _0x490f84(_0x3544ad(0x124));let _0x42722d=config[_0x3544ad(0x176)](_0x1746cd[_0x3544ad(0x18f)]),_0x4ed480=new Database(_0x42722d,{});_0x4ed480['pragma'](_0x3544ad(0x16f));let _0x5aa45e=_0x4ed480['prepare'](_0x3544ad(0x138))[_0x3544ad(0x162)](_0x1f2d2a[_0x3544ad(0x15d)]);if(!_0x5aa45e||!_0x5aa45e['stream_info'])return _0x490f84('index\x20id\x20does\x20not\x20exist');_0x4ed480[_0x3544ad(0x16b)]();let _0x279e95=JSON[_0x3544ad(0x16c)](_0x5aa45e['stream_info']);return _0x13e0ac({'fullpath':_0x15f687,'streamList':_0x279e95,'needDecrypt':!![],'pwd':_0xea961b,'duration':_0x5aa45e[_0x3544ad(0x13d)]});});});}}}});},transCodeUtil[_0x1de127(0x110)]=function(_0x563e53){const _0x5b7d0b=_0x1de127;let _0x462570=0x1e,_0x400e18=![];try{if(_0x563e53['r_frame_rate']){let _0x143aa1=_0x563e53['r_frame_rate'][_0x5b7d0b(0x154)]('/');(_0x143aa1[_0x5b7d0b(0x12f)]=0x2)&&(_0x400e18=Math[_0x5b7d0b(0x191)](parseInt(_0x143aa1[0x0])/parseInt(_0x143aa1[0x1])));}if(!_0x400e18){if(_0x563e53[_0x5b7d0b(0x156)]){let _0x2b9134=_0x563e53[_0x5b7d0b(0x156)][_0x5b7d0b(0x154)]('/');(_0x2b9134[_0x5b7d0b(0x12f)]=0x2)&&(_0x400e18=Math[_0x5b7d0b(0x191)](parseInt(_0x2b9134[0x0])/parseInt(_0x2b9134[0x1])));}}}catch(_0x1f2b68){console[_0x5b7d0b(0x116)](_0x5b7d0b(0x137),_0x1f2b68);}return _0x400e18&&_0x400e18<=0x3c&&(_0x462570=_0x400e18),_0x462570;},transCodeUtil[_0x1de127(0x12e)]=function(_0x5908a8,_0x110e88){const _0x5e2c8c=_0x1de127;let _0x591258=[];for(let _0x575909=0x0;_0x575909<_0x5908a8[_0x5e2c8c(0x12f)];_0x575909++){let _0x4ed3d3=_0x5908a8[_0x575909];_0x4ed3d3[_0x5e2c8c(0x134)]==_0x5e2c8c(0x113)&&_0x591258['push'](_0x4ed3d3);}if(_0x591258[_0x5e2c8c(0x12f)]>_0x110e88)return _0x591258[_0x110e88];return null;},transCodeUtil[_0x1de127(0x153)]=function(_0x4eea22){const _0x30cf86=_0x1de127;let _0x59b170=videoStreamUtil[_0x30cf86(0x148)](_0x4eea22);return _0x59b170;},transCodeUtil['getScaleOption']=function(_0x3b1dc3,_0x546120,_0x2591a9){const _0x40b42d=_0x1de127;let _0x4c0885=null;if(_0x546120&&_0x2591a9&&_0x3b1dc3)_0x3b1dc3>_0x546120&&_0x3b1dc3>_0x2591a9&&(_0x3b1dc3=_0x546120>_0x2591a9?_0x546120:_0x2591a9),_0x546120>_0x2591a9?_0x4c0885=_0x40b42d(0x122)+_0x3b1dc3+_0x40b42d(0x158):_0x4c0885=_0x40b42d(0x12b)+_0x3b1dc3;else{}return _0x4c0885;},transCodeUtil[_0x1de127(0x129)]=function(_0x273ca2,_0x39a35f){const _0x1ed860=_0x1de127;return _0x39a35f==-0x1&&(_0x273ca2&&_0x273ca2[_0x1ed860(0x184)]&&_0x273ca2[_0x1ed860(0x184)]>0xf4240&&_0x273ca2[_0x1ed860(0x184)]!='N/A'?(_0x39a35f=_0x273ca2[_0x1ed860(0x184)]/0x3e8,_0x39a35f>BITRATE_MAX&&(_0x39a35f=BITRATE_MAX)):_0x39a35f=BITRATE_DEFAULT),_0x39a35f;},transCodeUtil[_0x1de127(0x193)]=function(_0x5b5d61){const _0x18689a=_0x1de127;let _0xdcb74=0x17,_0x5cb785=dbConfigTable[_0x18689a(0x149)](_0x5b5d61,'crf');return _0x5cb785&&(_0x5cb785['value']>=0x1&&_0x5cb785[_0x18689a(0x126)]<=0x33&&(_0xdcb74=_0x5cb785['value'])),_0xdcb74;},transCodeUtil[_0x1de127(0x17a)]=function(_0x4bd1a5,_0x46ad67){const _0x578e6e=_0x1de127;let _0x363152=dbConfigTable[_0x578e6e(0x149)](_0x4bd1a5,'transcodeSpeed'),_0x319fd8=[_0x578e6e(0x189),_0x578e6e(0x15c),_0x578e6e(0x135),_0x578e6e(0x145)];function _0x265a9a(_0x44fe61){const _0x59ffc1=_0x578e6e;if((_0x46ad67==_0x59ffc1(0x120)||_0x46ad67==_0x59ffc1(0x190))&&_0x44fe61==_0x59ffc1(0x189))return'p1';if(_0x46ad67==_0x59ffc1(0x171)&&(_0x44fe61=='ultrafast'||_0x44fe61==_0x59ffc1(0x15b)))return'veryfast';return _0x44fe61;}return _0x363152&&_0x363152[_0x578e6e(0x126)]&&_0x319fd8[_0x578e6e(0x163)](_0x363152['value'])?_0x265a9a(_0x363152[_0x578e6e(0x126)]):_0x578e6e(0x135);},transCodeUtil[_0x1de127(0x18a)]=function(_0x48fc5a,_0x5c14e2){const _0x13ce20=_0x1de127;let _0x2a7d35='';if(_0x5c14e2){if(_0x5c14e2['codec_name']){let _0x50c64e=_0x5c14e2[_0x13ce20(0x11e)]['toLowerCase']();(_0x50c64e['indexOf'](_0x13ce20(0x155))!=-0x1||_0x50c64e[_0x13ce20(0x17c)]('h.264')!=-0x1)&&(_0x2a7d35='H264'),_0x50c64e[_0x13ce20(0x17c)]('hevc')!=-0x1&&(_0x2a7d35='HEVC');}if(!_0x2a7d35&&_0x5c14e2[_0x13ce20(0x14c)]){let _0x53a49d=_0x5c14e2[_0x13ce20(0x14c)][_0x13ce20(0x11a)]();(_0x53a49d[_0x13ce20(0x17c)]('h264')!=-0x1||_0x53a49d[_0x13ce20(0x17c)](_0x13ce20(0x161))!=-0x1)&&(_0x2a7d35=_0x13ce20(0x11d)),(_0x53a49d[_0x13ce20(0x17c)](_0x13ce20(0x181))!=-0x1||_0x53a49d[_0x13ce20(0x17c)](_0x13ce20(0x118))!=-0x1)&&(_0x2a7d35=_0x13ce20(0x183));}}!_0x2a7d35&&(console[_0x13ce20(0x116)]('video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc'),_0x2a7d35=_0x13ce20(0x183));let _0x16889a={'decoderCommand':'','encoderName':_0x13ce20(0x119),'coderName':_0x13ce20(0x11b)},_0x4d8771=dbConfigTable[_0x13ce20(0x149)](_0x48fc5a,_0x13ce20(0x112)),_0x4afa73='';if(_0x2a7d35==_0x13ce20(0x183)){let _0x8ee9e8=dbConfigTable['findByTitle'](_0x48fc5a,_0x13ce20(0x115));_0x8ee9e8&&_0x8ee9e8['value']&&(_0x4afa73=_0x8ee9e8[_0x13ce20(0x126)]);}else{if(_0x2a7d35==_0x13ce20(0x11d)){let _0x54cabf=dbConfigTable[_0x13ce20(0x149)](_0x48fc5a,_0x13ce20(0x152));_0x54cabf&&_0x54cabf['value']&&(_0x4afa73=_0x54cabf['value']);}}if(_0x4d8771&&_0x4d8771[_0x13ce20(0x126)])try{let _0x194b40=[];_0x4d8771=JSON['parse'](_0x4d8771[_0x13ce20(0x126)]);for(let _0x3c490a of _0x4d8771){_0x3c490a[_0x13ce20(0x10e)]==_0x2a7d35&&_0x194b40[_0x13ce20(0x141)](_0x3c490a);}if(_0x194b40[_0x13ce20(0x12f)]>0x0){if(!_0x4afa73)_0x16889a=_0x194b40[0x0];else{let _0x5c09c6=![];for(let _0x587e55 of _0x194b40){if(_0x587e55[_0x13ce20(0x12d)]==_0x4afa73){_0x16889a=_0x587e55,_0x5c09c6=!![];break;}}!_0x5c09c6&&(console[_0x13ce20(0x116)](_0x13ce20(0x117),_0x194b40[0x0]),_0x16889a=_0x194b40[0x0]);}}}catch(_0x26ac7e){console[_0x13ce20(0x116)](_0x26ac7e);}return _0x16889a;},transCodeUtil[_0x1de127(0x12c)]=function(_0x111c40){const _0x2e598e=_0x1de127;let _0x55bcf8=0x5,_0x327bcb=_0x55bcf8,_0x5f270b=dbConfigTable[_0x2e598e(0x149)](_0x111c40,_0x2e598e(0x151));if(_0x5f270b&&_0x5f270b[_0x2e598e(0x126)])try{_0x327bcb=parseInt(_0x5f270b[_0x2e598e(0x126)]),(_0x327bcb<0x2||_0x327bcb>0x1e)&&(_0x327bcb=_0x55bcf8);}catch(_0x2867bd){return _0x55bcf8;}return _0x327bcb;},transCodeUtil['getPixFmt']=function(_0x548b1b,_0x5bdfac){const _0x110bde=_0x1de127;return _0x110bde(0x167);},transCodeUtil[_0x1de127(0x18c)]=function(_0x25476e,_0x5af83a){const _0x4e99a1=_0x1de127;let _0x5ccd5a=_0x25476e[_0x4e99a1(0x170)];if(_0x5ccd5a){_0x5ccd5a=_0x5ccd5a['trim']();if(pixFormatList[_0x5af83a]){if(!pixFormatList[_0x5af83a]['includes'](_0x5ccd5a))return![];}}return!![];},module[_0x1de127(0x185)]=transCodeUtil;function _0x32f3(){const _0x87938d=['high\x20efficiency\x20video\x20coding','libx264','toLowerCase','CPU','675XOZwAa','H264','codec_name','d3d11','h264_nvenc','nv20le','scale=','bgr0','err','../db/dbConfigTable','value','spaceId','parseVideoFullPath','getVideoBitrate','better-sqlite3','scale=-2:','getReadRate','coderName','parseSubtitle','length','sha256','stat','yuyv422','yuv444p16le','codec_type','medium','qsv','error','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','space\x20does\x20not\x20exist','./videoStreamUtil','nv21','file\x20does\x20not\x20exist','duration','getTokenObjByToken','path','getIndexTableNameByType','push','../db/dbFileIndexTable','index\x20does\x20not\x20exist','platform','slow','sep','rgb0','parseVideoWH','findByTitle','tokenPwdEncryptKey','vaapi_vld','codec_long_name','p016le','decodePath','../express-server/utils/fileUtils','50MVBymo','transCodeParams-readrate','transCodeParams-CoderNameH264','parseStreamList','split','h264','avg_frame_rate','FFmpeg',':-2','y210le','then','superfast','fast','spaceIndexId','nv16','stream_info','gray10le','h.264','get','includes','child_process','stream读取失败','yuvj422p','yuv420p','98628nRscfV','filename','5064876yqujoP','close','parse','yuv420p10le','token\x20expired','journal_mode\x20=\x20WAL','pix_fmt','h264_qsv','dxva2_vld','yuv444p','cuda','174353LZARjz','getPrivateDbPath','30gkwkXQ','type','44184TSqbKV','getTranscodeSpeed','pwd','indexOf','win32','spaceToken','indexId','165gUmVjd','hevc','streams','HEVC','bit_rate','exports','dealFFmpegPath','2152OkfmOR','undefined','ultrafast','getCoderConfig','decryptString','decoderSupportPixFormat','getDurationFromStream','p010le','folder_path','nvenc_h264','ceil','../libs/nasTrans','getCrf','getById','stream\x20info\x20is\x20null','71540TKtEFA','string','decoderType','nv12','getFps','filePath','transCodeParams-coderList','subtitle','1208580QpfIEJ','transCodeParams-CoderNameHevc','log','用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器'];_0x32f3=function(){return _0x87938d;};return _0x32f3();}