const _0x1fcb38=_0x1fc4;(function(_0xbbe05,_0x5659a4){const _0x4e565d=_0x1fc4,_0x2f29fe=_0xbbe05();while(!![]){try{const _0x15efa7=-parseInt(_0x4e565d(0x1d4))/0x1+-parseInt(_0x4e565d(0x221))/0x2*(parseInt(_0x4e565d(0x1eb))/0x3)+-parseInt(_0x4e565d(0x1d7))/0x4*(parseInt(_0x4e565d(0x1d5))/0x5)+-parseInt(_0x4e565d(0x21e))/0x6*(-parseInt(_0x4e565d(0x225))/0x7)+-parseInt(_0x4e565d(0x20c))/0x8+parseInt(_0x4e565d(0x1a4))/0x9+parseInt(_0x4e565d(0x1c9))/0xa;if(_0x15efa7===_0x5659a4)break;else _0x2f29fe['push'](_0x2f29fe['shift']());}catch(_0x3c722c){_0x2f29fe['push'](_0x2f29fe['shift']());}}}(_0x5558,0x27a45));let path=require(_0x1fcb38(0x1da)),fs=require('fs');const Database=require('better-sqlite3');let transCodeUtil={};const config=require('../myConfig/config');let fileUtil=require(_0x1fcb38(0x215));const dbConfigTable=require(_0x1fcb38(0x21b)),chldProcess=require('child_process');let nasTrans=require(_0x1fcb38(0x216)),FFmpeg=nasTrans[_0x1fcb38(0x1d9)];const dbFileIndexTable=require(_0x1fcb38(0x1f2));let dbPrivateSpaceTable=require(_0x1fcb38(0x226)),sha256=require(_0x1fcb38(0x1fa)),cryptoUtils=require(_0x1fcb38(0x1ed));const os=require('os');function _0x1fc4(_0x14bdb9,_0x3b9cce){const _0x5558c8=_0x5558();return _0x1fc4=function(_0x1fc49b,_0x5d4a8b){_0x1fc49b=_0x1fc49b-0x1a1;let _0xe1bfd3=_0x5558c8[_0x1fc49b];return _0xe1bfd3;},_0x1fc4(_0x14bdb9,_0x3b9cce);}let platform=os[_0x1fcb38(0x224)]();const BITRATE_MAX=0xd6d8,BITRATE_DEFAULT=0xbb8,videoStreamUtil=require(_0x1fcb38(0x1e6));let pixFormatList={'h264_nvenc':[_0x1fcb38(0x1be),_0x1fcb38(0x1ca),_0x1fcb38(0x1cc),_0x1fcb38(0x1f3),_0x1fcb38(0x20f),_0x1fcb38(0x1f4),_0x1fcb38(0x21a),'rgb0',_0x1fcb38(0x1b3),_0x1fcb38(0x21c)],'nvenc_h264':[_0x1fcb38(0x1be),'nv12',_0x1fcb38(0x1cc),'yuv444p','p016le',_0x1fcb38(0x1f4),_0x1fcb38(0x21a),_0x1fcb38(0x1f0),_0x1fcb38(0x1b3),_0x1fcb38(0x21c)],'h264_qsv':[_0x1fcb38(0x1ca),_0x1fcb38(0x1cc),_0x1fcb38(0x1c7),_0x1fcb38(0x1be)],'hevc_qsv':['nv12','p010le','yuyv422',_0x1fcb38(0x1db),_0x1fcb38(0x1c7)],'h264_mf':[_0x1fcb38(0x1ca),'yuv420p'],'h264_amf':['nv12',_0x1fcb38(0x1be),_0x1fcb38(0x21c),_0x1fcb38(0x213)],'libopenh264':[_0x1fcb38(0x1be)],'libx264':[_0x1fcb38(0x1be),_0x1fcb38(0x205),_0x1fcb38(0x1b8),'yuv444p','yuvj444p','nv12',_0x1fcb38(0x1b6),_0x1fcb38(0x1e0),_0x1fcb38(0x1fb),'yuv422p10le',_0x1fcb38(0x1d6),_0x1fcb38(0x1cd),_0x1fcb38(0x214),_0x1fcb38(0x1f8)],'h264_vaapi':[_0x1fcb38(0x1bc),'yuv420p'],'h264_cuvid':[_0x1fcb38(0x1b3),'nv12',_0x1fcb38(0x1cc),_0x1fcb38(0x20f)],'hevc_cuvid':[_0x1fcb38(0x1b3),_0x1fcb38(0x1ca),_0x1fcb38(0x1cc),_0x1fcb38(0x20f)]};function getPwdFromToken(_0x4f4011,_0x2b6fe7,_0x391bc4){const _0x27825b=_0x1fcb38;let _0x59b08c=dbPrivateSpaceTable[_0x27825b(0x1a5)](_0x2b6fe7,_0x4f4011);!_0x59b08c&&_0x391bc4(_0x27825b(0x1e3),pwd);let _0x145c10=_0x59b08c[_0x27825b(0x212)];cryptoUtils[_0x27825b(0x201)](config[_0x27825b(0x210)],_0x145c10)[_0x27825b(0x1bd)](_0x146d67=>{_0x391bc4(![],_0x146d67);});}function _0x5558(){const _0x297c14=['./videoStreamUtil','transCodeParams-CoderNameHevc','scale=','ceil','getFps','136191dCsGom','medium','../express-server/utils/cryptoUtils','coderName','avg_frame_rate','rgb0','getDurationFromStream','../db/dbFileIndexTable','yuv444p','yuv444p16le','parse','type','codec_name','gray10le','bit_rate','sha256','yuv420p10le','undefined','indexId','hevc','parseSubtitle','nvenc_h264','decryptString','dealFFmpegPath','subtitle','pix_fmt','yuv422p','string','ffprobe','pragma','superfast','exports','ultrafast','1405984XIhpKb','spaceId','folder_path','p016le','tokenPwdEncryptKey','filename','pwd','dxva2_vld','gray','../express-server/utils/fileUtils','../libs/nasTrans','transCodeParams-readrate','includes','transCodeParams-coderList','bgr0','../db/dbConfigTable','d3d11','stream_info','102UccsVG','h264','SELECT\x20*\x20FROM\x20private_space_index\x20WHERE\x20id=?','10JsgxYS','filePath','split','platform','30716NVMJNp','../db/dbPrivateSpaceTable','space\x20does\x20not\x20exist','index\x20does\x20not\x20exist','high\x20efficiency\x20video\x20coding','1190583zcRfZB','getTokenObjByToken','getReadRate','stream\x20info\x20is\x20null','getById','findByTitle','log','value','push','decoderSupportPixFormat','r_frame_rate','stat','H264','decodePath','getPixFmt','cuda','journal_mode\x20=\x20WAL','crf','nv16','trim','yuvj422p','file\x20does\x20not\x20exist','toLowerCase','win32','vaapi_vld','then','yuv420p','libx264','scale=-2:',':-2','\x5c\x5c?\x5c','serverType','transCodeParams-CoderNameH264','index\x20id\x20does\x20not\x20exist','parseVideoFullPath','qsv','duration','9559670AOOGvE','nv12','getIndexTableNameByType','p010le','nv20le','video\x20codec\x20type\x20is\x20null，set\x20to\x20hevc','indexOf','CPU','getCrf','HEVC','sep','324043dtiSIP','23195StTICA','yuv444p10le','236rXwJJU','N/A','FFmpeg','path','y210le','codec_long_name','join','parseStreamList','getScaleOption','nv21','spaceIndexId','slow','token\x20expired','prepare','length'];_0x5558=function(){return _0x297c14;};return _0x5558();}transCodeUtil[_0x1fcb38(0x202)]=function(_0x1d7f1e){const _0x3eb34b=_0x1fcb38;if(typeof _0x1d7f1e!==_0x3eb34b(0x206))return _0x1d7f1e;return platform==_0x3eb34b(0x1bb)&&_0x1d7f1e[_0x3eb34b(0x1e5)]>0x103?_0x3eb34b(0x1c2)+_0x1d7f1e:_0x1d7f1e;},transCodeUtil[_0x1fcb38(0x1c6)]=function(_0x458e6e,_0x444f53,_0x3b865c){return new Promise((_0x1eccac,_0x17e417)=>{const _0x201202=_0x1fc4;if(_0x3b865c[_0x201202(0x1fd)]&&!_0x3b865c[_0x201202(0x20d)]){let _0x2cca0a=dbFileIndexTable[_0x201202(0x1cb)](_0x3b865c[_0x201202(0x1c3)]),_0x2276ae=dbFileIndexTable[_0x201202(0x1a8)](_0x458e6e,_0x3b865c[_0x201202(0x1fd)],_0x2cca0a);if(!_0x2276ae)return _0x17e417(_0x201202(0x1a2));if(_0x2276ae[_0x201202(0x1f6)]!=0x2)return _0x17e417('index\x20isn\x27t\x20video');if(_0x2276ae['stream_info']==_0x201202(0x1fc))return _0x17e417(_0x201202(0x1a7));let _0x7e63ba=JSON[_0x201202(0x1f5)](_0x2276ae[_0x201202(0x21d)]),_0x178233=_0x2276ae[_0x201202(0x1da)]+path[_0x201202(0x1d3)]+_0x2276ae[_0x201202(0x211)];return _0x1eccac({'fullpath':_0x178233,'streamList':_0x7e63ba,'duration':_0x2276ae[_0x201202(0x1c8)]});}else{if(_0x3b865c[_0x201202(0x222)]&&!_0x3b865c[_0x201202(0x20d)]){let _0x12b714=fileUtil[_0x201202(0x1b1)](_0x3b865c[_0x201202(0x222)]);fs['stat'](_0x12b714,(_0xf8fc4b,_0x474093)=>{const _0x3edc6a=_0x201202;if(_0xf8fc4b)return _0x17e417(_0x3edc6a(0x1b9));else FFmpeg()['input'](transCodeUtil['dealFFmpegPath'](_0x12b714))[_0x3edc6a(0x207)]((_0x59dfce,_0x319750)=>{const _0x3262f1=_0x3edc6a;if(_0x59dfce)return console[_0x3262f1(0x1aa)](_0x59dfce),_0x17e417('stream读取失败');else{let _0x423912=videoStreamUtil[_0x3262f1(0x1f1)](_0x319750),_0x337de8=_0x319750['streams'];return _0x1eccac({'fullpath':_0x12b714,'streamList':_0x337de8,'duration':_0x423912});}});});}else{if(_0x3b865c[_0x201202(0x20d)]){let _0x2da9da=_0x3b865c[_0x201202(0x20d)],_0x53f8a7=dbPrivateSpaceTable[_0x201202(0x1a8)](_0x444f53,_0x2da9da);if(!_0x53f8a7)return _0x17e417(_0x201202(0x1a1));let _0x3fc298=path[_0x201202(0x1dd)](_0x53f8a7[_0x201202(0x20e)],fileUtil[_0x201202(0x1b1)](_0x3b865c[_0x201202(0x222)]));fs[_0x201202(0x1af)](_0x3fc298,(_0x988876,_0x4a0444)=>{const _0x379fc0=_0x201202;if(_0x988876)return _0x17e417(_0x379fc0(0x1b9));getPwdFromToken(_0x3b865c['spaceToken'],_0x444f53,(_0x184d35,_0x12a5cb)=>{const _0x5dafd9=_0x379fc0;if(_0x184d35)return _0x17e417('err');let _0x4d7e9d=config['getPrivateDbPath'](_0x53f8a7[_0x5dafd9(0x20e)]),_0x31280a=new Database(_0x4d7e9d,{});_0x31280a[_0x5dafd9(0x208)](_0x5dafd9(0x1b4));let _0xa71775=_0x31280a[_0x5dafd9(0x1e4)](_0x5dafd9(0x220))['get'](_0x3b865c[_0x5dafd9(0x1e1)]);if(!_0xa71775||!_0xa71775[_0x5dafd9(0x21d)])return _0x17e417(_0x5dafd9(0x1c5));_0x31280a['close']();let _0xde2fc7=JSON[_0x5dafd9(0x1f5)](_0xa71775[_0x5dafd9(0x21d)]);return _0x1eccac({'fullpath':_0x3fc298,'streamList':_0xde2fc7,'needDecrypt':!![],'pwd':_0x12a5cb,'duration':_0xa71775[_0x5dafd9(0x1c8)]});});});}}}});},transCodeUtil[_0x1fcb38(0x1ea)]=function(_0x24aa7d){const _0x599e6f=_0x1fcb38;let _0x590ecc=0x1e,_0x50fde1=![];try{if(_0x24aa7d['r_frame_rate']){let _0x294ec0=_0x24aa7d[_0x599e6f(0x1ae)][_0x599e6f(0x223)]('/');(_0x294ec0[_0x599e6f(0x1e5)]=0x2)&&(_0x50fde1=Math[_0x599e6f(0x1e9)](parseInt(_0x294ec0[0x0])/parseInt(_0x294ec0[0x1])));}if(!_0x50fde1){if(_0x24aa7d[_0x599e6f(0x1ef)]){let _0x4212ea=_0x24aa7d[_0x599e6f(0x1ef)]['split']('/');(_0x4212ea['length']=0x2)&&(_0x50fde1=Math['ceil'](parseInt(_0x4212ea[0x0])/parseInt(_0x4212ea[0x1])));}}}catch(_0x10cd37){console[_0x599e6f(0x1aa)]('error',_0x10cd37);}return _0x50fde1&&_0x50fde1<=0x3c&&(_0x590ecc=_0x50fde1),_0x590ecc;},transCodeUtil[_0x1fcb38(0x1ff)]=function(_0x4969cf,_0x517f4a){const _0x78af1c=_0x1fcb38;let _0x3b8360=[];for(let _0x5263ed=0x0;_0x5263ed<_0x4969cf[_0x78af1c(0x1e5)];_0x5263ed++){let _0x2f9e1a=_0x4969cf[_0x5263ed];_0x2f9e1a['codec_type']==_0x78af1c(0x203)&&_0x3b8360[_0x78af1c(0x1ac)](_0x2f9e1a);}if(_0x3b8360[_0x78af1c(0x1e5)]>_0x517f4a)return _0x3b8360[_0x517f4a];return null;},transCodeUtil[_0x1fcb38(0x1de)]=function(_0x5d0191){let _0x3aee75=videoStreamUtil['parseVideoWH'](_0x5d0191);return _0x3aee75;},transCodeUtil[_0x1fcb38(0x1df)]=function(_0x29d4c9,_0x3d9836,_0x4f102c){const _0x5aea82=_0x1fcb38;let _0xcdb6ed=null;if(_0x3d9836&&_0x4f102c&&_0x29d4c9)_0x29d4c9>_0x3d9836&&_0x29d4c9>_0x4f102c&&(_0x29d4c9=_0x3d9836>_0x4f102c?_0x3d9836:_0x4f102c),_0x3d9836>_0x4f102c?_0xcdb6ed=_0x5aea82(0x1e8)+_0x29d4c9+_0x5aea82(0x1c1):_0xcdb6ed=_0x5aea82(0x1c0)+_0x29d4c9;else{}return _0xcdb6ed;},transCodeUtil['getVideoBitrate']=function(_0xa3fe89,_0x4c8e07){const _0x8fc024=_0x1fcb38;return _0x4c8e07==-0x1&&(_0xa3fe89&&_0xa3fe89[_0x8fc024(0x1f9)]&&_0xa3fe89[_0x8fc024(0x1f9)]>0xf4240&&_0xa3fe89['bit_rate']!=_0x8fc024(0x1d8)?(_0x4c8e07=_0xa3fe89[_0x8fc024(0x1f9)]/0x3e8,_0x4c8e07>BITRATE_MAX&&(_0x4c8e07=BITRATE_MAX)):_0x4c8e07=BITRATE_DEFAULT),_0x4c8e07;},transCodeUtil[_0x1fcb38(0x1d1)]=function(_0x1da09c){const _0x19236d=_0x1fcb38;let _0x2dda80=0x17,_0x5f352c=dbConfigTable[_0x19236d(0x1a9)](_0x1da09c,_0x19236d(0x1b5));return _0x5f352c&&(_0x5f352c[_0x19236d(0x1ab)]>=0x1&&_0x5f352c[_0x19236d(0x1ab)]<=0x33&&(_0x2dda80=_0x5f352c[_0x19236d(0x1ab)])),_0x2dda80;},transCodeUtil['getTranscodeSpeed']=function(_0x3f16fb,_0x2e2d27){const _0x2f32e1=_0x1fcb38;let _0x4dfa92=dbConfigTable[_0x2f32e1(0x1a9)](_0x3f16fb,'transcodeSpeed'),_0x4e3dc3=['ultrafast','fast',_0x2f32e1(0x1ec),_0x2f32e1(0x1e2)];function _0x1f41e7(_0x219b84){const _0x1fc829=_0x2f32e1;if((_0x2e2d27=='h264_nvenc'||_0x2e2d27==_0x1fc829(0x200))&&_0x219b84==_0x1fc829(0x20b))return'p1';if(_0x2e2d27=='h264_qsv'&&(_0x219b84==_0x1fc829(0x20b)||_0x219b84==_0x1fc829(0x209)))return'veryfast';return _0x219b84;}return _0x4dfa92&&_0x4dfa92[_0x2f32e1(0x1ab)]&&_0x4e3dc3['includes'](_0x4dfa92[_0x2f32e1(0x1ab)])?_0x1f41e7(_0x4dfa92[_0x2f32e1(0x1ab)]):_0x2f32e1(0x1ec);},transCodeUtil['getCoderConfig']=function(_0x33f194,_0xc0ba17){const _0x35161b=_0x1fcb38;let _0x41d31f='';if(_0xc0ba17){if(_0xc0ba17[_0x35161b(0x1f7)]){let _0x28afc5=_0xc0ba17['codec_name'][_0x35161b(0x1ba)]();(_0x28afc5[_0x35161b(0x1cf)]('h264')!=-0x1||_0x28afc5[_0x35161b(0x1cf)]('h.264')!=-0x1)&&(_0x41d31f=_0x35161b(0x1b0)),_0x28afc5[_0x35161b(0x1cf)]('hevc')!=-0x1&&(_0x41d31f='HEVC');}if(!_0x41d31f&&_0xc0ba17['codec_long_name']){let _0x116f31=_0xc0ba17[_0x35161b(0x1dc)][_0x35161b(0x1ba)]();(_0x116f31['indexOf'](_0x35161b(0x21f))!=-0x1||_0x116f31['indexOf']('h.264')!=-0x1)&&(_0x41d31f=_0x35161b(0x1b0)),(_0x116f31[_0x35161b(0x1cf)](_0x35161b(0x1fe))!=-0x1||_0x116f31[_0x35161b(0x1cf)](_0x35161b(0x1a3))!=-0x1)&&(_0x41d31f=_0x35161b(0x1d2));}}!_0x41d31f&&(console[_0x35161b(0x1aa)](_0x35161b(0x1ce)),_0x41d31f=_0x35161b(0x1d2));let _0x62b4df={'decoderCommand':'','encoderName':_0x35161b(0x1bf),'coderName':_0x35161b(0x1d0)},_0x58b0ca=dbConfigTable[_0x35161b(0x1a9)](_0x33f194,_0x35161b(0x219)),_0xefef12='';if(_0x41d31f=='HEVC'){let _0xd58619=dbConfigTable[_0x35161b(0x1a9)](_0x33f194,_0x35161b(0x1e7));_0xd58619&&_0xd58619[_0x35161b(0x1ab)]&&(_0xefef12=_0xd58619[_0x35161b(0x1ab)]);}else{if(_0x41d31f==_0x35161b(0x1b0)){let _0x5f18f0=dbConfigTable[_0x35161b(0x1a9)](_0x33f194,_0x35161b(0x1c4));_0x5f18f0&&_0x5f18f0['value']&&(_0xefef12=_0x5f18f0[_0x35161b(0x1ab)]);}}if(_0x58b0ca&&_0x58b0ca['value'])try{let _0x368959=[];_0x58b0ca=JSON['parse'](_0x58b0ca['value']);for(let _0x216bc8 of _0x58b0ca){_0x216bc8['decoderType']==_0x41d31f&&_0x368959['push'](_0x216bc8);}if(_0x368959[_0x35161b(0x1e5)]>0x0){if(!_0xefef12)_0x62b4df=_0x368959[0x0];else{let _0x47cd09=![];for(let _0x328609 of _0x368959){if(_0x328609[_0x35161b(0x1ee)]==_0xefef12){_0x62b4df=_0x328609,_0x47cd09=!![];break;}}!_0x47cd09&&(console[_0x35161b(0x1aa)]('用户设置过的编解码器不在可用列表\x20默认返回第一个编解码器',_0x368959[0x0]),_0x62b4df=_0x368959[0x0]);}}}catch(_0x5e6c69){console['log'](_0x5e6c69);}return _0x62b4df;},transCodeUtil[_0x1fcb38(0x1a6)]=function(_0x4251b5){const _0x100883=_0x1fcb38;let _0x500002=0x5,_0x19ad47=_0x500002,_0x324b0b=dbConfigTable[_0x100883(0x1a9)](_0x4251b5,_0x100883(0x217));if(_0x324b0b&&_0x324b0b[_0x100883(0x1ab)])try{_0x19ad47=parseInt(_0x324b0b[_0x100883(0x1ab)]),(_0x19ad47<0x2||_0x19ad47>0x1e)&&(_0x19ad47=_0x500002);}catch(_0xa389b4){return _0x500002;}return _0x19ad47;},transCodeUtil[_0x1fcb38(0x1b2)]=function(_0x533329,_0x35e34c){const _0x594683=_0x1fcb38;return _0x594683(0x1be);},transCodeUtil[_0x1fcb38(0x1ad)]=function(_0xcfc3fd,_0x1c7f51){const _0x5bbfeb=_0x1fcb38;let _0x309163=_0xcfc3fd[_0x5bbfeb(0x204)];if(_0x309163){_0x309163=_0x309163[_0x5bbfeb(0x1b7)]();if(pixFormatList[_0x1c7f51]){if(!pixFormatList[_0x1c7f51][_0x5bbfeb(0x218)](_0x309163))return![];}}return!![];},module[_0x1fcb38(0x20a)]=transCodeUtil;