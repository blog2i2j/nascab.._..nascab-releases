const _0x7b8aff=_0x1c4a;function _0x5ba0(){const _0x240259=['https','-----','18214911nbPGIb','http','../express-server/utils/cryptoUtils','readFileSync','stringify','listen','log','createServer','toString','3HSFuvi','value','../myConfig/config','../express-server/app','send','journal_mode\x20=\x20WAL','17769YQHdUy','key.pem','3693008YPkUmx','then','../db/dbNoticeCenterTable','nasZs987bac','HTTPS\x20certs\x20not\x20exist','4067ZhYMbR','close','error','../utils/messageUtil','Error\x20occurred\x20in\x20api\x20process\x20','createSecureContext','8vVkDRM','pragma','2296300vVtSNt','(Encrypted\x20https\x20cert)','env','warn','(Custom\x20https\x20key)','HTTPS\x20certs\x20error','stack','usePort','message','decryptString','existsSync','4735395jREbZL','expressStarted','dbOther','certs','apiPortHttps','create','run','https\x20service\x20is\x20running','appRootPath','../db/dbConfigTable','18hJzYyf','findByTitle','16242sZuAaR','6752175moVCpA','证书信息:系统默认证书(Default\x20https\x20cert)','apiServerHttps','path','https\x20service\x20is\x20not\x20running'];_0x5ba0=function(){return _0x240259;};return _0x5ba0();}(function(_0x3b99c6,_0x217945){const _0x3191b3=_0x1c4a,_0x5062d7=_0x3b99c6();while(!![]){try{const _0x249f58=parseInt(_0x3191b3(0x149))/0x1*(parseInt(_0x3191b3(0x16d))/0x2)+parseInt(_0x3191b3(0x143))/0x3*(-parseInt(_0x3191b3(0x14b))/0x4)+-parseInt(_0x3191b3(0x170))/0x5+parseInt(_0x3191b3(0x16f))/0x6*(parseInt(_0x3191b3(0x150))/0x7)+parseInt(_0x3191b3(0x156))/0x8*(-parseInt(_0x3191b3(0x163))/0x9)+parseInt(_0x3191b3(0x158))/0xa+parseInt(_0x3191b3(0x13a))/0xb;if(_0x249f58===_0x217945)break;else _0x5062d7['push'](_0x5062d7['shift']());}catch(_0x4b67f3){_0x5062d7['push'](_0x5062d7['shift']());}}}(_0x5ba0,0xc7cc9));const expressApp=require(_0x7b8aff(0x146)),fs=require('fs'),path=require(_0x7b8aff(0x136)),config=require(_0x7b8aff(0x145)),Database=require('better-sqlite3'),dbConfigTable=require(_0x7b8aff(0x16c));let dbNoticeCenterTable=require(_0x7b8aff(0x14d));function _0x1c4a(_0x2b3223,_0x82ad3c){const _0x5ba0c4=_0x5ba0();return _0x1c4a=function(_0x1c4a82,_0x5f3d7a){_0x1c4a82=_0x1c4a82-0x134;let _0x436013=_0x5ba0c4[_0x1c4a82];return _0x436013;},_0x1c4a(_0x2b3223,_0x82ad3c);}const http=require(_0x7b8aff(0x13b)),https=require(_0x7b8aff(0x138));let dbOther=new Database(config[_0x7b8aff(0x165)],{});dbOther[_0x7b8aff(0x157)](_0x7b8aff(0x148));let tls=require('tls');const cryptoUtils=require(_0x7b8aff(0x13c));var expressWs=require('express-ws');const messageUtil=require(_0x7b8aff(0x153));process['title']='NasCabApiWorker';function testCertAndKeyMatch(_0x5daa91,_0x5ceafc){const _0x2ded5c=_0x7b8aff;try{return tls[_0x2ded5c(0x155)]({'cert':_0x5daa91,'key':_0x5ceafc}),!![];}catch(_0x16c664){return![];}}function notifyMainLoadPage(_0x5a1ef9){const _0x5de890=_0x7b8aff;currentPort=_0x5a1ef9,process[_0x5de890(0x147)]({'type':_0x5de890(0x164),'exressPort':_0x5a1ef9});}function getFreePort(_0x11e1db,_0x1f82fa){const _0x543255=_0x7b8aff;_0x11e1db=parseInt(_0x11e1db),isPortFree(_0x11e1db)[_0x543255(0x14c)](_0x4650d2=>{_0x4650d2?_0x1f82fa(_0x11e1db):(_0x11e1db=parseInt(_0x11e1db)+0x1,getFreePort(_0x11e1db,_0x1f82fa));});}function isPortFree(_0x5cfcd2){return new Promise(_0x34d83b=>{const _0xc916be=_0x1c4a,_0x32d13b=http['createServer']()['listen'](_0x5cfcd2,()=>{const _0x511b7f=_0x1c4a;_0x32d13b[_0x511b7f(0x151)](),_0x34d83b(!![]);})['on'](_0xc916be(0x152),()=>{_0x34d83b(![]);});});}function setHttpsError(_0x428056){const _0x3f3d18=_0x7b8aff;console['log']('https\x20service\x20is\x20not\x20running\x20',_0x428056),dbConfigTable['create'](dbOther,{'title':_0x3f3d18(0x135),'value':JSON[_0x3f3d18(0x13e)]({'state':_0x3f3d18(0x152),'port':0x0,'message':_0x428056?JSON[_0x3f3d18(0x13e)](_0x428056):_0x3f3d18(0x152)})}),dbNoticeCenterTable[_0x3f3d18(0x168)](dbOther,{'title':'https\x20service\x20is\x20not\x20running','level':_0x3f3d18(0x152),'content':_0x428056?JSON[_0x3f3d18(0x13e)](_0x428056):_0x3f3d18(0x152)});}function startListen(_0x47ce49){const _0x4bfd19=_0x7b8aff;expressApp[_0x4bfd19(0x13f)](_0x47ce49,()=>{const _0xdf3b93=_0x4bfd19;notifyMainLoadPage(_0x47ce49);try{let _0x544639=0x1bb,_0x27f581=dbConfigTable[_0xdf3b93(0x16e)](dbOther,_0xdf3b93(0x167));_0x27f581&&_0x27f581[_0xdf3b93(0x144)]&&_0x27f581[_0xdf3b93(0x144)]>0x0&&_0x27f581[_0xdf3b93(0x144)]<0xffff&&(_0x544639=_0x27f581[_0xdf3b93(0x144)]),getFreePort(_0x544639,async _0x1b4715=>{const _0x13d134=_0xdf3b93;_0x544639=_0x1b4715;let _0x489926='',_0x4d28c1='',_0x1d64cf=dbConfigTable[_0x13d134(0x16e)](dbOther,'httpsCert');_0x1d64cf&&_0x1d64cf['value']&&(_0x489926=_0x1d64cf[_0x13d134(0x144)],console['log']('(Custom\x20https\x20cert)'));let _0x2c55a4=dbConfigTable[_0x13d134(0x16e)](dbOther,'httpsKey');_0x2c55a4&&_0x2c55a4[_0x13d134(0x144)]&&(_0x4d28c1=_0x2c55a4[_0x13d134(0x144)],console['log'](_0x13d134(0x15c)));if(!_0x489926){let _0x910f39=path['join'](config[_0x13d134(0x16b)],'certs','cert.pem');if(!fs[_0x13d134(0x162)](_0x910f39))return setHttpsError(_0x13d134(0x14f));_0x489926=fs[_0x13d134(0x13d)](_0x910f39)[_0x13d134(0x142)](),console[_0x13d134(0x140)](_0x13d134(0x134));}if(!_0x4d28c1){let _0xb842a=path['join'](config[_0x13d134(0x16b)],_0x13d134(0x166),_0x13d134(0x14a));if(!fs[_0x13d134(0x162)](_0xb842a))return setHttpsError('HTTPS\x20certs\x20not\x20exist');console[_0x13d134(0x140)]('证书信息:系统默认证书(Default\x20https\x20key)'),_0x4d28c1=fs['readFileSync'](_0xb842a)[_0x13d134(0x142)]();}if(!_0x489926['startsWith'](_0x13d134(0x139)))try{_0x489926=await cryptoUtils[_0x13d134(0x161)](_0x13d134(0x14e),_0x489926),_0x4d28c1=await cryptoUtils[_0x13d134(0x161)](_0x13d134(0x14e),_0x4d28c1),console[_0x13d134(0x140)](_0x13d134(0x159));}catch(_0x2a2dc9){console[_0x13d134(0x140)](_0x2a2dc9);}const _0xfab8aa=testCertAndKeyMatch(_0x489926,_0x4d28c1);if(!_0xfab8aa){setHttpsError(_0x13d134(0x15d));return;}const _0xe2bcbe={'cert':_0x489926,'key':_0x4d28c1};let _0x18e61c=https[_0x13d134(0x141)](_0xe2bcbe,expressApp);expressWs(expressApp,_0x18e61c),_0x18e61c[_0x13d134(0x13f)](_0x544639,_0x38da14=>{const _0x4ce126=_0x13d134;process[_0x4ce126(0x147)]({'type':'expressStartedHttps','exressPort':_0x544639}),dbConfigTable[_0x4ce126(0x168)](dbOther,{'title':_0x4ce126(0x135),'value':JSON[_0x4ce126(0x13e)]({'state':_0x4ce126(0x169),'port':_0x544639,'message':_0x4ce126(0x16a)})});}),_0x18e61c['on'](_0x13d134(0x152),_0x51183d=>{const _0x4f84f3=_0x13d134;console[_0x4f84f3(0x140)](_0x51183d),dbConfigTable[_0x4f84f3(0x168)](dbOther,{'title':_0x4f84f3(0x135),'value':JSON[_0x4f84f3(0x13e)]({'state':_0x4f84f3(0x152),'port':_0x544639,'message':_0x4f84f3(0x137)})});});});}catch(_0x1f76f9){console[_0xdf3b93(0x140)](_0x1f76f9),setHttpsError(_0x1f76f9);}});}process['on']('uncaughtException',(_0x2b41bc,_0x4445b3)=>{const _0x5c3bca=_0x7b8aff;console[_0x5c3bca(0x140)](_0x5c3bca(0x154),_0x2b41bc),messageUtil['saveMsg'](dbOther,'Error\x20occurred\x20in\x20api\x20process','error',_0x2b41bc[_0x5c3bca(0x15e)]||_0x2b41bc[_0x5c3bca(0x160)]);}),process['on']('warning',_0x3c62ee=>console[_0x7b8aff(0x15b)](_0x3c62ee[_0x7b8aff(0x15e)])),startListen(process[_0x7b8aff(0x15a)][_0x7b8aff(0x15f)]);