const _0x5befc6=_0x5516;(function(_0x2783ed,_0x389abc){const _0x14b305=_0x5516,_0x4627a2=_0x2783ed();while(!![]){try{const _0x219623=parseInt(_0x14b305(0x190))/0x1+parseInt(_0x14b305(0x1ad))/0x2*(-parseInt(_0x14b305(0x1b1))/0x3)+-parseInt(_0x14b305(0x1a0))/0x4+-parseInt(_0x14b305(0x197))/0x5+parseInt(_0x14b305(0x1a3))/0x6*(-parseInt(_0x14b305(0x1ba))/0x7)+-parseInt(_0x14b305(0x1a8))/0x8*(-parseInt(_0x14b305(0x1a6))/0x9)+parseInt(_0x14b305(0x196))/0xa;if(_0x219623===_0x389abc)break;else _0x4627a2['push'](_0x4627a2['shift']());}catch(_0xe7bcd5){_0x4627a2['push'](_0x4627a2['shift']());}}}(_0x9788,0x338de));const expressApp=require(_0x5befc6(0x191)),fs=require('fs'),path=require('path'),config=require(_0x5befc6(0x199)),Database=require(_0x5befc6(0x18d)),dbConfigTable=require('../db/dbConfigTable');let dbNoticeCenterTable=require('../db/dbNoticeCenterTable');const http=require('http'),https=require(_0x5befc6(0x1b4));let dbOther=new Database(config[_0x5befc6(0x1c4)],{});dbOther['pragma'](_0x5befc6(0x1b2));let tls=require(_0x5befc6(0x198));const cryptoUtils=require(_0x5befc6(0x18c));var expressWs=require('express-ws');function _0x5516(_0x9544a6,_0x3250a0){const _0x9788fd=_0x9788();return _0x5516=function(_0x551616,_0x1b7dd7){_0x551616=_0x551616-0x189;let _0x10f2d5=_0x9788fd[_0x551616];return _0x10f2d5;},_0x5516(_0x9544a6,_0x3250a0);}const messageUtil=require('../utils/messageUtil');process[_0x5befc6(0x193)]=_0x5befc6(0x1b6);function _0x9788(){const _0x39d877=['tls','../myConfig/config','send','(Encrypted\x20https\x20cert)','cert.pem','stringify','join','nasZs987bac','438068xhWzvK','saveMsg','expressStarted','114yjNnIa','usePort','apiServerHttps','9jjrYqq','expressStartedHttps','1173936GFBYwL','Error\x20occurred\x20in\x20api\x20process','certs','message','createServer','14ZqRRWQ','https\x20service\x20is\x20not\x20running','apiPortHttps','https\x20service\x20is\x20not\x20running\x20','45033LuiqAm','journal_mode\x20=\x20WAL','listen','https','httpsKey','NasCabApiWorker','https\x20service\x20is\x20running','existsSync','(Custom\x20https\x20cert)','103649sYJqmo','stack','error','httpsCert','toString','key.pem','readFileSync','value','findByTitle','warning','dbOther','then','证书信息:系统默认证书(Default\x20https\x20key)','appRootPath','../express-server/utils/cryptoUtils','better-sqlite3','uncaughtException','create','282925DXhZrc','../express-server/app','close','title','log','env','6566890kSBlqZ','1896315aopEqd'];_0x9788=function(){return _0x39d877;};return _0x9788();}function testCertAndKeyMatch(_0x2ce8e6,_0x4eda3a){try{return tls['createSecureContext']({'cert':_0x2ce8e6,'key':_0x4eda3a}),!![];}catch(_0x2368dc){return![];}}function notifyMainLoadPage(_0x265f79){const _0x4ff6b1=_0x5befc6;currentPort=_0x265f79,process[_0x4ff6b1(0x19a)]({'type':_0x4ff6b1(0x1a2),'exressPort':_0x265f79});}function getFreePort(_0x174e6f,_0x4b39a1){const _0x2e710f=_0x5befc6;_0x174e6f=parseInt(_0x174e6f),isPortFree(_0x174e6f)[_0x2e710f(0x189)](_0x4284d9=>{_0x4284d9?_0x4b39a1(_0x174e6f):(_0x174e6f=parseInt(_0x174e6f)+0x1,getFreePort(_0x174e6f,_0x4b39a1));});}function isPortFree(_0x5b423e){return new Promise(_0x40220c=>{const _0x4ca62f=_0x5516,_0x589fe6=http[_0x4ca62f(0x1ac)]()['listen'](_0x5b423e,()=>{const _0x33030a=_0x4ca62f;_0x589fe6[_0x33030a(0x192)](),_0x40220c(!![]);})['on'](_0x4ca62f(0x1bc),()=>{_0x40220c(![]);});});}function setHttpsError(_0x4792d3){const _0x456468=_0x5befc6;console[_0x456468(0x194)](_0x456468(0x1b0),_0x4792d3),dbConfigTable[_0x456468(0x18f)](dbOther,{'title':_0x456468(0x1a5),'value':JSON[_0x456468(0x19d)]({'state':'error','port':0x0,'message':_0x4792d3?JSON['stringify'](_0x4792d3):'error'})}),dbNoticeCenterTable['create'](dbOther,{'title':_0x456468(0x1ae),'level':'error','content':_0x4792d3?JSON[_0x456468(0x19d)](_0x4792d3):'error'});}function startListen(_0x19f188){const _0x1a3db9=_0x5befc6;expressApp[_0x1a3db9(0x1b3)](_0x19f188,()=>{const _0x4568af=_0x1a3db9;notifyMainLoadPage(_0x19f188);try{let _0x4a70e4=0x1bb,_0x271eb7=dbConfigTable[_0x4568af(0x1c2)](dbOther,_0x4568af(0x1af));_0x271eb7&&_0x271eb7[_0x4568af(0x1c1)]&&_0x271eb7['value']>0x0&&_0x271eb7['value']<0xffff&&(_0x4a70e4=_0x271eb7['value']),getFreePort(_0x4a70e4,async _0x4b0ba9=>{const _0x454089=_0x4568af;_0x4a70e4=_0x4b0ba9;let _0x1f2ed0='',_0x370603='',_0x44f56c=dbConfigTable[_0x454089(0x1c2)](dbOther,_0x454089(0x1bd));_0x44f56c&&_0x44f56c['value']&&(_0x1f2ed0=_0x44f56c[_0x454089(0x1c1)],console['log'](_0x454089(0x1b9)));let _0x34e961=dbConfigTable['findByTitle'](dbOther,_0x454089(0x1b5));_0x34e961&&_0x34e961['value']&&(_0x370603=_0x34e961['value'],console[_0x454089(0x194)]('(Custom\x20https\x20key)'));if(!_0x1f2ed0){let _0x1c96c2=path['join'](config['appRootPath'],_0x454089(0x1aa),_0x454089(0x19c));if(!fs[_0x454089(0x1b8)](_0x1c96c2))return setHttpsError('HTTPS\x20certs\x20not\x20exist');_0x1f2ed0=fs[_0x454089(0x1c0)](_0x1c96c2)['toString'](),console[_0x454089(0x194)]('证书信息:系统默认证书(Default\x20https\x20cert)');}if(!_0x370603){let _0x3a3602=path[_0x454089(0x19e)](config[_0x454089(0x18b)],_0x454089(0x1aa),_0x454089(0x1bf));if(!fs[_0x454089(0x1b8)](_0x3a3602))return setHttpsError('HTTPS\x20certs\x20not\x20exist');console['log'](_0x454089(0x18a)),_0x370603=fs[_0x454089(0x1c0)](_0x3a3602)[_0x454089(0x1be)]();}if(!_0x1f2ed0['startsWith']('-----'))try{_0x1f2ed0=await cryptoUtils['decryptString']('nasZs987bac',_0x1f2ed0),_0x370603=await cryptoUtils['decryptString'](_0x454089(0x19f),_0x370603),console[_0x454089(0x194)](_0x454089(0x19b));}catch(_0x2104fd){console['log'](_0x2104fd);}const _0x20ca05=testCertAndKeyMatch(_0x1f2ed0,_0x370603);if(!_0x20ca05){setHttpsError('HTTPS\x20certs\x20error');return;}const _0x2005b4={'cert':_0x1f2ed0,'key':_0x370603};let _0x454152=https[_0x454089(0x1ac)](_0x2005b4,expressApp);expressWs(expressApp,_0x454152),_0x454152[_0x454089(0x1b3)](_0x4a70e4,_0x33041c=>{const _0x1521e1=_0x454089;process[_0x1521e1(0x19a)]({'type':_0x1521e1(0x1a7),'exressPort':_0x4a70e4}),dbConfigTable[_0x1521e1(0x18f)](dbOther,{'title':'apiServerHttps','value':JSON[_0x1521e1(0x19d)]({'state':'run','port':_0x4a70e4,'message':_0x1521e1(0x1b7)})});}),_0x454152['on'](_0x454089(0x1bc),_0x228ab7=>{const _0x1c5c0c=_0x454089;console[_0x1c5c0c(0x194)](_0x228ab7),dbConfigTable[_0x1c5c0c(0x18f)](dbOther,{'title':_0x1c5c0c(0x1a5),'value':JSON[_0x1c5c0c(0x19d)]({'state':_0x1c5c0c(0x1bc),'port':_0x4a70e4,'message':_0x1c5c0c(0x1ae)})});});});}catch(_0x5bba1e){console[_0x4568af(0x194)](_0x5bba1e),setHttpsError(_0x5bba1e);}});}process['on'](_0x5befc6(0x18e),(_0x264cf5,_0x2688ee)=>{const _0x42e9c8=_0x5befc6;console[_0x42e9c8(0x194)]('Error\x20occurred\x20in\x20api\x20process\x20',_0x264cf5),messageUtil[_0x42e9c8(0x1a1)](dbOther,_0x42e9c8(0x1a9),_0x42e9c8(0x1bc),_0x264cf5[_0x42e9c8(0x1bb)]||_0x264cf5[_0x42e9c8(0x1ab)]);}),process['on'](_0x5befc6(0x1c3),_0x388439=>console['warn'](_0x388439[_0x5befc6(0x1bb)])),startListen(process[_0x5befc6(0x195)][_0x5befc6(0x1a4)]);