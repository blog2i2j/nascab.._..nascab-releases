const _0x8bb4f8=_0x413b;(function(_0x49b82a,_0x598d72){const _0x252f3e=_0x413b,_0x551eb0=_0x49b82a();while(!![]){try{const _0x55b4b2=-parseInt(_0x252f3e(0x6e))/0x1*(parseInt(_0x252f3e(0x88))/0x2)+-parseInt(_0x252f3e(0x84))/0x3*(parseInt(_0x252f3e(0x70))/0x4)+-parseInt(_0x252f3e(0x7b))/0x5*(parseInt(_0x252f3e(0xa5))/0x6)+-parseInt(_0x252f3e(0x8c))/0x7*(-parseInt(_0x252f3e(0xac))/0x8)+parseInt(_0x252f3e(0x95))/0x9*(-parseInt(_0x252f3e(0x91))/0xa)+-parseInt(_0x252f3e(0x87))/0xb+parseInt(_0x252f3e(0xa6))/0xc;if(_0x55b4b2===_0x598d72)break;else _0x551eb0['push'](_0x551eb0['shift']());}catch(_0x1aab5f){_0x551eb0['push'](_0x551eb0['shift']());}}}(_0x71a4,0xc2b00));const expressApp=require(_0x8bb4f8(0x6f)),fs=require('fs'),path=require('path'),config=require('../myConfig/config'),Database=require(_0x8bb4f8(0x73)),dbConfigTable=require('../db/dbConfigTable');function _0x413b(_0x70ff7,_0x37a80e){const _0x71a491=_0x71a4();return _0x413b=function(_0x413b9b,_0x520c9f){_0x413b9b=_0x413b9b-0x6d;let _0x4eae58=_0x71a491[_0x413b9b];return _0x4eae58;},_0x413b(_0x70ff7,_0x37a80e);}let dbNoticeCenterTable=require(_0x8bb4f8(0xb0));const http=require('http'),https=require(_0x8bb4f8(0x7d));let dbOther=new Database(config[_0x8bb4f8(0x79)],{});dbOther[_0x8bb4f8(0xa1)](_0x8bb4f8(0x7c));let tls=require(_0x8bb4f8(0xa7));const cryptoUtils=require(_0x8bb4f8(0x92));var expressWs=require(_0x8bb4f8(0x85));const messageUtil=require(_0x8bb4f8(0xa9));process[_0x8bb4f8(0x78)]='NasCabApiWorker';function _0x71a4(){const _0xa89ef0=['160OjMOCK','stack','(Custom\x20https\x20key)','create','../db/dbNoticeCenterTable','apiServerHttps','3BiovYg','../express-server/app','1468YdilKM','证书信息:系统默认证书(Default\x20https\x20key)','createServer','better-sqlite3','value','saveMsg','readFileSync','expressStartedHttps','title','dbOther','then','1380igFJMZ','journal_mode\x20=\x20WAL','https','findByTitle','-----','key.pem','HTTPS\x20certs\x20not\x20exist','expressStarted','appRootPath','678vgedJO','express-ws','decryptString','16508547CNkkak','878926gqLsNE','Error\x20occurred\x20in\x20api\x20process\x20','log','HTTPS\x20certs\x20error','487732CkVASO','uncaughtException','httpsKey','run','createSecureContext','36170ZVCdZF','../express-server/utils/cryptoUtils','https\x20service\x20is\x20running','https\x20service\x20is\x20not\x20running','261HOOWaR','env','Error\x20occurred\x20in\x20api\x20process','https\x20service\x20is\x20not\x20running\x20','certs','error','join','stringify','listen','nasZs987bac','usePort','startsWith','pragma','send','toString','message','1860EmOiSN','29957772IzJoNx','tls','证书信息:系统默认证书(Default\x20https\x20cert)','../utils/messageUtil','warn','(Encrypted\x20https\x20cert)'];_0x71a4=function(){return _0xa89ef0;};return _0x71a4();}function testCertAndKeyMatch(_0x488ba9,_0x5088c2){const _0x49a7fe=_0x8bb4f8;try{return tls[_0x49a7fe(0x90)]({'cert':_0x488ba9,'key':_0x5088c2}),!![];}catch(_0x5c7ca0){return![];}}function notifyMainLoadPage(_0x12a90f){const _0x1a8287=_0x8bb4f8;currentPort=_0x12a90f,process[_0x1a8287(0xa2)]({'type':_0x1a8287(0x82),'exressPort':_0x12a90f});}function getFreePort(_0x3d0bcd,_0x474d35){const _0x461fdc=_0x8bb4f8;_0x3d0bcd=parseInt(_0x3d0bcd),isPortFree(_0x3d0bcd)[_0x461fdc(0x7a)](_0xea054a=>{_0xea054a?_0x474d35(_0x3d0bcd):(_0x3d0bcd=parseInt(_0x3d0bcd)+0x1,getFreePort(_0x3d0bcd,_0x474d35));});}function isPortFree(_0x5a28e9){return new Promise(_0x9ba407=>{const _0x49d5ba=_0x413b,_0x710ece=http['createServer']()[_0x49d5ba(0x9d)](_0x5a28e9,()=>{_0x710ece['close'](),_0x9ba407(!![]);})['on'](_0x49d5ba(0x9a),()=>{_0x9ba407(![]);});});}function setHttpsError(_0x3aa701){const _0x377d4f=_0x8bb4f8;console[_0x377d4f(0x8a)](_0x377d4f(0x98),_0x3aa701),dbConfigTable['create'](dbOther,{'title':'apiServerHttps','value':JSON[_0x377d4f(0x9c)]({'state':_0x377d4f(0x9a),'port':0x0,'message':_0x3aa701?JSON[_0x377d4f(0x9c)](_0x3aa701):_0x377d4f(0x9a)})}),dbNoticeCenterTable[_0x377d4f(0xaf)](dbOther,{'title':'https\x20service\x20is\x20not\x20running','level':_0x377d4f(0x9a),'content':_0x3aa701?JSON[_0x377d4f(0x9c)](_0x3aa701):_0x377d4f(0x9a)});}function startListen(_0x372a12){const _0x2e7910=_0x8bb4f8;expressApp[_0x2e7910(0x9d)](_0x372a12,()=>{const _0x17561d=_0x2e7910;notifyMainLoadPage(_0x372a12);try{let _0x5dd860=0x1bb,_0x49b561=dbConfigTable[_0x17561d(0x7e)](dbOther,'apiPortHttps');_0x49b561&&_0x49b561[_0x17561d(0x74)]&&_0x49b561[_0x17561d(0x74)]>0x0&&_0x49b561[_0x17561d(0x74)]<0xffff&&(_0x5dd860=_0x49b561[_0x17561d(0x74)]),getFreePort(_0x5dd860,async _0x3825aa=>{const _0x470f08=_0x17561d;_0x5dd860=_0x3825aa;let _0x26390c='',_0x322118='',_0x3ae255=dbConfigTable[_0x470f08(0x7e)](dbOther,'httpsCert');_0x3ae255&&_0x3ae255['value']&&(_0x26390c=_0x3ae255[_0x470f08(0x74)],console[_0x470f08(0x8a)]('(Custom\x20https\x20cert)'));let _0x4e045a=dbConfigTable['findByTitle'](dbOther,_0x470f08(0x8e));_0x4e045a&&_0x4e045a[_0x470f08(0x74)]&&(_0x322118=_0x4e045a[_0x470f08(0x74)],console[_0x470f08(0x8a)](_0x470f08(0xae)));if(!_0x26390c){let _0x244215=path[_0x470f08(0x9b)](config['appRootPath'],_0x470f08(0x99),'cert.pem');if(!fs['existsSync'](_0x244215))return setHttpsError(_0x470f08(0x81));_0x26390c=fs['readFileSync'](_0x244215)[_0x470f08(0xa3)](),console[_0x470f08(0x8a)](_0x470f08(0xa8));}if(!_0x322118){let _0x57215a=path[_0x470f08(0x9b)](config[_0x470f08(0x83)],'certs',_0x470f08(0x80));if(!fs['existsSync'](_0x57215a))return setHttpsError(_0x470f08(0x81));console[_0x470f08(0x8a)](_0x470f08(0x71)),_0x322118=fs[_0x470f08(0x76)](_0x57215a)[_0x470f08(0xa3)]();}if(!_0x26390c[_0x470f08(0xa0)](_0x470f08(0x7f)))try{_0x26390c=await cryptoUtils[_0x470f08(0x86)]('nasZs987bac',_0x26390c),_0x322118=await cryptoUtils['decryptString'](_0x470f08(0x9e),_0x322118),console['log'](_0x470f08(0xab));}catch(_0x3cc681){console[_0x470f08(0x8a)](_0x3cc681);}const _0x23433e=testCertAndKeyMatch(_0x26390c,_0x322118);if(!_0x23433e){setHttpsError(_0x470f08(0x8b));return;}const _0x5d3c5e={'cert':_0x26390c,'key':_0x322118};let _0x56332c=https[_0x470f08(0x72)](_0x5d3c5e,expressApp);expressWs(expressApp,_0x56332c),_0x56332c[_0x470f08(0x9d)](_0x5dd860,_0x2d9c29=>{const _0x5457f7=_0x470f08;process[_0x5457f7(0xa2)]({'type':_0x5457f7(0x77),'exressPort':_0x5dd860}),dbConfigTable[_0x5457f7(0xaf)](dbOther,{'title':'apiServerHttps','value':JSON[_0x5457f7(0x9c)]({'state':_0x5457f7(0x8f),'port':_0x5dd860,'message':_0x5457f7(0x93)})});}),_0x56332c['on'](_0x470f08(0x9a),_0x5799bd=>{const _0xab9cea=_0x470f08;console[_0xab9cea(0x8a)](_0x5799bd),dbConfigTable[_0xab9cea(0xaf)](dbOther,{'title':_0xab9cea(0x6d),'value':JSON[_0xab9cea(0x9c)]({'state':_0xab9cea(0x9a),'port':_0x5dd860,'message':_0xab9cea(0x94)})});});});}catch(_0x34ba82){console[_0x17561d(0x8a)](_0x34ba82),setHttpsError(_0x34ba82);}});}process['on'](_0x8bb4f8(0x8d),(_0x241678,_0x531406)=>{const _0x523b5f=_0x8bb4f8;console['log'](_0x523b5f(0x89),_0x241678),messageUtil[_0x523b5f(0x75)](dbOther,_0x523b5f(0x97),_0x523b5f(0x9a),_0x241678[_0x523b5f(0xad)]||_0x241678[_0x523b5f(0xa4)]);}),process['on']('warning',_0x4f6065=>console[_0x8bb4f8(0xaa)](_0x4f6065[_0x8bb4f8(0xad)])),startListen(process[_0x8bb4f8(0x96)][_0x8bb4f8(0x9f)]);