const _0x4302c1=_0x1e82;(function(_0x11d3dc,_0x2d0f61){const _0x518706=_0x1e82,_0x45d098=_0x11d3dc();while(!![]){try{const _0x162dca=-parseInt(_0x518706(0x151))/0x1+-parseInt(_0x518706(0x162))/0x2+-parseInt(_0x518706(0x14c))/0x3+-parseInt(_0x518706(0x150))/0x4+parseInt(_0x518706(0x14f))/0x5+-parseInt(_0x518706(0x15d))/0x6*(parseInt(_0x518706(0x165))/0x7)+parseInt(_0x518706(0x175))/0x8;if(_0x162dca===_0x2d0f61)break;else _0x45d098['push'](_0x45d098['shift']());}catch(_0x3d9b92){_0x45d098['push'](_0x45d098['shift']());}}}(_0x3145,0x3cc02));const config=require(_0x4302c1(0x154));let fs=require('fs'),path=require(_0x4302c1(0x161)),sharpUtil=require(_0x4302c1(0x158));const dbFileIndexTable=require('../db/dbFileIndexTable'),Database=require(_0x4302c1(0x16b));let dbOther=new Database(config[_0x4302c1(0x15b)],{'timeout':0xea60});dbOther[_0x4302c1(0x15e)]('journal_mode\x20=\x20WAL');let dbFileIndex=new Database(config[_0x4302c1(0x15a)],{'timeout':0xea60});dbFileIndex[_0x4302c1(0x15e)](_0x4302c1(0x16f));const messageUtil=require(_0x4302c1(0x16d));process['title']='NasCabThumbnailWorker';function dealFail(_0x4043bb,_0x15decd,_0x10f5c3,_0x1519cc,_0x6ef62c){const _0x3c6cd6=_0x4302c1;dbFileIndexTable['updateById'](_0x15decd,_0x1519cc['id'],_0x3c6cd6(0x156),'0',_0x6ef62c),_0x4043bb();}function genTiny(_0x136fe2,_0x358b30,_0x588058,_0x413e13,_0x2f7b34,_0xa8aa31){const _0x2a70aa=_0x4302c1;let _0x5525d5=_0x2a70aa(0x14d);_0x413e13[_0x2a70aa(0x15f)]==0x2&&(_0x5525d5=_0x2a70aa(0x157)),sharpUtil[_0x2a70aa(0x171)](_0x588058,path[_0x2a70aa(0x155)](_0x2f7b34),path['basename'](_0x2f7b34),_0x5525d5,_0x413e13,_0x2c89d2=>{const _0x272fde=_0x2a70aa;dbFileIndexTable[_0x272fde(0x173)](_0x358b30,_0x413e13['id'],'tiny_path',_0x2c89d2,_0xa8aa31),_0x136fe2();},_0x1885c7=>{dealFail(_0x136fe2,_0x358b30,_0x588058,_0x413e13,_0xa8aa31);});}function genStart(_0xe7e3c4){return new Promise((_0x2f846b,_0x96ac02)=>{const _0x1d3681=_0x1e82;let _0x59ae07=dbFileIndexTable['getByWhere'](dbFileIndex,'\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','*',_0xe7e3c4);!_0x59ae07&&(_0x59ae07=dbFileIndexTable[_0x1d3681(0x14e)](dbFileIndex,'\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','*',_0xe7e3c4));if(_0x59ae07){try{bgTaskId&&dbOther['prepare'](_0x1d3681(0x152)+bgTaskId)['run']();}catch(_0x20a693){}let _0x261a87=path[_0x1d3681(0x153)](_0x59ae07[_0x1d3681(0x161)],_0x59ae07[_0x1d3681(0x167)]),_0x562d6f=config[_0x1d3681(0x168)](_0x59ae07),_0x1c1c89=path[_0x1d3681(0x153)](config[_0x1d3681(0x16c)],_0x562d6f);fs[_0x1d3681(0x164)](_0x1c1c89,(_0x2b412f,_0x2445c0)=>{const _0xfaa98b=_0x1d3681;if(_0x2b412f)return genTiny(_0x2f846b,dbFileIndex,_0x261a87,_0x59ae07,_0x1c1c89,_0xe7e3c4);_0x2445c0[_0xfaa98b(0x14b)]()&&_0x2445c0[_0xfaa98b(0x159)]>0x7d0?(dbFileIndexTable[_0xfaa98b(0x173)](dbFileIndex,_0x59ae07['id'],_0xfaa98b(0x156),_0x1c1c89,_0xe7e3c4),_0x2f846b()):genTiny(_0x2f846b,dbFileIndex,_0x261a87,_0x59ae07,_0x1c1c89,_0xe7e3c4);});}else _0x2f846b(_0x1d3681(0x149));});}function _0x1e82(_0x41728c,_0x64559f){const _0x314546=_0x3145();return _0x1e82=function(_0x1e826a,_0x563995){_0x1e826a=_0x1e826a-0x149;let _0xc0d1f1=_0x314546[_0x1e826a];return _0xc0d1f1;},_0x1e82(_0x41728c,_0x64559f);}let bgTaskId;try{let info=dbOther[_0x4302c1(0x14a)](_0x4302c1(0x163))[_0x4302c1(0x166)](_0x4302c1(0x170));bgTaskId=info[_0x4302c1(0x16a)];}catch(_0x1d9c09){}let genCount=0x0;function _0x3145(){const _0x4658fa=['type','close','path','237930NfMIvO','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','stat','7SWuDKT','run','filename','getFileHashName','NEW_TINY_IMAGE','lastInsertRowid','better-sqlite3','cachePath','../utils/messageUtil','Error\x20occurred\x20in\x20thumbnail\x20process\x20','journal_mode\x20=\x20WAL','GEN_TINY_IMAGE','genTinyFile','send','updateById','INDEX_TABLE_NAME_PHOTO','9463384hwYcHB','noData','prepare','isFile','313311esguHg','image','getByWhere','523095mUMxhU','1135784qxYpMh','230793EvbVge','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','join','../myConfig/config','dirname','tiny_path','video','../express-server/utils/sharpUtils','size','dbFileIndex','dbOther','log','1803402rtnIWT','pragma'];_0x3145=function(){return _0x4658fa;};return _0x3145();}async function runGen(){const _0x120fea=_0x4302c1;try{let _0x349a67=await genStart(dbFileIndexTable[_0x120fea(0x174)]);_0x349a67!=_0x120fea(0x149)&&(genCount+=0x1);let _0x36c2ab=await genStart(dbFileIndexTable['INDEX_TABLE_NAME_MOVIE']);if(_0x349a67==_0x120fea(0x149)&&_0x36c2ab==_0x120fea(0x149)){try{bgTaskId&&dbOther[_0x120fea(0x14a)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27')[_0x120fea(0x166)]();}catch(_0x17898f){}genCount>0x0&&process[_0x120fea(0x172)]({'type':_0x120fea(0x169)}),process[_0x120fea(0x172)]({'type':_0x120fea(0x160)}),process['exit']();}else return runGen();}catch(_0x38ea47){return console[_0x120fea(0x15c)](_0x38ea47),runGen();}}runGen();function exitProcess(){process['send']({'type':'close'}),process['exit']();}process['on']('uncaughtException',(_0x3e78bf,_0x52ba74)=>{const _0x2ba9a3=_0x4302c1;console[_0x2ba9a3(0x15c)](_0x2ba9a3(0x16e),_0x3e78bf),exitProcess();});