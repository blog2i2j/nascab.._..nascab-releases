const _0x3e5dfb=_0x3dad;(function(_0x454684,_0x28f9a8){const _0x15344e=_0x3dad,_0x179db6=_0x454684();while(!![]){try{const _0x30fece=-parseInt(_0x15344e(0x188))/0x1*(parseInt(_0x15344e(0x185))/0x2)+parseInt(_0x15344e(0x19b))/0x3+parseInt(_0x15344e(0x17a))/0x4+parseInt(_0x15344e(0x197))/0x5+parseInt(_0x15344e(0x198))/0x6+parseInt(_0x15344e(0x189))/0x7+-parseInt(_0x15344e(0x184))/0x8;if(_0x30fece===_0x28f9a8)break;else _0x179db6['push'](_0x179db6['shift']());}catch(_0x1d5872){_0x179db6['push'](_0x179db6['shift']());}}}(_0x1a60,0xc3818));const config=require(_0x3e5dfb(0x196));function _0x1a60(){const _0x50a968=['size','\x20tiny_path\x20is\x20null\x20and\x20type=2\x20LIMIT\x201','exit','pragma','5581088CPjzfa','log','../db/dbFileIndexTable','path','dbOther','INDEX_TABLE_NAME_PHOTO','image','../utils/messageUtil','NasCabThumbnailWorker','type','26313664qDyHTX','6394fdGmtF','dbFileIndex','dirname','283mQKBmY','9098075uCeQxM','GEN_TINY_IMAGE','getByWhere','join','genTinyFile','send','prepare','isFile','noData','filename','run','lastInsertRowid','updateById','../myConfig/config','3300105FGOcZf','798594wSsAji','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','journal_mode\x20=\x20WAL','4519902grulUq','getFileHashName','basename','Error\x20occurred\x20in\x20thumbnail\x20process\x20','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20task_type=\x27GEN_TINY_IMAGE\x27','NEW_TINY_IMAGE'];_0x1a60=function(){return _0x50a968;};return _0x1a60();}let fs=require('fs'),path=require(_0x3e5dfb(0x17d)),sharpUtil=require('../express-server/utils/sharpUtils');const dbFileIndexTable=require(_0x3e5dfb(0x17c)),Database=require('better-sqlite3');let dbOther=new Database(config[_0x3e5dfb(0x17e)],{'timeout':0xea60});dbOther[_0x3e5dfb(0x179)]('journal_mode\x20=\x20WAL');let dbFileIndex=new Database(config[_0x3e5dfb(0x186)],{'timeout':0xea60});dbFileIndex[_0x3e5dfb(0x179)](_0x3e5dfb(0x19a));const messageUtil=require(_0x3e5dfb(0x181));process['title']=_0x3e5dfb(0x182);function dealFail(_0x48f349,_0x265b08,_0x8637c1,_0x320f72,_0x4b7090){dbFileIndexTable['updateById'](_0x265b08,_0x320f72['id'],'tiny_path','0',_0x4b7090),_0x48f349();}function genTiny(_0x303a80,_0x317ad3,_0x35859e,_0x8eaa88,_0xb59cb2,_0xc3d29b){const _0x5e6bb1=_0x3e5dfb;let _0x243527=_0x5e6bb1(0x180);_0x8eaa88[_0x5e6bb1(0x183)]==0x2&&(_0x243527='video'),sharpUtil[_0x5e6bb1(0x18d)](_0x35859e,path[_0x5e6bb1(0x187)](_0xb59cb2),path[_0x5e6bb1(0x19d)](_0xb59cb2),_0x243527,_0x8eaa88,_0x84cf6e=>{const _0x356d0b=_0x5e6bb1;dbFileIndexTable[_0x356d0b(0x195)](_0x317ad3,_0x8eaa88['id'],'tiny_path',_0x84cf6e,_0xc3d29b),_0x303a80();},_0x1538ae=>{dealFail(_0x303a80,_0x317ad3,_0x35859e,_0x8eaa88,_0xc3d29b);});}function genStart(_0x50950f){return new Promise((_0x5339c6,_0x2457ad)=>{const _0x283cbb=_0x3dad;let _0x17283c=dbFileIndexTable[_0x283cbb(0x18b)](dbFileIndex,'\x20tiny_path\x20is\x20null\x20and\x20type=1\x20LIMIT\x201','*',_0x50950f);!_0x17283c&&(_0x17283c=dbFileIndexTable[_0x283cbb(0x18b)](dbFileIndex,_0x283cbb(0x1a2),'*',_0x50950f));if(_0x17283c){try{bgTaskId&&dbOther['prepare']('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x283cbb(0x193)]();}catch(_0x4c1055){}let _0x42f75c=path[_0x283cbb(0x18c)](_0x17283c[_0x283cbb(0x17d)],_0x17283c[_0x283cbb(0x192)]),_0xcd72b3=config[_0x283cbb(0x19c)](_0x17283c),_0x555e1c=path['join'](config['cachePath'],_0xcd72b3);fs['stat'](_0x555e1c,(_0x4fdd65,_0x5622c4)=>{const _0x5376d8=_0x283cbb;if(_0x4fdd65)return genTiny(_0x5339c6,dbFileIndex,_0x42f75c,_0x17283c,_0x555e1c,_0x50950f);_0x5622c4[_0x5376d8(0x190)]()&&_0x5622c4[_0x5376d8(0x1a1)]>0x7d0?(dbFileIndexTable[_0x5376d8(0x195)](dbFileIndex,_0x17283c['id'],'tiny_path',_0x555e1c,_0x50950f),_0x5339c6()):genTiny(_0x5339c6,dbFileIndex,_0x42f75c,_0x17283c,_0x555e1c,_0x50950f);});}else _0x5339c6('noData');});}let bgTaskId;try{let info=dbOther[_0x3e5dfb(0x18f)](_0x3e5dfb(0x199))[_0x3e5dfb(0x193)](_0x3e5dfb(0x18a));bgTaskId=info[_0x3e5dfb(0x194)];}catch(_0x2de4a8){}let genCount=0x0;async function runGen(){const _0x39b1d6=_0x3e5dfb;try{let _0x12438d=await genStart(dbFileIndexTable[_0x39b1d6(0x17f)]);_0x12438d!=_0x39b1d6(0x191)&&(genCount+=0x1);let _0x4f0698=await genStart(dbFileIndexTable['INDEX_TABLE_NAME_MOVIE']);if(_0x12438d=='noData'&&_0x4f0698==_0x39b1d6(0x191)){try{bgTaskId&&dbOther[_0x39b1d6(0x18f)](_0x39b1d6(0x19f))[_0x39b1d6(0x193)]();}catch(_0x449e89){}genCount>0x0&&process[_0x39b1d6(0x18e)]({'type':_0x39b1d6(0x1a0)}),process[_0x39b1d6(0x18e)]({'type':'close'}),process['exit']();}else return runGen();}catch(_0x212351){return console['log'](_0x212351),runGen();}}function _0x3dad(_0x3a62a6,_0x5a8334){const _0x1a60c6=_0x1a60();return _0x3dad=function(_0x3dadb9,_0x5a8aae){_0x3dadb9=_0x3dadb9-0x179;let _0x81a3dd=_0x1a60c6[_0x3dadb9];return _0x81a3dd;},_0x3dad(_0x3a62a6,_0x5a8334);}runGen();function exitProcess(){const _0x4c16c5=_0x3e5dfb;process[_0x4c16c5(0x18e)]({'type':'close'}),process[_0x4c16c5(0x1a3)]();}process['on']('uncaughtException',(_0x220d68,_0x233747)=>{const _0x1c7d9e=_0x3e5dfb;console[_0x1c7d9e(0x17b)](_0x1c7d9e(0x19e),_0x220d68),exitProcess();});