const _0x56123d=_0x1de6;function _0x28b4(){const _0x50a57b=['run','journal_mode\x20=\x20WAL','1vchTKR','statSync','1573768NJkvsl','扫描目录已不存在\x20','68964jBukVY','scan_path','../../db/dbFileIndexTable','1747815XqmKtT','now','INDEX_TABLE_NAME_MOVIE','deleteTask','recursionFilesAddIndex','SCAN_TYPE_MOVIE','better-sqlite3','dealTvDrama','./movieIndexUtil','../../db/dbScanTaskTable','exit','send','getOnTask','getTime','NasCabMovieIndexingWorker','3243486dDRoCt','文件夹数量','prepare','recursionDeleteIndex','pragma','NEW_MOVIE_INDEX','isDirectory','6272MyaJEr','20901393Foofdc','要扫描的目录不是文件夹','2163344BFmxEK','影音管理：扫描完成：','then','title','UPDATE\x20source_folder\x20SET\x20last_scan_time=?\x20\x20WHERE\x20path=?\x20and\x20type=\x27movie\x27','setIndexingState','dealFirstLetterAll','4704TUjzaO','./indexUtil','log'];_0x28b4=function(){return _0x50a57b;};return _0x28b4();}(function(_0x4e8521,_0x11d8aa){const _0x36deac=_0x1de6,_0x94f978=_0x4e8521();while(!![]){try{const _0x5b6889=-parseInt(_0x36deac(0x1a8))/0x1*(-parseInt(_0x36deac(0x1aa))/0x2)+parseInt(_0x36deac(0x1ac))/0x3+parseInt(_0x36deac(0x1c8))/0x4+parseInt(_0x36deac(0x1af))/0x5+parseInt(_0x36deac(0x1be))/0x6+parseInt(_0x36deac(0x1c5))/0x7*(parseInt(_0x36deac(0x1a3))/0x8)+-parseInt(_0x36deac(0x1c6))/0x9;if(_0x5b6889===_0x11d8aa)break;else _0x94f978['push'](_0x94f978['shift']());}catch(_0x28181a){_0x94f978['push'](_0x94f978['shift']());}}}(_0x28b4,0x6cb8b));const fs=require('fs'),path=require('path'),config=require('../../myConfig/config'),Database=require(_0x56123d(0x1b5)),dbOther=new Database(config['dbOther'],{});dbOther['pragma']('journal_mode\x20=\x20WAL');function _0x1de6(_0x53718d,_0x39f267){const _0x28b4f6=_0x28b4();return _0x1de6=function(_0x1de687,_0x46ed4d){_0x1de687=_0x1de687-0x1a0;let _0x2bc8ba=_0x28b4f6[_0x1de687];return _0x2bc8ba;},_0x1de6(_0x53718d,_0x39f267);}const dbFileIndex=new Database(config['dbFileIndex'],{'timeout':0xea60});dbFileIndex[_0x56123d(0x1c2)](_0x56123d(0x1a7));const movieUtil=require('../../express-server/utils/movieUtil'),dbScanTaskTable=require(_0x56123d(0x1b8)),dbFileIndexTable=require(_0x56123d(0x1ae)),indexTableName=dbFileIndexTable[_0x56123d(0x1b1)],movieIndexUtil=require(_0x56123d(0x1b7)),indexUtil=require(_0x56123d(0x1a4));process[_0x56123d(0x1cb)]=_0x56123d(0x1bd);async function startIndexingFolder(_0x15a7db){return new Promise(async(_0x299b06,_0x538e01)=>{const _0x7735bb=_0x1de6;try{let _0x229625=new Date()[_0x7735bb(0x1bc)](),_0x24fdde=fs[_0x7735bb(0x1a9)](_0x15a7db);if(!_0x24fdde[_0x7735bb(0x1c4)]())return console[_0x7735bb(0x1a5)](_0x7735bb(0x1c7),_0x15a7db),_0x299b06();console['log']('影音管理:\x20开始扫描',_0x15a7db),await indexUtil[_0x7735bb(0x1c1)](dbFileIndex,indexTableName,_0x15a7db);let {checkFileCount:_0x71c12d,checkPathCount:_0x37c9f4}=await movieIndexUtil[_0x7735bb(0x1b3)](dbOther,dbFileIndex,_0x15a7db);console[_0x7735bb(0x1a5)](_0x7735bb(0x1c9)+_0x15a7db,'耗时:',new Date()[_0x7735bb(0x1bc)]()-_0x229625,'ms',_0x7735bb(0x1bf),_0x37c9f4,'文件数量',_0x71c12d),movieIndexUtil[_0x7735bb(0x1b6)](dbFileIndex),process[_0x7735bb(0x1ba)]({'type':_0x7735bb(0x1c3)}),_0x299b06();}catch(_0x48b50c){console[_0x7735bb(0x1a5)](_0x7735bb(0x1ab),_0x48b50c,_0x15a7db),_0x299b06();}});}async function runScanTask(){const _0x4e7302=_0x56123d;let _0x4bd403=dbScanTaskTable[_0x4e7302(0x1bb)](dbOther,dbScanTaskTable[_0x4e7302(0x1b4)]);_0x4bd403?(dbOther[_0x4e7302(0x1c0)](_0x4e7302(0x1a0))[_0x4e7302(0x1a6)](Date[_0x4e7302(0x1b0)](),_0x4bd403[_0x4e7302(0x1ad)]),startIndexingFolder(_0x4bd403[_0x4e7302(0x1ad)])[_0x4e7302(0x1ca)](()=>{const _0x2ef774=_0x4e7302;dbScanTaskTable[_0x2ef774(0x1b2)](dbOther,_0x4bd403['id']),movieUtil[_0x2ef774(0x1a2)](dbFileIndex),runScanTask();})):(console[_0x4e7302(0x1a5)]('影音管理:未找到扫描任务[Movies\x20scanning\x20task\x20not\x20found]'),indexUtil[_0x4e7302(0x1a1)](dbOther,indexTableName,![]),process[_0x4e7302(0x1b9)]());}indexUtil[_0x56123d(0x1a1)](dbOther,indexTableName,!![]),runScanTask();