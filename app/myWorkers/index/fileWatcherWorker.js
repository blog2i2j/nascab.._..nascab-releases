const _0x4a745a=_0x3c30;(function(_0x414c51,_0x1e7348){const _0x72a6c2=_0x3c30,_0x52d9bc=_0x414c51();while(!![]){try{const _0x124df6=-parseInt(_0x72a6c2(0x154))/0x1+-parseInt(_0x72a6c2(0x17f))/0x2+parseInt(_0x72a6c2(0x191))/0x3+-parseInt(_0x72a6c2(0x155))/0x4+-parseInt(_0x72a6c2(0x186))/0x5*(parseInt(_0x72a6c2(0x18e))/0x6)+-parseInt(_0x72a6c2(0x17b))/0x7*(parseInt(_0x72a6c2(0x175))/0x8)+-parseInt(_0x72a6c2(0x173))/0x9*(-parseInt(_0x72a6c2(0x197))/0xa);if(_0x124df6===_0x1e7348)break;else _0x52d9bc['push'](_0x52d9bc['shift']());}catch(_0x2a51fa){_0x52d9bc['push'](_0x52d9bc['shift']());}}}(_0x3443,0x306e1));let fs=require('fs'),path=require(_0x4a745a(0x157));const config=require(_0x4a745a(0x160)),Database=require('better-sqlite3');let dbOther=new Database(config[_0x4a745a(0x190)],{}),dbFileIndex=new Database(config[_0x4a745a(0x163)],{});dbFileIndex[_0x4a745a(0x158)](_0x4a745a(0x198)),dbOther[_0x4a745a(0x158)](_0x4a745a(0x198));const dbSourceFolderTable=require(_0x4a745a(0x177)),dbFileIndexTable=require(_0x4a745a(0x187));var nsfw=require(_0x4a745a(0x179));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x4a745a(0x15a));const messageUtil=require(_0x4a745a(0x17e));process['title']=_0x4a745a(0x170);const bookIndexUtil=require(_0x4a745a(0x165)),musicIndexUtil=require(_0x4a745a(0x188)),photoIndexUtil=require('./photoIndexUtil'),movieIndexUtil=require('./movieIndexUtil');function _0x3c30(_0x59c5c1,_0x5e6516){const _0x3443a9=_0x3443();return _0x3c30=function(_0x3c30eb,_0x50b1ff){_0x3c30eb=_0x3c30eb-0x151;let _0x1011b7=_0x3443a9[_0x3c30eb];return _0x1011b7;},_0x3c30(_0x59c5c1,_0x5e6516);}let allWatcherList=[],waitDealFileList=[];process['on']('message',_0x3e2093=>{const _0x4b93d6=_0x4a745a;if(_0x3e2093[_0x4b93d6(0x156)]==_0x4b93d6(0x19d))_0x3e2093[_0x4b93d6(0x176)]!=_0x4b93d6(0x182)&&(console[_0x4b93d6(0x18b)](_0x4b93d6(0x178)),setSourceFolderWatcher());else _0x3e2093['type']==_0x4b93d6(0x172)&&closeAllWatcher();});async function dealFileChange(_0x41c619,_0x378436){const _0xae7b85=_0x4a745a;if(!_0x41c619||!_0x378436)return;if(indexUtil[_0xae7b85(0x162)](dbOther,_0x378436))return![];if(indexUtil['isForbiddenPath'](config,_0x378436))return![];if(indexUtil[_0xae7b85(0x183)](path[_0xae7b85(0x184)](_0x378436)))return![];for(let _0x2cf10b=0x0;_0x2cf10b<waitDealFileList[_0xae7b85(0x189)];_0x2cf10b++){if(waitDealFileList[_0x2cf10b][_0xae7b85(0x194)]==_0x378436)return![];}waitDealFileList[_0xae7b85(0x161)]({'watchPath':_0x41c619,'fullPath':_0x378436,'filePath':path[_0xae7b85(0x17c)](_0x378436),'fileName':path['basename'](_0x378436)});}async function startOneWatcher(_0x2081bd){const _0x59685b=_0x4a745a;try{let _0x2d656d=fs[_0x59685b(0x19a)](_0x2081bd);if(!_0x2d656d[_0x59685b(0x15b)]())return null;let _0x51365a=await nsfw(_0x2081bd,function(_0x38fdc4){const _0x332c96=_0x59685b;for(let _0x23d2f9 in _0x38fdc4){let _0x8ae8fe=_0x38fdc4[_0x23d2f9];if(_0x8ae8fe[_0x332c96(0x19b)]=='.DS_Store')continue;if(_0x8ae8fe[_0x332c96(0x18a)]==nsfw['actions'][_0x332c96(0x164)]){let _0x2f4266=path[_0x332c96(0x16f)](_0x8ae8fe[_0x332c96(0x19e)],_0x8ae8fe['oldFile']),_0x7656e3=path[_0x332c96(0x16f)](_0x8ae8fe['newDirectory'],_0x8ae8fe[_0x332c96(0x168)]);dealFileChange(_0x2081bd,_0x2f4266),dealFileChange(_0x2081bd,_0x7656e3);}else{let _0x434639=path[_0x332c96(0x16f)](_0x8ae8fe[_0x332c96(0x19e)],_0x8ae8fe[_0x332c96(0x19b)]);dealFileChange(_0x2081bd,_0x434639);}}},{'errorCallback'(_0x1f58ad){}});return _0x51365a[_0x59685b(0x19c)](),{'watcher':_0x51365a,'watchPathState':_0x2d656d};}catch(_0x129c93){return console[_0x59685b(0x18b)](_0x59685b(0x151),_0x2081bd),null;}}let isSettingWatcher=![];function _0x3443(){const _0x7141b6=['重设文件变动检测','nsfw','photo','47831svOfzu','dirname','Error\x20occurred\x20in\x20photo\x20watcher\x20process','../../utils/messageUtil','707208MfkbjZ','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','电影来源变动:','delete','isForbiddenFilename','basename','dealTvDrama','53405oqoEXZ','../../db/dbFileIndexTable','./musicIndexUtil','length','action','log','getAll','startsWith','210cVQQjt','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','dbOther','837318PfgcAq','NEW_MOVIE_INDEX','filter','fullPath','movie','close','3520210nNKpiS','journal_mode\x20=\x20WAL','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','statSync','file','start','startScanPath','directory','The\x20source\x20folder\x20no\x20exists\x20:\x20','music','message','304473CYlozc','173564KNicoy','type','path','pragma','send','./indexUtil','isDirectory','dealFileChange','error','照片来源变动:','scan_when_change','../../myConfig/config','push','checkPathIsInPrivateSpace','dbFileIndex','RENAMED','./bookIndexUtil','getById','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','newFile','saveMsg','未开启变动自动处理\x20跳过','watcher','then','INDEX_TABLE_NAME_PHOTO','stack','join','FileChangingWatchWorker','stop','closeWatcher','27jxiPJu','sep','72EPyabn','operate','../../db/dbSourceFolderTable'];_0x3443=function(){return _0x7141b6;};return _0x3443();}async function setSourceFolderWatcher(){const _0x2ce68c=_0x4a745a;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x3419e4(){const _0x4f62fa=_0x3c30;let _0x36bd9e=[];for(let _0x4b0506=0x0;_0x4b0506<finalWatchFolderList[_0x4f62fa(0x189)];_0x4b0506++){let _0x3d764a=finalWatchFolderList[_0x4b0506][_0x4f62fa(0x157)];try{let _0x495d6e=await startOneWatcher(_0x3d764a);_0x495d6e?(console[_0x4f62fa(0x18b)](_0x4f62fa(0x199),_0x3d764a),_0x36bd9e[_0x4f62fa(0x161)]({'path':_0x3d764a,'watcher':_0x495d6e[_0x4f62fa(0x16b)]})):(console[_0x4f62fa(0x18b)](_0x4f62fa(0x18f),_0x3d764a),_0x36bd9e[_0x4f62fa(0x161)]({'path':_0x3d764a,'watcher':null,'stop':0x1}));}catch(_0x38f7df){console[_0x4f62fa(0x18b)](_0x38f7df);}}return _0x36bd9e;}let _0xb902e7=[];for(let _0x59777d in finalWatchFolderList){_0xb902e7[_0x2ce68c(0x161)](finalWatchFolderList[_0x59777d]['path']);}closeAllWatcher(),allWatcherList=await _0x3419e4(_0xb902e7,dbFileIndexTable[_0x2ce68c(0x16d)],_0x2ce68c(0x17a)),isSettingWatcher=![];}function ifNeedDealChange(_0x23a707,_0x3fd674){const _0x2118d7=_0x4a745a;for(let _0x12ba99 in _0x23a707){let _0x575743=_0x23a707[_0x12ba99];if(_0x3fd674[_0x2118d7(0x18d)](_0x575743['path']+path[_0x2118d7(0x174)])||_0x3fd674==_0x575743[_0x2118d7(0x157)]){let _0x51399a=dbSourceFolderTable[_0x2118d7(0x166)](dbOther,_0x575743['id']);return _0x23a707[_0x12ba99]=_0x51399a,_0x51399a||_0x51399a['scan_when_change']==0x1?!![]:(console[_0x2118d7(0x18b)](_0x2118d7(0x16a),_0x3fd674),![]);}}return![];}function initSourceFolderList(){const _0xdf29ab=_0x4a745a;let _0x2febc6=dbSourceFolderTable[_0xdf29ab(0x18c)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x31201c of _0x2febc6){if(_0x31201c[_0xdf29ab(0x15f)]!=0x1)continue;if(_0x31201c[_0xdf29ab(0x156)]==_0xdf29ab(0x17a))photoSourceFolderList[_0xdf29ab(0x161)](_0x31201c);else{if(_0x31201c['type']==_0xdf29ab(0x195))movieSourceFolderList[_0xdf29ab(0x161)](_0x31201c);else{if(_0x31201c[_0xdf29ab(0x156)]==_0xdf29ab(0x152))musicSourceFolderList[_0xdf29ab(0x161)](_0x31201c);else _0x31201c[_0xdf29ab(0x156)]=='book'&&bookSourceFolderList[_0xdf29ab(0x161)](_0x31201c);}}let _0x5445ed=!![];for(let _0x59a7ff of finalWatchFolderList){let _0x43854f=path[_0xdf29ab(0x16f)](_0x59a7ff['path']),_0x428d05=path[_0xdf29ab(0x16f)](_0x31201c[_0xdf29ab(0x157)]);if(_0x43854f==_0x428d05)_0x5445ed=![];else{if(_0x428d05[_0xdf29ab(0x18d)](_0x43854f+path[_0xdf29ab(0x174)]))console['log']('变动检测列表中已包含父目录',_0x43854f),_0x5445ed=![];else _0x43854f[_0xdf29ab(0x18d)](_0x428d05+path[_0xdf29ab(0x174)])&&(console[_0xdf29ab(0x18b)](_0xdf29ab(0x180),_0x428d05),finalWatchFolderList=finalWatchFolderList[_0xdf29ab(0x193)](_0x1c93a2=>_0x1c93a2[_0xdf29ab(0x157)]!=_0x43854f));}}_0x5445ed&&finalWatchFolderList[_0xdf29ab(0x161)](_0x31201c);}}async function closeAllWatcher(){const _0xe17498=_0x4a745a;for(let _0x2e2dcb=0x0;_0x2e2dcb<allWatcherList[_0xe17498(0x189)];_0x2e2dcb++){try{allWatcherList[_0x2e2dcb][_0xe17498(0x16b)]&&await allWatcherList[_0x2e2dcb][_0xe17498(0x16b)][_0xe17498(0x171)]();}catch(_0x5d74ae){}}}function dealNewFilePromise(){return new Promise(async(_0xe9ae27,_0x444ecf)=>{const _0x2234f2=_0x3c30;if(waitDealFileList[_0x2234f2(0x189)]>0x0){let _0x351143=waitDealFileList[0x0],_0x2acbf7=![],_0x901409=![];return ifNeedDealChange(photoSourceFolderList,_0x351143['fullPath'])&&(console[_0x2234f2(0x18b)](_0x2234f2(0x15e),_0x351143[_0x2234f2(0x194)]),_0x2acbf7=!![],await photoIndexUtil[_0x2234f2(0x15c)](dbFileIndex,dbOther,_0x351143)),ifNeedDealChange(movieSourceFolderList,_0x351143[_0x2234f2(0x194)])&&(console[_0x2234f2(0x18b)](_0x2234f2(0x181),_0x351143['fullPath']),_0x901409=!![],await movieIndexUtil[_0x2234f2(0x15c)](dbFileIndex,dbOther,_0x351143)),ifNeedDealChange(musicSourceFolderList,_0x351143['fullPath'])&&(console[_0x2234f2(0x18b)]('音乐来源变动:',_0x351143[_0x2234f2(0x194)]),await musicIndexUtil[_0x2234f2(0x15c)](dbFileIndex,dbOther,_0x351143)),ifNeedDealChange(bookSourceFolderList,_0x351143[_0x2234f2(0x194)])&&(console[_0x2234f2(0x18b)]('图书来源变动:',_0x351143[_0x2234f2(0x194)]),await bookIndexUtil[_0x2234f2(0x15c)](dbFileIndex,dbOther,_0x351143)),waitDealFileList['splice'](0x0,0x1),waitDealFileList['length']<0x1&&(_0x2acbf7&&process[_0x2234f2(0x159)]({'type':'NEW_PHOTO_INDEX'}),_0x901409&&(movieIndexUtil[_0x2234f2(0x185)](dbFileIndex),process[_0x2234f2(0x159)]({'type':_0x2234f2(0x192)}))),_0xe9ae27();}else setTimeout(()=>{return _0xe9ae27();},0x1388);});}function dealNewFileRun(){const _0x411a27=_0x4a745a;dealNewFilePromise()[_0x411a27(0x16c)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on']('uncaughtException',(_0x36172a,_0x52fafa)=>{const _0x47583b=_0x4a745a;console[_0x47583b(0x18b)](_0x47583b(0x17d),_0x36172a),messageUtil[_0x47583b(0x169)](dbOther,_0x47583b(0x167),_0x47583b(0x15d),_0x36172a[_0x47583b(0x16e)]||_0x36172a[_0x47583b(0x153)]),closeAllWatcher(),process['send']({'type':_0x47583b(0x196)}),process['exit']();});