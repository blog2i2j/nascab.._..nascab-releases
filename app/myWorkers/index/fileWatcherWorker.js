const _0x17db7b=_0x179e;(function(_0x14ba7a,_0x65a557){const _0x25dc34=_0x179e,_0x5662aa=_0x14ba7a();while(!![]){try{const _0x243686=-parseInt(_0x25dc34(0x10e))/0x1*(-parseInt(_0x25dc34(0xff))/0x2)+-parseInt(_0x25dc34(0x130))/0x3*(parseInt(_0x25dc34(0x147))/0x4)+-parseInt(_0x25dc34(0x142))/0x5*(parseInt(_0x25dc34(0x133))/0x6)+parseInt(_0x25dc34(0x10f))/0x7*(parseInt(_0x25dc34(0xfc))/0x8)+-parseInt(_0x25dc34(0x12a))/0x9*(parseInt(_0x25dc34(0x12c))/0xa)+-parseInt(_0x25dc34(0x13f))/0xb*(-parseInt(_0x25dc34(0x135))/0xc)+parseInt(_0x25dc34(0x140))/0xd;if(_0x243686===_0x65a557)break;else _0x5662aa['push'](_0x5662aa['shift']());}catch(_0x29fcb3){_0x5662aa['push'](_0x5662aa['shift']());}}}(_0x1beb,0x21c30));let fs=require('fs'),path=require(_0x17db7b(0x10a));function _0x1beb(){const _0x1fcbfc=['dbOther','.DS_Store','2469DNlNcg','../../db/dbSourceFolderTable','getById','32976SNpyFj','startScanPath','251436WcNtTh','./photoIndexUtil','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','./musicIndexUtil','title','sep','NEW_PHOTO_INDEX','better-sqlite3','message','stop','33RBALfr','2969915FeAAgq','nsfw','135gjskzH','图书来源变动:','scan_when_change','oldFile','getAll','956rfbhQD','photo','../../db/dbFileIndexTable','../../utils/messageUtil','send','14752ahRLGG','./bookIndexUtil','delete','42668BOKSNr','uncaughtException','start','INDEX_TABLE_NAME_PHOTO','isForbiddenPath','error','file','action','pragma','isForbiddenFilename','NEW_MOVIE_INDEX','path','push','splice','dealFileChange','11BQrUqT','350LlXmFX','./indexUtil','statSync','The\x20source\x20folder\x20no\x20exists\x20:\x20','length','actions','basename','stack','log','dirname','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','重设文件变动检测','watcher','startsWith','close','dbFileIndex','dealTvDrama','type','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','RENAMED','join','book','journal_mode\x20=\x20WAL','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','music','exit','fullPath','1213299vcBROe','closeWatcher','10tSJzUY','directory'];_0x1beb=function(){return _0x1fcbfc;};return _0x1beb();}const config=require('../../myConfig/config'),Database=require(_0x17db7b(0x13c));let dbOther=new Database(config[_0x17db7b(0x12e)],{}),dbFileIndex=new Database(config[_0x17db7b(0x11e)],{});dbFileIndex[_0x17db7b(0x107)]('journal_mode\x20=\x20WAL'),dbOther[_0x17db7b(0x107)](_0x17db7b(0x125));function _0x179e(_0x1e710e,_0x4504f3){const _0x1beb4f=_0x1beb();return _0x179e=function(_0x179eca,_0x56aa63){_0x179eca=_0x179eca-0xfc;let _0x35ef2d=_0x1beb4f[_0x179eca];return _0x35ef2d;},_0x179e(_0x1e710e,_0x4504f3);}const dbSourceFolderTable=require(_0x17db7b(0x131)),dbFileIndexTable=require(_0x17db7b(0x149));var nsfw=require(_0x17db7b(0x141));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x17db7b(0x110));const messageUtil=require(_0x17db7b(0x14a));process[_0x17db7b(0x139)]='FileChangingWatchWorker';const bookIndexUtil=require(_0x17db7b(0xfd)),musicIndexUtil=require(_0x17db7b(0x138)),photoIndexUtil=require(_0x17db7b(0x136)),movieIndexUtil=require('./movieIndexUtil');let allWatcherList=[],waitDealFileList=[];process['on'](_0x17db7b(0x13d),_0x135d14=>{const _0xbdc7a5=_0x17db7b;if(_0x135d14['type']==_0xbdc7a5(0x134))_0x135d14['operate']!=_0xbdc7a5(0xfe)&&(console[_0xbdc7a5(0x117)](_0xbdc7a5(0x11a)),setSourceFolderWatcher());else _0x135d14[_0xbdc7a5(0x120)]==_0xbdc7a5(0x12b)&&closeAllWatcher();});async function dealFileChange(_0xd41d8c,_0x3c7af4){const _0x36b4d1=_0x17db7b;if(!_0xd41d8c||!_0x3c7af4)return;if(indexUtil['checkPathIsInPrivateSpace'](dbOther,_0x3c7af4))return![];if(indexUtil[_0x36b4d1(0x103)](config,_0x3c7af4))return![];if(indexUtil[_0x36b4d1(0x108)](path[_0x36b4d1(0x115)](_0x3c7af4)))return![];for(let _0x48aac6=0x0;_0x48aac6<waitDealFileList[_0x36b4d1(0x113)];_0x48aac6++){if(waitDealFileList[_0x48aac6][_0x36b4d1(0x129)]==_0x3c7af4)return![];}waitDealFileList[_0x36b4d1(0x10b)]({'watchPath':_0xd41d8c,'fullPath':_0x3c7af4,'filePath':path[_0x36b4d1(0x118)](_0x3c7af4),'fileName':path[_0x36b4d1(0x115)](_0x3c7af4)});}async function startOneWatcher(_0x454ba4){const _0x41fa6a=_0x17db7b;try{let _0x17ce60=fs[_0x41fa6a(0x111)](_0x454ba4);if(!_0x17ce60['isDirectory']())return null;let _0x3fa9c5=await nsfw(_0x454ba4,function(_0x3118da){const _0x2ad1a4=_0x41fa6a;for(let _0x4df082 in _0x3118da){let _0x3877c6=_0x3118da[_0x4df082];if(_0x3877c6[_0x2ad1a4(0x105)]==_0x2ad1a4(0x12f))continue;if(_0x3877c6[_0x2ad1a4(0x106)]==nsfw[_0x2ad1a4(0x114)][_0x2ad1a4(0x122)]){let _0x1b0129=path[_0x2ad1a4(0x123)](_0x3877c6[_0x2ad1a4(0x12d)],_0x3877c6[_0x2ad1a4(0x145)]),_0x212432=path[_0x2ad1a4(0x123)](_0x3877c6['newDirectory'],_0x3877c6['newFile']);dealFileChange(_0x454ba4,_0x1b0129),dealFileChange(_0x454ba4,_0x212432);}else{let _0x201733=path[_0x2ad1a4(0x123)](_0x3877c6[_0x2ad1a4(0x12d)],_0x3877c6[_0x2ad1a4(0x105)]);dealFileChange(_0x454ba4,_0x201733);}}},{'errorCallback'(_0x2f942a){}});return _0x3fa9c5[_0x41fa6a(0x101)](),{'watcher':_0x3fa9c5,'watchPathState':_0x17ce60};}catch(_0x132b3a){return console[_0x41fa6a(0x117)](_0x41fa6a(0x112),_0x454ba4),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x8bd68f=_0x17db7b;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x3d9a65(){const _0x4a468a=_0x179e;let _0x483ec9=[];for(let _0x2b386f=0x0;_0x2b386f<finalWatchFolderList[_0x4a468a(0x113)];_0x2b386f++){let _0xec253f=finalWatchFolderList[_0x2b386f][_0x4a468a(0x10a)];try{let _0x4c3b11=await startOneWatcher(_0xec253f);_0x4c3b11?(console[_0x4a468a(0x117)](_0x4a468a(0x119),_0xec253f),_0x483ec9[_0x4a468a(0x10b)]({'path':_0xec253f,'watcher':_0x4c3b11['watcher']})):(console[_0x4a468a(0x117)](_0x4a468a(0x126),_0xec253f),_0x483ec9['push']({'path':_0xec253f,'watcher':null,'stop':0x1}));}catch(_0x53e668){console['log'](_0x53e668);}}return _0x483ec9;}let _0x30349d=[];for(let _0x579832 in finalWatchFolderList){_0x30349d[_0x8bd68f(0x10b)](finalWatchFolderList[_0x579832]['path']);}closeAllWatcher(),allWatcherList=await _0x3d9a65(_0x30349d,dbFileIndexTable[_0x8bd68f(0x102)],_0x8bd68f(0x148)),isSettingWatcher=![];}function ifNeedDealChange(_0xc703ce,_0x154aa9){const _0x25ea4b=_0x17db7b;for(let _0x419962 in _0xc703ce){let _0x49fdc2=_0xc703ce[_0x419962];if(_0x154aa9[_0x25ea4b(0x11c)](_0x49fdc2['path']+path[_0x25ea4b(0x13a)])||_0x154aa9==_0x49fdc2[_0x25ea4b(0x10a)]){let _0x259cf=dbSourceFolderTable[_0x25ea4b(0x132)](dbOther,_0x49fdc2['id']);return _0xc703ce[_0x419962]=_0x259cf,_0x259cf||_0x259cf['scan_when_change']==0x1?!![]:(console[_0x25ea4b(0x117)]('未开启变动自动处理\x20跳过',_0x154aa9),![]);}}return![];}function initSourceFolderList(){const _0x505629=_0x17db7b;let _0x5549b7=dbSourceFolderTable[_0x505629(0x146)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x2529f1 of _0x5549b7){if(_0x2529f1[_0x505629(0x144)]!=0x1)continue;if(_0x2529f1['type']==_0x505629(0x148))photoSourceFolderList[_0x505629(0x10b)](_0x2529f1);else{if(_0x2529f1[_0x505629(0x120)]=='movie')movieSourceFolderList[_0x505629(0x10b)](_0x2529f1);else{if(_0x2529f1[_0x505629(0x120)]==_0x505629(0x127))musicSourceFolderList['push'](_0x2529f1);else _0x2529f1['type']==_0x505629(0x124)&&bookSourceFolderList['push'](_0x2529f1);}}let _0x3d0404=!![];for(let _0x15bea0 of finalWatchFolderList){let _0x55fa35=path[_0x505629(0x123)](_0x15bea0[_0x505629(0x10a)]),_0xc7b8e7=path[_0x505629(0x123)](_0x2529f1[_0x505629(0x10a)]);if(_0x55fa35==_0xc7b8e7)_0x3d0404=![];else{if(_0xc7b8e7[_0x505629(0x11c)](_0x55fa35+path[_0x505629(0x13a)]))console[_0x505629(0x117)]('变动检测列表中已包含父目录',_0x55fa35),_0x3d0404=![];else _0x55fa35[_0x505629(0x11c)](_0xc7b8e7+path['sep'])&&(console[_0x505629(0x117)](_0x505629(0x121),_0xc7b8e7),finalWatchFolderList=finalWatchFolderList['filter'](_0x30ec04=>_0x30ec04[_0x505629(0x10a)]!=_0x55fa35));}}_0x3d0404&&finalWatchFolderList[_0x505629(0x10b)](_0x2529f1);}}async function closeAllWatcher(){const _0x12bfcf=_0x17db7b;for(let _0x4143e6=0x0;_0x4143e6<allWatcherList[_0x12bfcf(0x113)];_0x4143e6++){try{allWatcherList[_0x4143e6][_0x12bfcf(0x11b)]&&await allWatcherList[_0x4143e6][_0x12bfcf(0x11b)][_0x12bfcf(0x13e)]();}catch(_0x5546ae){}}}function dealNewFilePromise(){return new Promise(async(_0x20a22d,_0x36dd5a)=>{const _0x4aa588=_0x179e;if(waitDealFileList[_0x4aa588(0x113)]>0x0){let _0x1e296f=waitDealFileList[0x0],_0xea15d=![],_0x2ae34f=![];return ifNeedDealChange(photoSourceFolderList,_0x1e296f[_0x4aa588(0x129)])&&(console[_0x4aa588(0x117)]('照片来源变动:',_0x1e296f[_0x4aa588(0x129)]),_0xea15d=!![],await photoIndexUtil[_0x4aa588(0x10d)](dbFileIndex,dbOther,_0x1e296f)),ifNeedDealChange(movieSourceFolderList,_0x1e296f[_0x4aa588(0x129)])&&(console['log']('电影来源变动:',_0x1e296f['fullPath']),_0x2ae34f=!![],await movieIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x1e296f)),ifNeedDealChange(musicSourceFolderList,_0x1e296f[_0x4aa588(0x129)])&&(console[_0x4aa588(0x117)]('音乐来源变动:',_0x1e296f[_0x4aa588(0x129)]),await musicIndexUtil[_0x4aa588(0x10d)](dbFileIndex,dbOther,_0x1e296f)),ifNeedDealChange(bookSourceFolderList,_0x1e296f[_0x4aa588(0x129)])&&(console[_0x4aa588(0x117)](_0x4aa588(0x143),_0x1e296f[_0x4aa588(0x129)]),await bookIndexUtil[_0x4aa588(0x10d)](dbFileIndex,dbOther,_0x1e296f)),waitDealFileList[_0x4aa588(0x10c)](0x0,0x1),waitDealFileList[_0x4aa588(0x113)]<0x1&&(_0xea15d&&process[_0x4aa588(0x14b)]({'type':_0x4aa588(0x13b)}),_0x2ae34f&&(movieIndexUtil[_0x4aa588(0x11f)](dbFileIndex),process[_0x4aa588(0x14b)]({'type':_0x4aa588(0x109)}))),_0x20a22d();}else setTimeout(()=>{return _0x20a22d();},0x1388);});}function dealNewFileRun(){dealNewFilePromise()['then'](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x17db7b(0x100),(_0x42d874,_0x3a29ff)=>{const _0x4d323b=_0x17db7b;console['log']('Error\x20occurred\x20in\x20photo\x20watcher\x20process',_0x42d874),messageUtil['saveMsg'](dbOther,_0x4d323b(0x137),_0x4d323b(0x104),_0x42d874[_0x4d323b(0x116)]||_0x42d874['message']),closeAllWatcher(),process[_0x4d323b(0x14b)]({'type':_0x4d323b(0x11d)}),process[_0x4d323b(0x128)]();});