const _0x3b9752=_0x1088;(function(_0x5a1c2c,_0x3110e1){const _0x203498=_0x1088,_0x26a0df=_0x5a1c2c();while(!![]){try{const _0x243941=-parseInt(_0x203498(0x131))/0x1+-parseInt(_0x203498(0x13d))/0x2*(-parseInt(_0x203498(0x161))/0x3)+-parseInt(_0x203498(0x15f))/0x4*(parseInt(_0x203498(0x123))/0x5)+parseInt(_0x203498(0x134))/0x6*(-parseInt(_0x203498(0x12e))/0x7)+parseInt(_0x203498(0x12d))/0x8+parseInt(_0x203498(0x118))/0x9+parseInt(_0x203498(0x13c))/0xa;if(_0x243941===_0x3110e1)break;else _0x26a0df['push'](_0x26a0df['shift']());}catch(_0x9b82ad){_0x26a0df['push'](_0x26a0df['shift']());}}}(_0x574d,0xadd2c));let fs=require('fs'),path=require(_0x3b9752(0x151));const config=require(_0x3b9752(0x14e)),Database=require(_0x3b9752(0x132));let dbOther=new Database(config[_0x3b9752(0x122)],{}),dbFileIndex=new Database(config[_0x3b9752(0x154)],{});dbFileIndex[_0x3b9752(0x14c)]('journal_mode\x20=\x20WAL'),dbOther[_0x3b9752(0x14c)](_0x3b9752(0x143));const dbSourceFolderTable=require(_0x3b9752(0x158)),dbFileIndexTable=require(_0x3b9752(0x15a));var nsfw=require('nsfw');function _0x1088(_0x43fd47,_0xcf5c3b){const _0x574dc0=_0x574d();return _0x1088=function(_0x108803,_0x4f0209){_0x108803=_0x108803-0x116;let _0x305340=_0x574dc0[_0x108803];return _0x305340;},_0x1088(_0x43fd47,_0xcf5c3b);}let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x3b9752(0x130));const messageUtil=require(_0x3b9752(0x128));process[_0x3b9752(0x11d)]=_0x3b9752(0x152);const bookIndexUtil=require('./bookIndexUtil'),musicIndexUtil=require('./musicIndexUtil'),photoIndexUtil=require(_0x3b9752(0x13b)),movieIndexUtil=require('./movieIndexUtil');let allWatcherList=[],waitDealFileList=[];function _0x574d(){const _0x14c4d6=['NEW_PHOTO_INDEX','isForbiddenPath','directory','dbOther','5PNorYg','stack','saveMsg','The\x20source\x20folder\x20no\x20exists\x20:\x20','fullPath','../../utils/messageUtil','closeWatcher','getById','变动检测列表中已包含父目录','dirname','6285112ivGiMQ','4307891lwvwrd','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','./indexUtil','737669ODaXnc','better-sqlite3','close','6AqTXzh','sep','basename','startsWith','exit','filter','type','./photoIndexUtil','4637840WWYsdR','643228DlxSNr','oldFile','scan_when_change','start','uncaughtException','join','journal_mode\x20=\x20WAL','图书来源变动:','电影来源变动:','INDEX_TABLE_NAME_PHOTO','music','log','file','message','statSync','pragma','checkPathIsInPrivateSpace','../../myConfig/config','newFile','send','path','FileChangingWatchWorker','音乐来源变动:','dbFileIndex','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','photo','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','../../db/dbSourceFolderTable','.DS_Store','../../db/dbFileIndexTable','delete','actions','splice','push','4701868uHdqhE','newDirectory','12ppcbdY','movie','length','dealTvDrama','watcher','重设文件变动检测','book','6341850sHZKnN','error','stop','getAll','dealFileChange','title','then'];_0x574d=function(){return _0x14c4d6;};return _0x574d();}process['on']('message',_0x4c7a74=>{const _0x3cf7bd=_0x3b9752;if(_0x4c7a74[_0x3cf7bd(0x13a)]=='startScanPath')_0x4c7a74['operate']!=_0x3cf7bd(0x15b)&&(console['log'](_0x3cf7bd(0x116)),setSourceFolderWatcher());else _0x4c7a74['type']==_0x3cf7bd(0x129)&&closeAllWatcher();});async function dealFileChange(_0x48f732,_0x520a39){const _0xbc3ef7=_0x3b9752;if(!_0x48f732||!_0x520a39)return;if(indexUtil[_0xbc3ef7(0x14d)](dbOther,_0x520a39))return![];if(indexUtil[_0xbc3ef7(0x120)](config,_0x520a39))return![];if(indexUtil['isForbiddenFilename'](path['basename'](_0x520a39)))return![];for(let _0x248634=0x0;_0x248634<waitDealFileList[_0xbc3ef7(0x163)];_0x248634++){if(waitDealFileList[_0x248634]['fullPath']==_0x520a39)return![];}waitDealFileList[_0xbc3ef7(0x15e)]({'watchPath':_0x48f732,'fullPath':_0x520a39,'filePath':path[_0xbc3ef7(0x12c)](_0x520a39),'fileName':path[_0xbc3ef7(0x136)](_0x520a39)});}async function startOneWatcher(_0x16c445){const _0x1f3f03=_0x3b9752;try{let _0x166de1=fs[_0x1f3f03(0x14b)](_0x16c445);if(!_0x166de1['isDirectory']())return null;let _0xe3c9ab=await nsfw(_0x16c445,function(_0xd04ea3){const _0x53c23b=_0x1f3f03;for(let _0x8f16 in _0xd04ea3){let _0x1fae36=_0xd04ea3[_0x8f16];if(_0x1fae36['file']==_0x53c23b(0x159))continue;if(_0x1fae36['action']==nsfw[_0x53c23b(0x15c)]['RENAMED']){let _0x1215b5=path['join'](_0x1fae36[_0x53c23b(0x121)],_0x1fae36[_0x53c23b(0x13e)]),_0x20155e=path[_0x53c23b(0x142)](_0x1fae36[_0x53c23b(0x160)],_0x1fae36[_0x53c23b(0x14f)]);dealFileChange(_0x16c445,_0x1215b5),dealFileChange(_0x16c445,_0x20155e);}else{let _0x3067e6=path[_0x53c23b(0x142)](_0x1fae36[_0x53c23b(0x121)],_0x1fae36[_0x53c23b(0x149)]);dealFileChange(_0x16c445,_0x3067e6);}}},{'errorCallback'(_0x293a5e){}});return _0xe3c9ab[_0x1f3f03(0x140)](),{'watcher':_0xe3c9ab,'watchPathState':_0x166de1};}catch(_0x2548ef){return console[_0x1f3f03(0x148)](_0x1f3f03(0x126),_0x16c445),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x49b054=_0x3b9752;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x31e58f(){const _0xfa927d=_0x1088;let _0x276f7b=[];for(let _0x2ae48b=0x0;_0x2ae48b<finalWatchFolderList[_0xfa927d(0x163)];_0x2ae48b++){let _0x5d9950=finalWatchFolderList[_0x2ae48b][_0xfa927d(0x151)];try{let _0x51e101=await startOneWatcher(_0x5d9950);_0x51e101?(console['log'](_0xfa927d(0x157),_0x5d9950),_0x276f7b['push']({'path':_0x5d9950,'watcher':_0x51e101['watcher']})):(console[_0xfa927d(0x148)](_0xfa927d(0x155),_0x5d9950),_0x276f7b[_0xfa927d(0x15e)]({'path':_0x5d9950,'watcher':null,'stop':0x1}));}catch(_0x1768d6){console[_0xfa927d(0x148)](_0x1768d6);}}return _0x276f7b;}let _0x1769d5=[];for(let _0x12eec4 in finalWatchFolderList){_0x1769d5[_0x49b054(0x15e)](finalWatchFolderList[_0x12eec4][_0x49b054(0x151)]);}closeAllWatcher(),allWatcherList=await _0x31e58f(_0x1769d5,dbFileIndexTable[_0x49b054(0x146)],_0x49b054(0x156)),isSettingWatcher=![];}function ifNeedDealChange(_0x2ed0f1,_0x644e6e){const _0x380814=_0x3b9752;for(let _0x24c112 in _0x2ed0f1){let _0x3db2be=_0x2ed0f1[_0x24c112];if(_0x644e6e[_0x380814(0x137)](_0x3db2be[_0x380814(0x151)]+path[_0x380814(0x135)])||_0x644e6e==_0x3db2be[_0x380814(0x151)]){let _0x118906=dbSourceFolderTable[_0x380814(0x12a)](dbOther,_0x3db2be['id']);return _0x2ed0f1[_0x24c112]=_0x118906,_0x118906||_0x118906['scan_when_change']==0x1?!![]:(console[_0x380814(0x148)]('未开启变动自动处理\x20跳过',_0x644e6e),![]);}}return![];}function initSourceFolderList(){const _0x97bdd7=_0x3b9752;let _0x282785=dbSourceFolderTable[_0x97bdd7(0x11b)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x5f5571 of _0x282785){if(_0x5f5571[_0x97bdd7(0x13f)]!=0x1)continue;if(_0x5f5571[_0x97bdd7(0x13a)]==_0x97bdd7(0x156))photoSourceFolderList[_0x97bdd7(0x15e)](_0x5f5571);else{if(_0x5f5571[_0x97bdd7(0x13a)]==_0x97bdd7(0x162))movieSourceFolderList['push'](_0x5f5571);else{if(_0x5f5571[_0x97bdd7(0x13a)]==_0x97bdd7(0x147))musicSourceFolderList[_0x97bdd7(0x15e)](_0x5f5571);else _0x5f5571[_0x97bdd7(0x13a)]==_0x97bdd7(0x117)&&bookSourceFolderList['push'](_0x5f5571);}}let _0x341bdd=!![];for(let _0x555420 of finalWatchFolderList){let _0x61caa0=path[_0x97bdd7(0x142)](_0x555420[_0x97bdd7(0x151)]),_0xc0a2b4=path[_0x97bdd7(0x142)](_0x5f5571[_0x97bdd7(0x151)]);if(_0x61caa0==_0xc0a2b4)_0x341bdd=![];else{if(_0xc0a2b4[_0x97bdd7(0x137)](_0x61caa0+path[_0x97bdd7(0x135)]))console['log'](_0x97bdd7(0x12b),_0x61caa0),_0x341bdd=![];else _0x61caa0['startsWith'](_0xc0a2b4+path[_0x97bdd7(0x135)])&&(console[_0x97bdd7(0x148)]('变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：',_0xc0a2b4),finalWatchFolderList=finalWatchFolderList[_0x97bdd7(0x139)](_0x11025f=>_0x11025f['path']!=_0x61caa0));}}_0x341bdd&&finalWatchFolderList[_0x97bdd7(0x15e)](_0x5f5571);}}async function closeAllWatcher(){const _0x2267c5=_0x3b9752;for(let _0x2a6f0e=0x0;_0x2a6f0e<allWatcherList[_0x2267c5(0x163)];_0x2a6f0e++){try{allWatcherList[_0x2a6f0e][_0x2267c5(0x165)]&&await allWatcherList[_0x2a6f0e][_0x2267c5(0x165)][_0x2267c5(0x11a)]();}catch(_0x12eb6f){}}}function dealNewFilePromise(){return new Promise(async(_0x45d5b4,_0x39baaa)=>{const _0x2476fe=_0x1088;if(waitDealFileList[_0x2476fe(0x163)]>0x0){let _0x46029a=waitDealFileList[0x0],_0x3f9a56=![],_0x3fa09f=![];return ifNeedDealChange(photoSourceFolderList,_0x46029a['fullPath'])&&(console[_0x2476fe(0x148)]('照片来源变动:',_0x46029a[_0x2476fe(0x127)]),_0x3f9a56=!![],await photoIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x46029a)),ifNeedDealChange(movieSourceFolderList,_0x46029a['fullPath'])&&(console['log'](_0x2476fe(0x145),_0x46029a[_0x2476fe(0x127)]),_0x3fa09f=!![],await movieIndexUtil[_0x2476fe(0x11c)](dbFileIndex,dbOther,_0x46029a)),ifNeedDealChange(musicSourceFolderList,_0x46029a['fullPath'])&&(console[_0x2476fe(0x148)](_0x2476fe(0x153),_0x46029a[_0x2476fe(0x127)]),await musicIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x46029a)),ifNeedDealChange(bookSourceFolderList,_0x46029a[_0x2476fe(0x127)])&&(console[_0x2476fe(0x148)](_0x2476fe(0x144),_0x46029a[_0x2476fe(0x127)]),await bookIndexUtil[_0x2476fe(0x11c)](dbFileIndex,dbOther,_0x46029a)),waitDealFileList[_0x2476fe(0x15d)](0x0,0x1),waitDealFileList[_0x2476fe(0x163)]<0x1&&(_0x3f9a56&&process['send']({'type':_0x2476fe(0x11f)}),_0x3fa09f&&(movieIndexUtil[_0x2476fe(0x164)](dbFileIndex),process[_0x2476fe(0x150)]({'type':'NEW_MOVIE_INDEX'}))),_0x45d5b4();}else setTimeout(()=>{return _0x45d5b4();},0x1388);});}function dealNewFileRun(){const _0x10cc8c=_0x3b9752;dealNewFilePromise()[_0x10cc8c(0x11e)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x3b9752(0x141),(_0x55d182,_0x156401)=>{const _0x6291f1=_0x3b9752;console[_0x6291f1(0x148)]('Error\x20occurred\x20in\x20photo\x20watcher\x20process',_0x55d182),messageUtil[_0x6291f1(0x125)](dbOther,_0x6291f1(0x12f),_0x6291f1(0x119),_0x55d182[_0x6291f1(0x124)]||_0x55d182[_0x6291f1(0x14a)]),closeAllWatcher(),process['send']({'type':_0x6291f1(0x133)}),process[_0x6291f1(0x138)]();});