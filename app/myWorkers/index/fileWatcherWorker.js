const _0x1e538d=_0x2232;(function(_0x3dab3e,_0x1b77ed){const _0x66fb84=_0x2232,_0x5cf952=_0x3dab3e();while(!![]){try{const _0x32bb1f=parseInt(_0x66fb84(0x12c))/0x1*(parseInt(_0x66fb84(0x106))/0x2)+-parseInt(_0x66fb84(0x114))/0x3*(-parseInt(_0x66fb84(0x109))/0x4)+-parseInt(_0x66fb84(0x11b))/0x5*(-parseInt(_0x66fb84(0x13c))/0x6)+-parseInt(_0x66fb84(0x120))/0x7+-parseInt(_0x66fb84(0x146))/0x8+parseInt(_0x66fb84(0x142))/0x9*(parseInt(_0x66fb84(0x10e))/0xa)+parseInt(_0x66fb84(0x13e))/0xb*(-parseInt(_0x66fb84(0x149))/0xc);if(_0x32bb1f===_0x1b77ed)break;else _0x5cf952['push'](_0x5cf952['shift']());}catch(_0x36ce91){_0x5cf952['push'](_0x5cf952['shift']());}}}(_0x1f49,0x5f988));function _0x1f49(){const _0xf6be56=['6548IDpTdu','./photoIndexUtil','checkPathIsInPrivateSpace','fullPath','path','520ALDqiT','log','filter','photo','图书来源变动:','The\x20source\x20folder\x20no\x20exists\x20:\x20','1365hatKoO','book','send','getAll','RENAMED','action','newFile','155MaCGbo','FileChangingWatchWorker','basename','isForbiddenFilename','startScanPath','5273002cATfPh','push','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','变动检测列表中已包含父目录','movie','dbFileIndex','watcher','error','dealFileChange','../../db/dbSourceFolderTable','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','newDirectory','29KEVgaS','close','dbOther','./bookIndexUtil','sep','电影来源变动:','closeWatcher','Error\x20occurred\x20in\x20photo\x20watcher\x20process','nsfw','stack','./movieIndexUtil','exit','music','then','splice','音乐来源变动:','96366KVaJjf','NEW_PHOTO_INDEX','1145441srHRKJ','better-sqlite3','title','uncaughtException','105678tVtkhH','delete','startsWith','type','829864MLxnYh','operate','start','96MOqFyz','oldFile','isDirectory','length','../../utils/messageUtil','isForbiddenPath','未开启变动自动处理\x20跳过','journal_mode\x20=\x20WAL','message','join','15746PESVAR','file','scan_when_change'];_0x1f49=function(){return _0xf6be56;};return _0x1f49();}let fs=require('fs'),path=require('path');const config=require('../../myConfig/config'),Database=require(_0x1e538d(0x13f));let dbOther=new Database(config[_0x1e538d(0x12e)],{}),dbFileIndex=new Database(config[_0x1e538d(0x125)],{});dbFileIndex['pragma']('journal_mode\x20=\x20WAL'),dbOther['pragma'](_0x1e538d(0x150));const dbSourceFolderTable=require(_0x1e538d(0x129)),dbFileIndexTable=require('../../db/dbFileIndexTable');var nsfw=require(_0x1e538d(0x134));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require('./indexUtil');const messageUtil=require(_0x1e538d(0x14d));process[_0x1e538d(0x140)]=_0x1e538d(0x11c);const bookIndexUtil=require(_0x1e538d(0x12f)),musicIndexUtil=require('./musicIndexUtil'),photoIndexUtil=require(_0x1e538d(0x10a)),movieIndexUtil=require(_0x1e538d(0x136));let allWatcherList=[],waitDealFileList=[];process['on'](_0x1e538d(0x151),_0x13841e=>{const _0x19ab44=_0x1e538d;if(_0x13841e[_0x19ab44(0x145)]==_0x19ab44(0x11f))_0x13841e[_0x19ab44(0x147)]!=_0x19ab44(0x143)&&(console[_0x19ab44(0x10f)]('重设文件变动检测'),setSourceFolderWatcher());else _0x13841e[_0x19ab44(0x145)]==_0x19ab44(0x132)&&closeAllWatcher();});async function dealFileChange(_0x3b97b6,_0x36ab9b){const _0x86ade8=_0x1e538d;if(!_0x3b97b6||!_0x36ab9b)return;if(indexUtil[_0x86ade8(0x10b)](dbOther,_0x36ab9b))return![];if(indexUtil[_0x86ade8(0x14e)](config,_0x36ab9b))return![];if(indexUtil[_0x86ade8(0x11e)](path[_0x86ade8(0x11d)](_0x36ab9b)))return![];for(let _0x28dfdd=0x0;_0x28dfdd<waitDealFileList['length'];_0x28dfdd++){if(waitDealFileList[_0x28dfdd][_0x86ade8(0x10c)]==_0x36ab9b)return![];}waitDealFileList[_0x86ade8(0x121)]({'watchPath':_0x3b97b6,'fullPath':_0x36ab9b,'filePath':path['dirname'](_0x36ab9b),'fileName':path[_0x86ade8(0x11d)](_0x36ab9b)});}function _0x2232(_0x3e85de,_0x43ce24){const _0x1f492d=_0x1f49();return _0x2232=function(_0x2232cb,_0x209610){_0x2232cb=_0x2232cb-0x105;let _0x3dbd68=_0x1f492d[_0x2232cb];return _0x3dbd68;},_0x2232(_0x3e85de,_0x43ce24);}async function startOneWatcher(_0x7acc9d){const _0x41cd79=_0x1e538d;try{let _0x2934e9=fs['statSync'](_0x7acc9d);if(!_0x2934e9[_0x41cd79(0x14b)]())return null;let _0x23359b=await nsfw(_0x7acc9d,function(_0x9817da){const _0x149730=_0x41cd79;for(let _0xe1b59a in _0x9817da){let _0x33983e=_0x9817da[_0xe1b59a];if(_0x33983e[_0x149730(0x107)]=='.DS_Store')continue;if(_0x33983e[_0x149730(0x119)]==nsfw['actions'][_0x149730(0x118)]){let _0x1c09d6=path[_0x149730(0x105)](_0x33983e['directory'],_0x33983e[_0x149730(0x14a)]),_0xcc924c=path[_0x149730(0x105)](_0x33983e[_0x149730(0x12b)],_0x33983e[_0x149730(0x11a)]);dealFileChange(_0x7acc9d,_0x1c09d6),dealFileChange(_0x7acc9d,_0xcc924c);}else{let _0x2e2976=path[_0x149730(0x105)](_0x33983e['directory'],_0x33983e[_0x149730(0x107)]);dealFileChange(_0x7acc9d,_0x2e2976);}}},{'errorCallback'(_0x2805ec){}});return _0x23359b[_0x41cd79(0x148)](),{'watcher':_0x23359b,'watchPathState':_0x2934e9};}catch(_0x55df30){return console[_0x41cd79(0x10f)](_0x41cd79(0x113),_0x7acc9d),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x513f89=_0x1e538d;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x445917(){const _0x57c96e=_0x2232;let _0x5089a4=[];for(let _0x368a37=0x0;_0x368a37<finalWatchFolderList[_0x57c96e(0x14c)];_0x368a37++){let _0xb8a355=finalWatchFolderList[_0x368a37][_0x57c96e(0x10d)];try{let _0x3fd7b5=await startOneWatcher(_0xb8a355);_0x3fd7b5?(console[_0x57c96e(0x10f)]('文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success',_0xb8a355),_0x5089a4[_0x57c96e(0x121)]({'path':_0xb8a355,'watcher':_0x3fd7b5['watcher']})):(console[_0x57c96e(0x10f)](_0x57c96e(0x122),_0xb8a355),_0x5089a4[_0x57c96e(0x121)]({'path':_0xb8a355,'watcher':null,'stop':0x1}));}catch(_0x5bc70e){console[_0x57c96e(0x10f)](_0x5bc70e);}}return _0x5089a4;}let _0x5df251=[];for(let _0x3aed8e in finalWatchFolderList){_0x5df251[_0x513f89(0x121)](finalWatchFolderList[_0x3aed8e][_0x513f89(0x10d)]);}closeAllWatcher(),allWatcherList=await _0x445917(_0x5df251,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],'photo'),isSettingWatcher=![];}function ifNeedDealChange(_0x5e9f2d,_0x3de7d7){const _0x104590=_0x1e538d;for(let _0x53db44 in _0x5e9f2d){let _0x4e98a9=_0x5e9f2d[_0x53db44];if(_0x3de7d7[_0x104590(0x144)](_0x4e98a9['path']+path[_0x104590(0x130)])||_0x3de7d7==_0x4e98a9[_0x104590(0x10d)]){let _0x37143=dbSourceFolderTable['getById'](dbOther,_0x4e98a9['id']);return _0x5e9f2d[_0x53db44]=_0x37143,_0x37143||_0x37143['scan_when_change']==0x1?!![]:(console[_0x104590(0x10f)](_0x104590(0x14f),_0x3de7d7),![]);}}return![];}function initSourceFolderList(){const _0x412183=_0x1e538d;let _0x6d1fd2=dbSourceFolderTable[_0x412183(0x117)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0x415f43 of _0x6d1fd2){if(_0x415f43[_0x412183(0x108)]!=0x1)continue;if(_0x415f43[_0x412183(0x145)]==_0x412183(0x111))photoSourceFolderList['push'](_0x415f43);else{if(_0x415f43[_0x412183(0x145)]==_0x412183(0x124))movieSourceFolderList[_0x412183(0x121)](_0x415f43);else{if(_0x415f43['type']==_0x412183(0x138))musicSourceFolderList[_0x412183(0x121)](_0x415f43);else _0x415f43[_0x412183(0x145)]==_0x412183(0x115)&&bookSourceFolderList[_0x412183(0x121)](_0x415f43);}}let _0x1b41c9=!![];for(let _0x354f77 of finalWatchFolderList){let _0x36ee98=path[_0x412183(0x105)](_0x354f77['path']),_0x520166=path['join'](_0x415f43[_0x412183(0x10d)]);if(_0x36ee98==_0x520166)_0x1b41c9=![];else{if(_0x520166[_0x412183(0x144)](_0x36ee98+path[_0x412183(0x130)]))console[_0x412183(0x10f)](_0x412183(0x123),_0x36ee98),_0x1b41c9=![];else _0x36ee98[_0x412183(0x144)](_0x520166+path['sep'])&&(console['log']('变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：',_0x520166),finalWatchFolderList=finalWatchFolderList[_0x412183(0x110)](_0x86f66d=>_0x86f66d[_0x412183(0x10d)]!=_0x36ee98));}}_0x1b41c9&&finalWatchFolderList[_0x412183(0x121)](_0x415f43);}}async function closeAllWatcher(){const _0x524b46=_0x1e538d;for(let _0xaf9ec6=0x0;_0xaf9ec6<allWatcherList[_0x524b46(0x14c)];_0xaf9ec6++){try{allWatcherList[_0xaf9ec6][_0x524b46(0x126)]&&await allWatcherList[_0xaf9ec6][_0x524b46(0x126)]['stop']();}catch(_0x361fa8){}}}function dealNewFilePromise(){return new Promise(async(_0x2c92e0,_0x212ab5)=>{const _0x4f9b46=_0x2232;if(waitDealFileList[_0x4f9b46(0x14c)]>0x0){let _0x523b46=waitDealFileList[0x0],_0x10bf7c=![],_0x5e38a6=![];return ifNeedDealChange(photoSourceFolderList,_0x523b46[_0x4f9b46(0x10c)])&&(console[_0x4f9b46(0x10f)]('照片来源变动:',_0x523b46[_0x4f9b46(0x10c)]),_0x10bf7c=!![],await photoIndexUtil[_0x4f9b46(0x128)](dbFileIndex,dbOther,_0x523b46)),ifNeedDealChange(movieSourceFolderList,_0x523b46[_0x4f9b46(0x10c)])&&(console['log'](_0x4f9b46(0x131),_0x523b46[_0x4f9b46(0x10c)]),_0x5e38a6=!![],await movieIndexUtil[_0x4f9b46(0x128)](dbFileIndex,dbOther,_0x523b46)),ifNeedDealChange(musicSourceFolderList,_0x523b46['fullPath'])&&(console['log'](_0x4f9b46(0x13b),_0x523b46[_0x4f9b46(0x10c)]),await musicIndexUtil[_0x4f9b46(0x128)](dbFileIndex,dbOther,_0x523b46)),ifNeedDealChange(bookSourceFolderList,_0x523b46['fullPath'])&&(console[_0x4f9b46(0x10f)](_0x4f9b46(0x112),_0x523b46[_0x4f9b46(0x10c)]),await bookIndexUtil[_0x4f9b46(0x128)](dbFileIndex,dbOther,_0x523b46)),waitDealFileList[_0x4f9b46(0x13a)](0x0,0x1),waitDealFileList[_0x4f9b46(0x14c)]<0x1&&(_0x10bf7c&&process['send']({'type':_0x4f9b46(0x13d)}),_0x5e38a6&&(movieIndexUtil['dealTvDrama'](dbFileIndex),process['send']({'type':'NEW_MOVIE_INDEX'}))),_0x2c92e0();}else setTimeout(()=>{return _0x2c92e0();},0x1388);});}function dealNewFileRun(){const _0x1fcdb2=_0x1e538d;dealNewFilePromise()[_0x1fcdb2(0x139)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on'](_0x1e538d(0x141),(_0x2e757a,_0x26fbb1)=>{const _0x3c3225=_0x1e538d;console[_0x3c3225(0x10f)](_0x3c3225(0x133),_0x2e757a),messageUtil['saveMsg'](dbOther,_0x3c3225(0x12a),_0x3c3225(0x127),_0x2e757a[_0x3c3225(0x135)]||_0x2e757a[_0x3c3225(0x151)]),closeAllWatcher(),process[_0x3c3225(0x116)]({'type':_0x3c3225(0x12d)}),process[_0x3c3225(0x137)]();});