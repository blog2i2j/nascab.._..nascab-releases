const _0x494d3d=_0x2a51;(function(_0x4711f1,_0x302b59){const _0x10fbc8=_0x2a51,_0x54d60a=_0x4711f1();while(!![]){try{const _0x490b07=parseInt(_0x10fbc8(0xd7))/0x1+-parseInt(_0x10fbc8(0xe9))/0x2+-parseInt(_0x10fbc8(0xd6))/0x3+parseInt(_0x10fbc8(0xf0))/0x4*(-parseInt(_0x10fbc8(0xc8))/0x5)+-parseInt(_0x10fbc8(0xca))/0x6*(-parseInt(_0x10fbc8(0xb8))/0x7)+parseInt(_0x10fbc8(0xcd))/0x8*(parseInt(_0x10fbc8(0xb4))/0x9)+parseInt(_0x10fbc8(0xe4))/0xa;if(_0x490b07===_0x302b59)break;else _0x54d60a['push'](_0x54d60a['shift']());}catch(_0x595abf){_0x54d60a['push'](_0x54d60a['shift']());}}}(_0x16ae,0x57b71));let fs=require('fs'),path=require(_0x494d3d(0xbe));const config=require(_0x494d3d(0xb5)),Database=require(_0x494d3d(0xb1));let dbOther=new Database(config[_0x494d3d(0xb3)],{}),dbFileIndex=new Database(config['dbFileIndex'],{});dbFileIndex['pragma'](_0x494d3d(0xf2)),dbOther[_0x494d3d(0xaf)](_0x494d3d(0xf2));const dbSourceFolderTable=require(_0x494d3d(0xa5)),dbFileIndexTable=require(_0x494d3d(0xe8));var nsfw=require(_0x494d3d(0xd0));let photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[],indexUtil=require(_0x494d3d(0xd3));const messageUtil=require(_0x494d3d(0xd9));function _0x2a51(_0x2b9a53,_0x11bb37){const _0x16aefb=_0x16ae();return _0x2a51=function(_0x2a51dc,_0xa30e42){_0x2a51dc=_0x2a51dc-0xa4;let _0x57dae8=_0x16aefb[_0x2a51dc];return _0x57dae8;},_0x2a51(_0x2b9a53,_0x11bb37);}process['title']=_0x494d3d(0xf3);const bookIndexUtil=require(_0x494d3d(0xcf)),musicIndexUtil=require(_0x494d3d(0xee)),photoIndexUtil=require(_0x494d3d(0xd1)),movieIndexUtil=require(_0x494d3d(0xa4));let allWatcherList=[],waitDealFileList=[];process['on'](_0x494d3d(0xac),_0x300f8d=>{const _0x102dad=_0x494d3d;if(_0x300f8d[_0x102dad(0xdf)]==_0x102dad(0xea))_0x300f8d[_0x102dad(0xe0)]!=_0x102dad(0xba)&&(console[_0x102dad(0xde)](_0x102dad(0xef)),setSourceFolderWatcher());else _0x300f8d['type']==_0x102dad(0xd8)&&closeAllWatcher();});async function dealFileChange(_0xb7fa9,_0x91ee2e){const _0x51b8ef=_0x494d3d;if(!_0xb7fa9||!_0x91ee2e)return;if(indexUtil[_0x51b8ef(0xe7)](dbOther,_0x91ee2e))return![];if(indexUtil[_0x51b8ef(0xbd)](config,_0x91ee2e))return![];if(indexUtil['isForbiddenFilename'](path[_0x51b8ef(0xab)](_0x91ee2e)))return![];for(let _0x2d872a=0x0;_0x2d872a<waitDealFileList[_0x51b8ef(0xed)];_0x2d872a++){if(waitDealFileList[_0x2d872a][_0x51b8ef(0xae)]==_0x91ee2e)return![];}waitDealFileList[_0x51b8ef(0xa9)]({'watchPath':_0xb7fa9,'fullPath':_0x91ee2e,'filePath':path[_0x51b8ef(0xe3)](_0x91ee2e),'fileName':path[_0x51b8ef(0xab)](_0x91ee2e)});}async function startOneWatcher(_0x380968){const _0x33a893=_0x494d3d;try{let _0x475091=fs[_0x33a893(0xc4)](_0x380968);if(!_0x475091[_0x33a893(0xb6)]())return null;let _0x3fc45a=await nsfw(_0x380968,function(_0x3b2cb1){const _0x945f5=_0x33a893;for(let _0x1fc144 in _0x3b2cb1){let _0x24f1b9=_0x3b2cb1[_0x1fc144];if(_0x24f1b9[_0x945f5(0xc1)]=='.DS_Store')continue;if(_0x24f1b9['action']==nsfw[_0x945f5(0xec)][_0x945f5(0xce)]){let _0x30d5db=path[_0x945f5(0xb2)](_0x24f1b9[_0x945f5(0xd4)],_0x24f1b9[_0x945f5(0xdc)]),_0x2b43ab=path[_0x945f5(0xb2)](_0x24f1b9['newDirectory'],_0x24f1b9['newFile']);dealFileChange(_0x380968,_0x30d5db),dealFileChange(_0x380968,_0x2b43ab);}else{let _0x10908d=path[_0x945f5(0xb2)](_0x24f1b9[_0x945f5(0xd4)],_0x24f1b9[_0x945f5(0xc1)]);dealFileChange(_0x380968,_0x10908d);}}},{'errorCallback'(_0x40c928){}});return _0x3fc45a[_0x33a893(0xda)](),{'watcher':_0x3fc45a,'watchPathState':_0x475091};}catch(_0x5c036d){return console[_0x33a893(0xde)](_0x33a893(0xbf),_0x380968),null;}}let isSettingWatcher=![];async function setSourceFolderWatcher(){const _0x5eb2ca=_0x494d3d;initSourceFolderList();if(isSettingWatcher)return;isSettingWatcher=!![];async function _0x189f33(){const _0x3dfbed=_0x2a51;let _0x478bec=[];for(let _0x536b17=0x0;_0x536b17<finalWatchFolderList['length'];_0x536b17++){let _0x4b8fcc=finalWatchFolderList[_0x536b17][_0x3dfbed(0xbe)];try{let _0xc6b5b7=await startOneWatcher(_0x4b8fcc);_0xc6b5b7?(console[_0x3dfbed(0xde)](_0x3dfbed(0xe5),_0x4b8fcc),_0x478bec[_0x3dfbed(0xa9)]({'path':_0x4b8fcc,'watcher':_0xc6b5b7[_0x3dfbed(0xeb)]})):(console[_0x3dfbed(0xde)](_0x3dfbed(0xc0),_0x4b8fcc),_0x478bec['push']({'path':_0x4b8fcc,'watcher':null,'stop':0x1}));}catch(_0x23d102){console[_0x3dfbed(0xde)](_0x23d102);}}return _0x478bec;}let _0x2b5a2c=[];for(let _0x44a5a5 in finalWatchFolderList){_0x2b5a2c['push'](finalWatchFolderList[_0x44a5a5][_0x5eb2ca(0xbe)]);}closeAllWatcher(),allWatcherList=await _0x189f33(_0x2b5a2c,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'],_0x5eb2ca(0xaa)),isSettingWatcher=![];}function ifNeedDealChange(_0xa687e0,_0x536743){const _0x4dc0ae=_0x494d3d;for(let _0x421943 in _0xa687e0){let _0x366cbc=_0xa687e0[_0x421943];if(_0x536743[_0x4dc0ae(0xc3)](_0x366cbc[_0x4dc0ae(0xbe)]+path[_0x4dc0ae(0xdd)])||_0x536743==_0x366cbc[_0x4dc0ae(0xbe)]){let _0x312dea=dbSourceFolderTable[_0x4dc0ae(0xcb)](dbOther,_0x366cbc['id']);return _0xa687e0[_0x421943]=_0x312dea,_0x312dea||_0x312dea['scan_when_change']==0x1?!![]:(console['log'](_0x4dc0ae(0xc2),_0x536743),![]);}}return![];}function initSourceFolderList(){const _0x57329d=_0x494d3d;let _0x1953f3=dbSourceFolderTable[_0x57329d(0xe2)](dbOther);photoSourceFolderList=[],movieSourceFolderList=[],musicSourceFolderList=[],bookSourceFolderList=[],finalWatchFolderList=[];for(let _0xf02df6 of _0x1953f3){if(_0xf02df6['scan_when_change']!=0x1)continue;if(_0xf02df6[_0x57329d(0xdf)]==_0x57329d(0xaa))photoSourceFolderList[_0x57329d(0xa9)](_0xf02df6);else{if(_0xf02df6[_0x57329d(0xdf)]==_0x57329d(0xc6))movieSourceFolderList[_0x57329d(0xa9)](_0xf02df6);else{if(_0xf02df6[_0x57329d(0xdf)]==_0x57329d(0xa8))musicSourceFolderList[_0x57329d(0xa9)](_0xf02df6);else _0xf02df6[_0x57329d(0xdf)]==_0x57329d(0xc9)&&bookSourceFolderList[_0x57329d(0xa9)](_0xf02df6);}}let _0x59da4=!![];for(let _0x46852a of finalWatchFolderList){let _0x1678fa=path[_0x57329d(0xb2)](_0x46852a['path']),_0x466f00=path[_0x57329d(0xb2)](_0xf02df6[_0x57329d(0xbe)]);if(_0x1678fa==_0x466f00)_0x59da4=![];else{if(_0x466f00[_0x57329d(0xc3)](_0x1678fa+path[_0x57329d(0xdd)]))console[_0x57329d(0xde)](_0x57329d(0xbb),_0x1678fa),_0x59da4=![];else _0x1678fa[_0x57329d(0xc3)](_0x466f00+path[_0x57329d(0xdd)])&&(console[_0x57329d(0xde)](_0x57329d(0xe6),_0x466f00),finalWatchFolderList=finalWatchFolderList['filter'](_0x44c658=>_0x44c658[_0x57329d(0xbe)]!=_0x1678fa));}}_0x59da4&&finalWatchFolderList[_0x57329d(0xa9)](_0xf02df6);}}function _0x16ae(){const _0x470b1b=['then','856ZeTTPO','RENAMED','./bookIndexUtil','nsfw','./photoIndexUtil','音乐来源变动:','./indexUtil','directory','照片来源变动:','2101434DaSbqX','148897nqOvUP','closeWatcher','../../utils/messageUtil','start','error','oldFile','sep','log','type','operate','Error\x20occurred\x20in\x20source\x20folder\x20watcher\x20process','getAll','dirname','17055660pymuTT','文件变动检测已开启\x20Watching\x20\x20source\x20folder\x20success','变动检测列表中包含范围较小的路径\x20需要替换为范围较大的：','checkPathIsInPrivateSpace','../../db/dbFileIndexTable','1247808iMXUQZ','startScanPath','watcher','actions','length','./musicIndexUtil','重设文件变动检测','40kFvySa','NEW_MOVIE_INDEX','journal_mode\x20=\x20WAL','FileChangingWatchWorker','./movieIndexUtil','../../db/dbSourceFolderTable','stop','stack','music','push','photo','basename','message','图书来源变动:','fullPath','pragma','Error\x20occurred\x20in\x20photo\x20watcher\x20process','better-sqlite3','join','dbOther','19080xEhQed','../../myConfig/config','isDirectory','send','5593uZxIpJ','saveMsg','delete','变动检测列表中已包含父目录','dealFileChange','isForbiddenPath','path','The\x20source\x20folder\x20no\x20exists\x20:\x20','文件变动检测启动失败\x20Watching\x20\x20source\x20folder\x20faild','file','未开启变动自动处理\x20跳过','startsWith','statSync','NEW_PHOTO_INDEX','movie','splice','338645RfFXcc','book','2100mzYQJi','getById'];_0x16ae=function(){return _0x470b1b;};return _0x16ae();}async function closeAllWatcher(){const _0x29e466=_0x494d3d;for(let _0x562a9e=0x0;_0x562a9e<allWatcherList[_0x29e466(0xed)];_0x562a9e++){try{allWatcherList[_0x562a9e][_0x29e466(0xeb)]&&await allWatcherList[_0x562a9e][_0x29e466(0xeb)][_0x29e466(0xa6)]();}catch(_0x5a56c1){}}}function dealNewFilePromise(){return new Promise(async(_0x416674,_0x232218)=>{const _0x1c1374=_0x2a51;if(waitDealFileList[_0x1c1374(0xed)]>0x0){let _0x31ef0c=waitDealFileList[0x0],_0x46c1c4=![],_0x511c66=![];return ifNeedDealChange(photoSourceFolderList,_0x31ef0c[_0x1c1374(0xae)])&&(console[_0x1c1374(0xde)](_0x1c1374(0xd5),_0x31ef0c[_0x1c1374(0xae)]),_0x46c1c4=!![],await photoIndexUtil[_0x1c1374(0xbc)](dbFileIndex,dbOther,_0x31ef0c)),ifNeedDealChange(movieSourceFolderList,_0x31ef0c['fullPath'])&&(console[_0x1c1374(0xde)]('电影来源变动:',_0x31ef0c[_0x1c1374(0xae)]),_0x511c66=!![],await movieIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x31ef0c)),ifNeedDealChange(musicSourceFolderList,_0x31ef0c[_0x1c1374(0xae)])&&(console[_0x1c1374(0xde)](_0x1c1374(0xd2),_0x31ef0c['fullPath']),await musicIndexUtil['dealFileChange'](dbFileIndex,dbOther,_0x31ef0c)),ifNeedDealChange(bookSourceFolderList,_0x31ef0c[_0x1c1374(0xae)])&&(console[_0x1c1374(0xde)](_0x1c1374(0xad),_0x31ef0c[_0x1c1374(0xae)]),await bookIndexUtil[_0x1c1374(0xbc)](dbFileIndex,dbOther,_0x31ef0c)),waitDealFileList[_0x1c1374(0xc7)](0x0,0x1),waitDealFileList['length']<0x1&&(_0x46c1c4&&process[_0x1c1374(0xb7)]({'type':_0x1c1374(0xc5)}),_0x511c66&&(movieIndexUtil['dealTvDrama'](dbFileIndex),process[_0x1c1374(0xb7)]({'type':_0x1c1374(0xf1)}))),_0x416674();}else setTimeout(()=>{return _0x416674();},0x1388);});}function dealNewFileRun(){const _0x36bb13=_0x494d3d;dealNewFilePromise()[_0x36bb13(0xcc)](()=>{dealNewFileRun();});}async function init(){await setSourceFolderWatcher(),dealNewFileRun();}init(),process['on']('uncaughtException',(_0x4c272f,_0x4c81c2)=>{const _0x55b4e1=_0x494d3d;console[_0x55b4e1(0xde)](_0x55b4e1(0xb0),_0x4c272f),messageUtil[_0x55b4e1(0xb9)](dbOther,_0x55b4e1(0xe1),_0x55b4e1(0xdb),_0x4c272f[_0x55b4e1(0xa7)]||_0x4c272f[_0x55b4e1(0xac)]),closeAllWatcher(),process[_0x55b4e1(0xb7)]({'type':'close'}),process['exit']();});