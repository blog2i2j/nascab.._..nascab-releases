const _0x5422bf=_0x3b13;(function(_0x48f123,_0xafe14a){const _0x345773=_0x3b13,_0x56a17d=_0x48f123();while(!![]){try{const _0x5dcbcb=parseInt(_0x345773(0x20b))/0x1*(-parseInt(_0x345773(0x1c9))/0x2)+-parseInt(_0x345773(0x1de))/0x3+-parseInt(_0x345773(0x205))/0x4*(-parseInt(_0x345773(0x20c))/0x5)+-parseInt(_0x345773(0x1c7))/0x6+parseInt(_0x345773(0x1f4))/0x7*(parseInt(_0x345773(0x201))/0x8)+-parseInt(_0x345773(0x215))/0x9*(-parseInt(_0x345773(0x1f8))/0xa)+-parseInt(_0x345773(0x218))/0xb*(parseInt(_0x345773(0x204))/0xc);if(_0x5dcbcb===_0xafe14a)break;else _0x56a17d['push'](_0x56a17d['shift']());}catch(_0x52fc10){_0x56a17d['push'](_0x56a17d['shift']());}}}(_0x1d43,0x3210d));const path=require('path'),fs=require('fs');function _0x3b13(_0x296840,_0x45aa28){const _0x1d43d9=_0x1d43();return _0x3b13=function(_0x3b132f,_0x3e8190){_0x3b132f=_0x3b132f-0x1bd;let _0x69ff0f=_0x1d43d9[_0x3b132f];return _0x69ff0f;},_0x3b13(_0x296840,_0x45aa28);}let pinyin=require(_0x5422bf(0x20f));const sharp=require(_0x5422bf(0x1c5)),{Worker}=require('worker_threads');let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require(_0x5422bf(0x1e3)),dbFileIndexTable=require(_0x5422bf(0x1dd)),dbConfigTable=require(_0x5422bf(0x1c1)),config=require(_0x5422bf(0x21a)),indexUtil=require(_0x5422bf(0x1df)),nfoUtil=require(_0x5422bf(0x21c)),indexTableName=dbFileIndexTable['INDEX_TABLE_NAME_BOOK'],bookIndexUtil={};bookIndexUtil[_0x5422bf(0x203)]=async function(_0x2ffefd,_0x2320b3){return new Promise((_0x2f24e8,_0x2ec5c5)=>{const _0x57c88b=_0x3b13;sharp(_0x2ffefd,{'failOnError':![]})['jpeg']({'quality':0x4d})[_0x57c88b(0x217)]({'width':0x1f4})[_0x57c88b(0x1cb)]()[_0x57c88b(0x1dc)](_0x4d249c=>{fs['writeFile'](_0x2320b3,_0x4d249c,_0x4907e4=>{if(_0x4907e4)return _0x2ec5c5();return _0x2f24e8(_0x2320b3);});})[_0x57c88b(0x1e4)](_0x405f40=>{const _0x2ad619=_0x57c88b;return console[_0x2ad619(0x206)](_0x2ad619(0x1d9),_0x405f40),_0x2ec5c5();});});},bookIndexUtil[_0x5422bf(0x210)]=function(_0x482e75,_0x98603a,_0x526ff9=![]){return new Promise((_0x5eb054,_0x265fd9)=>{const _0x2b11f1=_0x3b13;let _0x3bbbb8=new Worker(path[_0x2b11f1(0x20d)](__dirname,_0x2b11f1(0x1e7)),{'workerData':{'indexObj':_0x482e75,'bookCoverCachePath':_0x98603a,'onlyGenCover':_0x526ff9}}),_0x273ffc=setTimeout(()=>{const _0x592706=_0x2b11f1;_0x3bbbb8&&(console['log']('已超时\x20结束处理worker'),_0x3bbbb8[_0x592706(0x1d5)](),_0x3bbbb8=null,_0x265fd9());},0x7530);_0x3bbbb8['on'](_0x2b11f1(0x1f6),_0x466faf=>{const _0x3dd358=_0x2b11f1;_0x466faf[_0x3dd358(0x1f9)]==0x0&&(_0x273ffc&&clearTimeout(_0x273ffc),_0x5eb054(_0x466faf));}),_0x3bbbb8['on'](_0x2b11f1(0x1fd),_0x2d10fe=>{const _0x4190a0=_0x2b11f1;console[_0x4190a0(0x1fd)](_0x4190a0(0x1f1),_0x2d10fe),_0x3bbbb8&&(_0x3bbbb8['terminate'](),_0x3bbbb8=null),_0x265fd9();}),_0x3bbbb8['on'](_0x2b11f1(0x1f3),_0x56bb0=>{const _0x46af0d=_0x2b11f1;if(_0x56bb0!==0x0)console['error'](_0x46af0d(0x1c8),_0x56bb0);else{}});});},bookIndexUtil[_0x5422bf(0x1ed)]=async function(_0x30cf8f,_0x551c38){const _0x53a549=_0x5422bf;let _0x4329cb=![];if(_0x551c38[_0x53a549(0x1da)]==0x1&&_0x551c38[_0x53a549(0x1e2)]&&config[_0x53a549(0x1fc)][_0x53a549(0x21b)](_0x551c38[_0x53a549(0x1e2)][_0x53a549(0x1ea)]())){!_0x551c38[_0x53a549(0x1c2)]&&(_0x551c38[_0x53a549(0x1c2)]=bookIndexUtil['getBookType'](_0x551c38));let _0x3b6ed6=config[_0x53a549(0x1d3)](_0x551c38);try{let _0x50f7ae=await bookIndexUtil[_0x53a549(0x210)](_0x551c38,_0x3b6ed6);if(_0x50f7ae[_0x53a549(0x1ca)])try{let _0xaac3bb=await bookIndexUtil['sharpWriteCover'](_0x50f7ae[_0x53a549(0x1ca)],_0x3b6ed6);_0xaac3bb&&(console[_0x53a549(0x206)](_0x53a549(0x1fa),_0xaac3bb),_0x50f7ae['indexObj'][_0x53a549(0x1c4)]=_0xaac3bb);}catch(_0x582ffb){console[_0x53a549(0x206)](_0x582ffb);}return console[_0x53a549(0x206)]('处理成功',_0x50f7ae['indexObj'][_0x53a549(0x1d8)],_0x50f7ae[_0x53a549(0x1e9)][_0x53a549(0x1c6)]),bookIndexUtil[_0x53a549(0x211)](_0x30cf8f,_0x50f7ae[_0x53a549(0x1cf)],_0x50f7ae[_0x53a549(0x1e9)]);}catch(_0x372fa4){return console['log']('err\x205',_0x372fa4),bookIndexUtil[_0x53a549(0x211)](_0x30cf8f,_0x4329cb,_0x551c38);}}else{if(_0x551c38['is_file']==0x1)return;return bookIndexUtil['addOriginalDate'](_0x30cf8f,_0x4329cb,_0x551c38);}},bookIndexUtil[_0x5422bf(0x202)]=function(_0x2febef){const _0x287dbe=_0x5422bf;let _0x4da8bd=[_0x287dbe(0x1d4),_0x287dbe(0x1f5),'.rar',_0x287dbe(0x1f7)];return _0x2febef['ext']&&_0x4da8bd['includes'](_0x2febef[_0x287dbe(0x1e2)][_0x287dbe(0x1ea)]())?0x2:0x1;},bookIndexUtil['setAllBookType']=function(_0x315bc7){const _0x315ee7=_0x5422bf;let _0x5bb6e4=_0x315ee7(0x209),_0x12c2e8=_0x315ee7(0x1ff)+_0x5bb6e4;_0x315bc7[_0x315ee7(0x212)](_0x12c2e8)[_0x315ee7(0x1f2)](),_0x12c2e8=_0x315ee7(0x1e1)+_0x5bb6e4,_0x315bc7['prepare'](_0x12c2e8)[_0x315ee7(0x1f2)]();},bookIndexUtil[_0x5422bf(0x1c3)]=async function(_0x50e0e5,_0x522893,_0xcfa965){const _0x2684bb=_0x5422bf;return await indexUtil[_0x2684bb(0x1c3)](_0x50e0e5,_0x522893,indexTableName,_0x2684bb(0x1e6),_0xcfa965,bookIndexUtil[_0x2684bb(0x1ce)]);},bookIndexUtil[_0x5422bf(0x1ce)]=async function(_0x3a61d9,_0x5cbd64,_0x519606,_0x17f3fc,_0x229c78,_0x10cc38){const _0x2e2086=_0x5422bf;let _0x327d0b=indexUtil[_0x2e2086(0x1d7)](_0x3a61d9,_0x2e2086(0x1e6),config,_0x519606,_0x17f3fc);if(!_0x327d0b)return;let _0x678f1=_0x10cc38['birthtimeMs'];_0x10cc38[_0x2e2086(0x213)]<_0x678f1&&(_0x678f1=_0x10cc38[_0x2e2086(0x213)]);_0x10cc38[_0x2e2086(0x1e0)]<_0x678f1&&(_0x678f1=_0x10cc38[_0x2e2086(0x1e0)]);_0x10cc38[_0x2e2086(0x1cd)]<_0x678f1&&(_0x678f1=_0x10cc38[_0x2e2086(0x1cd)]);let _0x48988a={'path':_0x519606,'filename':_0x17f3fc,'is_file':_0x229c78,'ctime':_0x10cc38['ctimeMs'],'mtime':_0x10cc38['mtimeMs'],'ext':path[_0x2e2086(0x1ef)](_0x17f3fc),'birthtime':Math[_0x2e2086(0x20a)](_0x678f1),'size':_0x10cc38[_0x2e2086(0x1ec)],'check_time':new Date()['getTime']()};_0x48988a=await bookIndexUtil[_0x2e2086(0x1ed)](_0x5cbd64,_0x48988a);},bookIndexUtil[_0x5422bf(0x1db)]=async function(_0x33559d,_0x1b3409,_0x39b18d){const _0x54647f=_0x5422bf;await indexUtil['dealFileChange'](_0x33559d,_0x1b3409,_0x39b18d,indexTableName,bookIndexUtil[_0x54647f(0x1ce)],bookIndexUtil[_0x54647f(0x1c3)]);return;},bookIndexUtil[_0x5422bf(0x211)]=function(_0xc48e3a,_0x36ff15,_0x34146c){const _0x415abb=_0x5422bf;nfoUtil[_0x415abb(0x1eb)](_0x34146c)['then'](_0x309fc7=>{_0x304e08(_0x309fc7);})[_0x415abb(0x1e4)](_0x2e9715=>{_0x304e08(_0x34146c);});function _0x304e08(_0x131555){const _0x462716=_0x415abb;_0x36ff15&&_0x36ff15<config[_0x462716(0x1c0)]&&(_0x36ff15=![]);(!_0x36ff15||_0x36ff15==_0x462716(0x200)||_0x36ff15==_0x462716(0x1f0)||_0x36ff15=='NaN'||_0x36ff15==_0x462716(0x219))&&(_0x36ff15=_0x131555['birthtime']||_0x131555['ctime']);let _0x59bb57=new Date(_0x36ff15);_0x131555[_0x462716(0x1be)]=_0x59bb57['getTime']();let _0x3d0ab9=_0x59bb57[_0x462716(0x1e8)](),_0x5c77df=_0x59bb57[_0x462716(0x1d2)]()+0x1;_0x5c77df=_0x5c77df>=0xa?_0x5c77df:'0'+_0x5c77df;let _0x3aca01=_0x59bb57['getDate']();_0x3aca01=_0x3aca01>=0xa?_0x3aca01:'0'+_0x3aca01,_0x131555[_0x462716(0x1ee)]=_0x3d0ab9+'-'+_0x5c77df+'-'+_0x3aca01;let _0x5b31db=dbFileIndexTable[_0x462716(0x214)](_0xc48e3a,_0x131555,indexTableName);if(_0x5b31db&&_0x5b31db[_0x462716(0x1d0)]){let _0x5ed84e=dbFileIndexTable[_0x462716(0x1e5)](_0xc48e3a,_0x5b31db[_0x462716(0x1d0)],dbFileIndexTable[_0x462716(0x1d1)]);_0x5ed84e&&bookIndexUtil[_0x462716(0x1fe)](_0xc48e3a,_0x5ed84e);}}},bookIndexUtil[_0x5422bf(0x1bd)]=function(_0xaa1a79){const _0x7b0335=_0x5422bf;let _0x8f0e06=_0x7b0335(0x1d6),_0xa858a5=_0xaa1a79['prepare'](_0x8f0e06)[_0x7b0335(0x1fb)]();for(let _0x1b444e in _0xa858a5){bookIndexUtil['dealFirstLetterSingle'](_0xaa1a79,_0xa858a5[_0x1b444e]);}};function _0x1d43(){const _0x5a08a6=['toLowerCase','restoreBookNfo','size','dealBookInfo','original_date','extname','Nan','Worker\x20error:','run','exit','14HXkeoy','.cbr','message','.zip','1288910uJcXCb','code','封面写入成功','all','bookTypeList','error','dealFirstLetterSingle','UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20','NaN','1129328yddbSr','getBookType','sharpWriteCover','468552DHZhdF','1176gcFbWO','log','length','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','ceil','1XZdFhw','6810bYcORd','resolve','title','node-pinyin','runGetBookInfoWorker','addOriginalDate','prepare','mtimeMs','create','27alMZhE','exports','resize','121QlBfUb','Null','../../myConfig/config','includes','../../utils/nfoUtil','dealFirstLetterAll','original_time','toUpperCase','exifMinTimeStamp','../../db/dbConfigTable','type','recursionFilesAddIndex','coverPath','sharp','total_page','1184508LQoSsc','Worker\x20stopped\x20with\x20exit\x20code:','44692YhCIWg','coverData','toBuffer','artist','ctimeMs','addFileIndexToDb','originalTime','lastInsertRowid','INDEX_TABLE_NAME_BOOK','getMonth','getMediaCoverCachePath','.cbz','terminate','SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null','doesPathCanAddToDb','filename','err1','is_file','dealFileChange','then','../../db/dbFileIndexTable','645282uBLtkC','./indexUtil','atimeMs','UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20','ext','../../db/dbSourceFolderTable','catch','getById','book','bookInfoWorker.js','getFullYear','indexObj'];_0x1d43=function(){return _0x5a08a6;};return _0x1d43();}function isChinese(_0x343c98){var _0x4ee3e4=/[^\\u4e00-\\u9fa5]/;return _0x4ee3e4['test'](_0x343c98);}bookIndexUtil[_0x5422bf(0x1fe)]=function(_0x40c317,_0x8d744d){const _0x445c3d=_0x5422bf;function _0x4aa8ec(_0x50da38){const _0x1bedb1=_0x3b13;if(_0x50da38&&_0x50da38[_0x1bedb1(0x207)]>0x0){let _0x5a6dda=_0x50da38[0x0];if(letterList['includes'](_0x5a6dda))return _0x5a6dda;else{if(isChinese(_0x5a6dda)){let _0x1c7271=pinyin(_0x5a6dda,{'style':'initials'});return _0x1c7271&&_0x1c7271[_0x1bedb1(0x207)]>0x0&&_0x1c7271[0x0][_0x1bedb1(0x207)]>0x0&&_0x1c7271[0x0][0x0][_0x1bedb1(0x207)]>0x0?_0x1c7271[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x4ea206=_0x4aa8ec(_0x8d744d[_0x445c3d(0x1d8)]?_0x8d744d[_0x445c3d(0x1d8)][_0x445c3d(0x1bf)]():'')[_0x445c3d(0x1bf)](),_0x4c5020=_0x4aa8ec(_0x8d744d[_0x445c3d(0x1cc)]?_0x8d744d[_0x445c3d(0x1cc)][_0x445c3d(0x1bf)]():'')[_0x445c3d(0x1bf)](),_0x1a5322=_0x4aa8ec(_0x8d744d['title']?_0x8d744d[_0x445c3d(0x20e)][_0x445c3d(0x1bf)]():'')['toUpperCase']();_0x40c317[_0x445c3d(0x212)](_0x445c3d(0x208))[_0x445c3d(0x1f2)](_0x4ea206,_0x4c5020,_0x1a5322,_0x8d744d['id']);},module[_0x5422bf(0x216)]=bookIndexUtil;