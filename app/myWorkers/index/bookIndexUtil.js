const _0xaf8dbe=_0xaf39;(function(_0x333734,_0x298997){const _0x3b1b22=_0xaf39,_0x487a65=_0x333734();while(!![]){try{const _0x2e8980=-parseInt(_0x3b1b22(0x159))/0x1*(parseInt(_0x3b1b22(0x15b))/0x2)+-parseInt(_0x3b1b22(0x189))/0x3+-parseInt(_0x3b1b22(0x13a))/0x4+-parseInt(_0x3b1b22(0x17c))/0x5*(-parseInt(_0x3b1b22(0x179))/0x6)+parseInt(_0x3b1b22(0x130))/0x7*(-parseInt(_0x3b1b22(0x13d))/0x8)+parseInt(_0x3b1b22(0x16b))/0x9+parseInt(_0x3b1b22(0x164))/0xa;if(_0x2e8980===_0x298997)break;else _0x487a65['push'](_0x487a65['shift']());}catch(_0x160424){_0x487a65['push'](_0x487a65['shift']());}}}(_0x5418,0x24680));const path=require(_0xaf8dbe(0x184)),fs=require('fs');let pinyin=require(_0xaf8dbe(0x178));const sharp=require('sharp'),{Worker}=require(_0xaf8dbe(0x177));let letterList=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];const dbSourceFolderTable=require(_0xaf8dbe(0x17a)),dbFileIndexTable=require(_0xaf8dbe(0x143)),dbConfigTable=require(_0xaf8dbe(0x155)),config=require(_0xaf8dbe(0x188)),indexUtil=require('./indexUtil'),nfoUtil=require(_0xaf8dbe(0x185)),indexTableName=dbFileIndexTable[_0xaf8dbe(0x170)],bookIndexUtil={};bookIndexUtil[_0xaf8dbe(0x14e)]=async function(_0x10f2fd,_0x2492fe){return new Promise((_0x3e71bc,_0x217627)=>{const _0x899c09=_0xaf39;sharp(_0x10f2fd,{'failOnError':![]})[_0x899c09(0x183)]({'quality':0x4d})[_0x899c09(0x150)]({'width':0x1f4})[_0x899c09(0x162)]()['then'](_0x4a7239=>{const _0x285b7a=_0x899c09;fs[_0x285b7a(0x136)](_0x2492fe,_0x4a7239,_0x2dd4b8=>{if(_0x2dd4b8)return _0x217627();return _0x3e71bc(_0x2492fe);});})[_0x899c09(0x187)](_0x3a812b=>{const _0x488b10=_0x899c09;return console[_0x488b10(0x151)](_0x488b10(0x12e),_0x3a812b),_0x217627();});});},bookIndexUtil[_0xaf8dbe(0x13b)]=function(_0x3cf754,_0x3c7171,_0xc836de=![]){return new Promise((_0x34e18e,_0x180e6e)=>{const _0x3b96a0=_0xaf39;let _0x2654f1=new Worker(path['resolve'](__dirname,_0x3b96a0(0x16a)),{'workerData':{'indexObj':_0x3cf754,'bookCoverCachePath':_0x3c7171,'onlyGenCover':_0xc836de}}),_0x22b57b=setTimeout(()=>{const _0x415b78=_0x3b96a0;_0x2654f1&&(console[_0x415b78(0x151)](_0x415b78(0x169)),_0x2654f1[_0x415b78(0x16c)](),_0x2654f1=null,_0x180e6e());},0x7530);_0x2654f1['on'](_0x3b96a0(0x138),_0x1bf9f9=>{const _0x4a7af5=_0x3b96a0;_0x1bf9f9[_0x4a7af5(0x133)]==0x0&&(_0x22b57b&&clearTimeout(_0x22b57b),_0x34e18e(_0x1bf9f9));}),_0x2654f1['on'](_0x3b96a0(0x165),_0x53367b=>{const _0x25f253=_0x3b96a0;console[_0x25f253(0x165)](_0x25f253(0x176),_0x53367b),_0x2654f1&&(_0x2654f1[_0x25f253(0x16c)](),_0x2654f1=null),_0x180e6e();}),_0x2654f1['on'](_0x3b96a0(0x137),_0x398e09=>{const _0x50b5ea=_0x3b96a0;if(_0x398e09!==0x0)console[_0x50b5ea(0x165)](_0x50b5ea(0x15a),_0x398e09);else{}});});},bookIndexUtil[_0xaf8dbe(0x173)]=async function(_0x3d41e0,_0x16f95e){const _0x5b3a0f=_0xaf8dbe;let _0x4d41d5=![];if(_0x16f95e[_0x5b3a0f(0x149)]==0x1&&_0x16f95e[_0x5b3a0f(0x154)]&&config['bookTypeList']['includes'](_0x16f95e[_0x5b3a0f(0x154)]['toLowerCase']())){!_0x16f95e['type']&&(_0x16f95e[_0x5b3a0f(0x175)]=bookIndexUtil['getBookType'](_0x16f95e));let _0x53414a=config[_0x5b3a0f(0x17e)](_0x16f95e);try{let _0x418af1=await bookIndexUtil[_0x5b3a0f(0x13b)](_0x16f95e,_0x53414a);if(_0x418af1[_0x5b3a0f(0x15d)])try{let _0x1a42f5=await bookIndexUtil[_0x5b3a0f(0x14e)](_0x418af1[_0x5b3a0f(0x15d)],_0x53414a);_0x1a42f5&&(console[_0x5b3a0f(0x151)]('封面写入成功',_0x1a42f5),_0x418af1[_0x5b3a0f(0x181)]['coverPath']=_0x1a42f5);}catch(_0x10c7c8){console[_0x5b3a0f(0x151)](_0x10c7c8);}return console[_0x5b3a0f(0x151)](_0x5b3a0f(0x146),_0x418af1[_0x5b3a0f(0x181)][_0x5b3a0f(0x157)],_0x418af1[_0x5b3a0f(0x181)]['total_page']),bookIndexUtil['addOriginalDate'](_0x3d41e0,_0x418af1[_0x5b3a0f(0x12f)],_0x418af1[_0x5b3a0f(0x181)]);}catch(_0x386198){return console[_0x5b3a0f(0x151)](_0x5b3a0f(0x15f),_0x386198),bookIndexUtil[_0x5b3a0f(0x186)](_0x3d41e0,_0x4d41d5,_0x16f95e);}}else{if(_0x16f95e[_0x5b3a0f(0x149)]==0x1)return;return bookIndexUtil[_0x5b3a0f(0x186)](_0x3d41e0,_0x4d41d5,_0x16f95e);}},bookIndexUtil[_0xaf8dbe(0x134)]=function(_0x1237c2){const _0x38172e=_0xaf8dbe;let _0x4ddda1=[_0x38172e(0x153),_0x38172e(0x16d),'.rar',_0x38172e(0x135)];return _0x1237c2[_0x38172e(0x154)]&&_0x4ddda1[_0x38172e(0x139)](_0x1237c2[_0x38172e(0x154)][_0x38172e(0x13f)]())?0x2:0x1;},bookIndexUtil[_0xaf8dbe(0x131)]=function(_0x106db6){const _0x6f8067=_0xaf8dbe;let _0x457550=_0x6f8067(0x14d),_0x3ba3a9='UPDATE\x20file_index_book\x20SET\x20type=2\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20in\x20'+_0x457550;_0x106db6[_0x6f8067(0x132)](_0x3ba3a9)[_0x6f8067(0x148)](),_0x3ba3a9='UPDATE\x20file_index_book\x20SET\x20type=1\x20WHERE\x20type\x20=\x20\x27\x27\x20and\x20ext\x20not\x20in\x20'+_0x457550,_0x106db6['prepare'](_0x3ba3a9)[_0x6f8067(0x148)]();},bookIndexUtil['recursionFilesAddIndex']=async function(_0x584246,_0x1b9e50,_0x890517){const _0x47f153=_0xaf8dbe;return await indexUtil[_0x47f153(0x171)](_0x584246,_0x1b9e50,indexTableName,_0x47f153(0x145),_0x890517,bookIndexUtil[_0x47f153(0x168)]);},bookIndexUtil['addFileIndexToDb']=async function(_0x31e01a,_0x103a7f,_0x227507,_0x276ed2,_0x35adba,_0x2152a8){const _0x2de2af=_0xaf8dbe;let _0x311ffb=indexUtil[_0x2de2af(0x14b)](_0x31e01a,_0x2de2af(0x145),config,_0x227507,_0x276ed2);if(!_0x311ffb)return;let _0x3348a3=_0x2152a8[_0x2de2af(0x16e)];_0x2152a8[_0x2de2af(0x156)]<_0x3348a3&&(_0x3348a3=_0x2152a8['mtimeMs']);_0x2152a8[_0x2de2af(0x163)]<_0x3348a3&&(_0x3348a3=_0x2152a8[_0x2de2af(0x163)]);_0x2152a8[_0x2de2af(0x13e)]<_0x3348a3&&(_0x3348a3=_0x2152a8['ctimeMs']);let _0x768c={'path':_0x227507,'filename':_0x276ed2,'is_file':_0x35adba,'ctime':_0x2152a8[_0x2de2af(0x13e)],'mtime':_0x2152a8['mtimeMs'],'ext':path['extname'](_0x276ed2),'birthtime':Math[_0x2de2af(0x14a)](_0x3348a3),'size':_0x2152a8[_0x2de2af(0x141)],'check_time':new Date()[_0x2de2af(0x174)]()};_0x768c=await bookIndexUtil[_0x2de2af(0x173)](_0x103a7f,_0x768c);},bookIndexUtil['dealFileChange']=async function(_0xb27004,_0x3dee8f,_0x1a3081){const _0x608103=_0xaf8dbe;await indexUtil[_0x608103(0x140)](_0xb27004,_0x3dee8f,_0x1a3081,indexTableName,bookIndexUtil['addFileIndexToDb'],bookIndexUtil[_0x608103(0x171)]);return;},bookIndexUtil[_0xaf8dbe(0x186)]=function(_0x2b98ce,_0x3cce34,_0x234190){const _0x47f4fe=_0xaf8dbe;nfoUtil[_0x47f4fe(0x14f)](_0x234190)[_0x47f4fe(0x147)](_0x967107=>{_0x478b38(_0x967107);})[_0x47f4fe(0x187)](_0x3660b9=>{_0x478b38(_0x234190);});function _0x478b38(_0x5aa572){const _0x2ff658=_0x47f4fe;_0x3cce34&&_0x3cce34<config[_0x2ff658(0x152)]&&(_0x3cce34=![]);(!_0x3cce34||_0x3cce34==_0x2ff658(0x14c)||_0x3cce34=='Nan'||_0x3cce34==_0x2ff658(0x14c)||_0x3cce34==_0x2ff658(0x167))&&(_0x3cce34=_0x5aa572[_0x2ff658(0x13c)]||_0x5aa572[_0x2ff658(0x15e)]);let _0x54afbe=new Date(_0x3cce34);_0x5aa572['original_time']=_0x54afbe[_0x2ff658(0x174)]();let _0x41a2bf=_0x54afbe['getFullYear'](),_0x45d389=_0x54afbe['getMonth']()+0x1;_0x45d389=_0x45d389>=0xa?_0x45d389:'0'+_0x45d389;let _0x53c261=_0x54afbe[_0x2ff658(0x158)]();_0x53c261=_0x53c261>=0xa?_0x53c261:'0'+_0x53c261,_0x5aa572[_0x2ff658(0x180)]=_0x41a2bf+'-'+_0x45d389+'-'+_0x53c261;let _0x440276=dbFileIndexTable[_0x2ff658(0x17b)](_0x2b98ce,_0x5aa572,indexTableName);if(_0x440276&&_0x440276[_0x2ff658(0x15c)]){let _0x5ab4cb=dbFileIndexTable[_0x2ff658(0x172)](_0x2b98ce,_0x440276[_0x2ff658(0x15c)],dbFileIndexTable['INDEX_TABLE_NAME_BOOK']);_0x5ab4cb&&bookIndexUtil['dealFirstLetterSingle'](_0x2b98ce,_0x5ab4cb);}}},bookIndexUtil[_0xaf8dbe(0x16f)]=function(_0x31e975){const _0x348ba0=_0xaf8dbe;let _0x1e902f=_0x348ba0(0x160),_0x219d79=_0x31e975[_0x348ba0(0x132)](_0x1e902f)['all']();for(let _0x58363c in _0x219d79){bookIndexUtil['dealFirstLetterSingle'](_0x31e975,_0x219d79[_0x58363c]);}};function _0xaf39(_0x30fbbe,_0x3047ec){const _0x54187e=_0x5418();return _0xaf39=function(_0xaf3929,_0x5956e0){_0xaf3929=_0xaf3929-0x12e;let _0x42b4d0=_0x54187e[_0xaf3929];return _0x42b4d0;},_0xaf39(_0x30fbbe,_0x3047ec);}function isChinese(_0x4512a0){const _0x53f1eb=_0xaf8dbe;var _0x35768a=/[^\\u4e00-\\u9fa5]/;return _0x35768a[_0x53f1eb(0x182)](_0x4512a0);}function _0x5418(){const _0x45758e=['.cbr','birthtimeMs','dealFirstLetterAll','INDEX_TABLE_NAME_BOOK','recursionFilesAddIndex','getById','dealBookInfo','getTime','type','Worker\x20error:','worker_threads','node-pinyin','60234sWPbJo','../../db/dbSourceFolderTable','create','85wWikyK','UPDATE\x20file_index_book\x20set\x20filename_fl=?,artist_fl=?,title_fl=?\x20where\x20id=?','getMediaCoverCachePath','initials','original_date','indexObj','test','jpeg','path','../../utils/nfoUtil','addOriginalDate','catch','../../myConfig/config','716313okWjIe','err1','originalTime','7nbpXSs','setAllBookType','prepare','code','getBookType','.zip','writeFile','exit','message','includes','107060AvSGww','runGetBookInfoWorker','birthtime','2164720qXntPM','ctimeMs','toLowerCase','dealFileChange','size','toUpperCase','../../db/dbFileIndexTable','artist','book','处理成功','then','run','is_file','ceil','doesPathCanAddToDb','NaN','(\x27.cbz\x27,\x27.cbr\x27,\x27.rar\x27,\x27.zip\x27,\x27.CBZ\x27,\x27.CBR\x27,\x27.RAR\x27,\x27.ZIP\x27)','sharpWriteCover','restoreBookNfo','resize','log','exifMinTimeStamp','.cbz','ext','../../db/dbConfigTable','mtimeMs','filename','getDate','26GklHup','Worker\x20stopped\x20with\x20exit\x20code:','18666VCtAvl','lastInsertRowid','coverData','ctime','err\x205','SELECT\x20id,filename,artist,album,title\x20FROM\x20file_index_book\x20WHERE\x20filename_fl\x20is\x20null','title','toBuffer','atimeMs','5863340ygeSrS','error','length','Null','addFileIndexToDb','已超时\x20结束处理worker','bookInfoWorker.js','1538163cSvPgg','terminate'];_0x5418=function(){return _0x45758e;};return _0x5418();}bookIndexUtil['dealFirstLetterSingle']=function(_0x8cd02d,_0x32b796){const _0xa2336d=_0xaf8dbe;function _0xa7ea16(_0x53285e){const _0x178cdf=_0xaf39;if(_0x53285e&&_0x53285e[_0x178cdf(0x166)]>0x0){let _0x5db5f7=_0x53285e[0x0];if(letterList[_0x178cdf(0x139)](_0x5db5f7))return _0x5db5f7;else{if(isChinese(_0x5db5f7)){let _0x20fa9a=pinyin(_0x5db5f7,{'style':_0x178cdf(0x17f)});return _0x20fa9a&&_0x20fa9a['length']>0x0&&_0x20fa9a[0x0]['length']>0x0&&_0x20fa9a[0x0][0x0][_0x178cdf(0x166)]>0x0?_0x20fa9a[0x0][0x0][0x0]:'#';}else return'#';}}else return'';}let _0x588034=_0xa7ea16(_0x32b796[_0xa2336d(0x157)]?_0x32b796['filename'][_0xa2336d(0x142)]():'')[_0xa2336d(0x142)](),_0x227e07=_0xa7ea16(_0x32b796[_0xa2336d(0x144)]?_0x32b796['artist'][_0xa2336d(0x142)]():'')['toUpperCase'](),_0x35f23f=_0xa7ea16(_0x32b796[_0xa2336d(0x161)]?_0x32b796[_0xa2336d(0x161)]['toUpperCase']():'')[_0xa2336d(0x142)]();_0x8cd02d[_0xa2336d(0x132)](_0xa2336d(0x17d))[_0xa2336d(0x148)](_0x588034,_0x227e07,_0x35f23f,_0x32b796['id']);},module['exports']=bookIndexUtil;