const _0x462788=_0x48a2;function _0x5ce9(){const _0x23e277=['getDate','create','dealFileChange','/BDMV/STREAM','1164xBjjwM','dealMediaInfo','height','needDealTvDrama','format','ceil','ffprobeSync','stringify','addFileIndexToDb','getFilenameNumber','1180eUSvdD','substring','push','exifMinTimeStamp','is_file','videoTypeList','location','1170696EiYkPv','\x5cBDMV\x5cSTREAM','ext','doesPathCanAddToDb','getDurationFromStream','getMonth','addFinalIndexToDB','width','rawImgTypeList','10623213CchtUq','show_in_list','location-eng','filename','size','com.apple.quicktime.creationdate','path','../../utils/exifUtils','UPDATE\x20file_index_movie\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SET\x20show_in_list\x20=\x201\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20id\x20IN\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20t1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20file_index_movie\x20t1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INNER\x20JOIN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20path,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20min(filename)\x20AS\x20filename\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20file_index_movie\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20is_tvplay\x20=\x201\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20is_file\x20=\x201\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x20=\x202\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20GROUP\x20BY\x20path\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t2\x20ON\x20t1.path\x20=\x20t2.path\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t1.filename\x20=\x20t2.filename\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20);','../../myConfig/config','videoHeight','original_date','INDEX_TABLE_NAME_MOVIE','originalTime','UPDATE\x20','recursionFilesAddIndex','creation_time','2KcTvQd','mode','type','297842AiIpSw','media_type','tags','duration','longitude','is_tvplay','getExifInfo','2158941SEtMGt','latitude','birthtime','run','./indexUtil','\x20SET\x20show_in_list\x20=\x200\x20WHERE\x20path=?','addOriginalDate','toLowerCase','filenameNumber','影音管理：设置电视剧状态出错','videoWidth','length','tvplay','350707qFFHmE','dealTvDrama','basename','mtimeMs','\x5cbdmv\x5cstream','getTime','/bdmv/stream','com.apple.quicktime.model','endsWith','replace','imgTypeList','ctimeMs','includes','ctime','stream_info','streams','571776QUzWCz','transaction','atimeMs','prepare','UPDATE\x20file_index_movie\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SET\x20show_in_list\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20is_tvplay\x20=\x201\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20is_file\x20=\x201\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x20=\x202\x20AND\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20show_in_list\x20=\x201;'];_0x5ce9=function(){return _0x23e277;};return _0x5ce9();}(function(_0x56eadb,_0x36ae2b){const _0x32bd04=_0x48a2,_0x1bd4d2=_0x56eadb();while(!![]){try{const _0x13f25a=-parseInt(_0x32bd04(0x11b))/0x1*(-parseInt(_0x32bd04(0x11e))/0x2)+-parseInt(_0x32bd04(0x125))/0x3+-parseInt(_0x32bd04(0x101))/0x4+-parseInt(_0x32bd04(0xfa))/0x5*(parseInt(_0x32bd04(0xf0))/0x6)+parseInt(_0x32bd04(0x132))/0x7+-parseInt(_0x32bd04(0xe7))/0x8+parseInt(_0x32bd04(0x10a))/0x9;if(_0x13f25a===_0x36ae2b)break;else _0x1bd4d2['push'](_0x1bd4d2['shift']());}catch(_0x3fd906){_0x1bd4d2['push'](_0x1bd4d2['shift']());}}}(_0x5ce9,0x61583));const path=require(_0x462788(0x110)),dbFileIndexTable=require('../../db/dbFileIndexTable'),config=require(_0x462788(0x113)),exifUtil=require(_0x462788(0x111)),videoStreamUtil=require('../../utils/videoStreamUtil'),indexUtil=require(_0x462788(0x129)),movieUtil=require('../../express-server/utils/movieUtil'),indexTableName=dbFileIndexTable[_0x462788(0x116)],movieIndexUtil={};movieIndexUtil[_0x462788(0xf3)]=!![];let lastDealTvDramaTimestamp=0x0;function _0x48a2(_0x528395,_0x2cf2b7){const _0x5ce97b=_0x5ce9();return _0x48a2=function(_0x48a28a,_0x189851){_0x48a28a=_0x48a28a-0xd9;let _0x5254c5=_0x5ce97b[_0x48a28a];return _0x5254c5;},_0x48a2(_0x528395,_0x2cf2b7);}movieIndexUtil[_0x462788(0xee)]=async function(_0x5d6ab9,_0x3194ae,_0x264744){await indexUtil['dealFileChange'](_0x5d6ab9,_0x3194ae,_0x264744,indexTableName,movieIndexUtil['addFileIndexToDb'],movieIndexUtil['recursionFilesAddIndex']);return;},movieIndexUtil[_0x462788(0x119)]=async function(_0x302b51,_0x3d5408,_0x255962){const _0x1305cf=_0x462788;return await indexUtil[_0x1305cf(0x119)](_0x302b51,_0x3d5408,indexTableName,'movie',_0x255962,movieIndexUtil['addFileIndexToDb'],()=>{const _0x2ba209=_0x1305cf;let _0x53915b=new Date()['getTime']()-lastDealTvDramaTimestamp;movieIndexUtil[_0x2ba209(0xf3)]&&_0x53915b>0x1d4c0&&(movieIndexUtil['dealTvDrama'](_0x3d5408),lastDealTvDramaTimestamp=new Date()[_0x2ba209(0xdc)]());});},movieIndexUtil[_0x462788(0xf8)]=async function(_0x4a66b9,_0xe0a196,_0x17ffbb,_0x1d26ab,_0xf55d20,_0x4e87be){const _0xb8605b=_0x462788;let _0xc3f993={'path':_0x17ffbb,'filename':_0x1d26ab,'is_file':_0xf55d20},_0x55647e=indexUtil[_0xb8605b(0x104)](_0x4a66b9,'movie',config,_0x17ffbb,_0x1d26ab);if(!_0x55647e)return;_0x55647e[_0xb8605b(0x11f)]==_0xb8605b(0x131)&&(_0xc3f993[_0xb8605b(0x123)]=0x1,_0xc3f993[_0xb8605b(0x10b)]=0x0);let _0x469e9b=_0x4e87be['birthtimeMs'];_0x4e87be[_0xb8605b(0xda)]<_0x469e9b&&(_0x469e9b=_0x4e87be[_0xb8605b(0xda)]),_0x4e87be[_0xb8605b(0xe9)]<_0x469e9b&&(_0x469e9b=_0x4e87be[_0xb8605b(0xe9)]),_0x4e87be[_0xb8605b(0xe2)]<_0x469e9b&&(_0x469e9b=_0x4e87be['ctimeMs']),_0xc3f993={..._0xc3f993,'ctime':_0x4e87be[_0xb8605b(0xe2)],'mtime':_0x4e87be[_0xb8605b(0xda)],'ext':path['extname'](_0x1d26ab),'birthtime':Math[_0xb8605b(0xf5)](_0x469e9b),'size':_0x4e87be[_0xb8605b(0x10e)],'check_time':new Date()['getTime']()},_0xc3f993=await movieIndexUtil[_0xb8605b(0xf1)](_0xe0a196,_0xc3f993);},movieIndexUtil['dealMediaInfo']=async function(_0x385bb1,_0x1539dd){const _0x2e4f2b=_0x462788;let _0x419dbe=![],_0x381d81=path['join'](_0x1539dd[_0x2e4f2b(0x110)],_0x1539dd[_0x2e4f2b(0x10d)]);if(_0x1539dd[_0x2e4f2b(0xfe)]==0x1&&_0x1539dd['ext']&&(config[_0x2e4f2b(0xe1)][_0x2e4f2b(0xe3)](_0x1539dd[_0x2e4f2b(0x103)][_0x2e4f2b(0x12c)]())||config[_0x2e4f2b(0x109)][_0x2e4f2b(0xe3)](_0x1539dd['ext']['toLowerCase']()))){_0x1539dd[_0x2e4f2b(0x11d)]=0x1;try{let {tags:_0x9a95d6,dealedIndexObj:_0x3ba128}=await exifUtil[_0x2e4f2b(0x124)](_0x381d81,_0x1539dd);return movieIndexUtil[_0x2e4f2b(0x12b)](_0x385bb1,_0x3ba128[_0x2e4f2b(0x117)],_0x3ba128);}catch(_0x1b063e){return movieIndexUtil[_0x2e4f2b(0x12b)](_0x385bb1,_0x419dbe,_0x1539dd);}}else{if(_0x1539dd[_0x2e4f2b(0xfe)]==0x1&&_0x1539dd[_0x2e4f2b(0x103)]&&config[_0x2e4f2b(0xff)]['includes'](_0x1539dd[_0x2e4f2b(0x103)][_0x2e4f2b(0x12c)]())){_0x1539dd[_0x2e4f2b(0x11d)]=0x2;try{let _0x5e4054=await indexUtil[_0x2e4f2b(0xf6)](_0x381d81),_0x19d57f=0x0,_0x2dc037=0x0;if(_0x5e4054&&_0x5e4054[_0x2e4f2b(0xe6)]&&_0x5e4054[_0x2e4f2b(0xe6)][_0x2e4f2b(0x130)]>0x0){_0x1539dd[_0x2e4f2b(0xe5)]=JSON[_0x2e4f2b(0xf7)](_0x5e4054[_0x2e4f2b(0xe6)]);let _0x4d6fcb=videoStreamUtil['parseVideoWH'](_0x5e4054[_0x2e4f2b(0xe6)]);_0x1539dd[_0x2e4f2b(0x108)]=_0x4d6fcb[_0x2e4f2b(0x12f)],_0x1539dd[_0x2e4f2b(0xf2)]=_0x4d6fcb[_0x2e4f2b(0x114)];let _0x4314b4=videoStreamUtil[_0x2e4f2b(0x105)](_0x5e4054);_0x4314b4&&(_0x1539dd[_0x2e4f2b(0x121)]=_0x4314b4);}if(_0x5e4054&&_0x5e4054[_0x2e4f2b(0xf4)]&&_0x5e4054['format']['tags']){let _0x1d0f9d=_0x5e4054[_0x2e4f2b(0xf4)][_0x2e4f2b(0x120)]['com.apple.quicktime.location.ISO6709'],_0x4081e0=_0x5e4054['format']['tags'][_0x2e4f2b(0xde)],_0x2f02f3=_0x5e4054['format']['tags'][_0x2e4f2b(0x10f)];_0x4081e0&&(_0x1539dd[_0x2e4f2b(0x11c)]=_0x4081e0);_0x2f02f3&&(_0x419dbe=_0x2f02f3);!_0x419dbe&&_0x5e4054[_0x2e4f2b(0xf4)]['tags']['creation_time']&&(_0x419dbe=_0x5e4054['format'][_0x2e4f2b(0x120)][_0x2e4f2b(0x11a)]);function _0x529a39(_0x55f33d){const _0x509116=_0x2e4f2b;let _0x18de6a=[];for(let _0xa4a506=0x0;_0xa4a506<_0x55f33d['length'];_0xa4a506++){(_0x55f33d[_0xa4a506]=='+'||_0x55f33d[_0xa4a506]=='-')&&_0x18de6a[_0x509116(0xfc)](_0xa4a506);}if(_0x18de6a[_0x509116(0x130)]==0x2)_0x19d57f=_0x55f33d[_0x509116(0xfb)](_0x18de6a[0x0],_0x18de6a[0x1]),_0x2dc037=_0x55f33d[_0x509116(0xfb)](_0x18de6a[0x1]);else _0x18de6a['length']>=0x3&&(_0x19d57f=_0x55f33d[_0x509116(0xfb)](_0x18de6a[0x0],_0x18de6a[0x1]),_0x2dc037=_0x55f33d[_0x509116(0xfb)](_0x18de6a[0x1],_0x18de6a[0x2]));}_0x1d0f9d&&_0x529a39(_0x1d0f9d);let _0x3a6b09=_0x5e4054[_0x2e4f2b(0xf4)][_0x2e4f2b(0x120)][_0x2e4f2b(0x100)]||_0x5e4054[_0x2e4f2b(0xf4)][_0x2e4f2b(0x120)][_0x2e4f2b(0x10c)];_0x3a6b09&&!_0x19d57f&&(_0x3a6b09=_0x3a6b09[_0x2e4f2b(0xe0)]('/',''),_0x529a39(_0x3a6b09)),_0x5e4054['format'][_0x2e4f2b(0x121)]&&(_0x1539dd[_0x2e4f2b(0x121)]=_0x5e4054[_0x2e4f2b(0xf4)][_0x2e4f2b(0x121)]);}return _0x1539dd[_0x2e4f2b(0x126)]=_0x19d57f,_0x1539dd[_0x2e4f2b(0x122)]=_0x2dc037,movieIndexUtil[_0x2e4f2b(0x12b)](_0x385bb1,_0x419dbe,_0x1539dd);}catch(_0xc1e000){return movieIndexUtil[_0x2e4f2b(0x12b)](_0x385bb1,_0x419dbe,_0x1539dd);}}else{if(_0x1539dd[_0x2e4f2b(0xfe)]==0x1)return;return movieIndexUtil[_0x2e4f2b(0x12b)](_0x385bb1,_0x419dbe,_0x1539dd);}}},movieIndexUtil[_0x462788(0x12b)]=function(_0x3501e4,_0x1fac0d,_0x2d7889){const _0x4a3db9=_0x462788;_0x1fac0d&&_0x1fac0d<config[_0x4a3db9(0xfd)]&&(_0x1fac0d=![]);!_0x1fac0d&&(_0x1fac0d=_0x2d7889[_0x4a3db9(0x127)]||_0x2d7889[_0x4a3db9(0xe4)]);let _0x9c0fac=new Date(_0x1fac0d);_0x2d7889['original_time']=_0x9c0fac[_0x4a3db9(0xdc)]();let _0x2516d2=_0x9c0fac['getFullYear'](),_0x304265=_0x9c0fac[_0x4a3db9(0x106)]()+0x1;_0x304265=_0x304265>=0xa?_0x304265:'0'+_0x304265;let _0x465c60=_0x9c0fac[_0x4a3db9(0xec)]();_0x465c60=_0x465c60>=0xa?_0x465c60:'0'+_0x465c60,_0x2d7889[_0x4a3db9(0x115)]=_0x2516d2+'-'+_0x304265+'-'+_0x465c60,movieIndexUtil[_0x4a3db9(0x107)](_0x3501e4,_0x2d7889);},movieIndexUtil['addFinalIndexToDB']=function(_0x1411d5,_0x558c48){const _0x1de5e5=_0x462788;_0x558c48[_0x1de5e5(0x123)]==0x1&&_0x558c48[_0x1de5e5(0x11d)]==0x2&&(movieIndexUtil[_0x1de5e5(0xf3)]=!![]);_0x558c48[_0x1de5e5(0x12d)]=movieUtil[_0x1de5e5(0xf9)](_0x558c48[_0x1de5e5(0x10d)]);let _0x2f8914=dbFileIndexTable[_0x1de5e5(0xed)](_0x1411d5,_0x558c48,indexTableName),_0x1f8464=_0x558c48['path'][_0x1de5e5(0x12c)]();try{if(_0x1f8464[_0x1de5e5(0xdf)](_0x1de5e5(0xdb))||_0x1f8464[_0x1de5e5(0xdf)](_0x1de5e5(0xdd))){_0x1411d5[_0x1de5e5(0xea)]('UPDATE\x20'+indexTableName+_0x1de5e5(0x12a))[_0x1de5e5(0x128)](_0x558c48[_0x1de5e5(0x110)]);let _0x8f0fda=_0x558c48[_0x1de5e5(0x110)]['replace'](_0x1de5e5(0xdb),'')[_0x1de5e5(0xe0)]('/bdmv/stream','')['replace'](_0x1de5e5(0x102),'')[_0x1de5e5(0xe0)](_0x1de5e5(0xef),'');_0x8f0fda=path[_0x1de5e5(0xd9)](_0x8f0fda),_0x1411d5[_0x1de5e5(0xea)](_0x1de5e5(0x118)+indexTableName+'\x20as\x20t\x20SET\x20show_in_list\x20=\x201,show_name=?\x20WHERE\x20path=?\x20AND\x20duration>1800')['run'](_0x8f0fda,_0x558c48[_0x1de5e5(0x110)]);}}catch(_0x2ef8b2){}let _0xb96f9d=dbFileIndexTable['getById'](_0x1411d5,_0x2f8914['lastInsertRowid'],indexTableName);_0xb96f9d&&movieUtil['dealFirstLetterSingle'](_0x1411d5,_0xb96f9d);};let tvDramaIsDealing=![];movieIndexUtil[_0x462788(0x133)]=function(_0x1220ae){const _0x23bf3b=_0x462788;if(!movieIndexUtil['needDealTvDrama'])return;if(tvDramaIsDealing)return;tvDramaIsDealing=!![];let _0x3178ff=new Date()['getTime']();try{let _0x466486=_0x23bf3b(0xeb),_0x10f621=_0x23bf3b(0x112),_0xe06d38=_0x1220ae[_0x23bf3b(0xe8)](()=>{const _0x31c178=_0x23bf3b;_0x1220ae[_0x31c178(0xea)](_0x466486)[_0x31c178(0x128)](),_0x1220ae['prepare'](_0x10f621)[_0x31c178(0x128)]();}),_0x49edae=new Date()[_0x23bf3b(0xdc)]();_0xe06d38(),console['log']('影音管理：电视剧状态处理完成,耗时:',(_0x49edae-_0x3178ff)/0x3e8+'s');}catch(_0x273a33){console['log'](_0x23bf3b(0x12e),_0x273a33);}tvDramaIsDealing=![],movieIndexUtil[_0x23bf3b(0xf3)]=![];},module['exports']=movieIndexUtil;