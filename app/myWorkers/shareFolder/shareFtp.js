const _0x3f8170=_0x495a;(function(_0x32eafa,_0x3c9ed9){const _0x281699=_0x495a,_0x494dc4=_0x32eafa();while(!![]){try{const _0x50c146=-parseInt(_0x281699(0x15e))/0x1*(parseInt(_0x281699(0x161))/0x2)+parseInt(_0x281699(0x182))/0x3+-parseInt(_0x281699(0x162))/0x4+-parseInt(_0x281699(0x168))/0x5*(-parseInt(_0x281699(0x163))/0x6)+parseInt(_0x281699(0x158))/0x7*(parseInt(_0x281699(0x157))/0x8)+-parseInt(_0x281699(0x187))/0x9+parseInt(_0x281699(0x167))/0xa;if(_0x50c146===_0x3c9ed9)break;else _0x494dc4['push'](_0x494dc4['shift']());}catch(_0x443ba9){_0x494dc4['push'](_0x494dc4['shift']());}}}(_0x5582,0x587d9));const config=require(_0x3f8170(0x180)),Database=require(_0x3f8170(0x170));let dbOther=new Database(config[_0x3f8170(0x155)],{});dbOther[_0x3f8170(0x171)](_0x3f8170(0x16f));const dbConfigTable=require(_0x3f8170(0x17e)),dbFileShare=require('../../db/dbFileShare'),dbUserTable=require('../../db/dbUserTable'),FtpSrv=require(_0x3f8170(0x177));process[_0x3f8170(0x181)]='NasCabFtpWorker';let cryptoUtils=require(_0x3f8170(0x15a)),myFtpServer=null;const dbNoticeCenterTable=require('../../db/dbNoticeCenterTable');function _0x495a(_0x5f46ea,_0x1ed55){const _0x55823c=_0x5582();return _0x495a=function(_0x495ad0,_0x1a92b9){_0x495ad0=_0x495ad0-0x155;let _0x31ce01=_0x55823c[_0x495ad0];return _0x31ce01;},_0x495a(_0x5f46ea,_0x1ed55);}function _0x5582(){const _0x4a1fd2=['create','2tHwHns','shareType','findByTitle','201736KlETfJ','919984qztCEW','612ofytHp','FTP\x20start\x20running\x20on\x20:','../../express-server/utils/netUtils','encryptString','4881570NqBsfS','4390YzoeNX','closed','close','FTP\x20Start\x20failed','stringify','error','Invalid\x20username\x20or\x20password','journal_mode\x20=\x20WAL','better-sqlite3','pragma','path','GeneralError','Restart\x20FTP','isPortFree','getAllByWhere','ftp-srv','FTPServer','then','catch','log','value','type','../../db/dbConfigTable','login','../../myConfig/config','title','860265WowyYN','FTP','run','listen','length','1902339CIcZLx','stop','dbOther','FTPPort','112bnZRqv','70546HyBEBn','passwordKey','../../express-server/utils/cryptoUtils','code','\x20server_type=\x27FTP\x27'];_0x5582=function(){return _0x4a1fd2;};return _0x5582();}let netUtils=require(_0x3f8170(0x165));function saveMsg(_0x5934ce,_0xde03fa,_0x3fda27){const _0x534574=_0x3f8170;dbNoticeCenterTable[_0x534574(0x15d)](dbOther,{'title':_0x5934ce,'level':_0xde03fa,'content':_0x3fda27});}function ftpListenNew(_0x25f97d){const _0x2415d0=_0x3f8170;myFtpServer=new FtpSrv({'url':'ftp://0.0.0.0:'+_0x25f97d});let _0x2d9583=dbFileShare[_0x2415d0(0x176)](dbOther,_0x2415d0(0x15c),[]);_0x2d9583&&_0x2d9583[_0x2415d0(0x186)]>0x0?(myFtpServer['on'](_0x2415d0(0x17f),({connection:_0xaa6904,username:_0x8e3c01,password:_0x3683c7},_0x4587b4,_0x31fa1f)=>{const _0x3d1420=_0x2415d0;cryptoUtils[_0x3d1420(0x166)](config[_0x3d1420(0x159)],_0x3683c7)[_0x3d1420(0x179)](_0xa94720=>{const _0x2ea0b4=_0x3d1420;let _0x17a2d8=dbUserTable[_0x2ea0b4(0x17f)](dbOther,_0x8e3c01,_0xa94720);if(!_0x17a2d8)return _0x31fa1f(new errors[(_0x2ea0b4(0x173))](_0x2ea0b4(0x16e),0x191));let _0xdfb88b=dbFileShare['userHasFtp'](dbOther,_0x17a2d8['id'],_0x2ea0b4(0x183));return _0xdfb88b?_0x4587b4({'root':_0xdfb88b[_0x2ea0b4(0x172)]}):_0x31fa1f(0x191);})[_0x3d1420(0x17a)](_0x505a59=>{const _0x5b27bc=_0x3d1420;return console['log'](_0x5b27bc(0x16d),_0x505a59),_0x31fa1f(0x191);});}),myFtpServer[_0x2415d0(0x185)]()[_0x2415d0(0x179)](()=>{const _0x2a38dd=_0x2415d0;console[_0x2a38dd(0x17b)](_0x2a38dd(0x164)+_0x25f97d),dbConfigTable[_0x2a38dd(0x15d)](dbOther,{'title':'FTPServer','value':JSON[_0x2a38dd(0x16c)]({'state':_0x2a38dd(0x184),'port':_0x25f97d})});})[_0x2415d0(0x17a)](_0x4647c4=>{const _0x32809b=_0x2415d0;console[_0x32809b(0x17b)](_0x32809b(0x16d),_0x4647c4),_0x4647c4[_0x32809b(0x15b)]=='EADDRINUSE'?initFtpShare(_0x25f97d+0x1):(dbConfigTable[_0x32809b(0x15d)](dbOther,{'title':'FTPServer','value':JSON[_0x32809b(0x16c)]({'state':_0x32809b(0x188),'port':_0x25f97d})}),saveMsg(_0x32809b(0x16b),_0x32809b(0x16d),_0x4647c4[_0x32809b(0x15b)]));})):dbConfigTable[_0x2415d0(0x15d)](dbOther,{'title':_0x2415d0(0x178),'value':JSON[_0x2415d0(0x16c)]({'state':_0x2415d0(0x188),'port':_0x25f97d})});}async function initFtpShare(_0x1622e4){const _0x3657d0=_0x3f8170;myFtpServer?(myFtpServer[_0x3657d0(0x16a)](),myFtpServer['on'](_0x3657d0(0x169),({})=>{ftpListenNew(_0x1622e4);})):ftpListenNew(_0x1622e4);}let getFreePort=function(_0x26a638,_0x395200){const _0x1a7a1e=_0x3f8170;netUtils[_0x1a7a1e(0x175)](_0x26a638)[_0x1a7a1e(0x179)](_0x4717b1=>{_0x4717b1?_0x395200(_0x26a638):(_0x26a638+=0x1,getFreePort(_0x26a638,_0x395200));});};function getFtpSetPort(_0x404ce5){const _0x1e37f9=_0x3f8170;let _0x29b1d1=config[_0x1e37f9(0x156)],_0x47b342='FTPPort',_0x3baf22=dbConfigTable[_0x1e37f9(0x160)](dbOther,_0x47b342);if(_0x3baf22){let _0x1e2232=parseInt(_0x3baf22[_0x1e37f9(0x17c)]);if(_0x1e2232<=0x0||_0x1e2232>0xffff){}else _0x29b1d1=_0x1e2232;}getFreePort(_0x29b1d1,_0x404ce5);}process['on']('message',_0x43a5c9=>{const _0x263bfa=_0x3f8170;if(_0x43a5c9['type']=='fileShareRestart'&&_0x43a5c9[_0x263bfa(0x15f)]==_0x263bfa(0x183))console[_0x263bfa(0x17b)](_0x263bfa(0x174)),getFtpSetPort(_0x1befda=>{initFtpShare(_0x1befda);});else _0x43a5c9[_0x263bfa(0x17d)]=='close'&&(myFtpServer&&myFtpServer[_0x263bfa(0x16a)]());}),getFtpSetPort(_0x27c109=>{initFtpShare(_0x27c109);});