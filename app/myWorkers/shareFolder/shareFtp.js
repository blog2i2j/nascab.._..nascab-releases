const _0x409411=_0x2d14;function _0x2ba6(){const _0x43a212=['login','3614YWotYm','\x20server_type=\x27FTP\x27','14542578Dgdyar','../../db/dbConfigTable','fileShareRestart','GeneralError','3749135csbiQn','FTP\x20start\x20running\x20on\x20:','error','type','then','../../db/dbFileShare','548160CGqfeu','625740SJkZyJ','userHasFtp','run','stop','passwordKey','Restart\x20FTP','ftp-srv','pragma','getAllByWhere','stringify','FTP\x20Start\x20failed','code','../../db/dbUserTable','closed','create','FTP','listen','1245773eMdmOv','title','catch','../../db/dbNoticeCenterTable','value','539216pzcwmi','Invalid\x20username\x20or\x20password','close','1011OMYqOI','../../myConfig/config','EADDRINUSE','FTPPort','log','119USOZGt'];_0x2ba6=function(){return _0x43a212;};return _0x2ba6();}(function(_0x440043,_0x4ef7f2){const _0x2eae5a=_0x2d14,_0x22763e=_0x440043();while(!![]){try{const _0x3e2b47=parseInt(_0x2eae5a(0x18a))/0x1+parseInt(_0x2eae5a(0x199))/0x2*(-parseInt(_0x2eae5a(0x192))/0x3)+-parseInt(_0x2eae5a(0x179))/0x4+parseInt(_0x2eae5a(0x172))/0x5+-parseInt(_0x2eae5a(0x178))/0x6+-parseInt(_0x2eae5a(0x197))/0x7*(-parseInt(_0x2eae5a(0x18f))/0x8)+-parseInt(_0x2eae5a(0x19b))/0x9;if(_0x3e2b47===_0x4ef7f2)break;else _0x22763e['push'](_0x22763e['shift']());}catch(_0x18dc9a){_0x22763e['push'](_0x22763e['shift']());}}}(_0x2ba6,0xa34a6));const config=require(_0x409411(0x193)),Database=require('better-sqlite3');let dbOther=new Database(config['dbOther'],{});dbOther[_0x409411(0x180)]('journal_mode\x20=\x20WAL');const dbConfigTable=require(_0x409411(0x19c)),dbFileShare=require(_0x409411(0x177)),dbUserTable=require(_0x409411(0x185)),FtpSrv=require(_0x409411(0x17f));process[_0x409411(0x18b)]='NasCabFtpWorker';let cryptoUtils=require('../../express-server/utils/cryptoUtils'),myFtpServer=null;const dbNoticeCenterTable=require(_0x409411(0x18d));let netUtils=require('../../express-server/utils/netUtils');function _0x2d14(_0x4bf48a,_0x5c983c){const _0x2ba66b=_0x2ba6();return _0x2d14=function(_0x2d14b8,_0x4f58fa){_0x2d14b8=_0x2d14b8-0x172;let _0x3e0648=_0x2ba66b[_0x2d14b8];return _0x3e0648;},_0x2d14(_0x4bf48a,_0x5c983c);}function saveMsg(_0x1ac21c,_0x55ef48,_0x387f28){const _0xadd32=_0x409411;dbNoticeCenterTable[_0xadd32(0x187)](dbOther,{'title':_0x1ac21c,'level':_0x55ef48,'content':_0x387f28});}function ftpListenNew(_0x2e8339){const _0x35b326=_0x409411;myFtpServer=new FtpSrv({'url':'ftp://0.0.0.0:'+_0x2e8339});let _0x4a2934=dbFileShare[_0x35b326(0x181)](dbOther,_0x35b326(0x19a),[]);_0x4a2934&&_0x4a2934['length']>0x0?(myFtpServer['on'](_0x35b326(0x198),({connection:_0x3cf4ee,username:_0x583c39,password:_0x5b74ec},_0x50bdb4,_0x4cd685)=>{const _0x2a02fc=_0x35b326;cryptoUtils['encryptString'](config[_0x2a02fc(0x17d)],_0x5b74ec)[_0x2a02fc(0x176)](_0x5866db=>{const _0x54a31b=_0x2a02fc;let _0x3c86d3=dbUserTable[_0x54a31b(0x198)](dbOther,_0x583c39,_0x5866db);if(!_0x3c86d3)return _0x4cd685(new errors[(_0x54a31b(0x19e))](_0x54a31b(0x190),0x191));let _0xd339c8=dbFileShare[_0x54a31b(0x17a)](dbOther,_0x3c86d3['id'],_0x54a31b(0x188));return _0xd339c8?_0x50bdb4({'root':_0xd339c8['path']}):_0x4cd685(0x191);})['catch'](_0x2a6970=>{const _0x25bbf5=_0x2a02fc;return console[_0x25bbf5(0x196)](_0x25bbf5(0x174),_0x2a6970),_0x4cd685(0x191);});}),myFtpServer[_0x35b326(0x189)]()[_0x35b326(0x176)](()=>{const _0x4f72a3=_0x35b326;console[_0x4f72a3(0x196)](_0x4f72a3(0x173)+_0x2e8339),dbConfigTable[_0x4f72a3(0x187)](dbOther,{'title':'FTPServer','value':JSON[_0x4f72a3(0x182)]({'state':_0x4f72a3(0x17b),'port':_0x2e8339})});})[_0x35b326(0x18c)](_0x41900a=>{const _0x443ab3=_0x35b326;console['log'](_0x443ab3(0x174),_0x41900a),_0x41900a[_0x443ab3(0x184)]==_0x443ab3(0x194)?initFtpShare(_0x2e8339+0x1):(dbConfigTable[_0x443ab3(0x187)](dbOther,{'title':'FTPServer','value':JSON[_0x443ab3(0x182)]({'state':_0x443ab3(0x17c),'port':_0x2e8339})}),saveMsg(_0x443ab3(0x183),_0x443ab3(0x174),_0x41900a[_0x443ab3(0x184)]));})):dbConfigTable[_0x35b326(0x187)](dbOther,{'title':'FTPServer','value':JSON[_0x35b326(0x182)]({'state':'stop','port':_0x2e8339})});}async function initFtpShare(_0x5b54ce){const _0x1114fc=_0x409411;myFtpServer?(myFtpServer[_0x1114fc(0x191)](),myFtpServer['on'](_0x1114fc(0x186),({})=>{ftpListenNew(_0x5b54ce);})):ftpListenNew(_0x5b54ce);}let getFreePort=function(_0x5c6337,_0x499da1){const _0x32cfc4=_0x409411;netUtils['isPortFree'](_0x5c6337)[_0x32cfc4(0x176)](_0x5c44c4=>{_0x5c44c4?_0x499da1(_0x5c6337):(_0x5c6337+=0x1,getFreePort(_0x5c6337,_0x499da1));});};function getFtpSetPort(_0x402385){const _0x206877=_0x409411;let _0x157962=config['FTPPort'],_0x17d61e=_0x206877(0x195),_0x52f38a=dbConfigTable['findByTitle'](dbOther,_0x17d61e);if(_0x52f38a){let _0x3698ad=parseInt(_0x52f38a[_0x206877(0x18e)]);if(_0x3698ad<=0x0||_0x3698ad>0xffff){}else _0x157962=_0x3698ad;}getFreePort(_0x157962,_0x402385);}process['on']('message',_0x26f6e7=>{const _0x497d0d=_0x409411;if(_0x26f6e7[_0x497d0d(0x175)]==_0x497d0d(0x19d)&&_0x26f6e7['shareType']==_0x497d0d(0x188))console[_0x497d0d(0x196)](_0x497d0d(0x17e)),getFtpSetPort(_0x596531=>{initFtpShare(_0x596531);});else _0x26f6e7[_0x497d0d(0x175)]==_0x497d0d(0x191)&&(myFtpServer&&myFtpServer[_0x497d0d(0x191)]());}),getFtpSetPort(_0x2f4139=>{initFtpShare(_0x2f4139);});