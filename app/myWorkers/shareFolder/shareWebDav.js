const _0x583373=_0x26c6;(function(_0x2f9541,_0x428c08){const _0x312a5c=_0x26c6,_0x3f7884=_0x2f9541();while(!![]){try{const _0x4d963a=parseInt(_0x312a5c(0xe3))/0x1*(-parseInt(_0x312a5c(0x10a))/0x2)+-parseInt(_0x312a5c(0xba))/0x3+-parseInt(_0x312a5c(0xd6))/0x4+-parseInt(_0x312a5c(0xe2))/0x5*(-parseInt(_0x312a5c(0x109))/0x6)+-parseInt(_0x312a5c(0xd1))/0x7+-parseInt(_0x312a5c(0x106))/0x8*(-parseInt(_0x312a5c(0x103))/0x9)+-parseInt(_0x312a5c(0xf9))/0xa*(-parseInt(_0x312a5c(0xeb))/0xb);if(_0x4d963a===_0x428c08)break;else _0x3f7884['push'](_0x3f7884['shift']());}catch(_0x17f2dc){_0x3f7884['push'](_0x3f7884['shift']());}}}(_0x1489,0x5191e));let webdav=require(_0x583373(0xcc))['v2'],express=require('express');const config=require(_0x583373(0xfd)),path=require(_0x583373(0xf5)),fs=require('fs'),Database=require(_0x583373(0xcb));let dbOther=new Database(config['dbOther'],{});process['title']='NasCabWebDavWorker',dbOther[_0x583373(0xdd)](_0x583373(0xf2));let dbConfigTable=require(_0x583373(0xd7)),dbFileShare=require(_0x583373(0xd4)),dbUserTable=require(_0x583373(0xbd)),cryptoUtils=require(_0x583373(0xd5)),app=null,myWebDavServer=null,userManager=new webdav[(_0x583373(0xdf))](),privilegeManager=new webdav[(_0x583373(0xb4))](),dbNoticeCenterTable=require('../../db/dbNoticeCenterTable'),netUtils=require('../../express-server/utils/netUtils');const messageUtil=require(_0x583373(0xfa));let httpsServer;const https=require('https');let tls=require('tls');function testCertAndKeyMatch(_0x3d972d,_0xa85a2){const _0x2e02fb=_0x583373;try{return tls[_0x2e02fb(0xd3)]({'cert':_0x3d972d,'key':_0xa85a2}),!![];}catch(_0x4e8fc4){return![];}}function saveMsg(_0x1512a1,_0xacc0ab,_0x3b2d98){dbNoticeCenterTable['create'](dbOther,{'title':_0x1512a1,'level':_0xacc0ab,'content':_0x3b2d98});}let getFreePort=function(_0x5c36c0,_0x33bb46){const _0x24b8a7=_0x583373;netUtils[_0x24b8a7(0xb7)](_0x5c36c0)[_0x24b8a7(0xf8)](_0x4bf862=>{_0x4bf862?_0x33bb46(_0x5c36c0):(_0x5c36c0=parseInt(_0x5c36c0)+0x1,getFreePort(_0x5c36c0,_0x33bb46));})['catch'](_0x287207=>{const _0x3d1949=_0x24b8a7;console[_0x3d1949(0xc8)](_0x287207),_0x33bb46(_0x5c36c0);});};async function startHttps(_0x261265){const _0x1ab97b=_0x583373;try{let _0x51b70a=config[_0x1ab97b(0xe5)],_0x15b17d=dbConfigTable['findByTitle'](dbOther,_0x1ab97b(0xe5));_0x15b17d&&_0x15b17d[_0x1ab97b(0xd2)]&&_0x15b17d[_0x1ab97b(0xd2)]>0x0&&_0x15b17d[_0x1ab97b(0xd2)]<0xffff&&(_0x51b70a=_0x15b17d[_0x1ab97b(0xd2)]);let _0x11d5e3='',_0x212de3='';getFreePort(_0x51b70a,async _0x485251=>{const _0x3f5509=_0x1ab97b;try{console[_0x3f5509(0xc8)](_0x3f5509(0x101),_0x485251),_0x51b70a=_0x485251;let _0xe367d4=dbConfigTable['findByTitle'](dbOther,_0x3f5509(0xd0));if(_0xe367d4&&_0xe367d4['value']==0x1){console[_0x3f5509(0xc8)](_0x3f5509(0xef));let _0x48b164=dbConfigTable[_0x3f5509(0xe9)](dbOther,'httpsCert');_0x48b164&&_0x48b164[_0x3f5509(0xd2)]&&(_0x11d5e3=_0x48b164[_0x3f5509(0xd2)]);let _0x340e7e=dbConfigTable[_0x3f5509(0xe9)](dbOther,_0x3f5509(0x10b));_0x340e7e&&_0x340e7e[_0x3f5509(0xd2)]&&(_0x212de3=_0x340e7e[_0x3f5509(0xd2)]);}else{console[_0x3f5509(0xc8)]('webdav使用自己设置的证书');let _0x54f8ab=dbConfigTable[_0x3f5509(0xe9)](dbOther,_0x3f5509(0xf0));_0x54f8ab&&_0x54f8ab['value']&&(_0x11d5e3=_0x54f8ab[_0x3f5509(0xd2)]);let _0x1b1e74=dbConfigTable[_0x3f5509(0xe9)](dbOther,'webDavHttpsKey');_0x1b1e74&&_0x1b1e74[_0x3f5509(0xd2)]&&(_0x212de3=_0x1b1e74[_0x3f5509(0xd2)]);}if(!_0x11d5e3){console['log'](_0x3f5509(0xb6));let _0x5585fb=path[_0x3f5509(0xbc)](config[_0x3f5509(0xce)],_0x3f5509(0xbe),_0x3f5509(0xfb));if(!fs['existsSync'](_0x5585fb))return messageUtil['saveMsg'](dbOther,_0x3f5509(0xc5),_0x3f5509(0xd9),_0x3f5509(0xb1));_0x11d5e3=fs[_0x3f5509(0xc7)](_0x5585fb)[_0x3f5509(0xf1)]();}if(!_0x212de3){let _0x31ce2d=path[_0x3f5509(0xbc)](config[_0x3f5509(0xce)],_0x3f5509(0xbe),_0x3f5509(0xdc));if(!fs[_0x3f5509(0xea)](_0x31ce2d))return messageUtil[_0x3f5509(0xbb)](dbOther,_0x3f5509(0xc5),_0x3f5509(0xd9),_0x3f5509(0xb1));_0x212de3=fs[_0x3f5509(0xc7)](_0x31ce2d)[_0x3f5509(0xf1)]();}if(!_0x11d5e3['startsWith']('-----'))try{_0x11d5e3=await cryptoUtils[_0x3f5509(0xbf)](_0x3f5509(0xb9),_0x11d5e3),_0x212de3=await cryptoUtils[_0x3f5509(0xbf)]('nasZs987bac',_0x212de3);}catch(_0x48cd9e){console['log'](_0x48cd9e);}const _0x2987e8=testCertAndKeyMatch(_0x11d5e3,_0x212de3);if(!_0x2987e8)return messageUtil[_0x3f5509(0xbb)](dbOther,_0x3f5509(0xc5),_0x3f5509(0xd9),_0x3f5509(0xb1));const _0x202ae6={'cert':_0x11d5e3,'key':_0x212de3};httpsServer=https[_0x3f5509(0x10c)](_0x202ae6,_0x261265),httpsServer[_0x3f5509(0xfc)](_0x51b70a,_0x2fe1fc=>{const _0x20a963=_0x3f5509;console[_0x20a963(0xc8)](_0x2fe1fc),console['log'](_0x20a963(0x108),_0x51b70a),dbConfigTable[_0x20a963(0xc1)](dbOther,{'title':_0x20a963(0xed),'value':JSON[_0x20a963(0xe7)]({'state':_0x20a963(0xec),'port':_0x51b70a})});}),httpsServer['on'](_0x3f5509(0xd9),_0x43f7aa=>{const _0x15b0b4=_0x3f5509;return console['log'](_0x15b0b4(0xc0),_0x43f7aa),dbConfigTable[_0x15b0b4(0xc1)](dbOther,{'title':'webDavHttpsServer','value':JSON[_0x15b0b4(0xe7)]({'state':_0x15b0b4(0x10e),'port':_0x51b70a})}),messageUtil[_0x15b0b4(0xbb)](dbOther,_0x15b0b4(0xc5),'error',_0x43f7aa[_0x15b0b4(0xf3)]||_0x43f7aa[_0x15b0b4(0xda)]);});}catch(_0x111c5a){return console[_0x3f5509(0xc8)](_0x111c5a),messageUtil[_0x3f5509(0xbb)](dbOther,_0x3f5509(0xc5),_0x3f5509(0xd9),_0x111c5a['stack']||_0x111c5a[_0x3f5509(0xda)]);}});}catch(_0x3589b6){return console[_0x1ab97b(0xc8)](_0x3589b6),messageUtil[_0x1ab97b(0xbb)](dbOther,_0x1ab97b(0xc5),_0x1ab97b(0xd9),_0x3589b6[_0x1ab97b(0xf3)]||_0x3589b6[_0x1ab97b(0xda)]);}}function initWebDavShare(){const _0x3e2029=_0x583373;let _0x2f9a60=dbFileShare['getAllByWhere'](dbOther,_0x3e2029(0xca),[]),_0x1f0180=_0x3e2029(0xcd),_0x86e0e3=config[_0x3e2029(0xcd)],_0x139a25=dbConfigTable['findByTitle'](dbOther,_0x1f0180);if(_0x139a25){let _0x26c0a4=parseInt(_0x139a25['value']);if(_0x26c0a4<=0x0||_0x26c0a4>0xffff){}else _0x86e0e3=_0x26c0a4;}function _0x659683(){getFreePort(_0x86e0e3,async _0x5a16fa=>{const _0xc0009e=_0x26c6;if(_0x2f9a60&&_0x2f9a60['length']>0x0){app=express();for(let _0xf25fa2=0x0;_0xf25fa2<_0x2f9a60[_0xc0009e(0xfe)];_0xf25fa2++){let _0x5b3ef4=_0x2f9a60[_0xf25fa2],_0x4c5c67=dbFileShare[_0xc0009e(0xb8)](dbOther,_0x5b3ef4['id']);if(_0x4c5c67&&_0x4c5c67['length']>0x0)for(let _0x367090=0x0;_0x367090<_0x4c5c67[_0xc0009e(0xfe)];_0x367090++){let _0x1e1ad8=dbUserTable[_0xc0009e(0x102)](dbOther,_0x4c5c67[_0x367090][_0xc0009e(0xcf)]);if(_0x1e1ad8){let _0xf4ba11=await cryptoUtils['decryptString'](config['passwordKey'],_0x1e1ad8['password']),_0x17615d=userManager['addUser'](_0x1e1ad8[_0xc0009e(0xf6)],_0xf4ba11,parseInt(_0x1e1ad8[_0xc0009e(0xd8)])==0x1);privilegeManager[_0xc0009e(0xf4)](_0x17615d,'/'+_0x2f9a60[_0xf25fa2][_0xc0009e(0x105)],[_0xc0009e(0x104)]);}}}let _0x35bbda=dbUserTable[_0xc0009e(0xe0)](dbOther);if(!_0x35bbda)return;let _0x1358d2=await cryptoUtils[_0xc0009e(0xbf)](config[_0xc0009e(0xb5)],_0x35bbda[_0xc0009e(0xc6)]),_0x47f4b6=userManager[_0xc0009e(0xc2)](_0x35bbda[_0xc0009e(0xf6)],_0x1358d2,!![]);privilegeManager['setRights'](_0x47f4b6,'/',[_0xc0009e(0x104)]);const _0x4ea60e=new webdav[(_0xc0009e(0xc4))]({'httpAuthentication':new webdav[(_0xc0009e(0xb2))](userManager,_0xc0009e(0xde)),'privilegeManager':privilegeManager});for(let _0x48e34d=0x0;_0x48e34d<_0x2f9a60[_0xc0009e(0xfe)];_0x48e34d++){_0x4ea60e[_0xc0009e(0xe1)]('/'+_0x2f9a60[_0x48e34d][_0xc0009e(0x105)],new webdav[(_0xc0009e(0xe8))](_0x2f9a60[_0x48e34d][_0xc0009e(0xf5)]));}app[_0xc0009e(0xc3)](webdav['extensions'][_0xc0009e(0xff)]('/',_0x4ea60e));function _0x59e4db(_0x5d08a9){const _0x4eddf9=_0xc0009e;myWebDavServer=app[_0x4eddf9(0xfc)](_0x5d08a9,()=>{const _0x2c6ae8=_0x4eddf9;console['log'](_0x2c6ae8(0xf7)),startHttps(app),dbConfigTable[_0x2c6ae8(0xc1)](dbOther,{'title':_0x2c6ae8(0x100),'value':JSON[_0x2c6ae8(0xe7)]({'state':'run','port':_0x5d08a9})});});}process['on']('uncaughtException',function(_0x55cf3e){const _0xcc47a4=_0xc0009e;saveMsg(_0xcc47a4(0xe6),_0xcc47a4(0xd9),_0x55cf3e[_0xcc47a4(0xee)]),initWebDavShare();}),_0x59e4db(_0x5a16fa);}else dbConfigTable[_0xc0009e(0xc1)](dbOther,{'title':_0xc0009e(0x100),'value':JSON[_0xc0009e(0xe7)]({'state':_0xc0009e(0x10e),'port':_0x5a16fa})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x3e2029(0xdf))](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),httpsServer[_0x3e2029(0xc9)](_0x2d990e=>{const _0xa86bc0=_0x3e2029;console[_0xa86bc0(0xc8)](_0xa86bc0(0xdb)),myWebDavServer[_0xa86bc0(0xc9)](_0x17ef27=>{myWebDavServer=null,_0x659683();});})):_0x659683();}function _0x1489(){const _0x2c8e35=['path_sign','8lQRhsC','WebDav','WebDav\x20https\x20service\x20is\x20running,port:','676062chaVIA','1030IiihpG','httpsKey','createServer','type','stop','HTTPS\x20certs\x20not\x20exist','HTTPDigestAuthentication','shareType','SimplePathPrivilegeManager','passwordKey','webdav使用默认证书','isPortFree','getSharesUserByShareId','nasZs987bac','1438053eHpNyU','saveMsg','join','../../db/dbUserTable','certs','decryptString','WebDav\x20https\x20error\x20','create','addUser','use','WebDAVServer','WebDav\x20https\x20error','password','readFileSync','log','close','\x20server_type=\x27WebDav\x27','better-sqlite3','webdav-server','webDavPort','appRootPath','user_id','webDavUseApiCert','1347619rveumN','value','createSecureContext','../../db/dbFileShare','../../express-server/utils/cryptoUtils','152096yYMvvx','../../db/dbConfigTable','is_admin','error','message','webdav\x20https\x20已关闭','key.pem','pragma','Default\x20realm','SimpleUserManager','getAdmin','setFileSystem','5MtDsuL','109LkDJfI','fileShareRestart','webDavPortHttps','WebDav\x20Start\x20failed','stringify','PhysicalFileSystem','findByTitle','existsSync','275mNbihK','run','webDavHttpsServer','code','webdav使用和api相同的证书','webDavHttpsCert','toString','journal_mode\x20=\x20WAL','stack','setRights','path','username','WebDav\x20start\x20listen','then','349620vHByHp','../../utils/messageUtil','cert.pem','listen','../../myConfig/config','length','express','webDavServer','Starting\x20WebDav\x20http\x20on\x20port','find','1020690KIiMtg','all'];_0x1489=function(){return _0x2c8e35;};return _0x1489();}function _0x26c6(_0x566a88,_0x18812b){const _0x148913=_0x1489();return _0x26c6=function(_0x26c64a,_0x9d7fa7){_0x26c64a=_0x26c64a-0xb1;let _0x38afbc=_0x148913[_0x26c64a];return _0x38afbc;},_0x26c6(_0x566a88,_0x18812b);}process['on'](_0x583373(0xda),_0xe94b6a=>{const _0xd6be35=_0x583373;_0xe94b6a[_0xd6be35(0x10d)]==_0xd6be35(0xe4)&&_0xe94b6a[_0xd6be35(0xb3)]==_0xd6be35(0x107)&&initWebDavShare();}),initWebDavShare();