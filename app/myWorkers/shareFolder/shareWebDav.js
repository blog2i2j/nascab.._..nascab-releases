const _0x2b922b=_0xb934;(function(_0x1b6093,_0x13b129){const _0x33aed3=_0xb934,_0x1eb86b=_0x1b6093();while(!![]){try{const _0x4084ca=parseInt(_0x33aed3(0x141))/0x1*(-parseInt(_0x33aed3(0x15b))/0x2)+parseInt(_0x33aed3(0x13c))/0x3+parseInt(_0x33aed3(0x11d))/0x4+-parseInt(_0x33aed3(0x149))/0x5+-parseInt(_0x33aed3(0x11b))/0x6+parseInt(_0x33aed3(0x11c))/0x7+parseInt(_0x33aed3(0x13a))/0x8;if(_0x4084ca===_0x13b129)break;else _0x1eb86b['push'](_0x1eb86b['shift']());}catch(_0x1587a7){_0x1eb86b['push'](_0x1eb86b['shift']());}}}(_0x47f7,0xc2bc2));let webdav=require(_0x2b922b(0x119))['v2'],express=require(_0x2b922b(0x137));const config=require(_0x2b922b(0x112)),path=require(_0x2b922b(0x14d)),fs=require('fs'),Database=require(_0x2b922b(0x153));let dbOther=new Database(config[_0x2b922b(0x127)],{});process[_0x2b922b(0x165)]=_0x2b922b(0x116),dbOther[_0x2b922b(0x114)](_0x2b922b(0x13d));let dbConfigTable=require(_0x2b922b(0x15a)),dbFileShare=require(_0x2b922b(0x162)),dbUserTable=require(_0x2b922b(0x136)),cryptoUtils=require(_0x2b922b(0x13f)),app=null,myWebDavServer=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),dbNoticeCenterTable=require(_0x2b922b(0x129)),netUtils=require(_0x2b922b(0x12b));const messageUtil=require(_0x2b922b(0x109));let httpsServer;const https=require(_0x2b922b(0x15f));let tls=require(_0x2b922b(0x126));function testCertAndKeyMatch(_0x376819,_0x5c8d92){try{return tls['createSecureContext']({'cert':_0x376819,'key':_0x5c8d92}),!![];}catch(_0x45ccaa){return![];}}function _0xb934(_0x16b1f9,_0x36d310){const _0x47f789=_0x47f7();return _0xb934=function(_0xb934f6,_0x5d0c43){_0xb934f6=_0xb934f6-0x109;let _0x3491fc=_0x47f789[_0xb934f6];return _0x3491fc;},_0xb934(_0x16b1f9,_0x36d310);}function saveMsg(_0x24c945,_0x192a4c,_0xf734ec){const _0x392b8c=_0x2b922b;dbNoticeCenterTable[_0x392b8c(0x14b)](dbOther,{'title':_0x24c945,'level':_0x192a4c,'content':_0xf734ec});}let getFreePort=function(_0x5d7a72,_0x31b624){const _0x244904=_0x2b922b;netUtils[_0x244904(0x151)](_0x5d7a72)[_0x244904(0x125)](_0x30fdca=>{_0x30fdca?_0x31b624(_0x5d7a72):(_0x5d7a72=parseInt(_0x5d7a72)+0x1,getFreePort(_0x5d7a72,_0x31b624));})['catch'](_0x5f3048=>{const _0x1dfad5=_0x244904;console[_0x1dfad5(0x12f)](_0x5f3048),_0x31b624(_0x5d7a72);});};async function startHttps(_0x15020a){const _0x26c97b=_0x2b922b;try{let _0x366e5b=config[_0x26c97b(0x146)],_0x5d0b59=dbConfigTable[_0x26c97b(0x135)](dbOther,_0x26c97b(0x146));_0x5d0b59&&_0x5d0b59[_0x26c97b(0x124)]&&_0x5d0b59[_0x26c97b(0x124)]>0x0&&_0x5d0b59['value']<0xffff&&(_0x366e5b=_0x5d0b59['value']);let _0x18f0ed='',_0xf96dad='';getFreePort(_0x366e5b,async _0x536df4=>{const _0x213207=_0x26c97b;try{console[_0x213207(0x12f)](_0x213207(0x145),_0x536df4),_0x366e5b=_0x536df4;let _0x1bc200=dbConfigTable[_0x213207(0x135)](dbOther,_0x213207(0x142));if(_0x1bc200&&_0x1bc200['value']==0x1){console[_0x213207(0x12f)]('webdav使用和api相同的证书');let _0x50da14=dbConfigTable[_0x213207(0x135)](dbOther,_0x213207(0x15d));_0x50da14&&_0x50da14[_0x213207(0x124)]&&(_0x18f0ed=_0x50da14[_0x213207(0x124)]);let _0x3200da=dbConfigTable['findByTitle'](dbOther,'httpsKey');_0x3200da&&_0x3200da[_0x213207(0x124)]&&(_0xf96dad=_0x3200da[_0x213207(0x124)]);}else{console[_0x213207(0x12f)](_0x213207(0x159));let _0x2062db=dbConfigTable[_0x213207(0x135)](dbOther,_0x213207(0x113));_0x2062db&&_0x2062db[_0x213207(0x124)]&&(_0x18f0ed=_0x2062db[_0x213207(0x124)]);let _0x45090c=dbConfigTable[_0x213207(0x135)](dbOther,_0x213207(0x152));_0x45090c&&_0x45090c[_0x213207(0x124)]&&(_0xf96dad=_0x45090c['value']);}if(!_0x18f0ed){console['log']('webdav使用默认证书');let _0x1e2348=path[_0x213207(0x167)](config[_0x213207(0x147)],_0x213207(0x115),'cert.pem');if(!fs[_0x213207(0x12e)](_0x1e2348))return messageUtil['saveMsg'](dbOther,'WebDav\x20https\x20error',_0x213207(0x133),_0x213207(0x140));_0x18f0ed=fs[_0x213207(0x13e)](_0x1e2348)['toString']();}if(!_0xf96dad){let _0x2a1fc8=path[_0x213207(0x167)](config['appRootPath'],'certs',_0x213207(0x117));if(!fs[_0x213207(0x12e)](_0x2a1fc8))return messageUtil[_0x213207(0x166)](dbOther,_0x213207(0x10b),'error',_0x213207(0x140));_0xf96dad=fs[_0x213207(0x13e)](_0x2a1fc8)[_0x213207(0x10f)]();}if(!_0x18f0ed[_0x213207(0x130)]('-----'))try{_0x18f0ed=await cryptoUtils[_0x213207(0x13b)](_0x213207(0x120),_0x18f0ed),_0xf96dad=await cryptoUtils['decryptString']('nasZs987bac',_0xf96dad);}catch(_0x56f57b){console[_0x213207(0x12f)](_0x56f57b);}const _0x410a27=testCertAndKeyMatch(_0x18f0ed,_0xf96dad);if(!_0x410a27)return messageUtil[_0x213207(0x166)](dbOther,'WebDav\x20https\x20error',_0x213207(0x133),_0x213207(0x140));const _0x3d8dee={'cert':_0x18f0ed,'key':_0xf96dad};httpsServer=https[_0x213207(0x14c)](_0x3d8dee,_0x15020a),httpsServer[_0x213207(0x111)](_0x366e5b,_0x30a1c3=>{const _0x2f8425=_0x213207;console[_0x2f8425(0x12f)](_0x30a1c3),console[_0x2f8425(0x12f)](_0x2f8425(0x158),_0x366e5b),dbConfigTable['create'](dbOther,{'title':_0x2f8425(0x156),'value':JSON[_0x2f8425(0x138)]({'state':_0x2f8425(0x10d),'port':_0x366e5b})});}),httpsServer['on'](_0x213207(0x133),_0x27a8a1=>{const _0x53b5a8=_0x213207;return console[_0x53b5a8(0x12f)](_0x53b5a8(0x164),_0x27a8a1),dbConfigTable['create'](dbOther,{'title':_0x53b5a8(0x156),'value':JSON[_0x53b5a8(0x138)]({'state':_0x53b5a8(0x143),'port':_0x366e5b})}),messageUtil[_0x53b5a8(0x166)](dbOther,_0x53b5a8(0x10b),_0x53b5a8(0x133),_0x27a8a1['stack']||_0x27a8a1[_0x53b5a8(0x118)]);});}catch(_0x4886b8){return console[_0x213207(0x12f)](_0x4886b8),messageUtil['saveMsg'](dbOther,_0x213207(0x10b),_0x213207(0x133),_0x4886b8[_0x213207(0x144)]||_0x4886b8[_0x213207(0x118)]);}});}catch(_0x49ec1c){return console['log'](_0x49ec1c),messageUtil[_0x26c97b(0x166)](dbOther,_0x26c97b(0x10b),_0x26c97b(0x133),_0x49ec1c[_0x26c97b(0x144)]||_0x49ec1c[_0x26c97b(0x118)]);}}function _0x47f7(){const _0x4548f1=['getSharesUserByShareId','error','username','findByTitle','../../db/dbUserTable','express','stringify','WebDav\x20Start\x20failed','7333432sBfWSO','decryptString','3904887HbHElb','journal_mode\x20=\x20WAL','readFileSync','../../express-server/utils/cryptoUtils','HTTPS\x20certs\x20not\x20exist','850256TZfjsp','webDavUseApiCert','stop','stack','Starting\x20WebDav\x20http\x20on\x20port','webDavPortHttps','appRootPath','HTTPDigestAuthentication','6819455HAzxVG','use','create','createServer','path','getAllByWhere','WebDav','close','isPortFree','webDavHttpsKey','better-sqlite3','all','code','webDavHttpsServer','length','WebDav\x20https\x20service\x20is\x20running,port:','webdav使用自己设置的证书','../../db/dbConfigTable','2RfmKWT','webDavServer','httpsCert','shareType','https','SimplePathPrivilegeManager','webdav\x20https\x20已关闭','../../db/dbFileShare','setFileSystem','WebDav\x20https\x20error\x20','title','saveMsg','join','../../utils/messageUtil','webDavPort','WebDav\x20https\x20error','\x20server_type=\x27WebDav\x27','run','addUser','toString','fileShareRestart','listen','../../myConfig/config','webDavHttpsCert','pragma','certs','NasCabWebDavWorker','key.pem','message','webdav-server','user_id','7592418SKnTLf','5106332WVztio','5317600yjqoJD','type','path_sign','nasZs987bac','WebDav\x20start\x20listen','WebDAVServer','uncaughtException','value','then','tls','dbOther','passwordKey','../../db/dbNoticeCenterTable','SimpleUserManager','../../express-server/utils/netUtils','Default\x20realm','password','existsSync','log','startsWith','extensions'];_0x47f7=function(){return _0x4548f1;};return _0x47f7();}function initWebDavShare(){const _0x3e640c=_0x2b922b;let _0x4d3204=dbFileShare[_0x3e640c(0x14e)](dbOther,_0x3e640c(0x10c),[]),_0x2d54cd=_0x3e640c(0x10a),_0x4820d0=config[_0x3e640c(0x10a)],_0x7882f3=dbConfigTable[_0x3e640c(0x135)](dbOther,_0x2d54cd);if(_0x7882f3){let _0x540c36=parseInt(_0x7882f3[_0x3e640c(0x124)]);if(_0x540c36<=0x0||_0x540c36>0xffff){}else _0x4820d0=_0x540c36;}function _0x949b02(){getFreePort(_0x4820d0,async _0x245860=>{const _0x27348d=_0xb934;if(_0x4d3204&&_0x4d3204['length']>0x0){app=express();for(let _0x3d3c32=0x0;_0x3d3c32<_0x4d3204['length'];_0x3d3c32++){let _0x15a6b6=_0x4d3204[_0x3d3c32],_0x27ca64=dbFileShare[_0x27348d(0x132)](dbOther,_0x15a6b6['id']);if(_0x27ca64&&_0x27ca64[_0x27348d(0x157)]>0x0)for(let _0x583ccb=0x0;_0x583ccb<_0x27ca64['length'];_0x583ccb++){let _0x32227e=dbUserTable['find'](dbOther,_0x27ca64[_0x583ccb][_0x27348d(0x11a)]);if(_0x32227e){let _0xacb006=await cryptoUtils['decryptString'](config[_0x27348d(0x128)],_0x32227e[_0x27348d(0x12d)]),_0x303452=userManager[_0x27348d(0x10e)](_0x32227e[_0x27348d(0x134)],_0xacb006,parseInt(_0x32227e['is_admin'])==0x1);privilegeManager['setRights'](_0x303452,'/'+_0x4d3204[_0x3d3c32][_0x27348d(0x11f)],[_0x27348d(0x154)]);}}}let _0x6d3ecf=dbUserTable['getAdmin'](dbOther);if(!_0x6d3ecf)return;let _0x44cf34=await cryptoUtils['decryptString'](config[_0x27348d(0x128)],_0x6d3ecf['password']),_0x3eacf0=userManager[_0x27348d(0x10e)](_0x6d3ecf['username'],_0x44cf34,!![]);privilegeManager['setRights'](_0x3eacf0,'/',['all']);const _0xef3d51=new webdav[(_0x27348d(0x122))]({'httpAuthentication':new webdav[(_0x27348d(0x148))](userManager,_0x27348d(0x12c)),'privilegeManager':privilegeManager});for(let _0x16e9de=0x0;_0x16e9de<_0x4d3204['length'];_0x16e9de++){_0xef3d51[_0x27348d(0x163)]('/'+_0x4d3204[_0x16e9de]['path_sign'],new webdav['PhysicalFileSystem'](_0x4d3204[_0x16e9de][_0x27348d(0x14d)]));}app[_0x27348d(0x14a)](webdav[_0x27348d(0x131)][_0x27348d(0x137)]('/',_0xef3d51));function _0x53991c(_0x5c1f80){const _0x4973d7=_0x27348d;myWebDavServer=app[_0x4973d7(0x111)](_0x5c1f80,()=>{const _0x3d353a=_0x4973d7;console[_0x3d353a(0x12f)](_0x3d353a(0x121)),startHttps(app),dbConfigTable[_0x3d353a(0x14b)](dbOther,{'title':_0x3d353a(0x15c),'value':JSON[_0x3d353a(0x138)]({'state':_0x3d353a(0x10d),'port':_0x5c1f80})});});}process['on'](_0x27348d(0x123),function(_0x16c26e){const _0x5929a2=_0x27348d;saveMsg(_0x5929a2(0x139),_0x5929a2(0x133),_0x16c26e[_0x5929a2(0x155)]),initWebDavShare();}),_0x53991c(_0x245860);}else dbConfigTable['create'](dbOther,{'title':_0x27348d(0x15c),'value':JSON[_0x27348d(0x138)]({'state':_0x27348d(0x143),'port':_0x245860})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x3e640c(0x12a))](),privilegeManager=new webdav[(_0x3e640c(0x160))](),httpsServer[_0x3e640c(0x150)](_0x41abd8=>{const _0xbf1134=_0x3e640c;console[_0xbf1134(0x12f)](_0xbf1134(0x161)),myWebDavServer[_0xbf1134(0x150)](_0x902df7=>{myWebDavServer=null,_0x949b02();});})):_0x949b02();}process['on']('message',_0x962cdf=>{const _0x1c2b3d=_0x2b922b;_0x962cdf[_0x1c2b3d(0x11e)]==_0x1c2b3d(0x110)&&_0x962cdf[_0x1c2b3d(0x15e)]==_0x1c2b3d(0x14f)&&initWebDavShare();}),initWebDavShare();