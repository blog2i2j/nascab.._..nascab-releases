const _0x2e60e7=_0x413f;(function(_0x5508f5,_0xa92c87){const _0x5f3fe2=_0x413f,_0xb5c084=_0x5508f5();while(!![]){try{const _0x3342af=parseInt(_0x5f3fe2(0x168))/0x1*(-parseInt(_0x5f3fe2(0x164))/0x2)+-parseInt(_0x5f3fe2(0x183))/0x3+-parseInt(_0x5f3fe2(0x180))/0x4+parseInt(_0x5f3fe2(0x178))/0x5*(-parseInt(_0x5f3fe2(0x186))/0x6)+-parseInt(_0x5f3fe2(0x189))/0x7+parseInt(_0x5f3fe2(0x17b))/0x8+parseInt(_0x5f3fe2(0x16b))/0x9;if(_0x3342af===_0xa92c87)break;else _0xb5c084['push'](_0xb5c084['shift']());}catch(_0x130721){_0xb5c084['push'](_0xb5c084['shift']());}}}(_0x96b2,0xa91af));let webdav=require(_0x2e60e7(0x154))['v2'],express=require('express');const config=require(_0x2e60e7(0x167)),path=require(_0x2e60e7(0x179)),fs=require('fs'),Database=require(_0x2e60e7(0x170));let dbOther=new Database(config[_0x2e60e7(0x18a)],{});process[_0x2e60e7(0x156)]=_0x2e60e7(0x16f),dbOther[_0x2e60e7(0x159)]('journal_mode\x20=\x20WAL');let dbConfigTable=require('../../db/dbConfigTable'),dbFileShare=require(_0x2e60e7(0x195)),dbUserTable=require('../../db/dbUserTable'),cryptoUtils=require(_0x2e60e7(0x172)),app=null,myWebDavServer=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav['SimplePathPrivilegeManager'](),dbNoticeCenterTable=require(_0x2e60e7(0x161)),netUtils=require(_0x2e60e7(0x143));const messageUtil=require(_0x2e60e7(0x171));let httpsServer;const https=require(_0x2e60e7(0x140));let tls=require(_0x2e60e7(0x17a));function testCertAndKeyMatch(_0x5c7f97,_0x517b2e){const _0x1230ae=_0x2e60e7;try{return tls[_0x1230ae(0x18c)]({'cert':_0x5c7f97,'key':_0x517b2e}),!![];}catch(_0x42e07e){return![];}}function saveMsg(_0x47650a,_0x5cbe80,_0x4436a6){const _0x299710=_0x2e60e7;dbNoticeCenterTable[_0x299710(0x15a)](dbOther,{'title':_0x47650a,'level':_0x5cbe80,'content':_0x4436a6});}function _0x413f(_0x2b2aea,_0x2874bb){const _0x96b27a=_0x96b2();return _0x413f=function(_0x413fea,_0x15d83e){_0x413fea=_0x413fea-0x13f;let _0x126e48=_0x96b27a[_0x413fea];return _0x126e48;},_0x413f(_0x2b2aea,_0x2874bb);}let getFreePort=function(_0x1ecb58,_0x3c8837){const _0x159c35=_0x2e60e7;netUtils['isPortFree'](_0x1ecb58)['then'](_0x51d6bb=>{_0x51d6bb?_0x3c8837(_0x1ecb58):(_0x1ecb58=parseInt(_0x1ecb58)+0x1,getFreePort(_0x1ecb58,_0x3c8837));})[_0x159c35(0x177)](_0x45b942=>{const _0x4c88dd=_0x159c35;console[_0x4c88dd(0x18e)](_0x45b942),_0x3c8837(_0x1ecb58);});};async function startHttps(_0x597438){const _0x59cc8e=_0x2e60e7;try{let _0x405978=config[_0x59cc8e(0x165)],_0x44fe51=dbConfigTable[_0x59cc8e(0x150)](dbOther,'webDavPortHttps');_0x44fe51&&_0x44fe51[_0x59cc8e(0x190)]&&_0x44fe51['value']>0x0&&_0x44fe51[_0x59cc8e(0x190)]<0xffff&&(_0x405978=_0x44fe51[_0x59cc8e(0x190)]);let _0x51095a='',_0x5b886e='';getFreePort(_0x405978,async _0x1fa83d=>{const _0x47f614=_0x59cc8e;try{console[_0x47f614(0x18e)](_0x47f614(0x155),_0x1fa83d),_0x405978=_0x1fa83d;let _0x3ac454=dbConfigTable['findByTitle'](dbOther,_0x47f614(0x185));if(_0x3ac454&&_0x3ac454['value']==0x1){console['log'](_0x47f614(0x141));let _0x2522f1=dbConfigTable[_0x47f614(0x150)](dbOther,_0x47f614(0x15c));_0x2522f1&&_0x2522f1[_0x47f614(0x190)]&&(_0x51095a=_0x2522f1['value']);let _0x5c7292=dbConfigTable[_0x47f614(0x150)](dbOther,_0x47f614(0x148));_0x5c7292&&_0x5c7292[_0x47f614(0x190)]&&(_0x5b886e=_0x5c7292['value']);}else{console[_0x47f614(0x18e)]('webdav使用自己设置的证书');let _0x45df27=dbConfigTable[_0x47f614(0x150)](dbOther,_0x47f614(0x16a));_0x45df27&&_0x45df27[_0x47f614(0x190)]&&(_0x51095a=_0x45df27[_0x47f614(0x190)]);let _0x4e0c65=dbConfigTable[_0x47f614(0x150)](dbOther,_0x47f614(0x166));_0x4e0c65&&_0x4e0c65[_0x47f614(0x190)]&&(_0x5b886e=_0x4e0c65[_0x47f614(0x190)]);}if(!_0x51095a){console[_0x47f614(0x18e)]('webdav使用默认证书');let _0x1f9438=path[_0x47f614(0x142)](config[_0x47f614(0x16d)],_0x47f614(0x15d),'cert.pem');if(!fs['existsSync'](_0x1f9438))return messageUtil[_0x47f614(0x146)](dbOther,'WebDav\x20https\x20error',_0x47f614(0x17d),_0x47f614(0x18d));_0x51095a=fs['readFileSync'](_0x1f9438)[_0x47f614(0x176)]();}if(!_0x5b886e){let _0x3e8b5e=path[_0x47f614(0x142)](config[_0x47f614(0x16d)],_0x47f614(0x15d),'key.pem');if(!fs[_0x47f614(0x184)](_0x3e8b5e))return messageUtil['saveMsg'](dbOther,'WebDav\x20https\x20error','error','HTTPS\x20certs\x20not\x20exist');_0x5b886e=fs['readFileSync'](_0x3e8b5e)[_0x47f614(0x176)]();}if(!_0x51095a[_0x47f614(0x16c)](_0x47f614(0x18f)))try{_0x51095a=await cryptoUtils[_0x47f614(0x147)](_0x47f614(0x14c),_0x51095a),_0x5b886e=await cryptoUtils[_0x47f614(0x147)](_0x47f614(0x14c),_0x5b886e);}catch(_0x5894a7){console[_0x47f614(0x18e)](_0x5894a7);}const _0x3370a2=testCertAndKeyMatch(_0x51095a,_0x5b886e);if(!_0x3370a2)return messageUtil['saveMsg'](dbOther,_0x47f614(0x15f),_0x47f614(0x17d),'HTTPS\x20certs\x20not\x20exist');const _0x1844a1={'cert':_0x51095a,'key':_0x5b886e};httpsServer=https['createServer'](_0x1844a1,_0x597438),httpsServer[_0x47f614(0x18b)](_0x405978,_0x20c363=>{const _0x1158e5=_0x47f614;console['log'](_0x20c363),console['log']('WebDav\x20https\x20service\x20is\x20running,port:',_0x405978),dbConfigTable['create'](dbOther,{'title':'webDavHttpsServer','value':JSON[_0x1158e5(0x193)]({'state':_0x1158e5(0x187),'port':_0x405978})});}),httpsServer['on'](_0x47f614(0x17d),_0x2f84b6=>{const _0x18846e=_0x47f614;return console[_0x18846e(0x18e)]('WebDav\x20https\x20error\x20',_0x2f84b6),dbConfigTable['create'](dbOther,{'title':_0x18846e(0x192),'value':JSON['stringify']({'state':_0x18846e(0x145),'port':_0x405978})}),messageUtil[_0x18846e(0x146)](dbOther,_0x18846e(0x15f),_0x18846e(0x17d),_0x2f84b6[_0x18846e(0x160)]||_0x2f84b6[_0x18846e(0x174)]);});}catch(_0x512c23){return console[_0x47f614(0x18e)](_0x512c23),messageUtil['saveMsg'](dbOther,_0x47f614(0x15f),_0x47f614(0x17d),_0x512c23[_0x47f614(0x160)]||_0x512c23[_0x47f614(0x174)]);}});}catch(_0x7dc2e){return console['log'](_0x7dc2e),messageUtil[_0x59cc8e(0x146)](dbOther,_0x59cc8e(0x15f),'error',_0x7dc2e[_0x59cc8e(0x160)]||_0x7dc2e[_0x59cc8e(0x174)]);}}function _0x96b2(){const _0x5b6b8d=['3807483AEXbAQ','existsSync','webDavUseApiCert','12030aJGaMP','run','SimpleUserManager','7295498EquPaE','dbOther','listen','createSecureContext','HTTPS\x20certs\x20not\x20exist','log','-----','value','passwordKey','webDavHttpsServer','stringify','getAdmin','../../db/dbFileShare','code','webdav\x20https\x20已关闭','https','webdav使用和api相同的证书','join','../../express-server/utils/netUtils','find','stop','saveMsg','decryptString','httpsKey','PhysicalFileSystem','getAllByWhere','getSharesUserByShareId','nasZs987bac','setRights','type','SimplePathPrivilegeManager','findByTitle','webDavPort','setFileSystem','WebDAVServer','webdav-server','Starting\x20WebDav\x20http\x20on\x20port','title','shareType','all','pragma','create','path_sign','httpsCert','certs','username','WebDav\x20https\x20error','stack','../../db/dbNoticeCenterTable','express','HTTPDigestAuthentication','12gdmDRP','webDavPortHttps','webDavHttpsKey','../../myConfig/config','127688XsmuBF','Default\x20realm','webDavHttpsCert','51909066oZzjai','startsWith','appRootPath','use','NasCabWebDavWorker','better-sqlite3','../../utils/messageUtil','../../express-server/utils/cryptoUtils','webDavServer','message','addUser','toString','catch','2015DMCMtY','path','tls','489536KpFuiK','close','error','password','fileShareRestart','5002772XAVOcT','length','WebDav\x20start\x20listen'];_0x96b2=function(){return _0x5b6b8d;};return _0x96b2();}function initWebDavShare(){const _0x3084e0=_0x2e60e7;let _0x1385fe=dbFileShare[_0x3084e0(0x14a)](dbOther,'\x20server_type=\x27WebDav\x27',[]),_0x107c26=_0x3084e0(0x151),_0x55c668=config[_0x3084e0(0x151)],_0x1be9d3=dbConfigTable[_0x3084e0(0x150)](dbOther,_0x107c26);if(_0x1be9d3){let _0x2f71fa=parseInt(_0x1be9d3[_0x3084e0(0x190)]);if(_0x2f71fa<=0x0||_0x2f71fa>0xffff){}else _0x55c668=_0x2f71fa;}function _0x5db544(){getFreePort(_0x55c668,async _0x31b818=>{const _0x635368=_0x413f;if(_0x1385fe&&_0x1385fe[_0x635368(0x181)]>0x0){app=express();for(let _0x6830b7=0x0;_0x6830b7<_0x1385fe['length'];_0x6830b7++){let _0x3bc0de=_0x1385fe[_0x6830b7],_0x4f4c7f=dbFileShare[_0x635368(0x14b)](dbOther,_0x3bc0de['id']);if(_0x4f4c7f&&_0x4f4c7f['length']>0x0)for(let _0x17317d=0x0;_0x17317d<_0x4f4c7f[_0x635368(0x181)];_0x17317d++){let _0xb069aa=dbUserTable[_0x635368(0x144)](dbOther,_0x4f4c7f[_0x17317d]['user_id']);if(_0xb069aa){let _0x4a4ce7=await cryptoUtils['decryptString'](config['passwordKey'],_0xb069aa[_0x635368(0x17e)]),_0xf18787=userManager['addUser'](_0xb069aa[_0x635368(0x15e)],_0x4a4ce7,parseInt(_0xb069aa['is_admin'])==0x1);privilegeManager[_0x635368(0x14d)](_0xf18787,'/'+_0x1385fe[_0x6830b7][_0x635368(0x15b)],[_0x635368(0x158)]);}}}let _0x4919de=dbUserTable[_0x635368(0x194)](dbOther);if(!_0x4919de)return;let _0x3f6691=await cryptoUtils[_0x635368(0x147)](config[_0x635368(0x191)],_0x4919de[_0x635368(0x17e)]),_0x14bd7c=userManager[_0x635368(0x175)](_0x4919de['username'],_0x3f6691,!![]);privilegeManager[_0x635368(0x14d)](_0x14bd7c,'/',['all']);const _0x3e79fe=new webdav[(_0x635368(0x153))]({'httpAuthentication':new webdav[(_0x635368(0x163))](userManager,_0x635368(0x169)),'privilegeManager':privilegeManager});for(let _0xaaa4=0x0;_0xaaa4<_0x1385fe[_0x635368(0x181)];_0xaaa4++){_0x3e79fe[_0x635368(0x152)]('/'+_0x1385fe[_0xaaa4][_0x635368(0x15b)],new webdav[(_0x635368(0x149))](_0x1385fe[_0xaaa4][_0x635368(0x179)]));}app[_0x635368(0x16e)](webdav['extensions'][_0x635368(0x162)]('/',_0x3e79fe));function _0x22d6ee(_0x2b1078){const _0x584793=_0x635368;myWebDavServer=app[_0x584793(0x18b)](_0x2b1078,()=>{const _0x268c44=_0x584793;console[_0x268c44(0x18e)](_0x268c44(0x182)),startHttps(app),dbConfigTable['create'](dbOther,{'title':'webDavServer','value':JSON[_0x268c44(0x193)]({'state':'run','port':_0x2b1078})});});}process['on']('uncaughtException',function(_0x23356a){const _0xd8ede2=_0x635368;saveMsg('WebDav\x20Start\x20failed',_0xd8ede2(0x17d),_0x23356a[_0xd8ede2(0x196)]),initWebDavShare();}),_0x22d6ee(_0x31b818);}else dbConfigTable[_0x635368(0x15a)](dbOther,{'title':_0x635368(0x173),'value':JSON['stringify']({'state':_0x635368(0x145),'port':_0x31b818})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x3084e0(0x188))](),privilegeManager=new webdav[(_0x3084e0(0x14f))](),httpsServer[_0x3084e0(0x17c)](_0x345578=>{const _0x444659=_0x3084e0;console[_0x444659(0x18e)](_0x444659(0x13f)),myWebDavServer[_0x444659(0x17c)](_0x14db45=>{myWebDavServer=null,_0x5db544();});})):_0x5db544();}process['on'](_0x2e60e7(0x174),_0x1079d4=>{const _0x1151cf=_0x2e60e7;_0x1079d4[_0x1151cf(0x14e)]==_0x1151cf(0x17f)&&_0x1079d4[_0x1151cf(0x157)]=='WebDav'&&initWebDavShare();}),initWebDavShare();