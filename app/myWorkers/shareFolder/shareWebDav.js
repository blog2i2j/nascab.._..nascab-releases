function _0x5a98(_0x5c30d7,_0x5bdd8e){const _0x36b920=_0x36b9();return _0x5a98=function(_0x5a9805,_0x45c109){_0x5a9805=_0x5a9805-0xa4;let _0x42665c=_0x36b920[_0x5a9805];return _0x42665c;},_0x5a98(_0x5c30d7,_0x5bdd8e);}const _0x277087=_0x5a98;(function(_0x26a764,_0x13f2e4){const _0x1959d2=_0x5a98,_0x376924=_0x26a764();while(!![]){try{const _0x2a627=-parseInt(_0x1959d2(0xeb))/0x1*(parseInt(_0x1959d2(0xb0))/0x2)+-parseInt(_0x1959d2(0xe5))/0x3+parseInt(_0x1959d2(0xc2))/0x4*(-parseInt(_0x1959d2(0xd5))/0x5)+-parseInt(_0x1959d2(0xc7))/0x6+parseInt(_0x1959d2(0xc0))/0x7*(parseInt(_0x1959d2(0xd0))/0x8)+-parseInt(_0x1959d2(0xac))/0x9+parseInt(_0x1959d2(0xc1))/0xa;if(_0x2a627===_0x13f2e4)break;else _0x376924['push'](_0x376924['shift']());}catch(_0x46cf27){_0x376924['push'](_0x376924['shift']());}}}(_0x36b9,0x4af6e));let webdav=require(_0x277087(0xc8))['v2'],express=require(_0x277087(0xcb));const config=require(_0x277087(0xa4)),path=require(_0x277087(0xdc)),fs=require('fs'),Database=require(_0x277087(0xba));let dbOther=new Database(config['dbOther'],{});process[_0x277087(0xd8)]=_0x277087(0xf4),dbOther[_0x277087(0xef)](_0x277087(0xe7));function _0x36b9(){const _0x3fe902=['webdav-server','uncaughtException','SimpleUserManager','express','toString','webDavPort','Default\x20realm','find','233064FzWxvB','setRights','user_id','use','shareType','378415FwNPJe','-----','HTTPS\x20certs\x20not\x20exist','title','HTTPDigestAuthentication','findByTitle','then','path','getSharesUserByShareId','stack','../../utils/messageUtil','WebDav','stop','../../db/dbNoticeCenterTable','value','log','686223AFbmva','readFileSync','journal_mode\x20=\x20WAL','error','close','create','2AMamPs','catch','passwordKey','certs','pragma','WebDAVServer','Starting\x20WebDav\x20http\x20on\x20port','path_sign','all','NasCabWebDavWorker','existsSync','key.pem','join','type','username','addUser','webDavHttpsServer','../../db/dbFileShare','code','cert.pem','WebDav\x20https\x20service\x20is\x20running,port:','../../myConfig/config','length','appRootPath','getAdmin','httpsCert','decryptString','WebDav\x20https\x20error','WebDav\x20https\x20error\x20','2623167sQBIvT','webdav使用和api相同的证书','WebDav\x20start\x20listen','tls','485494FVsNbm','../../express-server/utils/netUtils','run','extensions','listen','saveMsg','nasZs987bac','createSecureContext','webDavHttpsKey','../../db/dbUserTable','better-sqlite3','SimplePathPrivilegeManager','https','webDavPortHttps','fileShareRestart','webDavServer','35ZqClkm','17013860HImjqD','4wtloOa','PhysicalFileSystem','stringify','password','message','2751696WgXXIT'];_0x36b9=function(){return _0x3fe902;};return _0x36b9();}let dbConfigTable=require('../../db/dbConfigTable'),dbFileShare=require(_0x277087(0xfc)),dbUserTable=require(_0x277087(0xb9)),cryptoUtils=require('../../express-server/utils/cryptoUtils'),app=null,myWebDavServer=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav[(_0x277087(0xbb))](),dbNoticeCenterTable=require(_0x277087(0xe2)),netUtils=require(_0x277087(0xb1));const messageUtil=require(_0x277087(0xdf));let httpsServer;const https=require(_0x277087(0xbc));let tls=require(_0x277087(0xaf));function testCertAndKeyMatch(_0x26bbb1,_0x462e1a){const _0x3d9fbc=_0x277087;try{return tls[_0x3d9fbc(0xb7)]({'cert':_0x26bbb1,'key':_0x462e1a}),!![];}catch(_0x327e85){return![];}}function saveMsg(_0x41cfac,_0xf55c9d,_0x210a03){dbNoticeCenterTable['create'](dbOther,{'title':_0x41cfac,'level':_0xf55c9d,'content':_0x210a03});}let getFreePort=function(_0x1da204,_0x47e85d){const _0xc7a5a9=_0x277087;netUtils['isPortFree'](_0x1da204)[_0xc7a5a9(0xdb)](_0x5ecf83=>{_0x5ecf83?_0x47e85d(_0x1da204):(_0x1da204=parseInt(_0x1da204)+0x1,getFreePort(_0x1da204,_0x47e85d));})[_0xc7a5a9(0xec)](_0x4012ce=>{console['log'](_0x4012ce),_0x47e85d(_0x1da204);});};async function startHttps(_0x50114f){const _0x39432b=_0x277087;try{let _0x72b0b9=config['webDavPortHttps'],_0x17ced0=dbConfigTable[_0x39432b(0xda)](dbOther,_0x39432b(0xbd));_0x17ced0&&_0x17ced0[_0x39432b(0xe3)]&&_0x17ced0[_0x39432b(0xe3)]>0x0&&_0x17ced0[_0x39432b(0xe3)]<0xffff&&(_0x72b0b9=_0x17ced0[_0x39432b(0xe3)]);let _0x4902f2='',_0x49baf2='';getFreePort(_0x72b0b9,async _0x242d24=>{const _0x1e6567=_0x39432b;try{console['log'](_0x1e6567(0xf1),_0x242d24),_0x72b0b9=_0x242d24;let _0x29814d=dbConfigTable['findByTitle'](dbOther,'webDavUseApiCert');if(_0x29814d&&_0x29814d[_0x1e6567(0xe3)]==0x1){console[_0x1e6567(0xe4)](_0x1e6567(0xad));let _0x51b8c2=dbConfigTable[_0x1e6567(0xda)](dbOther,_0x1e6567(0xa8));_0x51b8c2&&_0x51b8c2['value']&&(_0x4902f2=_0x51b8c2['value']);let _0x5cd862=dbConfigTable[_0x1e6567(0xda)](dbOther,'httpsKey');_0x5cd862&&_0x5cd862['value']&&(_0x49baf2=_0x5cd862[_0x1e6567(0xe3)]);}else{console['log']('webdav使用自己设置的证书');let _0xb4c866=dbConfigTable[_0x1e6567(0xda)](dbOther,'webDavHttpsCert');_0xb4c866&&_0xb4c866[_0x1e6567(0xe3)]&&(_0x4902f2=_0xb4c866[_0x1e6567(0xe3)]);let _0x772ab6=dbConfigTable[_0x1e6567(0xda)](dbOther,_0x1e6567(0xb8));_0x772ab6&&_0x772ab6[_0x1e6567(0xe3)]&&(_0x49baf2=_0x772ab6['value']);}if(!_0x4902f2){console[_0x1e6567(0xe4)]('webdav使用默认证书');let _0x208aea=path[_0x1e6567(0xf7)](config[_0x1e6567(0xa6)],_0x1e6567(0xee),_0x1e6567(0xfe));if(!fs[_0x1e6567(0xf5)](_0x208aea))return messageUtil[_0x1e6567(0xb5)](dbOther,_0x1e6567(0xaa),_0x1e6567(0xe8),_0x1e6567(0xd7));_0x4902f2=fs[_0x1e6567(0xe6)](_0x208aea)[_0x1e6567(0xcc)]();}if(!_0x49baf2){let _0x26c3fa=path[_0x1e6567(0xf7)](config[_0x1e6567(0xa6)],_0x1e6567(0xee),_0x1e6567(0xf6));if(!fs['existsSync'](_0x26c3fa))return messageUtil[_0x1e6567(0xb5)](dbOther,_0x1e6567(0xaa),_0x1e6567(0xe8),_0x1e6567(0xd7));_0x49baf2=fs[_0x1e6567(0xe6)](_0x26c3fa)['toString']();}if(!_0x4902f2['startsWith'](_0x1e6567(0xd6)))try{_0x4902f2=await cryptoUtils['decryptString'](_0x1e6567(0xb6),_0x4902f2),_0x49baf2=await cryptoUtils[_0x1e6567(0xa9)]('nasZs987bac',_0x49baf2);}catch(_0x4cc6cd){console[_0x1e6567(0xe4)](_0x4cc6cd);}const _0x3ceaa0=testCertAndKeyMatch(_0x4902f2,_0x49baf2);if(!_0x3ceaa0)return messageUtil['saveMsg'](dbOther,'WebDav\x20https\x20error',_0x1e6567(0xe8),_0x1e6567(0xd7));const _0x20f798={'cert':_0x4902f2,'key':_0x49baf2};httpsServer=https['createServer'](_0x20f798,_0x50114f),httpsServer[_0x1e6567(0xb4)](_0x72b0b9,_0x1c1832=>{const _0x1429ad=_0x1e6567;console[_0x1429ad(0xe4)](_0x1c1832),console[_0x1429ad(0xe4)](_0x1429ad(0xff),_0x72b0b9),dbConfigTable[_0x1429ad(0xea)](dbOther,{'title':_0x1429ad(0xfb),'value':JSON[_0x1429ad(0xc4)]({'state':_0x1429ad(0xb2),'port':_0x72b0b9})});}),httpsServer['on'](_0x1e6567(0xe8),_0x44d5c5=>{const _0x11b7e8=_0x1e6567;return console['log'](_0x11b7e8(0xab),_0x44d5c5),dbConfigTable[_0x11b7e8(0xea)](dbOther,{'title':_0x11b7e8(0xfb),'value':JSON[_0x11b7e8(0xc4)]({'state':'stop','port':_0x72b0b9})}),messageUtil[_0x11b7e8(0xb5)](dbOther,'WebDav\x20https\x20error',_0x11b7e8(0xe8),_0x44d5c5[_0x11b7e8(0xde)]||_0x44d5c5[_0x11b7e8(0xc6)]);});}catch(_0x57bb10){return console[_0x1e6567(0xe4)](_0x57bb10),messageUtil[_0x1e6567(0xb5)](dbOther,'WebDav\x20https\x20error',_0x1e6567(0xe8),_0x57bb10['stack']||_0x57bb10[_0x1e6567(0xc6)]);}});}catch(_0x3cb8ea){return console[_0x39432b(0xe4)](_0x3cb8ea),messageUtil[_0x39432b(0xb5)](dbOther,_0x39432b(0xaa),_0x39432b(0xe8),_0x3cb8ea[_0x39432b(0xde)]||_0x3cb8ea[_0x39432b(0xc6)]);}}function initWebDavShare(){const _0x586540=_0x277087;let _0x1c050e=dbFileShare['getAllByWhere'](dbOther,'\x20server_type=\x27WebDav\x27',[]),_0x49cfba=_0x586540(0xcd),_0x4e42c8=config[_0x586540(0xcd)],_0x287565=dbConfigTable[_0x586540(0xda)](dbOther,_0x49cfba);if(_0x287565){let _0x4ea333=parseInt(_0x287565[_0x586540(0xe3)]);if(_0x4ea333<=0x0||_0x4ea333>0xffff){}else _0x4e42c8=_0x4ea333;}function _0x511a18(){getFreePort(_0x4e42c8,async _0x50b87b=>{const _0x2b023c=_0x5a98;if(_0x1c050e&&_0x1c050e[_0x2b023c(0xa5)]>0x0){app=express();for(let _0x4af149=0x0;_0x4af149<_0x1c050e[_0x2b023c(0xa5)];_0x4af149++){let _0x9060dc=_0x1c050e[_0x4af149],_0x383541=dbFileShare[_0x2b023c(0xdd)](dbOther,_0x9060dc['id']);if(_0x383541&&_0x383541[_0x2b023c(0xa5)]>0x0)for(let _0x37ad79=0x0;_0x37ad79<_0x383541[_0x2b023c(0xa5)];_0x37ad79++){let _0x42f8fd=dbUserTable[_0x2b023c(0xcf)](dbOther,_0x383541[_0x37ad79][_0x2b023c(0xd2)]);if(_0x42f8fd){let _0x5a70de=await cryptoUtils[_0x2b023c(0xa9)](config[_0x2b023c(0xed)],_0x42f8fd[_0x2b023c(0xc5)]),_0x51d3c0=userManager[_0x2b023c(0xfa)](_0x42f8fd[_0x2b023c(0xf9)],_0x5a70de,parseInt(_0x42f8fd['is_admin'])==0x1);privilegeManager[_0x2b023c(0xd1)](_0x51d3c0,'/'+_0x1c050e[_0x4af149]['path_sign'],['all']);}}}let _0x388bb7=dbUserTable[_0x2b023c(0xa7)](dbOther);if(!_0x388bb7)return;let _0x506b5c=await cryptoUtils['decryptString'](config[_0x2b023c(0xed)],_0x388bb7[_0x2b023c(0xc5)]),_0x4318cb=userManager[_0x2b023c(0xfa)](_0x388bb7[_0x2b023c(0xf9)],_0x506b5c,!![]);privilegeManager[_0x2b023c(0xd1)](_0x4318cb,'/',[_0x2b023c(0xf3)]);const _0x376265=new webdav[(_0x2b023c(0xf0))]({'httpAuthentication':new webdav[(_0x2b023c(0xd9))](userManager,_0x2b023c(0xce)),'privilegeManager':privilegeManager});for(let _0x43c40c=0x0;_0x43c40c<_0x1c050e[_0x2b023c(0xa5)];_0x43c40c++){_0x376265['setFileSystem']('/'+_0x1c050e[_0x43c40c][_0x2b023c(0xf2)],new webdav[(_0x2b023c(0xc3))](_0x1c050e[_0x43c40c]['path']));}app[_0x2b023c(0xd3)](webdav[_0x2b023c(0xb3)][_0x2b023c(0xcb)]('/',_0x376265));function _0x482a8f(_0x5e1a09){const _0x202885=_0x2b023c;myWebDavServer=app[_0x202885(0xb4)](_0x5e1a09,()=>{const _0x4b531a=_0x202885;console['log'](_0x4b531a(0xae)),startHttps(app),dbConfigTable[_0x4b531a(0xea)](dbOther,{'title':_0x4b531a(0xbf),'value':JSON['stringify']({'state':_0x4b531a(0xb2),'port':_0x5e1a09})});});}process['on'](_0x2b023c(0xc9),function(_0x3a3076){const _0x28f143=_0x2b023c;saveMsg('WebDav\x20Start\x20failed',_0x28f143(0xe8),_0x3a3076[_0x28f143(0xfd)]),initWebDavShare();}),_0x482a8f(_0x50b87b);}else dbConfigTable[_0x2b023c(0xea)](dbOther,{'title':_0x2b023c(0xbf),'value':JSON['stringify']({'state':_0x2b023c(0xe1),'port':_0x50b87b})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x586540(0xca))](),privilegeManager=new webdav[(_0x586540(0xbb))](),httpsServer[_0x586540(0xe9)](_0xb68c3e=>{const _0x5800a2=_0x586540;console[_0x5800a2(0xe4)]('webdav\x20https\x20已关闭'),myWebDavServer[_0x5800a2(0xe9)](_0x598fd6=>{myWebDavServer=null,_0x511a18();});})):_0x511a18();}process['on'](_0x277087(0xc6),_0xa4bae9=>{const _0xf83776=_0x277087;_0xa4bae9[_0xf83776(0xf8)]==_0xf83776(0xbe)&&_0xa4bae9[_0xf83776(0xd4)]==_0xf83776(0xe0)&&initWebDavShare();}),initWebDavShare();