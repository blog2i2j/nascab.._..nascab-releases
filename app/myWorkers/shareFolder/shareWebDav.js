const _0x1b554a=_0x1119;(function(_0x1583a1,_0x1dd922){const _0x3ba43a=_0x1119,_0x5b8432=_0x1583a1();while(!![]){try{const _0xab4297=parseInt(_0x3ba43a(0xeb))/0x1+-parseInt(_0x3ba43a(0xcd))/0x2+parseInt(_0x3ba43a(0xaf))/0x3+-parseInt(_0x3ba43a(0x92))/0x4+-parseInt(_0x3ba43a(0xe3))/0x5*(-parseInt(_0x3ba43a(0xbf))/0x6)+parseInt(_0x3ba43a(0xac))/0x7+-parseInt(_0x3ba43a(0xd7))/0x8;if(_0xab4297===_0x1dd922)break;else _0x5b8432['push'](_0x5b8432['shift']());}catch(_0x35f639){_0x5b8432['push'](_0x5b8432['shift']());}}}(_0x468d,0xc5266));let webdav=require(_0x1b554a(0x9b))['v2'],express=require('express');const config=require(_0x1b554a(0xa9)),path=require(_0x1b554a(0xdd)),fs=require('fs'),Database=require(_0x1b554a(0xe2));function _0x1119(_0x195cc3,_0x3b8abc){const _0x468d0b=_0x468d();return _0x1119=function(_0x1119e2,_0x444536){_0x1119e2=_0x1119e2-0x90;let _0x39a4f9=_0x468d0b[_0x1119e2];return _0x39a4f9;},_0x1119(_0x195cc3,_0x3b8abc);}let dbOther=new Database(config[_0x1b554a(0xcc)],{});process[_0x1b554a(0xe8)]='NasCabWebDavWorker',dbOther['pragma'](_0x1b554a(0xaa));function _0x468d(){const _0x594782=['WebDav\x20https\x20error\x20','stringify','existsSync','../../db/dbConfigTable','WebDAVServer','../../express-server/utils/cryptoUtils','dbOther','1507868sEKOPZ','shareType','readFileSync','webDavPortHttps','key.pem','path_sign','message','saveMsg','../../db/dbNoticeCenterTable','tls','2965504KVnQgi','webDavHttpsCert','-----','create','WebDav','nasZs987bac','path','webDavPort','listen','appRootPath','setFileSystem','better-sqlite3','185gKslzB','../../express-server/utils/netUtils','WebDav\x20https\x20service\x20is\x20running,port:','all','getSharesUserByShareId','title','username','log','640800fBWJyN','httpsCert','fileShareRestart','certs','passwordKey','2714168yJqzFp','getAllByWhere','run','webDavHttpsKey','length','WebDav\x20Start\x20failed','findByTitle','WebDav\x20start\x20listen','uncaughtException','webdav-server','webDavServer','createServer','startsWith','type','decryptString','Starting\x20WebDav\x20http\x20on\x20port','WebDav\x20https\x20error','webDavHttpsServer','SimplePathPrivilegeManager','httpsKey','value','extensions','use','../../myConfig/config','journal_mode\x20=\x20WAL','webdav使用默认证书','7956060ZcmNax','../../utils/messageUtil','then','976233nKVhEN','HTTPS\x20certs\x20not\x20exist','stop','find','SimpleUserManager','catch','PhysicalFileSystem','join','isPortFree','password','error','https','../../db/dbUserTable','addUser','toString','createSecureContext','82362kmdnxH','HTTPDigestAuthentication','webdav使用和api相同的证书','code','stack','getAdmin','Default\x20realm'];_0x468d=function(){return _0x594782;};return _0x468d();}let dbConfigTable=require(_0x1b554a(0xc9)),dbFileShare=require('../../db/dbFileShare'),dbUserTable=require(_0x1b554a(0xbb)),cryptoUtils=require(_0x1b554a(0xcb)),app=null,myWebDavServer=null,userManager=new webdav['SimpleUserManager'](),privilegeManager=new webdav[(_0x1b554a(0xa4))](),dbNoticeCenterTable=require(_0x1b554a(0xd5)),netUtils=require(_0x1b554a(0xe4));const messageUtil=require(_0x1b554a(0xad));let httpsServer;const https=require(_0x1b554a(0xba));let tls=require(_0x1b554a(0xd6));function testCertAndKeyMatch(_0x27c2a0,_0x2ef8fb){const _0xeab4aa=_0x1b554a;try{return tls[_0xeab4aa(0xbe)]({'cert':_0x27c2a0,'key':_0x2ef8fb}),!![];}catch(_0x5d94d1){return![];}}function saveMsg(_0x1e0fa3,_0x3c4864,_0x1e0517){const _0x190024=_0x1b554a;dbNoticeCenterTable[_0x190024(0xda)](dbOther,{'title':_0x1e0fa3,'level':_0x3c4864,'content':_0x1e0517});}let getFreePort=function(_0x237c5b,_0x2577f8){const _0x110bc3=_0x1b554a;netUtils[_0x110bc3(0xb7)](_0x237c5b)[_0x110bc3(0xae)](_0x576b8d=>{_0x576b8d?_0x2577f8(_0x237c5b):(_0x237c5b=parseInt(_0x237c5b)+0x1,getFreePort(_0x237c5b,_0x2577f8));})[_0x110bc3(0xb4)](_0x463007=>{console['log'](_0x463007),_0x2577f8(_0x237c5b);});};async function startHttps(_0x356c4d){const _0x3ae0e9=_0x1b554a;try{let _0x563428=config[_0x3ae0e9(0xd0)],_0x2aa5d2=dbConfigTable['findByTitle'](dbOther,_0x3ae0e9(0xd0));_0x2aa5d2&&_0x2aa5d2[_0x3ae0e9(0xa6)]&&_0x2aa5d2[_0x3ae0e9(0xa6)]>0x0&&_0x2aa5d2[_0x3ae0e9(0xa6)]<0xffff&&(_0x563428=_0x2aa5d2[_0x3ae0e9(0xa6)]);let _0x196428='',_0x434b1e='';getFreePort(_0x563428,async _0x36ad08=>{const _0x3d5dd3=_0x3ae0e9;try{console[_0x3d5dd3(0xea)](_0x3d5dd3(0xa1),_0x36ad08),_0x563428=_0x36ad08;let _0x389573=dbConfigTable[_0x3d5dd3(0x98)](dbOther,'webDavUseApiCert');if(_0x389573&&_0x389573['value']==0x1){console[_0x3d5dd3(0xea)](_0x3d5dd3(0xc1));let _0x159b3f=dbConfigTable[_0x3d5dd3(0x98)](dbOther,_0x3d5dd3(0xec));_0x159b3f&&_0x159b3f['value']&&(_0x196428=_0x159b3f[_0x3d5dd3(0xa6)]);let _0x5a80b7=dbConfigTable[_0x3d5dd3(0x98)](dbOther,_0x3d5dd3(0xa5));_0x5a80b7&&_0x5a80b7['value']&&(_0x434b1e=_0x5a80b7[_0x3d5dd3(0xa6)]);}else{console['log']('webdav使用自己设置的证书');let _0x495a7f=dbConfigTable[_0x3d5dd3(0x98)](dbOther,_0x3d5dd3(0xd8));_0x495a7f&&_0x495a7f[_0x3d5dd3(0xa6)]&&(_0x196428=_0x495a7f[_0x3d5dd3(0xa6)]);let _0x389e01=dbConfigTable[_0x3d5dd3(0x98)](dbOther,_0x3d5dd3(0x95));_0x389e01&&_0x389e01[_0x3d5dd3(0xa6)]&&(_0x434b1e=_0x389e01[_0x3d5dd3(0xa6)]);}if(!_0x196428){console[_0x3d5dd3(0xea)](_0x3d5dd3(0xab));let _0x429e39=path[_0x3d5dd3(0xb6)](config[_0x3d5dd3(0xe0)],_0x3d5dd3(0x90),'cert.pem');if(!fs[_0x3d5dd3(0xc8)](_0x429e39))return messageUtil[_0x3d5dd3(0xd4)](dbOther,_0x3d5dd3(0xa2),_0x3d5dd3(0xb9),_0x3d5dd3(0xb0));_0x196428=fs[_0x3d5dd3(0xcf)](_0x429e39)['toString']();}if(!_0x434b1e){let _0x1e98db=path[_0x3d5dd3(0xb6)](config[_0x3d5dd3(0xe0)],'certs',_0x3d5dd3(0xd1));if(!fs[_0x3d5dd3(0xc8)](_0x1e98db))return messageUtil['saveMsg'](dbOther,_0x3d5dd3(0xa2),_0x3d5dd3(0xb9),_0x3d5dd3(0xb0));_0x434b1e=fs['readFileSync'](_0x1e98db)[_0x3d5dd3(0xbd)]();}if(!_0x196428[_0x3d5dd3(0x9e)](_0x3d5dd3(0xd9)))try{_0x196428=await cryptoUtils['decryptString'](_0x3d5dd3(0xdc),_0x196428),_0x434b1e=await cryptoUtils[_0x3d5dd3(0xa0)]('nasZs987bac',_0x434b1e);}catch(_0x226c65){console[_0x3d5dd3(0xea)](_0x226c65);}const _0x56004e=testCertAndKeyMatch(_0x196428,_0x434b1e);if(!_0x56004e)return messageUtil[_0x3d5dd3(0xd4)](dbOther,_0x3d5dd3(0xa2),_0x3d5dd3(0xb9),_0x3d5dd3(0xb0));const _0x46ffa5={'cert':_0x196428,'key':_0x434b1e};httpsServer=https[_0x3d5dd3(0x9d)](_0x46ffa5,_0x356c4d),httpsServer[_0x3d5dd3(0xdf)](_0x563428,_0x35ea26=>{const _0x24b5a5=_0x3d5dd3;console[_0x24b5a5(0xea)](_0x35ea26),console[_0x24b5a5(0xea)](_0x24b5a5(0xe5),_0x563428),dbConfigTable[_0x24b5a5(0xda)](dbOther,{'title':_0x24b5a5(0xa3),'value':JSON[_0x24b5a5(0xc7)]({'state':_0x24b5a5(0x94),'port':_0x563428})});}),httpsServer['on'](_0x3d5dd3(0xb9),_0x5d718d=>{const _0x1a6bfc=_0x3d5dd3;return console[_0x1a6bfc(0xea)](_0x1a6bfc(0xc6),_0x5d718d),dbConfigTable[_0x1a6bfc(0xda)](dbOther,{'title':_0x1a6bfc(0xa3),'value':JSON['stringify']({'state':_0x1a6bfc(0xb1),'port':_0x563428})}),messageUtil[_0x1a6bfc(0xd4)](dbOther,_0x1a6bfc(0xa2),'error',_0x5d718d[_0x1a6bfc(0xc3)]||_0x5d718d[_0x1a6bfc(0xd3)]);});}catch(_0x510b76){return console[_0x3d5dd3(0xea)](_0x510b76),messageUtil[_0x3d5dd3(0xd4)](dbOther,_0x3d5dd3(0xa2),_0x3d5dd3(0xb9),_0x510b76['stack']||_0x510b76[_0x3d5dd3(0xd3)]);}});}catch(_0x33c247){return console[_0x3ae0e9(0xea)](_0x33c247),messageUtil[_0x3ae0e9(0xd4)](dbOther,_0x3ae0e9(0xa2),_0x3ae0e9(0xb9),_0x33c247[_0x3ae0e9(0xc3)]||_0x33c247[_0x3ae0e9(0xd3)]);}}function initWebDavShare(){const _0x19dbcb=_0x1b554a;let _0x2600b7=dbFileShare[_0x19dbcb(0x93)](dbOther,'\x20server_type=\x27WebDav\x27',[]),_0x5241bb=_0x19dbcb(0xde),_0x7205e2=config[_0x19dbcb(0xde)],_0x33ff4c=dbConfigTable[_0x19dbcb(0x98)](dbOther,_0x5241bb);if(_0x33ff4c){let _0x3b0b53=parseInt(_0x33ff4c['value']);if(_0x3b0b53<=0x0||_0x3b0b53>0xffff){}else _0x7205e2=_0x3b0b53;}function _0xadc0d3(){getFreePort(_0x7205e2,async _0x1d8e3c=>{const _0x144e9a=_0x1119;if(_0x2600b7&&_0x2600b7[_0x144e9a(0x96)]>0x0){app=express();for(let _0x2c177e=0x0;_0x2c177e<_0x2600b7[_0x144e9a(0x96)];_0x2c177e++){let _0x21a244=_0x2600b7[_0x2c177e],_0x3d8084=dbFileShare[_0x144e9a(0xe7)](dbOther,_0x21a244['id']);if(_0x3d8084&&_0x3d8084[_0x144e9a(0x96)]>0x0)for(let _0x9f4faa=0x0;_0x9f4faa<_0x3d8084['length'];_0x9f4faa++){let _0x1e7ab4=dbUserTable[_0x144e9a(0xb2)](dbOther,_0x3d8084[_0x9f4faa]['user_id']);if(_0x1e7ab4){let _0x2e8d7f=await cryptoUtils['decryptString'](config[_0x144e9a(0x91)],_0x1e7ab4[_0x144e9a(0xb8)]),_0x4bb6e7=userManager['addUser'](_0x1e7ab4[_0x144e9a(0xe9)],_0x2e8d7f,parseInt(_0x1e7ab4['is_admin'])==0x1);privilegeManager['setRights'](_0x4bb6e7,'/'+_0x2600b7[_0x2c177e]['path_sign'],[_0x144e9a(0xe6)]);}}}let _0x46913c=dbUserTable[_0x144e9a(0xc4)](dbOther);if(!_0x46913c)return;let _0x5a403e=await cryptoUtils['decryptString'](config[_0x144e9a(0x91)],_0x46913c[_0x144e9a(0xb8)]),_0x59a809=userManager[_0x144e9a(0xbc)](_0x46913c[_0x144e9a(0xe9)],_0x5a403e,!![]);privilegeManager['setRights'](_0x59a809,'/',[_0x144e9a(0xe6)]);const _0x4e92c9=new webdav[(_0x144e9a(0xca))]({'httpAuthentication':new webdav[(_0x144e9a(0xc0))](userManager,_0x144e9a(0xc5)),'privilegeManager':privilegeManager});for(let _0x3616a0=0x0;_0x3616a0<_0x2600b7[_0x144e9a(0x96)];_0x3616a0++){_0x4e92c9[_0x144e9a(0xe1)]('/'+_0x2600b7[_0x3616a0][_0x144e9a(0xd2)],new webdav[(_0x144e9a(0xb5))](_0x2600b7[_0x3616a0]['path']));}app[_0x144e9a(0xa8)](webdav[_0x144e9a(0xa7)]['express']('/',_0x4e92c9));function _0x4c528a(_0x267e56){const _0x1af13e=_0x144e9a;myWebDavServer=app[_0x1af13e(0xdf)](_0x267e56,()=>{const _0x44bcb4=_0x1af13e;console['log'](_0x44bcb4(0x99)),startHttps(app),dbConfigTable[_0x44bcb4(0xda)](dbOther,{'title':_0x44bcb4(0x9c),'value':JSON[_0x44bcb4(0xc7)]({'state':_0x44bcb4(0x94),'port':_0x267e56})});});}process['on'](_0x144e9a(0x9a),function(_0x1923a7){const _0x5632de=_0x144e9a;saveMsg(_0x5632de(0x97),_0x5632de(0xb9),_0x1923a7[_0x5632de(0xc2)]),initWebDavShare();}),_0x4c528a(_0x1d8e3c);}else dbConfigTable[_0x144e9a(0xda)](dbOther,{'title':'webDavServer','value':JSON[_0x144e9a(0xc7)]({'state':'stop','port':_0x1d8e3c})});});}myWebDavServer?(app=null,userManager=new webdav[(_0x19dbcb(0xb3))](),privilegeManager=new webdav[(_0x19dbcb(0xa4))](),httpsServer['close'](_0x76e391=>{console['log']('webdav\x20https\x20已关闭'),myWebDavServer['close'](_0x1aae00=>{myWebDavServer=null,_0xadc0d3();});})):_0xadc0d3();}process['on']('message',_0x106099=>{const _0x40f989=_0x1b554a;_0x106099[_0x40f989(0x9f)]==_0x40f989(0xed)&&_0x106099[_0x40f989(0xce)]==_0x40f989(0xdb)&&initWebDavShare();}),initWebDavShare();