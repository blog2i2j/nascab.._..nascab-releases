const _0x59f6ae=_0x5dec;(function(_0x177a59,_0x182f7a){const _0x4caffe=_0x5dec,_0x46e95b=_0x177a59();while(!![]){try{const _0x5ca0b0=-parseInt(_0x4caffe(0xdb))/0x1*(-parseInt(_0x4caffe(0xcf))/0x2)+-parseInt(_0x4caffe(0xf7))/0x3*(parseInt(_0x4caffe(0x10e))/0x4)+-parseInt(_0x4caffe(0x104))/0x5*(parseInt(_0x4caffe(0xd2))/0x6)+-parseInt(_0x4caffe(0x11d))/0x7*(parseInt(_0x4caffe(0xd0))/0x8)+-parseInt(_0x4caffe(0xf0))/0x9+parseInt(_0x4caffe(0xe6))/0xa+parseInt(_0x4caffe(0xf3))/0xb*(parseInt(_0x4caffe(0x118))/0xc);if(_0x5ca0b0===_0x182f7a)break;else _0x46e95b['push'](_0x46e95b['shift']());}catch(_0x722be){_0x46e95b['push'](_0x46e95b['shift']());}}}(_0xbd94,0x95be9));const Database=require(_0x59f6ae(0x10f)),config=require('../../myConfig/config');let dbOther=new Database(config[_0x59f6ae(0x10c)],{});dbOther['pragma']('journal_mode\x20=\x20WAL');let moment=require('moment'),path=require(_0x59f6ae(0xfc)),fs=require('fs'),i18nUtil=require(_0x59f6ae(0xfa)),i18n=i18nUtil[_0x59f6ae(0x116)](dbOther);process[_0x59f6ae(0x11e)]=_0x59f6ae(0x108);let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x285932,_0x9af0d2,_0x25ef68,_0x1be7a2){const _0x1243c4=_0x59f6ae;try{let _0x4dd4bd=dbOther[_0x1243c4(0x112)](_0x1243c4(0xf4)+_0x9af0d2)[_0x1243c4(0xe3)]();if(_0x4dd4bd[_0x1243c4(0x109)]!=_0x1243c4(0xea))return paused=!![],![];let _0x5530cb=fs['statSync'](_0x25ef68);filesCount+=0x1,totalSize+=_0x5530cb[_0x1243c4(0xe1)];let _0x1fb3ac=!![];if(!fs[_0x1243c4(0x110)](_0x1be7a2))fs['cpSync'](_0x25ef68,_0x1be7a2,{'preserveTimestamps':!![]}),copySize+=_0x5530cb['size'],copyFileCount+=0x1;else{let _0x2b1177=fs['statSync'](_0x1be7a2);_0x5530cb[_0x1243c4(0xe1)]==_0x2b1177[_0x1243c4(0xe1)]&&Math['abs'](_0x5530cb[_0x1243c4(0xe5)]-_0x2b1177[_0x1243c4(0xe5)])<=0x3e8?_0x1fb3ac=![]:(fs[_0x1243c4(0xe7)](_0x25ef68,_0x1be7a2,{'preserveTimestamps':!![]}),copySize+=_0x5530cb[_0x1243c4(0xe1)],copyFileCount+=0x1);}return _0x1fb3ac&&updateTaskRecord(_0x9af0d2,_0x1243c4(0xcd)+copySize+_0x1243c4(0x115)+copyFileCount),!![];}catch(_0x2f2dc1){return addTaskMsg(_0x285932,_0x9af0d2,'ERROR',_0x25ef68+':'+i18n['__'](_0x1243c4(0x10a))+_0x1243c4(0x102)+JSON[_0x1243c4(0xf8)](_0x2f2dc1)),!![];}}function matchRuleShort(_0x120ed9,_0x2c732a){const _0x2ceb9b=_0x59f6ae;var _0x420f3b=_0xf71124=>_0xf71124['replace'](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x2ceb9b(0xd1));return new RegExp('^'+_0x2c732a[_0x2ceb9b(0x117)]('*')[_0x2ceb9b(0xff)](_0x420f3b)[_0x2ceb9b(0x111)]('.*')+'$')[_0x2ceb9b(0xfe)](_0x120ed9);}function copyFolder(_0xab857c,_0x1c755c,_0x9a8f79,_0x3faad0,_0x37b393){const _0x7a6a8d=_0x59f6ae;let _0x37405b=_0xab857c['id'],_0x2e7546=checkFolderPower(_0x3faad0,!![]);if(!_0x2e7546)addTaskMsg(_0x37405b,_0x1c755c,'ERROR',i18n['__'](_0x7a6a8d(0x11b))+':'+_0x3faad0);else try{let _0x57b68f=fs[_0x7a6a8d(0xd6)](_0x3faad0);for(let _0x338afb=0x0;_0x338afb<_0x57b68f['length'];_0x338afb++){let _0x50df6b=_0x57b68f[_0x338afb];var _0x38d817=path['join'](_0x3faad0,_0x50df6b);let _0x15f3a2=fs[_0x7a6a8d(0xf6)](_0x38d817);var _0x6c8a73=_0x15f3a2[_0x7a6a8d(0x11c)](),_0x41bc28=_0x15f3a2[_0x7a6a8d(0xda)]();if(_0x6c8a73){if(excludeList[_0x7a6a8d(0xd9)](_0x50df6b))continue;if(_0xab857c['exclude_list']&&_0xab857c[_0x7a6a8d(0xef)]['length']>0x0){let _0x6fc321=JSON['parse'](_0xab857c[_0x7a6a8d(0xef)]),_0x3901dc=!![];for(let _0x13b9ff in _0x6fc321){if(_0x6fc321[_0x13b9ff][_0x7a6a8d(0xd9)]('*')){if(matchRuleShort(_0x50df6b,_0x6fc321[_0x13b9ff])){_0x3901dc=![];break;}}else{if(_0x6fc321[_0x13b9ff]==_0x50df6b){_0x3901dc=![];break;}}}if(!_0x3901dc){excludeCount+=0x1;continue;}}let _0x58644a=path['join'](_0x37b393,path['basename'](_0x9a8f79),_0x38d817[_0x7a6a8d(0x113)](_0x9a8f79[_0x7a6a8d(0xd8)])),_0x3061b0=copyFile(_0x37405b,_0x1c755c,_0x38d817,_0x58644a);if(_0x3061b0===![])return![];}else _0x41bc28&&copyFolder(_0xab857c,_0x1c755c,_0x9a8f79,_0x38d817,_0x37b393);}}catch(_0x549adf){addTaskMsg(_0x37405b,_0x1c755c,'ERROR',i18n['__'](_0x7a6a8d(0x103))+':'+_0x3faad0);}}function reverseCheck(_0x6b6f0,_0x423ce1,_0x2cb3ad,_0x4555b4,_0x10d907){const _0x1081c5=_0x59f6ae;try{if(!fs[_0x1081c5(0x110)](_0x10d907))return;let _0x5e88b7=fs['readdirSync'](_0x10d907);for(let _0x2d3bca=0x0;_0x2d3bca<_0x5e88b7[_0x1081c5(0xd8)];_0x2d3bca++){let _0x3981d8=_0x5e88b7[_0x2d3bca];var _0x24c5b3=path[_0x1081c5(0x111)](_0x10d907,_0x3981d8);let _0x392f89=fs['statSync'](_0x24c5b3);var _0x270f3d=_0x392f89[_0x1081c5(0x11c)](),_0x1eaf5a=_0x392f89['isDirectory']();let _0xe0108c=path[_0x1081c5(0x111)](_0x4555b4,_0x24c5b3[_0x1081c5(0x113)](_0x2cb3ad[_0x1081c5(0xd8)]));if(_0x270f3d)!fs[_0x1081c5(0x110)](_0xe0108c)&&fs[_0x1081c5(0x100)](_0x24c5b3,{'force':!![],'maxRetries':0xa});else _0x1eaf5a&&(!fs[_0x1081c5(0x110)](_0xe0108c)?fs[_0x1081c5(0xde)](_0x24c5b3,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x6b6f0,_0x423ce1,_0x2cb3ad,_0x4555b4,_0x24c5b3));}}catch(_0x2a701b){addTaskMsg(_0x6b6f0,_0x423ce1,_0x1081c5(0xec),i18n['__'](_0x1081c5(0x103))+':'+_0x4555b4);}}function _0x5dec(_0x944a1e,_0x44a295){const _0xbd942f=_0xbd94();return _0x5dec=function(_0x5decbf,_0x356ee6){_0x5decbf=_0x5decbf-0xcb;let _0x1287a5=_0xbd942f[_0x5decbf];return _0x1287a5;},_0x5dec(_0x944a1e,_0x44a295);}function updateTaskRecord(_0x4eb445,_0x5bddbe){const _0x474bef=_0x59f6ae;let _0x2bdc12='UPDATE\x20backup_task_record\x20SET\x20';_0x2bdc12+=_0x5bddbe,_0x2bdc12+=_0x474bef(0xdf)+_0x4eb445,dbOther[_0x474bef(0x106)](_0x2bdc12);}function setTaskOver(_0x397b33){const _0x50e93b=_0x59f6ae;let _0x2f062a=dbOther['prepare'](_0x50e93b(0x11f)+_0x397b33['id'])[_0x50e93b(0xe3)](),_0x5d4cef=moment()['format'](_0x50e93b(0xd3));updateTaskRecord(_0x397b33['id'],_0x50e93b(0xcd)+copySize+_0x50e93b(0x115)+copyFileCount+',exclude_count='+excludeCount+_0x50e93b(0xed)+_0x2f062a['count']+_0x50e93b(0xe9)+filesCount+_0x50e93b(0xfd)+totalSize+_0x50e93b(0x11a)+_0x5d4cef+'\x27');}function addTaskMsg(_0x17f976,_0x1fbacc,_0x5ef126,_0x3d1571){const _0x389d94=_0x59f6ae,_0x2e2eca='REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)';return dbOther[_0x389d94(0x112)](_0x2e2eca)[_0x389d94(0xe8)](''+_0x17f976,''+_0x1fbacc,''+_0x5ef126,''+_0x3d1571);}function checkFolderPower(_0x558d5e,_0x29f913){const _0x4d4246=_0x59f6ae;try{return _0x29f913?fs[_0x4d4246(0xe2)](_0x558d5e,fs[_0x4d4246(0xf9)][_0x4d4246(0xce)]):fs[_0x4d4246(0xe2)](_0x558d5e,fs[_0x4d4246(0xf9)][_0x4d4246(0xce)]|fs[_0x4d4246(0xf9)]['W_OK']),!![];}catch(_0x3e9105){return![];}}function exeTask(_0x270beb){const _0x4e68ef=_0x59f6ae;let _0x2ca0cb=_0x4e68ef(0xf5),_0x4fb533=dbOther[_0x4e68ef(0x112)](_0x2ca0cb)[_0x4e68ef(0xe3)]();if(_0x4fb533){let _0x4fedee='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20'+_0x4fb533['task_id'],_0x41658a=dbOther[_0x4e68ef(0x112)](_0x4fedee)['get']();if(!fs[_0x4e68ef(0x110)](_0x41658a[_0x4e68ef(0x119)]))return addTaskMsg(_0x41658a['id'],_0x4fb533['id'],_0x4e68ef(0xec),i18n['__'](_0x4e68ef(0xe4))+':'+_0x41658a[_0x4e68ef(0x119)]),setTaskOver(_0x4fb533),_0x270beb();let _0x2a66ce=checkFolderPower(_0x41658a[_0x4e68ef(0x119)]);if(!_0x2a66ce)return addTaskMsg(_0x41658a['id'],_0x4fb533['id'],_0x4e68ef(0xec),i18n['__'](_0x4e68ef(0x11b))+':'+_0x41658a[_0x4e68ef(0x119)]),setTaskOver(_0x4fb533),_0x270beb();updateTaskRecord(_0x4fb533['id'],'status=\x27running\x27');let _0x315ccc=JSON[_0x4e68ef(0x114)](_0x41658a[_0x4e68ef(0x10d)]);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0x4a388e in _0x315ccc){try{if(fs[_0x4e68ef(0x110)](_0x315ccc[_0x4a388e])){copyFolder(_0x41658a,_0x4fb533['id'],_0x315ccc[_0x4a388e],_0x315ccc[_0x4a388e],_0x41658a[_0x4e68ef(0x119)]);if(!paused){let _0x1ced6a=path[_0x4e68ef(0x111)](_0x41658a['target_path'],path[_0x4e68ef(0xcb)](_0x315ccc[_0x4a388e]));reverseCheck(_0x41658a['id'],_0x4fb533['id'],_0x1ced6a,_0x315ccc[_0x4a388e],_0x1ced6a);}}else addTaskMsg(_0x41658a['id'],_0x4fb533['id'],'ERROR',i18n['__']('folderNotExist')+':'+_0x315ccc[_0x4a388e]);}catch(_0x51143e){addTaskMsg(_0x41658a['id'],_0x4fb533['id'],_0x4e68ef(0xec),i18n['__'](_0x4e68ef(0x10a))+':'+_0x315ccc[_0x4a388e]+':'+JSON['stringify'](_0x51143e));}}!paused&&setTaskOver(_0x4fb533),_0x270beb();}else setTimeout(()=>{_0x270beb();},0x2710);}function runInfinit(){return new Promise(_0x1e167e=>{exeTask(_0x1e167e);});}async function runBacupExe(){const _0x1a6fcc=_0x59f6ae;runInfinit()[_0x1a6fcc(0xdd)](()=>{runBacupExe();});}dbOther[_0x59f6ae(0x106)](_0x59f6ae(0xf2)),runBacupExe();function addTask(_0x30520f){const _0x3e4073=_0x59f6ae;let _0x3d8dcf=dbOther[_0x3e4073(0x112)](_0x30520f)['all']();if(_0x3d8dcf[_0x3e4073(0xd8)]>0x0)for(let _0x428afa=0x0;_0x428afa<_0x3d8dcf[_0x3e4073(0xd8)];_0x428afa++){let _0x461a87=_0x3d8dcf[_0x428afa],_0x44afb3=moment(new Date()['getTime']()-0xea60)[_0x3e4073(0xcc)](_0x3e4073(0xd3)),_0x541ca9=_0x3e4073(0xf1)+_0x461a87['id']+'\x20and\x20(start_time>=\x27'+_0x44afb3+_0x3e4073(0xe0),_0x509344=dbOther[_0x3e4073(0x112)](_0x541ca9)[_0x3e4073(0xe3)]();if(_0x509344[_0x3e4073(0x10b)]<0x1){let _0x41e65a=moment()[_0x3e4073(0xcc)]('YYYY-MM-DD\x20HH:mm:ss');const _0x158274=_0x3e4073(0xfb)+_0x461a87['id']+'\x27,\x20\x27waiting\x27,\x27'+_0x41e65a+'\x27)';return dbOther['exec'](_0x158274);}else{}}}function _0xbd94(){const _0x51a041=['getMonth','ERROR',',status=\x27done\x27,fail_count=','%\x27)','exclude_list','10443393ayeHuD','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','12218195yXkjWX','select\x20status\x20from\x20backup_task_record\x20where\x20id=','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','statSync','1144257SJoRHn','stringify','constants','../../utils/i18nUtil','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','path',',total_size=','test','map','rmSync','send','\x20ERROR:','ReadFolderFail','989525RWHfpQ','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27','exec','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','NasCabBackupWorker','status','fileCopyFail','count','dbOther','source_list','4gtFNAy','better-sqlite3','existsSync','join','prepare','substring','parse',',copy_count=','getI18n','split','12BDqbLF','target_path',',end_time=\x27','noWritePermission','isFile','626605KtbpoI','title','select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id=','getDay','basename','format','copy_size=','R_OK','1356980wrdJPE','24dqkzmR','\x5c$1','12iWtYZy','YYYY-MM-DD\x20HH:mm:ss','getHours','getDate','readdirSync','\x27\x20AND\x20task_time\x20LIKE\x20\x27','length','includes','isDirectory','1abdMmE','close','then','rmdirSync','\x20WHERE\x20id=','\x27\x20or\x20status!=\x27done\x27)','size','accessSync','get','targetFolderNotExist','mtimeMs','10302690xoSFBD','cpSync','run',',files_count=','running'];_0xbd94=function(){return _0x51a041;};return _0xbd94();}function add0(_0x2c31cf){return _0x2c31cf<0xa?'0'+_0x2c31cf:_0x2c31cf;}function getYmd(_0x78ebfe){const _0x1efdd7=_0x59f6ae;var _0xe625d2=_0x78ebfe['getFullYear'](),_0x3eb403=_0x78ebfe[_0x1efdd7(0xeb)]()+0x1,_0x11d3e7=_0x78ebfe['getDate']();return _0xe625d2+'-'+add0(_0x3eb403)+'-'+add0(_0x11d3e7);}function runBackupCheck(){setInterval(()=>{const _0x1b857f=_0x5dec;let _0x5d8783=new Date(),_0x285ac0=_0x5d8783[_0x1b857f(0x120)](),_0x113a4f=_0x5d8783[_0x1b857f(0xd5)](),_0x504048=add0(_0x5d8783[_0x1b857f(0xd4)]()),_0x364745=add0(_0x5d8783['getMinutes']()),_0x50ff86=getYmd(_0x5d8783),_0x46c422=_0x1b857f(0x107)+_0x50ff86+_0x1b857f(0xd7)+_0x504048+':'+_0x364745+_0x1b857f(0xee);addTask(_0x46c422);let _0x5255e3=_0x1b857f(0x105)+_0x504048+':'+_0x364745+_0x1b857f(0xee);addTask(_0x5255e3);let _0xa528a8='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27'+_0x285ac0+'\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x504048+':'+_0x364745+_0x1b857f(0xee);addTask(_0xa528a8);let _0x4b18a8='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27'+_0x113a4f+_0x1b857f(0xd7)+_0x504048+':'+_0x364745+_0x1b857f(0xee);addTask(_0x4b18a8);},0x3a98);}runBackupCheck(),process['on']('exit',(_0x59ea1a,_0x27ff95)=>{const _0x427736=_0x59f6ae;process[_0x427736(0x101)]({'type':_0x427736(0xdc)});});