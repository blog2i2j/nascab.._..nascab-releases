const _0x2ea2dd=_0xf3a5;(function(_0x5ad5e5,_0x40d355){const _0x12f322=_0xf3a5,_0xfad05d=_0x5ad5e5();while(!![]){try{const _0x1ed435=parseInt(_0x12f322(0x15a))/0x1+parseInt(_0x12f322(0x162))/0x2*(parseInt(_0x12f322(0x168))/0x3)+-parseInt(_0x12f322(0x149))/0x4+-parseInt(_0x12f322(0x140))/0x5+-parseInt(_0x12f322(0x127))/0x6+parseInt(_0x12f322(0x12f))/0x7+parseInt(_0x12f322(0x120))/0x8*(-parseInt(_0x12f322(0x152))/0x9);if(_0x1ed435===_0x40d355)break;else _0xfad05d['push'](_0xfad05d['shift']());}catch(_0x3859ef){_0xfad05d['push'](_0xfad05d['shift']());}}}(_0x2b5e,0x61cbf));const Database=require(_0x2ea2dd(0x14e)),config=require(_0x2ea2dd(0x143));let dbOther=new Database(config[_0x2ea2dd(0x167)],{});dbOther[_0x2ea2dd(0x150)]('journal_mode\x20=\x20WAL');let moment=require(_0x2ea2dd(0x163)),path=require('path'),fs=require('fs'),i18nUtil=require(_0x2ea2dd(0x145)),i18n=i18nUtil[_0x2ea2dd(0x11b)](dbOther);process['title']=_0x2ea2dd(0x11a);let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0xe8f1fd,_0x996b94,_0x6eed81,_0x20f39c){const _0x311032=_0x2ea2dd;try{let _0x1f122f=dbOther['prepare']('select\x20status\x20from\x20backup_task_record\x20where\x20id='+_0x996b94)[_0x311032(0x156)]();if(_0x1f122f[_0x311032(0x144)]!=_0x311032(0x14c))return paused=!![],![];let _0x2660d2=fs[_0x311032(0x15d)](_0x6eed81);filesCount+=0x1,totalSize+=_0x2660d2[_0x311032(0x138)];let _0x11624f=!![];if(!fs['existsSync'](_0x20f39c))fs[_0x311032(0x157)](_0x6eed81,_0x20f39c,{'preserveTimestamps':!![]}),copySize+=_0x2660d2[_0x311032(0x138)],copyFileCount+=0x1;else{let _0x36f3aa=fs['statSync'](_0x20f39c);_0x2660d2[_0x311032(0x138)]==_0x36f3aa[_0x311032(0x138)]&&Math[_0x311032(0x116)](_0x2660d2[_0x311032(0x115)]-_0x36f3aa[_0x311032(0x115)])<=0x3e8?_0x11624f=![]:(fs[_0x311032(0x157)](_0x6eed81,_0x20f39c,{'preserveTimestamps':!![]}),copySize+=_0x2660d2[_0x311032(0x138)],copyFileCount+=0x1);}return _0x11624f&&updateTaskRecord(_0x996b94,_0x311032(0x11c)+copySize+_0x311032(0x151)+copyFileCount),!![];}catch(_0x57481b){return addTaskMsg(_0xe8f1fd,_0x996b94,_0x311032(0x114),_0x6eed81+':'+i18n['__'](_0x311032(0x160))+_0x311032(0x12d)+JSON[_0x311032(0x12e)](_0x57481b)),!![];}}function matchRuleShort(_0x404477,_0x12d06b){const _0xa7270a=_0x2ea2dd;var _0xd4f4d7=_0x1c369a=>_0x1c369a[_0xa7270a(0x13a)](/([.*+?^=!:${}()|\[\]\/\\])/g,'\x5c$1');return new RegExp('^'+_0x12d06b[_0xa7270a(0x131)]('*')['map'](_0xd4f4d7)[_0xa7270a(0x126)]('.*')+'$')['test'](_0x404477);}function copyFolder(_0x18453e,_0x3f9295,_0x16e8f8,_0x34ec92,_0x2c059d){const _0x146d57=_0x2ea2dd;let _0x5aff9f=_0x18453e['id'],_0x5207f1=checkFolderPower(_0x34ec92,!![]);if(!_0x5207f1)addTaskMsg(_0x5aff9f,_0x3f9295,_0x146d57(0x114),i18n['__'](_0x146d57(0x161))+':'+_0x34ec92);else try{let _0x515290=fs[_0x146d57(0x164)](_0x34ec92);for(let _0x12091a=0x0;_0x12091a<_0x515290[_0x146d57(0x124)];_0x12091a++){let _0x2ad716=_0x515290[_0x12091a];var _0x447a84=path[_0x146d57(0x126)](_0x34ec92,_0x2ad716);let _0x5d5ed1=fs['statSync'](_0x447a84);var _0x2e27d9=_0x5d5ed1[_0x146d57(0x136)](),_0x2aea93=_0x5d5ed1[_0x146d57(0x15c)]();if(_0x2e27d9){if(excludeList[_0x146d57(0x133)](_0x2ad716))continue;if(_0x18453e[_0x146d57(0x12a)]&&_0x18453e[_0x146d57(0x12a)][_0x146d57(0x124)]>0x0){let _0x149e08=JSON['parse'](_0x18453e['exclude_list']),_0x344870=!![];for(let _0x542215 in _0x149e08){if(_0x149e08[_0x542215][_0x146d57(0x133)]('*')){if(matchRuleShort(_0x2ad716,_0x149e08[_0x542215])){_0x344870=![];break;}}else{if(_0x149e08[_0x542215]==_0x2ad716){_0x344870=![];break;}}}if(!_0x344870){excludeCount+=0x1;continue;}}let _0x1195e9=path['join'](_0x2c059d,path[_0x146d57(0x13e)](_0x16e8f8),_0x447a84[_0x146d57(0x11e)](_0x16e8f8[_0x146d57(0x124)])),_0x420892=copyFile(_0x5aff9f,_0x3f9295,_0x447a84,_0x1195e9);if(_0x420892===![])return![];}else _0x2aea93&&copyFolder(_0x18453e,_0x3f9295,_0x16e8f8,_0x447a84,_0x2c059d);}}catch(_0x5c4ddc){addTaskMsg(_0x5aff9f,_0x3f9295,_0x146d57(0x114),i18n['__'](_0x146d57(0x11f))+':'+_0x34ec92);}}function reverseCheck(_0xbf5efe,_0x35e600,_0x50ef9e,_0x354eb0,_0x4f37df){const _0x84a214=_0x2ea2dd;try{if(!fs['existsSync'](_0x4f37df))return;let _0x1553fe=fs[_0x84a214(0x164)](_0x4f37df);for(let _0x5e675f=0x0;_0x5e675f<_0x1553fe['length'];_0x5e675f++){let _0x28a49c=_0x1553fe[_0x5e675f];var _0x386b90=path[_0x84a214(0x126)](_0x4f37df,_0x28a49c);let _0x261103=fs['statSync'](_0x386b90);var _0x59dd24=_0x261103[_0x84a214(0x136)](),_0x2868a3=_0x261103[_0x84a214(0x15c)]();let _0xa2294f=path[_0x84a214(0x126)](_0x354eb0,_0x386b90['substring'](_0x50ef9e[_0x84a214(0x124)]));if(_0x59dd24)!fs['existsSync'](_0xa2294f)&&fs['rmSync'](_0x386b90,{'force':!![],'maxRetries':0xa});else _0x2868a3&&(!fs[_0x84a214(0x154)](_0xa2294f)?fs['rmdirSync'](_0x386b90,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0xbf5efe,_0x35e600,_0x50ef9e,_0x354eb0,_0x386b90));}}catch(_0x666b9d){addTaskMsg(_0xbf5efe,_0x35e600,'ERROR',i18n['__'](_0x84a214(0x11f))+':'+_0x354eb0);}}function updateTaskRecord(_0x29babb,_0x3bd213){const _0x59c2b=_0x2ea2dd;let _0x406c80='UPDATE\x20backup_task_record\x20SET\x20';_0x406c80+=_0x3bd213,_0x406c80+=_0x59c2b(0x153)+_0x29babb,dbOther[_0x59c2b(0x130)](_0x406c80);}function setTaskOver(_0x556fec){const _0x1b80b2=_0x2ea2dd;let _0x20e4f7=dbOther[_0x1b80b2(0x155)]('select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id='+_0x556fec['id'])[_0x1b80b2(0x156)](),_0x12f723=moment()[_0x1b80b2(0x13f)](_0x1b80b2(0x13c));updateTaskRecord(_0x556fec['id'],_0x1b80b2(0x11c)+copySize+_0x1b80b2(0x151)+copyFileCount+',exclude_count='+excludeCount+_0x1b80b2(0x166)+_0x20e4f7[_0x1b80b2(0x15e)]+_0x1b80b2(0x15b)+filesCount+_0x1b80b2(0x139)+totalSize+',end_time=\x27'+_0x12f723+'\x27');}function addTaskMsg(_0x2a7657,_0x1f8a25,_0x399a35,_0x3eb252){const _0x2d6e5a=_0x2ea2dd,_0x59b9e1=_0x2d6e5a(0x117);return dbOther['prepare'](_0x59b9e1)[_0x2d6e5a(0x118)](''+_0x2a7657,''+_0x1f8a25,''+_0x399a35,''+_0x3eb252);}function checkFolderPower(_0x489661,_0xd4e8c5){const _0x3f3527=_0x2ea2dd;try{return _0xd4e8c5?fs[_0x3f3527(0x142)](_0x489661,fs['constants'][_0x3f3527(0x122)]):fs[_0x3f3527(0x142)](_0x489661,fs[_0x3f3527(0x129)]['R_OK']|fs['constants'][_0x3f3527(0x12c)]),!![];}catch(_0x3bccaf){return![];}}function exeTask(_0x53987e){const _0x23cc73=_0x2ea2dd;let _0x20243d=_0x23cc73(0x132),_0x54756a=dbOther['prepare'](_0x20243d)[_0x23cc73(0x156)]();if(_0x54756a){let _0x15f81f='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20'+_0x54756a[_0x23cc73(0x158)],_0x4ddef1=dbOther['prepare'](_0x15f81f)[_0x23cc73(0x156)]();if(!fs['existsSync'](_0x4ddef1['target_path']))return addTaskMsg(_0x4ddef1['id'],_0x54756a['id'],_0x23cc73(0x114),i18n['__'](_0x23cc73(0x165))+':'+_0x4ddef1[_0x23cc73(0x147)]),setTaskOver(_0x54756a),_0x53987e();let _0x1f4904=checkFolderPower(_0x4ddef1[_0x23cc73(0x147)]);if(!_0x1f4904)return addTaskMsg(_0x4ddef1['id'],_0x54756a['id'],_0x23cc73(0x114),i18n['__'](_0x23cc73(0x161))+':'+_0x4ddef1[_0x23cc73(0x147)]),setTaskOver(_0x54756a),_0x53987e();updateTaskRecord(_0x54756a['id'],_0x23cc73(0x14a));let _0x47045a=JSON[_0x23cc73(0x146)](_0x4ddef1['source_list']);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0xcf2a2e in _0x47045a){try{if(fs[_0x23cc73(0x154)](_0x47045a[_0xcf2a2e])){copyFolder(_0x4ddef1,_0x54756a['id'],_0x47045a[_0xcf2a2e],_0x47045a[_0xcf2a2e],_0x4ddef1['target_path']);if(!paused){let _0x471298=path['join'](_0x4ddef1['target_path'],path[_0x23cc73(0x13e)](_0x47045a[_0xcf2a2e]));reverseCheck(_0x4ddef1['id'],_0x54756a['id'],_0x471298,_0x47045a[_0xcf2a2e],_0x471298);}}else addTaskMsg(_0x4ddef1['id'],_0x54756a['id'],_0x23cc73(0x114),i18n['__']('folderNotExist')+':'+_0x47045a[_0xcf2a2e]);}catch(_0x14d77d){addTaskMsg(_0x4ddef1['id'],_0x54756a['id'],'ERROR',i18n['__'](_0x23cc73(0x160))+':'+_0x47045a[_0xcf2a2e]+':'+JSON[_0x23cc73(0x12e)](_0x14d77d));}}!paused&&setTaskOver(_0x54756a),_0x53987e();}else setTimeout(()=>{_0x53987e();},0x2710);}function runInfinit(){return new Promise(_0x171c72=>{exeTask(_0x171c72);});}async function runBacupExe(){const _0x3e37bc=_0x2ea2dd;runInfinit()[_0x3e37bc(0x135)](()=>{runBacupExe();});}dbOther[_0x2ea2dd(0x130)]('UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27'),runBacupExe();function addTask(_0x1a2a8){const _0x1caca2=_0x2ea2dd;let _0x4727d5=dbOther[_0x1caca2(0x155)](_0x1a2a8)['all']();if(_0x4727d5['length']>0x0)for(let _0x3e6d9b=0x0;_0x3e6d9b<_0x4727d5[_0x1caca2(0x124)];_0x3e6d9b++){let _0x3d407b=_0x4727d5[_0x3e6d9b],_0x2d7438=moment(new Date()[_0x1caca2(0x13d)]()-0xea60)[_0x1caca2(0x13f)](_0x1caca2(0x13c)),_0x14c0e6=_0x1caca2(0x14b)+_0x3d407b['id']+_0x1caca2(0x134)+_0x2d7438+_0x1caca2(0x13b),_0x433dce=dbOther[_0x1caca2(0x155)](_0x14c0e6)['get']();if(_0x433dce['count']<0x1){let _0x1dadb3=moment()[_0x1caca2(0x13f)]('YYYY-MM-DD\x20HH:mm:ss');const _0x376acb=_0x1caca2(0x12b)+_0x3d407b['id']+'\x27,\x20\x27waiting\x27,\x27'+_0x1dadb3+'\x27)';return dbOther[_0x1caca2(0x130)](_0x376acb);}else{}}}function _0xf3a5(_0x2bfaee,_0x3a5235){const _0x2b5e99=_0x2b5e();return _0xf3a5=function(_0xf3a526,_0x456341){_0xf3a526=_0xf3a526-0x114;let _0x49b40a=_0x2b5e99[_0xf3a526];return _0x49b40a;},_0xf3a5(_0x2bfaee,_0x3a5235);}function add0(_0x36d0a5){return _0x36d0a5<0xa?'0'+_0x36d0a5:_0x36d0a5;}function getYmd(_0x10cde5){const _0x3787bc=_0x2ea2dd;var _0x28a5cd=_0x10cde5[_0x3787bc(0x148)](),_0x1d4b33=_0x10cde5[_0x3787bc(0x14d)]()+0x1,_0x262c03=_0x10cde5[_0x3787bc(0x11d)]();return _0x28a5cd+'-'+add0(_0x1d4b33)+'-'+add0(_0x262c03);}function _0x2b5e(){const _0x55ecef=['statSync','count','send','fileCopyFail','noWritePermission','2uFOPca','moment','readdirSync','targetFolderNotExist',',status=\x27done\x27,fail_count=','dbOther','1411383IBeOpo','ERROR','mtimeMs','abs','REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)','run','getHours','NasCabBackupWorker','getI18n','copy_size=','getDate','substring','ReadFolderFail','4016vbAWby','getMinutes','R_OK','close','length','exit','join','3733338FOTIOV','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27','constants','exclude_list','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','W_OK','\x20ERROR:','stringify','5323486kTUVDh','exec','split','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','includes','\x20and\x20(start_time>=\x27','then','isFile','\x27\x20AND\x20task_time\x20LIKE\x20\x27','size',',total_size=','replace','\x27\x20or\x20status!=\x27done\x27)','YYYY-MM-DD\x20HH:mm:ss','getTime','basename','format','2104285hGNeGy','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27','accessSync','../../myConfig/config','status','../../utils/i18nUtil','parse','target_path','getFullYear','356712VVzVUN','status=\x27running\x27','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','running','getMonth','better-sqlite3','%\x27)','pragma',',copy_count=','279owfYdK','\x20WHERE\x20id=','existsSync','prepare','get','cpSync','task_id','getDay','317436LWzCfu',',files_count=','isDirectory'];_0x2b5e=function(){return _0x55ecef;};return _0x2b5e();}function runBackupCheck(){setInterval(()=>{const _0x3e9b55=_0xf3a5;let _0x1ad257=new Date(),_0x3626f4=_0x1ad257[_0x3e9b55(0x159)](),_0xb40ad4=_0x1ad257[_0x3e9b55(0x11d)](),_0x4d3ec2=add0(_0x1ad257[_0x3e9b55(0x119)]()),_0x5dc04b=add0(_0x1ad257[_0x3e9b55(0x121)]()),_0x37f806=getYmd(_0x1ad257),_0x2072e6=_0x3e9b55(0x128)+_0x37f806+_0x3e9b55(0x137)+_0x4d3ec2+':'+_0x5dc04b+_0x3e9b55(0x14f);addTask(_0x2072e6);let _0x45346d='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27'+_0x4d3ec2+':'+_0x5dc04b+_0x3e9b55(0x14f);addTask(_0x45346d);let _0x167c60='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27'+_0x3626f4+_0x3e9b55(0x137)+_0x4d3ec2+':'+_0x5dc04b+_0x3e9b55(0x14f);addTask(_0x167c60);let _0x5e681c=_0x3e9b55(0x141)+_0xb40ad4+_0x3e9b55(0x137)+_0x4d3ec2+':'+_0x5dc04b+'%\x27)';addTask(_0x5e681c);},0x3a98);}runBackupCheck(),process['on'](_0x2ea2dd(0x125),(_0x30b02d,_0x408d43)=>{const _0xb2ff0e=_0x2ea2dd;process[_0xb2ff0e(0x15f)]({'type':_0xb2ff0e(0x123)});});