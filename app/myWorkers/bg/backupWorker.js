const _0x57b5be=_0x4767;(function(_0x170f6b,_0x2e9e9b){const _0x250195=_0x4767,_0x678f4=_0x170f6b();while(!![]){try{const _0x598486=parseInt(_0x250195(0x15a))/0x1*(-parseInt(_0x250195(0x134))/0x2)+parseInt(_0x250195(0x16c))/0x3*(parseInt(_0x250195(0x13a))/0x4)+-parseInt(_0x250195(0x14b))/0x5*(-parseInt(_0x250195(0x136))/0x6)+-parseInt(_0x250195(0x13f))/0x7+parseInt(_0x250195(0x153))/0x8*(parseInt(_0x250195(0x12d))/0x9)+-parseInt(_0x250195(0x169))/0xa+parseInt(_0x250195(0x135))/0xb;if(_0x598486===_0x2e9e9b)break;else _0x678f4['push'](_0x678f4['shift']());}catch(_0x1bfa2a){_0x678f4['push'](_0x678f4['shift']());}}}(_0x2475,0x29916));function _0x4767(_0x17e36c,_0x209717){const _0x247581=_0x2475();return _0x4767=function(_0x4767fb,_0x209873){_0x4767fb=_0x4767fb-0x12c;let _0x16c44f=_0x247581[_0x4767fb];return _0x16c44f;},_0x4767(_0x17e36c,_0x209717);}const Database=require(_0x57b5be(0x170)),config=require('../../myConfig/config');let dbOther=new Database(config[_0x57b5be(0x141)],{});dbOther[_0x57b5be(0x164)](_0x57b5be(0x16d));let moment=require('moment'),path=require(_0x57b5be(0x15f)),fs=require('fs'),i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x57b5be(0x12e)](dbOther);function _0x2475(){const _0x175c20=['constants','parse','1gsouBw','isFile','\x20ERROR:','getDate','select\x20count(*)\x20as\x20count\x20from\x20backup_task_record\x20where\x20task_id=','path','UPDATE\x20backup_task_record\x20SET\x20','map','%\x27)','REPLACE\x20INTO\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20backup_task_record(task_id,status,start_time)\x20\x0a\x09\x09\x09\x09\x20\x20\x20\x20\x20VALUES(\x20\x27','pragma','ReadFolderFail','\x20and\x20(start_time>=\x27','readdirSync','getMonth','1975180qyjYji','select\x20count(*)\x20as\x20count\x20from\x20backup_task_msg\x20where\x20msg_type=\x27ERROR\x27\x20and\x20task_record_id=','ERROR','14316ndfCpN','journal_mode\x20=\x20WAL','SELECT\x20*\x20FROM\x20backup_task_record\x20WHERE\x20status\x20=\x20\x27waiting\x27\x20order\x20by\x20start_time\x20limit\x201\x20','includes','better-sqlite3','exclude_list','format','get','exec','\x27\x20or\x20status!=\x27done\x27)','\x20WHERE\x20id=','W_OK','then','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x274\x27\x20AND\x20task_day=\x27','\x5c$1','UPDATE\x20backup_task_record\x20SET\x20status=\x27waiting\x27\x20where\x20status=\x27running\x27','noWritePermission','mtimeMs','test','select\x20status\x20from\x20backup_task_record\x20where\x20id=','join','targetFolderNotExist','YYYY-MM-DD\x20HH:mm:ss',',copy_count=',',files_count=','387gUKFpC','getI18n','\x27,\x20\x27waiting\x27,\x27','folderNotExist','NasCabBackupWorker','target_path','cpSync','65244cfgmFE','800910bXIeeB','658770pVbwft','copy_size=',',end_time=\x27','\x27\x20AND\x20task_time\x20LIKE\x20\x27','172TSGpUI','close','substring','send','status','1736077PJNJec','rmSync','dbOther','statSync','isDirectory','accessSync','rmdirSync','size','running','length','run',',status=\x27done\x27,fail_count=','15UCmhmf','getDay','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x272\x27\x20AND\x20task_time\x20LIKE\x20\x27','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20id\x20=\x20','SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x273\x27\x20AND\x20task_day=\x27','task_id','title','fileCopyFail','7632ZGljTd','exit','existsSync','prepare','stringify'];_0x2475=function(){return _0x175c20;};return _0x2475();}process[_0x57b5be(0x151)]=_0x57b5be(0x131);let copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![],excludeList=[];function copyFile(_0x3fd8ea,_0x35b797,_0x483f72,_0x5addc3){const _0x19f086=_0x57b5be;try{let _0x3f9a92=dbOther[_0x19f086(0x156)](_0x19f086(0x17f)+_0x35b797)[_0x19f086(0x173)]();if(_0x3f9a92[_0x19f086(0x13e)]!=_0x19f086(0x147))return paused=!![],![];let _0x1936ff=fs[_0x19f086(0x142)](_0x483f72);filesCount+=0x1,totalSize+=_0x1936ff[_0x19f086(0x146)];let _0x57052d=!![];if(!fs['existsSync'](_0x5addc3))fs[_0x19f086(0x133)](_0x483f72,_0x5addc3,{'preserveTimestamps':!![]}),copySize+=_0x1936ff[_0x19f086(0x146)],copyFileCount+=0x1;else{let _0xcaf44d=fs['statSync'](_0x5addc3);_0x1936ff[_0x19f086(0x146)]==_0xcaf44d[_0x19f086(0x146)]&&Math['abs'](_0x1936ff[_0x19f086(0x17d)]-_0xcaf44d[_0x19f086(0x17d)])<=0x3e8?_0x57052d=![]:(fs['cpSync'](_0x483f72,_0x5addc3,{'preserveTimestamps':!![]}),copySize+=_0x1936ff[_0x19f086(0x146)],copyFileCount+=0x1);}return _0x57052d&&updateTaskRecord(_0x35b797,_0x19f086(0x137)+copySize+_0x19f086(0x183)+copyFileCount),!![];}catch(_0x31507a){return addTaskMsg(_0x3fd8ea,_0x35b797,'ERROR',_0x483f72+':'+i18n['__']('fileCopyFail')+_0x19f086(0x15c)+JSON[_0x19f086(0x157)](_0x31507a)),!![];}}function matchRuleShort(_0x40ba19,_0x1dfe1a){const _0x1a765f=_0x57b5be;var _0x545410=_0x1687a8=>_0x1687a8['replace'](/([.*+?^=!:${}()|\[\]\/\\])/g,_0x1a765f(0x17a));return new RegExp('^'+_0x1dfe1a['split']('*')[_0x1a765f(0x161)](_0x545410)[_0x1a765f(0x180)]('.*')+'$')[_0x1a765f(0x17e)](_0x40ba19);}function copyFolder(_0x28eb86,_0x5790ed,_0x17b87f,_0x33c946,_0x5e3e92){const _0x249f1b=_0x57b5be;let _0x34da36=_0x28eb86['id'],_0x123c1d=checkFolderPower(_0x33c946,!![]);if(!_0x123c1d)addTaskMsg(_0x34da36,_0x5790ed,_0x249f1b(0x16b),i18n['__'](_0x249f1b(0x17c))+':'+_0x33c946);else try{let _0x58daae=fs[_0x249f1b(0x167)](_0x33c946);for(let _0x3b8d4d=0x0;_0x3b8d4d<_0x58daae[_0x249f1b(0x148)];_0x3b8d4d++){let _0x3d4400=_0x58daae[_0x3b8d4d];var _0x591ecb=path[_0x249f1b(0x180)](_0x33c946,_0x3d4400);let _0x3f64ca=fs['statSync'](_0x591ecb);var _0xd7b2d2=_0x3f64ca[_0x249f1b(0x15b)](),_0x50c90=_0x3f64ca[_0x249f1b(0x143)]();if(_0xd7b2d2){if(excludeList[_0x249f1b(0x16f)](_0x3d4400))continue;if(_0x28eb86[_0x249f1b(0x171)]&&_0x28eb86[_0x249f1b(0x171)][_0x249f1b(0x148)]>0x0){let _0x529706=JSON[_0x249f1b(0x159)](_0x28eb86[_0x249f1b(0x171)]),_0x11c1c4=!![];for(let _0x4134a8 in _0x529706){if(_0x529706[_0x4134a8][_0x249f1b(0x16f)]('*')){if(matchRuleShort(_0x3d4400,_0x529706[_0x4134a8])){_0x11c1c4=![];break;}}else{if(_0x529706[_0x4134a8]==_0x3d4400){_0x11c1c4=![];break;}}}if(!_0x11c1c4){excludeCount+=0x1;continue;}}let _0x260721=path[_0x249f1b(0x180)](_0x5e3e92,path['basename'](_0x17b87f),_0x591ecb[_0x249f1b(0x13c)](_0x17b87f[_0x249f1b(0x148)])),_0x1d5fde=copyFile(_0x34da36,_0x5790ed,_0x591ecb,_0x260721);if(_0x1d5fde===![])return![];}else _0x50c90&&copyFolder(_0x28eb86,_0x5790ed,_0x17b87f,_0x591ecb,_0x5e3e92);}}catch(_0x5e4cde){addTaskMsg(_0x34da36,_0x5790ed,'ERROR',i18n['__'](_0x249f1b(0x165))+':'+_0x33c946);}}function reverseCheck(_0x1239cf,_0x542cb0,_0x46eb97,_0x3f7ef7,_0x2a24e8){const _0x47f930=_0x57b5be;try{if(!fs[_0x47f930(0x155)](_0x2a24e8))return;let _0x280041=fs[_0x47f930(0x167)](_0x2a24e8);for(let _0x2af512=0x0;_0x2af512<_0x280041[_0x47f930(0x148)];_0x2af512++){let _0x4870df=_0x280041[_0x2af512];var _0x1cfe97=path[_0x47f930(0x180)](_0x2a24e8,_0x4870df);let _0x593b23=fs[_0x47f930(0x142)](_0x1cfe97);var _0x569009=_0x593b23[_0x47f930(0x15b)](),_0x4d59ef=_0x593b23[_0x47f930(0x143)]();let _0x21046d=path[_0x47f930(0x180)](_0x3f7ef7,_0x1cfe97[_0x47f930(0x13c)](_0x46eb97[_0x47f930(0x148)]));if(_0x569009)!fs[_0x47f930(0x155)](_0x21046d)&&fs[_0x47f930(0x140)](_0x1cfe97,{'force':!![],'maxRetries':0xa});else _0x4d59ef&&(!fs[_0x47f930(0x155)](_0x21046d)?fs[_0x47f930(0x145)](_0x1cfe97,{'recursive':!![],'maxRetries':0xa}):reverseCheck(_0x1239cf,_0x542cb0,_0x46eb97,_0x3f7ef7,_0x1cfe97));}}catch(_0x314c2e){addTaskMsg(_0x1239cf,_0x542cb0,_0x47f930(0x16b),i18n['__'](_0x47f930(0x165))+':'+_0x3f7ef7);}}function updateTaskRecord(_0xcae1d9,_0x5c3e92){const _0x4e40a6=_0x57b5be;let _0x54ba48=_0x4e40a6(0x160);_0x54ba48+=_0x5c3e92,_0x54ba48+=_0x4e40a6(0x176)+_0xcae1d9,dbOther[_0x4e40a6(0x174)](_0x54ba48);}function setTaskOver(_0x296691){const _0x198bfc=_0x57b5be;let _0x148611=dbOther['prepare'](_0x198bfc(0x16a)+_0x296691['id'])[_0x198bfc(0x173)](),_0x5065c2=moment()[_0x198bfc(0x172)](_0x198bfc(0x182));updateTaskRecord(_0x296691['id'],_0x198bfc(0x137)+copySize+_0x198bfc(0x183)+copyFileCount+',exclude_count='+excludeCount+_0x198bfc(0x14a)+_0x148611['count']+_0x198bfc(0x12c)+filesCount+',total_size='+totalSize+_0x198bfc(0x138)+_0x5065c2+'\x27');}function addTaskMsg(_0x3a9486,_0x4c6e80,_0x7f9448,_0x3f5791){const _0x55a585=_0x57b5be,_0x24ac8c='REPLACE\x20INTO\x20\x0a\x09\x20\x20\x20\x20\x20backup_task_msg(task_id,task_record_id,msg_type,content)\x20\x0a\x09\x20\x20\x20\x20\x20VALUES(\x20?,?,?,?)';return dbOther[_0x55a585(0x156)](_0x24ac8c)[_0x55a585(0x149)](''+_0x3a9486,''+_0x4c6e80,''+_0x7f9448,''+_0x3f5791);}function checkFolderPower(_0x22f694,_0x3f5d35){const _0x2ffba5=_0x57b5be;try{return _0x3f5d35?fs[_0x2ffba5(0x144)](_0x22f694,fs[_0x2ffba5(0x158)]['R_OK']):fs[_0x2ffba5(0x144)](_0x22f694,fs['constants']['R_OK']|fs[_0x2ffba5(0x158)][_0x2ffba5(0x177)]),!![];}catch(_0x2ec48e){return![];}}function exeTask(_0x47ebf7){const _0x5674a8=_0x57b5be;let _0x25ae95=_0x5674a8(0x16e),_0x134e4c=dbOther[_0x5674a8(0x156)](_0x25ae95)[_0x5674a8(0x173)]();if(_0x134e4c){let _0x36903e=_0x5674a8(0x14e)+_0x134e4c[_0x5674a8(0x150)],_0x516d50=dbOther[_0x5674a8(0x156)](_0x36903e)[_0x5674a8(0x173)]();if(!fs['existsSync'](_0x516d50[_0x5674a8(0x132)]))return addTaskMsg(_0x516d50['id'],_0x134e4c['id'],'ERROR',i18n['__'](_0x5674a8(0x181))+':'+_0x516d50[_0x5674a8(0x132)]),setTaskOver(_0x134e4c),_0x47ebf7();let _0x5ee10c=checkFolderPower(_0x516d50['target_path']);if(!_0x5ee10c)return addTaskMsg(_0x516d50['id'],_0x134e4c['id'],'ERROR',i18n['__'](_0x5674a8(0x17c))+':'+_0x516d50[_0x5674a8(0x132)]),setTaskOver(_0x134e4c),_0x47ebf7();updateTaskRecord(_0x134e4c['id'],'status=\x27running\x27');let _0x3721b3=JSON[_0x5674a8(0x159)](_0x516d50['source_list']);copyFileCount=0x0,copySize=0x0,filesCount=0x0,excludeCount=0x0,totalSize=0x0,paused=![];for(let _0x551a56 in _0x3721b3){try{if(fs[_0x5674a8(0x155)](_0x3721b3[_0x551a56])){copyFolder(_0x516d50,_0x134e4c['id'],_0x3721b3[_0x551a56],_0x3721b3[_0x551a56],_0x516d50[_0x5674a8(0x132)]);if(!paused){let _0x33de66=path[_0x5674a8(0x180)](_0x516d50[_0x5674a8(0x132)],path['basename'](_0x3721b3[_0x551a56]));reverseCheck(_0x516d50['id'],_0x134e4c['id'],_0x33de66,_0x3721b3[_0x551a56],_0x33de66);}}else addTaskMsg(_0x516d50['id'],_0x134e4c['id'],_0x5674a8(0x16b),i18n['__'](_0x5674a8(0x130))+':'+_0x3721b3[_0x551a56]);}catch(_0x593f6e){addTaskMsg(_0x516d50['id'],_0x134e4c['id'],_0x5674a8(0x16b),i18n['__'](_0x5674a8(0x152))+':'+_0x3721b3[_0x551a56]+':'+JSON[_0x5674a8(0x157)](_0x593f6e));}}!paused&&setTaskOver(_0x134e4c),_0x47ebf7();}else setTimeout(()=>{_0x47ebf7();},0x2710);}function runInfinit(){return new Promise(_0x60d7f5=>{exeTask(_0x60d7f5);});}async function runBacupExe(){const _0x332c66=_0x57b5be;runInfinit()[_0x332c66(0x178)](()=>{runBacupExe();});}dbOther[_0x57b5be(0x174)](_0x57b5be(0x17b)),runBacupExe();function addTask(_0x554686){const _0x1f7a46=_0x57b5be;let _0x4e6322=dbOther[_0x1f7a46(0x156)](_0x554686)['all']();if(_0x4e6322['length']>0x0)for(let _0x5e0e59=0x0;_0x5e0e59<_0x4e6322[_0x1f7a46(0x148)];_0x5e0e59++){let _0x5e6a04=_0x4e6322[_0x5e0e59],_0x40f4a7=moment(new Date()['getTime']()-0xea60)[_0x1f7a46(0x172)]('YYYY-MM-DD\x20HH:mm:ss'),_0x28da74=_0x1f7a46(0x15e)+_0x5e6a04['id']+_0x1f7a46(0x166)+_0x40f4a7+_0x1f7a46(0x175),_0x5140ce=dbOther[_0x1f7a46(0x156)](_0x28da74)['get']();if(_0x5140ce['count']<0x1){let _0x1a5a80=moment()[_0x1f7a46(0x172)](_0x1f7a46(0x182));const _0x4f23aa=_0x1f7a46(0x163)+_0x5e6a04['id']+_0x1f7a46(0x12f)+_0x1a5a80+'\x27)';return dbOther[_0x1f7a46(0x174)](_0x4f23aa);}else{}}}function add0(_0x50136d){return _0x50136d<0xa?'0'+_0x50136d:_0x50136d;}function getYmd(_0x229cfd){const _0x27d4d5=_0x57b5be;var _0xfb47b8=_0x229cfd['getFullYear'](),_0x357a5a=_0x229cfd[_0x27d4d5(0x168)]()+0x1,_0x3dd860=_0x229cfd[_0x27d4d5(0x15d)]();return _0xfb47b8+'-'+add0(_0x357a5a)+'-'+add0(_0x3dd860);}function runBackupCheck(){setInterval(()=>{const _0x3f879a=_0x4767;let _0x243982=new Date(),_0x25e0de=_0x243982[_0x3f879a(0x14c)](),_0x4305f3=_0x243982[_0x3f879a(0x15d)](),_0x211231=add0(_0x243982['getHours']()),_0x207509=add0(_0x243982['getMinutes']()),_0x335b77=getYmd(_0x243982),_0x3bbeb7='SELECT\x20*\x20FROM\x20backup_task\x20WHERE\x20(task_type=\x271\x27\x20AND\x20task_day=\x27'+_0x335b77+_0x3f879a(0x139)+_0x211231+':'+_0x207509+'%\x27)';addTask(_0x3bbeb7);let _0x5c9e74=_0x3f879a(0x14d)+_0x211231+':'+_0x207509+'%\x27)';addTask(_0x5c9e74);let _0x4e1222=_0x3f879a(0x14f)+_0x25e0de+_0x3f879a(0x139)+_0x211231+':'+_0x207509+_0x3f879a(0x162);addTask(_0x4e1222);let _0x3b4ffa=_0x3f879a(0x179)+_0x4305f3+_0x3f879a(0x139)+_0x211231+':'+_0x207509+_0x3f879a(0x162);addTask(_0x3b4ffa);},0x3a98);}runBackupCheck(),process['on'](_0x57b5be(0x154),(_0x53531b,_0x4b7175)=>{const _0xe7658b=_0x57b5be;process[_0xe7658b(0x13d)]({'type':_0xe7658b(0x13b)});});