const _0x4e117d=_0x4fce;(function(_0x307d4d,_0x25d340){const _0x2c351f=_0x4fce,_0x5a4c17=_0x307d4d();while(!![]){try{const _0x1ced33=-parseInt(_0x2c351f(0x191))/0x1+-parseInt(_0x2c351f(0x19e))/0x2*(-parseInt(_0x2c351f(0x18d))/0x3)+parseInt(_0x2c351f(0x1a7))/0x4*(-parseInt(_0x2c351f(0x1ae))/0x5)+-parseInt(_0x2c351f(0x1dc))/0x6+-parseInt(_0x2c351f(0x1d7))/0x7*(-parseInt(_0x2c351f(0x1a9))/0x8)+-parseInt(_0x2c351f(0x1a1))/0x9*(-parseInt(_0x2c351f(0x1a2))/0xa)+parseInt(_0x2c351f(0x1d1))/0xb*(parseInt(_0x2c351f(0x1b4))/0xc);if(_0x1ced33===_0x25d340)break;else _0x5a4c17['push'](_0x5a4c17['shift']());}catch(_0x4a66cb){_0x5a4c17['push'](_0x5a4c17['shift']());}}}(_0x194a,0x59d9f));let path=require(_0x4e117d(0x19a)),fs=require('fs');const dbFileOperationRecord=require(_0x4e117d(0x1b7)),config=require('../../myConfig/config'),Database=require(_0x4e117d(0x19f));let dbOther=new Database(config[_0x4e117d(0x1ba)],{});dbOther[_0x4e117d(0x1c0)]('journal_mode\x20=\x20WAL');let i18nUtil=require(_0x4e117d(0x1a4)),i18n=i18nUtil[_0x4e117d(0x1b0)](dbOther);const compressing=require(_0x4e117d(0x1de)),mkdirp=require(_0x4e117d(0x1d2)),fileUtils=require(_0x4e117d(0x1bf));process[_0x4e117d(0x1db)]='NasCabFileWorker';let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x432203,_0x25abd6){const _0x10298f=_0x4e117d;if(fs[_0x10298f(0x18f)](_0x432203)){let _0x3c93b3=path[_0x10298f(0x1a8)](_0x432203),_0x26a067=path['dirname'](_0x432203),_0x424cf8=path[_0x10298f(0x1ab)](_0x432203),_0x29ae00=_0x3c93b3[_0x10298f(0x1cc)](_0x424cf8,'')+('('+_0x25abd6+')')+_0x424cf8,_0xdfdab7=path[_0x10298f(0x1e1)](_0x26a067,_0x29ae00);return getTargetFullPath(_0xdfdab7,_0x25abd6+0x1);}else return _0x432203;}function copyFile(_0x3b7183,_0x353871,_0x373dd1,_0x4a5335){const _0x47dd4b=_0x4e117d;try{let _0x52e002=dbOther['prepare'](_0x47dd4b(0x1c8)+taskObj['id'])['get']();if(!_0x52e002||_0x52e002[_0x47dd4b(0x1b3)]!=0x1)return paused=!![],![];let _0x120d09=fs[_0x47dd4b(0x1b2)](_0x353871);return _0x373dd1=getTargetFullPath(_0x373dd1,0x1),fs[_0x47dd4b(0x1e0)](_0x353871,_0x373dd1),copySize+=_0x120d09[_0x47dd4b(0x1bd)],copyFileCount+=0x1,dbOther[_0x47dd4b(0x196)](_0x47dd4b(0x1cd))[_0x47dd4b(0x19d)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x2ea19d){return console['log'](_0x2ea19d),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,fileUtils['getFileErrStr'](i18n,_0x2ea19d)),![];}}function copyFolder(_0x59ca2e,_0xa0bc64,_0x5343b4,_0x5620df,_0x21cf6c){const _0x4d78a4=_0x4e117d;try{fs['accessSync'](_0x5343b4,fs['constants'][_0x4d78a4(0x1ce)]);let _0x1b9a52=fs[_0x4d78a4(0x1c3)](_0x5343b4);for(let _0x3dda2b=0x0;_0x3dda2b<_0x1b9a52[_0x4d78a4(0x1d0)];_0x3dda2b++){if(paused)return![];let _0xf44dac=_0x1b9a52[_0x3dda2b];var _0x5e4fd2=path[_0x4d78a4(0x1e1)](_0x5343b4,_0xf44dac);let _0x546208=path[_0x4d78a4(0x1e1)](_0x5620df,_0x5e4fd2[_0x4d78a4(0x18c)](_0xa0bc64['length'])),_0x454349=fs[_0x4d78a4(0x1b2)](_0x5e4fd2);if(_0x454349[_0x4d78a4(0x1d3)]()){let _0x543681=copyFile(_0x59ca2e,_0x5e4fd2,_0x546208,_0x21cf6c);if(_0x543681===![])return paused=!![],dbFileOperationRecord[_0x4d78a4(0x1a6)](dbOther,currentFileOperationRecordId,i18n['__'](_0x4d78a4(0x1d5))),![];}else _0x454349[_0x4d78a4(0x1c4)]()&&(!fs[_0x4d78a4(0x18f)](_0x546208)&&fs[_0x4d78a4(0x190)](_0x546208,{'recursive':!![]}),copyFolder(_0x59ca2e,_0xa0bc64,_0x5e4fd2,_0x5620df,_0x21cf6c));}if(paused)return![];return!![];}catch(_0x5d42df){return![];}}async function doFileOperation(_0x5c1f1e,_0x1229bc){const _0x5c8502=_0x4e117d;let _0x3d3ac6=_0x5c1f1e['sourcePath'],_0x526caa=_0x5c1f1e[_0x5c8502(0x1d9)],_0x39fd0f=_0x5c1f1e[_0x5c8502(0x1d6)];function _0x4a8368(_0x4a1bf5,_0x3eeb41){const _0x979789=_0x5c8502;if(_0x4a1bf5)taskObj=_0x4a1bf5;dbOther[_0x979789(0x196)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])[_0x979789(0x19d)](),dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x979789(0x1df)]),_0x3eeb41&&dbFileOperationRecord[_0x979789(0x1a6)](dbOther,currentFileOperationRecordId,_0x3eeb41),_0x1229bc();}function _0x188e0a(_0x5740b9,_0x3f0657){const _0xf876a3=_0x5c8502;if(_0x5740b9)taskObj=_0x5740b9;dbOther[_0xf876a3(0x196)](_0xf876a3(0x19c)+taskObj['id'])[_0xf876a3(0x19d)](),_0x39fd0f=='cut'&&_0x3f0657?fs['rm'](_0x3d3ac6,{'recursive':!![]},_0x3695ad=>{const _0x316c1b=_0xf876a3;_0x3695ad?(dbFileOperationRecord[_0x316c1b(0x1d8)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_FAIL']),dbFileOperationRecord[_0x316c1b(0x1a6)](dbOther,currentFileOperationRecordId,i18n['__'](_0x316c1b(0x1b1)))):dbFileOperationRecord[_0x316c1b(0x1d8)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x316c1b(0x1af)]),_0x1229bc();}):(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0xf876a3(0x1af)]),_0x1229bc());}try{let _0x1d9a72=fs[_0x5c8502(0x1b2)](_0x3d3ac6);function _0x19a8c4(_0x1e8547){const _0x172411=_0x5c8502;if(_0x1d9a72[_0x172411(0x1d3)]()){let _0x2e2563=copyFile(_0x5c1f1e,_0x3d3ac6,_0x526caa,_0x39fd0f);_0x2e2563?_0x188e0a(_0x1e8547,!![]):_0x4a8368(_0x1e8547);}else{if(_0x1d9a72[_0x172411(0x1c4)]()){_0x526caa=getTargetFullPath(_0x526caa,0x1);!fs[_0x172411(0x18f)](_0x526caa)&&fs['mkdirSync'](_0x526caa,{'recursive':!![]});let _0x1b2569=copyFolder(_0x5c1f1e,_0x3d3ac6,_0x3d3ac6,_0x526caa,_0x39fd0f);_0x1b2569?_0x188e0a(_0x1e8547,!![]):_0x4a8368(_0x1e8547);}}}if(_0x39fd0f==_0x5c8502(0x1bc))_0x19a8c4(taskObj);else{if(_0x39fd0f=='cut')fs['rename'](_0x3d3ac6,_0x526caa,_0x3c2b22=>{if(_0x3c2b22)return _0x19a8c4(taskObj);else _0x188e0a(taskObj,![]);});else{if(_0x39fd0f=='zip'){let _0x269165=path[_0x5c8502(0x1a8)](_0x3d3ac6),_0x59a400=path['join'](_0x526caa,_0x269165+_0x5c8502(0x1c6));if(fs[_0x5c8502(0x18f)](_0x59a400))return _0x4a8368(taskObj,i18n['__'](_0x5c8502(0x1c2))+':'+_0x59a400);let _0x182f24=fs[_0x5c8502(0x1da)](_0x59a400),_0x1500ee=taskObj,_0x578c22=0x0,_0x15be38=0x0,_0x4b9259,_0x5059d9=![];if(_0x1d9a72[_0x5c8502(0x1d3)]())_0x4b9259=new compressing[(_0x5c8502(0x1d4))][(_0x5c8502(0x1c7))]({'source':_0x3d3ac6});else _0x1d9a72[_0x5c8502(0x1c4)]()&&(_0x4b9259=new compressing[(_0x5c8502(0x1d4))]['Stream'](),_0x4b9259[_0x5c8502(0x1a0)](_0x3d3ac6));_0x4b9259['on'](_0x5c8502(0x19b),_0x5bf969=>{const _0x109c7e=_0x5c8502;_0x578c22+=_0x5bf969[_0x109c7e(0x1d0)];let _0x5e1693=_0x578c22/0x400/0x400;if(_0x5e1693>_0x15be38+0x64){_0x15be38=_0x5e1693,dbOther['prepare'](_0x109c7e(0x1cf))[_0x109c7e(0x19d)](_0x578c22,_0x1500ee['id']);let _0x3cd95d=dbOther[_0x109c7e(0x196)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+_0x1500ee['id'])['get']();(!_0x3cd95d||_0x3cd95d['task_state']!=0x1&&!_0x5059d9)&&(_0x182f24[_0x109c7e(0x195)](),_0x4b9259['destroy'](),_0x4a8368(_0x1500ee));}}),_0x4b9259[_0x5c8502(0x1ca)](_0x182f24),_0x4b9259['on'](_0x5c8502(0x197),_0x144e49=>{const _0x2b2d50=_0x5c8502;_0x182f24[_0x2b2d50(0x195)](),_0x4a8368(_0x1500ee);}),_0x182f24['on'](_0x5c8502(0x197),_0x2e26d2=>{const _0x2774bf=_0x5c8502;_0x182f24[_0x2774bf(0x195)](),_0x4a8368(_0x1500ee);}),_0x182f24['on'](_0x5c8502(0x18e),()=>{const _0x5bd1e6=_0x5c8502;_0x5059d9=!![],_0x182f24[_0x5bd1e6(0x195)](),_0x188e0a(_0x1500ee);});}else{if(_0x39fd0f==_0x5c8502(0x1ad)){let _0x342617=taskObj,_0x322a39=path[_0x5c8502(0x1ab)](_0x3d3ac6),_0x2aab8a=[_0x5c8502(0x1ac),'.gzip',_0x5c8502(0x1be),_0x5c8502(0x1c6)];if(!_0x322a39||!_0x2aab8a[_0x5c8502(0x1b9)](_0x322a39))return _0x4a8368(_0x342617,i18n['__']('notSupportFileFormat'));let _0x500979=0x0,_0x5b4dec=0x0,_0x1ded1c,_0xbbd62e=new compressing[(_0x322a39[_0x5c8502(0x1cc)]('.',''))]['UncompressStream']({'source':_0x3d3ac6});_0xbbd62e['on'](_0x5c8502(0x197),_0x7de7c3=>{_0x1ded1c&&(_0x1ded1c['close'](),_0x1ded1c=null),_0x4a8368(_0x342617);}),_0xbbd62e['on'](_0x5c8502(0x18e),()=>{const _0x4b3255=_0x5c8502;_0x1ded1c&&(_0x1ded1c[_0x4b3255(0x195)](),_0x1ded1c=null),_0x188e0a(_0x342617);}),_0xbbd62e['on'](_0x5c8502(0x199),(_0x197eba,_0xcbada1,_0x4e0965)=>{const _0x515eff=_0x5c8502;_0xcbada1['on'](_0x515eff(0x1a5),_0x4e0965);let _0x187eee=path['join'](_0x526caa,_0x197eba[_0x515eff(0x198)]),_0x135f88=path[_0x515eff(0x1c1)](_0x187eee);!fs[_0x515eff(0x18f)](_0x135f88)&&fs[_0x515eff(0x190)](_0x135f88,{'recursive':!![]}),_0x1ded1c=fs[_0x515eff(0x1da)](_0x187eee),_0x1ded1c['on']('error',_0xb069c6=>{const _0x125a4e=_0x515eff;console[_0x125a4e(0x1b6)](_0xb069c6);}),_0x197eba[_0x515eff(0x1d6)]===_0x515eff(0x194)?(_0xcbada1['on'](_0x515eff(0x19b),_0x211fa4=>{const _0x3db5c2=_0x515eff;_0x500979+=_0x211fa4['length'];let _0x5f3df3=_0x500979/0x400/0x400;if(_0x5f3df3>_0x5b4dec+0x64){_0x5b4dec=_0x5f3df3,dbOther[_0x3db5c2(0x196)](_0x3db5c2(0x1cf))[_0x3db5c2(0x19d)](_0x500979,_0x342617['id']);let _0x335398=dbOther['prepare'](_0x3db5c2(0x1c8)+_0x342617['id'])[_0x3db5c2(0x1dd)]();if(!_0x335398||_0x335398[_0x3db5c2(0x1b3)]!=0x1&&!isFinish)return _0x1ded1c[_0x3db5c2(0x195)](),_0xcbada1['on']('end',()=>{}),_0xcbada1[_0x3db5c2(0x1aa)](),_0x1ded1c['destroy'](),_0xbbd62e[_0x3db5c2(0x1aa)](),_0x4a8368(_0x342617);}}),_0xcbada1[_0x515eff(0x1ca)](_0x1ded1c)):mkdirp(path['join'](_0x526caa,_0x197eba[_0x515eff(0x198)]),_0x16eceb=>{const _0x2819e7=_0x515eff;if(_0x16eceb)return;_0xcbada1[_0x2819e7(0x1c5)]();});});}else _0x188e0a();}}}}catch(_0x4c22e4){console['log'](_0x4c22e4),_0x4a8368();}}async function taskStart(_0x2fb98a){return new Promise((_0x459de3,_0x5d68e3)=>{const _0x2afc3c=_0x4fce;taskObj=dbOther['prepare'](_0x2afc3c(0x1bb)+_0x2fb98a)['get']();if(taskObj){taskParams=JSON['parse'](taskObj[_0x2afc3c(0x1a3)]),dbOther[_0x2afc3c(0x196)](_0x2afc3c(0x1cb)+taskObj['id'])[_0x2afc3c(0x19d)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x43f681=dbFileOperationRecord[_0x2afc3c(0x193)](dbOther,{'username':taskParams['username'],'sourcePath':taskParams['sourcePath'],'targetPath':taskParams['targetPath'],'level':dbFileOperationRecord['LEVEL_MAIN_OPERATION'],'type':taskParams['type'],'state':dbFileOperationRecord[_0x2afc3c(0x192)]});_0x43f681&&(currentFileOperationRecordId=_0x43f681[_0x2afc3c(0x1b5)]),doFileOperation(taskParams,_0x459de3);}else _0x459de3();});}function _0x4fce(_0xd4946c,_0x1da3c6){const _0x194aa2=_0x194a();return _0x4fce=function(_0x4fce63,_0x2d610b){_0x4fce63=_0x4fce63-0x18c;let _0x4b9cfe=_0x194aa2[_0x4fce63];return _0x4b9cfe;},_0x4fce(_0xd4946c,_0x1da3c6);}function exitProcess(){const _0x23a265=_0x4e117d;process['send']({'type':_0x23a265(0x195)}),process['exit']();}function _0x194a(){const _0x327bd0=['existsSync','mkdirSync','661488fmfeWC','STATE_DOING','addFileOperationRecord','file','close','prepare','error','name','entry','path','data','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','run','1461446oqivGb','better-sqlite3','addEntry','9kKDagC','6430290oDUCRW','task_json','../../utils/i18nUtil','end','updateRecordRemark','17924yEZpTm','basename','168gQTtQd','destroy','extname','.tar','unzip','345nzSGlV','STATE_SUC','getI18n','file.cutCopySucButDeleteFail','statSync','task_state','64716LlZWZL','lastInsertRowid','log','../../db/dbFileOperationRecord','message','includes','dbOther','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','copy','size','.tgz','../../express-server/utils/fileUtils','pragma','dirname','sameNameFileAlreadExist','readdirSync','isDirectory','resume','.zip','FileStream','select\x20task_state\x20from\x20bg_task\x20where\x20id=','taskIdList','pipe','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','replace','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','R_OK','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','length','1045RmlXbI','mkdirp','isFile','zip','file.taskCancel','type','16527APmBlH','updateRecordState','targetPath','createWriteStream','title','3581760EjWQdR','get','compressing','STATE_FAIL','cpSync','join','substring','3xFwmRw','finish'];_0x194a=function(){return _0x327bd0;};return _0x194a();}process['on'](_0x4e117d(0x1b8),async _0x4385d2=>{const _0x336254=_0x4e117d;try{if(_0x4385d2[_0x336254(0x1c9)]&&_0x4385d2['taskIdList'][_0x336254(0x1d0)]>0x0){for(let _0xf565bf in _0x4385d2[_0x336254(0x1c9)]){await taskStart(_0x4385d2[_0x336254(0x1c9)][_0xf565bf]);}exitProcess();}else exitProcess();}catch(_0x59f9ad){exitProcess();}});