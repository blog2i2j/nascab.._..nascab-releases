const _0x51e0cc=_0x2b60;(function(_0x2060c3,_0x77eb91){const _0x2dcc8f=_0x2b60,_0x319312=_0x2060c3();while(!![]){try{const _0x593e60=parseInt(_0x2dcc8f(0x88))/0x1*(-parseInt(_0x2dcc8f(0x7b))/0x2)+-parseInt(_0x2dcc8f(0x7d))/0x3+parseInt(_0x2dcc8f(0xaf))/0x4+parseInt(_0x2dcc8f(0xa0))/0x5+-parseInt(_0x2dcc8f(0xc0))/0x6*(-parseInt(_0x2dcc8f(0xb9))/0x7)+parseInt(_0x2dcc8f(0xc2))/0x8+-parseInt(_0x2dcc8f(0x70))/0x9*(-parseInt(_0x2dcc8f(0xbd))/0xa);if(_0x593e60===_0x77eb91)break;else _0x319312['push'](_0x319312['shift']());}catch(_0x2ae985){_0x319312['push'](_0x319312['shift']());}}}(_0x331a,0x35e11));let path=require(_0x51e0cc(0x73)),fs=require('fs');const dbFileOperationRecord=require(_0x51e0cc(0x9b)),config=require(_0x51e0cc(0xaa)),Database=require(_0x51e0cc(0xb5));let dbOther=new Database(config['dbOther'],{});function _0x331a(){const _0x35ca2e=['compressing','readdirSync','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','../../myConfig/config','updateRecordRemark','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','isDirectory','statSync','959656mwkMMa','journal_mode\x20=\x20WAL','STATE_SUC','username','constants','parse','better-sqlite3','getI18n','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','mkdirp','7DADsCI','.tar','isFile','UncompressStream','70MMlXMn','join','substring','346914XFQtwK','error','327880MOdmQd','notSupportFileFormat','taskIdList','pragma','log','UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id=','185049VRzoOd','getFileErrStr','task_state','path','FileStream','sameNameFileAlreadExist','basename','unzip','mkdirSync','send','destroy','361182shjkcS','replace','77922rrKeQs','type','targetPath','task_json','run','close','select\x20task_state\x20from\x20bg_task\x20where\x20id=','dirname','createWriteStream','finish','end','2eSjxVx','pipe','../../express-server/utils/fileUtils','resume','Stream','.gzip','data','name','file','extname','zip','title','length','rename','entry','LEVEL_MAIN_OPERATION','file.taskCancel','sourcePath','get','../../db/dbFileOperationRecord','addEntry','updateRecordState','message','cut','626000QeLPKM','copy','existsSync','prepare','size','addFileOperationRecord','STATE_FAIL'];_0x331a=function(){return _0x35ca2e;};return _0x331a();}dbOther[_0x51e0cc(0xc5)](_0x51e0cc(0xb0));let i18nUtil=require('../../utils/i18nUtil'),i18n=i18nUtil[_0x51e0cc(0xb6)](dbOther);const compressing=require(_0x51e0cc(0xa7)),mkdirp=require(_0x51e0cc(0xb8)),fileUtils=require(_0x51e0cc(0x8a));process[_0x51e0cc(0x93)]='NasCabFileWorker';let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x8c2391,_0x419d19){const _0x3bdb8c=_0x51e0cc;if(fs['existsSync'](_0x8c2391)){let _0x2eec31=path[_0x3bdb8c(0x76)](_0x8c2391),_0x5b71e3=path[_0x3bdb8c(0x84)](_0x8c2391),_0x37e1b6=path[_0x3bdb8c(0x91)](_0x8c2391),_0x25b012=_0x2eec31[_0x3bdb8c(0x7c)](_0x37e1b6,'')+('('+_0x419d19+')')+_0x37e1b6,_0x5ceef0=path[_0x3bdb8c(0xbe)](_0x5b71e3,_0x25b012);return getTargetFullPath(_0x5ceef0,_0x419d19+0x1);}else return _0x8c2391;}function _0x2b60(_0x3cc03c,_0x43eb26){const _0x331a1f=_0x331a();return _0x2b60=function(_0x2b60b0,_0x496f67){_0x2b60b0=_0x2b60b0-0x6e;let _0x33f2cd=_0x331a1f[_0x2b60b0];return _0x33f2cd;},_0x2b60(_0x3cc03c,_0x43eb26);}function copyFile(_0x4c453e,_0x415ceb,_0x26a2ad,_0x111967){const _0x114dc6=_0x51e0cc;try{let _0x9864be=dbOther['prepare'](_0x114dc6(0x83)+taskObj['id'])[_0x114dc6(0x9a)]();if(!_0x9864be||_0x9864be[_0x114dc6(0x72)]!=0x1)return paused=!![],![];let _0x5cc521=fs[_0x114dc6(0xae)](_0x415ceb);return _0x26a2ad=getTargetFullPath(_0x26a2ad,0x1),fs['cpSync'](_0x415ceb,_0x26a2ad),copySize+=_0x5cc521[_0x114dc6(0xa4)],copyFileCount+=0x1,dbOther[_0x114dc6(0xa3)]('UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?')[_0x114dc6(0x81)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x15ae55){return console[_0x114dc6(0x6e)](_0x15ae55),dbFileOperationRecord[_0x114dc6(0xab)](dbOther,currentFileOperationRecordId,fileUtils[_0x114dc6(0x71)](i18n,_0x15ae55)),![];}}function copyFolder(_0x127886,_0x3f8e02,_0x2c8bad,_0xdff3fe,_0x14558a){const _0x1637f4=_0x51e0cc;try{fs['accessSync'](_0x2c8bad,fs[_0x1637f4(0xb3)]['R_OK']);let _0x373db6=fs[_0x1637f4(0xa8)](_0x2c8bad);for(let _0x13f4d6=0x0;_0x13f4d6<_0x373db6['length'];_0x13f4d6++){if(paused)return![];let _0x13b512=_0x373db6[_0x13f4d6];var _0x45d12c=path[_0x1637f4(0xbe)](_0x2c8bad,_0x13b512);let _0x41e873=path[_0x1637f4(0xbe)](_0xdff3fe,_0x45d12c[_0x1637f4(0xbf)](_0x3f8e02['length'])),_0x4bc7d5=fs[_0x1637f4(0xae)](_0x45d12c);if(_0x4bc7d5[_0x1637f4(0xbb)]()){let _0x574b19=copyFile(_0x127886,_0x45d12c,_0x41e873,_0x14558a);if(_0x574b19===![])return paused=!![],dbFileOperationRecord[_0x1637f4(0xab)](dbOther,currentFileOperationRecordId,i18n['__'](_0x1637f4(0x98))),![];}else _0x4bc7d5[_0x1637f4(0xad)]()&&(!fs[_0x1637f4(0xa2)](_0x41e873)&&fs['mkdirSync'](_0x41e873,{'recursive':!![]}),copyFolder(_0x127886,_0x3f8e02,_0x45d12c,_0xdff3fe,_0x14558a));}if(paused)return![];return!![];}catch(_0x405951){return![];}}async function doFileOperation(_0xa05d1e,_0x27b03a){const _0x4c0d76=_0x51e0cc;let _0x914770=_0xa05d1e[_0x4c0d76(0x99)],_0x4f1b14=_0xa05d1e[_0x4c0d76(0x7f)],_0xf1dac=_0xa05d1e['type'];function _0x42fcdc(_0x386360,_0x42704d){const _0x2574e1=_0x4c0d76;if(_0x386360)taskObj=_0x386360;dbOther[_0x2574e1(0xa3)](_0x2574e1(0x6f)+taskObj['id'])[_0x2574e1(0x81)](),dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x2574e1(0xa6)]),_0x42704d&&dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,_0x42704d),_0x27b03a();}function _0x21931c(_0x433c97,_0x35e029){const _0x1a4230=_0x4c0d76;if(_0x433c97)taskObj=_0x433c97;dbOther[_0x1a4230(0xa3)](_0x1a4230(0xb7)+taskObj['id'])[_0x1a4230(0x81)](),_0xf1dac==_0x1a4230(0x9f)&&_0x35e029?fs['rm'](_0x914770,{'recursive':!![]},_0xe74ee3=>{const _0x1c3559=_0x1a4230;_0xe74ee3?(dbFileOperationRecord[_0x1c3559(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1c3559(0xa6)]),dbFileOperationRecord[_0x1c3559(0xab)](dbOther,currentFileOperationRecordId,i18n['__']('file.cutCopySucButDeleteFail'))):dbFileOperationRecord[_0x1c3559(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1c3559(0xb1)]),_0x27b03a();}):(dbFileOperationRecord[_0x1a4230(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1a4230(0xb1)]),_0x27b03a());}try{let _0x38101d=fs['statSync'](_0x914770);function _0x16a169(_0x43f14a){const _0x39c088=_0x4c0d76;if(_0x38101d[_0x39c088(0xbb)]()){let _0x2f6d32=copyFile(_0xa05d1e,_0x914770,_0x4f1b14,_0xf1dac);_0x2f6d32?_0x21931c(_0x43f14a,!![]):_0x42fcdc(_0x43f14a);}else{if(_0x38101d['isDirectory']()){_0x4f1b14=getTargetFullPath(_0x4f1b14,0x1);!fs[_0x39c088(0xa2)](_0x4f1b14)&&fs[_0x39c088(0x78)](_0x4f1b14,{'recursive':!![]});let _0x2eb927=copyFolder(_0xa05d1e,_0x914770,_0x914770,_0x4f1b14,_0xf1dac);_0x2eb927?_0x21931c(_0x43f14a,!![]):_0x42fcdc(_0x43f14a);}}}if(_0xf1dac==_0x4c0d76(0xa1))_0x16a169(taskObj);else{if(_0xf1dac==_0x4c0d76(0x9f))fs[_0x4c0d76(0x95)](_0x914770,_0x4f1b14,_0x3b58a0=>{if(_0x3b58a0)return _0x16a169(taskObj);else _0x21931c(taskObj,![]);});else{if(_0xf1dac=='zip'){let _0x498355=path[_0x4c0d76(0x76)](_0x914770),_0x1d7bcc=path[_0x4c0d76(0xbe)](_0x4f1b14,_0x498355+'.zip');if(fs[_0x4c0d76(0xa2)](_0x1d7bcc))return _0x42fcdc(taskObj,i18n['__'](_0x4c0d76(0x75))+':'+_0x1d7bcc);let _0x5a974d=fs[_0x4c0d76(0x85)](_0x1d7bcc),_0x1e176e=taskObj,_0x3f223d=0x0,_0x86d107=0x0,_0x38d87b,_0x4aa156=![];if(_0x38101d[_0x4c0d76(0xbb)]())_0x38d87b=new compressing['zip'][(_0x4c0d76(0x74))]({'source':_0x914770});else _0x38101d[_0x4c0d76(0xad)]()&&(_0x38d87b=new compressing[(_0x4c0d76(0x92))][(_0x4c0d76(0x8c))](),_0x38d87b[_0x4c0d76(0x9c)](_0x914770));_0x38d87b['on'](_0x4c0d76(0x8e),_0x34671d=>{const _0x31c827=_0x4c0d76;_0x3f223d+=_0x34671d[_0x31c827(0x94)];let _0x1caf74=_0x3f223d/0x400/0x400;if(_0x1caf74>_0x86d107+0x64){_0x86d107=_0x1caf74,dbOther[_0x31c827(0xa3)](_0x31c827(0xac))[_0x31c827(0x81)](_0x3f223d,_0x1e176e['id']);let _0x2cdbbb=dbOther[_0x31c827(0xa3)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+_0x1e176e['id'])[_0x31c827(0x9a)]();(!_0x2cdbbb||_0x2cdbbb[_0x31c827(0x72)]!=0x1&&!_0x4aa156)&&(_0x5a974d[_0x31c827(0x82)](),_0x38d87b['destroy'](),_0x42fcdc(_0x1e176e));}}),_0x38d87b['pipe'](_0x5a974d),_0x38d87b['on'](_0x4c0d76(0xc1),_0x30fc83=>{const _0x366586=_0x4c0d76;_0x5a974d[_0x366586(0x82)](),_0x42fcdc(_0x1e176e);}),_0x5a974d['on'](_0x4c0d76(0xc1),_0x34826c=>{const _0x91d9d1=_0x4c0d76;_0x5a974d[_0x91d9d1(0x82)](),_0x42fcdc(_0x1e176e);}),_0x5a974d['on'](_0x4c0d76(0x86),()=>{const _0x3d3154=_0x4c0d76;_0x4aa156=!![],_0x5a974d[_0x3d3154(0x82)](),_0x21931c(_0x1e176e);});}else{if(_0xf1dac==_0x4c0d76(0x77)){let _0x4b1338=taskObj,_0x1b9e8f=path[_0x4c0d76(0x91)](_0x914770),_0x45c000=[_0x4c0d76(0xba),_0x4c0d76(0x8d),'.tgz','.zip'];if(!_0x1b9e8f||!_0x45c000['includes'](_0x1b9e8f))return _0x42fcdc(_0x4b1338,i18n['__'](_0x4c0d76(0xc3)));let _0xa9221d=0x0,_0x2fec85=0x0,_0x42b14b,_0x4a070a=new compressing[(_0x1b9e8f[_0x4c0d76(0x7c)]('.',''))][(_0x4c0d76(0xbc))]({'source':_0x914770});_0x4a070a['on']('error',_0x5ad201=>{_0x42b14b&&(_0x42b14b['close'](),_0x42b14b=null),_0x42fcdc(_0x4b1338);}),_0x4a070a['on']('finish',()=>{const _0xd6e4af=_0x4c0d76;_0x42b14b&&(_0x42b14b[_0xd6e4af(0x82)](),_0x42b14b=null),_0x21931c(_0x4b1338);}),_0x4a070a['on'](_0x4c0d76(0x96),(_0x4f051c,_0x1109be,_0x53054a)=>{const _0x35f09f=_0x4c0d76;_0x1109be['on'](_0x35f09f(0x87),_0x53054a);let _0x5e75ce=path[_0x35f09f(0xbe)](_0x4f1b14,_0x4f051c[_0x35f09f(0x8f)]),_0x391092=path[_0x35f09f(0x84)](_0x5e75ce);!fs[_0x35f09f(0xa2)](_0x391092)&&fs[_0x35f09f(0x78)](_0x391092,{'recursive':!![]}),_0x42b14b=fs['createWriteStream'](_0x5e75ce),_0x42b14b['on'](_0x35f09f(0xc1),_0x25a1e6=>{const _0x11a211=_0x35f09f;console[_0x11a211(0x6e)](_0x25a1e6);}),_0x4f051c[_0x35f09f(0x7e)]===_0x35f09f(0x90)?(_0x1109be['on'](_0x35f09f(0x8e),_0x2e5f37=>{const _0x5c2978=_0x35f09f;_0xa9221d+=_0x2e5f37['length'];let _0x2f5368=_0xa9221d/0x400/0x400;if(_0x2f5368>_0x2fec85+0x64){_0x2fec85=_0x2f5368,dbOther[_0x5c2978(0xa3)](_0x5c2978(0xac))[_0x5c2978(0x81)](_0xa9221d,_0x4b1338['id']);let _0x2a58ed=dbOther[_0x5c2978(0xa3)](_0x5c2978(0x83)+_0x4b1338['id'])[_0x5c2978(0x9a)]();if(!_0x2a58ed||_0x2a58ed[_0x5c2978(0x72)]!=0x1&&!isFinish)return _0x42b14b[_0x5c2978(0x82)](),_0x1109be['on'](_0x5c2978(0x87),()=>{}),_0x1109be[_0x5c2978(0x7a)](),_0x42b14b[_0x5c2978(0x7a)](),_0x4a070a['destroy'](),_0x42fcdc(_0x4b1338);}}),_0x1109be[_0x35f09f(0x89)](_0x42b14b)):mkdirp(path[_0x35f09f(0xbe)](_0x4f1b14,_0x4f051c[_0x35f09f(0x8f)]),_0x5a6b1d=>{const _0x44d9a8=_0x35f09f;if(_0x5a6b1d)return;_0x1109be[_0x44d9a8(0x8b)]();});});}else _0x21931c();}}}}catch(_0x4af8d7){console[_0x4c0d76(0x6e)](_0x4af8d7),_0x42fcdc();}}async function taskStart(_0xeeaf1b){return new Promise((_0x54253b,_0xfea477)=>{const _0x1281f2=_0x2b60;taskObj=dbOther[_0x1281f2(0xa3)]('SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id='+_0xeeaf1b)[_0x1281f2(0x9a)]();if(taskObj){taskParams=JSON[_0x1281f2(0xb4)](taskObj[_0x1281f2(0x80)]),dbOther[_0x1281f2(0xa3)](_0x1281f2(0xa9)+taskObj['id'])[_0x1281f2(0x81)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x4cf9bc=dbFileOperationRecord[_0x1281f2(0xa5)](dbOther,{'username':taskParams[_0x1281f2(0xb2)],'sourcePath':taskParams['sourcePath'],'targetPath':taskParams['targetPath'],'level':dbFileOperationRecord[_0x1281f2(0x97)],'type':taskParams[_0x1281f2(0x7e)],'state':dbFileOperationRecord['STATE_DOING']});_0x4cf9bc&&(currentFileOperationRecordId=_0x4cf9bc['lastInsertRowid']),doFileOperation(taskParams,_0x54253b);}else _0x54253b();});}function exitProcess(){const _0x1fa92a=_0x51e0cc;process[_0x1fa92a(0x79)]({'type':_0x1fa92a(0x82)}),process['exit']();}process['on'](_0x51e0cc(0x9e),async _0x584360=>{const _0x49bb8f=_0x51e0cc;try{if(_0x584360[_0x49bb8f(0xc4)]&&_0x584360['taskIdList'][_0x49bb8f(0x94)]>0x0){for(let _0x303432 in _0x584360[_0x49bb8f(0xc4)]){await taskStart(_0x584360[_0x49bb8f(0xc4)][_0x303432]);}exitProcess();}else exitProcess();}catch(_0x423467){exitProcess();}});