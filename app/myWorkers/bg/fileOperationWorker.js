const _0x323802=_0x5645;(function(_0x505510,_0x3c30df){const _0x25dca7=_0x5645,_0x1810bb=_0x505510();while(!![]){try{const _0x1b2dcd=parseInt(_0x25dca7(0x97))/0x1+-parseInt(_0x25dca7(0xe7))/0x2*(-parseInt(_0x25dca7(0xd5))/0x3)+-parseInt(_0x25dca7(0xe5))/0x4+-parseInt(_0x25dca7(0x9b))/0x5+-parseInt(_0x25dca7(0x98))/0x6*(-parseInt(_0x25dca7(0xb0))/0x7)+parseInt(_0x25dca7(0xa7))/0x8+-parseInt(_0x25dca7(0xeb))/0x9*(parseInt(_0x25dca7(0xa5))/0xa);if(_0x1b2dcd===_0x3c30df)break;else _0x1810bb['push'](_0x1810bb['shift']());}catch(_0x3becaa){_0x1810bb['push'](_0x1810bb['shift']());}}}(_0x4265,0x859e3));let path=require(_0x323802(0xaa)),fs=require('fs');const dbFileOperationRecord=require(_0x323802(0xda)),config=require(_0x323802(0xc5)),Database=require(_0x323802(0xd8));let dbOther=new Database(config[_0x323802(0xc0)],{});dbOther[_0x323802(0xdc)](_0x323802(0x96));let i18nUtil=require(_0x323802(0xbe)),i18n=i18nUtil[_0x323802(0xaf)](dbOther);const compressing=require(_0x323802(0xec)),mkdirp=require('mkdirp'),fileUtils=require(_0x323802(0x9c));function _0x4265(){const _0x1421b6=['dbOther','lastInsertRowid','length','destroy','name','../../myConfig/config','addFileOperationRecord','pipe','log','get','end','targetPath','readdirSync','type','taskIdList','username','unzip','.tgz','join','finish','.gzip','4077OLnUmB','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','NasCabFileWorker','better-sqlite3','existsSync','../../db/dbFileOperationRecord','error','pragma','rename','file','sourcePath','R_OK','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','includes','sameNameFileAlreadExist','exit','1120588EqUOlj','basename','178dsZGXF','.tar','message','task_state','9GKaDbE','compressing','replace','mkdirSync','accessSync','journal_mode\x20=\x20WAL','674269tuxlfu','2918658lcPRLy','STATE_FAIL','.zip','1531110JybfYu','../../express-server/utils/fileUtils','updateRecordState','notSupportFileFormat','LEVEL_MAIN_OPERATION','copy','select\x20task_state\x20from\x20bg_task\x20where\x20id=','extname','STATE_SUC','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','1529810QqZrOJ','getFileErrStr','39888saLzbF','parse','close','path','cpSync','data','isFile','task_json','getI18n','7dhYMyf','substring','statSync','zip','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','isDirectory','run','addEntry','cut','UncompressStream','createWriteStream','updateRecordRemark','STATE_DOING','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','../../utils/i18nUtil','prepare'];_0x4265=function(){return _0x1421b6;};return _0x4265();}process['title']=_0x323802(0xd7);function _0x5645(_0x728ca5,_0x8d48fa){const _0x426594=_0x4265();return _0x5645=function(_0x5645ed,_0x3ff8ca){_0x5645ed=_0x5645ed-0x93;let _0x161272=_0x426594[_0x5645ed];return _0x161272;},_0x5645(_0x728ca5,_0x8d48fa);}let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x4e2735,_0x4f53cc){const _0x4fb38f=_0x323802;if(fs[_0x4fb38f(0xd9)](_0x4e2735)){let _0x53583f=path[_0x4fb38f(0xe6)](_0x4e2735),_0x433c7f=path['dirname'](_0x4e2735),_0x9c9be6=path['extname'](_0x4e2735),_0x46849d=_0x53583f['replace'](_0x9c9be6,'')+('('+_0x4f53cc+')')+_0x9c9be6,_0x1adbc7=path[_0x4fb38f(0xd2)](_0x433c7f,_0x46849d);return getTargetFullPath(_0x1adbc7,_0x4f53cc+0x1);}else return _0x4e2735;}function copyFile(_0x5e2777,_0x48aad2,_0x448663,_0x4eb1ec){const _0x110c6f=_0x323802;try{let _0x5b8917=dbOther[_0x110c6f(0xbf)](_0x110c6f(0xa1)+taskObj['id'])[_0x110c6f(0xc9)]();if(!_0x5b8917||_0x5b8917[_0x110c6f(0xea)]!=0x1)return paused=!![],![];let _0x5de31f=fs[_0x110c6f(0xb2)](_0x48aad2);return _0x448663=getTargetFullPath(_0x448663,0x1),fs[_0x110c6f(0xab)](_0x48aad2,_0x448663),copySize+=_0x5de31f['size'],copyFileCount+=0x1,dbOther[_0x110c6f(0xbf)](_0x110c6f(0xbd))[_0x110c6f(0xb6)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x118011){return console[_0x110c6f(0xc8)](_0x118011),dbFileOperationRecord[_0x110c6f(0xbb)](dbOther,currentFileOperationRecordId,fileUtils[_0x110c6f(0xa6)](i18n,_0x118011)),![];}}function copyFolder(_0x2412ce,_0x16a426,_0x582688,_0x5d15db,_0x442219){const _0x120637=_0x323802;try{fs[_0x120637(0x95)](_0x582688,fs['constants'][_0x120637(0xe0)]);let _0x23e422=fs[_0x120637(0xcc)](_0x582688);for(let _0x28e0a3=0x0;_0x28e0a3<_0x23e422[_0x120637(0xc2)];_0x28e0a3++){if(paused)return![];let _0xbdcf70=_0x23e422[_0x28e0a3];var _0x389a26=path[_0x120637(0xd2)](_0x582688,_0xbdcf70);let _0x164e90=path['join'](_0x5d15db,_0x389a26[_0x120637(0xb1)](_0x16a426[_0x120637(0xc2)])),_0x596e4e=fs[_0x120637(0xb2)](_0x389a26);if(_0x596e4e['isFile']()){let _0x2df8c5=copyFile(_0x2412ce,_0x389a26,_0x164e90,_0x442219);if(_0x2df8c5===![])return paused=!![],dbFileOperationRecord[_0x120637(0xbb)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x596e4e['isDirectory']()&&(!fs[_0x120637(0xd9)](_0x164e90)&&fs[_0x120637(0x94)](_0x164e90,{'recursive':!![]}),copyFolder(_0x2412ce,_0x16a426,_0x389a26,_0x5d15db,_0x442219));}if(paused)return![];return!![];}catch(_0x593ef5){return![];}}async function doFileOperation(_0x400a88,_0x49d4f4){const _0x41349b=_0x323802;let _0x31ee02=_0x400a88[_0x41349b(0xdf)],_0x343dca=_0x400a88['targetPath'],_0x55cecc=_0x400a88['type'];function _0xdc6a4e(_0x5f3b3e,_0x2d5e2e){const _0x2167d6=_0x41349b;if(_0x5f3b3e)taskObj=_0x5f3b3e;dbOther[_0x2167d6(0xbf)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])['run'](),dbFileOperationRecord[_0x2167d6(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x2167d6(0x99)]),_0x2d5e2e&&dbFileOperationRecord[_0x2167d6(0xbb)](dbOther,currentFileOperationRecordId,_0x2d5e2e),_0x49d4f4();}function _0x1a2cfd(_0x438329,_0x30543e){const _0x1b6c1d=_0x41349b;if(_0x438329)taskObj=_0x438329;dbOther[_0x1b6c1d(0xbf)](_0x1b6c1d(0xa4)+taskObj['id'])[_0x1b6c1d(0xb6)](),_0x55cecc==_0x1b6c1d(0xb8)&&_0x30543e?fs['rm'](_0x31ee02,{'recursive':!![]},_0x240dfc=>{const _0x570992=_0x1b6c1d;_0x240dfc?(dbFileOperationRecord[_0x570992(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x570992(0x99)]),dbFileOperationRecord[_0x570992(0xbb)](dbOther,currentFileOperationRecordId,i18n['__']('file.cutCopySucButDeleteFail'))):dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_SUC']),_0x49d4f4();}):(dbFileOperationRecord[_0x1b6c1d(0x9d)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x1b6c1d(0xa3)]),_0x49d4f4());}try{let _0x6e16c5=fs[_0x41349b(0xb2)](_0x31ee02);function _0x38804e(_0x5a7668){const _0x18e381=_0x41349b;if(_0x6e16c5[_0x18e381(0xad)]()){let _0x40923b=copyFile(_0x400a88,_0x31ee02,_0x343dca,_0x55cecc);_0x40923b?_0x1a2cfd(_0x5a7668,!![]):_0xdc6a4e(_0x5a7668);}else{if(_0x6e16c5[_0x18e381(0xb5)]()){_0x343dca=getTargetFullPath(_0x343dca,0x1);!fs[_0x18e381(0xd9)](_0x343dca)&&fs[_0x18e381(0x94)](_0x343dca,{'recursive':!![]});let _0x4c3eaf=copyFolder(_0x400a88,_0x31ee02,_0x31ee02,_0x343dca,_0x55cecc);_0x4c3eaf?_0x1a2cfd(_0x5a7668,!![]):_0xdc6a4e(_0x5a7668);}}}if(_0x55cecc==_0x41349b(0xa0))_0x38804e(taskObj);else{if(_0x55cecc==_0x41349b(0xb8))fs[_0x41349b(0xdd)](_0x31ee02,_0x343dca,_0x372ab0=>{if(_0x372ab0)return _0x38804e(taskObj);else _0x1a2cfd(taskObj,![]);});else{if(_0x55cecc=='zip'){let _0x2955bd=path[_0x41349b(0xe6)](_0x31ee02),_0x304866=path['join'](_0x343dca,_0x2955bd+_0x41349b(0x9a));if(fs[_0x41349b(0xd9)](_0x304866))return _0xdc6a4e(taskObj,i18n['__'](_0x41349b(0xe3))+':'+_0x304866);let _0x29b78f=fs[_0x41349b(0xba)](_0x304866),_0x157e26=taskObj,_0x5969e4=0x0,_0x5307d1=0x0,_0x16275f,_0x298c34=![];if(_0x6e16c5[_0x41349b(0xad)]())_0x16275f=new compressing[(_0x41349b(0xb3))]['FileStream']({'source':_0x31ee02});else _0x6e16c5[_0x41349b(0xb5)]()&&(_0x16275f=new compressing[(_0x41349b(0xb3))]['Stream'](),_0x16275f[_0x41349b(0xb7)](_0x31ee02));_0x16275f['on'](_0x41349b(0xac),_0x3363f7=>{const _0x2f4149=_0x41349b;_0x5969e4+=_0x3363f7[_0x2f4149(0xc2)];let _0x383aee=_0x5969e4/0x400/0x400;if(_0x383aee>_0x5307d1+0x64){_0x5307d1=_0x383aee,dbOther[_0x2f4149(0xbf)](_0x2f4149(0xb4))[_0x2f4149(0xb6)](_0x5969e4,_0x157e26['id']);let _0x115dbb=dbOther[_0x2f4149(0xbf)](_0x2f4149(0xa1)+_0x157e26['id'])[_0x2f4149(0xc9)]();(!_0x115dbb||_0x115dbb['task_state']!=0x1&&!_0x298c34)&&(_0x29b78f[_0x2f4149(0xa9)](),_0x16275f[_0x2f4149(0xc3)](),_0xdc6a4e(_0x157e26));}}),_0x16275f[_0x41349b(0xc7)](_0x29b78f),_0x16275f['on'](_0x41349b(0xdb),_0x3a3220=>{const _0x3282d8=_0x41349b;_0x29b78f[_0x3282d8(0xa9)](),_0xdc6a4e(_0x157e26);}),_0x29b78f['on'](_0x41349b(0xdb),_0x159bee=>{const _0xcba8cd=_0x41349b;_0x29b78f[_0xcba8cd(0xa9)](),_0xdc6a4e(_0x157e26);}),_0x29b78f['on'](_0x41349b(0xd3),()=>{const _0x41377a=_0x41349b;_0x298c34=!![],_0x29b78f[_0x41377a(0xa9)](),_0x1a2cfd(_0x157e26);});}else{if(_0x55cecc==_0x41349b(0xd0)){let _0x25a90d=taskObj,_0xeb5589=path[_0x41349b(0xa2)](_0x31ee02),_0x416a0f=[_0x41349b(0xe8),_0x41349b(0xd4),_0x41349b(0xd1),_0x41349b(0x9a)];if(!_0xeb5589||!_0x416a0f[_0x41349b(0xe2)](_0xeb5589))return _0xdc6a4e(_0x25a90d,i18n['__'](_0x41349b(0x9e)));let _0x1c0d1d=0x0,_0x58bdae=0x0,_0x219cb9,_0x5a492b=new compressing[(_0xeb5589[_0x41349b(0x93)]('.',''))][(_0x41349b(0xb9))]({'source':_0x31ee02});_0x5a492b['on'](_0x41349b(0xdb),_0x5eb551=>{const _0x483302=_0x41349b;_0x219cb9&&(_0x219cb9[_0x483302(0xa9)](),_0x219cb9=null),_0xdc6a4e(_0x25a90d);}),_0x5a492b['on'](_0x41349b(0xd3),()=>{_0x219cb9&&(_0x219cb9['close'](),_0x219cb9=null),_0x1a2cfd(_0x25a90d);}),_0x5a492b['on']('entry',(_0xb76fff,_0x17d8aa,_0xba07c)=>{const _0x367a69=_0x41349b;_0x17d8aa['on'](_0x367a69(0xca),_0xba07c);let _0x2ef05=path[_0x367a69(0xd2)](_0x343dca,_0xb76fff[_0x367a69(0xc4)]),_0x390cdc=path['dirname'](_0x2ef05);!fs[_0x367a69(0xd9)](_0x390cdc)&&fs[_0x367a69(0x94)](_0x390cdc,{'recursive':!![]}),_0x219cb9=fs[_0x367a69(0xba)](_0x2ef05),_0x219cb9['on'](_0x367a69(0xdb),_0xb407a0=>{const _0x5c7f3d=_0x367a69;console[_0x5c7f3d(0xc8)](_0xb407a0);}),_0xb76fff['type']===_0x367a69(0xde)?(_0x17d8aa['on'](_0x367a69(0xac),_0x102db4=>{const _0x330158=_0x367a69;_0x1c0d1d+=_0x102db4[_0x330158(0xc2)];let _0x4a9204=_0x1c0d1d/0x400/0x400;if(_0x4a9204>_0x58bdae+0x64){_0x58bdae=_0x4a9204,dbOther['prepare'](_0x330158(0xb4))['run'](_0x1c0d1d,_0x25a90d['id']);let _0xb6342e=dbOther['prepare'](_0x330158(0xa1)+_0x25a90d['id'])['get']();if(!_0xb6342e||_0xb6342e[_0x330158(0xea)]!=0x1&&!isFinish)return _0x219cb9['close'](),_0x17d8aa['on']('end',()=>{}),_0x17d8aa[_0x330158(0xc3)](),_0x219cb9['destroy'](),_0x5a492b['destroy'](),_0xdc6a4e(_0x25a90d);}}),_0x17d8aa[_0x367a69(0xc7)](_0x219cb9)):mkdirp(path[_0x367a69(0xd2)](_0x343dca,_0xb76fff[_0x367a69(0xc4)]),_0x377194=>{if(_0x377194)return;_0x17d8aa['resume']();});});}else _0x1a2cfd();}}}}catch(_0x46986c){console['log'](_0x46986c),_0xdc6a4e();}}async function taskStart(_0x519910){return new Promise((_0x48e3ad,_0x4843ec)=>{const _0x947830=_0x5645;taskObj=dbOther[_0x947830(0xbf)](_0x947830(0xd6)+_0x519910)[_0x947830(0xc9)]();if(taskObj){taskParams=JSON[_0x947830(0xa8)](taskObj[_0x947830(0xae)]),dbOther['prepare'](_0x947830(0xe1)+taskObj['id'])['run'](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x25d821=dbFileOperationRecord[_0x947830(0xc6)](dbOther,{'username':taskParams[_0x947830(0xcf)],'sourcePath':taskParams['sourcePath'],'targetPath':taskParams[_0x947830(0xcb)],'level':dbFileOperationRecord[_0x947830(0x9f)],'type':taskParams[_0x947830(0xcd)],'state':dbFileOperationRecord[_0x947830(0xbc)]});_0x25d821&&(currentFileOperationRecordId=_0x25d821[_0x947830(0xc1)]),doFileOperation(taskParams,_0x48e3ad);}else _0x48e3ad();});}function exitProcess(){const _0x4af447=_0x323802;process['send']({'type':_0x4af447(0xa9)}),process[_0x4af447(0xe4)]();}process['on'](_0x323802(0xe9),async _0x1673e6=>{const _0xd28956=_0x323802;try{if(_0x1673e6['taskIdList']&&_0x1673e6[_0xd28956(0xce)]['length']>0x0){for(let _0xe761df in _0x1673e6[_0xd28956(0xce)]){await taskStart(_0x1673e6[_0xd28956(0xce)][_0xe761df]);}exitProcess();}else exitProcess();}catch(_0x59183b){exitProcess();}});