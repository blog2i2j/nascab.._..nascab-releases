const _0x2d2c24=_0x2bb3;(function(_0x4f21a7,_0x38017e){const _0x1151a9=_0x2bb3,_0x44662b=_0x4f21a7();while(!![]){try{const _0x590390=parseInt(_0x1151a9(0xaf))/0x1+parseInt(_0x1151a9(0xa3))/0x2+-parseInt(_0x1151a9(0x8f))/0x3+parseInt(_0x1151a9(0xb5))/0x4+parseInt(_0x1151a9(0xb6))/0x5*(parseInt(_0x1151a9(0x8a))/0x6)+-parseInt(_0x1151a9(0x7f))/0x7+-parseInt(_0x1151a9(0x82))/0x8*(parseInt(_0x1151a9(0x86))/0x9);if(_0x590390===_0x38017e)break;else _0x44662b['push'](_0x44662b['shift']());}catch(_0x3522d7){_0x44662b['push'](_0x44662b['shift']());}}}(_0x2a1f,0x5c544));let path=require(_0x2d2c24(0x8b)),fs=require('fs');const dbFileOperationRecord=require(_0x2d2c24(0x9d)),config=require(_0x2d2c24(0x74)),Database=require(_0x2d2c24(0x96));function _0x2a1f(){const _0x13f341=['journal_mode\x20=\x20WAL','sourcePath','R_OK','.tgz','STATE_SUC','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','../../myConfig/config','get','task_json','prepare','size','updateRecordRemark','mkdirSync','.zip','includes','replace','FileStream','2252089KKfKoy','length','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','16stdmku','cpSync','UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?','updateRecordState','1205451JBBdKr','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','send','.gzip','1457550EngrMj','path','unzip','join','addEntry','664263NdEFIE','select\x20task_state\x20from\x20bg_task\x20where\x20id=','run','entry','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','log','destroy','better-sqlite3','close','rename','LEVEL_MAIN_OPERATION','pragma','title','file.cutCopySucButDeleteFail','../../db/dbFileOperationRecord','zip','extname','error','statSync','pipe','945186wOoOSh','basename','taskIdList','.tar','name','constants','username','../../express-server/utils/fileUtils','sameNameFileAlreadExist','NasCabFileWorker','createWriteStream','dirname','200395MdDlIM','task_state','file','existsSync','isDirectory','readdirSync','121472pwtFid','10dFAUov','compressing','exit','end','data','mkdirp','STATE_FAIL','type','Stream','resume','addFileOperationRecord','accessSync','../../utils/i18nUtil','targetPath','cut','UncompressStream'];_0x2a1f=function(){return _0x13f341;};return _0x2a1f();}let dbOther=new Database(config['dbOther'],{});dbOther[_0x2d2c24(0x9a)](_0x2d2c24(0x6e));let i18nUtil=require(_0x2d2c24(0xc2)),i18n=i18nUtil['getI18n'](dbOther);const compressing=require(_0x2d2c24(0xb7)),mkdirp=require(_0x2d2c24(0xbb)),fileUtils=require(_0x2d2c24(0xaa));process[_0x2d2c24(0x9b)]=_0x2d2c24(0xac);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x29393,_0xee38da){const _0x4b790e=_0x2d2c24;if(fs[_0x4b790e(0xb2)](_0x29393)){let _0x1ff779=path[_0x4b790e(0xa4)](_0x29393),_0x8a004d=path[_0x4b790e(0xae)](_0x29393),_0x350605=path['extname'](_0x29393),_0x5a7ec2=_0x1ff779[_0x4b790e(0x7d)](_0x350605,'')+('('+_0xee38da+')')+_0x350605,_0x2bb7a7=path['join'](_0x8a004d,_0x5a7ec2);return getTargetFullPath(_0x2bb7a7,_0xee38da+0x1);}else return _0x29393;}function copyFile(_0x13b090,_0x59e27b,_0x268557,_0x2d7303){const _0x38a191=_0x2d2c24;try{let _0x22ad81=dbOther[_0x38a191(0x77)]('select\x20task_state\x20from\x20bg_task\x20where\x20id='+taskObj['id'])[_0x38a191(0x75)]();if(!_0x22ad81||_0x22ad81[_0x38a191(0xb0)]!=0x1)return paused=!![],![];let _0x39b14f=fs[_0x38a191(0xa1)](_0x59e27b);return _0x268557=getTargetFullPath(_0x268557,0x1),fs[_0x38a191(0x83)](_0x59e27b,_0x268557),copySize+=_0x39b14f[_0x38a191(0x78)],copyFileCount+=0x1,dbOther[_0x38a191(0x77)](_0x38a191(0x84))[_0x38a191(0x91)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x119d8e){return console[_0x38a191(0x94)](_0x119d8e),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,fileUtils['getFileErrStr'](i18n,_0x119d8e)),![];}}function copyFolder(_0x28ff11,_0x4af626,_0x1e5046,_0x26af7b,_0x39038c){const _0x49fa62=_0x2d2c24;try{fs[_0x49fa62(0xc1)](_0x1e5046,fs[_0x49fa62(0xa8)][_0x49fa62(0x70)]);let _0x3fc979=fs[_0x49fa62(0xb4)](_0x1e5046);for(let _0x4357fe=0x0;_0x4357fe<_0x3fc979[_0x49fa62(0x80)];_0x4357fe++){if(paused)return![];let _0x4a2562=_0x3fc979[_0x4357fe];var _0x230c66=path[_0x49fa62(0x8d)](_0x1e5046,_0x4a2562);let _0x369315=path[_0x49fa62(0x8d)](_0x26af7b,_0x230c66['substring'](_0x4af626[_0x49fa62(0x80)])),_0x103beb=fs[_0x49fa62(0xa1)](_0x230c66);if(_0x103beb['isFile']()){let _0x1953ef=copyFile(_0x28ff11,_0x230c66,_0x369315,_0x39038c);if(_0x1953ef===![])return paused=!![],dbFileOperationRecord[_0x49fa62(0x79)](dbOther,currentFileOperationRecordId,i18n['__']('file.taskCancel')),![];}else _0x103beb[_0x49fa62(0xb3)]()&&(!fs[_0x49fa62(0xb2)](_0x369315)&&fs[_0x49fa62(0x7a)](_0x369315,{'recursive':!![]}),copyFolder(_0x28ff11,_0x4af626,_0x230c66,_0x26af7b,_0x39038c));}if(paused)return![];return!![];}catch(_0x10cd85){return![];}}function _0x2bb3(_0x1a7166,_0x1e6f84){const _0x2a1f0b=_0x2a1f();return _0x2bb3=function(_0x2bb3ff,_0x217559){_0x2bb3ff=_0x2bb3ff-0x6c;let _0x18c170=_0x2a1f0b[_0x2bb3ff];return _0x18c170;},_0x2bb3(_0x1a7166,_0x1e6f84);}async function doFileOperation(_0x59b77a,_0x183635){const _0x23e912=_0x2d2c24;let _0x491bcf=_0x59b77a[_0x23e912(0x6f)],_0x76acc=_0x59b77a[_0x23e912(0xc3)],_0x4fdf69=_0x59b77a[_0x23e912(0xbd)];function _0x55feed(_0x4cd324,_0x495e25){const _0x54153e=_0x23e912;if(_0x4cd324)taskObj=_0x4cd324;dbOther[_0x54153e(0x77)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])[_0x54153e(0x91)](),dbFileOperationRecord[_0x54153e(0x85)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x54153e(0xbc)]),_0x495e25&&dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,_0x495e25),_0x183635();}function _0x28f2f9(_0x367adf,_0x24ccae){const _0xfddc64=_0x23e912;if(_0x367adf)taskObj=_0x367adf;dbOther[_0xfddc64(0x77)](_0xfddc64(0x73)+taskObj['id'])[_0xfddc64(0x91)](),_0x4fdf69=='cut'&&_0x24ccae?fs['rm'](_0x491bcf,{'recursive':!![]},_0x43f5dd=>{const _0x10f0c4=_0xfddc64;_0x43f5dd?(dbFileOperationRecord[_0x10f0c4(0x85)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x10f0c4(0xbc)]),dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__'](_0x10f0c4(0x9c)))):dbFileOperationRecord[_0x10f0c4(0x85)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x10f0c4(0x72)]),_0x183635();}):(dbFileOperationRecord['updateRecordState'](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0xfddc64(0x72)]),_0x183635());}try{let _0x277729=fs['statSync'](_0x491bcf);function _0x416d1e(_0xb8424d){const _0x1a762e=_0x23e912;if(_0x277729['isFile']()){let _0x318439=copyFile(_0x59b77a,_0x491bcf,_0x76acc,_0x4fdf69);_0x318439?_0x28f2f9(_0xb8424d,!![]):_0x55feed(_0xb8424d);}else{if(_0x277729[_0x1a762e(0xb3)]()){_0x76acc=getTargetFullPath(_0x76acc,0x1);!fs['existsSync'](_0x76acc)&&fs[_0x1a762e(0x7a)](_0x76acc,{'recursive':!![]});let _0x5586b5=copyFolder(_0x59b77a,_0x491bcf,_0x491bcf,_0x76acc,_0x4fdf69);_0x5586b5?_0x28f2f9(_0xb8424d,!![]):_0x55feed(_0xb8424d);}}}if(_0x4fdf69=='copy')_0x416d1e(taskObj);else{if(_0x4fdf69==_0x23e912(0x6c))fs[_0x23e912(0x98)](_0x491bcf,_0x76acc,_0x211f07=>{if(_0x211f07)return _0x416d1e(taskObj);else _0x28f2f9(taskObj,![]);});else{if(_0x4fdf69==_0x23e912(0x9e)){let _0xd5aeeb=path[_0x23e912(0xa4)](_0x491bcf),_0x2d30de=path[_0x23e912(0x8d)](_0x76acc,_0xd5aeeb+_0x23e912(0x7b));if(fs['existsSync'](_0x2d30de))return _0x55feed(taskObj,i18n['__'](_0x23e912(0xab))+':'+_0x2d30de);let _0x52346f=fs['createWriteStream'](_0x2d30de),_0x366aa5=taskObj,_0x51b31f=0x0,_0x278fef=0x0,_0x122167,_0x425873=![];if(_0x277729['isFile']())_0x122167=new compressing[(_0x23e912(0x9e))][(_0x23e912(0x7e))]({'source':_0x491bcf});else _0x277729[_0x23e912(0xb3)]()&&(_0x122167=new compressing['zip'][(_0x23e912(0xbe))](),_0x122167[_0x23e912(0x8e)](_0x491bcf));_0x122167['on'](_0x23e912(0xba),_0x3f9657=>{const _0x391bdc=_0x23e912;_0x51b31f+=_0x3f9657['length'];let _0xdb3652=_0x51b31f/0x400/0x400;if(_0xdb3652>_0x278fef+0x64){_0x278fef=_0xdb3652,dbOther[_0x391bdc(0x77)](_0x391bdc(0x81))[_0x391bdc(0x91)](_0x51b31f,_0x366aa5['id']);let _0x18fdef=dbOther[_0x391bdc(0x77)](_0x391bdc(0x90)+_0x366aa5['id'])[_0x391bdc(0x75)]();(!_0x18fdef||_0x18fdef[_0x391bdc(0xb0)]!=0x1&&!_0x425873)&&(_0x52346f[_0x391bdc(0x97)](),_0x122167[_0x391bdc(0x95)](),_0x55feed(_0x366aa5));}}),_0x122167[_0x23e912(0xa2)](_0x52346f),_0x122167['on'](_0x23e912(0xa0),_0x15fe0e=>{const _0x137ce=_0x23e912;_0x52346f[_0x137ce(0x97)](),_0x55feed(_0x366aa5);}),_0x52346f['on'](_0x23e912(0xa0),_0x23e7d4=>{const _0x1bc3b6=_0x23e912;_0x52346f[_0x1bc3b6(0x97)](),_0x55feed(_0x366aa5);}),_0x52346f['on']('finish',()=>{const _0x1a551f=_0x23e912;_0x425873=!![],_0x52346f[_0x1a551f(0x97)](),_0x28f2f9(_0x366aa5);});}else{if(_0x4fdf69==_0x23e912(0x8c)){let _0x3c7d82=taskObj,_0x3bd472=path[_0x23e912(0x9f)](_0x491bcf),_0x53bf0d=[_0x23e912(0xa6),_0x23e912(0x89),_0x23e912(0x71),_0x23e912(0x7b)];if(!_0x3bd472||!_0x53bf0d[_0x23e912(0x7c)](_0x3bd472))return _0x55feed(_0x3c7d82,i18n['__']('notSupportFileFormat'));let _0x382657=0x0,_0x2ad130=0x0,_0x43bad2,_0x4ecb89=new compressing[(_0x3bd472[_0x23e912(0x7d)]('.',''))][(_0x23e912(0x6d))]({'source':_0x491bcf});_0x4ecb89['on'](_0x23e912(0xa0),_0x484a0a=>{const _0x498626=_0x23e912;_0x43bad2&&(_0x43bad2[_0x498626(0x97)](),_0x43bad2=null),_0x55feed(_0x3c7d82);}),_0x4ecb89['on']('finish',()=>{_0x43bad2&&(_0x43bad2['close'](),_0x43bad2=null),_0x28f2f9(_0x3c7d82);}),_0x4ecb89['on'](_0x23e912(0x92),(_0x328f65,_0x3b9780,_0x5b8ed7)=>{const _0x532290=_0x23e912;_0x3b9780['on'](_0x532290(0xb9),_0x5b8ed7);let _0x5fd102=path[_0x532290(0x8d)](_0x76acc,_0x328f65[_0x532290(0xa7)]),_0x4c5d19=path[_0x532290(0xae)](_0x5fd102);!fs['existsSync'](_0x4c5d19)&&fs[_0x532290(0x7a)](_0x4c5d19,{'recursive':!![]}),_0x43bad2=fs[_0x532290(0xad)](_0x5fd102),_0x43bad2['on']('error',_0x56b6d7=>{const _0x573340=_0x532290;console[_0x573340(0x94)](_0x56b6d7);}),_0x328f65[_0x532290(0xbd)]===_0x532290(0xb1)?(_0x3b9780['on'](_0x532290(0xba),_0x3d00c6=>{const _0x4b7735=_0x532290;_0x382657+=_0x3d00c6[_0x4b7735(0x80)];let _0x57ce33=_0x382657/0x400/0x400;if(_0x57ce33>_0x2ad130+0x64){_0x2ad130=_0x57ce33,dbOther[_0x4b7735(0x77)]('UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?')['run'](_0x382657,_0x3c7d82['id']);let _0x3765d8=dbOther[_0x4b7735(0x77)](_0x4b7735(0x90)+_0x3c7d82['id'])[_0x4b7735(0x75)]();if(!_0x3765d8||_0x3765d8['task_state']!=0x1&&!isFinish)return _0x43bad2[_0x4b7735(0x97)](),_0x3b9780['on'](_0x4b7735(0xb9),()=>{}),_0x3b9780[_0x4b7735(0x95)](),_0x43bad2[_0x4b7735(0x95)](),_0x4ecb89[_0x4b7735(0x95)](),_0x55feed(_0x3c7d82);}}),_0x3b9780[_0x532290(0xa2)](_0x43bad2)):mkdirp(path['join'](_0x76acc,_0x328f65[_0x532290(0xa7)]),_0x12402c=>{const _0x5d9bec=_0x532290;if(_0x12402c)return;_0x3b9780[_0x5d9bec(0xbf)]();});});}else _0x28f2f9();}}}}catch(_0x6c11db){console['log'](_0x6c11db),_0x55feed();}}async function taskStart(_0x3265ba){return new Promise((_0xef01de,_0xb7cd26)=>{const _0x8aa8a1=_0x2bb3;taskObj=dbOther[_0x8aa8a1(0x77)](_0x8aa8a1(0x93)+_0x3265ba)[_0x8aa8a1(0x75)]();if(taskObj){taskParams=JSON['parse'](taskObj[_0x8aa8a1(0x76)]),dbOther['prepare'](_0x8aa8a1(0x87)+taskObj['id'])[_0x8aa8a1(0x91)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x2b1905=dbFileOperationRecord[_0x8aa8a1(0xc0)](dbOther,{'username':taskParams[_0x8aa8a1(0xa9)],'sourcePath':taskParams[_0x8aa8a1(0x6f)],'targetPath':taskParams[_0x8aa8a1(0xc3)],'level':dbFileOperationRecord[_0x8aa8a1(0x99)],'type':taskParams[_0x8aa8a1(0xbd)],'state':dbFileOperationRecord['STATE_DOING']});_0x2b1905&&(currentFileOperationRecordId=_0x2b1905['lastInsertRowid']),doFileOperation(taskParams,_0xef01de);}else _0xef01de();});}function exitProcess(){const _0x3c8fce=_0x2d2c24;process[_0x3c8fce(0x88)]({'type':'close'}),process[_0x3c8fce(0xb8)]();}process['on']('message',async _0x5affe7=>{const _0x2e9d4b=_0x2d2c24;try{if(_0x5affe7[_0x2e9d4b(0xa5)]&&_0x5affe7[_0x2e9d4b(0xa5)][_0x2e9d4b(0x80)]>0x0){for(let _0x4dd45c in _0x5affe7[_0x2e9d4b(0xa5)]){await taskStart(_0x5affe7['taskIdList'][_0x4dd45c]);}exitProcess();}else exitProcess();}catch(_0x573b88){exitProcess();}});