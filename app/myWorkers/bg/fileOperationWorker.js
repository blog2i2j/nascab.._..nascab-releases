const _0xaff781=_0x3f72;(function(_0x381e83,_0x18bce8){const _0x577583=_0x3f72,_0x497535=_0x381e83();while(!![]){try{const _0xf513f8=-parseInt(_0x577583(0xfe))/0x1+-parseInt(_0x577583(0xf4))/0x2*(-parseInt(_0x577583(0xf3))/0x3)+-parseInt(_0x577583(0xfc))/0x4+parseInt(_0x577583(0xfd))/0x5+-parseInt(_0x577583(0x119))/0x6*(-parseInt(_0x577583(0x10c))/0x7)+-parseInt(_0x577583(0xe3))/0x8+-parseInt(_0x577583(0xd7))/0x9*(-parseInt(_0x577583(0xea))/0xa);if(_0xf513f8===_0x18bce8)break;else _0x497535['push'](_0x497535['shift']());}catch(_0x1e58c1){_0x497535['push'](_0x497535['shift']());}}}(_0x21ca,0x5a16b));let path=require('path'),fs=require('fs');const dbFileOperationRecord=require(_0xaff781(0x106)),config=require(_0xaff781(0xe9)),Database=require(_0xaff781(0xe2));let dbOther=new Database(config[_0xaff781(0x118)],{});function _0x3f72(_0x53c8c6,_0x1becb8){const _0x21ca3f=_0x21ca();return _0x3f72=function(_0x3f72d7,_0x11e296){_0x3f72d7=_0x3f72d7-0xc3;let _0x1e62d9=_0x21ca3f[_0x3f72d7];return _0x1e62d9;},_0x3f72(_0x53c8c6,_0x1becb8);}dbOther[_0xaff781(0x110)](_0xaff781(0xda));let i18nUtil=require(_0xaff781(0xcb)),i18n=i18nUtil[_0xaff781(0xd3)](dbOther);const compressing=require('compressing'),mkdirp=require(_0xaff781(0xe4)),fileUtils=require(_0xaff781(0xec));process[_0xaff781(0xed)]=_0xaff781(0x117);let copyFileCount=0x0,copySize=0x0,taskObj=null,paused=![],currentFileOperationRecordId=null,taskParams;function getTargetFullPath(_0x5a3e53,_0x507d58){const _0xcf060c=_0xaff781;if(fs[_0xcf060c(0xc6)](_0x5a3e53)){let _0x24cd8e=path[_0xcf060c(0xd2)](_0x5a3e53),_0x3dbca1=path[_0xcf060c(0x111)](_0x5a3e53),_0x1d84a7=path[_0xcf060c(0x109)](_0x5a3e53),_0x270346=_0x24cd8e[_0xcf060c(0x10b)](_0x1d84a7,'')+('('+_0x507d58+')')+_0x1d84a7,_0x5ab750=path[_0xcf060c(0xf9)](_0x3dbca1,_0x270346);return getTargetFullPath(_0x5ab750,_0x507d58+0x1);}else return _0x5a3e53;}function copyFile(_0x370565,_0x32a99a,_0xc6e212,_0x35a4c9){const _0x395a0b=_0xaff781;try{let _0x51803c=dbOther['prepare'](_0x395a0b(0xce)+taskObj['id'])[_0x395a0b(0x101)]();if(!_0x51803c||_0x51803c[_0x395a0b(0xc9)]!=0x1)return paused=!![],![];let _0x1b6d8e=fs[_0x395a0b(0xd5)](_0x32a99a);return _0xc6e212=getTargetFullPath(_0xc6e212,0x1),fs[_0x395a0b(0x104)](_0x32a99a,_0xc6e212),copySize+=_0x1b6d8e[_0x395a0b(0xc3)],copyFileCount+=0x1,dbOther[_0x395a0b(0xcf)]('UPDATE\x20bg_task\x20SET\x20progress_current=?,size_current=?\x20where\x20id=?')[_0x395a0b(0xe1)](copyFileCount,copySize,taskObj['id']),!![];}catch(_0x48fd02){return console[_0x395a0b(0x113)](_0x48fd02),dbFileOperationRecord[_0x395a0b(0xc4)](dbOther,currentFileOperationRecordId,fileUtils[_0x395a0b(0xff)](i18n,_0x48fd02)),![];}}function copyFolder(_0xf4e6ec,_0x446b69,_0xb7064c,_0xe7e088,_0x215164){const _0x2aba91=_0xaff781;try{fs[_0x2aba91(0xc7)](_0xb7064c,fs[_0x2aba91(0xf0)][_0x2aba91(0xcd)]);let _0x5b4185=fs['readdirSync'](_0xb7064c);for(let _0x3df073=0x0;_0x3df073<_0x5b4185[_0x2aba91(0xe8)];_0x3df073++){if(paused)return![];let _0x3209a0=_0x5b4185[_0x3df073];var _0x289c01=path[_0x2aba91(0xf9)](_0xb7064c,_0x3209a0);let _0x77ac81=path[_0x2aba91(0xf9)](_0xe7e088,_0x289c01[_0x2aba91(0xde)](_0x446b69[_0x2aba91(0xe8)])),_0x4d0219=fs[_0x2aba91(0xd5)](_0x289c01);if(_0x4d0219['isFile']()){let _0x79cc61=copyFile(_0xf4e6ec,_0x289c01,_0x77ac81,_0x215164);if(_0x79cc61===![])return paused=!![],dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,i18n['__'](_0x2aba91(0x116))),![];}else _0x4d0219['isDirectory']()&&(!fs[_0x2aba91(0xc6)](_0x77ac81)&&fs['mkdirSync'](_0x77ac81,{'recursive':!![]}),copyFolder(_0xf4e6ec,_0x446b69,_0x289c01,_0xe7e088,_0x215164));}if(paused)return![];return!![];}catch(_0xc7cd3a){return![];}}async function doFileOperation(_0x4e6090,_0xb90db6){const _0x38eeab=_0xaff781;let _0x267a96=_0x4e6090[_0x38eeab(0xd4)],_0x5634c7=_0x4e6090[_0x38eeab(0x11a)],_0x514d72=_0x4e6090[_0x38eeab(0x115)];function _0x250b8f(_0x4f1b44,_0x14382c){const _0x2b6c87=_0x38eeab;if(_0x4f1b44)taskObj=_0x4f1b44;dbOther[_0x2b6c87(0xcf)]('UPDATE\x20bg_task\x20SET\x20task_state=3\x20where\x20id='+taskObj['id'])[_0x2b6c87(0xe1)](),dbFileOperationRecord[_0x2b6c87(0xe6)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_FAIL']),_0x14382c&&dbFileOperationRecord['updateRecordRemark'](dbOther,currentFileOperationRecordId,_0x14382c),_0xb90db6();}function _0x2ad79f(_0xf57f69,_0x14d8fb){const _0x41f28f=_0x38eeab;if(_0xf57f69)taskObj=_0xf57f69;dbOther[_0x41f28f(0xcf)](_0x41f28f(0x10f)+taskObj['id'])[_0x41f28f(0xe1)](),_0x514d72==_0x41f28f(0xee)&&_0x14d8fb?fs['rm'](_0x267a96,{'recursive':!![]},_0x268bf8=>{const _0x36c53d=_0x41f28f;_0x268bf8?(dbFileOperationRecord[_0x36c53d(0xe6)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_FAIL']),dbFileOperationRecord[_0x36c53d(0xc4)](dbOther,currentFileOperationRecordId,i18n['__'](_0x36c53d(0xf1)))):dbFileOperationRecord[_0x36c53d(0xe6)](dbOther,currentFileOperationRecordId,dbFileOperationRecord[_0x36c53d(0xfb)]),_0xb90db6();}):(dbFileOperationRecord[_0x41f28f(0xe6)](dbOther,currentFileOperationRecordId,dbFileOperationRecord['STATE_SUC']),_0xb90db6());}try{let _0x33aa93=fs['statSync'](_0x267a96);function _0x5eb46f(_0x3c06b1){const _0x1bbd86=_0x38eeab;if(_0x33aa93[_0x1bbd86(0x102)]()){let _0x28f1b5=copyFile(_0x4e6090,_0x267a96,_0x5634c7,_0x514d72);_0x28f1b5?_0x2ad79f(_0x3c06b1,!![]):_0x250b8f(_0x3c06b1);}else{if(_0x33aa93[_0x1bbd86(0x100)]()){_0x5634c7=getTargetFullPath(_0x5634c7,0x1);!fs[_0x1bbd86(0xc6)](_0x5634c7)&&fs[_0x1bbd86(0x107)](_0x5634c7,{'recursive':!![]});let _0x53a4ef=copyFolder(_0x4e6090,_0x267a96,_0x267a96,_0x5634c7,_0x514d72);_0x53a4ef?_0x2ad79f(_0x3c06b1,!![]):_0x250b8f(_0x3c06b1);}}}if(_0x514d72=='copy')_0x5eb46f(taskObj);else{if(_0x514d72=='cut')fs[_0x38eeab(0xd1)](_0x267a96,_0x5634c7,_0x1b5dfc=>{if(_0x1b5dfc)return _0x5eb46f(taskObj);else _0x2ad79f(taskObj,![]);});else{if(_0x514d72==_0x38eeab(0xf6)){let _0x24b225=path[_0x38eeab(0xd2)](_0x267a96),_0x14ec6c=path[_0x38eeab(0xf9)](_0x5634c7,_0x24b225+_0x38eeab(0xfa));if(fs[_0x38eeab(0xc6)](_0x14ec6c))return _0x250b8f(taskObj,i18n['__'](_0x38eeab(0x112))+':'+_0x14ec6c);let _0x474c64=fs['createWriteStream'](_0x14ec6c),_0x8db1d8=taskObj,_0x15c726=0x0,_0x293139=0x0,_0x1babc1,_0x1e24e7=![];if(_0x33aa93[_0x38eeab(0x102)]())_0x1babc1=new compressing[(_0x38eeab(0xf6))][(_0x38eeab(0xd9))]({'source':_0x267a96});else _0x33aa93[_0x38eeab(0x100)]()&&(_0x1babc1=new compressing[(_0x38eeab(0xf6))][(_0x38eeab(0xf5))](),_0x1babc1[_0x38eeab(0xe0)](_0x267a96));_0x1babc1['on'](_0x38eeab(0x10d),_0x4180a1=>{const _0x2fe089=_0x38eeab;_0x15c726+=_0x4180a1['length'];let _0x140b69=_0x15c726/0x400/0x400;if(_0x140b69>_0x293139+0x64){_0x293139=_0x140b69,dbOther[_0x2fe089(0xcf)](_0x2fe089(0xca))[_0x2fe089(0xe1)](_0x15c726,_0x8db1d8['id']);let _0x52a97f=dbOther[_0x2fe089(0xcf)](_0x2fe089(0xce)+_0x8db1d8['id'])[_0x2fe089(0x101)]();(!_0x52a97f||_0x52a97f['task_state']!=0x1&&!_0x1e24e7)&&(_0x474c64[_0x2fe089(0xdc)](),_0x1babc1[_0x2fe089(0xd6)](),_0x250b8f(_0x8db1d8));}}),_0x1babc1[_0x38eeab(0xe5)](_0x474c64),_0x1babc1['on']('error',_0x361507=>{const _0x1c4db1=_0x38eeab;_0x474c64[_0x1c4db1(0xdc)](),_0x250b8f(_0x8db1d8);}),_0x474c64['on'](_0x38eeab(0x105),_0xf93e4f=>{const _0x5d9904=_0x38eeab;_0x474c64[_0x5d9904(0xdc)](),_0x250b8f(_0x8db1d8);}),_0x474c64['on'](_0x38eeab(0x114),()=>{const _0x19fd6f=_0x38eeab;_0x1e24e7=!![],_0x474c64[_0x19fd6f(0xdc)](),_0x2ad79f(_0x8db1d8);});}else{if(_0x514d72=='unzip'){let _0x98b544=taskObj,_0x4476e4=path['extname'](_0x267a96),_0x1c0f2c=[_0x38eeab(0x10e),'.gzip',_0x38eeab(0xf7),_0x38eeab(0xfa)];if(!_0x4476e4||!_0x1c0f2c[_0x38eeab(0x103)](_0x4476e4))return _0x250b8f(_0x98b544,i18n['__']('notSupportFileFormat'));let _0x3eaac3=0x0,_0x133742=0x0,_0x230483,_0x93dd1c=new compressing[(_0x4476e4['replace']('.',''))][(_0x38eeab(0xd0))]({'source':_0x267a96});_0x93dd1c['on']('error',_0x369619=>{_0x230483&&(_0x230483['close'](),_0x230483=null),_0x250b8f(_0x98b544);}),_0x93dd1c['on'](_0x38eeab(0x114),()=>{const _0x569e03=_0x38eeab;_0x230483&&(_0x230483[_0x569e03(0xdc)](),_0x230483=null),_0x2ad79f(_0x98b544);}),_0x93dd1c['on'](_0x38eeab(0xf8),(_0x15c458,_0xd4d579,_0x2dbca6)=>{const _0x5c4fee=_0x38eeab;_0xd4d579['on'](_0x5c4fee(0xcc),_0x2dbca6);let _0x165529=path['join'](_0x5634c7,_0x15c458[_0x5c4fee(0xd8)]),_0x2d3705=path[_0x5c4fee(0x111)](_0x165529);!fs['existsSync'](_0x2d3705)&&fs[_0x5c4fee(0x107)](_0x2d3705,{'recursive':!![]}),_0x230483=fs['createWriteStream'](_0x165529),_0x230483['on'](_0x5c4fee(0x105),_0x28a9c3=>{const _0x5e0294=_0x5c4fee;console[_0x5e0294(0x113)](_0x28a9c3);}),_0x15c458[_0x5c4fee(0x115)]==='file'?(_0xd4d579['on'](_0x5c4fee(0x10d),_0x188e33=>{const _0x5e20cc=_0x5c4fee;_0x3eaac3+=_0x188e33[_0x5e20cc(0xe8)];let _0x1f2510=_0x3eaac3/0x400/0x400;if(_0x1f2510>_0x133742+0x64){_0x133742=_0x1f2510,dbOther['prepare']('UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?')[_0x5e20cc(0xe1)](_0x3eaac3,_0x98b544['id']);let _0x22822b=dbOther[_0x5e20cc(0xcf)](_0x5e20cc(0xce)+_0x98b544['id'])['get']();if(!_0x22822b||_0x22822b[_0x5e20cc(0xc9)]!=0x1&&!isFinish)return _0x230483['close'](),_0xd4d579['on'](_0x5e20cc(0xcc),()=>{}),_0xd4d579['destroy'](),_0x230483[_0x5e20cc(0xd6)](),_0x93dd1c[_0x5e20cc(0xd6)](),_0x250b8f(_0x98b544);}}),_0xd4d579['pipe'](_0x230483)):mkdirp(path[_0x5c4fee(0xf9)](_0x5634c7,_0x15c458[_0x5c4fee(0xd8)]),_0x399d14=>{if(_0x399d14)return;_0xd4d579['resume']();});});}else _0x2ad79f();}}}}catch(_0x32fe23){console[_0x38eeab(0x113)](_0x32fe23),_0x250b8f();}}function _0x21ca(){const _0xbc9724=['lastInsertRowid','substring','STATE_DOING','addEntry','run','better-sqlite3','2566912EgVekw','mkdirp','pipe','updateRecordState','exit','length','../../myConfig/config','4534970OLGpGm','addFileOperationRecord','../../express-server/utils/fileUtils','title','cut','SELECT\x20*\x20FROM\x20bg_task\x20WHERE\x20task_type=\x27FILE_OPERATION\x27\x20and\x20task_state=0\x20and\x20id=','constants','file.cutCopySucButDeleteFail','task_json','14340nxIhSR','282jqOpbQ','Stream','zip','.tgz','entry','join','.zip','STATE_SUC','2037560snoriR','1924225QeuaTB','428666SFOzcG','getFileErrStr','isDirectory','get','isFile','includes','cpSync','error','../../db/dbFileOperationRecord','mkdirSync','taskIdList','extname','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','replace','7rGSCbz','data','.tar','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','pragma','dirname','sameNameFileAlreadExist','log','finish','type','file.taskCancel','NasCabFileWorker','dbOther','693606VHtdRL','targetPath','size','updateRecordRemark','LEVEL_MAIN_OPERATION','existsSync','accessSync','message','task_state','UPDATE\x20bg_task\x20SET\x20size_current=?\x20where\x20id=?','../../utils/i18nUtil','end','R_OK','select\x20task_state\x20from\x20bg_task\x20where\x20id=','prepare','UncompressStream','rename','basename','getI18n','sourcePath','statSync','destroy','9zEcxhS','name','FileStream','journal_mode\x20=\x20WAL','send','close'];_0x21ca=function(){return _0xbc9724;};return _0x21ca();}async function taskStart(_0x2c43b8){return new Promise((_0x3ea03b,_0x527d67)=>{const _0x385d56=_0x3f72;taskObj=dbOther[_0x385d56(0xcf)](_0x385d56(0xef)+_0x2c43b8)[_0x385d56(0x101)]();if(taskObj){taskParams=JSON['parse'](taskObj[_0x385d56(0xf2)]),dbOther[_0x385d56(0xcf)](_0x385d56(0x10a)+taskObj['id'])[_0x385d56(0xe1)](),copyFileCount=0x0,copySize=0x0,paused=![];let _0x268063=dbFileOperationRecord[_0x385d56(0xeb)](dbOther,{'username':taskParams['username'],'sourcePath':taskParams[_0x385d56(0xd4)],'targetPath':taskParams[_0x385d56(0x11a)],'level':dbFileOperationRecord[_0x385d56(0xc5)],'type':taskParams[_0x385d56(0x115)],'state':dbFileOperationRecord[_0x385d56(0xdf)]});_0x268063&&(currentFileOperationRecordId=_0x268063[_0x385d56(0xdd)]),doFileOperation(taskParams,_0x3ea03b);}else _0x3ea03b();});}function exitProcess(){const _0x4e5ca7=_0xaff781;process[_0x4e5ca7(0xdb)]({'type':_0x4e5ca7(0xdc)}),process[_0x4e5ca7(0xe7)]();}process['on'](_0xaff781(0xc8),async _0x5a9797=>{const _0x1011af=_0xaff781;try{if(_0x5a9797[_0x1011af(0x108)]&&_0x5a9797[_0x1011af(0x108)][_0x1011af(0xe8)]>0x0){for(let _0x4526e3 in _0x5a9797[_0x1011af(0x108)]){await taskStart(_0x5a9797[_0x1011af(0x108)][_0x4526e3]);}exitProcess();}else exitProcess();}catch(_0x39c895){exitProcess();}});