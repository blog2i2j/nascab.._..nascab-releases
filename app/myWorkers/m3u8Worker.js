const _0x2d4122=_0x2aae;function _0x2aae(_0x38dea3,_0xa9e2c7){const _0x2414f0=_0x2414();return _0x2aae=function(_0x2aae6f,_0x1c1738){_0x2aae6f=_0x2aae6f-0x10b;let _0x40383e=_0x2414f0[_0x2aae6f];return _0x40383e;},_0x2aae(_0x38dea3,_0xa9e2c7);}(function(_0xa0e33b,_0x38fcc1){const _0x44e473=_0x2aae,_0x497253=_0xa0e33b();while(!![]){try{const _0xdf405a=-parseInt(_0x44e473(0x149))/0x1*(-parseInt(_0x44e473(0x144))/0x2)+parseInt(_0x44e473(0x157))/0x3*(-parseInt(_0x44e473(0x178))/0x4)+-parseInt(_0x44e473(0x163))/0x5*(-parseInt(_0x44e473(0x10c))/0x6)+-parseInt(_0x44e473(0x12b))/0x7+parseInt(_0x44e473(0x11e))/0x8+parseInt(_0x44e473(0x134))/0x9+parseInt(_0x44e473(0x135))/0xa;if(_0xdf405a===_0x38fcc1)break;else _0x497253['push'](_0x497253['shift']());}catch(_0x5c202c){_0x497253['push'](_0x497253['shift']());}}}(_0x2414,0xb3ce2));const path=require(_0x2d4122(0x16c)),fs=require('fs'),config=require(_0x2d4122(0x11b)),transCodeUtil=require(_0x2d4122(0x110)),Database=require(_0x2d4122(0x158)),dbOther=new Database(config['dbOther'],{}),dbFileIndex=new Database(config[_0x2d4122(0x11a)],{'timeout':0xea60});dbOther[_0x2d4122(0x14e)](_0x2d4122(0x172)),dbFileIndex['pragma'](_0x2d4122(0x172));const FFmpeg=require('../libs/nasTrans')['FFmpeg'],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x2d4122(0x162));const chokidar=require(_0x2d4122(0x117)),platform=require('os')[_0x2d4122(0x146)];process[_0x2d4122(0x165)]='NasCabHlsWorker';function setLastReqTime(_0x23aa6b){const _0x440ab0=_0x2d4122;for(let _0x20b706 in ffmpList){let _0x4c95ca=ffmpList[_0x20b706];if(_0x4c95ca[_0x440ab0(0x17c)]==_0x23aa6b)return ffmpList[_0x20b706]['lastTsReqTime']=new Date()[_0x440ab0(0x168)]();}}function _0x2414(){const _0x162663=['[0:s:','seekInput','chokidar','then','getVideoBitrate','dbFileIndex','../myConfig/config','dvd_subtitle','[ref][sub]overlay[vss]','4831264bCgvhh','seq','gen','stat','-crf\x20','hwaccel','-ac\x202','start','getReadRate','[vs]','dvb_subtitle','dealFFmpegPath','endsWith','6756344pxQClp','m3u8TmpPath','indexOf','-hls_list_size\x200','-pix_fmt\x20','][vs]scale2ref[sub][ref]','-map\x200:v:0?','-r\x20','parseSubtitle','12767238yPnnYJ','5949170XFQnFt','addOutputOption','decoderSupportPixFormat','No\x20request\x20timeout\x20','parseStreamList','.tmp','qsv\x20cannot\x20deal,restart\x20ffmpeg','videoBitrate','kill','join','add','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','run','addOption','inputOption','214BmpXDg','-map\x20[vss]','platform','getPixFmt','m3u8segmentDuration','709ctdYaI','pgssub','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','replace','complexFilter','pragma','videobit','decryptFileGetStream','change','log','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','-map\x200:a:','subtitleIndex','splice','24063sVJKEZ','better-sqlite3','dirname','-readrate\x20','size','push','.m3u8','videoCodec','stop','format','audioIndex','../express-server/utils/cryptoUtils','5zbFwbD','message','title','addInputOption','includes','getTime','vobsub','end','Play\x20ID\x20has\x20started','path','-copyts','prepare','encoderName','getFps','basename','journal_mode\x20=\x20WAL','-bufsize\x20','catch','burn','-filter:v\x20','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','548JGBFjg','getCrf','constants','decoderCommand','playId','hdmv_pgs_subtitle','get','643686NUJTfL','hls','-c:v\x20','getCoderConfig','../utils/transCodeUtil','codec_name','getScaleOption','close','lastTsReqTime'];_0x2414=function(){return _0x162663;};return _0x2414();}function addFfmpToList(_0x490f11,_0xe37807,_0x5437eb){const _0x20d138=_0x2d4122;ffmpList[_0x20d138(0x15c)]({'ffmp':_0x490f11,'playId':_0xe37807,'dirWatcher':_0x5437eb,'lastTsReqTime':new Date()[_0x20d138(0x168)]()});}function killFfmpByPlayId(_0x474923,_0x310ca4=!![]){const _0xc200e8=_0x2d4122;console['log']('Stop\x20transcode\x20',_0x474923);for(let _0x59d565 in startedPlayIdList){let _0xb02714=startedPlayIdList[_0x59d565];if(_0xb02714==_0x474923){startedPlayIdList[_0xc200e8(0x156)](_0x59d565,0x1);break;}}for(let _0x374609 in ffmpList){let _0xd56e72=ffmpList[_0x374609];if(_0xd56e72[_0xc200e8(0x17c)]==_0x474923){ffmpList[_0xc200e8(0x156)](_0x374609,0x1);let _0x542fcd=_0xd56e72['ffmp'][_0xc200e8(0x13d)]();_0x310ca4&&setTimeout(()=>{const _0x4e4ba7=_0xc200e8;_0xd56e72['dirWatcher'][_0x4e4ba7(0x113)]()[_0x4e4ba7(0x118)](()=>{});},0x7d0);return;}}}function startPlay(_0x2a7345){const _0xeedc60=_0x2d4122;let {playId:_0x306192,args:_0x1d0d4c,action:_0x3a3a7e}=_0x2a7345;if(!_0x306192)return;if(_0x3a3a7e==_0xeedc60(0x15f)){killFfmpByPlayId(_0x306192);return;}for(let _0x33f101 in ffmpList){let _0x2f8b95=ffmpList[_0x33f101];if(_0x2f8b95['playId']==_0x306192){setLastReqTime(_0x306192);return;}}if(startedPlayIdList[_0xeedc60(0x167)](_0x306192)){console[_0xeedc60(0x152)](_0xeedc60(0x16b));return;}startedPlayIdList[_0xeedc60(0x15c)](_0x306192);let _0x265667=dbOther[_0xeedc60(0x16e)](_0xeedc60(0x140))[_0xeedc60(0x10b)](_0x306192);if(!_0x265667)return;let _0x4f7068=path[_0xeedc60(0x13e)](config['m3u8TmpPath'],_0x306192);function _0x436c39(){const _0x45d2e7=_0xeedc60;transCodeUtil['parseVideoFullPath'](dbFileIndex,dbOther,_0x1d0d4c)['then'](_0x26d827=>{const _0x5d2747=_0x2aae;let {fullpath:_0x3ab32e,streamList:_0x16766c,needDecrypt:_0x16e055,pwd:_0x2c5f5e,duration:_0x35f65b}=_0x26d827;fs['access'](_0x3ab32e,fs[_0x5d2747(0x17a)]['R_OK'],_0xbdea57=>{const _0x225681=_0x5d2747;if(_0xbdea57)return;let _0x27ed9f=chokidar['watch'](_0x4f7068,{'ignored':'*.m3u8','ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x27ed9f['on'](_0x225681(0x13f),_0x408d22=>{const _0x135d26=_0x225681;if(_0x408d22['endsWith'](_0x135d26(0x13a))||_0x408d22[_0x135d26(0x12a)](_0x135d26(0x15d)))return;let _0x1a41a3=path[_0x135d26(0x171)](_0x408d22),_0x2e460d=dbOther['prepare'](_0x135d26(0x153))[_0x135d26(0x141)](_0x306192);if(!_0x2e460d)return killFfmpByPlayId(_0x306192);else dbOther[_0x135d26(0x16e)](_0x135d26(0x177))[_0x135d26(0x141)](_0x306192,_0x1a41a3,_0x135d26(0x120));}),_0x27ed9f['on']('error',_0x2de0d4=>{}),_0x27ed9f['on'](_0x225681(0x151),_0x336460=>{const _0x514f01=_0x225681;if(_0x336460[_0x514f01(0x12a)](_0x514f01(0x13a))||_0x336460['endsWith'](_0x514f01(0x15d)))return;let _0x217c39=path['basename'](_0x336460);dbOther[_0x514f01(0x16e)](_0x514f01(0x177))[_0x514f01(0x141)](_0x306192,_0x217c39,_0x514f01(0x120));}),_0x27ed9f['on']('ready',()=>{m3u8FfmpegTrans(_0x27ed9f,_0x306192,_0x1d0d4c,_0x3ab32e,_0x16766c,_0x16e055,_0x2c5f5e);});});})[_0x45d2e7(0x174)](_0x5cc3d9=>{});}fs[_0xeedc60(0x121)](_0x4f7068,(_0x2c4de9,_0x1c3e11)=>{_0x2c4de9?fs['mkdir'](_0x4f7068,{'recursive':!![]},_0x3b0f90=>{!_0x3b0f90&&_0x436c39();}):_0x436c39();});}function m3u8FfmpegTrans(_0x49b24b,_0x2feb14,_0x145bd1,_0x29af24,_0x578a74,_0x3807a7,_0x19d737,_0x43389c=!![]){const _0x37adc5=_0x2d4122;try{let _0x3f27f3=_0x145bd1[_0x37adc5(0x15b)]&&_0x145bd1[_0x37adc5(0x15b)]>0xf0?_0x145bd1[_0x37adc5(0x15b)]:0x2d0,{videoStream:_0x48be82,videoWidth:_0x17ef1b,videoHeight:_0xd85672}=transCodeUtil[_0x37adc5(0x139)](_0x578a74),_0xbec4f8=_0x3807a7?cryptoUtils[_0x37adc5(0x150)](_0x19d737,_0x29af24):_0x29af24;_0xbec4f8=transCodeUtil[_0x37adc5(0x129)](_0xbec4f8);let _0x2d8d0e=FFmpeg(_0xbec4f8),_0x5bcc5d=transCodeUtil[_0x37adc5(0x10f)](dbOther,_0x48be82);_0x43389c&&_0x5bcc5d[_0x37adc5(0x123)]&&_0x2d8d0e[_0x37adc5(0x166)](_0x5bcc5d['hwaccel']);if(_0x43389c&&_0x5bcc5d[_0x37adc5(0x17b)]){let _0x17458a=transCodeUtil[_0x37adc5(0x137)](_0x48be82,_0x5bcc5d[_0x37adc5(0x17b)][_0x37adc5(0x14c)](_0x37adc5(0x10e),''));_0x17458a&&_0x2d8d0e['addInputOption'](_0x5bcc5d['decoderCommand']);}_0x2d8d0e[_0x37adc5(0x143)](_0x37adc5(0x15a)+transCodeUtil[_0x37adc5(0x126)](dbOther));let _0x965381=_0x145bd1[_0x37adc5(0x11f)]*config[_0x37adc5(0x148)];_0x965381&&!_0x3807a7&&_0x2d8d0e[_0x37adc5(0x116)](''+parseInt(_0x965381));_0x2d8d0e['audioCodec']('aac');_0x5bcc5d[_0x37adc5(0x16f)]&&_0x2d8d0e[_0x37adc5(0x15e)](_0x5bcc5d[_0x37adc5(0x16f)]);let _0x54484b=transCodeUtil[_0x37adc5(0x119)](_0x48be82,_0x145bd1[_0x37adc5(0x14f)]);_0x2d8d0e[_0x37adc5(0x13c)](''+_0x54484b),_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x173)+_0x54484b/0x2+'k');let _0x28b6cf=transCodeUtil[_0x37adc5(0x112)](_0x3f27f3,_0x17ef1b,_0xd85672),_0x355069=null;_0x145bd1[_0x37adc5(0x175)]==0x1&&_0x145bd1[_0x37adc5(0x155)]>-0x1&&(_0x355069=transCodeUtil[_0x37adc5(0x133)](_0x578a74,_0x145bd1[_0x37adc5(0x155)]));_0x355069&&(_0x355069[_0x37adc5(0x111)]==_0x37adc5(0x14a)||_0x355069[_0x37adc5(0x111)]==_0x37adc5(0x17d)||_0x355069['codec_name']==_0x37adc5(0x169)||_0x355069[_0x37adc5(0x111)]==_0x37adc5(0x11c)||_0x355069[_0x37adc5(0x111)]=='dvdsub'||_0x355069[_0x37adc5(0x111)]==_0x37adc5(0x128))?(_0x2d8d0e[_0x37adc5(0x14d)](['[0:v:0]'+_0x28b6cf+_0x37adc5(0x127),_0x37adc5(0x115)+_0x145bd1['subtitleIndex']+_0x37adc5(0x130),_0x37adc5(0x11d)]),_0x2d8d0e[_0x37adc5(0x136)](_0x37adc5(0x145))):(_0x28b6cf&&_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x176)+_0x28b6cf),_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x131)));_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x154)+(_0x145bd1[_0x37adc5(0x161)]?_0x145bd1[_0x37adc5(0x161)]:0x0)+'?');let _0x39b81f=transCodeUtil[_0x37adc5(0x170)](_0x48be82);_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x132)+_0x39b81f),_0x2d8d0e[_0x37adc5(0x142)]('-g\x20'+_0x39b81f);let _0x2d7a45=transCodeUtil['getTranscodeSpeed'](dbOther,_0x5bcc5d[_0x37adc5(0x16f)]);_0x2d7a45!='medium'&&_0x2d8d0e[_0x37adc5(0x142)]('-preset\x20'+_0x2d7a45);let _0x222c7d=transCodeUtil[_0x37adc5(0x147)](_0x48be82,_0x5bcc5d['encoderName']);_0x222c7d&&_0x2d8d0e['addOption'](_0x37adc5(0x12f)+_0x222c7d);_0x2d8d0e['addOption'](_0x37adc5(0x16d));_0x145bd1['ac']&&_0x145bd1['ac']>0x0&&_0x145bd1['ac']<=0x18?_0x2d8d0e[_0x37adc5(0x142)]('-ac\x20'+_0x145bd1['ac']):_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x124));let _0x3a0156=transCodeUtil[_0x37adc5(0x179)](dbOther);_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x122)+_0x3a0156),_0x2d8d0e[_0x37adc5(0x160)](_0x37adc5(0x10d)),_0x2d8d0e[_0x37adc5(0x142)]('-hls_time\x20'+config[_0x37adc5(0x148)]),_0x2d8d0e[_0x37adc5(0x142)](_0x37adc5(0x12e));let _0x348f72=_0x145bd1[_0x37adc5(0x11f)];_0x348f72&&_0x965381&&!_0x3807a7&&_0x2d8d0e[_0x37adc5(0x142)]('-start_number\x20'+_0x348f72);let _0x58e232=path[_0x37adc5(0x13e)](config[_0x37adc5(0x12c)],_0x2feb14,'stream.m3u8');_0x58e232=transCodeUtil[_0x37adc5(0x129)](_0x58e232),_0x2d8d0e['output'](''+_0x58e232);let _0x51b423=path[_0x37adc5(0x159)](_0x58e232);fs[_0x37adc5(0x121)](_0x51b423,(_0x4f1c2f,_0x55f479)=>{if(_0x4f1c2f){fs['mkdir'](_0x51b423,{'recursive':!![]},_0x90c942=>{if(_0x90c942)return;_0x20d1ce(_0x2d8d0e);});return;}_0x20d1ce(_0x2d8d0e);});function _0x351ad0(){const _0x3fabbc=_0x37adc5;_0x43389c&&(console[_0x3fabbc(0x152)](_0x3fabbc(0x14b)),killFfmpByPlayId(_0x2feb14,![]),m3u8FfmpegTrans(_0x49b24b,_0x2feb14,_0x145bd1,_0x29af24,_0x578a74,_0x3807a7,_0x19d737,![]));}function _0x20d1ce(){const _0x49cea0=_0x37adc5;_0x2d8d0e['run'](),addFfmpToList(_0x2d8d0e,_0x2feb14,_0x49b24b),_0x2d8d0e['on'](_0x49cea0(0x125),function(_0x4296d0){const _0x305b4d=_0x49cea0;console[_0x305b4d(0x152)](_0x4296d0);})['on']('stderr',function(_0x55edc6){const _0x1df03e=_0x49cea0;_0x43389c&&_0x5bcc5d&&_0x55edc6&&_0x55edc6[_0x1df03e(0x12d)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console[_0x1df03e(0x152)](_0x1df03e(0x13b)),_0x351ad0());})['on']('error',function(_0x23ff42){const _0x24fbb0=_0x49cea0;_0x23ff42[_0x24fbb0(0x164)]&&_0x23ff42[_0x24fbb0(0x164)][_0x24fbb0(0x12d)]('killed')==-0x1&&(console['log'](_0x23ff42),_0x351ad0());})['on'](_0x49cea0(0x16a),function(_0x244f78){const _0x36b1ae=_0x49cea0;console[_0x36b1ae(0x152)](_0x244f78);});}}catch(_0x1cfecb){console[_0x37adc5(0x152)](_0x1cfecb),_0x49b24b[_0x37adc5(0x113)]();}}setInterval(()=>{const _0x1c55ed=_0x2d4122;let _0x2ec6f4=new Date()['getTime'](),_0x3856cb=0xea60;for(let _0x5da108 in ffmpList){let _0x2fe503=ffmpList[_0x5da108],_0x30dd22=_0x2ec6f4-_0x2fe503['lastTsReqTime'];_0x2fe503[_0x1c55ed(0x114)]&&_0x30dd22>_0x3856cb&&(console[_0x1c55ed(0x152)](_0x1c55ed(0x138)),killFfmpByPlayId(_0x2fe503[_0x1c55ed(0x17c)]));}},0x2710),process['on'](_0x2d4122(0x164),_0xca9a31=>{startPlay(_0xca9a31);}),process['on']('exit',(_0x3455e3,_0x2b4415)=>{const _0x2346d9=_0x2d4122;process['send']({'type':_0x2346d9(0x113)});});