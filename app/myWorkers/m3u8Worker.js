const _0x10778a=_0x5d41;function _0x2fc1(){const _0x2655e2=['path','-ac\x20','.tmp','-map\x200:v:0?','hwaccel','dirWatcher','dvdsub','inputOption','getTranscodeSpeed','parseVideoFullPath','decoderCommand','Play\x20ID\x20has\x20started','-ac\x202','hdmv_pgs_subtitle','[ref][sub]overlay[vss]','run','catch','size','error','4125354cgJSVF','kill','vobsub','1qKtevG','../myConfig/config','playId','codec_name','7144088KyObHx','includes','message','push','stat','subtitleIndex','[vs]','R_OK','start','getReadRate','2179018szRntI','pgssub','videobit','pragma','addOption','m3u8segmentDuration','-hls_list_size\x200','-filter:v\x20','platform','decryptFileGetStream','[0:s:','better-sqlite3','2257671ZYcJWV','FFmpeg','m3u8TmpPath','complexFilter','../libs/nasTrans','then','[0:v:0]','.m3u8','getCoderConfig','constants','videoBitrate','dbOther','../express-server/utils/cryptoUtils','-crf\x20','aac','killed','getTime','log','add','5126580ruQGQO','medium','burn','-hls_time\x20','getCrf','decoderSupportPixFormat','addInputOption','stop','-map\x200:a:','stderr','encoderName','basename','dbFileIndex','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','dvd_subtitle','lastTsReqTime','-g\x20','getFps','join','audioIndex','27ImifUz','NasCabHlsWorker','splice','prepare','dealFFmpegPath','ffmp','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','watch','format','end','Stop\x20transcode\x20','addOutputOption','chokidar','183180kmqwXV','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','-bufsize\x20','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','stream.m3u8','indexOf','dirname','access','videoCodec','getVideoBitrate','-start_number\x20','title','close','-copyts','get','-pix_fmt\x20','endsWith','ready','mkdir','6227344zoevnh'];_0x2fc1=function(){return _0x2655e2;};return _0x2fc1();}(function(_0x493ad4,_0x5d5f79){const _0x2bf190=_0x5d41,_0x81f56c=_0x493ad4();while(!![]){try{const _0x59686c=parseInt(_0x2bf190(0xd6))/0x1*(-parseInt(_0x2bf190(0xe4))/0x2)+parseInt(_0x2bf190(0xf0))/0x3+-parseInt(_0x2bf190(0x124))/0x4+-parseInt(_0x2bf190(0x103))/0x5+parseInt(_0x2bf190(0xd3))/0x6+-parseInt(_0x2bf190(0xda))/0x7+parseInt(_0x2bf190(0xbf))/0x8*(parseInt(_0x2bf190(0x117))/0x9);if(_0x59686c===_0x5d5f79)break;else _0x81f56c['push'](_0x81f56c['shift']());}catch(_0x4c8453){_0x81f56c['push'](_0x81f56c['shift']());}}}(_0x2fc1,0x910f6));const path=require(_0x10778a(0xc0)),fs=require('fs'),config=require(_0x10778a(0xd7)),transCodeUtil=require('../utils/transCodeUtil'),Database=require(_0x10778a(0xef)),dbOther=new Database(config[_0x10778a(0xfb)],{}),dbFileIndex=new Database(config[_0x10778a(0x10f)],{'timeout':0xea60});dbOther[_0x10778a(0xe7)]('journal_mode\x20=\x20WAL'),dbFileIndex['pragma']('journal_mode\x20=\x20WAL');const FFmpeg=require(_0x10778a(0xf4))[_0x10778a(0xf1)],ffmpList=[];function _0x5d41(_0x3ead42,_0x441d04){const _0x2fc107=_0x2fc1();return _0x5d41=function(_0x5d4120,_0x47c43d){_0x5d4120=_0x5d4120-0xb8;let _0x5b1d34=_0x2fc107[_0x5d4120];return _0x5b1d34;},_0x5d41(_0x3ead42,_0x441d04);}let startedPlayIdList=[],cryptoUtils=require(_0x10778a(0xfc));const chokidar=require(_0x10778a(0x123)),platform=require('os')[_0x10778a(0xec)];process[_0x10778a(0x12f)]=_0x10778a(0x118);function setLastReqTime(_0x1d4766){const _0x30d84c=_0x10778a;for(let _0x5de763 in ffmpList){let _0x403373=ffmpList[_0x5de763];if(_0x403373[_0x30d84c(0xd8)]==_0x1d4766)return ffmpList[_0x5de763][_0x30d84c(0x112)]=new Date()['getTime']();}}function addFfmpToList(_0x854e22,_0x41e748,_0x5d3659){const _0xbc17d6=_0x10778a;ffmpList[_0xbc17d6(0xdd)]({'ffmp':_0x854e22,'playId':_0x41e748,'dirWatcher':_0x5d3659,'lastTsReqTime':new Date()[_0xbc17d6(0x100)]()});}function killFfmpByPlayId(_0x2d4e60,_0x361d08=!![]){const _0x254c58=_0x10778a;console[_0x254c58(0x101)](_0x254c58(0x121),_0x2d4e60);for(let _0x2f03ac in startedPlayIdList){let _0x3c760d=startedPlayIdList[_0x2f03ac];if(_0x3c760d==_0x2d4e60){startedPlayIdList[_0x254c58(0x119)](_0x2f03ac,0x1);break;}}for(let _0x4b3fd6 in ffmpList){let _0x33dd25=ffmpList[_0x4b3fd6];if(_0x33dd25[_0x254c58(0xd8)]==_0x2d4e60){ffmpList[_0x254c58(0x119)](_0x4b3fd6,0x1);let _0x3b222f=_0x33dd25[_0x254c58(0x11c)][_0x254c58(0xd4)]();_0x361d08&&setTimeout(()=>{const _0x267f7f=_0x254c58;_0x33dd25[_0x267f7f(0xc5)][_0x267f7f(0xb8)]()[_0x267f7f(0xf5)](()=>{});},0x7d0);return;}}}function startPlay(_0x582102){const _0x20d7f9=_0x10778a;let {playId:_0x190876,args:_0x288678,action:_0x59b633}=_0x582102;if(!_0x190876)return;if(_0x59b633==_0x20d7f9(0x10a)){killFfmpByPlayId(_0x190876);return;}for(let _0x4cad2b in ffmpList){let _0x1a4768=ffmpList[_0x4cad2b];if(_0x1a4768[_0x20d7f9(0xd8)]==_0x190876){setLastReqTime(_0x190876);return;}}if(startedPlayIdList[_0x20d7f9(0xdb)](_0x190876)){console[_0x20d7f9(0x101)](_0x20d7f9(0xcb));return;}startedPlayIdList['push'](_0x190876);let _0x3de2a3=dbOther['prepare'](_0x20d7f9(0x127))[_0x20d7f9(0xba)](_0x190876);if(!_0x3de2a3)return;let _0x21f0d7=path[_0x20d7f9(0x115)](config['m3u8TmpPath'],_0x190876);function _0x4c0f45(){const _0x40592c=_0x20d7f9;transCodeUtil[_0x40592c(0xc9)](dbFileIndex,dbOther,_0x288678)['then'](_0xf48874=>{const _0x177ba4=_0x40592c;let {fullpath:_0x472ba1,streamList:_0x123d61,needDecrypt:_0x591ca5,pwd:_0x319abe,duration:_0x428062}=_0xf48874;fs[_0x177ba4(0x12b)](_0x472ba1,fs[_0x177ba4(0xf9)][_0x177ba4(0xe1)],_0x297eb5=>{const _0x341237=_0x177ba4;if(_0x297eb5)return;let _0xebfb56=chokidar[_0x341237(0x11e)](_0x21f0d7,{'ignored':'*.m3u8','ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0xebfb56['on'](_0x341237(0x102),_0x20927f=>{const _0x4d3c28=_0x341237;if(_0x20927f[_0x4d3c28(0xbc)]('.tmp')||_0x20927f[_0x4d3c28(0xbc)](_0x4d3c28(0xf7)))return;let _0x5a3ef9=path[_0x4d3c28(0x10e)](_0x20927f),_0x48cc07=dbOther[_0x4d3c28(0x11a)](_0x4d3c28(0x125))[_0x4d3c28(0xcf)](_0x190876);if(!_0x48cc07)return killFfmpByPlayId(_0x190876);else dbOther[_0x4d3c28(0x11a)](_0x4d3c28(0x11d))[_0x4d3c28(0xcf)](_0x190876,_0x5a3ef9,'gen');}),_0xebfb56['on'](_0x341237(0xd2),_0x2c870d=>{}),_0xebfb56['on']('change',_0x2a9694=>{const _0x41bba0=_0x341237;if(_0x2a9694[_0x41bba0(0xbc)](_0x41bba0(0xc2))||_0x2a9694[_0x41bba0(0xbc)](_0x41bba0(0xf7)))return;let _0x39575a=path[_0x41bba0(0x10e)](_0x2a9694);dbOther[_0x41bba0(0x11a)]('REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)')[_0x41bba0(0xcf)](_0x190876,_0x39575a,'gen');}),_0xebfb56['on'](_0x341237(0xbd),()=>{m3u8FfmpegTrans(_0xebfb56,_0x190876,_0x288678,_0x472ba1,_0x123d61,_0x591ca5,_0x319abe);});});})[_0x40592c(0xd0)](_0x1d312b=>{});}fs[_0x20d7f9(0xde)](_0x21f0d7,(_0x33b930,_0x595894)=>{const _0x47fe51=_0x20d7f9;_0x33b930?fs[_0x47fe51(0xbe)](_0x21f0d7,{'recursive':!![]},_0x1487b7=>{!_0x1487b7&&_0x4c0f45();}):_0x4c0f45();});}function m3u8FfmpegTrans(_0xcedcba,_0x4d507f,_0x48769e,_0x12b1a6,_0x49caee,_0x5e0d5a,_0x2e1461,_0x5b8382=!![]){const _0x23e9d1=_0x10778a;try{let _0xc91560=_0x48769e['size']&&_0x48769e[_0x23e9d1(0xd1)]>0xf0?_0x48769e[_0x23e9d1(0xd1)]:0x2d0,{videoStream:_0x426951,videoWidth:_0x48a3e1,videoHeight:_0x392fbc}=transCodeUtil['parseStreamList'](_0x49caee),_0x4bd973=_0x5e0d5a?cryptoUtils[_0x23e9d1(0xed)](_0x2e1461,_0x12b1a6):_0x12b1a6;_0x4bd973=transCodeUtil[_0x23e9d1(0x11b)](_0x4bd973);let _0x30516d=FFmpeg(_0x4bd973),_0x18876e=transCodeUtil[_0x23e9d1(0xf8)](dbOther,_0x426951);_0x5b8382&&_0x18876e['hwaccel']&&_0x30516d[_0x23e9d1(0x109)](_0x18876e[_0x23e9d1(0xc4)]);if(_0x5b8382&&_0x18876e[_0x23e9d1(0xca)]){let _0x45f297=transCodeUtil[_0x23e9d1(0x108)](_0x426951,_0x18876e[_0x23e9d1(0xca)]['replace']('-c:v\x20',''));_0x45f297&&_0x30516d[_0x23e9d1(0x109)](_0x18876e[_0x23e9d1(0xca)]);}_0x30516d[_0x23e9d1(0xc7)]('-readrate\x20'+transCodeUtil[_0x23e9d1(0xe3)](dbOther));let _0x34bf4f=_0x48769e['seq']*config[_0x23e9d1(0xe9)];_0x34bf4f&&!_0x5e0d5a&&_0x30516d['seekInput'](''+parseInt(_0x34bf4f));_0x30516d['audioCodec'](_0x23e9d1(0xfe));_0x18876e[_0x23e9d1(0x10d)]&&_0x30516d[_0x23e9d1(0x12c)](_0x18876e[_0x23e9d1(0x10d)]);let _0x31e767=transCodeUtil[_0x23e9d1(0x12d)](_0x426951,_0x48769e[_0x23e9d1(0xe6)]);_0x30516d[_0x23e9d1(0xfa)](''+_0x31e767),_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0x126)+_0x31e767/0x2+'k');let _0x3e1f15=transCodeUtil['getScaleOption'](_0xc91560,_0x48a3e1,_0x392fbc),_0x2fbfb2=null;_0x48769e[_0x23e9d1(0x105)]==0x1&&_0x48769e['subtitleIndex']>-0x1&&(_0x2fbfb2=transCodeUtil['parseSubtitle'](_0x49caee,_0x48769e['subtitleIndex']));_0x2fbfb2&&(_0x2fbfb2[_0x23e9d1(0xd9)]==_0x23e9d1(0xe5)||_0x2fbfb2[_0x23e9d1(0xd9)]==_0x23e9d1(0xcd)||_0x2fbfb2[_0x23e9d1(0xd9)]==_0x23e9d1(0xd5)||_0x2fbfb2['codec_name']==_0x23e9d1(0x111)||_0x2fbfb2[_0x23e9d1(0xd9)]==_0x23e9d1(0xc6)||_0x2fbfb2[_0x23e9d1(0xd9)]=='dvb_subtitle')?(_0x30516d[_0x23e9d1(0xf3)]([_0x23e9d1(0xf6)+_0x3e1f15+_0x23e9d1(0xe0),_0x23e9d1(0xee)+_0x48769e[_0x23e9d1(0xdf)]+'][vs]scale2ref[sub][ref]',_0x23e9d1(0xce)]),_0x30516d[_0x23e9d1(0x122)]('-map\x20[vss]')):(_0x3e1f15&&_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0xeb)+_0x3e1f15),_0x30516d['addOption'](_0x23e9d1(0xc3)));_0x30516d['addOption'](_0x23e9d1(0x10b)+(_0x48769e[_0x23e9d1(0x116)]?_0x48769e['audioIndex']:0x0)+'?');let _0xbbbd61=transCodeUtil[_0x23e9d1(0x114)](_0x426951);_0x30516d[_0x23e9d1(0xe8)]('-r\x20'+_0xbbbd61),_0x30516d['addOption'](_0x23e9d1(0x113)+_0xbbbd61);let _0xe2d92b=transCodeUtil[_0x23e9d1(0xc8)](dbOther,_0x18876e[_0x23e9d1(0x10d)]);_0xe2d92b!=_0x23e9d1(0x104)&&_0x30516d[_0x23e9d1(0xe8)]('-preset\x20'+_0xe2d92b);let _0xcf7ab1=transCodeUtil['getPixFmt'](_0x426951,_0x18876e[_0x23e9d1(0x10d)]);_0xcf7ab1&&_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0xbb)+_0xcf7ab1);_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0xb9));_0x48769e['ac']&&_0x48769e['ac']>0x0&&_0x48769e['ac']<=0x18?_0x30516d['addOption'](_0x23e9d1(0xc1)+_0x48769e['ac']):_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0xcc));let _0x508b0a=transCodeUtil[_0x23e9d1(0x107)](dbOther);_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0xfd)+_0x508b0a),_0x30516d[_0x23e9d1(0x11f)]('hls'),_0x30516d[_0x23e9d1(0xe8)](_0x23e9d1(0x106)+config[_0x23e9d1(0xe9)]),_0x30516d['addOption'](_0x23e9d1(0xea));let _0x37994c=_0x48769e['seq'];_0x37994c&&_0x34bf4f&&!_0x5e0d5a&&_0x30516d['addOption'](_0x23e9d1(0x12e)+_0x37994c);let _0x247071=path[_0x23e9d1(0x115)](config[_0x23e9d1(0xf2)],_0x4d507f,_0x23e9d1(0x128));_0x247071=transCodeUtil[_0x23e9d1(0x11b)](_0x247071),_0x30516d['output'](''+_0x247071);let _0x172fa6=path[_0x23e9d1(0x12a)](_0x247071);fs[_0x23e9d1(0xde)](_0x172fa6,(_0x42c45b,_0x3830fa)=>{const _0x4fb46e=_0x23e9d1;if(_0x42c45b){fs[_0x4fb46e(0xbe)](_0x172fa6,{'recursive':!![]},_0x2754f5=>{if(_0x2754f5)return;_0x1afd51(_0x30516d);});return;}_0x1afd51(_0x30516d);});function _0x3fcff1(){const _0x5d08b9=_0x23e9d1;_0x5b8382&&(console[_0x5d08b9(0x101)](_0x5d08b9(0x110)),killFfmpByPlayId(_0x4d507f,![]),m3u8FfmpegTrans(_0xcedcba,_0x4d507f,_0x48769e,_0x12b1a6,_0x49caee,_0x5e0d5a,_0x2e1461,![]));}function _0x1afd51(){const _0x1d3af1=_0x23e9d1;_0x30516d[_0x1d3af1(0xcf)](),addFfmpToList(_0x30516d,_0x4d507f,_0xcedcba),_0x30516d['on'](_0x1d3af1(0xe2),function(_0x134023){const _0x566c61=_0x1d3af1;console[_0x566c61(0x101)](_0x134023);})['on'](_0x1d3af1(0x10c),function(_0x28df50){const _0x16b586=_0x1d3af1;_0x5b8382&&_0x18876e&&_0x28df50&&_0x28df50[_0x16b586(0x129)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console[_0x16b586(0x101)]('qsv\x20cannot\x20deal,restart\x20ffmpeg'),_0x3fcff1());})['on'](_0x1d3af1(0xd2),function(_0x63777){const _0x34378d=_0x1d3af1;_0x63777[_0x34378d(0xdc)]&&_0x63777[_0x34378d(0xdc)]['indexOf'](_0x34378d(0xff))==-0x1&&(console['log'](_0x63777),_0x3fcff1());})['on'](_0x1d3af1(0x120),function(_0x241525){const _0xe999f5=_0x1d3af1;console[_0xe999f5(0x101)](_0x241525);});}}catch(_0x41d580){console['log'](_0x41d580),_0xcedcba[_0x23e9d1(0xb8)]();}}setInterval(()=>{const _0x59b5fb=_0x10778a;let _0x4c7281=new Date()[_0x59b5fb(0x100)](),_0x54df18=0xea60;for(let _0x3e441e in ffmpList){let _0x195e06=ffmpList[_0x3e441e],_0x5485fb=_0x4c7281-_0x195e06[_0x59b5fb(0x112)];_0x195e06[_0x59b5fb(0x112)]&&_0x5485fb>_0x54df18&&(console[_0x59b5fb(0x101)]('No\x20request\x20timeout\x20'),killFfmpByPlayId(_0x195e06[_0x59b5fb(0xd8)]));}},0x2710),process['on'](_0x10778a(0xdc),_0x5630c2=>{startPlay(_0x5630c2);}),process['on']('exit',(_0x331c1b,_0x5eee5c)=>{const _0x182683=_0x10778a;process['send']({'type':_0x182683(0xb8)});});