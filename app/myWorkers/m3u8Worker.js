const _0x2e4b6d=_0x3a52;(function(_0x5e1017,_0x35045a){const _0x23fa66=_0x3a52,_0x4b5ffb=_0x5e1017();while(!![]){try{const _0x2f1829=-parseInt(_0x23fa66(0x1f3))/0x1+-parseInt(_0x23fa66(0x22b))/0x2*(parseInt(_0x23fa66(0x1d1))/0x3)+parseInt(_0x23fa66(0x1ea))/0x4*(parseInt(_0x23fa66(0x202))/0x5)+-parseInt(_0x23fa66(0x20e))/0x6*(-parseInt(_0x23fa66(0x22c))/0x7)+-parseInt(_0x23fa66(0x1e3))/0x8+-parseInt(_0x23fa66(0x218))/0x9+parseInt(_0x23fa66(0x208))/0xa;if(_0x2f1829===_0x35045a)break;else _0x4b5ffb['push'](_0x4b5ffb['shift']());}catch(_0x1af04a){_0x4b5ffb['push'](_0x4b5ffb['shift']());}}}(_0xdd27,0xa2566));const path=require(_0x2e4b6d(0x1f4)),fs=require('fs'),config=require(_0x2e4b6d(0x1e6)),transCodeUtil=require(_0x2e4b6d(0x1fa)),Database=require(_0x2e4b6d(0x1c6)),dbOther=new Database(config[_0x2e4b6d(0x1d6)],{}),dbFileIndex=new Database(config['dbFileIndex'],{'timeout':0xea60});function _0xdd27(){const _0x317a1a=['videoBitrate','NasCabHlsWorker','-crf\x20','format','getVideoBitrate','join','medium','log','parseSubtitle','push','-hls_time\x20','mkdir','-copyts','stderr','2160jfJfbO','1085dgIBDh','-ac\x20','-map\x200:v:0?','FFmpeg','addOption','-ac\x202','addInputOption','addOutputOption','[0:s:','-map\x20[vss]','catch','No\x20request\x20timeout\x20','message','videobit','constants','endsWith','qsv\x20cannot\x20deal,restart\x20ffmpeg','getPixFmt','../libs/nasTrans','title','-pix_fmt\x20','dvb_subtitle','access','stat','better-sqlite3','../express-server/utils/cryptoUtils','ffmp','gen','output','audioCodec','lastTsReqTime','dealFFmpegPath','getScaleOption','decryptFileGetStream','getReadRate','1149aDVaLi','*.m3u8','codec_name','-bufsize\x20','videoCodec','dbOther','kill','size','getCrf','dirWatcher','.tmp','complexFilter','playId','watch','end','-start_number\x20','hwaccel','subtitleIndex','6563376bfkked','burn','.m3u8','../myConfig/config','journal_mode\x20=\x20WAL','decoderCommand','audioIndex','268qlvfhN','get','error','dirname','encoderName','ready','-hls_list_size\x200','exit','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','290145ABIyLc','path','platform','decoderSupportPixFormat','[0:v:0]','m3u8TmpPath','-map\x200:a:','../utils/transCodeUtil','-preset\x20','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','add','hdmv_pgs_subtitle','R_OK','prepare','-filter:v\x20','88785IITbBR','seq','then','-readrate\x20','send','-r\x20','6503580UjjmnP','indexOf','pgssub','includes','m3u8segmentDuration','run','38742yegwin','close','inputOption','change','aac','Stop\x20transcode\x20','[ref][sub]overlay[vss]','basename','parseVideoFullPath','replace','5865939SXQdLU','start','vobsub','[vs]','pragma'];_0xdd27=function(){return _0x317a1a;};return _0xdd27();}dbOther[_0x2e4b6d(0x21c)](_0x2e4b6d(0x1e7)),dbFileIndex[_0x2e4b6d(0x21c)](_0x2e4b6d(0x1e7));const FFmpeg=require(_0x2e4b6d(0x1c0))[_0x2e4b6d(0x22f)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x2e4b6d(0x1c7));const chokidar=require('chokidar'),platform=require('os')[_0x2e4b6d(0x1f5)];process[_0x2e4b6d(0x1c1)]=_0x2e4b6d(0x21e);function _0x3a52(_0x1e2b02,_0x1e6fb2){const _0xdd270b=_0xdd27();return _0x3a52=function(_0x3a52d,_0x33580e){_0x3a52d=_0x3a52d-0x1bb;let _0x1883d0=_0xdd270b[_0x3a52d];return _0x1883d0;},_0x3a52(_0x1e2b02,_0x1e6fb2);}function setLastReqTime(_0x4d0ed7){const _0x15a126=_0x2e4b6d;for(let _0x34cf79 in ffmpList){let _0x1d6425=ffmpList[_0x34cf79];if(_0x1d6425['playId']==_0x4d0ed7)return ffmpList[_0x34cf79][_0x15a126(0x1cc)]=new Date()['getTime']();}}function addFfmpToList(_0x15a234,_0x465dde,_0xaeed){ffmpList['push']({'ffmp':_0x15a234,'playId':_0x465dde,'dirWatcher':_0xaeed,'lastTsReqTime':new Date()['getTime']()});}function killFfmpByPlayId(_0x8f2a2,_0x3f4b5c=!![]){const _0x59e626=_0x2e4b6d;console[_0x59e626(0x224)](_0x59e626(0x213),_0x8f2a2);for(let _0x12831e in startedPlayIdList){let _0x3edd31=startedPlayIdList[_0x12831e];if(_0x3edd31==_0x8f2a2){startedPlayIdList['splice'](_0x12831e,0x1);break;}}for(let _0x30601b in ffmpList){let _0xe8c54b=ffmpList[_0x30601b];if(_0xe8c54b[_0x59e626(0x1dd)]==_0x8f2a2){ffmpList['splice'](_0x30601b,0x1);let _0x423436=_0xe8c54b[_0x59e626(0x1c8)][_0x59e626(0x1d7)]();_0x3f4b5c&&setTimeout(()=>{const _0x4725be=_0x59e626;_0xe8c54b[_0x4725be(0x1da)][_0x4725be(0x20f)]()['then'](()=>{});},0x7d0);return;}}}function startPlay(_0x2b92ec){const _0x4823a4=_0x2e4b6d;let {playId:_0x6482d3,args:_0x41f9db,action:_0xe539bc}=_0x2b92ec;if(!_0x6482d3)return;if(_0xe539bc=='stop'){killFfmpByPlayId(_0x6482d3);return;}for(let _0x94e752 in ffmpList){let _0x448bc7=ffmpList[_0x94e752];if(_0x448bc7[_0x4823a4(0x1dd)]==_0x6482d3){setLastReqTime(_0x6482d3);return;}}if(startedPlayIdList[_0x4823a4(0x20b)](_0x6482d3)){console['log']('Play\x20ID\x20has\x20started');return;}startedPlayIdList[_0x4823a4(0x226)](_0x6482d3);let _0xb5e431=dbOther[_0x4823a4(0x200)]('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')[_0x4823a4(0x1eb)](_0x6482d3);if(!_0xb5e431)return;let _0x1ded4f=path[_0x4823a4(0x222)](config[_0x4823a4(0x1f8)],_0x6482d3);function _0x7505a9(){const _0x1a03c8=_0x4823a4;transCodeUtil[_0x1a03c8(0x216)](dbFileIndex,dbOther,_0x41f9db)[_0x1a03c8(0x204)](_0xecddca=>{const _0x20f8bb=_0x1a03c8;let {fullpath:_0x37466a,streamList:_0x2c500f,needDecrypt:_0x4dd005,pwd:_0xce3dfb,duration:_0x1e85cb}=_0xecddca;fs[_0x20f8bb(0x1c4)](_0x37466a,fs[_0x20f8bb(0x1bc)][_0x20f8bb(0x1ff)],_0x55929d=>{const _0x2a908c=_0x20f8bb;if(_0x55929d)return;let _0x38e536=chokidar[_0x2a908c(0x1de)](_0x1ded4f,{'ignored':_0x2a908c(0x1d2),'ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x38e536['on'](_0x2a908c(0x1fd),_0x8589f0=>{const _0x59feb4=_0x2a908c;if(_0x8589f0['endsWith'](_0x59feb4(0x1db))||_0x8589f0[_0x59feb4(0x1bd)](_0x59feb4(0x1e5)))return;let _0x27aa33=path[_0x59feb4(0x215)](_0x8589f0),_0x441b12=dbOther[_0x59feb4(0x200)](_0x59feb4(0x1f2))[_0x59feb4(0x20d)](_0x6482d3);if(!_0x441b12)return killFfmpByPlayId(_0x6482d3);else dbOther[_0x59feb4(0x200)]('REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)')[_0x59feb4(0x20d)](_0x6482d3,_0x27aa33,_0x59feb4(0x1c9));}),_0x38e536['on'](_0x2a908c(0x1ec),_0x21587d=>{}),_0x38e536['on'](_0x2a908c(0x211),_0x302120=>{const _0x5c5d99=_0x2a908c;if(_0x302120[_0x5c5d99(0x1bd)](_0x5c5d99(0x1db))||_0x302120['endsWith'](_0x5c5d99(0x1e5)))return;let _0x10a9a4=path[_0x5c5d99(0x215)](_0x302120);dbOther[_0x5c5d99(0x200)](_0x5c5d99(0x1fc))[_0x5c5d99(0x20d)](_0x6482d3,_0x10a9a4,_0x5c5d99(0x1c9));}),_0x38e536['on'](_0x2a908c(0x1ef),()=>{m3u8FfmpegTrans(_0x38e536,_0x6482d3,_0x41f9db,_0x37466a,_0x2c500f,_0x4dd005,_0xce3dfb);});});})[_0x1a03c8(0x236)](_0x5522e9=>{});}fs[_0x4823a4(0x1c5)](_0x1ded4f,(_0x5e2cb5,_0x1fdf3d)=>{_0x5e2cb5?fs['mkdir'](_0x1ded4f,{'recursive':!![]},_0x24576e=>{!_0x24576e&&_0x7505a9();}):_0x7505a9();});}function m3u8FfmpegTrans(_0x5090f4,_0x14ede8,_0x5bf91a,_0x401bbe,_0x1462d9,_0x3032b5,_0x3bc54f,_0x47c171=!![]){const _0x2754ae=_0x2e4b6d;try{let _0x482c02=_0x5bf91a['size']&&_0x5bf91a[_0x2754ae(0x1d8)]>0xf0?_0x5bf91a['size']:0x2d0,{videoStream:_0x3b56fa,videoWidth:_0x2799cc,videoHeight:_0x234ec3}=transCodeUtil['parseStreamList'](_0x1462d9),_0x2e1bfe=_0x3032b5?cryptoUtils[_0x2754ae(0x1cf)](_0x3bc54f,_0x401bbe):_0x401bbe;_0x2e1bfe=transCodeUtil[_0x2754ae(0x1cd)](_0x2e1bfe);let _0x204df7=FFmpeg(_0x2e1bfe),_0x47e50f=transCodeUtil['getCoderConfig'](dbOther,_0x3b56fa);_0x47c171&&_0x47e50f[_0x2754ae(0x1e1)]&&_0x204df7[_0x2754ae(0x232)](_0x47e50f['hwaccel']);if(_0x47c171&&_0x47e50f['decoderCommand']){let _0x404769=transCodeUtil[_0x2754ae(0x1f6)](_0x3b56fa,_0x47e50f[_0x2754ae(0x1e8)][_0x2754ae(0x217)]('-c:v\x20',''));_0x404769&&_0x204df7[_0x2754ae(0x232)](_0x47e50f[_0x2754ae(0x1e8)]);}_0x204df7[_0x2754ae(0x210)](_0x2754ae(0x205)+transCodeUtil[_0x2754ae(0x1d0)](dbOther));let _0xbc05fc=_0x5bf91a[_0x2754ae(0x203)]*config['m3u8segmentDuration'];_0xbc05fc&&!_0x3032b5&&_0x204df7['seekInput'](''+parseInt(_0xbc05fc));_0x204df7[_0x2754ae(0x1cb)](_0x2754ae(0x212));_0x47e50f[_0x2754ae(0x1ee)]&&_0x204df7[_0x2754ae(0x1d5)](_0x47e50f[_0x2754ae(0x1ee)]);let _0x34546f=transCodeUtil[_0x2754ae(0x221)](_0x3b56fa,_0x5bf91a[_0x2754ae(0x1bb)]);_0x204df7[_0x2754ae(0x21d)](''+_0x34546f),_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x1d4)+_0x34546f/0x2+'k');let _0x4731b4=transCodeUtil[_0x2754ae(0x1ce)](_0x482c02,_0x2799cc,_0x234ec3),_0x1d2cef=null;_0x5bf91a[_0x2754ae(0x1e4)]==0x1&&_0x5bf91a['subtitleIndex']>-0x1&&(_0x1d2cef=transCodeUtil[_0x2754ae(0x225)](_0x1462d9,_0x5bf91a['subtitleIndex']));_0x1d2cef&&(_0x1d2cef[_0x2754ae(0x1d3)]==_0x2754ae(0x20a)||_0x1d2cef['codec_name']==_0x2754ae(0x1fe)||_0x1d2cef[_0x2754ae(0x1d3)]==_0x2754ae(0x21a)||_0x1d2cef['codec_name']=='dvd_subtitle'||_0x1d2cef[_0x2754ae(0x1d3)]=='dvdsub'||_0x1d2cef[_0x2754ae(0x1d3)]==_0x2754ae(0x1c3))?(_0x204df7[_0x2754ae(0x1dc)]([_0x2754ae(0x1f7)+_0x4731b4+_0x2754ae(0x21b),_0x2754ae(0x234)+_0x5bf91a[_0x2754ae(0x1e2)]+'][vs]scale2ref[sub][ref]',_0x2754ae(0x214)]),_0x204df7[_0x2754ae(0x233)](_0x2754ae(0x235))):(_0x4731b4&&_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x201)+_0x4731b4),_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x22e)));_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x1f9)+(_0x5bf91a[_0x2754ae(0x1e9)]?_0x5bf91a['audioIndex']:0x0)+'?');let _0x29ef76=transCodeUtil['getFps'](_0x3b56fa);_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x207)+_0x29ef76),_0x204df7[_0x2754ae(0x230)]('-g\x20'+_0x29ef76);let _0x1f1863=transCodeUtil['getTranscodeSpeed'](dbOther,_0x47e50f['encoderName']);_0x1f1863!=_0x2754ae(0x223)&&_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x1fb)+_0x1f1863);let _0x50ef74=transCodeUtil[_0x2754ae(0x1bf)](_0x3b56fa,_0x47e50f['encoderName']);_0x50ef74&&_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x1c2)+_0x50ef74);_0x204df7['addOption'](_0x2754ae(0x229));_0x5bf91a['ac']&&_0x5bf91a['ac']>0x0&&_0x5bf91a['ac']<=0x18?_0x204df7['addOption'](_0x2754ae(0x22d)+_0x5bf91a['ac']):_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x231));let _0x3eda5f=transCodeUtil[_0x2754ae(0x1d9)](dbOther);_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x21f)+_0x3eda5f),_0x204df7[_0x2754ae(0x220)]('hls'),_0x204df7['addOption'](_0x2754ae(0x227)+config[_0x2754ae(0x20c)]),_0x204df7[_0x2754ae(0x230)](_0x2754ae(0x1f0));let _0x4f11e7=_0x5bf91a[_0x2754ae(0x203)];_0x4f11e7&&_0xbc05fc&&!_0x3032b5&&_0x204df7['addOption'](_0x2754ae(0x1e0)+_0x4f11e7);let _0x30c0f8=path[_0x2754ae(0x222)](config[_0x2754ae(0x1f8)],_0x14ede8,'stream.m3u8');_0x30c0f8=transCodeUtil[_0x2754ae(0x1cd)](_0x30c0f8),_0x204df7[_0x2754ae(0x1ca)](''+_0x30c0f8);let _0x121a63=path[_0x2754ae(0x1ed)](_0x30c0f8);fs[_0x2754ae(0x1c5)](_0x121a63,(_0x1f6c6d,_0x57af9e)=>{const _0xf24b0e=_0x2754ae;if(_0x1f6c6d){fs[_0xf24b0e(0x228)](_0x121a63,{'recursive':!![]},_0x4298bc=>{if(_0x4298bc)return;_0x123dca(_0x204df7);});return;}_0x123dca(_0x204df7);});function _0x36669c(){const _0x47d2d7=_0x2754ae;_0x47c171&&(console[_0x47d2d7(0x224)]('!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!'),killFfmpByPlayId(_0x14ede8,![]),m3u8FfmpegTrans(_0x5090f4,_0x14ede8,_0x5bf91a,_0x401bbe,_0x1462d9,_0x3032b5,_0x3bc54f,![]));}function _0x123dca(){const _0x104e7e=_0x2754ae;_0x204df7[_0x104e7e(0x20d)](),addFfmpToList(_0x204df7,_0x14ede8,_0x5090f4),_0x204df7['on'](_0x104e7e(0x219),function(_0xc72791){const _0x221704=_0x104e7e;console[_0x221704(0x224)](_0xc72791);})['on'](_0x104e7e(0x22a),function(_0x5d469c){const _0x22b8fb=_0x104e7e;_0x47c171&&_0x47e50f&&_0x5d469c&&_0x5d469c[_0x22b8fb(0x209)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console['log'](_0x22b8fb(0x1be)),_0x36669c());})['on'](_0x104e7e(0x1ec),function(_0x5c2930){const _0x4db1c7=_0x104e7e;_0x5c2930[_0x4db1c7(0x238)]&&_0x5c2930[_0x4db1c7(0x238)][_0x4db1c7(0x209)]('killed')==-0x1&&(console[_0x4db1c7(0x224)](_0x5c2930),_0x36669c());})['on'](_0x104e7e(0x1df),function(_0x4edd82){console['log'](_0x4edd82);});}}catch(_0x1884e2){console[_0x2754ae(0x224)](_0x1884e2),_0x5090f4['close']();}}setInterval(()=>{const _0x5bcbaa=_0x2e4b6d;let _0x509f79=new Date()['getTime'](),_0x5c0b77=0xea60;for(let _0x3f5e2a in ffmpList){let _0x5880ea=ffmpList[_0x3f5e2a],_0x4b9ff8=_0x509f79-_0x5880ea[_0x5bcbaa(0x1cc)];_0x5880ea[_0x5bcbaa(0x1cc)]&&_0x4b9ff8>_0x5c0b77&&(console[_0x5bcbaa(0x224)](_0x5bcbaa(0x237)),killFfmpByPlayId(_0x5880ea[_0x5bcbaa(0x1dd)]));}},0x2710),process['on'](_0x2e4b6d(0x238),_0x445126=>{startPlay(_0x445126);}),process['on'](_0x2e4b6d(0x1f1),(_0x2813dd,_0x7a51b2)=>{const _0x216e64=_0x2e4b6d;process[_0x216e64(0x206)]({'type':_0x216e64(0x20f)});});