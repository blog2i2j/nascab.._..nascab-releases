const _0x459c76=_0x922d;function _0x922d(_0x5f434a,_0x5b0fde){const _0x1a5f56=_0x1a5f();return _0x922d=function(_0x922d15,_0x53ff9a){_0x922d15=_0x922d15-0x82;let _0xf48a74=_0x1a5f56[_0x922d15];return _0xf48a74;},_0x922d(_0x5f434a,_0x5b0fde);}(function(_0x43737d,_0x458dc6){const _0x5254cc=_0x922d,_0x1791e4=_0x43737d();while(!![]){try{const _0x2d6255=-parseInt(_0x5254cc(0x92))/0x1*(-parseInt(_0x5254cc(0xda))/0x2)+parseInt(_0x5254cc(0x94))/0x3*(parseInt(_0x5254cc(0xc4))/0x4)+-parseInt(_0x5254cc(0xb0))/0x5+-parseInt(_0x5254cc(0xfa))/0x6*(parseInt(_0x5254cc(0xd5))/0x7)+-parseInt(_0x5254cc(0x87))/0x8+-parseInt(_0x5254cc(0xe4))/0x9+parseInt(_0x5254cc(0xa3))/0xa;if(_0x2d6255===_0x458dc6)break;else _0x1791e4['push'](_0x1791e4['shift']());}catch(_0x593460){_0x1791e4['push'](_0x1791e4['shift']());}}}(_0x1a5f,0x30d20));const path=require(_0x459c76(0xc1)),fs=require('fs'),config=require('../myConfig/config'),transCodeUtil=require(_0x459c76(0xdd)),Database=require(_0x459c76(0xd0)),dbOther=new Database(config[_0x459c76(0xdf)],{}),dbFileIndex=new Database(config[_0x459c76(0xc5)],{'timeout':0xea60});dbOther[_0x459c76(0x8f)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x459c76(0x8f)](_0x459c76(0x9a));const FFmpeg=require(_0x459c76(0xd3))[_0x459c76(0x9d)],ffmpList=[];let startedPlayIdList=[],cryptoUtils=require(_0x459c76(0x97));const chokidar=require(_0x459c76(0xf2)),platform=require('os')[_0x459c76(0xf6)];process['title']=_0x459c76(0xfd);function setLastReqTime(_0x53c666){const _0x15fa60=_0x459c76;for(let _0x5cdbb2 in ffmpList){let _0x5d382d=ffmpList[_0x5cdbb2];if(_0x5d382d[_0x15fa60(0xc0)]==_0x53c666)return ffmpList[_0x5cdbb2][_0x15fa60(0x90)]=new Date()['getTime']();}}function addFfmpToList(_0x3ded71,_0x1a8c93,_0x9fd969){const _0x584537=_0x459c76;ffmpList[_0x584537(0xfb)]({'ffmp':_0x3ded71,'playId':_0x1a8c93,'dirWatcher':_0x9fd969,'lastTsReqTime':new Date()[_0x584537(0xae)]()});}function killFfmpByPlayId(_0x416ff3,_0x269bf7=!![]){const _0x327a8b=_0x459c76;console['log'](_0x327a8b(0x100),_0x416ff3);for(let _0x4db98d in startedPlayIdList){let _0x9b1df1=startedPlayIdList[_0x4db98d];if(_0x9b1df1==_0x416ff3){startedPlayIdList['splice'](_0x4db98d,0x1);break;}}for(let _0x4bc5bc in ffmpList){let _0x1d6e62=ffmpList[_0x4bc5bc];if(_0x1d6e62[_0x327a8b(0xc0)]==_0x416ff3){ffmpList[_0x327a8b(0xe8)](_0x4bc5bc,0x1);let _0x4ab1e2=_0x1d6e62[_0x327a8b(0x91)][_0x327a8b(0xa6)]();_0x269bf7&&setTimeout(()=>{const _0x406f18=_0x327a8b;_0x1d6e62[_0x406f18(0xcc)]['close']()[_0x406f18(0xac)](()=>{});},0x7d0);return;}}}function startPlay(_0x3b6dc0){const _0x2c969e=_0x459c76;let {playId:_0x550415,args:_0x366a78,action:_0x21405c}=_0x3b6dc0;if(!_0x550415)return;if(_0x21405c==_0x2c969e(0xe1)){killFfmpByPlayId(_0x550415);return;}for(let _0x24c4c8 in ffmpList){let _0x1c2490=ffmpList[_0x24c4c8];if(_0x1c2490['playId']==_0x550415){setLastReqTime(_0x550415);return;}}if(startedPlayIdList[_0x2c969e(0xe2)](_0x550415)){console[_0x2c969e(0xab)](_0x2c969e(0x88));return;}startedPlayIdList[_0x2c969e(0xfb)](_0x550415);let _0x3b74c1=dbOther[_0x2c969e(0xb7)](_0x2c969e(0xcd))[_0x2c969e(0x104)](_0x550415);if(!_0x3b74c1)return;let _0x35aa3d=path['join'](config[_0x2c969e(0xe6)],_0x550415);function _0x489ecc(){const _0x196743=_0x2c969e;transCodeUtil[_0x196743(0xc9)](dbFileIndex,dbOther,_0x366a78)[_0x196743(0xac)](_0x2949f5=>{const _0x2417be=_0x196743;let {fullpath:_0x176920,streamList:_0x1359d9,needDecrypt:_0x23110c,pwd:_0x4cd205,duration:_0xf4cead}=_0x2949f5;fs[_0x2417be(0x96)](_0x176920,fs['constants'][_0x2417be(0xc6)],_0x64450e=>{const _0x1fba3a=_0x2417be;if(_0x64450e)return;let _0x8f5537=chokidar[_0x1fba3a(0xec)](_0x35aa3d,{'ignored':'*.m3u8','ignoreInitial':!![],'awaitWriteFinish':{'stabilityThreshold':0x12c,'pollInterval':0x96}});_0x8f5537['on'](_0x1fba3a(0xbd),_0x4bd730=>{const _0x5612e9=_0x1fba3a;if(_0x4bd730[_0x5612e9(0x9c)]('.tmp')||_0x4bd730[_0x5612e9(0x9c)](_0x5612e9(0x95)))return;let _0x3fe4f7=path[_0x5612e9(0xf5)](_0x4bd730),_0x5dfb7e=dbOther[_0x5612e9(0xb7)](_0x5612e9(0xee))['run'](_0x550415);if(!_0x5dfb7e)return killFfmpByPlayId(_0x550415);else dbOther['prepare'](_0x5612e9(0x9e))[_0x5612e9(0xd2)](_0x550415,_0x3fe4f7,'gen');}),_0x8f5537['on'](_0x1fba3a(0xce),_0xd12a68=>{}),_0x8f5537['on'](_0x1fba3a(0xcf),_0x5d6f81=>{const _0x2f70e3=_0x1fba3a;if(_0x5d6f81[_0x2f70e3(0x9c)]('.tmp')||_0x5d6f81[_0x2f70e3(0x9c)](_0x2f70e3(0x95)))return;let _0x486885=path[_0x2f70e3(0xf5)](_0x5d6f81);dbOther['prepare'](_0x2f70e3(0x9e))['run'](_0x550415,_0x486885,_0x2f70e3(0xbc));}),_0x8f5537['on'](_0x1fba3a(0xb4),()=>{m3u8FfmpegTrans(_0x8f5537,_0x550415,_0x366a78,_0x176920,_0x1359d9,_0x23110c,_0x4cd205);});});})[_0x196743(0xaa)](_0x3defac=>{});}fs[_0x2c969e(0xd4)](_0x35aa3d,(_0x5b451a,_0x24d56f)=>{const _0x3faecb=_0x2c969e;_0x5b451a?fs[_0x3faecb(0xca)](_0x35aa3d,{'recursive':!![]},_0x247ab3=>{!_0x247ab3&&_0x489ecc();}):_0x489ecc();});}function m3u8FfmpegTrans(_0x148590,_0x418d13,_0x3adacd,_0x551e1b,_0x3f931c,_0x3a762f,_0x47a54d,_0x53338a=!![]){const _0x44e047=_0x459c76;try{let _0x15d682=_0x3adacd[_0x44e047(0xb8)]&&_0x3adacd[_0x44e047(0xb8)]>0xf0?_0x3adacd[_0x44e047(0xb8)]:0x2d0,{videoStream:_0x119924,videoWidth:_0x3ae760,videoHeight:_0x18d2af}=transCodeUtil[_0x44e047(0xf0)](_0x3f931c),_0x4553a5=_0x3a762f?cryptoUtils[_0x44e047(0xd7)](_0x47a54d,_0x551e1b):_0x551e1b;_0x4553a5=transCodeUtil[_0x44e047(0xef)](_0x4553a5);let _0xc10ad=FFmpeg(_0x4553a5),_0x432e32=transCodeUtil[_0x44e047(0x8d)](dbOther,_0x119924);_0x53338a&&_0x432e32[_0x44e047(0xc7)]&&_0xc10ad['addInputOption'](_0x432e32[_0x44e047(0xc7)]);if(_0x53338a&&_0x432e32[_0x44e047(0x8a)]){let _0x5c4472=transCodeUtil[_0x44e047(0x8b)](_0x119924,_0x432e32[_0x44e047(0x8a)][_0x44e047(0x86)](_0x44e047(0xcb),''));_0x5c4472&&_0xc10ad[_0x44e047(0x101)](_0x432e32[_0x44e047(0x8a)]);}_0xc10ad[_0x44e047(0x83)](_0x44e047(0xb3)+transCodeUtil['getReadRate'](dbOther));let _0x5a225f=_0x3adacd[_0x44e047(0xbe)]*config[_0x44e047(0xe9)];_0x5a225f&&!_0x3a762f&&_0xc10ad[_0x44e047(0xa4)](''+parseInt(_0x5a225f));_0xc10ad['audioCodec'](_0x44e047(0xf3));_0x432e32[_0x44e047(0xe3)]&&_0xc10ad[_0x44e047(0x84)](_0x432e32['encoderName']);let _0x172c53=transCodeUtil[_0x44e047(0xc3)](_0x119924,_0x3adacd[_0x44e047(0xb9)]);_0xc10ad['videoBitrate'](''+_0x172c53),_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xf9)+_0x172c53/0x2+'k');let _0x3d6999=transCodeUtil['getScaleOption'](_0x15d682,_0x3ae760,_0x18d2af),_0xd6b3f0=null;_0x3adacd[_0x44e047(0x85)]==0x1&&_0x3adacd[_0x44e047(0x9f)]>-0x1&&(_0xd6b3f0=transCodeUtil[_0x44e047(0xbf)](_0x3f931c,_0x3adacd[_0x44e047(0x9f)]));_0xd6b3f0&&(_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0xd1)||_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0xf1)||_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0xa8)||_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0xb1)||_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0xad)||_0xd6b3f0[_0x44e047(0xa9)]==_0x44e047(0x8c))?(_0xc10ad[_0x44e047(0xeb)]([_0x44e047(0xf8)+_0x3d6999+_0x44e047(0x103),_0x44e047(0xc2)+_0x3adacd[_0x44e047(0x9f)]+_0x44e047(0x98),_0x44e047(0xba)]),_0xc10ad[_0x44e047(0x89)]('-map\x20[vss]')):(_0x3d6999&&_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xbb)+_0x3d6999),_0xc10ad[_0x44e047(0xb6)]('-map\x200:v:0?'));_0xc10ad[_0x44e047(0xb6)](_0x44e047(0x102)+(_0x3adacd[_0x44e047(0xc8)]?_0x3adacd[_0x44e047(0xc8)]:0x0)+'?');let _0x5ab6ab=transCodeUtil[_0x44e047(0xfe)](_0x119924);_0xc10ad['addOption'](_0x44e047(0x9b)+_0x5ab6ab),_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xa0)+_0x5ab6ab);let _0x486518=transCodeUtil[_0x44e047(0xe7)](dbOther,_0x432e32[_0x44e047(0xe3)]);_0x486518!=_0x44e047(0xa1)&&_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xd9)+_0x486518);let _0x4f1c0b=transCodeUtil['getPixFmt'](_0x119924,_0x432e32[_0x44e047(0xe3)]);_0x4f1c0b&&_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xaf)+_0x4f1c0b);_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xf7));_0x3adacd['ac']&&_0x3adacd['ac']>0x0&&_0x3adacd['ac']<=0x18?_0xc10ad[_0x44e047(0xb6)](_0x44e047(0x93)+_0x3adacd['ac']):_0xc10ad[_0x44e047(0xb6)](_0x44e047(0x82));let _0x283913=transCodeUtil['getCrf'](dbOther);_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xf4)+_0x283913),_0xc10ad[_0x44e047(0xa2)](_0x44e047(0x8e)),_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xa7)+config[_0x44e047(0xe9)]),_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xdc));let _0x356df1=_0x3adacd[_0x44e047(0xbe)];_0x356df1&&_0x5a225f&&!_0x3a762f&&_0xc10ad[_0x44e047(0xb6)](_0x44e047(0xea)+_0x356df1);let _0x34bdf0=path[_0x44e047(0x99)](config[_0x44e047(0xe6)],_0x418d13,_0x44e047(0xfc));_0x34bdf0=transCodeUtil[_0x44e047(0xef)](_0x34bdf0),_0xc10ad[_0x44e047(0xdb)](''+_0x34bdf0);let _0x398832=path[_0x44e047(0xde)](_0x34bdf0);fs['stat'](_0x398832,(_0x1995eb,_0x146f85)=>{const _0x4cd6a0=_0x44e047;if(_0x1995eb){fs[_0x4cd6a0(0xca)](_0x398832,{'recursive':!![]},_0x1a2606=>{if(_0x1a2606)return;_0x20d2d3(_0xc10ad);});return;}_0x20d2d3(_0xc10ad);});function _0x3158da(){const _0x1513d5=_0x44e047;_0x53338a&&(console[_0x1513d5(0xab)](_0x1513d5(0xe0)),killFfmpByPlayId(_0x418d13,![]),m3u8FfmpegTrans(_0x148590,_0x418d13,_0x3adacd,_0x551e1b,_0x3f931c,_0x3a762f,_0x47a54d,![]));}function _0x20d2d3(){const _0x100d8d=_0x44e047;_0xc10ad[_0x100d8d(0xd2)](),addFfmpToList(_0xc10ad,_0x418d13,_0x148590),_0xc10ad['on'](_0x100d8d(0xe5),function(_0x3e835c){console['log'](_0x3e835c);})['on'](_0x100d8d(0xd6),function(_0x4abeea){const _0xd9f02b=_0x100d8d;_0x53338a&&_0x432e32&&_0x4abeea&&_0x4abeea[_0xd9f02b(0xb2)]('More\x20data\x20is\x20required\x20to\x20decode\x20header')!=-0x1&&(console[_0xd9f02b(0xab)]('qsv\x20cannot\x20deal,restart\x20ffmpeg'),_0x3158da());})['on'](_0x100d8d(0xce),function(_0x35fa1f){const _0x22748f=_0x100d8d;_0x35fa1f[_0x22748f(0xff)]&&_0x35fa1f[_0x22748f(0xff)][_0x22748f(0xb2)]('killed')==-0x1&&(console[_0x22748f(0xab)](_0x35fa1f),_0x3158da());})['on'](_0x100d8d(0xd8),function(_0x22a43c){const _0x5230f7=_0x100d8d;console[_0x5230f7(0xab)](_0x22a43c);});}}catch(_0x1156a0){console[_0x44e047(0xab)](_0x1156a0),_0x148590['close']();}}function _0x1a5f(){const _0x5c164f=['encoderName','2426058eXnIWw','start','m3u8TmpPath','getTranscodeSpeed','splice','m3u8segmentDuration','-start_number\x20','complexFilter','watch','No\x20request\x20timeout\x20','SELECT\x20play_id\x20FROM\x20play_record\x20WHERE\x20play_id=?','dealFFmpegPath','parseStreamList','hdmv_pgs_subtitle','chokidar','aac','-crf\x20','basename','platform','-copyts','[0:v:0]','-bufsize\x20','654anKINT','push','stream.m3u8','NasCabHlsWorker','getFps','message','Stop\x20transcode\x20','addInputOption','-map\x200:a:','[vs]','get','-ac\x202','inputOption','videoCodec','burn','replace','621912Mfrqrg','Play\x20ID\x20has\x20started','addOutputOption','decoderCommand','decoderSupportPixFormat','dvb_subtitle','getCoderConfig','hls','pragma','lastTsReqTime','ffmp','1nuLIXC','-ac\x20','159tiYucE','.m3u8','access','../express-server/utils/cryptoUtils','][vs]scale2ref[sub][ref]','join','journal_mode\x20=\x20WAL','-r\x20','endsWith','FFmpeg','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','subtitleIndex','-g\x20','medium','format','6568910DdktEy','seekInput','exit','kill','-hls_time\x20','vobsub','codec_name','catch','log','then','dvdsub','getTime','-pix_fmt\x20','1628655HXEOmF','dvd_subtitle','indexOf','-readrate\x20','ready','close','addOption','prepare','size','videobit','[ref][sub]overlay[vss]','-filter:v\x20','gen','add','seq','parseSubtitle','playId','path','[0:s:','getVideoBitrate','14788DHuUmk','dbFileIndex','R_OK','hwaccel','audioIndex','parseVideoFullPath','mkdir','-c:v\x20','dirWatcher','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','error','change','better-sqlite3','pgssub','run','../libs/nasTrans','stat','21077nQNhWy','stderr','decryptFileGetStream','end','-preset\x20','696734AwlUQg','output','-hls_list_size\x200','../utils/transCodeUtil','dirname','dbOther','!!!!!!\x20Restart\x20TransCode\x20Without\x20HW\x20!!!!!!','stop','includes'];_0x1a5f=function(){return _0x5c164f;};return _0x1a5f();}setInterval(()=>{const _0x36d2dc=_0x459c76;let _0x16867a=new Date()[_0x36d2dc(0xae)](),_0x708e05=0xea60;for(let _0x27bb18 in ffmpList){let _0x2c60de=ffmpList[_0x27bb18],_0x5bd006=_0x16867a-_0x2c60de[_0x36d2dc(0x90)];_0x2c60de[_0x36d2dc(0x90)]&&_0x5bd006>_0x708e05&&(console[_0x36d2dc(0xab)](_0x36d2dc(0xed)),killFfmpByPlayId(_0x2c60de[_0x36d2dc(0xc0)]));}},0x2710),process['on'](_0x459c76(0xff),_0x35812c=>{startPlay(_0x35812c);}),process['on'](_0x459c76(0xa5),(_0x11ae3e,_0x4afb3b)=>{const _0x1045b1=_0x459c76;process['send']({'type':_0x1045b1(0xb5)});});