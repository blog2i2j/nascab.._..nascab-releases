const _0x302959=_0x5a7e;(function(_0x458f25,_0x50d221){const _0x1e8e67=_0x5a7e,_0x5f4f58=_0x458f25();while(!![]){try{const _0x383ef1=-parseInt(_0x1e8e67(0x196))/0x1*(-parseInt(_0x1e8e67(0x1ae))/0x2)+parseInt(_0x1e8e67(0x1aa))/0x3+parseInt(_0x1e8e67(0x1d0))/0x4*(-parseInt(_0x1e8e67(0x1b0))/0x5)+parseInt(_0x1e8e67(0x1be))/0x6+parseInt(_0x1e8e67(0x1a5))/0x7+-parseInt(_0x1e8e67(0x1af))/0x8+parseInt(_0x1e8e67(0x1cd))/0x9*(-parseInt(_0x1e8e67(0x1d2))/0xa);if(_0x383ef1===_0x50d221)break;else _0x5f4f58['push'](_0x5f4f58['shift']());}catch(_0x54542c){_0x5f4f58['push'](_0x5f4f58['shift']());}}}(_0x48bd,0x5daea));const path=require(_0x302959(0x1ba)),fs=require('fs'),config=require(_0x302959(0x1a6)),Database=require(_0x302959(0x1c2)),dbConfigTable=require(_0x302959(0x1c4)),phash=require(_0x302959(0x1c9)),phashDist=require(_0x302959(0x1c0)),dbSourceFolderTable=require(_0x302959(0x1bf)),sharpUtil=require(_0x302959(0x1ac)),exifUtils=require('../../utils/exifUtils');process[_0x302959(0x195)]=_0x302959(0x1c7);let dbFileIndex=new Database(config[_0x302959(0x1c6)],{}),dbOther=new Database(config[_0x302959(0x1a1)],{});dbOther['pragma']('journal_mode\x20=\x20WAL'),dbFileIndex[_0x302959(0x1b8)](_0x302959(0x1c5)),process['on']('exit',()=>{const _0x33261b=_0x302959;dbOther['close'](),dbFileIndex[_0x33261b(0x19e)]();});function _0x48bd(){const _0x1026b4=['sharp-phash','getSharpInstanceFromInput','access','all','27zjzNPg','exit','send','2060csxMAV','phash','544970DiqjWF','\x20LIMIT\x201','title','42vORhul','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','constants','prepare','transSpcielFormat','value','deleteRawTempFile','close','get','join','dbOther','lastInsertRowid','length','\x20AND\x20','4503961biHzsU','../../myConfig/config','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','rotate','toBuffer','1139703yVHVXy','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','../../express-server/utils/sharpUtils','log','13790THgZsx','4546328lXurAg','2395zXKkVl','catch','file_index_photo-indexing','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','findByTitle','filename','getExcludePathWhereStr','pragma','phash_compare','path','R_OK','uncaughtException','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','295650ryenMM','../../db/dbSourceFolderTable','sharp-phash/distance','then','better-sqlite3','count','../../db/dbConfigTable','journal_mode\x20=\x20WAL','dbFileIndex','NasCabDeduplicatePhotos','run'];_0x48bd=function(){return _0x1026b4;};return _0x48bd();}const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x39f2da=>{const _0x32dd2b=_0x5a7e;let _0x268ffa;function _0x19b5c5(){const _0x7bc36d=_0x5a7e;if(_0x268ffa)dbFileIndex['prepare'](_0x7bc36d(0x1b3)+_0x268ffa['id'])[_0x7bc36d(0x1c8)]();return _0x39f2da();}try{let _0x199665=dbConfigTable[_0x32dd2b(0x1b5)](dbOther,_0x32dd2b(0x1b2));if(_0x199665&&_0x199665=='1')return setTimeout(_0x39f2da,DEAL_GAP);let _0x45b979='SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1';_0x45b979+=_0x32dd2b(0x1d3),_0x268ffa=dbFileIndex['prepare'](_0x45b979)[_0x32dd2b(0x19f)]();if(!_0x268ffa)return exitProcess();currentDetectIndex=_0x268ffa;let _0x5c7f46=path[_0x32dd2b(0x1a0)](_0x268ffa[_0x32dd2b(0x1ba)],_0x268ffa[_0x32dd2b(0x1b6)]);try{if(bgTaskId)dbOther[_0x32dd2b(0x19a)](_0x32dd2b(0x198)+bgTaskId)[_0x32dd2b(0x1c8)]();}catch(_0x6d76a2){}fs[_0x32dd2b(0x1cb)](_0x5c7f46,fs[_0x32dd2b(0x199)][_0x32dd2b(0x1bb)],async _0x152068=>{const _0x5092fa=_0x32dd2b;if(_0x152068)return console[_0x5092fa(0x1ad)](_0x152068),_0x19b5c5();try{sharpUtil[_0x5092fa(0x19b)](_0x5c7f46,(_0x39aefa,_0x596d0a,_0x2f0787)=>{const _0x4477cd=_0x5092fa;let _0x36eb89=sharpUtil[_0x4477cd(0x1ca)](_0x39aefa),_0x2ab866=exifUtils['getRotateFromTags'](_0x2f0787);_0x2ab866?_0x36eb89=_0x36eb89[_0x4477cd(0x1a8)](_0x2ab866):_0x36eb89=_0x36eb89[_0x4477cd(0x1a8)](),_0x36eb89[_0x4477cd(0x1a9)]()[_0x4477cd(0x1c1)](_0x4d6098=>{const _0xdf9226=_0x4477cd;phash(_0x4d6098)[_0xdf9226(0x1c1)](_0x46fce6=>{const _0x5687c0=_0xdf9226;_0x596d0a&&sharpUtil[_0x5687c0(0x19d)](_0x39aefa),dbFileIndex[_0x5687c0(0x19a)](_0x5687c0(0x1b4)+_0x268ffa['id'])[_0x5687c0(0x1c8)](_0x46fce6),_0x39f2da();})['catch'](_0x34ab75=>{return _0x596d0a&&sharpUtil['deleteRawTempFile'](_0x39aefa),_0x19b5c5();});})[_0x4477cd(0x1b1)](_0x1840d8=>{return _0x19b5c5();});});}catch(_0x3cffc6){return _0x19b5c5();}});}catch(_0x5874bc){return _0x19b5c5();}});}function exitProcess(){const _0x5d9afb=_0x302959;runComparePhash();try{if(bgTaskId)dbOther[_0x5d9afb(0x19a)]('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)[_0x5d9afb(0x1c8)]();}catch(_0x2542e4){}return process[_0x5d9afb(0x1cf)]({'type':_0x5d9afb(0x19e)}),process['exit']();}function _0x5a7e(_0xe0c730,_0x531823){const _0x48bdf7=_0x48bd();return _0x5a7e=function(_0x5a7ed6,_0x2f1390){_0x5a7ed6=_0x5a7ed6-0x195;let _0x839b4a=_0x48bdf7[_0x5a7ed6];return _0x839b4a;},_0x5a7e(_0xe0c730,_0x531823);}async function runGenPhashTask(){const _0x35958a=_0x302959;let _0x44683e=dbConfigTable[_0x35958a(0x1b5)](dbOther,'aiSimilarPhotoEnable');_0x44683e&&_0x44683e[_0x35958a(0x19c)]=='1'?runGenPhash()[_0x35958a(0x1c1)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x35958a(0x1ad)]('Similar\x20photo\x20disabled'),exitProcess());}runGenPhashTask();function runComparePhash(){const _0xf3878d=_0x302959;try{let _0x23b694='SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0',_0x4f02c7=dbSourceFolderTable[_0xf3878d(0x1b7)](dbOther,_0xf3878d(0x1ba),'excludePathPhoto');_0x4f02c7&&(_0x23b694+='\x20AND\x20'+_0x4f02c7);let _0xbabe89=dbFileIndex['prepare'](_0x23b694)[_0xf3878d(0x19f)]();if(_0xbabe89[_0xf3878d(0x1c3)]<0x1)return;let _0x2244ea=_0xf3878d(0x1bd);_0x4f02c7&&(_0x2244ea+=_0xf3878d(0x1a4)+_0x4f02c7);let _0x157759=dbFileIndex[_0xf3878d(0x19a)](_0x2244ea)[_0xf3878d(0x1cc)]();for(let _0x24c7a1=0x0;_0x24c7a1<_0x157759['length'];_0x24c7a1++){let _0x4cec3a=_0x157759[_0x24c7a1];if(_0x4cec3a['phash_compare']==0x1)continue;try{for(let _0x15999c=0x0;_0x15999c<_0x157759[_0xf3878d(0x1a3)];_0x15999c++){if(_0x157759[_0x15999c][_0xf3878d(0x1b9)]==0x1)continue;if(_0x157759[_0x24c7a1]['id']==_0x157759[_0x15999c]['id'])continue;try{let _0x543525=phashDist(_0x157759[_0x24c7a1][_0xf3878d(0x1d1)],_0x157759[_0x15999c][_0xf3878d(0x1d1)]);_0x543525<0x9&&(_0x157759[_0x15999c]['phash_compare']=0x1,dbFileIndex['prepare'](_0xf3878d(0x197)+_0x157759[_0x15999c]['id'])[_0xf3878d(0x1c8)](),dbFileIndex[_0xf3878d(0x19a)](_0xf3878d(0x1ab))[_0xf3878d(0x1c8)](_0x157759[_0x24c7a1]['id']+'',_0x157759[_0x15999c]['id']+'',_0x543525));}catch(_0x27c800){console[_0xf3878d(0x1ad)](_0x27c800);continue;}}}catch(_0x4fd929){console[_0xf3878d(0x1ad)](_0x4fd929),_0x157759[_0x24c7a1][_0xf3878d(0x1b9)]=0x1,dbFileIndex[_0xf3878d(0x19a)](_0xf3878d(0x197)+_0x4cec3a['id'])[_0xf3878d(0x1c8)]();continue;}_0x157759[_0x24c7a1]['phash_compare']=0x1,dbFileIndex[_0xf3878d(0x19a)](_0xf3878d(0x197)+_0x4cec3a['id'])[_0xf3878d(0x1c8)]();}}catch(_0x4fbe86){console[_0xf3878d(0x1ad)](_0x4fbe86);}}let bgTaskId;try{let info=dbOther['prepare']('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')[_0x302959(0x1c8)]('AI_PHASH');bgTaskId=info[_0x302959(0x1a2)];}catch(_0x5612db){}process['on'](_0x302959(0x1bc),(_0x133e7a,_0x4dfd8c)=>{const _0x5c40e1=_0x302959;currentDetectIndex&&dbFileIndex[_0x5c40e1(0x19a)](_0x5c40e1(0x1a7)+currentDetectIndex['id'])[_0x5c40e1(0x1c8)](),process[_0x5c40e1(0x1cf)]({'type':'close'}),process[_0x5c40e1(0x1ce)]();});