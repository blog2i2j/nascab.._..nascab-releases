const _0x54b28e=_0x5613;(function(_0x23386b,_0x395cdd){const _0x20aed0=_0x5613,_0x24312e=_0x23386b();while(!![]){try{const _0x120e0a=-parseInt(_0x20aed0(0x165))/0x1+-parseInt(_0x20aed0(0x163))/0x2*(parseInt(_0x20aed0(0x162))/0x3)+-parseInt(_0x20aed0(0x180))/0x4+-parseInt(_0x20aed0(0x167))/0x5+parseInt(_0x20aed0(0x14d))/0x6+-parseInt(_0x20aed0(0x172))/0x7*(parseInt(_0x20aed0(0x173))/0x8)+-parseInt(_0x20aed0(0x151))/0x9*(-parseInt(_0x20aed0(0x15f))/0xa);if(_0x120e0a===_0x395cdd)break;else _0x24312e['push'](_0x24312e['shift']());}catch(_0x1e2ae6){_0x24312e['push'](_0x24312e['shift']());}}}(_0x1d2e,0xaff55));const path=require(_0x54b28e(0x15a)),fs=require('fs'),config=require(_0x54b28e(0x17e)),Database=require(_0x54b28e(0x150)),dbConfigTable=require(_0x54b28e(0x169)),phash=require(_0x54b28e(0x16c)),phashDist=require(_0x54b28e(0x17b)),dbSourceFolderTable=require(_0x54b28e(0x179)),sharpUtil=require('../../express-server/utils/sharpUtils'),exifUtils=require('../../utils/exifUtils');function _0x1d2e(){const _0x428b06=['10630664RXjRcO','getRotateFromTags','excludePathPhoto','run','dbFileIndex','exit','../../db/dbSourceFolderTable','lastInsertRowid','sharp-phash/distance','phash','filename','../../myConfig/config','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','4591900Clpkvq','send','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','log','prepare','then','catch','Similar\x20photo\x20disabled','journal_mode\x20=\x20WAL','8277012CVUhIS','getSharpInstanceFromInput','dbOther','better-sqlite3','6866766ckkWOT','count','AI_PHASH','\x20AND\x20','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','value','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','path','getExcludePathWhereStr','toBuffer','close','aiSimilarPhotoEnable','40eWUOBy','length','phash_compare','235419XAHqbE','6UgAnoD','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','352372zvWTtR','rotate','3230370HOpEfi','pragma','../../db/dbConfigTable','deleteRawTempFile','join','sharp-phash','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','findByTitle','transSpcielFormat','access','get','7MuRnLt'];_0x1d2e=function(){return _0x428b06;};return _0x1d2e();}process['title']='NasCabDeduplicatePhotos';let dbFileIndex=new Database(config[_0x54b28e(0x177)],{}),dbOther=new Database(config[_0x54b28e(0x14f)],{});dbOther['pragma'](_0x54b28e(0x14c)),dbFileIndex[_0x54b28e(0x168)](_0x54b28e(0x14c)),process['on'](_0x54b28e(0x178),()=>{const _0x5e7eb0=_0x54b28e;dbOther[_0x5e7eb0(0x15d)](),dbFileIndex[_0x5e7eb0(0x15d)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function _0x5613(_0xfa91e3,_0x5b3307){const _0x1d2e1c=_0x1d2e();return _0x5613=function(_0x561386,_0x695c32){_0x561386=_0x561386-0x145;let _0x223967=_0x1d2e1c[_0x561386];return _0x223967;},_0x5613(_0xfa91e3,_0x5b3307);}function runGenPhash(){return new Promise(async _0x5eb704=>{const _0x112e25=_0x5613;let _0x2ce86a;function _0x201302(){const _0x1dde29=_0x5613;if(_0x2ce86a)dbFileIndex[_0x1dde29(0x148)](_0x1dde29(0x17f)+_0x2ce86a['id'])[_0x1dde29(0x176)]();return _0x5eb704();}try{let _0x5b8097=dbConfigTable[_0x112e25(0x16e)](dbOther,'file_index_photo-indexing');if(_0x5b8097&&_0x5b8097=='1')return setTimeout(_0x5eb704,DEAL_GAP);let _0x3b8068=_0x112e25(0x146);_0x3b8068+='\x20LIMIT\x201',_0x2ce86a=dbFileIndex['prepare'](_0x3b8068)['get']();if(!_0x2ce86a)return exitProcess();currentDetectIndex=_0x2ce86a;let _0x572c34=path[_0x112e25(0x16b)](_0x2ce86a['path'],_0x2ce86a[_0x112e25(0x17d)]);try{if(bgTaskId)dbOther[_0x112e25(0x148)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x112e25(0x176)]();}catch(_0x299f3e){}fs[_0x112e25(0x170)](_0x572c34,fs['constants']['R_OK'],async _0x2e9b05=>{const _0x49f4fb=_0x112e25;if(_0x2e9b05)return console[_0x49f4fb(0x147)](_0x2e9b05),_0x201302();try{sharpUtil[_0x49f4fb(0x16f)](_0x572c34,(_0x43545f,_0x373fcc,_0x3c06e1)=>{const _0x30b063=_0x49f4fb;let _0x1ae251=sharpUtil[_0x30b063(0x14e)](_0x43545f),_0x3e4fa7=exifUtils[_0x30b063(0x174)](_0x3c06e1);_0x3e4fa7?_0x1ae251=_0x1ae251[_0x30b063(0x166)](_0x3e4fa7):_0x1ae251=_0x1ae251['rotate'](),_0x1ae251[_0x30b063(0x15c)]()['then'](_0x1cb24d=>{phash(_0x1cb24d)['then'](_0x5bef61=>{const _0x9292fe=_0x5613;_0x373fcc&&sharpUtil[_0x9292fe(0x16a)](_0x43545f),dbFileIndex[_0x9292fe(0x148)]('UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id='+_0x2ce86a['id'])[_0x9292fe(0x176)](_0x5bef61),_0x5eb704();})['catch'](_0x51bb26=>{const _0x4fe42a=_0x5613;return _0x373fcc&&sharpUtil[_0x4fe42a(0x16a)](_0x43545f),_0x201302();});})[_0x30b063(0x14a)](_0xa41ada=>{return _0x201302();});});}catch(_0x3f3150){return _0x201302();}});}catch(_0x37f839){return _0x201302();}});}function exitProcess(){const _0x282738=_0x54b28e;runComparePhash();try{if(bgTaskId)dbOther[_0x282738(0x148)](_0x282738(0x16d)+bgTaskId)[_0x282738(0x176)]();}catch(_0x245d48){}return process[_0x282738(0x145)]({'type':_0x282738(0x15d)}),process[_0x282738(0x178)]();}async function runGenPhashTask(){const _0x57339a=_0x54b28e;let _0x425664=dbConfigTable[_0x57339a(0x16e)](dbOther,_0x57339a(0x15e));_0x425664&&_0x425664[_0x57339a(0x157)]=='1'?runGenPhash()[_0x57339a(0x149)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x57339a(0x147)](_0x57339a(0x14b)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x4ffc0e=_0x54b28e;try{let _0x20b69b=_0x4ffc0e(0x159),_0x11cdf9=dbSourceFolderTable[_0x4ffc0e(0x15b)](dbOther,_0x4ffc0e(0x15a),_0x4ffc0e(0x175));_0x11cdf9&&(_0x20b69b+=_0x4ffc0e(0x154)+_0x11cdf9);let _0x69db5=dbFileIndex[_0x4ffc0e(0x148)](_0x20b69b)[_0x4ffc0e(0x171)]();if(_0x69db5[_0x4ffc0e(0x152)]<0x1)return;let _0x3dbd22=_0x4ffc0e(0x156);_0x11cdf9&&(_0x3dbd22+='\x20AND\x20'+_0x11cdf9);let _0x353add=dbFileIndex[_0x4ffc0e(0x148)](_0x3dbd22)['all']();for(let _0x2554f7=0x0;_0x2554f7<_0x353add[_0x4ffc0e(0x160)];_0x2554f7++){let _0x163b34=_0x353add[_0x2554f7];if(_0x163b34['phash_compare']==0x1)continue;try{for(let _0xd664c0=0x0;_0xd664c0<_0x353add[_0x4ffc0e(0x160)];_0xd664c0++){if(_0x353add[_0xd664c0]['phash_compare']==0x1)continue;if(_0x353add[_0x2554f7]['id']==_0x353add[_0xd664c0]['id'])continue;try{let _0x587430=phashDist(_0x353add[_0x2554f7][_0x4ffc0e(0x17c)],_0x353add[_0xd664c0][_0x4ffc0e(0x17c)]);_0x587430<0x9&&(_0x353add[_0xd664c0][_0x4ffc0e(0x161)]=0x1,dbFileIndex[_0x4ffc0e(0x148)](_0x4ffc0e(0x158)+_0x353add[_0xd664c0]['id'])[_0x4ffc0e(0x176)](),dbFileIndex[_0x4ffc0e(0x148)]('REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)')[_0x4ffc0e(0x176)](_0x353add[_0x2554f7]['id']+'',_0x353add[_0xd664c0]['id']+'',_0x587430));}catch(_0x5567bf){console[_0x4ffc0e(0x147)](_0x5567bf);continue;}}}catch(_0x59c70a){console[_0x4ffc0e(0x147)](_0x59c70a),_0x353add[_0x2554f7][_0x4ffc0e(0x161)]=0x1,dbFileIndex[_0x4ffc0e(0x148)](_0x4ffc0e(0x158)+_0x163b34['id'])['run']();continue;}_0x353add[_0x2554f7][_0x4ffc0e(0x161)]=0x1,dbFileIndex['prepare'](_0x4ffc0e(0x158)+_0x163b34['id'])[_0x4ffc0e(0x176)]();}}catch(_0x37e4c7){console[_0x4ffc0e(0x147)](_0x37e4c7);}}let bgTaskId;try{let info=dbOther[_0x54b28e(0x148)](_0x54b28e(0x164))['run'](_0x54b28e(0x153));bgTaskId=info[_0x54b28e(0x17a)];}catch(_0x46f18f){}process['on']('uncaughtException',(_0x2de0c7,_0x133c04)=>{const _0x425352=_0x54b28e;currentDetectIndex&&dbFileIndex['prepare'](_0x425352(0x155)+currentDetectIndex['id'])[_0x425352(0x176)](),process[_0x425352(0x145)]({'type':_0x425352(0x15d)}),process[_0x425352(0x178)]();});