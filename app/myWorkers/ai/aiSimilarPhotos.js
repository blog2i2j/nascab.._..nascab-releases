const _0x4aedaa=_0xbe4b;(function(_0x1dc6d7,_0x84302b){const _0x4bcfd5=_0xbe4b,_0x4e5d7d=_0x1dc6d7();while(!![]){try{const _0xee5191=-parseInt(_0x4bcfd5(0x144))/0x1+parseInt(_0x4bcfd5(0x141))/0x2+parseInt(_0x4bcfd5(0x145))/0x3+-parseInt(_0x4bcfd5(0x15e))/0x4+-parseInt(_0x4bcfd5(0x174))/0x5+parseInt(_0x4bcfd5(0x13d))/0x6+parseInt(_0x4bcfd5(0x15b))/0x7;if(_0xee5191===_0x84302b)break;else _0x4e5d7d['push'](_0x4e5d7d['shift']());}catch(_0x3def75){_0x4e5d7d['push'](_0x4e5d7d['shift']());}}}(_0x4df5,0xe8c2e));const path=require(_0x4aedaa(0x16f)),fs=require('fs'),config=require(_0x4aedaa(0x173)),Database=require(_0x4aedaa(0x14a)),dbConfigTable=require(_0x4aedaa(0x14f)),phash=require(_0x4aedaa(0x14d)),phashDist=require(_0x4aedaa(0x167)),dbSourceFolderTable=require(_0x4aedaa(0x146)),sharpUtil=require('../../express-server/utils/sharpUtils'),exifUtils=require(_0x4aedaa(0x147));process[_0x4aedaa(0x158)]=_0x4aedaa(0x155);let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x4aedaa(0x13f)],{});dbOther[_0x4aedaa(0x168)](_0x4aedaa(0x16b)),dbFileIndex['pragma'](_0x4aedaa(0x16b)),process['on'](_0x4aedaa(0x166),()=>{const _0x2840ca=_0x4aedaa;dbOther[_0x2840ca(0x165)](),dbFileIndex[_0x2840ca(0x165)]();});const DEAL_GAP=0x7530;function _0x4df5(){const _0x37df6b=['UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','phash_compare','7209092prvOpZ','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','aiSimilarPhotoEnable','\x20AND\x20','R_OK','file_index_photo-indexing','length','close','exit','sharp-phash/distance','pragma','phash','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','journal_mode\x20=\x20WAL','all','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','access','path','findByTitle','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','log','../../myConfig/config','2875735hzCZtv','AI_PHASH','3687438xfpnSz','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','dbOther','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','3729636DSpoNG','getExcludePathWhereStr','prepare','1727528kEyrRE','1889748tzNvVt','../../db/dbSourceFolderTable','../../utils/exifUtils','toBuffer','transSpcielFormat','better-sqlite3','getRotateFromTags','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','sharp-phash','get','../../db/dbConfigTable','run','filename','deleteRawTempFile','rotate','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','NasCabDeduplicatePhotos','\x20LIMIT\x201','send','title','then','catch','13643217VmFCrF'];_0x4df5=function(){return _0x37df6b;};return _0x4df5();}let currentDetectIndex=null;function _0xbe4b(_0x28c6d9,_0x5ae46b){const _0x4df565=_0x4df5();return _0xbe4b=function(_0xbe4b26,_0x534704){_0xbe4b26=_0xbe4b26-0x13d;let _0x71e9a=_0x4df565[_0xbe4b26];return _0x71e9a;},_0xbe4b(_0x28c6d9,_0x5ae46b);}function runGenPhash(){return new Promise(async _0x3343c0=>{const _0x304ac1=_0xbe4b;let _0xfb3bfc;function _0x34f3fd(){const _0x577c8b=_0xbe4b;if(_0xfb3bfc)dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id='+_0xfb3bfc['id'])[_0x577c8b(0x150)]();return _0x3343c0();}try{let _0x27d065=dbConfigTable[_0x304ac1(0x170)](dbOther,_0x304ac1(0x163));if(_0x27d065&&_0x27d065=='1')return setTimeout(_0x3343c0,DEAL_GAP);let _0x5ecd5a=_0x304ac1(0x15f);_0x5ecd5a+=_0x304ac1(0x156),_0xfb3bfc=dbFileIndex['prepare'](_0x5ecd5a)[_0x304ac1(0x14e)]();if(!_0xfb3bfc)return exitProcess();currentDetectIndex=_0xfb3bfc;let _0x5ce22b=path['join'](_0xfb3bfc[_0x304ac1(0x16f)],_0xfb3bfc[_0x304ac1(0x151)]);try{if(bgTaskId)dbOther['prepare'](_0x304ac1(0x171)+bgTaskId)['run']();}catch(_0x246573){}fs[_0x304ac1(0x16e)](_0x5ce22b,fs['constants'][_0x304ac1(0x162)],async _0x5442c9=>{const _0x324d68=_0x304ac1;if(_0x5442c9)return console['log'](_0x5442c9),_0x34f3fd();try{sharpUtil[_0x324d68(0x149)](_0x5ce22b,(_0x21b6b2,_0x106473,_0x7481f8)=>{const _0xa06359=_0x324d68;let _0x425cb0=sharpUtil['getSharpInstanceFromInput'](_0x21b6b2),_0x3248ef=exifUtils[_0xa06359(0x14b)](_0x7481f8);_0x3248ef?_0x425cb0=_0x425cb0[_0xa06359(0x153)](_0x3248ef):_0x425cb0=_0x425cb0['rotate'](),_0x425cb0[_0xa06359(0x148)]()[_0xa06359(0x159)](_0x3afd3f=>{const _0x2bb97d=_0xa06359;phash(_0x3afd3f)['then'](_0x2e9ca8=>{const _0x539fd3=_0xbe4b;_0x106473&&sharpUtil[_0x539fd3(0x152)](_0x21b6b2),dbFileIndex[_0x539fd3(0x143)](_0x539fd3(0x15c)+_0xfb3bfc['id'])[_0x539fd3(0x150)](_0x2e9ca8),_0x3343c0();})[_0x2bb97d(0x15a)](_0x26ca66=>{const _0x4b4fe4=_0x2bb97d;return _0x106473&&sharpUtil[_0x4b4fe4(0x152)](_0x21b6b2),_0x34f3fd();});})[_0xa06359(0x15a)](_0x4ec4d1=>{return _0x34f3fd();});});}catch(_0x17b821){return _0x34f3fd();}});}catch(_0x3ee7c2){return _0x34f3fd();}});}function exitProcess(){const _0x30b68d=_0x4aedaa;runComparePhash();try{if(bgTaskId)dbOther[_0x30b68d(0x143)](_0x30b68d(0x16a)+bgTaskId)[_0x30b68d(0x150)]();}catch(_0x48a5b6){}return process[_0x30b68d(0x157)]({'type':_0x30b68d(0x165)}),process[_0x30b68d(0x166)]();}async function runGenPhashTask(){const _0x1f4d50=_0x4aedaa;let _0xe3d1a5=dbConfigTable['findByTitle'](dbOther,_0x1f4d50(0x160));_0xe3d1a5&&_0xe3d1a5['value']=='1'?runGenPhash()[_0x1f4d50(0x159)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x1f4d50(0x172)]('Similar\x20photo\x20disabled'),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x5a4079=_0x4aedaa;try{let _0x20f4dc=_0x5a4079(0x140),_0x384e7a=dbSourceFolderTable[_0x5a4079(0x142)](dbOther,_0x5a4079(0x16f),'excludePathPhoto');_0x384e7a&&(_0x20f4dc+='\x20AND\x20'+_0x384e7a);let _0x4892de=dbFileIndex[_0x5a4079(0x143)](_0x20f4dc)[_0x5a4079(0x14e)]();if(_0x4892de['count']<0x1)return;let _0x7f4310=_0x5a4079(0x13e);_0x384e7a&&(_0x7f4310+=_0x5a4079(0x161)+_0x384e7a);let _0x2c6faa=dbFileIndex[_0x5a4079(0x143)](_0x7f4310)[_0x5a4079(0x16c)]();for(let _0x50aad1=0x0;_0x50aad1<_0x2c6faa[_0x5a4079(0x164)];_0x50aad1++){let _0x18ddd7=_0x2c6faa[_0x50aad1];if(_0x18ddd7['phash_compare']==0x1)continue;try{for(let _0x474b54=0x0;_0x474b54<_0x2c6faa[_0x5a4079(0x164)];_0x474b54++){if(_0x2c6faa[_0x474b54]['phash_compare']==0x1)continue;if(_0x2c6faa[_0x50aad1]['id']==_0x2c6faa[_0x474b54]['id'])continue;try{let _0x25743f=phashDist(_0x2c6faa[_0x50aad1][_0x5a4079(0x169)],_0x2c6faa[_0x474b54][_0x5a4079(0x169)]);_0x25743f<0x9&&(_0x2c6faa[_0x474b54][_0x5a4079(0x15d)]=0x1,dbFileIndex[_0x5a4079(0x143)](_0x5a4079(0x154)+_0x2c6faa[_0x474b54]['id'])[_0x5a4079(0x150)](),dbFileIndex[_0x5a4079(0x143)](_0x5a4079(0x14c))[_0x5a4079(0x150)](_0x2c6faa[_0x50aad1]['id']+'',_0x2c6faa[_0x474b54]['id']+'',_0x25743f));}catch(_0x49bdce){console[_0x5a4079(0x172)](_0x49bdce);continue;}}}catch(_0x36adee){console[_0x5a4079(0x172)](_0x36adee),_0x2c6faa[_0x50aad1][_0x5a4079(0x15d)]=0x1,dbFileIndex['prepare'](_0x5a4079(0x154)+_0x18ddd7['id'])[_0x5a4079(0x150)]();continue;}_0x2c6faa[_0x50aad1][_0x5a4079(0x15d)]=0x1,dbFileIndex[_0x5a4079(0x143)](_0x5a4079(0x154)+_0x18ddd7['id'])[_0x5a4079(0x150)]();}}catch(_0x26ef46){console[_0x5a4079(0x172)](_0x26ef46);}}let bgTaskId;try{let info=dbOther['prepare'](_0x4aedaa(0x16d))['run'](_0x4aedaa(0x175));bgTaskId=info['lastInsertRowid'];}catch(_0x29653e){}process['on']('uncaughtException',(_0x5400ac,_0x587f6b)=>{const _0x290dad=_0x4aedaa;currentDetectIndex&&dbFileIndex[_0x290dad(0x143)]('UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id='+currentDetectIndex['id'])[_0x290dad(0x150)](),process['send']({'type':'close'}),process[_0x290dad(0x166)]();});