const _0x3f4f8e=_0x8a12;function _0x5d47(){const _0x2a1f8f=['../../myConfig/config','UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','9410hlHLoI','Similar\x20photo\x20disabled','lastInsertRowid','findByTitle','NasCabDeduplicatePhotos','../../db/dbConfigTable','path','then','940TGxLDS','AI_PHASH','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','log','access','phash','../../utils/exifUtils','\x20AND\x20','catch','exit','excludePathPhoto','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','prepare','deleteRawTempFile','count','getSharpInstanceFromInput','R_OK','uncaughtException','../../db/dbSourceFolderTable','dbOther','sharp-phash','phash_compare','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','close','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','rotate','all','105666fhYvpu','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','172392oQtVPF','send','489wBGICl','2250qwkQVG','\x20LIMIT\x201','transSpcielFormat','1167985uEyGCZ','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','better-sqlite3','859931jzsKni','journal_mode\x20=\x20WAL','run','24kdYWSU','length','dbFileIndex','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','get','pragma','join','getRotateFromTags','1960434HuwMNz','filename','constants','3672Dutjho','title','getExcludePathWhereStr','value'];_0x5d47=function(){return _0x2a1f8f;};return _0x5d47();}(function(_0x54b3ed,_0x2a4e82){const _0x315f87=_0x8a12,_0x47fd9e=_0x54b3ed();while(!![]){try{const _0x39c88c=parseInt(_0x315f87(0x169))/0x1+parseInt(_0x315f87(0x17d))/0x2*(parseInt(_0x315f87(0x162))/0x3)+-parseInt(_0x315f87(0x160))/0x4+parseInt(_0x315f87(0x163))/0x5*(parseInt(_0x315f87(0x177))/0x6)+parseInt(_0x315f87(0x166))/0x7+-parseInt(_0x315f87(0x16c))/0x8*(parseInt(_0x315f87(0x174))/0x9)+-parseInt(_0x315f87(0x141))/0xa*(parseInt(_0x315f87(0x15d))/0xb);if(_0x39c88c===_0x2a4e82)break;else _0x47fd9e['push'](_0x47fd9e['shift']());}catch(_0x330300){_0x47fd9e['push'](_0x47fd9e['shift']());}}}(_0x5d47,0x72a39));function _0x8a12(_0x1463ec,_0x456d2b){const _0x5d47cd=_0x5d47();return _0x8a12=function(_0x8a1264,_0x5f3672){_0x8a1264=_0x8a1264-0x13b;let _0x454fb1=_0x5d47cd[_0x8a1264];return _0x454fb1;},_0x8a12(_0x1463ec,_0x456d2b);}const path=require('path'),fs=require('fs'),config=require(_0x3f4f8e(0x17b)),Database=require(_0x3f4f8e(0x168)),dbConfigTable=require(_0x3f4f8e(0x13e)),phash=require(_0x3f4f8e(0x156)),phashDist=require('sharp-phash/distance'),dbSourceFolderTable=require(_0x3f4f8e(0x154)),sharpUtil=require('../../express-server/utils/sharpUtils'),exifUtils=require(_0x3f4f8e(0x147));process[_0x3f4f8e(0x178)]=_0x3f4f8e(0x13d);let dbFileIndex=new Database(config[_0x3f4f8e(0x16e)],{}),dbOther=new Database(config[_0x3f4f8e(0x155)],{});dbOther[_0x3f4f8e(0x171)](_0x3f4f8e(0x16a)),dbFileIndex['pragma'](_0x3f4f8e(0x16a)),process['on'](_0x3f4f8e(0x14a),()=>{const _0x4d307c=_0x3f4f8e;dbOther[_0x4d307c(0x159)](),dbFileIndex[_0x4d307c(0x159)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0xa89713=>{const _0x3535bb=_0x8a12;let _0x4e31fc;function _0x2856ff(){const _0x2ec701=_0x8a12;if(_0x4e31fc)dbFileIndex[_0x2ec701(0x14e)](_0x2ec701(0x15a)+_0x4e31fc['id'])[_0x2ec701(0x16b)]();return _0xa89713();}try{let _0x51bfc=dbConfigTable[_0x3535bb(0x13c)](dbOther,'file_index_photo-indexing');if(_0x51bfc&&_0x51bfc=='1')return setTimeout(_0xa89713,DEAL_GAP);let _0x14144f=_0x3535bb(0x15e);_0x14144f+=_0x3535bb(0x164),_0x4e31fc=dbFileIndex[_0x3535bb(0x14e)](_0x14144f)['get']();if(!_0x4e31fc)return exitProcess();currentDetectIndex=_0x4e31fc;let _0x26f4e1=path[_0x3535bb(0x172)](_0x4e31fc[_0x3535bb(0x13f)],_0x4e31fc[_0x3535bb(0x175)]);try{if(bgTaskId)dbOther[_0x3535bb(0x14e)](_0x3535bb(0x14d)+bgTaskId)['run']();}catch(_0x1f2fda){}fs[_0x3535bb(0x145)](_0x26f4e1,fs[_0x3535bb(0x176)][_0x3535bb(0x152)],async _0x2b8e30=>{const _0x3505d6=_0x3535bb;if(_0x2b8e30)return console['log'](_0x2b8e30),_0x2856ff();try{sharpUtil[_0x3505d6(0x165)](_0x26f4e1,(_0x232222,_0x4d015d,_0x2abc57)=>{const _0x36cca3=_0x3505d6;let _0x3443dc=sharpUtil[_0x36cca3(0x151)](_0x232222),_0x3688de=exifUtils[_0x36cca3(0x173)](_0x2abc57);_0x3688de?_0x3443dc=_0x3443dc[_0x36cca3(0x15b)](_0x3688de):_0x3443dc=_0x3443dc[_0x36cca3(0x15b)](),_0x3443dc['toBuffer']()[_0x36cca3(0x140)](_0x575829=>{const _0x38e1f7=_0x36cca3;phash(_0x575829)[_0x38e1f7(0x140)](_0x39b697=>{const _0x223517=_0x38e1f7;_0x4d015d&&sharpUtil[_0x223517(0x14f)](_0x232222),dbFileIndex[_0x223517(0x14e)](_0x223517(0x17c)+_0x4e31fc['id'])[_0x223517(0x16b)](_0x39b697),_0xa89713();})[_0x38e1f7(0x149)](_0x53a4aa=>{const _0x1614f2=_0x38e1f7;return _0x4d015d&&sharpUtil[_0x1614f2(0x14f)](_0x232222),_0x2856ff();});})[_0x36cca3(0x149)](_0x32b06e=>{return _0x2856ff();});});}catch(_0x2e341a){return _0x2856ff();}});}catch(_0x33d094){return _0x2856ff();}});}function exitProcess(){const _0x132b9c=_0x3f4f8e;runComparePhash();try{if(bgTaskId)dbOther[_0x132b9c(0x14e)](_0x132b9c(0x143)+bgTaskId)[_0x132b9c(0x16b)]();}catch(_0x576de5){}return process[_0x132b9c(0x161)]({'type':_0x132b9c(0x159)}),process[_0x132b9c(0x14a)]();}async function runGenPhashTask(){const _0x5399f4=_0x3f4f8e;let _0x2d7095=dbConfigTable[_0x5399f4(0x13c)](dbOther,'aiSimilarPhotoEnable');_0x2d7095&&_0x2d7095[_0x5399f4(0x17a)]=='1'?runGenPhash()[_0x5399f4(0x140)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console[_0x5399f4(0x144)](_0x5399f4(0x17e)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x182b70=_0x3f4f8e;try{let _0x6eba2c=_0x182b70(0x14c),_0x2b044c=dbSourceFolderTable[_0x182b70(0x179)](dbOther,_0x182b70(0x13f),_0x182b70(0x14b));_0x2b044c&&(_0x6eba2c+=_0x182b70(0x148)+_0x2b044c);let _0x1978e9=dbFileIndex[_0x182b70(0x14e)](_0x6eba2c)[_0x182b70(0x170)]();if(_0x1978e9[_0x182b70(0x150)]<0x1)return;let _0x4d2af1=_0x182b70(0x15f);_0x2b044c&&(_0x4d2af1+=_0x182b70(0x148)+_0x2b044c);let _0x57d270=dbFileIndex[_0x182b70(0x14e)](_0x4d2af1)[_0x182b70(0x15c)]();for(let _0x58fe40=0x0;_0x58fe40<_0x57d270[_0x182b70(0x16d)];_0x58fe40++){let _0x144504=_0x57d270[_0x58fe40];if(_0x144504['phash_compare']==0x1)continue;try{for(let _0x5cdbc2=0x0;_0x5cdbc2<_0x57d270[_0x182b70(0x16d)];_0x5cdbc2++){if(_0x57d270[_0x5cdbc2][_0x182b70(0x157)]==0x1)continue;if(_0x57d270[_0x58fe40]['id']==_0x57d270[_0x5cdbc2]['id'])continue;try{let _0x26b4b6=phashDist(_0x57d270[_0x58fe40][_0x182b70(0x146)],_0x57d270[_0x5cdbc2]['phash']);_0x26b4b6<0x9&&(_0x57d270[_0x5cdbc2][_0x182b70(0x157)]=0x1,dbFileIndex['prepare'](_0x182b70(0x167)+_0x57d270[_0x5cdbc2]['id'])['run'](),dbFileIndex[_0x182b70(0x14e)]('REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)')[_0x182b70(0x16b)](_0x57d270[_0x58fe40]['id']+'',_0x57d270[_0x5cdbc2]['id']+'',_0x26b4b6));}catch(_0x7390da){console['log'](_0x7390da);continue;}}}catch(_0x5700e4){console[_0x182b70(0x144)](_0x5700e4),_0x57d270[_0x58fe40]['phash_compare']=0x1,dbFileIndex[_0x182b70(0x14e)](_0x182b70(0x167)+_0x144504['id'])[_0x182b70(0x16b)]();continue;}_0x57d270[_0x58fe40][_0x182b70(0x157)]=0x1,dbFileIndex[_0x182b70(0x14e)]('UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id='+_0x144504['id'])[_0x182b70(0x16b)]();}}catch(_0x1917dd){console[_0x182b70(0x144)](_0x1917dd);}}let bgTaskId;try{let info=dbOther['prepare'](_0x3f4f8e(0x16f))[_0x3f4f8e(0x16b)](_0x3f4f8e(0x142));bgTaskId=info[_0x3f4f8e(0x13b)];}catch(_0x4588ec){}process['on'](_0x3f4f8e(0x153),(_0x391046,_0x522c10)=>{const _0xde69ec=_0x3f4f8e;currentDetectIndex&&dbFileIndex['prepare'](_0xde69ec(0x158)+currentDetectIndex['id'])[_0xde69ec(0x16b)](),process[_0xde69ec(0x161)]({'type':_0xde69ec(0x159)}),process[_0xde69ec(0x14a)]();});