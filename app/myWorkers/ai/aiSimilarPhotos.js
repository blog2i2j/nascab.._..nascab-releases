const _0x2fb18d=_0x3f42;(function(_0x3f241c,_0x134d63){const _0x3f39b2=_0x3f42,_0x56abea=_0x3f241c();while(!![]){try{const _0xbce76b=-parseInt(_0x3f39b2(0x113))/0x1*(parseInt(_0x3f39b2(0x11a))/0x2)+parseInt(_0x3f39b2(0xed))/0x3*(parseInt(_0x3f39b2(0xf8))/0x4)+-parseInt(_0x3f39b2(0xee))/0x5*(-parseInt(_0x3f39b2(0x10b))/0x6)+-parseInt(_0x3f39b2(0x111))/0x7*(parseInt(_0x3f39b2(0x104))/0x8)+parseInt(_0x3f39b2(0x100))/0x9*(-parseInt(_0x3f39b2(0xf0))/0xa)+-parseInt(_0x3f39b2(0xdd))/0xb*(parseInt(_0x3f39b2(0xff))/0xc)+-parseInt(_0x3f39b2(0xe4))/0xd*(-parseInt(_0x3f39b2(0xf2))/0xe);if(_0xbce76b===_0x134d63)break;else _0x56abea['push'](_0x56abea['shift']());}catch(_0x1b2242){_0x56abea['push'](_0x56abea['shift']());}}}(_0x42d7,0xcb9d3));const path=require(_0x2fb18d(0x10c)),fs=require('fs'),config=require('../../myConfig/config'),Database=require(_0x2fb18d(0xf6)),dbConfigTable=require(_0x2fb18d(0x105)),phash=require(_0x2fb18d(0x112)),phashDist=require(_0x2fb18d(0xe7)),dbSourceFolderTable=require(_0x2fb18d(0x11e)),sharpUtil=require(_0x2fb18d(0x120)),exifUtils=require('../../utils/exifUtils');process[_0x2fb18d(0x110)]=_0x2fb18d(0x106);let dbFileIndex=new Database(config[_0x2fb18d(0xf7)],{}),dbOther=new Database(config[_0x2fb18d(0xe0)],{});function _0x42d7(){const _0x3f2b73=['UPDATE\x20file_index_photo\x20SET\x20phash=?\x20where\x20id=','UPDATE\x20file_index_photo\x20SET\x20phash=0,phash_compare=1\x20where\x20id=','2450283JontvZ','deleteRawTempFile','SELECT\x20id,phash,phash_compare\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20in_trash=0\x20\x20and\x20phash_compare\x20=0\x20','dbOther','Similar\x20photo\x20disabled','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','get','1274qhCabP','phash_compare','AI_PHASH','sharp-phash/distance','constants','\x20LIMIT\x201','rotate','catch','prepare','783051OQNwHI','1595680bZdTWj','run','5679810uUhCxT','length','474236NIYBIG','count','lastInsertRowid','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','better-sqlite3','dbFileIndex','4aSTHTu','file_index_photo-indexing','all','journal_mode\x20=\x20WAL','log','aiSimilarPhotoEnable','phash','84yzFLqA','9imMuwJ','SELECT\x20count(*)\x20as\x20count\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20not\x20null\x20and\x20phash\x20!=0\x20and\x20phash_compare\x20=0\x20and\x20in_trash=0','getSharpInstanceFromInput','transSpcielFormat','336264giVFZk','../../db/dbConfigTable','NasCabDeduplicatePhotos','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20type=1\x20and\x20phash\x20is\x20null\x20and\x20is_raw!=1','send','uncaughtException','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','6YhVBZH','path','pragma','REPLACE\x20INTO\x20photo_phash_similar(index_id,similar_index_id,distance)\x20VALUES(?,?,?)','UPDATE\x20file_index_photo\x20SET\x20phash=0\x20where\x20id=','title','21ZvtKBv','sharp-phash','107oyrDmm','UPDATE\x20file_index_photo\x20SET\x20phash_compare=1\x20where\x20id=','access','value','close','exit','getRotateFromTags','15186ITlVfd','filename','getExcludePathWhereStr','join','../../db/dbSourceFolderTable','then','../../express-server/utils/sharpUtils','\x20AND\x20'];_0x42d7=function(){return _0x3f2b73;};return _0x42d7();}dbOther['pragma'](_0x2fb18d(0xfb)),dbFileIndex[_0x2fb18d(0x10d)](_0x2fb18d(0xfb)),process['on'](_0x2fb18d(0x118),()=>{const _0x107bcb=_0x2fb18d;dbOther[_0x107bcb(0x117)](),dbFileIndex[_0x107bcb(0x117)]();});const DEAL_GAP=0x7530;let currentDetectIndex=null;function runGenPhash(){return new Promise(async _0x4d93ec=>{const _0x3cf21b=_0x3f42;let _0x5a0509;function _0x4b56ec(){const _0x35029e=_0x3f42;if(_0x5a0509)dbFileIndex['prepare'](_0x35029e(0x10f)+_0x5a0509['id'])[_0x35029e(0xef)]();return _0x4d93ec();}try{let _0x14ca22=dbConfigTable['findByTitle'](dbOther,_0x3cf21b(0xf9));if(_0x14ca22&&_0x14ca22=='1')return setTimeout(_0x4d93ec,DEAL_GAP);let _0x26e206=_0x3cf21b(0x107);_0x26e206+=_0x3cf21b(0xe9),_0x5a0509=dbFileIndex['prepare'](_0x26e206)[_0x3cf21b(0xe3)]();if(!_0x5a0509)return exitProcess();currentDetectIndex=_0x5a0509;let _0x3326e8=path[_0x3cf21b(0x11d)](_0x5a0509[_0x3cf21b(0x10c)],_0x5a0509[_0x3cf21b(0x11b)]);try{if(bgTaskId)dbOther[_0x3cf21b(0xec)](_0x3cf21b(0x10a)+bgTaskId)[_0x3cf21b(0xef)]();}catch(_0x37c177){}fs[_0x3cf21b(0x115)](_0x3326e8,fs[_0x3cf21b(0xe8)]['R_OK'],async _0x43fc0c=>{const _0x1a3149=_0x3cf21b;if(_0x43fc0c)return console[_0x1a3149(0xfc)](_0x43fc0c),_0x4b56ec();try{sharpUtil[_0x1a3149(0x103)](_0x3326e8,(_0xe7df96,_0x2cdd3e,_0x1ca854)=>{const _0x446f05=_0x1a3149;let _0xa4f4b4=sharpUtil[_0x446f05(0x102)](_0xe7df96),_0x487645=exifUtils[_0x446f05(0x119)](_0x1ca854);_0x487645?_0xa4f4b4=_0xa4f4b4['rotate'](_0x487645):_0xa4f4b4=_0xa4f4b4[_0x446f05(0xea)](),_0xa4f4b4['toBuffer']()[_0x446f05(0x11f)](_0x236879=>{const _0x919918=_0x446f05;phash(_0x236879)[_0x919918(0x11f)](_0x3fd6ab=>{const _0x422cbe=_0x919918;_0x2cdd3e&&sharpUtil[_0x422cbe(0xde)](_0xe7df96),dbFileIndex[_0x422cbe(0xec)](_0x422cbe(0xdb)+_0x5a0509['id'])[_0x422cbe(0xef)](_0x3fd6ab),_0x4d93ec();})[_0x919918(0xeb)](_0x2194f6=>{const _0x202aa4=_0x919918;return _0x2cdd3e&&sharpUtil[_0x202aa4(0xde)](_0xe7df96),_0x4b56ec();});})[_0x446f05(0xeb)](_0x151e47=>{return _0x4b56ec();});});}catch(_0x5613b8){return _0x4b56ec();}});}catch(_0x52845b){return _0x4b56ec();}});}function exitProcess(){const _0x2cc2c5=_0x2fb18d;runComparePhash();try{if(bgTaskId)dbOther[_0x2cc2c5(0xec)](_0x2cc2c5(0xf5)+bgTaskId)[_0x2cc2c5(0xef)]();}catch(_0x2ec0bd){}return process[_0x2cc2c5(0x108)]({'type':_0x2cc2c5(0x117)}),process[_0x2cc2c5(0x118)]();}async function runGenPhashTask(){const _0x2113f6=_0x2fb18d;let _0x5597f9=dbConfigTable['findByTitle'](dbOther,_0x2113f6(0xfd));_0x5597f9&&_0x5597f9[_0x2113f6(0x116)]=='1'?runGenPhash()[_0x2113f6(0x11f)](()=>{setTimeout(()=>{runGenPhashTask();},0x12c);}):(console['log'](_0x2113f6(0xe1)),exitProcess());}runGenPhashTask();function runComparePhash(){const _0x3dbe17=_0x2fb18d;try{let _0x156671=_0x3dbe17(0x101),_0x2366c6=dbSourceFolderTable[_0x3dbe17(0x11c)](dbOther,_0x3dbe17(0x10c),'excludePathPhoto');_0x2366c6&&(_0x156671+=_0x3dbe17(0xda)+_0x2366c6);let _0x3524d1=dbFileIndex[_0x3dbe17(0xec)](_0x156671)[_0x3dbe17(0xe3)]();if(_0x3524d1[_0x3dbe17(0xf3)]<0x1)return;let _0x3cacb0=_0x3dbe17(0xdf);_0x2366c6&&(_0x3cacb0+=_0x3dbe17(0xda)+_0x2366c6);let _0x22d494=dbFileIndex['prepare'](_0x3cacb0)[_0x3dbe17(0xfa)]();for(let _0xdb84c0=0x0;_0xdb84c0<_0x22d494[_0x3dbe17(0xf1)];_0xdb84c0++){let _0x65cbdc=_0x22d494[_0xdb84c0];if(_0x65cbdc[_0x3dbe17(0xe5)]==0x1)continue;try{for(let _0x507b61=0x0;_0x507b61<_0x22d494['length'];_0x507b61++){if(_0x22d494[_0x507b61][_0x3dbe17(0xe5)]==0x1)continue;if(_0x22d494[_0xdb84c0]['id']==_0x22d494[_0x507b61]['id'])continue;try{let _0x2827a5=phashDist(_0x22d494[_0xdb84c0]['phash'],_0x22d494[_0x507b61][_0x3dbe17(0xfe)]);_0x2827a5<0x9&&(_0x22d494[_0x507b61][_0x3dbe17(0xe5)]=0x1,dbFileIndex[_0x3dbe17(0xec)](_0x3dbe17(0x114)+_0x22d494[_0x507b61]['id'])[_0x3dbe17(0xef)](),dbFileIndex[_0x3dbe17(0xec)](_0x3dbe17(0x10e))[_0x3dbe17(0xef)](_0x22d494[_0xdb84c0]['id']+'',_0x22d494[_0x507b61]['id']+'',_0x2827a5));}catch(_0x29f515){console[_0x3dbe17(0xfc)](_0x29f515);continue;}}}catch(_0x58bb6c){console['log'](_0x58bb6c),_0x22d494[_0xdb84c0][_0x3dbe17(0xe5)]=0x1,dbFileIndex[_0x3dbe17(0xec)](_0x3dbe17(0x114)+_0x65cbdc['id'])[_0x3dbe17(0xef)]();continue;}_0x22d494[_0xdb84c0][_0x3dbe17(0xe5)]=0x1,dbFileIndex[_0x3dbe17(0xec)](_0x3dbe17(0x114)+_0x65cbdc['id'])[_0x3dbe17(0xef)]();}}catch(_0x5e0408){console[_0x3dbe17(0xfc)](_0x5e0408);}}let bgTaskId;try{let info=dbOther[_0x2fb18d(0xec)](_0x2fb18d(0xe2))[_0x2fb18d(0xef)](_0x2fb18d(0xe6));bgTaskId=info[_0x2fb18d(0xf4)];}catch(_0xdb5e29){}function _0x3f42(_0x45ba3c,_0x378b3e){const _0x42d728=_0x42d7();return _0x3f42=function(_0x3f4263,_0x596699){_0x3f4263=_0x3f4263-0xda;let _0xb4f09b=_0x42d728[_0x3f4263];return _0xb4f09b;},_0x3f42(_0x45ba3c,_0x378b3e);}process['on'](_0x2fb18d(0x109),(_0x285618,_0x5177c8)=>{const _0x3435bb=_0x2fb18d;currentDetectIndex&&dbFileIndex[_0x3435bb(0xec)](_0x3435bb(0xdc)+currentDetectIndex['id'])[_0x3435bb(0xef)](),process['send']({'type':_0x3435bb(0x117)}),process['exit']();});