const _0x1335b0=_0x2671;(function(_0xf498f9,_0x57b6bd){const _0x5add8f=_0x2671,_0x3ba59e=_0xf498f9();while(!![]){try{const _0x167191=parseInt(_0x5add8f(0x116))/0x1+-parseInt(_0x5add8f(0x124))/0x2+-parseInt(_0x5add8f(0x14f))/0x3*(-parseInt(_0x5add8f(0x135))/0x4)+parseInt(_0x5add8f(0x12b))/0x5*(-parseInt(_0x5add8f(0x14b))/0x6)+-parseInt(_0x5add8f(0x132))/0x7*(-parseInt(_0x5add8f(0x13d))/0x8)+parseInt(_0x5add8f(0x12f))/0x9+-parseInt(_0x5add8f(0x14e))/0xa*(parseInt(_0x5add8f(0x159))/0xb);if(_0x167191===_0x57b6bd)break;else _0x3ba59e['push'](_0x3ba59e['shift']());}catch(_0x14ea7e){_0x3ba59e['push'](_0x3ba59e['shift']());}}}(_0x5296,0x84ec9));const tfjs=require(_0x1335b0(0x15f)),wasm=require(_0x1335b0(0x158)),fileSys=require(_0x1335b0(0x128)),cocoSsd=require('@tensorflow-models/coco-ssd'),Database=require(_0x1335b0(0x109)),config=require(_0x1335b0(0x115)),dbConfigTable=require(_0x1335b0(0x134)),sharpUtil=require(_0x1335b0(0x142));let dbFileIndex=new Database(config[_0x1335b0(0x122)],{}),dbOther=new Database(config['dbOther'],{});process['title']=_0x1335b0(0x155),dbOther['pragma'](_0x1335b0(0x120)),dbFileIndex['pragma'](_0x1335b0(0x120));const exifUtils=require('../../utils/exifUtils');process['on'](_0x1335b0(0x111),()=>{const _0x7e6aa0=_0x1335b0;dbOther['close'](),dbFileIndex[_0x7e6aa0(0x13a)]();});const fs=require('fs');let path=require('path');const https=require('https');let cocoSsdModel=null,modelSavePath=path['join'](config[_0x1335b0(0x118)],'tfModel','ssd_mobilenet_v2_1_default_1');!fs[_0x1335b0(0x123)](modelSavePath)&&fs[_0x1335b0(0x14d)](modelSavePath,{'recursive':!![]});function _0x5296(){const _0x11d729=['tiny_path','coco_ssd','detect','catch','value','journal_mode\x20=\x20WAL','renameSync','dbFileIndex','existsSync','584126NLEtnc','join','bbox','group1-shard4of17','./utils/file_system','filename','deleteRawTempFile','10nHsSNU','rotate','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','group1-shard10of17','6639912sXXnRK','endScope','jpeg','14SkEfBv','height','../../db/dbConfigTable','16FVwahX','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','tmp_','大于30mb的图像不处理','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','close','group1-shard7of17','path','2794328MepgWq','group1-shard8of17','createWriteStream','group1-shard14of17','length','../../express-server/utils/sharpUtils','resize','message','prepare','tensor','run','transSpcielFormat','group1-shard2of17','then','660774IGgAXV','group1-shard1of17','mkdirSync','10UZfDJQ','564552kYcVRl','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','getRotateFromTags','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','group1-shard16of17','model.json','NasCabAiClassify','group1-shard12of17','getTime','@tensorflow/tfjs-backend-wasm','16822597ToIavp','pipe','startScope','error','raw','group1-shard15of17','@tensorflow/tfjs','toBuffer','engine','weights_manifest.json','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','group1-shard6of17','group1-shard11of17','push','load','better-sqlite3','lastInsertRowid','ready','aiClassesEnable','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','get','class','NodeFileSystem','exit','findByTitle','send','width','../../myConfig/config','397019KxTsAy','dispose','userDataFolder','log','score'];_0x5296=function(){return _0x11d729;};return _0x5296();}let modelBaseUrl='https://down.nascab.cn/tfModel/ssd_mobilenet_v2_1_default_1/',modelFileUrlList=[],modelFileList=['group1-shard9of17',_0x1335b0(0x12e),_0x1335b0(0x165),_0x1335b0(0x156),'group1-shard13of17',_0x1335b0(0x140),_0x1335b0(0x15e),_0x1335b0(0x153),'group1-shard17of17',_0x1335b0(0x154),'tensorflowjs_model.pb',_0x1335b0(0x162),_0x1335b0(0x14c),_0x1335b0(0x149),'group1-shard3of17',_0x1335b0(0x127),'group1-shard5of17',_0x1335b0(0x164),_0x1335b0(0x13b),_0x1335b0(0x13e)];for(let i=0x0;i<modelFileList[_0x1335b0(0x141)];i++){modelFileUrlList[_0x1335b0(0x166)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x309b08,_0x26ab4d,_0x2346e2){return new Promise((_0x2c7496,_0x2a85d2)=>{const _0x4614f2=_0x2671;https[_0x4614f2(0x10e)](_0x309b08,_0x158f63=>{const _0x36ca9d=_0x4614f2,_0x1355f0=fs[_0x36ca9d(0x13f)](_0x26ab4d);_0x158f63[_0x36ca9d(0x15a)](_0x1355f0),_0x1355f0['on']('finish',()=>{const _0xa6d5=_0x36ca9d;_0x1355f0[_0xa6d5(0x13a)](),fs[_0xa6d5(0x121)](_0x26ab4d,_0x2346e2),_0x2c7496();})['on']('error',_0x19fa7b=>{const _0x117829=_0x36ca9d;console[_0x117829(0x119)](_0x19fa7b);});})['on'](_0x4614f2(0x15c),_0x49d006=>{const _0x557bc7=_0x4614f2;_0x2a85d2(_0x49d006[_0x557bc7(0x144)]);});});}function downloadModelFile(){return new Promise(async(_0x11c241,_0x1b30db)=>{const _0x3edb59=_0x2671;try{for(let _0x5bbcf8=0x0;_0x5bbcf8<modelFileList['length'];_0x5bbcf8++){let _0x5bc07f=path['join'](modelSavePath,modelFileList[_0x5bbcf8]),_0x3ff3e3=path[_0x3edb59(0x125)](modelSavePath,_0x3edb59(0x137)+modelFileList[_0x5bbcf8]);if(!fs[_0x3edb59(0x123)](_0x5bc07f)){let _0x51e3e3=modelFileUrlList[_0x5bbcf8];await httpDownload(_0x51e3e3,_0x3ff3e3,_0x5bc07f);}else{}}_0x11c241();}catch(_0x36600d){_0x1b30db(_0x36600d);}});}async function loadModel(){return new Promise(async(_0xc26c8d,_0x359bc6)=>{const _0x3e9b13=_0x2671;try{if(!cocoSsdModel){await tfjs['setBackend']('wasm'),await tfjs[_0x3e9b13(0x10b)](),await downloadModelFile();let _0x45ddaf=path['join'](modelSavePath,_0x3e9b13(0x154)),_0x59bdf2=new fileSys[(_0x3e9b13(0x110))](_0x45ddaf);cocoSsdModel=await cocoSsd[_0x3e9b13(0x108)]({'modelUrl':_0x59bdf2});let _0x5ee7d9=new Date()[_0x3e9b13(0x157)]();_0xc26c8d();}else _0xc26c8d();}catch(_0x16c082){console[_0x3e9b13(0x119)](_0x16c082),_0x359bc6(_0x16c082);}});}function _0x2671(_0x584871,_0x55ccd2){const _0x5296cd=_0x5296();return _0x2671=function(_0x267184,_0x290f5c){_0x267184=_0x267184-0x108;let _0x2e61d8=_0x5296cd[_0x267184];return _0x2e61d8;},_0x2671(_0x584871,_0x55ccd2);}function exitProcess(){const _0x5efbe2=_0x1335b0;try{bgTaskId&&dbOther[_0x5efbe2(0x145)](_0x5efbe2(0x136)+bgTaskId)['run']();}catch(_0x1cd583){}return process[_0x5efbe2(0x113)]({'type':_0x5efbe2(0x13a)}),process[_0x5efbe2(0x111)]();}function runInfinitCoCoSsd(){return new Promise(async _0x595795=>{const _0x1145ad=_0x2671;let _0xf65c09=0x32*0x400;dbFileIndex[_0x1145ad(0x145)](_0x1145ad(0x12d)+_0xf65c09)['run']();let _0x1d60ca=dbFileIndex['prepare'](_0x1145ad(0x10d)+_0xf65c09+_0x1145ad(0x139))[_0x1145ad(0x10e)]();if(!_0x1d60ca)return exitProcess();try{bgTaskId&&dbOther[_0x1145ad(0x145)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0x1145ad(0x147)]();}catch(_0x379dca){}await loadModel();function _0x3a6776(){const _0x3212a7=_0x1145ad;dbFileIndex[_0x3212a7(0x145)]('UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id='+_0x1d60ca['id'])['run'](),_0x595795();}let _0x3aee7a=path[_0x1145ad(0x125)](_0x1d60ca[_0x1145ad(0x13c)],_0x1d60ca[_0x1145ad(0x129)]);parseInt(_0x1d60ca['type'])==0x2&&(_0x3aee7a=path['join'](_0x1d60ca[_0x1145ad(0x11b)])),fs['stat'](_0x3aee7a,async(_0xd48d50,_0x5c7eea)=>{const _0x54654f=_0x1145ad;if(_0xd48d50||_0x5c7eea['size']>0x400*0x400*0x3c)return console[_0x54654f(0x119)](_0x54654f(0x138)),_0x3a6776();sharpUtil[_0x54654f(0x148)](_0x3aee7a,(_0x379dac,_0x2c623b,_0x499c2c)=>{const _0x360a37=_0x54654f;let _0x48261d=sharpUtil['getSharpInstanceFromInput'](_0x379dac),_0x34de65=exifUtils[_0x360a37(0x151)](_0x499c2c);_0x34de65?_0x48261d=_0x48261d[_0x360a37(0x12c)](_0x34de65):_0x48261d=_0x48261d[_0x360a37(0x12c)](),_0x48261d[_0x360a37(0x143)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x360a37(0x131)]()[_0x360a37(0x15d)]()[_0x360a37(0x160)]((_0x42febc,_0x51f3f1,_0x1dc3fe)=>{const _0x526dc9=_0x360a37;_0x2c623b&&sharpUtil[_0x526dc9(0x12a)](_0x379dac);if(_0x42febc)return _0x3a6776();tfjs['engine']()[_0x526dc9(0x15b)](),temp=tfjs[_0x526dc9(0x146)](_0x51f3f1,[_0x1dc3fe[_0x526dc9(0x133)],_0x1dc3fe[_0x526dc9(0x114)],_0x1dc3fe['channels']]),tensor=tfjs['slice'](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x526dc9(0x117)](temp),_0x51f3f1=null,cocoSsdModel[_0x526dc9(0x11d)](tensor)[_0x526dc9(0x14a)](_0x14a4da=>{const _0x529b9e=_0x526dc9;tfjs[_0x529b9e(0x117)](tensor),tfjs[_0x529b9e(0x161)]()[_0x529b9e(0x130)]();for(let _0x4e8341=0x0;_0x4e8341<_0x14a4da['length'];_0x4e8341++){let _0x10e6a6=_0x529b9e(0x11c),_0x2a984c=_0x14a4da[_0x4e8341],_0x404331=_0x2a984c[_0x529b9e(0x126)];for(let _0x39aaa9 in _0x404331){if(_0x404331[_0x39aaa9]<0x0)_0x404331[_0x39aaa9]=0x0;}if(_0x404331[0x3]*_0x404331[0x4]<0x4e20)continue;let _0x283219='',_0x2511dc=dbFileIndex[_0x529b9e(0x145)](_0x529b9e(0x163))[_0x529b9e(0x10e)](_0x2a984c['class'],_0x10e6a6);if(_0x2511dc)_0x283219=_0x2511dc['id'];else{let _0x2c1a29=dbFileIndex[_0x529b9e(0x145)]('REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)')['run'](_0x2a984c[_0x529b9e(0x10f)],_0x10e6a6);_0x283219=_0x2c1a29[_0x529b9e(0x10a)];}dbFileIndex[_0x529b9e(0x145)](_0x529b9e(0x152))['run'](_0x1d60ca['id'],_0x283219,_0x10e6a6,JSON['stringify'](_0x2a984c[_0x529b9e(0x126)]),_0x2a984c[_0x529b9e(0x11a)]);}_0x3a6776();})[_0x526dc9(0x11e)](_0xf69d30=>{const _0x5523d6=_0x526dc9;_0x2c623b&&sharpUtil[_0x5523d6(0x12a)](_0x379dac),tfjs[_0x5523d6(0x117)](tensor),tfjs['engine']()['endScope'](),_0x3a6776();});});});});});}let bgTaskId;try{let info=dbOther['prepare'](_0x1335b0(0x150))[_0x1335b0(0x147)]('AI_CLASSES');bgTaskId=info[_0x1335b0(0x10a)];}catch(_0x38c80f){}async function runCoCoSsd(){const _0x2158c3=_0x1335b0;let _0x58f381=dbConfigTable[_0x2158c3(0x112)](dbOther,_0x2158c3(0x10c));_0x58f381&&_0x58f381[_0x2158c3(0x11f)]=='1'?runInfinitCoCoSsd()[_0x2158c3(0x14a)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();