const _0x144b2a=_0x2cc2;(function(_0x1380b8,_0x10631b){const _0x30ce68=_0x2cc2,_0x57fdc6=_0x1380b8();while(!![]){try{const _0x39b809=parseInt(_0x30ce68(0x188))/0x1*(-parseInt(_0x30ce68(0x184))/0x2)+parseInt(_0x30ce68(0x137))/0x3*(parseInt(_0x30ce68(0x13b))/0x4)+parseInt(_0x30ce68(0x178))/0x5+-parseInt(_0x30ce68(0x173))/0x6*(-parseInt(_0x30ce68(0x17e))/0x7)+-parseInt(_0x30ce68(0x138))/0x8*(parseInt(_0x30ce68(0x166))/0x9)+parseInt(_0x30ce68(0x186))/0xa*(parseInt(_0x30ce68(0x17a))/0xb)+-parseInt(_0x30ce68(0x13a))/0xc;if(_0x39b809===_0x10631b)break;else _0x57fdc6['push'](_0x57fdc6['shift']());}catch(_0x33ac40){_0x57fdc6['push'](_0x57fdc6['shift']());}}}(_0x14fe,0xe7cd4));function _0x14fe(){const _0x188c2d=['existsSync','5748UjjLAM','findByTitle','group1-shard13of17','https','better-sqlite3','6228515eTRTMu','group1-shard2of17','796873UpWBcK','prepare','../../express-server/utils/sharpUtils','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','8547jsVvfl','pipe','dispose','ssd_mobilenet_v2_1_default_1','error','dbFileIndex','350824cUDRlC','group1-shard14of17','150lEPYQS','title','2SnTaOw','raw','deleteRawTempFile','join','rotate','slice','lastInsertRowid','push','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','ready','detect','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','endScope','366033xGvnzU','32xwEPOA','engine','14928756HMQzmB','12wTPHGv','大于30mb的图像不处理','log','then','model.json','run','channels','width','weights_manifest.json','group1-shard1of17','group1-shard9of17','size','@tensorflow/tfjs-backend-wasm','jpeg','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','exit','tiny_path','group1-shard15of17','group1-shard7of17','score','bbox','./utils/file_system','startScope','transSpcielFormat','group1-shard16of17','tmp_','value','message','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','pragma','@tensorflow/tfjs','height','journal_mode\x20=\x20WAL','dbOther','class','path','close','group1-shard12of17','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','length','stringify','resize','type','2978442LyUBlO','AI_CLASSES','get','load','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','getRotateFromTags','group1-shard6of17','group1-shard8of17','group1-shard10of17','coco_ssd','group1-shard3of17','../../myConfig/config'];_0x14fe=function(){return _0x188c2d;};return _0x14fe();}const tfjs=require(_0x144b2a(0x159)),wasm=require(_0x144b2a(0x147)),fileSys=require(_0x144b2a(0x150)),cocoSsd=require('@tensorflow-models/coco-ssd'),Database=require(_0x144b2a(0x177)),config=require(_0x144b2a(0x171)),dbConfigTable=require('../../db/dbConfigTable'),sharpUtil=require(_0x144b2a(0x17c));let dbFileIndex=new Database(config[_0x144b2a(0x183)],{}),dbOther=new Database(config[_0x144b2a(0x15c)],{});process[_0x144b2a(0x187)]='NasCabAiClassify',dbOther['pragma']('journal_mode\x20=\x20WAL'),dbFileIndex[_0x144b2a(0x158)](_0x144b2a(0x15b));function _0x2cc2(_0x5028e2,_0x3cf939){const _0x14fe7b=_0x14fe();return _0x2cc2=function(_0x2cc2b1,_0x175e4d){_0x2cc2b1=_0x2cc2b1-0x12e;let _0x371247=_0x14fe7b[_0x2cc2b1];return _0x371247;},_0x2cc2(_0x5028e2,_0x3cf939);}const exifUtils=require('../../utils/exifUtils');process['on'](_0x144b2a(0x14a),()=>{const _0x5c26c1=_0x144b2a;dbOther['close'](),dbFileIndex[_0x5c26c1(0x15f)]();});const fs=require('fs');let path=require(_0x144b2a(0x15e));const https=require(_0x144b2a(0x176));let cocoSsdModel=null,modelSavePath=path[_0x144b2a(0x18b)](config['userDataFolder'],'tfModel',_0x144b2a(0x181));!fs[_0x144b2a(0x172)](modelSavePath)&&fs['mkdirSync'](modelSavePath,{'recursive':!![]});let modelBaseUrl='https://down.nascab.cn/tfModel/ssd_mobilenet_v2_1_default_1/',modelFileUrlList=[],modelFileList=[_0x144b2a(0x145),_0x144b2a(0x16e),'group1-shard11of17',_0x144b2a(0x160),_0x144b2a(0x175),_0x144b2a(0x185),_0x144b2a(0x14c),_0x144b2a(0x153),'group1-shard17of17',_0x144b2a(0x13f),'tensorflowjs_model.pb',_0x144b2a(0x143),_0x144b2a(0x144),_0x144b2a(0x179),_0x144b2a(0x170),'group1-shard4of17','group1-shard5of17',_0x144b2a(0x16c),_0x144b2a(0x14d),_0x144b2a(0x16d)];for(let i=0x0;i<modelFileList['length'];i++){modelFileUrlList[_0x144b2a(0x131)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x179842,_0x5548b4,_0x2a57b3){return new Promise((_0x12c940,_0x3edec9)=>{const _0x2c3551=_0x2cc2;https[_0x2c3551(0x168)](_0x179842,_0x3d1ffc=>{const _0x16eff7=_0x2c3551,_0x453dce=fs['createWriteStream'](_0x5548b4);_0x3d1ffc[_0x16eff7(0x17f)](_0x453dce),_0x453dce['on']('finish',()=>{const _0x784ba6=_0x16eff7;_0x453dce[_0x784ba6(0x15f)](),fs['renameSync'](_0x5548b4,_0x2a57b3),_0x12c940();})['on'](_0x16eff7(0x182),_0x9e5159=>{const _0x337efe=_0x16eff7;console[_0x337efe(0x13d)](_0x9e5159);});})['on'](_0x2c3551(0x182),_0x19758f=>{const _0x488133=_0x2c3551;_0x3edec9(_0x19758f[_0x488133(0x156)]);});});}function downloadModelFile(){return new Promise(async(_0x5071c2,_0x2ac46d)=>{const _0x450fa8=_0x2cc2;try{for(let _0x57f73e=0x0;_0x57f73e<modelFileList[_0x450fa8(0x162)];_0x57f73e++){let _0x3be68c=path[_0x450fa8(0x18b)](modelSavePath,modelFileList[_0x57f73e]),_0x31e194=path['join'](modelSavePath,_0x450fa8(0x154)+modelFileList[_0x57f73e]);if(!fs[_0x450fa8(0x172)](_0x3be68c)){let _0x59ed58=modelFileUrlList[_0x57f73e];await httpDownload(_0x59ed58,_0x31e194,_0x3be68c);}else{}}_0x5071c2();}catch(_0x5a72cd){_0x2ac46d(_0x5a72cd);}});}async function loadModel(){return new Promise(async(_0x24d8ac,_0x58c7ca)=>{const _0x3604c3=_0x2cc2;try{if(!cocoSsdModel){await tfjs['setBackend']('wasm'),await tfjs[_0x3604c3(0x133)](),await downloadModelFile();let _0x2522d0=path[_0x3604c3(0x18b)](modelSavePath,_0x3604c3(0x13f)),_0x5ae566=new fileSys['NodeFileSystem'](_0x2522d0);cocoSsdModel=await cocoSsd[_0x3604c3(0x169)]({'modelUrl':_0x5ae566});let _0x2edb38=new Date()['getTime']();_0x24d8ac();}else _0x24d8ac();}catch(_0x1c7f8c){console[_0x3604c3(0x13d)](_0x1c7f8c),_0x58c7ca(_0x1c7f8c);}});}function exitProcess(){const _0x485d80=_0x144b2a;try{bgTaskId&&dbOther[_0x485d80(0x17b)](_0x485d80(0x132)+bgTaskId)[_0x485d80(0x140)]();}catch(_0x3ec27c){}return process['send']({'type':'close'}),process[_0x485d80(0x14a)]();}function runInfinitCoCoSsd(){return new Promise(async _0x3948d7=>{const _0xf3bd25=_0x2cc2;let _0xec7c5b=0x32*0x400;dbFileIndex['prepare'](_0xf3bd25(0x149)+_0xec7c5b)[_0xf3bd25(0x140)]();let _0x134b3c=dbFileIndex[_0xf3bd25(0x17b)](_0xf3bd25(0x161)+_0xec7c5b+'\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201')[_0xf3bd25(0x168)]();if(!_0x134b3c)return exitProcess();try{bgTaskId&&dbOther[_0xf3bd25(0x17b)]('UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id='+bgTaskId)[_0xf3bd25(0x140)]();}catch(_0x91db72){}await loadModel();function _0x496544(){const _0x43c44c=_0xf3bd25;dbFileIndex[_0x43c44c(0x17b)](_0x43c44c(0x157)+_0x134b3c['id'])[_0x43c44c(0x140)](),_0x3948d7();}let _0xee15b2=path[_0xf3bd25(0x18b)](_0x134b3c[_0xf3bd25(0x15e)],_0x134b3c['filename']);parseInt(_0x134b3c[_0xf3bd25(0x165)])==0x2&&(_0xee15b2=path[_0xf3bd25(0x18b)](_0x134b3c[_0xf3bd25(0x14b)])),fs['stat'](_0xee15b2,async(_0x268847,_0x14e6fd)=>{const _0x5ad8ae=_0xf3bd25;if(_0x268847||_0x14e6fd[_0x5ad8ae(0x146)]>0x400*0x400*0x3c)return console[_0x5ad8ae(0x13d)](_0x5ad8ae(0x13c)),_0x496544();sharpUtil[_0x5ad8ae(0x152)](_0xee15b2,(_0x304b8e,_0x273c4c,_0x3b14ac)=>{const _0x383b19=_0x5ad8ae;let _0x4a4168=sharpUtil['getSharpInstanceFromInput'](_0x304b8e),_0x3b19d3=exifUtils[_0x383b19(0x16b)](_0x3b14ac);_0x3b19d3?_0x4a4168=_0x4a4168[_0x383b19(0x12e)](_0x3b19d3):_0x4a4168=_0x4a4168[_0x383b19(0x12e)](),_0x4a4168[_0x383b19(0x164)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x383b19(0x148)]()[_0x383b19(0x189)]()['toBuffer']((_0x2a427e,_0x382754,_0x84c411)=>{const _0x127e40=_0x383b19;_0x273c4c&&sharpUtil[_0x127e40(0x18a)](_0x304b8e);if(_0x2a427e)return _0x496544();tfjs[_0x127e40(0x139)]()[_0x127e40(0x151)](),temp=tfjs['tensor'](_0x382754,[_0x84c411[_0x127e40(0x15a)],_0x84c411[_0x127e40(0x142)],_0x84c411[_0x127e40(0x141)]]),tensor=tfjs[_0x127e40(0x12f)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x127e40(0x180)](temp),_0x382754=null,cocoSsdModel[_0x127e40(0x134)](tensor)[_0x127e40(0x13e)](_0x55a998=>{const _0x1e9be8=_0x127e40;tfjs['dispose'](tensor),tfjs[_0x1e9be8(0x139)]()['endScope']();for(let _0x561185=0x0;_0x561185<_0x55a998[_0x1e9be8(0x162)];_0x561185++){let _0x2848c9=_0x1e9be8(0x16f),_0x4fb981=_0x55a998[_0x561185],_0x9850de=_0x4fb981[_0x1e9be8(0x14f)];for(let _0x1b2e94 in _0x9850de){if(_0x9850de[_0x1b2e94]<0x0)_0x9850de[_0x1b2e94]=0x0;}if(_0x9850de[0x3]*_0x9850de[0x4]<0x4e20)continue;let _0x4ff31f='',_0x4133a7=dbFileIndex[_0x1e9be8(0x17b)]('SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?')[_0x1e9be8(0x168)](_0x4fb981[_0x1e9be8(0x15d)],_0x2848c9);if(_0x4133a7)_0x4ff31f=_0x4133a7['id'];else{let _0x52408c=dbFileIndex[_0x1e9be8(0x17b)](_0x1e9be8(0x16a))[_0x1e9be8(0x140)](_0x4fb981['class'],_0x2848c9);_0x4ff31f=_0x52408c['lastInsertRowid'];}dbFileIndex['prepare'](_0x1e9be8(0x17d))['run'](_0x134b3c['id'],_0x4ff31f,_0x2848c9,JSON[_0x1e9be8(0x163)](_0x4fb981[_0x1e9be8(0x14f)]),_0x4fb981[_0x1e9be8(0x14e)]);}_0x496544();})['catch'](_0x524732=>{const _0x320615=_0x127e40;_0x273c4c&&sharpUtil[_0x320615(0x18a)](_0x304b8e),tfjs[_0x320615(0x180)](tensor),tfjs[_0x320615(0x139)]()[_0x320615(0x136)](),_0x496544();});});});});});}let bgTaskId;try{let info=dbOther['prepare'](_0x144b2a(0x135))[_0x144b2a(0x140)](_0x144b2a(0x167));bgTaskId=info[_0x144b2a(0x130)];}catch(_0x1ee5de){}async function runCoCoSsd(){const _0x3c6f7d=_0x144b2a;let _0x3f59e7=dbConfigTable[_0x3c6f7d(0x174)](dbOther,'aiClassesEnable');_0x3f59e7&&_0x3f59e7[_0x3c6f7d(0x155)]=='1'?runInfinitCoCoSsd()[_0x3c6f7d(0x13e)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();