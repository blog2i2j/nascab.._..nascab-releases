const _0x1ac726=_0x478b;(function(_0x2784db,_0x222beb){const _0x404d94=_0x478b,_0x45f796=_0x2784db();while(!![]){try{const _0x392f8b=-parseInt(_0x404d94(0x190))/0x1+-parseInt(_0x404d94(0x1de))/0x2+-parseInt(_0x404d94(0x1a9))/0x3+-parseInt(_0x404d94(0x1a3))/0x4*(parseInt(_0x404d94(0x1b8))/0x5)+-parseInt(_0x404d94(0x184))/0x6*(-parseInt(_0x404d94(0x1a7))/0x7)+-parseInt(_0x404d94(0x1b4))/0x8+parseInt(_0x404d94(0x17f))/0x9*(parseInt(_0x404d94(0x1ac))/0xa);if(_0x392f8b===_0x222beb)break;else _0x45f796['push'](_0x45f796['shift']());}catch(_0x41c890){_0x45f796['push'](_0x45f796['shift']());}}}(_0x2add,0x6fef8));const tfjs=require('@tensorflow/tfjs'),wasm=require(_0x1ac726(0x1bc)),fileSys=require(_0x1ac726(0x1ca)),cocoSsd=require(_0x1ac726(0x1d6)),Database=require(_0x1ac726(0x1d5)),config=require(_0x1ac726(0x1ab)),dbConfigTable=require(_0x1ac726(0x18c)),sharpUtil=require(_0x1ac726(0x1d9));let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x1ac726(0x1c5)],{});process[_0x1ac726(0x1cf)]=_0x1ac726(0x1c4),dbOther['pragma'](_0x1ac726(0x18e)),dbFileIndex['pragma'](_0x1ac726(0x18e));const exifUtils=require(_0x1ac726(0x1d8));process['on'](_0x1ac726(0x1d4),()=>{const _0x25e8bd=_0x1ac726;dbOther[_0x25e8bd(0x1b2)](),dbFileIndex[_0x25e8bd(0x1b2)]();});const fs=require('fs');let path=require(_0x1ac726(0x1e0));const https=require(_0x1ac726(0x1b9));function _0x2add(){const _0x26af42=['prepare','getTime','getSharpInstanceFromInput','../../db/dbConfigTable','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','journal_mode\x20=\x20WAL','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','583543yEWJfh','toBuffer','wasm','message','stat','group1-shard6of17','renameSync','existsSync','aiClassesEnable','group1-shard10of17','group1-shard5of17','weights_manifest.json','pipe','group1-shard7of17','mkdirSync','slice','stringify','score','class','79404JfVuPh','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','engine','lastInsertRowid','1078MBcZuz','NodeFileSystem','1764111TXypwB','log','../../myConfig/config','27942430IzKuct','getRotateFromTags','group1-shard11of17','ssd_mobilenet_v2_1_default_1','detect','endScope','close','createWriteStream','6115424bjUigI','filename','width','model.json','205ABaAPZ','https','findByTitle','group1-shard14of17','@tensorflow/tfjs-backend-wasm','size','type','setBackend','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','bbox','ready','group1-shard16of17','NasCabAiClassify','dbOther','https://down.nascab.cn/tfModel/ssd_mobilenet_v2_1_default_1/','resize','userDataFolder','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','./utils/file_system','error','length','get','startScope','title','rotate','jpeg','load','group1-shard13of17','exit','better-sqlite3','@tensorflow-models/coco-ssd','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','../../utils/exifUtils','../../express-server/utils/sharpUtils','group1-shard9of17','run','deleteRawTempFile','height','237700FEmomo','group1-shard3of17','path','then','9QKTVhc','dispose','group1-shard1of17','tiny_path','join','20766EGTydo','coco_ssd','group1-shard15of17','value','group1-shard4of17'];_0x2add=function(){return _0x26af42;};return _0x2add();}let cocoSsdModel=null,modelSavePath=path[_0x1ac726(0x183)](config[_0x1ac726(0x1c8)],'tfModel',_0x1ac726(0x1af));!fs[_0x1ac726(0x197)](modelSavePath)&&fs[_0x1ac726(0x19e)](modelSavePath,{'recursive':!![]});let modelBaseUrl=_0x1ac726(0x1c6),modelFileUrlList=[],modelFileList=[_0x1ac726(0x1da),_0x1ac726(0x199),_0x1ac726(0x1ae),'group1-shard12of17',_0x1ac726(0x1d3),_0x1ac726(0x1bb),_0x1ac726(0x186),_0x1ac726(0x1c3),'group1-shard17of17','model.json','tensorflowjs_model.pb',_0x1ac726(0x19b),_0x1ac726(0x181),'group1-shard2of17',_0x1ac726(0x1df),_0x1ac726(0x188),_0x1ac726(0x19a),_0x1ac726(0x195),_0x1ac726(0x19d),'group1-shard8of17'];for(let i=0x0;i<modelFileList['length'];i++){modelFileUrlList['push'](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x57bc39,_0x249369,_0x2b78b3){return new Promise((_0x5d0c3c,_0x16122e)=>{const _0x3cfe55=_0x478b;https[_0x3cfe55(0x1cd)](_0x57bc39,_0x295e84=>{const _0x53cc87=_0x3cfe55,_0x1c55aa=fs[_0x53cc87(0x1b3)](_0x249369);_0x295e84[_0x53cc87(0x19c)](_0x1c55aa),_0x1c55aa['on']('finish',()=>{const _0x31a70e=_0x53cc87;_0x1c55aa[_0x31a70e(0x1b2)](),fs[_0x31a70e(0x196)](_0x249369,_0x2b78b3),_0x5d0c3c();})['on'](_0x53cc87(0x1cb),_0x41f452=>{const _0x1a8009=_0x53cc87;console[_0x1a8009(0x1aa)](_0x41f452);});})['on']('error',_0x5d84b3=>{const _0x53eda5=_0x3cfe55;_0x16122e(_0x5d84b3[_0x53eda5(0x193)]);});});}function _0x478b(_0x419670,_0x4bac6e){const _0x2add72=_0x2add();return _0x478b=function(_0x478bfa,_0x36524d){_0x478bfa=_0x478bfa-0x17e;let _0x2f5826=_0x2add72[_0x478bfa];return _0x2f5826;},_0x478b(_0x419670,_0x4bac6e);}function downloadModelFile(){return new Promise(async(_0x5577f8,_0x2894bc)=>{const _0x765267=_0x478b;try{for(let _0x18e1db=0x0;_0x18e1db<modelFileList[_0x765267(0x1cc)];_0x18e1db++){let _0x26534c=path[_0x765267(0x183)](modelSavePath,modelFileList[_0x18e1db]),_0x398a8c=path[_0x765267(0x183)](modelSavePath,'tmp_'+modelFileList[_0x18e1db]);if(!fs[_0x765267(0x197)](_0x26534c)){let _0x47232b=modelFileUrlList[_0x18e1db];await httpDownload(_0x47232b,_0x398a8c,_0x26534c);}else{}}_0x5577f8();}catch(_0x2a9bda){_0x2894bc(_0x2a9bda);}});}async function loadModel(){return new Promise(async(_0x962726,_0xddd1c7)=>{const _0x20ddc5=_0x478b;try{if(!cocoSsdModel){await tfjs[_0x20ddc5(0x1bf)](_0x20ddc5(0x192)),await tfjs[_0x20ddc5(0x1c2)](),await downloadModelFile();let _0x1f5e72=path[_0x20ddc5(0x183)](modelSavePath,_0x20ddc5(0x1b7)),_0x596719=new fileSys[(_0x20ddc5(0x1a8))](_0x1f5e72);cocoSsdModel=await cocoSsd[_0x20ddc5(0x1d2)]({'modelUrl':_0x596719});let _0x2b7377=new Date()[_0x20ddc5(0x18a)]();_0x962726();}else _0x962726();}catch(_0x11cf30){console[_0x20ddc5(0x1aa)](_0x11cf30),_0xddd1c7(_0x11cf30);}});}function exitProcess(){const _0x5e2633=_0x1ac726;try{bgTaskId&&dbOther['prepare'](_0x5e2633(0x18f)+bgTaskId)['run']();}catch(_0x3a1636){}return process['send']({'type':_0x5e2633(0x1b2)}),process[_0x5e2633(0x1d4)]();}function runInfinitCoCoSsd(){return new Promise(async _0x53eaae=>{const _0xbfb121=_0x478b;let _0x2249e2=0x32*0x400;dbFileIndex[_0xbfb121(0x189)]('UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<='+_0x2249e2)['run']();let _0x1e919d=dbFileIndex[_0xbfb121(0x189)](_0xbfb121(0x18d)+_0x2249e2+_0xbfb121(0x1c9))[_0xbfb121(0x1cd)]();if(!_0x1e919d)return exitProcess();try{bgTaskId&&dbOther[_0xbfb121(0x189)](_0xbfb121(0x1a4)+bgTaskId)[_0xbfb121(0x1db)]();}catch(_0x5b8b7d){}await loadModel();function _0x5f5a37(){dbFileIndex['prepare']('UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id='+_0x1e919d['id'])['run'](),_0x53eaae();}let _0x42a8c2=path[_0xbfb121(0x183)](_0x1e919d[_0xbfb121(0x1e0)],_0x1e919d[_0xbfb121(0x1b5)]);parseInt(_0x1e919d[_0xbfb121(0x1be)])==0x2&&(_0x42a8c2=path['join'](_0x1e919d[_0xbfb121(0x182)])),fs[_0xbfb121(0x194)](_0x42a8c2,async(_0x2dfec,_0x2ffd4d)=>{const _0x1ca647=_0xbfb121;if(_0x2dfec||_0x2ffd4d[_0x1ca647(0x1bd)]>0x400*0x400*0x3c)return console['log']('大于30mb的图像不处理'),_0x5f5a37();sharpUtil['transSpcielFormat'](_0x42a8c2,(_0x30ddc7,_0x5dad36,_0xec36e8)=>{const _0x1df5b6=_0x1ca647;let _0x182a52=sharpUtil[_0x1df5b6(0x18b)](_0x30ddc7),_0x213590=exifUtils[_0x1df5b6(0x1ad)](_0xec36e8);_0x213590?_0x182a52=_0x182a52[_0x1df5b6(0x1d0)](_0x213590):_0x182a52=_0x182a52[_0x1df5b6(0x1d0)](),_0x182a52[_0x1df5b6(0x1c7)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x1df5b6(0x1d1)]()['raw']()[_0x1df5b6(0x191)]((_0x5371a1,_0x5a50fb,_0x199f3a)=>{const _0x1c3dd4=_0x1df5b6;_0x5dad36&&sharpUtil[_0x1c3dd4(0x1dc)](_0x30ddc7);if(_0x5371a1)return _0x5f5a37();tfjs['engine']()[_0x1c3dd4(0x1ce)](),temp=tfjs['tensor'](_0x5a50fb,[_0x199f3a[_0x1c3dd4(0x1dd)],_0x199f3a[_0x1c3dd4(0x1b6)],_0x199f3a['channels']]),tensor=tfjs[_0x1c3dd4(0x19f)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x1c3dd4(0x180)](temp),_0x5a50fb=null,cocoSsdModel[_0x1c3dd4(0x1b0)](tensor)[_0x1c3dd4(0x17e)](_0x2b5d10=>{const _0x45728a=_0x1c3dd4;tfjs[_0x45728a(0x180)](tensor),tfjs[_0x45728a(0x1a5)]()[_0x45728a(0x1b1)]();for(let _0x5e4108=0x0;_0x5e4108<_0x2b5d10['length'];_0x5e4108++){let _0x1ffbbe=_0x45728a(0x185),_0x56fc05=_0x2b5d10[_0x5e4108],_0xc1070b=_0x56fc05[_0x45728a(0x1c1)];for(let _0x96ee98 in _0xc1070b){if(_0xc1070b[_0x96ee98]<0x0)_0xc1070b[_0x96ee98]=0x0;}if(_0xc1070b[0x3]*_0xc1070b[0x4]<0x4e20)continue;let _0x1653d3='',_0x4768ab=dbFileIndex[_0x45728a(0x189)](_0x45728a(0x1c0))['get'](_0x56fc05['class'],_0x1ffbbe);if(_0x4768ab)_0x1653d3=_0x4768ab['id'];else{let _0x3bb501=dbFileIndex[_0x45728a(0x189)]('REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)')['run'](_0x56fc05[_0x45728a(0x1a2)],_0x1ffbbe);_0x1653d3=_0x3bb501[_0x45728a(0x1a6)];}dbFileIndex[_0x45728a(0x189)](_0x45728a(0x1d7))[_0x45728a(0x1db)](_0x1e919d['id'],_0x1653d3,_0x1ffbbe,JSON[_0x45728a(0x1a0)](_0x56fc05[_0x45728a(0x1c1)]),_0x56fc05[_0x45728a(0x1a1)]);}_0x5f5a37();})['catch'](_0x3dedcb=>{const _0x53a5bd=_0x1c3dd4;_0x5dad36&&sharpUtil[_0x53a5bd(0x1dc)](_0x30ddc7),tfjs[_0x53a5bd(0x180)](tensor),tfjs['engine']()[_0x53a5bd(0x1b1)](),_0x5f5a37();});});});});});}let bgTaskId;try{let info=dbOther['prepare']('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')[_0x1ac726(0x1db)]('AI_CLASSES');bgTaskId=info[_0x1ac726(0x1a6)];}catch(_0x43940d){}async function runCoCoSsd(){const _0x1494e9=_0x1ac726;let _0x38db4e=dbConfigTable[_0x1494e9(0x1ba)](dbOther,_0x1494e9(0x198));_0x38db4e&&_0x38db4e[_0x1494e9(0x187)]=='1'?runInfinitCoCoSsd()['then'](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();