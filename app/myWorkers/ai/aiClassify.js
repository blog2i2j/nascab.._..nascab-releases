function _0x487a(_0x1073fc,_0x1024b5){const _0x352484=_0x3524();return _0x487a=function(_0x487a9b,_0x181040){_0x487a9b=_0x487a9b-0x69;let _0x45c18b=_0x352484[_0x487a9b];return _0x45c18b;},_0x487a(_0x1073fc,_0x1024b5);}const _0x58c786=_0x487a;(function(_0x5e0c86,_0x57a007){const _0x4434f6=_0x487a,_0x35917a=_0x5e0c86();while(!![]){try{const _0x43ae5a=-parseInt(_0x4434f6(0x6f))/0x1*(-parseInt(_0x4434f6(0x7f))/0x2)+-parseInt(_0x4434f6(0x98))/0x3+-parseInt(_0x4434f6(0xa9))/0x4+-parseInt(_0x4434f6(0x7d))/0x5+parseInt(_0x4434f6(0xc7))/0x6+-parseInt(_0x4434f6(0xa6))/0x7*(-parseInt(_0x4434f6(0x6b))/0x8)+-parseInt(_0x4434f6(0x85))/0x9*(parseInt(_0x4434f6(0x8f))/0xa);if(_0x43ae5a===_0x57a007)break;else _0x35917a['push'](_0x35917a['shift']());}catch(_0x4ecda7){_0x35917a['push'](_0x35917a['shift']());}}}(_0x3524,0xf30d6));const tfjs=require(_0x58c786(0xb1)),wasm=require(_0x58c786(0xb7)),fileSys=require('./utils/file_system'),cocoSsd=require(_0x58c786(0x8a)),Database=require('better-sqlite3'),config=require(_0x58c786(0x7c)),dbConfigTable=require(_0x58c786(0x95)),sharpUtil=require(_0x58c786(0x72));let dbFileIndex=new Database(config[_0x58c786(0xc0)],{}),dbOther=new Database(config[_0x58c786(0xb3)],{});function _0x3524(){const _0x404dc9=['@tensorflow-models/coco-ssd','tmp_','dispose','getTime','send','10oHgqGP','get','then','AI_CLASSES','大于30mb的图像不处理','aiClassesEnable','../../db/dbConfigTable','filename','error','204882wJcpOT','getSharpInstanceFromInput','createWriteStream','log','raw','type','channels','detect','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','load','finish','run','journal_mode\x20=\x20WAL','group1-shard9of17','763CzBqzL','tensorflowjs_model.pb','engine','4489208wpfQiL','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)','group1-shard14of17','SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?','join','getRotateFromTags','weights_manifest.json','class','@tensorflow/tfjs','https://down.nascab.cn/tfModel/ssd_mobilenet_v2_1_default_1/','dbOther','findByTitle','tiny_path','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','@tensorflow/tfjs-backend-wasm','toBuffer','width','existsSync','exit','pragma','NodeFileSystem','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','group1-shard5of17','dbFileIndex','endScope','path','size','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','close','group1-shard7of17','5245680MXKRTq','height','UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id=','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','prepare','group1-shard10of17','mkdirSync','rotate','pipe','43592DxlAfw','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','userDataFolder','deleteRawTempFile','21WJIuPh','lastInsertRowid','transSpcielFormat','../../express-server/utils/sharpUtils','startScope','tfModel','stat','coco_ssd','length','group1-shard16of17','wasm','bbox','group1-shard13of17','../../myConfig/config','2761150fTDtFo','title','136918yjyolZ','group1-shard2of17','group1-shard17of17','NasCabAiClassify','group1-shard8of17','ready','1507428MajPma','group1-shard4of17','push','catch','model.json'];_0x3524=function(){return _0x404dc9;};return _0x3524();}process[_0x58c786(0x7e)]=_0x58c786(0x82),dbOther[_0x58c786(0xbc)]('journal_mode\x20=\x20WAL'),dbFileIndex[_0x58c786(0xbc)](_0x58c786(0xa4));const exifUtils=require('../../utils/exifUtils');process['on']('exit',()=>{const _0x4fe9cb=_0x58c786;dbOther[_0x4fe9cb(0xc5)](),dbFileIndex['close']();});const fs=require('fs');let path=require(_0x58c786(0xc2));const https=require('https');let cocoSsdModel=null,modelSavePath=path['join'](config[_0x58c786(0x6d)],_0x58c786(0x74),'ssd_mobilenet_v2_1_default_1');!fs[_0x58c786(0xba)](modelSavePath)&&fs[_0x58c786(0xcd)](modelSavePath,{'recursive':!![]});let modelBaseUrl=_0x58c786(0xb2),modelFileUrlList=[],modelFileList=[_0x58c786(0xa5),_0x58c786(0xcc),'group1-shard11of17','group1-shard12of17',_0x58c786(0x7b),_0x58c786(0xab),'group1-shard15of17',_0x58c786(0x78),_0x58c786(0x81),_0x58c786(0x89),_0x58c786(0xa7),_0x58c786(0xaf),'group1-shard1of17',_0x58c786(0x80),'group1-shard3of17',_0x58c786(0x86),_0x58c786(0xbf),'group1-shard6of17',_0x58c786(0xc6),_0x58c786(0x83)];for(let i=0x0;i<modelFileList[_0x58c786(0x77)];i++){modelFileUrlList[_0x58c786(0x87)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x241bea,_0x542248,_0x3a1e37){return new Promise((_0x56b76a,_0x1c136e)=>{const _0xd91c1c=_0x487a;https[_0xd91c1c(0x90)](_0x241bea,_0x10fed7=>{const _0x2f2efd=_0xd91c1c,_0x2b8e4f=fs[_0x2f2efd(0x9a)](_0x542248);_0x10fed7[_0x2f2efd(0x6a)](_0x2b8e4f),_0x2b8e4f['on'](_0x2f2efd(0xa2),()=>{_0x2b8e4f['close'](),fs['renameSync'](_0x542248,_0x3a1e37),_0x56b76a();})['on'](_0x2f2efd(0x97),_0x44e068=>{const _0x564386=_0x2f2efd;console[_0x564386(0x9b)](_0x44e068);});})['on'](_0xd91c1c(0x97),_0x315ad6=>{_0x1c136e(_0x315ad6['message']);});});}function downloadModelFile(){return new Promise(async(_0xaa09d1,_0x587435)=>{const _0x5b6bf0=_0x487a;try{for(let _0xb2a254=0x0;_0xb2a254<modelFileList[_0x5b6bf0(0x77)];_0xb2a254++){let _0x484284=path[_0x5b6bf0(0xad)](modelSavePath,modelFileList[_0xb2a254]),_0x19969b=path[_0x5b6bf0(0xad)](modelSavePath,_0x5b6bf0(0x8b)+modelFileList[_0xb2a254]);if(!fs[_0x5b6bf0(0xba)](_0x484284)){let _0x2100fd=modelFileUrlList[_0xb2a254];await httpDownload(_0x2100fd,_0x19969b,_0x484284);}else{}}_0xaa09d1();}catch(_0x30bb6f){_0x587435(_0x30bb6f);}});}async function loadModel(){return new Promise(async(_0x4d40de,_0x418894)=>{const _0xbd1e0=_0x487a;try{if(!cocoSsdModel){await tfjs['setBackend'](_0xbd1e0(0x79)),await tfjs[_0xbd1e0(0x84)](),await downloadModelFile();let _0x1a830a=path['join'](modelSavePath,_0xbd1e0(0x89)),_0x48faf1=new fileSys[(_0xbd1e0(0xbd))](_0x1a830a);cocoSsdModel=await cocoSsd[_0xbd1e0(0xa1)]({'modelUrl':_0x48faf1});let _0x50b699=new Date()[_0xbd1e0(0x8d)]();_0x4d40de();}else _0x4d40de();}catch(_0x42d5cd){console[_0xbd1e0(0x9b)](_0x42d5cd),_0x418894(_0x42d5cd);}});}function exitProcess(){const _0x492551=_0x58c786;try{bgTaskId&&dbOther[_0x492551(0xcb)](_0x492551(0xc9)+bgTaskId)['run']();}catch(_0xa67aae){}return process[_0x492551(0x8e)]({'type':_0x492551(0xc5)}),process[_0x492551(0xbb)]();}function runInfinitCoCoSsd(){return new Promise(async _0x3adf4f=>{const _0x37689e=_0x487a;let _0x2ad2aa=0x32*0x400;dbFileIndex[_0x37689e(0xcb)](_0x37689e(0xbe)+_0x2ad2aa)['run']();let _0x50b1ff=dbFileIndex[_0x37689e(0xcb)](_0x37689e(0xca)+_0x2ad2aa+_0x37689e(0xa0))['get']();if(!_0x50b1ff)return exitProcess();try{bgTaskId&&dbOther[_0x37689e(0xcb)](_0x37689e(0x6c)+bgTaskId)[_0x37689e(0xa3)]();}catch(_0x2c8b29){}await loadModel();function _0x43d9c4(){const _0x1d53c5=_0x37689e;dbFileIndex['prepare'](_0x1d53c5(0xc4)+_0x50b1ff['id'])['run'](),_0x3adf4f();}let _0x3ee644=path[_0x37689e(0xad)](_0x50b1ff['path'],_0x50b1ff[_0x37689e(0x96)]);parseInt(_0x50b1ff[_0x37689e(0x9d)])==0x2&&(_0x3ee644=path[_0x37689e(0xad)](_0x50b1ff[_0x37689e(0xb5)])),fs[_0x37689e(0x75)](_0x3ee644,async(_0x48afb4,_0x2579ae)=>{const _0x596df8=_0x37689e;if(_0x48afb4||_0x2579ae[_0x596df8(0xc3)]>0x400*0x400*0x3c)return console[_0x596df8(0x9b)](_0x596df8(0x93)),_0x43d9c4();sharpUtil[_0x596df8(0x71)](_0x3ee644,(_0x42533d,_0x28bb52,_0x2b7e0c)=>{const _0x375953=_0x596df8;let _0x1aa63f=sharpUtil[_0x375953(0x99)](_0x42533d),_0x1e15fb=exifUtils[_0x375953(0xae)](_0x2b7e0c);_0x1e15fb?_0x1aa63f=_0x1aa63f[_0x375953(0x69)](_0x1e15fb):_0x1aa63f=_0x1aa63f[_0x375953(0x69)](),_0x1aa63f['resize']({'width':0x7d0,'withoutEnlargement':!![]})['jpeg']()[_0x375953(0x9c)]()[_0x375953(0xb8)]((_0x47168f,_0x376f18,_0x2b7e0b)=>{const _0x55579a=_0x375953;_0x28bb52&&sharpUtil[_0x55579a(0x6e)](_0x42533d);if(_0x47168f)return _0x43d9c4();tfjs['engine']()[_0x55579a(0x73)](),temp=tfjs['tensor'](_0x376f18,[_0x2b7e0b[_0x55579a(0xc8)],_0x2b7e0b[_0x55579a(0xb9)],_0x2b7e0b[_0x55579a(0x9e)]]),tensor=tfjs['slice'](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x55579a(0x8c)](temp),_0x376f18=null,cocoSsdModel[_0x55579a(0x9f)](tensor)[_0x55579a(0x91)](_0x322264=>{const _0x5e45b4=_0x55579a;tfjs[_0x5e45b4(0x8c)](tensor),tfjs[_0x5e45b4(0xa8)]()[_0x5e45b4(0xc1)]();for(let _0x3e6fe5=0x0;_0x3e6fe5<_0x322264['length'];_0x3e6fe5++){let _0x4d57ed=_0x5e45b4(0x76),_0x4ad1ec=_0x322264[_0x3e6fe5],_0x48ac68=_0x4ad1ec[_0x5e45b4(0x7a)];for(let _0xad31b5 in _0x48ac68){if(_0x48ac68[_0xad31b5]<0x0)_0x48ac68[_0xad31b5]=0x0;}if(_0x48ac68[0x3]*_0x48ac68[0x4]<0x4e20)continue;let _0x11c6c4='',_0x2cd5b4=dbFileIndex[_0x5e45b4(0xcb)](_0x5e45b4(0xac))[_0x5e45b4(0x90)](_0x4ad1ec[_0x5e45b4(0xb0)],_0x4d57ed);if(_0x2cd5b4)_0x11c6c4=_0x2cd5b4['id'];else{let _0x3918eb=dbFileIndex[_0x5e45b4(0xcb)](_0x5e45b4(0xb6))[_0x5e45b4(0xa3)](_0x4ad1ec[_0x5e45b4(0xb0)],_0x4d57ed);_0x11c6c4=_0x3918eb[_0x5e45b4(0x70)];}dbFileIndex[_0x5e45b4(0xcb)](_0x5e45b4(0xaa))[_0x5e45b4(0xa3)](_0x50b1ff['id'],_0x11c6c4,_0x4d57ed,JSON['stringify'](_0x4ad1ec[_0x5e45b4(0x7a)]),_0x4ad1ec['score']);}_0x43d9c4();})[_0x55579a(0x88)](_0x238389=>{const _0x58f0a7=_0x55579a;_0x28bb52&&sharpUtil['deleteRawTempFile'](_0x42533d),tfjs[_0x58f0a7(0x8c)](tensor),tfjs['engine']()[_0x58f0a7(0xc1)](),_0x43d9c4();});});});});});}let bgTaskId;try{let info=dbOther[_0x58c786(0xcb)]('INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)')['run'](_0x58c786(0x92));bgTaskId=info[_0x58c786(0x70)];}catch(_0x51614d){}async function runCoCoSsd(){const _0x5c6d4a=_0x58c786;let _0x9d4a87=dbConfigTable[_0x5c6d4a(0xb4)](dbOther,_0x5c6d4a(0x94));_0x9d4a87&&_0x9d4a87['value']=='1'?runInfinitCoCoSsd()[_0x5c6d4a(0x91)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}runCoCoSsd();