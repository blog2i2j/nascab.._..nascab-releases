const _0x4d2b22=_0x4e8b;(function(_0x37cf4c,_0x581d99){const _0x35ad2c=_0x4e8b,_0x314b2c=_0x37cf4c();while(!![]){try{const _0x3a7a06=parseInt(_0x35ad2c(0x128))/0x1+-parseInt(_0x35ad2c(0x159))/0x2*(parseInt(_0x35ad2c(0x157))/0x3)+-parseInt(_0x35ad2c(0x11f))/0x4+parseInt(_0x35ad2c(0xfa))/0x5*(-parseInt(_0x35ad2c(0x119))/0x6)+-parseInt(_0x35ad2c(0x11b))/0x7*(-parseInt(_0x35ad2c(0xf9))/0x8)+parseInt(_0x35ad2c(0x10b))/0x9+-parseInt(_0x35ad2c(0x154))/0xa*(parseInt(_0x35ad2c(0xfc))/0xb);if(_0x3a7a06===_0x581d99)break;else _0x314b2c['push'](_0x314b2c['shift']());}catch(_0x6ba0bc){_0x314b2c['push'](_0x314b2c['shift']());}}}(_0x29fb,0xaa75c));const tfjs=require(_0x4d2b22(0x130)),wasm=require(_0x4d2b22(0x112)),fileSys=require(_0x4d2b22(0x13e)),cocoSsd=require('@tensorflow-models/coco-ssd'),Database=require(_0x4d2b22(0x111)),config=require(_0x4d2b22(0x149)),dbConfigTable=require(_0x4d2b22(0x104)),sharpUtil=require(_0x4d2b22(0x14c));let dbFileIndex=new Database(config['dbFileIndex'],{}),dbOther=new Database(config[_0x4d2b22(0x134)],{});process[_0x4d2b22(0x127)]='NasCabAiClassify',dbOther[_0x4d2b22(0xf4)](_0x4d2b22(0x14d)),dbFileIndex[_0x4d2b22(0xf4)](_0x4d2b22(0x14d));const exifUtils=require(_0x4d2b22(0x110));process['on'](_0x4d2b22(0x139),()=>{const _0x3f2b27=_0x4d2b22;dbOther[_0x3f2b27(0x156)](),dbFileIndex[_0x3f2b27(0x156)]();});const fs=require('fs');let path=require(_0x4d2b22(0x12c));const https=require(_0x4d2b22(0x148));let cocoSsdModel=null,modelSavePath=path[_0x4d2b22(0x123)](config[_0x4d2b22(0x12d)],_0x4d2b22(0x102),_0x4d2b22(0x121));!fs[_0x4d2b22(0x13b)](modelSavePath)&&fs['mkdirSync'](modelSavePath,{'recursive':!![]});let modelBaseUrl=_0x4d2b22(0xf8),modelFileUrlList=[],modelFileList=[_0x4d2b22(0x101),'group1-shard10of17',_0x4d2b22(0x13a),_0x4d2b22(0x126),_0x4d2b22(0x10f),_0x4d2b22(0xf7),_0x4d2b22(0x10e),_0x4d2b22(0x152),'group1-shard17of17','model.json',_0x4d2b22(0x151),_0x4d2b22(0x131),'group1-shard1of17',_0x4d2b22(0x143),'group1-shard3of17',_0x4d2b22(0x120),_0x4d2b22(0x116),'group1-shard6of17','group1-shard7of17',_0x4d2b22(0x155)];for(let i=0x0;i<modelFileList['length'];i++){modelFileUrlList[_0x4d2b22(0x144)](modelBaseUrl+modelFileList[i]);}function httpDownload(_0x3157d5,_0x492832,_0x57779b){return new Promise((_0x4fdd38,_0x5b5771)=>{const _0x1b443b=_0x4e8b;https[_0x1b443b(0x14b)](_0x3157d5,_0x4e2877=>{const _0x3e46c0=_0x1b443b,_0x43f6fb=fs[_0x3e46c0(0x14e)](_0x492832);_0x4e2877[_0x3e46c0(0x14f)](_0x43f6fb),_0x43f6fb['on'](_0x3e46c0(0x138),()=>{const _0x572351=_0x3e46c0;_0x43f6fb['close'](),fs[_0x572351(0x13c)](_0x492832,_0x57779b),_0x4fdd38();})['on']('error',_0x290e12=>{const _0x101c06=_0x3e46c0;console[_0x101c06(0x146)](_0x290e12);});})['on'](_0x1b443b(0x109),_0x31d7ac=>{_0x5b5771(_0x31d7ac['message']);});});}function downloadModelFile(){return new Promise(async(_0x1f10fc,_0x2ba853)=>{const _0x537ef3=_0x4e8b;try{for(let _0x2c0256=0x0;_0x2c0256<modelFileList[_0x537ef3(0x12e)];_0x2c0256++){let _0x50528f=path['join'](modelSavePath,modelFileList[_0x2c0256]),_0x5e5a4a=path[_0x537ef3(0x123)](modelSavePath,_0x537ef3(0x107)+modelFileList[_0x2c0256]);if(!fs[_0x537ef3(0x13b)](_0x50528f)){let _0x2ac25e=modelFileUrlList[_0x2c0256];await httpDownload(_0x2ac25e,_0x5e5a4a,_0x50528f);}else{}}_0x1f10fc();}catch(_0x2a6251){_0x2ba853(_0x2a6251);}});}function _0x29fb(){const _0x36d71c=['6MNPWYX','then','7yIbVbR','height','AI_CLASSES','getTime','298128vWXsZk','group1-shard4of17','ssd_mobilenet_v2_1_default_1','getSharpInstanceFromInput','join','INSERT\x20INTO\x20bg_task(task_type)\x20VALUES(?)','size','group1-shard12of17','title','619926wsgMPO','value','catch','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20where\x20id=','path','userDataFolder','length','run','@tensorflow/tfjs','weights_manifest.json','lastInsertRowid','class','dbOther','model.json','type','setBackend','finish','exit','group1-shard11of17','existsSync','renameSync','tiny_path','./utils/file_system','\x20AND\x20(type=1\x20OR\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20AND\x20ai_class_state=0\x20AND\x20is_raw!=1\x20LIMIT\x201','stat','findByTitle','toBuffer','group1-shard2of17','push','prepare','log','aiClassesEnable','https','../../myConfig/config','NodeFileSystem','get','../../express-server/utils/sharpUtils','journal_mode\x20=\x20WAL','createWriteStream','pipe','deleteRawTempFile','tensorflowjs_model.pb','group1-shard16of17','REPLACE\x20INTO\x20ai_classes(class_name,class_type)\x20\x20VALUES(?,?)','30VgIfmm','group1-shard8of17','close','15VldvJg','channels','408868TLPQhD','startScope','pragma','tensor','getRotateFromTags','group1-shard14of17','https://down.nascab.cn/tfModel/ssd_mobilenet_v2_1_default_1/','4836728JBLcRe','13530UZXmpN','dispose','15642DDZjcf','UPDATE\x20bg_task\x20SET\x20task_state=1\x20where\x20id=','rotate','bbox','endScope','group1-shard9of17','tfModel','coco_ssd','../../db/dbConfigTable','ready','send','tmp_','jpeg','error','UPDATE\x20file_index_photo\x20SET\x20ai_class_state=1\x20WHERE\x20ai_class_state=0\x20and\x20size<=','5196249HfZqIp','slice','score','group1-shard15of17','group1-shard13of17','../../utils/exifUtils','better-sqlite3','@tensorflow/tfjs-backend-wasm','engine','SELECT\x20*\x20from\x20file_index_photo\x20WHERE\x20is_file=1\x20AND\x20size>','transSpcielFormat','group1-shard5of17','resize','REPLACE\x20INTO\x20ai_classes2index(photo_index_id,class_id,class_type,bbox,score)\x20\x20VALUES(?,?,?,?,?)'];_0x29fb=function(){return _0x36d71c;};return _0x29fb();}async function loadModel(){return new Promise(async(_0x32b5b2,_0x1093cf)=>{const _0x41229d=_0x4e8b;try{if(!cocoSsdModel){await tfjs[_0x41229d(0x137)]('wasm'),await tfjs[_0x41229d(0x105)](),await downloadModelFile();let _0x283b99=path[_0x41229d(0x123)](modelSavePath,_0x41229d(0x135)),_0x39e5df=new fileSys[(_0x41229d(0x14a))](_0x283b99);cocoSsdModel=await cocoSsd['load']({'modelUrl':_0x39e5df});let _0x855706=new Date()[_0x41229d(0x11e)]();_0x32b5b2();}else _0x32b5b2();}catch(_0x3e2a79){console[_0x41229d(0x146)](_0x3e2a79),_0x1093cf(_0x3e2a79);}});}function exitProcess(){const _0x510211=_0x4d2b22;try{bgTaskId&&dbOther['prepare']('UPDATE\x20bg_task\x20SET\x20task_state=2\x20where\x20id='+bgTaskId)['run']();}catch(_0x41c614){}return process[_0x510211(0x106)]({'type':_0x510211(0x156)}),process[_0x510211(0x139)]();}function runInfinitCoCoSsd(){return new Promise(async _0x5b5d4a=>{const _0x22a6bc=_0x4e8b;let _0x1f0583=0x32*0x400;dbFileIndex['prepare'](_0x22a6bc(0x10a)+_0x1f0583)[_0x22a6bc(0x12f)]();let _0x25c15e=dbFileIndex[_0x22a6bc(0x145)](_0x22a6bc(0x114)+_0x1f0583+_0x22a6bc(0x13f))[_0x22a6bc(0x14b)]();if(!_0x25c15e)return exitProcess();try{bgTaskId&&dbOther[_0x22a6bc(0x145)](_0x22a6bc(0xfd)+bgTaskId)[_0x22a6bc(0x12f)]();}catch(_0x5ca674){}await loadModel();function _0x3d0885(){const _0x57539d=_0x22a6bc;dbFileIndex[_0x57539d(0x145)](_0x57539d(0x12b)+_0x25c15e['id'])[_0x57539d(0x12f)](),_0x5b5d4a();}let _0x4eb1b3=path[_0x22a6bc(0x123)](_0x25c15e[_0x22a6bc(0x12c)],_0x25c15e['filename']);parseInt(_0x25c15e[_0x22a6bc(0x136)])==0x2&&(_0x4eb1b3=path['join'](_0x25c15e[_0x22a6bc(0x13d)])),fs[_0x22a6bc(0x140)](_0x4eb1b3,async(_0x315dd4,_0x234e05)=>{const _0x467ba8=_0x22a6bc;if(_0x315dd4||_0x234e05[_0x467ba8(0x125)]>0x400*0x400*0x3c)return console[_0x467ba8(0x146)]('大于30mb的图像不处理'),_0x3d0885();sharpUtil[_0x467ba8(0x115)](_0x4eb1b3,(_0x456e67,_0x3578a2,_0x34a369)=>{const _0x22416c=_0x467ba8;let _0x3adc36=sharpUtil[_0x22416c(0x122)](_0x456e67),_0x49ba53=exifUtils[_0x22416c(0xf6)](_0x34a369);_0x49ba53?_0x3adc36=_0x3adc36[_0x22416c(0xfe)](_0x49ba53):_0x3adc36=_0x3adc36[_0x22416c(0xfe)](),_0x3adc36[_0x22416c(0x117)]({'width':0x7d0,'withoutEnlargement':!![]})[_0x22416c(0x108)]()['raw']()[_0x22416c(0x142)]((_0x20a839,_0x3a2ee1,_0x21d37d)=>{const _0x4cf241=_0x22416c;_0x3578a2&&sharpUtil[_0x4cf241(0x150)](_0x456e67);if(_0x20a839)return _0x3d0885();tfjs[_0x4cf241(0x113)]()[_0x4cf241(0xf3)](),temp=tfjs[_0x4cf241(0xf5)](_0x3a2ee1,[_0x21d37d[_0x4cf241(0x11c)],_0x21d37d['width'],_0x21d37d[_0x4cf241(0x158)]]),tensor=tfjs[_0x4cf241(0x10c)](temp,[0x0,0x0,0x0],[-0x1,-0x1,0x3]),tfjs[_0x4cf241(0xfb)](temp),_0x3a2ee1=null,cocoSsdModel['detect'](tensor)[_0x4cf241(0x11a)](_0x9a75fb=>{const _0x382246=_0x4cf241;tfjs[_0x382246(0xfb)](tensor),tfjs['engine']()[_0x382246(0x100)]();for(let _0x298b95=0x0;_0x298b95<_0x9a75fb[_0x382246(0x12e)];_0x298b95++){let _0x242119=_0x382246(0x103),_0x566ead=_0x9a75fb[_0x298b95],_0x5176ea=_0x566ead[_0x382246(0xff)];for(let _0xbdf6cf in _0x5176ea){if(_0x5176ea[_0xbdf6cf]<0x0)_0x5176ea[_0xbdf6cf]=0x0;}if(_0x5176ea[0x3]*_0x5176ea[0x4]<0x4e20)continue;let _0x1aa6aa='',_0x964be4=dbFileIndex[_0x382246(0x145)]('SELECT\x20*\x20FROM\x20ai_classes\x20WHERE\x20class_name=?\x20AND\x20class_type=?')[_0x382246(0x14b)](_0x566ead[_0x382246(0x133)],_0x242119);if(_0x964be4)_0x1aa6aa=_0x964be4['id'];else{let _0x57521a=dbFileIndex[_0x382246(0x145)](_0x382246(0x153))[_0x382246(0x12f)](_0x566ead['class'],_0x242119);_0x1aa6aa=_0x57521a[_0x382246(0x132)];}dbFileIndex[_0x382246(0x145)](_0x382246(0x118))['run'](_0x25c15e['id'],_0x1aa6aa,_0x242119,JSON['stringify'](_0x566ead[_0x382246(0xff)]),_0x566ead[_0x382246(0x10d)]);}_0x3d0885();})[_0x4cf241(0x12a)](_0x2c19ab=>{const _0x4bbde0=_0x4cf241;_0x3578a2&&sharpUtil[_0x4bbde0(0x150)](_0x456e67),tfjs[_0x4bbde0(0xfb)](tensor),tfjs['engine']()['endScope'](),_0x3d0885();});});});});});}let bgTaskId;try{let info=dbOther[_0x4d2b22(0x145)](_0x4d2b22(0x124))[_0x4d2b22(0x12f)](_0x4d2b22(0x11d));bgTaskId=info['lastInsertRowid'];}catch(_0x33d78e){}async function runCoCoSsd(){const _0xd94089=_0x4d2b22;let _0x352cc1=dbConfigTable[_0xd94089(0x141)](dbOther,_0xd94089(0x147));_0x352cc1&&_0x352cc1[_0xd94089(0x129)]=='1'?runInfinitCoCoSsd()[_0xd94089(0x11a)](()=>{setTimeout(()=>{runCoCoSsd();},0xc8);}):exitProcess();}function _0x4e8b(_0x43a969,_0x353785){const _0x29fbaa=_0x29fb();return _0x4e8b=function(_0x4e8b56,_0x12e836){_0x4e8b56=_0x4e8b56-0xf3;let _0x3c028c=_0x29fbaa[_0x4e8b56];return _0x3c028c;},_0x4e8b(_0x43a969,_0x353785);}runCoCoSsd();