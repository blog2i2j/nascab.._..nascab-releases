const _0xba2782=_0x5d50;(function(_0x576106,_0x4d5bb4){const _0x267f5a=_0x5d50,_0x34d4b8=_0x576106();while(!![]){try{const _0x32edb4=parseInt(_0x267f5a(0x106))/0x1*(parseInt(_0x267f5a(0x12a))/0x2)+-parseInt(_0x267f5a(0x114))/0x3+-parseInt(_0x267f5a(0xdc))/0x4*(parseInt(_0x267f5a(0x103))/0x5)+-parseInt(_0x267f5a(0x10a))/0x6+-parseInt(_0x267f5a(0x108))/0x7*(parseInt(_0x267f5a(0x12e))/0x8)+-parseInt(_0x267f5a(0xfb))/0x9*(-parseInt(_0x267f5a(0xf5))/0xa)+-parseInt(_0x267f5a(0x11b))/0xb*(-parseInt(_0x267f5a(0x133))/0xc);if(_0x32edb4===_0x4d5bb4)break;else _0x34d4b8['push'](_0x34d4b8['shift']());}catch(_0x4fff12){_0x34d4b8['push'](_0x34d4b8['shift']());}}}(_0x51e0,0x9b3da));let path=require(_0xba2782(0x116)),fs=require('fs'),FFmpeg=require(_0xba2782(0xee))[_0xba2782(0x137)],sharpUtil={};const sharp=require('sharp'),libheif=require(_0xba2782(0x124)),config=require(_0xba2782(0x105)),transCodeUtil=require(_0xba2782(0x100)),sharpBmp=require(_0xba2782(0xef));let sha256=require(_0xba2782(0xf1));const {Worker}=require(_0xba2782(0x115));let dcraw;function getDcraw(){const _0x24dc1f=_0xba2782;if(!dcraw)try{return dcraw=require(_0x24dc1f(0x119)),dcraw;}catch(_0x17a38a){return console[_0x24dc1f(0x109)](_0x24dc1f(0x12b)),null;}else return dcraw;}let PSD;function getPsd(){const _0x1a4718=_0xba2782;if(!PSD)try{return PSD=require(_0x1a4718(0x11e)),PSD;}catch(_0x44ac38){return console[_0x1a4718(0x109)](_0x1a4718(0x13b)),null;}else return PSD;}function extractThumbnailFromRaw(_0x5a4410,_0x4d9e8b){return new Promise((_0x1262b1,_0x3210ab)=>{const _0x3e3a83=_0x5d50;if(_0x4d9e8b&&_0x4d9e8b[_0x3e3a83(0x10d)]()==_0x3e3a83(0xf4)){let _0x19e211=getPsd();if(!_0x19e211)return _0x3210ab(null);try{if(typeof _0x5a4410==_0x3e3a83(0x129)){let _0x55d5d7=path[_0x3e3a83(0x112)](config[_0x3e3a83(0xea)],sha256(_0x5a4410)+_0x3e3a83(0x131));fs[_0x3e3a83(0x111)](_0x55d5d7,(_0x483a2b,_0x37a71e)=>{const _0x154864=_0x3e3a83;try{if(_0x483a2b){let _0x530bfd=_0x19e211[_0x154864(0x121)](_0x5a4410);_0x530bfd[_0x154864(0xf9)](),_0x530bfd[_0x154864(0x11a)][_0x154864(0xe4)](_0x55d5d7)[_0x154864(0xfa)](()=>{const _0x202a12=_0x154864;sharp(_0x55d5d7)[_0x202a12(0x11c)]({'quality':0x4d})['toBuffer']()[_0x202a12(0xfa)](_0x50d4fd=>{fs['writeFile'](_0x55d5d7,_0x50d4fd,_0x4617ba=>{if(_0x4617ba)return _0x3210ab(null);_0x1262b1(_0x55d5d7);});})[_0x202a12(0x135)](_0x226edf=>{const _0x5ca925=_0x202a12;return console['log'](_0x5ca925(0xdb),_0x226edf),_0x3210ab(null);});})[_0x154864(0x135)](_0x280685=>{const _0x260442=_0x154864;return console[_0x260442(0x109)]('psd\x20error\x201',_0x280685),_0x3210ab(null);});}else return _0x1262b1(_0x55d5d7);}catch(_0xb63403){return console['log'](_0x154864(0x12f),_0xb63403),_0x3210ab(null);}});}else return _0x3210ab(null);}catch(_0x27c434){return _0x3210ab(null);}}else{let _0x59f763=getDcraw();if(!_0x59f763)return _0x3210ab(null);function _0x3b929d(_0x9b856a){try{const _0x5ebe5d=_0x59f763(_0x9b856a,{'extractThumbnail':!![],'identify':!![]});return _0x5ebe5d?_0x1262b1(_0x5ebe5d):_0x3210ab(null);}catch(_0x4836a9){return _0x3210ab(null);}}if(typeof _0x5a4410==_0x3e3a83(0x129))fs[_0x3e3a83(0xe8)](_0x5a4410,(_0x4c19a0,_0x49cf6c)=>{const _0x110f72=_0x3e3a83;if(_0x4c19a0)return console[_0x110f72(0x109)]('读取失败',_0x5a4410),_0x3210ab(_0x4c19a0);_0x3b929d(_0x49cf6c);});else{if(Buffer['isBuffer'](_0x5a4410))_0x3b929d(_0x5a4410);else return _0x3210ab(null);}}});}function _0x5d50(_0x5f3aeb,_0x495e85){const _0x51e058=_0x51e0();return _0x5d50=function(_0x5d507c,_0x248b34){_0x5d507c=_0x5d507c-0xdb;let _0x2d3b3c=_0x51e058[_0x5d507c];return _0x2d3b3c;},_0x5d50(_0x5f3aeb,_0x495e85);}const exifUtils=require('../../utils/exifUtils');sharpUtil[_0xba2782(0x102)]=function(_0x109ea2){const _0x1e0fe6=_0xba2782;_0x109ea2[_0x1e0fe6(0x123)]=='Buffer'&&(_0x109ea2=Buffer[_0x1e0fe6(0xe6)](_0x109ea2));let _0x10455a={'failOnError':![]};return _0x109ea2[_0x1e0fe6(0xe2)]&&_0x109ea2['height']&&_0x109ea2[_0x1e0fe6(0xff)]&&(_0x10455a['raw']={'width':_0x109ea2[_0x1e0fe6(0xe2)],'height':_0x109ea2['height'],'channels':0x4},_0x109ea2=_0x109ea2['data']),sharp(_0x109ea2,_0x10455a);},sharpUtil[_0xba2782(0x126)]=function(_0x1edc7e){const _0x23d13c=_0xba2782;typeof _0x1edc7e==_0x23d13c(0x129)&&_0x1edc7e[_0x23d13c(0x132)](config[_0x23d13c(0x127)])&&fs['rm'](_0x1edc7e,_0x1b5bf1=>{});},sharpUtil[_0xba2782(0x11f)]=function(_0x4ee0ed,_0x25f4e4,_0x9ec0,_0x509986,_0x4170de,_0x8570a9,_0x1a4638,_0x94d7e0,_0x41147f,_0x4a16a1,_0x559c71){const _0x34df31=_0xba2782;if(!_0x4ee0ed)return _0x1a4638(null);let _0x394153=sharpUtil['getSharpInstanceFromInput'](_0x4ee0ed);_0x25f4e4==_0x34df31(0x11c)?_0x559c71?_0x394153=_0x394153[_0x34df31(0x11c)](_0x559c71):_0x394153=_0x394153[_0x34df31(0x11c)]():_0x394153=_0x394153[_0x34df31(0x10f)]({});_0x9ec0&&(_0x394153=_0x394153[_0x34df31(0xe3)]());let _0x95e415=exifUtils[_0x34df31(0x13c)](_0x4a16a1);_0x95e415?_0x394153=_0x394153[_0x34df31(0x110)](_0x95e415):_0x394153=_0x394153[_0x34df31(0x110)]();_0x509986&&(_0x394153=_0x394153['resize'](_0x509986));if(_0x4170de=='file')_0x394153['toFile'](_0x8570a9,(_0xb3646a,_0x587366)=>{const _0x461524=_0x34df31;_0x41147f&&(console[_0x461524(0x109)](_0x461524(0x139),_0x4ee0ed),sharpUtil['deleteRawTempFile'](_0x4ee0ed)),_0xb3646a?(console[_0x461524(0x109)](_0x461524(0xe1),_0x4ee0ed,_0xb3646a),_0x94d7e0()):_0x1a4638(_0x8570a9);});else _0x4170de=='buffer'&&_0x394153[_0x34df31(0xf0)]((_0x19e632,_0x58f92d,_0x9a02fb)=>{const _0x7b38ba=_0x34df31;_0x41147f&&sharpUtil[_0x7b38ba(0x126)](_0x4ee0ed),_0x19e632?(console[_0x7b38ba(0x109)](_0x7b38ba(0x12c),_0x19e632),_0x94d7e0()):_0x1a4638(_0x58f92d);});};function sharpImg(_0xa8bf07,_0x5e104e,_0x5a2d77,_0x5a26b9,_0x3673c1){const _0x1730e8=_0xba2782;sharpUtil[_0x1730e8(0x113)](_0xa8bf07,(_0x1e76e1,_0x262812,_0x434772)=>{const _0xe2096e=_0x1730e8;!_0x5e104e['width']&&!_0x5e104e[_0xe2096e(0xf6)]&&(_0x5e104e={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0xe2096e(0x11f)](_0x1e76e1,null,![],_0x5e104e,'file',_0x5a2d77,_0x5a26b9,_0x3673c1,_0x262812,_0x434772);});}sharpUtil[_0xba2782(0x11d)]=function(_0x483da1,_0x1eb3a3,_0x4e23f8,_0x86ce1,_0x267efc,_0x394fc8,_0x5a95a7,_0x105ed4){const _0x26aae9=_0xba2782;_0x105ed4&&(_0x105ed4=parseInt(_0x105ed4));let _0x14709c=path['join'](_0x1eb3a3,_0x4e23f8);if(_0x86ce1==_0x26aae9(0x11a)){let _0x59d194={};_0x267efc&&_0x267efc[_0x26aae9(0xe2)]&&_0x267efc[_0x26aae9(0xf6)]?_0x267efc[_0x26aae9(0xe2)]>_0x267efc[_0x26aae9(0xf6)]?_0x59d194[_0x26aae9(0xe2)]=_0x105ed4?_0x105ed4:0x258:_0x59d194[_0x26aae9(0xf6)]=_0x105ed4?_0x105ed4:0x258:(_0x59d194[_0x26aae9(0xe2)]=_0x105ed4,_0x59d194[_0x26aae9(0xf6)]=_0x105ed4),sharpImg(_0x483da1,_0x59d194,_0x14709c,_0x394fc8,_0x5a95a7);}else{if(_0x86ce1==_0x26aae9(0xf2)){let _0xda7b96=FFmpeg(transCodeUtil[_0x26aae9(0xdf)](_0x483da1),{'timeout':0x3c});_0xda7b96['on']('end',()=>{const _0x42e124=_0x26aae9;_0xda7b96['kill'](),_0x394fc8(path[_0x42e124(0x112)](_0x1eb3a3,_0x4e23f8));}),_0xda7b96['on'](_0x26aae9(0xe0),function(_0xdd4b85,_0x34341d,_0x26700c){const _0x57ac92=_0x26aae9;_0xda7b96[_0x57ac92(0x125)](),_0x5a95a7&&_0x5a95a7();}),_0xda7b96[_0x26aae9(0x10c)]({'timestamps':['10%'],'filename':_0x4e23f8,'folder':_0x1eb3a3,'size':_0x26aae9(0x10e)});}}},sharpUtil[_0xba2782(0xf7)]=function(_0x5c3775){return new Promise((_0x13453b,_0xda24b0)=>{const _0x5e526e=_0x5d50;let _0x4a3e54=new Worker(path[_0x5e526e(0xfe)](__dirname,_0x5e526e(0xec)),{'workerData':{'inputBuffer':_0x5c3775}}),_0x2345a3=setTimeout(()=>{const _0xd1553f=_0x5e526e;_0x4a3e54&&(console[_0xd1553f(0x109)](_0xd1553f(0x117)),_0x4a3e54['terminate'](),_0x4a3e54=null,_0xda24b0());},0x3a98);_0x4a3e54['on']('message',_0x1e8991=>{const _0x2a0f13=_0x5e526e;_0x1e8991[_0x2a0f13(0xe9)]==0x0&&(_0x2345a3&&clearTimeout(_0x2345a3),_0x13453b(_0x1e8991[_0x2a0f13(0x134)]));}),_0x4a3e54['on']('error',_0x577ba0=>{const _0x3e2914=_0x5e526e;console[_0x3e2914(0xe0)](_0x3e2914(0xdd),_0x577ba0),_0x4a3e54&&(_0x4a3e54[_0x3e2914(0xed)](),_0x4a3e54=null),_0xda24b0();}),_0x4a3e54['on'](_0x5e526e(0xfc),_0x90daea=>{const _0x3729cf=_0x5e526e;if(_0x90daea!==0x0)console['error'](_0x3729cf(0xf8),_0x90daea);else{}});});},sharpUtil[_0xba2782(0x107)]=function(_0xb7fc99,_0x5cfcb8,_0x57efa8){const _0x84672a=_0xba2782;if(_0xb7fc99)_0xb7fc99=_0xb7fc99[_0x84672a(0x10d)]();if(_0xb7fc99&&(_0xb7fc99=='.heic'||_0xb7fc99=='.heif'||_0xb7fc99=='.hif'))sharpUtil[_0x84672a(0xf7)](_0x5cfcb8)[_0x84672a(0xfa)](_0x2e2d78=>{_0x2e2d78?_0x57efa8(_0x2e2d78):_0x57efa8(_0x5cfcb8);})['catch'](()=>{_0x57efa8(_0x5cfcb8);});else{if(_0xb7fc99&&_0xb7fc99==_0x84672a(0x130))try{const _0x208e44=sharpBmp['decode'](_0x5cfcb8);_0x57efa8(_0x208e44);}catch(_0x2cb014){_0x57efa8(_0x5cfcb8);}else _0xb7fc99&&config[_0x84672a(0x118)][_0x84672a(0xe5)](_0xb7fc99[_0x84672a(0x10d)]())?extractThumbnailFromRaw(_0x5cfcb8,_0xb7fc99)[_0x84672a(0xfa)](_0x159e92=>{_0x57efa8(_0x159e92);})['catch'](_0x43a1e3=>{console['log']('raw\x20err1',_0x43a1e3),_0x57efa8(_0x5cfcb8);}):_0x57efa8(_0x5cfcb8);}},sharpUtil[_0xba2782(0x113)]=function(_0x4bef38,_0x365dcd){const _0x203f9d=_0xba2782;let _0x40f3ca=path[_0x203f9d(0x122)](_0x4bef38);if(_0x40f3ca)_0x40f3ca=_0x40f3ca['toLowerCase']();if(_0x40f3ca&&(_0x40f3ca==_0x203f9d(0xeb)||_0x40f3ca==_0x203f9d(0xfd)||_0x40f3ca==_0x203f9d(0x13a)))fs[_0x203f9d(0xe8)](_0x4bef38,(_0x3439f1,_0x4b743f)=>{const _0x4dc467=_0x203f9d;if(_0x3439f1)return _0x365dcd(_0x4bef38);sharpUtil[_0x4dc467(0xf7)](_0x4b743f)[_0x4dc467(0xfa)](_0x1fd901=>{_0x1fd901?_0x365dcd(_0x1fd901):_0x365dcd(_0x4b743f);})[_0x4dc467(0x135)](()=>{_0x365dcd(_0x4b743f);});});else{if(_0x40f3ca&&_0x40f3ca==_0x203f9d(0x130))console[_0x203f9d(0x109)]('正在处理bmp',_0x4bef38),fs[_0x203f9d(0xe8)](_0x4bef38,(_0x3229b8,_0x41c6b2)=>{const _0x967041=_0x203f9d;if(_0x3229b8)console[_0x967041(0x109)](_0x3229b8),_0x365dcd(_0x4bef38);else try{const _0x3e3592=sharpBmp['decode'](_0x41c6b2);_0x365dcd(_0x3e3592);}catch(_0x50d800){_0x365dcd(_0x4bef38);}});else{if(_0x40f3ca&&config[_0x203f9d(0x118)]['includes'](_0x40f3ca[_0x203f9d(0x10d)]()))try{extractThumbnailFromRaw(_0x4bef38,_0x40f3ca)['then'](_0x8241b9=>{_0x365dcd(_0x8241b9);})[_0x203f9d(0x135)](_0x314ebb=>{const _0x33e1df=_0x203f9d;console[_0x33e1df(0x109)](_0x314ebb),_0x365dcd(_0x4bef38);});}catch(_0x46a2a4){console['log'](_0x46a2a4),_0x365dcd(_0x4bef38);}else _0x365dcd(_0x4bef38);}}},sharpUtil['returnDealedImage']=function(_0x46b005,_0x1c43be,_0x52fc0a,_0x3b7433){const _0x82a619=_0xba2782;sharpUtil[_0x82a619(0x113)](_0x1c43be,(_0x5d0c0d,_0xda9136,_0x408b67)=>{const _0x2a85dd=_0x82a619;sharpUtil[_0x2a85dd(0x11f)](_0x5d0c0d,_0x2a85dd(0x11c),!![],_0x52fc0a,'buffer',null,_0x491a61=>{const _0x1389cd=_0x2a85dd;_0x46b005[_0x1389cd(0x136)](Buffer[_0x1389cd(0xe6)](_0x491a61));},()=>{_0x46b005['status'](0x194)['end']();},_0xda9136,_0x408b67,_0x3b7433);});},sharpUtil[_0xba2782(0xde)]=function(_0x2dd531){const _0x58d13a=_0xba2782;return config['heicExt'][_0x58d13a(0xe5)](_0x2dd531)||config[_0x58d13a(0x118)][_0x58d13a(0xe5)](_0x2dd531['toLowerCase']())||_0x2dd531==_0x58d13a(0x130)||_0x2dd531==_0x58d13a(0x104)?!![]:![];},sharpUtil[_0xba2782(0x120)]=function(_0x21b25d){const _0x1e8ee1=_0xba2782;let _0x2022cd=path[_0x1e8ee1(0x122)](_0x21b25d)?path[_0x1e8ee1(0x122)](_0x21b25d)[_0x1e8ee1(0x10d)]():null;if(!_0x2022cd)return![];return sharpUtil['ifExtIsSpecialFormat'](_0x2022cd);},sharpUtil['returnDealedFile']=function(_0x3e7311,_0x215d78,_0x3fb6a9,_0x573f33,_0x56cb7e){const _0x5e4c6f=_0xba2782;if(sharpUtil['ifImageIsSpecialFormat'](_0x215d78)||_0x573f33||_0x56cb7e){let _0x5dad34=null,_0x2e3f37=null;return _0x573f33&&_0x573f33>=0x64&&_0x573f33<=0x186a0&&(_0x5dad34={'fit':_0x5e4c6f(0xe7),'width':parseInt(_0x573f33),'height':parseInt(_0x573f33),'withoutEnlargement':!![]}),_0x56cb7e&&_0x56cb7e>=0x1e&&_0x56cb7e<=0x64&&(_0x2e3f37={'quality':parseInt(_0x56cb7e)}),sharpUtil[_0x5e4c6f(0x128)](_0x3e7311,_0x215d78,_0x5dad34,_0x2e3f37);}else{if(_0x3fb6a9){const _0x401c10=encodeURIComponent(path[_0x5e4c6f(0x12d)](_0x215d78))[_0x5e4c6f(0x138)](/%([0-9A-F]{2})/g,(_0x3357e3,_0x270ebe)=>'%'+_0x270ebe[_0x5e4c6f(0x101)]());_0x3e7311['setHeader']('Content-Disposition','attachment;\x20filename*=UTF-8\x27\x27'+_0x401c10);}_0x3e7311[_0x5e4c6f(0x10b)](_0x215d78);}},module[_0xba2782(0xf3)]=sharpUtil;function _0x51e0(){const _0x16706c=['sharp\x20err1:','width','withMetadata','saveAsPng','includes','from','inside','readFile','code','cachePath','.heic','../../myWorkers/transHeicWorker.js','terminate','../../libs/nasTrans','sharp-bmp','toBuffer','sha256','video','exports','.psd','158050JxuDNV','height','runTransHeicWorker','Worker\x20stopped\x20with\x20exit\x20code:','parse','then','414baOhGm','exit','.heif','resolve','data','../../utils/transCodeUtil','toUpperCase','getSharpInstanceFromInput','5xjesvf','.tiff','../../myConfig/config','223pIMbSj','transSpcielFormatFromBuffer','91kMTAtU','log','3458520WjrPHl','sendFile','screenshots','toLowerCase','600x?','webp','rotate','stat','join','transSpcielFormat','3541353zAieGC','worker_threads','path','已超时\x20结束处理worker','rawImgTypeList','dcraw','image','38121556fcQaaG','jpeg','genTinyFile','psd','sharpDealImg','ifImageIsSpecialFormat','fromFile','extname','type','libheif-js/wasm-bundle','kill','deleteRawTempFile','tempFilePath','returnDealedImage','string','4738GayGqX','dcraw导入失败','sharp\x20err2:','basename','773624CNgkgU','psd\x20error\x202','.bmp','_psd.png','startsWith','12IxAlUm','output','catch','send','FFmpeg','replace','处理完成,删除临时文件','.hif','psd导入失败','getRotateFromTags','sharp\x20deal\x20psd\x20png\x20error\x201','4284148cpMhuw','Worker\x20error:','ifExtIsSpecialFormat','dealFFmpegPath','error'];_0x51e0=function(){return _0x16706c;};return _0x51e0();}