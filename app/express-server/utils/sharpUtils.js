const _0x2fb59d=_0x9e92;(function(_0x13a65f,_0x5eaf2d){const _0x179f49=_0x9e92,_0x14a80e=_0x13a65f();while(!![]){try{const _0x5b9f68=parseInt(_0x179f49(0x109))/0x1+-parseInt(_0x179f49(0x113))/0x2*(parseInt(_0x179f49(0x130))/0x3)+-parseInt(_0x179f49(0xe7))/0x4+-parseInt(_0x179f49(0x12a))/0x5+-parseInt(_0x179f49(0x12e))/0x6+-parseInt(_0x179f49(0x12f))/0x7+parseInt(_0x179f49(0xf9))/0x8;if(_0x5b9f68===_0x5eaf2d)break;else _0x14a80e['push'](_0x14a80e['shift']());}catch(_0x16e4be){_0x14a80e['push'](_0x14a80e['shift']());}}}(_0x1187,0x2a1d4));let path=require(_0x2fb59d(0x11c)),fs=require('fs'),FFmpeg=require(_0x2fb59d(0x118))[_0x2fb59d(0x10c)],sharpUtil={};const sharp=require(_0x2fb59d(0xfd)),libheif=require(_0x2fb59d(0xee)),config=require('../../myConfig/config'),transCodeUtil=require(_0x2fb59d(0x10e)),sharpBmp=require(_0x2fb59d(0xcf));let sha256=require(_0x2fb59d(0xf3));const {Worker}=require('worker_threads');let dcraw;function getDcraw(){if(!dcraw)try{return dcraw=require('dcraw'),dcraw;}catch(_0x1e3c85){return console['log']('dcraw导入失败'),null;}else return dcraw;}let PSD;function getPsd(){const _0xdc3cb8=_0x2fb59d;if(!PSD)try{return PSD=require(_0xdc3cb8(0xec)),PSD;}catch(_0x483ded){return console[_0xdc3cb8(0x11a)](_0xdc3cb8(0x10b)),null;}else return PSD;}function extractThumbnailFromRaw(_0x5036ff,_0x1a0ec7){return new Promise((_0x29d6a2,_0x2fec30)=>{const _0x577400=_0x9e92;if(_0x1a0ec7&&_0x1a0ec7[_0x577400(0x114)]()==_0x577400(0x117)){let _0x34b80a=getPsd();if(!_0x34b80a)return _0x2fec30(null);try{if(typeof _0x5036ff==_0x577400(0x110)){let _0x569ff5=path[_0x577400(0xe1)](config[_0x577400(0x12c)],sha256(_0x5036ff)+_0x577400(0xf8));fs['stat'](_0x569ff5,(_0x24cb64,_0xc17d15)=>{const _0x22c439=_0x577400;try{if(_0x24cb64){let _0x310595=_0x34b80a['fromFile'](_0x5036ff);_0x310595[_0x22c439(0xd1)](),_0x310595[_0x22c439(0xe8)][_0x22c439(0x115)](_0x569ff5)['then'](()=>{const _0x2dcab2=_0x22c439;sharp(_0x569ff5)[_0x2dcab2(0x111)]({'quality':0x4d})['toBuffer']()[_0x2dcab2(0xe9)](_0x30b21a=>{fs['writeFile'](_0x569ff5,_0x30b21a,_0x21c8b6=>{if(_0x21c8b6)return _0x2fec30(null);_0x29d6a2(_0x569ff5);});})[_0x2dcab2(0xde)](_0x2bfc4f=>{const _0x2d0ecc=_0x2dcab2;return console[_0x2d0ecc(0x11a)](_0x2d0ecc(0x104),_0x2bfc4f),_0x2fec30(null);});})[_0x22c439(0xde)](_0xa364ac=>{const _0x327010=_0x22c439;return console[_0x327010(0x11a)](_0x327010(0xd8),_0xa364ac),_0x2fec30(null);});}else return _0x29d6a2(_0x569ff5);}catch(_0x2e126f){return console[_0x22c439(0x11a)](_0x22c439(0x107),_0x2e126f),_0x2fec30(null);}});}else return _0x2fec30(null);}catch(_0x343d78){return _0x2fec30(null);}}else{let _0x20f94b=getDcraw();if(!_0x20f94b)return _0x2fec30(null);function _0x4e3c0b(_0x362eda){try{const _0x2dc063=_0x20f94b(_0x362eda,{'extractThumbnail':!![],'identify':!![]});return _0x2dc063?_0x29d6a2(_0x2dc063):_0x2fec30(null);}catch(_0xe94cb7){return _0x2fec30(null);}}if(typeof _0x5036ff=='string')fs[_0x577400(0xcd)](_0x5036ff,(_0x1beb8d,_0x2df105)=>{const _0xeb155c=_0x577400;if(_0x1beb8d)return console[_0xeb155c(0x11a)]('读取失败',_0x5036ff),_0x2fec30(_0x1beb8d);_0x4e3c0b(_0x2df105);});else{if(Buffer['isBuffer'](_0x5036ff))_0x4e3c0b(_0x5036ff);else return _0x2fec30(null);}}});}const exifUtils=require(_0x2fb59d(0xe6));sharpUtil[_0x2fb59d(0xce)]=function(_0x4db617){const _0xff7c9d=_0x2fb59d;_0x4db617[_0xff7c9d(0xdf)]==_0xff7c9d(0x102)&&(_0x4db617=Buffer[_0xff7c9d(0x127)](_0x4db617));let _0x1e0558={'failOnError':![]};return _0x4db617[_0xff7c9d(0x112)]&&_0x4db617[_0xff7c9d(0x128)]&&_0x4db617[_0xff7c9d(0x129)]&&(_0x1e0558[_0xff7c9d(0x103)]={'width':_0x4db617[_0xff7c9d(0x112)],'height':_0x4db617['height'],'channels':0x4},_0x4db617=_0x4db617[_0xff7c9d(0x129)]),sharp(_0x4db617,_0x1e0558);},sharpUtil['deleteRawTempFile']=function(_0x5b45df){const _0x545946=_0x2fb59d;typeof _0x5b45df=='string'&&_0x5b45df[_0x545946(0xe4)](config['tempFilePath'])&&fs['rm'](_0x5b45df,_0x23feca=>{});},sharpUtil[_0x2fb59d(0xdb)]=function(_0x1195c9,_0xa2e889,_0x40e4ac,_0xbe9f81,_0x3fa358,_0x2f9955,_0x599331,_0x3e3276,_0x48ddd1,_0x59d0bb,_0xa497ce){const _0x129f35=_0x2fb59d;if(!_0x1195c9)return _0x599331(null);let _0x1c0132=sharpUtil[_0x129f35(0xce)](_0x1195c9);_0xa2e889=='jpeg'?_0xa497ce?_0x1c0132=_0x1c0132['jpeg'](_0xa497ce):_0x1c0132=_0x1c0132[_0x129f35(0x111)]():_0x1c0132=_0x1c0132[_0x129f35(0x124)]({});_0x40e4ac&&(_0x1c0132=_0x1c0132[_0x129f35(0xf6)]());let _0x1bdcee=exifUtils['getRotateFromTags'](_0x59d0bb);_0x1bdcee?_0x1c0132=_0x1c0132[_0x129f35(0x10f)](_0x1bdcee):_0x1c0132=_0x1c0132['rotate']();_0xbe9f81&&(_0x1c0132=_0x1c0132[_0x129f35(0x106)](_0xbe9f81));if(_0x3fa358==_0x129f35(0xda))_0x1c0132[_0x129f35(0x125)](_0x2f9955,(_0x2369a8,_0x4d6413)=>{const _0x4b4ffc=_0x129f35;_0x48ddd1&&(console['log'](_0x4b4ffc(0x126),_0x1195c9),sharpUtil[_0x4b4ffc(0x11d)](_0x1195c9)),_0x2369a8?(console[_0x4b4ffc(0x11a)]('sharp\x20err1:',_0x1195c9,_0x2369a8),_0x3e3276()):_0x599331(_0x2f9955);});else _0x3fa358=='buffer'&&_0x1c0132[_0x129f35(0xe0)]((_0x25d907,_0x3524b1,_0x2ffe1d)=>{const _0x3993b2=_0x129f35;_0x48ddd1&&sharpUtil[_0x3993b2(0x11d)](_0x1195c9),_0x25d907?(console[_0x3993b2(0x11a)](_0x3993b2(0xdc),_0x25d907),_0x3e3276()):_0x599331(_0x3524b1);});};function _0x1187(){const _0x1bf5ec=['exit','terminate','Worker\x20stopped\x20with\x20exit\x20code:','heicExt','Buffer','raw','sharp\x20deal\x20psd\x20png\x20error\x201','genTinyFile','resize','psd\x20error\x202','basename','51693UJwjZU','replace','psd导入失败','FFmpeg','send','../../utils/transCodeUtil','rotate','string','jpeg','width','61082PoWAdh','toLowerCase','saveAsPng','rawImgTypeList','.psd','../../libs/nasTrans','raw\x20err1','log','ifImageIsSpecialFormat','path','deleteRawTempFile','10%','.heif','kill','attachment;\x20filename*=UTF-8\x27\x27','.hif','output','webp','toFile','处理完成,删除临时文件','from','height','data','508175rxcGqY','../../myWorkers/transHeicWorker.js','cachePath','extname','126282IicqYa','113365cRtZAC','21yJKwAH','readFile','getSharpInstanceFromInput','sharp-bmp','正在处理bmp','parse','sendFile','runTransHeicWorker','message','error','decode','buffer','psd\x20error\x201','end','file','sharpDealImg','sharp\x20err2:','transSpcielFormatFromBuffer','catch','type','toBuffer','join','code','returnDealedImage','startsWith','.heic','../../utils/exifUtils','1282576EtmOMW','image','then','includes','ifExtIsSpecialFormat','psd','returnDealedFile','libheif-js/wasm-bundle','600x?','dealFFmpegPath','setHeader','screenshots','sha256','toUpperCase','Worker\x20error:','withMetadata','transSpcielFormat','_psd.png','6352920bQsvjo','.tiff','.bmp','inside','sharp'];_0x1187=function(){return _0x1bf5ec;};return _0x1187();}function sharpImg(_0x559474,_0x441ff3,_0x5570de,_0x2d7e3a,_0x2c115c){const _0x685892=_0x2fb59d;sharpUtil[_0x685892(0xf7)](_0x559474,(_0x348d8b,_0x1e06c8,_0x2d8072)=>{const _0x2a2a33=_0x685892;!_0x441ff3[_0x2a2a33(0x112)]&&!_0x441ff3[_0x2a2a33(0x128)]&&(_0x441ff3={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x2a2a33(0xdb)](_0x348d8b,null,![],_0x441ff3,_0x2a2a33(0xda),_0x5570de,_0x2d7e3a,_0x2c115c,_0x1e06c8,_0x2d8072);});}function _0x9e92(_0x56c7f1,_0x1cc50e){const _0x1187ac=_0x1187();return _0x9e92=function(_0x9e922e,_0x23a1d1){_0x9e922e=_0x9e922e-0xcd;let _0x47e5ce=_0x1187ac[_0x9e922e];return _0x47e5ce;},_0x9e92(_0x56c7f1,_0x1cc50e);}sharpUtil[_0x2fb59d(0x105)]=function(_0x487026,_0x506157,_0x14f8eb,_0x2874c8,_0x36f2ee,_0x5c8a58,_0x14a6d1,_0x106175){const _0x54408d=_0x2fb59d;_0x106175&&(_0x106175=parseInt(_0x106175));let _0x357a62=path[_0x54408d(0xe1)](_0x506157,_0x14f8eb);if(_0x2874c8==_0x54408d(0xe8)){let _0x375c0a={};_0x36f2ee&&_0x36f2ee[_0x54408d(0x112)]&&_0x36f2ee[_0x54408d(0x128)]?_0x36f2ee[_0x54408d(0x112)]>_0x36f2ee[_0x54408d(0x128)]?_0x375c0a['width']=_0x106175?_0x106175:0x258:_0x375c0a[_0x54408d(0x128)]=_0x106175?_0x106175:0x258:(_0x375c0a[_0x54408d(0x112)]=_0x106175,_0x375c0a[_0x54408d(0x128)]=_0x106175),sharpImg(_0x487026,_0x375c0a,_0x357a62,_0x5c8a58,_0x14a6d1);}else{if(_0x2874c8=='video'){let _0x55455b=FFmpeg(transCodeUtil[_0x54408d(0xf0)](_0x487026),{'timeout':0x3c});_0x55455b['on']('end',()=>{_0x55455b['kill'](),_0x5c8a58(path['join'](_0x506157,_0x14f8eb));}),_0x55455b['on'](_0x54408d(0xd5),function(_0x5ad591,_0x4d1cec,_0x190bbd){const _0x45c32a=_0x54408d;_0x55455b[_0x45c32a(0x120)](),_0x14a6d1&&_0x14a6d1();}),_0x55455b[_0x54408d(0xf2)]({'timestamps':[_0x54408d(0x11e)],'filename':_0x14f8eb,'folder':_0x506157,'size':_0x54408d(0xef)});}}},sharpUtil[_0x2fb59d(0xd3)]=function(_0x207a49){return new Promise((_0x291894,_0x6377cf)=>{const _0x342a3c=_0x9e92;let _0x13a360=new Worker(path['resolve'](__dirname,_0x342a3c(0x12b)),{'workerData':{'inputBuffer':_0x207a49}}),_0x25a35f=setTimeout(()=>{const _0x1f35a7=_0x342a3c;_0x13a360&&(console[_0x1f35a7(0x11a)]('已超时\x20结束处理worker'),_0x13a360[_0x1f35a7(0xff)](),_0x13a360=null,_0x6377cf());},0x3a98);_0x13a360['on'](_0x342a3c(0xd4),_0x25aa44=>{const _0xf91899=_0x342a3c;_0x25aa44[_0xf91899(0xe2)]==0x0&&(_0x25a35f&&clearTimeout(_0x25a35f),_0x291894(_0x25aa44[_0xf91899(0x123)]));}),_0x13a360['on'](_0x342a3c(0xd5),_0x298f74=>{const _0x54fb6e=_0x342a3c;console[_0x54fb6e(0xd5)](_0x54fb6e(0xf5),_0x298f74),_0x13a360&&(_0x13a360[_0x54fb6e(0xff)](),_0x13a360=null),_0x6377cf();}),_0x13a360['on'](_0x342a3c(0xfe),_0x1f551c=>{const _0x12507e=_0x342a3c;if(_0x1f551c!==0x0)console[_0x12507e(0xd5)](_0x12507e(0x100),_0x1f551c);else{}});});},sharpUtil[_0x2fb59d(0xdd)]=function(_0x3382ac,_0x2babfe,_0x50c195){const _0x19cc86=_0x2fb59d;if(_0x3382ac)_0x3382ac=_0x3382ac[_0x19cc86(0x114)]();if(_0x3382ac&&(_0x3382ac=='.heic'||_0x3382ac==_0x19cc86(0x11f)||_0x3382ac==_0x19cc86(0x122)))sharpUtil[_0x19cc86(0xd3)](_0x2babfe)[_0x19cc86(0xe9)](_0x263a17=>{_0x263a17?_0x50c195(_0x263a17):_0x50c195(_0x2babfe);})[_0x19cc86(0xde)](()=>{_0x50c195(_0x2babfe);});else{if(_0x3382ac&&_0x3382ac==_0x19cc86(0xfb))try{const _0x5f5c9b=sharpBmp[_0x19cc86(0xd6)](_0x2babfe);_0x50c195(_0x5f5c9b);}catch(_0x9358bd){_0x50c195(_0x2babfe);}else _0x3382ac&&config[_0x19cc86(0x116)][_0x19cc86(0xea)](_0x3382ac[_0x19cc86(0x114)]())?extractThumbnailFromRaw(_0x2babfe,_0x3382ac)[_0x19cc86(0xe9)](_0xae1062=>{_0x50c195(_0xae1062);})[_0x19cc86(0xde)](_0x24d444=>{const _0x58952a=_0x19cc86;console[_0x58952a(0x11a)](_0x58952a(0x119),_0x24d444),_0x50c195(_0x2babfe);}):_0x50c195(_0x2babfe);}},sharpUtil[_0x2fb59d(0xf7)]=function(_0x2a14fd,_0x36ee12){const _0x722356=_0x2fb59d;let _0x9e4034=path[_0x722356(0x12d)](_0x2a14fd);if(_0x9e4034)_0x9e4034=_0x9e4034['toLowerCase']();if(_0x9e4034&&(_0x9e4034==_0x722356(0xe5)||_0x9e4034==_0x722356(0x11f)||_0x9e4034==_0x722356(0x122)))fs[_0x722356(0xcd)](_0x2a14fd,(_0x3393df,_0x3e785b)=>{const _0x470854=_0x722356;if(_0x3393df)return _0x36ee12(_0x2a14fd);sharpUtil[_0x470854(0xd3)](_0x3e785b)['then'](_0x5adf66=>{_0x5adf66?_0x36ee12(_0x5adf66):_0x36ee12(_0x3e785b);})['catch'](()=>{_0x36ee12(_0x3e785b);});});else{if(_0x9e4034&&_0x9e4034==_0x722356(0xfb))console[_0x722356(0x11a)](_0x722356(0xd0),_0x2a14fd),fs[_0x722356(0xcd)](_0x2a14fd,(_0x2c86d3,_0x20ee6c)=>{const _0x8f5cc9=_0x722356;if(_0x2c86d3)console[_0x8f5cc9(0x11a)](_0x2c86d3),_0x36ee12(_0x2a14fd);else try{const _0x16d369=sharpBmp[_0x8f5cc9(0xd6)](_0x20ee6c);_0x36ee12(_0x16d369);}catch(_0x41f6bb){_0x36ee12(_0x2a14fd);}});else{if(_0x9e4034&&config['rawImgTypeList'][_0x722356(0xea)](_0x9e4034[_0x722356(0x114)]()))try{extractThumbnailFromRaw(_0x2a14fd,_0x9e4034)[_0x722356(0xe9)](_0x428bdb=>{_0x36ee12(_0x428bdb);})['catch'](_0x52a950=>{const _0x572c52=_0x722356;console[_0x572c52(0x11a)](_0x52a950),_0x36ee12(_0x2a14fd);});}catch(_0x11236b){console[_0x722356(0x11a)](_0x11236b),_0x36ee12(_0x2a14fd);}else _0x36ee12(_0x2a14fd);}}},sharpUtil[_0x2fb59d(0xe3)]=function(_0x53065f,_0x39d328,_0x54f51b,_0x5ebcec){const _0xde2ccf=_0x2fb59d;sharpUtil[_0xde2ccf(0xf7)](_0x39d328,(_0x59d0f7,_0x1942ac,_0x49e921)=>{const _0x242c97=_0xde2ccf;sharpUtil[_0x242c97(0xdb)](_0x59d0f7,_0x242c97(0x111),!![],_0x54f51b,_0x242c97(0xd7),null,_0x390822=>{const _0x197242=_0x242c97;_0x53065f[_0x197242(0x10d)](Buffer[_0x197242(0x127)](_0x390822));},()=>{const _0x2a811f=_0x242c97;_0x53065f['status'](0x194)[_0x2a811f(0xd9)]();},_0x1942ac,_0x49e921,_0x5ebcec);});},sharpUtil[_0x2fb59d(0xeb)]=function(_0x433ed6){const _0x3b25a3=_0x2fb59d;return config[_0x3b25a3(0x101)][_0x3b25a3(0xea)](_0x433ed6)||config[_0x3b25a3(0x116)]['includes'](_0x433ed6[_0x3b25a3(0x114)]())||_0x433ed6==_0x3b25a3(0xfb)||_0x433ed6==_0x3b25a3(0xfa)?!![]:![];},sharpUtil['ifImageIsSpecialFormat']=function(_0xdd03a5){const _0x21dd18=_0x2fb59d;let _0xbb9d7d=path[_0x21dd18(0x12d)](_0xdd03a5)?path[_0x21dd18(0x12d)](_0xdd03a5)[_0x21dd18(0x114)]():null;if(!_0xbb9d7d)return![];return sharpUtil[_0x21dd18(0xeb)](_0xbb9d7d);},sharpUtil[_0x2fb59d(0xed)]=function(_0xe86da4,_0x53931f,_0x1bf8ce,_0x508586,_0x4d2095){const _0xb1db30=_0x2fb59d;if(sharpUtil[_0xb1db30(0x11b)](_0x53931f)||_0x508586||_0x4d2095){let _0x3fd8de=null,_0x5a9b2d=null;return _0x508586&&_0x508586>=0x64&&_0x508586<=0x186a0&&(_0x3fd8de={'fit':_0xb1db30(0xfc),'width':parseInt(_0x508586),'height':parseInt(_0x508586),'withoutEnlargement':!![]}),_0x4d2095&&_0x4d2095>=0x1e&&_0x4d2095<=0x64&&(_0x5a9b2d={'quality':parseInt(_0x4d2095)}),sharpUtil[_0xb1db30(0xe3)](_0xe86da4,_0x53931f,_0x3fd8de,_0x5a9b2d);}else{if(_0x1bf8ce){const _0x2cae54=encodeURIComponent(path[_0xb1db30(0x108)](_0x53931f))[_0xb1db30(0x10a)](/%([0-9A-F]{2})/g,(_0x7c74ec,_0xd5959)=>'%'+_0xd5959[_0xb1db30(0xf4)]());_0xe86da4[_0xb1db30(0xf1)]('Content-Disposition',_0xb1db30(0x121)+_0x2cae54);}_0xe86da4[_0xb1db30(0xd2)](_0x53931f);}},module['exports']=sharpUtil;