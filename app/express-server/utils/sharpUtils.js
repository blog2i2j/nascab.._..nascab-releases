const _0x127e55=_0x2802;(function(_0x2b4a03,_0x4cc7ac){const _0x2fb9ae=_0x2802,_0x2ea4ee=_0x2b4a03();while(!![]){try{const _0x447e39=-parseInt(_0x2fb9ae(0x200))/0x1*(parseInt(_0x2fb9ae(0x206))/0x2)+parseInt(_0x2fb9ae(0x204))/0x3+parseInt(_0x2fb9ae(0x202))/0x4+-parseInt(_0x2fb9ae(0x1c6))/0x5+parseInt(_0x2fb9ae(0x1d5))/0x6*(parseInt(_0x2fb9ae(0x1c9))/0x7)+-parseInt(_0x2fb9ae(0x1f1))/0x8+parseInt(_0x2fb9ae(0x1e8))/0x9;if(_0x447e39===_0x4cc7ac)break;else _0x2ea4ee['push'](_0x2ea4ee['shift']());}catch(_0x109caa){_0x2ea4ee['push'](_0x2ea4ee['shift']());}}}(_0x5308,0x9459e));let path=require(_0x127e55(0x1e7)),fs=require('fs'),FFmpeg=require('../../libs/nasTrans')[_0x127e55(0x20c)],sharpUtil={};const sharp=require(_0x127e55(0x1f8)),libheif=require(_0x127e55(0x1ec)),config=require('../../myConfig/config'),transCodeUtil=require(_0x127e55(0x1bd)),sharpBmp=require('sharp-bmp');let sha256=require(_0x127e55(0x1f4));const {Worker}=require(_0x127e55(0x1c3));let dcraw;function getDcraw(){const _0x260c58=_0x127e55;if(!dcraw)try{return dcraw=require(_0x260c58(0x1b2)),dcraw;}catch(_0x3768fc){return console['log'](_0x260c58(0x1b6)),null;}else return dcraw;}let PSD;function _0x5308(){const _0x24ed31=['terminate','exports','resize','1VMsAAN','rawImgTypeList','2691332rkLIRz','replace','3349797iyFpbU','basename','265740ugarxQ','.hif','catch','dealFFmpegPath','file','transSpcielFormat','FFmpeg','raw\x20err1','fromFile','dcraw','jpeg','10%','rotate','dcraw导入失败','toUpperCase','kill','psd\x20error\x201','exit','toFile','getRotateFromTags','../../utils/transCodeUtil','ifExtIsSpecialFormat','parse','runTransHeicWorker','data','extname','worker_threads','heicExt','image','399515tcNedL','psd\x20error\x202','cachePath','52843juxJxh','writeFile','.tiff','type','message','psd','webp','stat','string','resolve','toLowerCase','readFile','138zWjahu','_psd.png','join','.bmp','screenshots','genTinyFile','.heic','../../myWorkers/transHeicWorker.js','toBuffer','code','transSpcielFormatFromBuffer','video','then','height','log','returnDealedImage','sharp\x20err1:','sharp\x20deal\x20psd\x20png\x20error\x201','path','204984YszlgH','sharpDealImg','ifImageIsSpecialFormat','width','libheif-js/wasm-bundle','Worker\x20stopped\x20with\x20exit\x20code:','deleteRawTempFile','startsWith','output','9323328DCkIbr','includes','error','sha256','buffer','.psd','处理完成,删除临时文件','sharp','Worker\x20error:','end','sharp\x20err2:','.heif'];_0x5308=function(){return _0x24ed31;};return _0x5308();}function getPsd(){const _0x11c3d3=_0x127e55;if(!PSD)try{return PSD=require(_0x11c3d3(0x1ce)),PSD;}catch(_0x3a4690){return console[_0x11c3d3(0x1e3)]('psd导入失败'),null;}else return PSD;}function extractThumbnailFromRaw(_0x10bc42,_0x1d2279){return new Promise((_0x31b8fa,_0x84a514)=>{const _0x5be68e=_0x2802;if(_0x1d2279&&_0x1d2279[_0x5be68e(0x1d3)]()==_0x5be68e(0x1f6)){let _0x423429=getPsd();if(!_0x423429)return _0x84a514(null);try{if(typeof _0x10bc42==_0x5be68e(0x1d1)){let _0x15ee9d=path[_0x5be68e(0x1d7)](config[_0x5be68e(0x1c8)],sha256(_0x10bc42)+_0x5be68e(0x1d6));fs[_0x5be68e(0x1d0)](_0x15ee9d,(_0x3d5f8e,_0x3997e7)=>{const _0x18aeeb=_0x5be68e;try{if(_0x3d5f8e){let _0x571400=_0x423429[_0x18aeeb(0x20e)](_0x10bc42);_0x571400[_0x18aeeb(0x1bf)](),_0x571400['image']['saveAsPng'](_0x15ee9d)[_0x18aeeb(0x1e1)](()=>{const _0x25a3ad=_0x18aeeb;sharp(_0x15ee9d)[_0x25a3ad(0x1b3)]({'quality':0x4d})[_0x25a3ad(0x1dd)]()[_0x25a3ad(0x1e1)](_0x131d9d=>{const _0x33fb54=_0x25a3ad;fs[_0x33fb54(0x1ca)](_0x15ee9d,_0x131d9d,_0x59ab01=>{if(_0x59ab01)return _0x84a514(null);_0x31b8fa(_0x15ee9d);});})[_0x25a3ad(0x208)](_0x3c6d13=>{const _0x17241e=_0x25a3ad;return console[_0x17241e(0x1e3)](_0x17241e(0x1e6),_0x3c6d13),_0x84a514(null);});})[_0x18aeeb(0x208)](_0x530819=>{const _0x5426c9=_0x18aeeb;return console[_0x5426c9(0x1e3)](_0x5426c9(0x1b9),_0x530819),_0x84a514(null);});}else return _0x31b8fa(_0x15ee9d);}catch(_0x17ad67){return console[_0x18aeeb(0x1e3)](_0x18aeeb(0x1c7),_0x17ad67),_0x84a514(null);}});}else return _0x84a514(null);}catch(_0x3842fe){return _0x84a514(null);}}else{let _0x293c8c=getDcraw();if(!_0x293c8c)return _0x84a514(null);function _0x1ea383(_0x1f432c){try{const _0x18dd28=_0x293c8c(_0x1f432c,{'extractThumbnail':!![],'identify':!![]});return _0x18dd28?_0x31b8fa(_0x18dd28):_0x84a514(null);}catch(_0x78f5ff){return _0x84a514(null);}}if(typeof _0x10bc42==_0x5be68e(0x1d1))fs[_0x5be68e(0x1d4)](_0x10bc42,(_0x28a271,_0x5a93e6)=>{const _0x5b14cf=_0x5be68e;if(_0x28a271)return console[_0x5b14cf(0x1e3)]('读取失败',_0x10bc42),_0x84a514(_0x28a271);_0x1ea383(_0x5a93e6);});else{if(Buffer['isBuffer'](_0x10bc42))_0x1ea383(_0x10bc42);else return _0x84a514(null);}}});}const exifUtils=require('../../utils/exifUtils');sharpUtil['getSharpInstanceFromInput']=function(_0x3f5c84){const _0xaabe75=_0x127e55;_0x3f5c84[_0xaabe75(0x1cc)]=='Buffer'&&(_0x3f5c84=Buffer['from'](_0x3f5c84));let _0x54102f={'failOnError':![]};return _0x3f5c84[_0xaabe75(0x1eb)]&&_0x3f5c84[_0xaabe75(0x1e2)]&&_0x3f5c84[_0xaabe75(0x1c1)]&&(_0x54102f['raw']={'width':_0x3f5c84[_0xaabe75(0x1eb)],'height':_0x3f5c84[_0xaabe75(0x1e2)],'channels':0x4},_0x3f5c84=_0x3f5c84[_0xaabe75(0x1c1)]),sharp(_0x3f5c84,_0x54102f);},sharpUtil[_0x127e55(0x1ee)]=function(_0x3b42f5){const _0x3ebfa4=_0x127e55;typeof _0x3b42f5==_0x3ebfa4(0x1d1)&&_0x3b42f5[_0x3ebfa4(0x1ef)](config['tempFilePath'])&&fs['rm'](_0x3b42f5,_0x8040a1=>{});},sharpUtil[_0x127e55(0x1e9)]=function(_0x394f17,_0x49c6ba,_0x3a9714,_0x4c40b7,_0x37faf2,_0x24617d,_0x490f56,_0x44be2e,_0x5540c2,_0x11f5e5,_0x545cf2){const _0x5c79f5=_0x127e55;if(!_0x394f17)return _0x490f56(null);let _0x2bceb0=sharpUtil['getSharpInstanceFromInput'](_0x394f17);_0x49c6ba==_0x5c79f5(0x1b3)?_0x545cf2?_0x2bceb0=_0x2bceb0[_0x5c79f5(0x1b3)](_0x545cf2):_0x2bceb0=_0x2bceb0['jpeg']():_0x2bceb0=_0x2bceb0[_0x5c79f5(0x1cf)]({});_0x3a9714&&(_0x2bceb0=_0x2bceb0['withMetadata']());let _0x548a52=exifUtils[_0x5c79f5(0x1bc)](_0x11f5e5);_0x548a52?_0x2bceb0=_0x2bceb0[_0x5c79f5(0x1b5)](_0x548a52):_0x2bceb0=_0x2bceb0[_0x5c79f5(0x1b5)]();_0x4c40b7&&(_0x2bceb0=_0x2bceb0[_0x5c79f5(0x1ff)](_0x4c40b7));if(_0x37faf2==_0x5c79f5(0x20a))_0x2bceb0[_0x5c79f5(0x1bb)](_0x24617d,(_0xb165ca,_0x1c5d58)=>{const _0x448b82=_0x5c79f5;_0x5540c2&&(console['log'](_0x448b82(0x1f7),_0x394f17),sharpUtil['deleteRawTempFile'](_0x394f17)),_0xb165ca?(console[_0x448b82(0x1e3)](_0x448b82(0x1e5),_0x394f17,_0xb165ca),_0x44be2e()):_0x490f56(_0x24617d);});else _0x37faf2==_0x5c79f5(0x1f5)&&_0x2bceb0[_0x5c79f5(0x1dd)]((_0x1c9479,_0x2adb28,_0x375305)=>{const _0x215148=_0x5c79f5;_0x5540c2&&sharpUtil[_0x215148(0x1ee)](_0x394f17),_0x1c9479?(console[_0x215148(0x1e3)](_0x215148(0x1fb),_0x1c9479),_0x44be2e()):_0x490f56(_0x2adb28);});};function _0x2802(_0x36113e,_0x5a8394){const _0x530899=_0x5308();return _0x2802=function(_0x28026e,_0x3e1fa1){_0x28026e=_0x28026e-0x1b2;let _0x366b14=_0x530899[_0x28026e];return _0x366b14;},_0x2802(_0x36113e,_0x5a8394);}function sharpImg(_0x125d1a,_0x586751,_0x7fb7dc,_0x2072e1,_0x1e8b9a){const _0x75352=_0x127e55;sharpUtil[_0x75352(0x20b)](_0x125d1a,(_0x571a5d,_0x42ee9,_0x46d15d)=>{const _0x284af5=_0x75352;!_0x586751[_0x284af5(0x1eb)]&&!_0x586751[_0x284af5(0x1e2)]&&(_0x586751={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x284af5(0x1e9)](_0x571a5d,null,![],_0x586751,_0x284af5(0x20a),_0x7fb7dc,_0x2072e1,_0x1e8b9a,_0x42ee9,_0x46d15d);});}sharpUtil[_0x127e55(0x1da)]=function(_0x36a38d,_0x1fca6f,_0x26512f,_0x20c833,_0xe306dc,_0x1f8642,_0x18fb87,_0x4c2b69){const _0x4e08fe=_0x127e55;_0x4c2b69&&(_0x4c2b69=parseInt(_0x4c2b69));let _0x3e0aee=path[_0x4e08fe(0x1d7)](_0x1fca6f,_0x26512f);if(_0x20c833==_0x4e08fe(0x1c5)){let _0x31d39c={};_0xe306dc&&_0xe306dc[_0x4e08fe(0x1eb)]&&_0xe306dc[_0x4e08fe(0x1e2)]?_0xe306dc[_0x4e08fe(0x1eb)]>_0xe306dc[_0x4e08fe(0x1e2)]?_0x31d39c[_0x4e08fe(0x1eb)]=_0x4c2b69?_0x4c2b69:0x258:_0x31d39c[_0x4e08fe(0x1e2)]=_0x4c2b69?_0x4c2b69:0x258:(_0x31d39c['width']=_0x4c2b69,_0x31d39c[_0x4e08fe(0x1e2)]=_0x4c2b69),sharpImg(_0x36a38d,_0x31d39c,_0x3e0aee,_0x1f8642,_0x18fb87);}else{if(_0x20c833==_0x4e08fe(0x1e0)){let _0x5da384=FFmpeg(transCodeUtil[_0x4e08fe(0x209)](_0x36a38d),{'timeout':0x3c});_0x5da384['on'](_0x4e08fe(0x1fa),()=>{const _0x4ef411=_0x4e08fe;_0x5da384['kill'](),_0x1f8642(path[_0x4ef411(0x1d7)](_0x1fca6f,_0x26512f));}),_0x5da384['on'](_0x4e08fe(0x1f3),function(_0x3e9d02,_0x55daa2,_0x2e5dd3){const _0x445e93=_0x4e08fe;_0x5da384[_0x445e93(0x1b8)](),_0x18fb87&&_0x18fb87();}),_0x5da384[_0x4e08fe(0x1d9)]({'timestamps':[_0x4e08fe(0x1b4)],'filename':_0x26512f,'folder':_0x1fca6f,'size':'600x?'});}}},sharpUtil[_0x127e55(0x1c0)]=function(_0x31a1d0){return new Promise((_0x179b27,_0x433c70)=>{const _0x1d632d=_0x2802;let _0x4065cd=new Worker(path[_0x1d632d(0x1d2)](__dirname,_0x1d632d(0x1dc)),{'workerData':{'inputBuffer':_0x31a1d0}}),_0x37c548=setTimeout(()=>{const _0x11bef1=_0x1d632d;_0x4065cd&&(console[_0x11bef1(0x1e3)]('已超时\x20结束处理worker'),_0x4065cd[_0x11bef1(0x1fd)](),_0x4065cd=null,_0x433c70());},0x3a98);_0x4065cd['on'](_0x1d632d(0x1cd),_0x58084b=>{const _0x30c53e=_0x1d632d;_0x58084b[_0x30c53e(0x1de)]==0x0&&(_0x37c548&&clearTimeout(_0x37c548),_0x179b27(_0x58084b[_0x30c53e(0x1f0)]));}),_0x4065cd['on'](_0x1d632d(0x1f3),_0x3f1097=>{const _0x514e3b=_0x1d632d;console[_0x514e3b(0x1f3)](_0x514e3b(0x1f9),_0x3f1097),_0x4065cd&&(_0x4065cd[_0x514e3b(0x1fd)](),_0x4065cd=null),_0x433c70();}),_0x4065cd['on'](_0x1d632d(0x1ba),_0x2d862e=>{const _0x5e15cc=_0x1d632d;if(_0x2d862e!==0x0)console[_0x5e15cc(0x1f3)](_0x5e15cc(0x1ed),_0x2d862e);else{}});});},sharpUtil[_0x127e55(0x1df)]=function(_0x3a2d2b,_0x1c3dff,_0x483292){const _0x216e1a=_0x127e55;if(_0x3a2d2b)_0x3a2d2b=_0x3a2d2b[_0x216e1a(0x1d3)]();if(_0x3a2d2b&&(_0x3a2d2b==_0x216e1a(0x1db)||_0x3a2d2b==_0x216e1a(0x1fc)||_0x3a2d2b==_0x216e1a(0x207)))sharpUtil[_0x216e1a(0x1c0)](_0x1c3dff)['then'](_0x5835e1=>{_0x5835e1?_0x483292(_0x5835e1):_0x483292(_0x1c3dff);})[_0x216e1a(0x208)](()=>{_0x483292(_0x1c3dff);});else{if(_0x3a2d2b&&_0x3a2d2b==_0x216e1a(0x1d8))try{const _0xd5a437=sharpBmp['decode'](_0x1c3dff);_0x483292(_0xd5a437);}catch(_0x5a5845){_0x483292(_0x1c3dff);}else _0x3a2d2b&&config['rawImgTypeList'][_0x216e1a(0x1f2)](_0x3a2d2b[_0x216e1a(0x1d3)]())?extractThumbnailFromRaw(_0x1c3dff,_0x3a2d2b)[_0x216e1a(0x1e1)](_0x34941d=>{_0x483292(_0x34941d);})[_0x216e1a(0x208)](_0x24697d=>{const _0x364926=_0x216e1a;console['log'](_0x364926(0x20d),_0x24697d),_0x483292(_0x1c3dff);}):_0x483292(_0x1c3dff);}},sharpUtil['transSpcielFormat']=function(_0x540362,_0xe8a953){const _0x3e2b7a=_0x127e55;let _0x61d65a=path[_0x3e2b7a(0x1c2)](_0x540362);if(_0x61d65a)_0x61d65a=_0x61d65a[_0x3e2b7a(0x1d3)]();if(_0x61d65a&&(_0x61d65a==_0x3e2b7a(0x1db)||_0x61d65a==_0x3e2b7a(0x1fc)||_0x61d65a==_0x3e2b7a(0x207)))fs[_0x3e2b7a(0x1d4)](_0x540362,(_0x439732,_0x231383)=>{const _0x4d4c02=_0x3e2b7a;if(_0x439732)return _0xe8a953(_0x540362);sharpUtil[_0x4d4c02(0x1c0)](_0x231383)[_0x4d4c02(0x1e1)](_0x25c371=>{_0x25c371?_0xe8a953(_0x25c371):_0xe8a953(_0x231383);})[_0x4d4c02(0x208)](()=>{_0xe8a953(_0x231383);});});else{if(_0x61d65a&&_0x61d65a==_0x3e2b7a(0x1d8))console['log']('正在处理bmp',_0x540362),fs[_0x3e2b7a(0x1d4)](_0x540362,(_0x55eae6,_0x5225db)=>{if(_0x55eae6)console['log'](_0x55eae6),_0xe8a953(_0x540362);else try{const _0x2e12f0=sharpBmp['decode'](_0x5225db);_0xe8a953(_0x2e12f0);}catch(_0x18f477){_0xe8a953(_0x540362);}});else{if(_0x61d65a&&config[_0x3e2b7a(0x201)]['includes'](_0x61d65a[_0x3e2b7a(0x1d3)]()))try{extractThumbnailFromRaw(_0x540362,_0x61d65a)['then'](_0x17a95d=>{_0xe8a953(_0x17a95d);})[_0x3e2b7a(0x208)](_0xdf940e=>{const _0x4d8822=_0x3e2b7a;console[_0x4d8822(0x1e3)](_0xdf940e),_0xe8a953(_0x540362);});}catch(_0x96c677){console[_0x3e2b7a(0x1e3)](_0x96c677),_0xe8a953(_0x540362);}else _0xe8a953(_0x540362);}}},sharpUtil[_0x127e55(0x1e4)]=function(_0x338331,_0x1006c3,_0x224d97,_0xacf6af){const _0x51913d=_0x127e55;sharpUtil[_0x51913d(0x20b)](_0x1006c3,(_0x4f7a8e,_0x3aa3a1,_0x5ce083)=>{const _0x29e6c9=_0x51913d;sharpUtil['sharpDealImg'](_0x4f7a8e,'jpeg',!![],_0x224d97,_0x29e6c9(0x1f5),null,_0x25e753=>{_0x338331['send'](Buffer['from'](_0x25e753));},()=>{const _0x3bc989=_0x29e6c9;_0x338331['status'](0x194)[_0x3bc989(0x1fa)]();},_0x3aa3a1,_0x5ce083,_0xacf6af);});},sharpUtil[_0x127e55(0x1be)]=function(_0x4d445d){const _0x53acff=_0x127e55;return config[_0x53acff(0x1c4)][_0x53acff(0x1f2)](_0x4d445d)||config[_0x53acff(0x201)][_0x53acff(0x1f2)](_0x4d445d['toLowerCase']())||_0x4d445d==_0x53acff(0x1d8)||_0x4d445d==_0x53acff(0x1cb)?!![]:![];},sharpUtil[_0x127e55(0x1ea)]=function(_0x209ded){const _0x53b074=_0x127e55;let _0x168790=path[_0x53b074(0x1c2)](_0x209ded)?path['extname'](_0x209ded)['toLowerCase']():null;if(!_0x168790)return![];return sharpUtil[_0x53b074(0x1be)](_0x168790);},sharpUtil['returnDealedFile']=function(_0xc74b45,_0x3d07f6,_0x309f05,_0x42b54c,_0x488cd7){const _0x417504=_0x127e55;if(sharpUtil[_0x417504(0x1ea)](_0x3d07f6)||_0x42b54c||_0x488cd7){let _0x291e0e=null,_0x21f2d9=null;return _0x42b54c&&_0x42b54c>=0x64&&_0x42b54c<=0x186a0&&(_0x291e0e={'fit':'inside','width':parseInt(_0x42b54c),'height':parseInt(_0x42b54c),'withoutEnlargement':!![]}),_0x488cd7&&_0x488cd7>=0x1e&&_0x488cd7<=0x64&&(_0x21f2d9={'quality':parseInt(_0x488cd7)}),sharpUtil['returnDealedImage'](_0xc74b45,_0x3d07f6,_0x291e0e,_0x21f2d9);}else{if(_0x309f05){const _0x2784c1=encodeURIComponent(path[_0x417504(0x205)](_0x3d07f6))[_0x417504(0x203)](/%([0-9A-F]{2})/g,(_0x3f7642,_0x595af8)=>'%'+_0x595af8[_0x417504(0x1b7)]());_0xc74b45['setHeader']('Content-Disposition','attachment;\x20filename*=UTF-8\x27\x27'+_0x2784c1);}_0xc74b45['sendFile'](_0x3d07f6);}},module[_0x127e55(0x1fe)]=sharpUtil;