const _0x1aca2f=_0x5117;function _0x4b19(){const _0xa78da0=['589044YsQPSc','error','../../myConfig/config','string','webp','1214631WAzoGb','replace','startsWith','file','terminate','rotate','../../myWorkers/transHeicWorker.js','returnDealedImage','data','image','exit','sharp\x20err2:','setHeader','sharp\x20deal\x20psd\x20png\x20error\x201','toBuffer','end','fromFile','_psd.png','transSpcielFormatFromBuffer','3AosQKy','basename','height','kill','../../libs/nasTrans','stat','jpeg','runTransHeicWorker','getRotateFromTags','已超时\x20结束处理worker','../../utils/transCodeUtil','sha256','1595892TulhLc','output','readFile','message','110gTXPug','sharp\x20err1:','.tiff','24StxSKT','raw\x20err1','resize','returnDealedFile','withMetadata','code','getSharpInstanceFromInput','log','rawImgTypeList','send','10%','join','isBuffer','ifExtIsSpecialFormat','722796WScnOe','.heic','psd\x20error\x202','.heif','path','saveAsPng','video','psd导入失败','273810VNQJWY','parse','Buffer','Content-Disposition','dealFFmpegPath','decode','catch','631233ZIvyHW','sendFile','ifImageIsSpecialFormat','status','genTinyFile','toUpperCase','screenshots','from','.bmp','extname','sharpDealImg','../../utils/exifUtils','25GKLXOD','deleteRawTempFile','heicExt','.hif','toLowerCase','includes','psd','inside','FFmpeg','resolve','psd\x20error\x201','libheif-js/wasm-bundle','width','buffer','then','3635807FBdOfm','读取失败','attachment;\x20filename*=UTF-8\x27\x27'];_0x4b19=function(){return _0xa78da0;};return _0x4b19();}(function(_0x4a1033,_0x5e4fd3){const _0x1c2809=_0x5117,_0x171d52=_0x4a1033();while(!![]){try{const _0x5d644d=-parseInt(_0x1c2809(0xf1))/0x1*(parseInt(_0x1c2809(0x11a))/0x2)+-parseInt(_0x1c2809(0x112))/0x3+-parseInt(_0x1c2809(0xfd))/0x4+-parseInt(_0x1c2809(0x12d))/0x5*(-parseInt(_0x1c2809(0xd9))/0x6)+-parseInt(_0x1c2809(0xd6))/0x7+parseInt(_0x1c2809(0x104))/0x8*(parseInt(_0x1c2809(0x121))/0x9)+parseInt(_0x1c2809(0x101))/0xa*(parseInt(_0x1c2809(0xde))/0xb);if(_0x5d644d===_0x5e4fd3)break;else _0x171d52['push'](_0x171d52['shift']());}catch(_0x25cebd){_0x171d52['push'](_0x171d52['shift']());}}}(_0x4b19,0x54723));let path=require(_0x1aca2f(0x116)),fs=require('fs'),FFmpeg=require(_0x1aca2f(0xf5))[_0x1aca2f(0xcf)],sharpUtil={};function _0x5117(_0xc4f082,_0x508246){const _0x4b19f4=_0x4b19();return _0x5117=function(_0x51178e,_0xa1b6e2){_0x51178e=_0x51178e-0xca;let _0xba8035=_0x4b19f4[_0x51178e];return _0xba8035;},_0x5117(_0xc4f082,_0x508246);}const sharp=require('sharp'),libheif=require(_0x1aca2f(0xd2)),config=require(_0x1aca2f(0xdb)),transCodeUtil=require(_0x1aca2f(0xfb)),sharpBmp=require('sharp-bmp');let sha256=require(_0x1aca2f(0xfc));const {Worker}=require('worker_threads');let dcraw;function getDcraw(){const _0x33ee65=_0x1aca2f;if(!dcraw)try{return dcraw=require('dcraw'),dcraw;}catch(_0x44fe98){return console[_0x33ee65(0x10b)]('dcraw导入失败'),null;}else return dcraw;}let PSD;function getPsd(){const _0x18adfc=_0x1aca2f;if(!PSD)try{return PSD=require(_0x18adfc(0xcd)),PSD;}catch(_0x2b7946){return console[_0x18adfc(0x10b)](_0x18adfc(0x119)),null;}else return PSD;}function extractThumbnailFromRaw(_0xacd235,_0x389df3){return new Promise((_0x114e55,_0x4a45cb)=>{const _0x41b3a4=_0x5117;if(_0x389df3&&_0x389df3[_0x41b3a4(0xcb)]()=='.psd'){let _0x1f1051=getPsd();if(!_0x1f1051)return _0x4a45cb(null);try{if(typeof _0xacd235=='string'){let _0x4fa2af=path[_0x41b3a4(0x10f)](config['cachePath'],sha256(_0xacd235)+_0x41b3a4(0xef));fs[_0x41b3a4(0xf6)](_0x4fa2af,(_0x3279d3,_0x31f8f0)=>{const _0x90e358=_0x41b3a4;try{if(_0x3279d3){let _0x205deb=_0x1f1051[_0x90e358(0xee)](_0xacd235);_0x205deb[_0x90e358(0x11b)](),_0x205deb[_0x90e358(0xe7)][_0x90e358(0x117)](_0x4fa2af)[_0x90e358(0xd5)](()=>{const _0x1e3471=_0x90e358;sharp(_0x4fa2af)[_0x1e3471(0xf7)]({'quality':0x4d})[_0x1e3471(0xec)]()['then'](_0x4159fc=>{fs['writeFile'](_0x4fa2af,_0x4159fc,_0x3f06f6=>{if(_0x3f06f6)return _0x4a45cb(null);_0x114e55(_0x4fa2af);});})['catch'](_0x5def6e=>{const _0x2b2f59=_0x1e3471;return console[_0x2b2f59(0x10b)](_0x2b2f59(0xeb),_0x5def6e),_0x4a45cb(null);});})[_0x90e358(0x120)](_0x483ac1=>{const _0x562200=_0x90e358;return console[_0x562200(0x10b)](_0x562200(0xd1),_0x483ac1),_0x4a45cb(null);});}else return _0x114e55(_0x4fa2af);}catch(_0x32d6f9){return console[_0x90e358(0x10b)](_0x90e358(0x114),_0x32d6f9),_0x4a45cb(null);}});}else return _0x4a45cb(null);}catch(_0x265f37){return _0x4a45cb(null);}}else{let _0x2afc99=getDcraw();if(!_0x2afc99)return _0x4a45cb(null);function _0x9d4b0c(_0x444f11){try{const _0xb02673=_0x2afc99(_0x444f11,{'extractThumbnail':!![],'identify':!![]});return _0xb02673?_0x114e55(_0xb02673):_0x4a45cb(null);}catch(_0x47127d){return _0x4a45cb(null);}}if(typeof _0xacd235==_0x41b3a4(0xdc))fs['readFile'](_0xacd235,(_0x11d88f,_0x17351e)=>{const _0xa2624b=_0x41b3a4;if(_0x11d88f)return console[_0xa2624b(0x10b)](_0xa2624b(0xd7),_0xacd235),_0x4a45cb(_0x11d88f);_0x9d4b0c(_0x17351e);});else{if(Buffer[_0x41b3a4(0x110)](_0xacd235))_0x9d4b0c(_0xacd235);else return _0x4a45cb(null);}}});}const exifUtils=require(_0x1aca2f(0x12c));sharpUtil['getSharpInstanceFromInput']=function(_0x435901){const _0x20439c=_0x1aca2f;_0x435901['type']==_0x20439c(0x11c)&&(_0x435901=Buffer[_0x20439c(0x128)](_0x435901));let _0x51de7c={'failOnError':![]};return _0x435901['width']&&_0x435901[_0x20439c(0xf3)]&&_0x435901[_0x20439c(0xe6)]&&(_0x51de7c['raw']={'width':_0x435901[_0x20439c(0xd3)],'height':_0x435901[_0x20439c(0xf3)],'channels':0x4},_0x435901=_0x435901[_0x20439c(0xe6)]),sharp(_0x435901,_0x51de7c);},sharpUtil['deleteRawTempFile']=function(_0x248194){const _0x3dbe26=_0x1aca2f;typeof _0x248194==_0x3dbe26(0xdc)&&_0x248194[_0x3dbe26(0xe0)](config['tempFilePath'])&&fs['rm'](_0x248194,_0x330cc1=>{});},sharpUtil[_0x1aca2f(0x12b)]=function(_0x2748a2,_0x5017aa,_0x4c099f,_0x3361b8,_0x4530bc,_0x4b255d,_0x21c54f,_0x563891,_0x41fc1f,_0x8fb517,_0x550552){const _0x403ec5=_0x1aca2f;if(!_0x2748a2)return _0x21c54f(null);let _0x49a1bf=sharpUtil[_0x403ec5(0x10a)](_0x2748a2);_0x5017aa==_0x403ec5(0xf7)?_0x550552?_0x49a1bf=_0x49a1bf[_0x403ec5(0xf7)](_0x550552):_0x49a1bf=_0x49a1bf[_0x403ec5(0xf7)]():_0x49a1bf=_0x49a1bf[_0x403ec5(0xdd)]({});_0x4c099f&&(_0x49a1bf=_0x49a1bf[_0x403ec5(0x108)]());let _0x39fe13=exifUtils[_0x403ec5(0xf9)](_0x8fb517);_0x39fe13?_0x49a1bf=_0x49a1bf['rotate'](_0x39fe13):_0x49a1bf=_0x49a1bf[_0x403ec5(0xe3)]();_0x3361b8&&(_0x49a1bf=_0x49a1bf[_0x403ec5(0x106)](_0x3361b8));if(_0x4530bc=='file')_0x49a1bf['toFile'](_0x4b255d,(_0x238a70,_0x10f45e)=>{const _0x500ffe=_0x403ec5;_0x41fc1f&&(console[_0x500ffe(0x10b)]('处理完成,删除临时文件',_0x2748a2),sharpUtil['deleteRawTempFile'](_0x2748a2)),_0x238a70?(console[_0x500ffe(0x10b)](_0x500ffe(0x102),_0x2748a2,_0x238a70),_0x563891()):_0x21c54f(_0x4b255d);});else _0x4530bc==_0x403ec5(0xd4)&&_0x49a1bf[_0x403ec5(0xec)]((_0x9f925b,_0x5163f4,_0x3e4454)=>{const _0x288d78=_0x403ec5;_0x41fc1f&&sharpUtil[_0x288d78(0x12e)](_0x2748a2),_0x9f925b?(console[_0x288d78(0x10b)](_0x288d78(0xe9),_0x9f925b),_0x563891()):_0x21c54f(_0x5163f4);});};function sharpImg(_0x58459e,_0x1c2263,_0x493dd8,_0x2db4ec,_0x5c5b40){sharpUtil['transSpcielFormat'](_0x58459e,(_0x24e345,_0x3f820d,_0xd62d1e)=>{const _0x174191=_0x5117;!_0x1c2263[_0x174191(0xd3)]&&!_0x1c2263[_0x174191(0xf3)]&&(_0x1c2263={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil['sharpDealImg'](_0x24e345,null,![],_0x1c2263,_0x174191(0xe1),_0x493dd8,_0x2db4ec,_0x5c5b40,_0x3f820d,_0xd62d1e);});}sharpUtil[_0x1aca2f(0x125)]=function(_0x3a996e,_0x3ac098,_0x9c01d8,_0x1cb595,_0x259788,_0x267d56,_0x48f844,_0x3cf115){const _0x3c90b5=_0x1aca2f;_0x3cf115&&(_0x3cf115=parseInt(_0x3cf115));let _0x1b5319=path[_0x3c90b5(0x10f)](_0x3ac098,_0x9c01d8);if(_0x1cb595==_0x3c90b5(0xe7)){let _0x46fea6={};_0x259788&&_0x259788['width']&&_0x259788[_0x3c90b5(0xf3)]?_0x259788[_0x3c90b5(0xd3)]>_0x259788[_0x3c90b5(0xf3)]?_0x46fea6['width']=_0x3cf115?_0x3cf115:0x258:_0x46fea6[_0x3c90b5(0xf3)]=_0x3cf115?_0x3cf115:0x258:(_0x46fea6[_0x3c90b5(0xd3)]=_0x3cf115,_0x46fea6['height']=_0x3cf115),sharpImg(_0x3a996e,_0x46fea6,_0x1b5319,_0x267d56,_0x48f844);}else{if(_0x1cb595==_0x3c90b5(0x118)){let _0x90a7a2=FFmpeg(transCodeUtil[_0x3c90b5(0x11e)](_0x3a996e),{'timeout':0x3c});_0x90a7a2['on'](_0x3c90b5(0xed),()=>{const _0x26528b=_0x3c90b5;_0x90a7a2[_0x26528b(0xf4)](),_0x267d56(path[_0x26528b(0x10f)](_0x3ac098,_0x9c01d8));}),_0x90a7a2['on']('error',function(_0x29ca24,_0x1ed6ea,_0x48213d){_0x90a7a2['kill'](),_0x48f844&&_0x48f844();}),_0x90a7a2[_0x3c90b5(0x127)]({'timestamps':[_0x3c90b5(0x10e)],'filename':_0x9c01d8,'folder':_0x3ac098,'size':'600x?'});}}},sharpUtil['runTransHeicWorker']=function(_0xecc70){return new Promise((_0x103541,_0x2a7df4)=>{const _0x22ed2c=_0x5117;let _0x48c8c3=new Worker(path[_0x22ed2c(0xd0)](__dirname,_0x22ed2c(0xe4)),{'workerData':{'inputBuffer':_0xecc70}}),_0x3e6fb7=setTimeout(()=>{const _0xff8632=_0x22ed2c;_0x48c8c3&&(console[_0xff8632(0x10b)](_0xff8632(0xfa)),_0x48c8c3['terminate'](),_0x48c8c3=null,_0x2a7df4());},0x3a98);_0x48c8c3['on'](_0x22ed2c(0x100),_0x20f034=>{const _0x5d3c41=_0x22ed2c;_0x20f034[_0x5d3c41(0x109)]==0x0&&(_0x3e6fb7&&clearTimeout(_0x3e6fb7),_0x103541(_0x20f034[_0x5d3c41(0xfe)]));}),_0x48c8c3['on'](_0x22ed2c(0xda),_0x1b54c9=>{const _0x28f4e3=_0x22ed2c;console[_0x28f4e3(0xda)]('Worker\x20error:',_0x1b54c9),_0x48c8c3&&(_0x48c8c3[_0x28f4e3(0xe2)](),_0x48c8c3=null),_0x2a7df4();}),_0x48c8c3['on'](_0x22ed2c(0xe8),_0x3d84a3=>{if(_0x3d84a3!==0x0)console['error']('Worker\x20stopped\x20with\x20exit\x20code:',_0x3d84a3);else{}});});},sharpUtil[_0x1aca2f(0xf0)]=function(_0x402ca2,_0x3f0b85,_0x2b1bf2){const _0x3e582f=_0x1aca2f;if(_0x402ca2)_0x402ca2=_0x402ca2[_0x3e582f(0xcb)]();if(_0x402ca2&&(_0x402ca2=='.heic'||_0x402ca2==_0x3e582f(0x115)||_0x402ca2=='.hif'))sharpUtil[_0x3e582f(0xf8)](_0x3f0b85)[_0x3e582f(0xd5)](_0x315081=>{_0x315081?_0x2b1bf2(_0x315081):_0x2b1bf2(_0x3f0b85);})[_0x3e582f(0x120)](()=>{_0x2b1bf2(_0x3f0b85);});else{if(_0x402ca2&&_0x402ca2=='.bmp')try{const _0x5c5526=sharpBmp[_0x3e582f(0x11f)](_0x3f0b85);_0x2b1bf2(_0x5c5526);}catch(_0x2c6e1d){_0x2b1bf2(_0x3f0b85);}else _0x402ca2&&config['rawImgTypeList']['includes'](_0x402ca2[_0x3e582f(0xcb)]())?extractThumbnailFromRaw(_0x3f0b85,_0x402ca2)['then'](_0x29588d=>{_0x2b1bf2(_0x29588d);})[_0x3e582f(0x120)](_0x1b1500=>{const _0x91abd2=_0x3e582f;console[_0x91abd2(0x10b)](_0x91abd2(0x105),_0x1b1500),_0x2b1bf2(_0x3f0b85);}):_0x2b1bf2(_0x3f0b85);}},sharpUtil['transSpcielFormat']=function(_0x43a211,_0x4e2a20){const _0x281695=_0x1aca2f;let _0x3dba84=path['extname'](_0x43a211);if(_0x3dba84)_0x3dba84=_0x3dba84[_0x281695(0xcb)]();if(_0x3dba84&&(_0x3dba84==_0x281695(0x113)||_0x3dba84==_0x281695(0x115)||_0x3dba84==_0x281695(0xca)))fs[_0x281695(0xff)](_0x43a211,(_0x2d25d6,_0x549faf)=>{const _0xf5da9e=_0x281695;if(_0x2d25d6)return _0x4e2a20(_0x43a211);sharpUtil[_0xf5da9e(0xf8)](_0x549faf)[_0xf5da9e(0xd5)](_0x45a974=>{_0x45a974?_0x4e2a20(_0x45a974):_0x4e2a20(_0x549faf);})[_0xf5da9e(0x120)](()=>{_0x4e2a20(_0x549faf);});});else{if(_0x3dba84&&_0x3dba84==_0x281695(0x129))console[_0x281695(0x10b)]('正在处理bmp',_0x43a211),fs[_0x281695(0xff)](_0x43a211,(_0x58b52f,_0x399694)=>{const _0x2ae6f6=_0x281695;if(_0x58b52f)console[_0x2ae6f6(0x10b)](_0x58b52f),_0x4e2a20(_0x43a211);else try{const _0x7785bd=sharpBmp[_0x2ae6f6(0x11f)](_0x399694);_0x4e2a20(_0x7785bd);}catch(_0x11f643){_0x4e2a20(_0x43a211);}});else{if(_0x3dba84&&config[_0x281695(0x10c)]['includes'](_0x3dba84[_0x281695(0xcb)]()))try{extractThumbnailFromRaw(_0x43a211,_0x3dba84)['then'](_0x5b5b21=>{_0x4e2a20(_0x5b5b21);})[_0x281695(0x120)](_0x34d5dd=>{const _0x4d3afc=_0x281695;console[_0x4d3afc(0x10b)](_0x34d5dd),_0x4e2a20(_0x43a211);});}catch(_0x1fb477){console[_0x281695(0x10b)](_0x1fb477),_0x4e2a20(_0x43a211);}else _0x4e2a20(_0x43a211);}}},sharpUtil[_0x1aca2f(0xe5)]=function(_0x4addc1,_0x30fae7,_0xe56859,_0xbb2fb7){sharpUtil['transSpcielFormat'](_0x30fae7,(_0x266d97,_0x3450d9,_0x3f503a)=>{const _0xfa1025=_0x5117;sharpUtil[_0xfa1025(0x12b)](_0x266d97,_0xfa1025(0xf7),!![],_0xe56859,_0xfa1025(0xd4),null,_0xc532a6=>{const _0x297b83=_0xfa1025;_0x4addc1[_0x297b83(0x10d)](Buffer['from'](_0xc532a6));},()=>{const _0x23cc79=_0xfa1025;_0x4addc1[_0x23cc79(0x124)](0x194)['end']();},_0x3450d9,_0x3f503a,_0xbb2fb7);});},sharpUtil[_0x1aca2f(0x111)]=function(_0x5268ab){const _0x64e666=_0x1aca2f;return config[_0x64e666(0x12f)][_0x64e666(0xcc)](_0x5268ab)||config['rawImgTypeList'][_0x64e666(0xcc)](_0x5268ab[_0x64e666(0xcb)]())||_0x5268ab==_0x64e666(0x129)||_0x5268ab==_0x64e666(0x103)?!![]:![];},sharpUtil['ifImageIsSpecialFormat']=function(_0x35b406){const _0x3f5444=_0x1aca2f;let _0x7cbedc=path[_0x3f5444(0x12a)](_0x35b406)?path[_0x3f5444(0x12a)](_0x35b406)[_0x3f5444(0xcb)]():null;if(!_0x7cbedc)return![];return sharpUtil[_0x3f5444(0x111)](_0x7cbedc);},sharpUtil[_0x1aca2f(0x107)]=function(_0x91b298,_0x10b153,_0x4a3a29,_0x1a60cf,_0x23f8c7){const _0xa46209=_0x1aca2f;if(sharpUtil[_0xa46209(0x123)](_0x10b153)||_0x1a60cf||_0x23f8c7){let _0x3d1dfd=null,_0x498c22=null;return _0x1a60cf&&_0x1a60cf>=0x64&&_0x1a60cf<=0x186a0&&(_0x3d1dfd={'fit':_0xa46209(0xce),'width':parseInt(_0x1a60cf),'height':parseInt(_0x1a60cf),'withoutEnlargement':!![]}),_0x23f8c7&&_0x23f8c7>=0x1e&&_0x23f8c7<=0x64&&(_0x498c22={'quality':parseInt(_0x23f8c7)}),sharpUtil[_0xa46209(0xe5)](_0x91b298,_0x10b153,_0x3d1dfd,_0x498c22);}else{if(_0x4a3a29){const _0xa4048a=encodeURIComponent(path[_0xa46209(0xf2)](_0x10b153))[_0xa46209(0xdf)](/%([0-9A-F]{2})/g,(_0x53fa5c,_0x4df2b6)=>'%'+_0x4df2b6[_0xa46209(0x126)]());_0x91b298[_0xa46209(0xea)](_0xa46209(0x11d),_0xa46209(0xd8)+_0xa4048a);}_0x91b298[_0xa46209(0x122)](_0x10b153);}},module['exports']=sharpUtil;