const _0x5e76f9=_0x98f7;(function(_0x4f881f,_0x5bc7a3){const _0x1a1ab7=_0x98f7,_0x3e74b8=_0x4f881f();while(!![]){try{const _0x383e42=parseInt(_0x1a1ab7(0xfd))/0x1*(parseInt(_0x1a1ab7(0xe4))/0x2)+-parseInt(_0x1a1ab7(0xd2))/0x3+-parseInt(_0x1a1ab7(0x126))/0x4+-parseInt(_0x1a1ab7(0xd9))/0x5+-parseInt(_0x1a1ab7(0x122))/0x6*(-parseInt(_0x1a1ab7(0xf8))/0x7)+-parseInt(_0x1a1ab7(0x10f))/0x8*(parseInt(_0x1a1ab7(0xe1))/0x9)+-parseInt(_0x1a1ab7(0x117))/0xa*(-parseInt(_0x1a1ab7(0xe0))/0xb);if(_0x383e42===_0x5bc7a3)break;else _0x3e74b8['push'](_0x3e74b8['shift']());}catch(_0x16fdd9){_0x3e74b8['push'](_0x3e74b8['shift']());}}}(_0x42c3,0x71953));let path=require(_0x5e76f9(0xf1)),fs=require('fs'),FFmpeg=require(_0x5e76f9(0x109))['FFmpeg'],sharpUtil={};const sharp=require('sharp'),libheif=require(_0x5e76f9(0x104)),config=require('../../myConfig/config'),transCodeUtil=require(_0x5e76f9(0x102)),sharpBmp=require(_0x5e76f9(0xd1));let sha256=require(_0x5e76f9(0x111));const {Worker}=require(_0x5e76f9(0xde));let dcraw;function _0x42c3(){const _0x3af3ef=['worker_threads','transSpcielFormat','173701LjqkzI','4635EKIYma','status','withMetadata','2FGtoUY','attachment;\x20filename*=UTF-8\x27\x27','send','error','screenshots','psd\x20error\x201','runTransHeicWorker','../../utils/exifUtils','image','parse','string','10%','writeFile','path','startsWith','returnDealedFile','.psd','rawImgTypeList','.tiff','getSharpInstanceFromInput','1476153qxPWhF','toUpperCase','ifExtIsSpecialFormat','includes','exports','551773ruYVnI','deleteRawTempFile','psd\x20error\x202','buffer','.bmp','../../utils/transCodeUtil','readFile','libheif-js/wasm-bundle','returnDealedImage','catch','file','end','../../libs/nasTrans','rotate','getRotateFromTags','log','.heif','Buffer','14320DXZOTW','ifImageIsSpecialFormat','sha256','transSpcielFormatFromBuffer','jpeg','extname','join','setHeader','940VOmxbb','code','toBuffer','psd','then','inside','sharp\x20err1:','resize','data','toFile','../../myWorkers/transHeicWorker.js','12eSfZzT','已超时\x20结束处理worker','decode','from','352600CTsaJy','saveAsPng','terminate','sharpDealImg','isBuffer','dcraw','toLowerCase','height','Worker\x20stopped\x20with\x20exit\x20code:','600x?','sharp-bmp','1331202yJsgHW','output','.hif','exit','webp','正在处理bmp','tempFilePath','2694580AOWNKt','.heic','psd导入失败','width','message'];_0x42c3=function(){return _0x3af3ef;};return _0x42c3();}function getDcraw(){const _0x1aa0dc=_0x5e76f9;if(!dcraw)try{return dcraw=require(_0x1aa0dc(0x12b)),dcraw;}catch(_0x499533){return console['log']('dcraw导入失败'),null;}else return dcraw;}let PSD;function getPsd(){const _0x1ff53c=_0x5e76f9;if(!PSD)try{return PSD=require(_0x1ff53c(0x11a)),PSD;}catch(_0xc2ac1a){return console[_0x1ff53c(0x10c)](_0x1ff53c(0xdb)),null;}else return PSD;}function extractThumbnailFromRaw(_0x2e9f95,_0x57109f){return new Promise((_0xad15e5,_0x2b1351)=>{const _0x513bf3=_0x98f7;if(_0x57109f&&_0x57109f[_0x513bf3(0x12c)]()==_0x513bf3(0xf4)){let _0x13936e=getPsd();if(!_0x13936e)return _0x2b1351(null);try{if(typeof _0x2e9f95==_0x513bf3(0xee)){let _0x47a651=path[_0x513bf3(0x115)](config['cachePath'],sha256(_0x2e9f95)+'_psd.png');fs['stat'](_0x47a651,(_0x1f76cd,_0x18a05c)=>{const _0x3c7062=_0x513bf3;try{if(_0x1f76cd){let _0x18093f=_0x13936e['fromFile'](_0x2e9f95);_0x18093f[_0x3c7062(0xed)](),_0x18093f[_0x3c7062(0xec)][_0x3c7062(0x127)](_0x47a651)['then'](()=>{const _0x312755=_0x3c7062;sharp(_0x47a651)[_0x312755(0x113)]({'quality':0x4d})[_0x312755(0x119)]()[_0x312755(0x11b)](_0x13a621=>{const _0x552056=_0x312755;fs[_0x552056(0xf0)](_0x47a651,_0x13a621,_0x1883dd=>{if(_0x1883dd)return _0x2b1351(null);_0xad15e5(_0x47a651);});})[_0x312755(0x106)](_0x472d21=>{return console['log']('sharp\x20deal\x20psd\x20png\x20error\x201',_0x472d21),_0x2b1351(null);});})[_0x3c7062(0x106)](_0x59b21d=>{const _0x273e75=_0x3c7062;return console[_0x273e75(0x10c)](_0x273e75(0xe9),_0x59b21d),_0x2b1351(null);});}else return _0xad15e5(_0x47a651);}catch(_0x5d712b){return console[_0x3c7062(0x10c)](_0x3c7062(0xff),_0x5d712b),_0x2b1351(null);}});}else return _0x2b1351(null);}catch(_0x1f91ae){return _0x2b1351(null);}}else{let _0x5da7d3=getDcraw();if(!_0x5da7d3)return _0x2b1351(null);function _0x4e0792(_0x52b6d2){try{const _0x37e2b0=_0x5da7d3(_0x52b6d2,{'extractThumbnail':!![],'identify':!![]});return _0x37e2b0?_0xad15e5(_0x37e2b0):_0x2b1351(null);}catch(_0x2eadbe){return _0x2b1351(null);}}if(typeof _0x2e9f95=='string')fs[_0x513bf3(0x103)](_0x2e9f95,(_0x1b362b,_0x521c0d)=>{const _0x16ff80=_0x513bf3;if(_0x1b362b)return console[_0x16ff80(0x10c)]('读取失败',_0x2e9f95),_0x2b1351(_0x1b362b);_0x4e0792(_0x521c0d);});else{if(Buffer[_0x513bf3(0x12a)](_0x2e9f95))_0x4e0792(_0x2e9f95);else return _0x2b1351(null);}}});}const exifUtils=require(_0x5e76f9(0xeb));function _0x98f7(_0x497df3,_0xf10b13){const _0x42c3a8=_0x42c3();return _0x98f7=function(_0x98f7c1,_0x343309){_0x98f7c1=_0x98f7c1-0xd1;let _0x191b7e=_0x42c3a8[_0x98f7c1];return _0x191b7e;},_0x98f7(_0x497df3,_0xf10b13);}sharpUtil[_0x5e76f9(0xf7)]=function(_0x4ef545){const _0xb6e8f4=_0x5e76f9;_0x4ef545['type']==_0xb6e8f4(0x10e)&&(_0x4ef545=Buffer[_0xb6e8f4(0x125)](_0x4ef545));let _0x3e79b4={'failOnError':![]};return _0x4ef545[_0xb6e8f4(0xdc)]&&_0x4ef545[_0xb6e8f4(0x12d)]&&_0x4ef545[_0xb6e8f4(0x11f)]&&(_0x3e79b4['raw']={'width':_0x4ef545['width'],'height':_0x4ef545[_0xb6e8f4(0x12d)],'channels':0x4},_0x4ef545=_0x4ef545['data']),sharp(_0x4ef545,_0x3e79b4);},sharpUtil[_0x5e76f9(0xfe)]=function(_0x447586){const _0x1c676d=_0x5e76f9;typeof _0x447586==_0x1c676d(0xee)&&_0x447586[_0x1c676d(0xf2)](config[_0x1c676d(0xd8)])&&fs['rm'](_0x447586,_0x48750e=>{});},sharpUtil[_0x5e76f9(0x129)]=function(_0x11e0e1,_0x19cd4b,_0x334818,_0x42e0c7,_0x179dd1,_0x2ad5be,_0xc25130,_0x327fc0,_0x5691b9,_0x3bca75,_0x99cfa1){const _0x1dc1a2=_0x5e76f9;if(!_0x11e0e1)return _0xc25130(null);let _0x4fb3db=sharpUtil[_0x1dc1a2(0xf7)](_0x11e0e1);_0x19cd4b==_0x1dc1a2(0x113)?_0x99cfa1?_0x4fb3db=_0x4fb3db['jpeg'](_0x99cfa1):_0x4fb3db=_0x4fb3db[_0x1dc1a2(0x113)]():_0x4fb3db=_0x4fb3db[_0x1dc1a2(0xd6)]({});_0x334818&&(_0x4fb3db=_0x4fb3db[_0x1dc1a2(0xe3)]());let _0x236816=exifUtils[_0x1dc1a2(0x10b)](_0x3bca75);_0x236816?_0x4fb3db=_0x4fb3db[_0x1dc1a2(0x10a)](_0x236816):_0x4fb3db=_0x4fb3db[_0x1dc1a2(0x10a)]();_0x42e0c7&&(_0x4fb3db=_0x4fb3db[_0x1dc1a2(0x11e)](_0x42e0c7));if(_0x179dd1==_0x1dc1a2(0x107))_0x4fb3db[_0x1dc1a2(0x120)](_0x2ad5be,(_0x10fea5,_0x3790f9)=>{const _0x4e1a85=_0x1dc1a2;_0x5691b9&&(console['log']('处理完成,删除临时文件',_0x11e0e1),sharpUtil[_0x4e1a85(0xfe)](_0x11e0e1)),_0x10fea5?(console[_0x4e1a85(0x10c)](_0x4e1a85(0x11d),_0x11e0e1,_0x10fea5),_0x327fc0()):_0xc25130(_0x2ad5be);});else _0x179dd1==_0x1dc1a2(0x100)&&_0x4fb3db[_0x1dc1a2(0x119)]((_0x344c7a,_0x582e69,_0x41a328)=>{const _0x207571=_0x1dc1a2;_0x5691b9&&sharpUtil['deleteRawTempFile'](_0x11e0e1),_0x344c7a?(console[_0x207571(0x10c)]('sharp\x20err2:',_0x344c7a),_0x327fc0()):_0xc25130(_0x582e69);});};function sharpImg(_0x5a739d,_0xeced61,_0x542ff7,_0x5b8bc0,_0x2d4243){sharpUtil['transSpcielFormat'](_0x5a739d,(_0x2877b0,_0x15d747,_0x108faf)=>{const _0x34d210=_0x98f7;!_0xeced61['width']&&!_0xeced61[_0x34d210(0x12d)]&&(_0xeced61={'width':0x1f4,'withoutEnlargement':!![]}),sharpUtil[_0x34d210(0x129)](_0x2877b0,null,![],_0xeced61,_0x34d210(0x107),_0x542ff7,_0x5b8bc0,_0x2d4243,_0x15d747,_0x108faf);});}sharpUtil['genTinyFile']=function(_0x2ef5f8,_0x24ea64,_0x310f79,_0xd4c36,_0x20e756,_0x4413a3,_0x2c1fdc,_0x229244){const _0xa86a5e=_0x5e76f9;_0x229244&&(_0x229244=parseInt(_0x229244));let _0x3d4211=path[_0xa86a5e(0x115)](_0x24ea64,_0x310f79);if(_0xd4c36==_0xa86a5e(0xec)){let _0x1c79a6={};_0x20e756&&_0x20e756[_0xa86a5e(0xdc)]&&_0x20e756[_0xa86a5e(0x12d)]?_0x20e756[_0xa86a5e(0xdc)]>_0x20e756['height']?_0x1c79a6[_0xa86a5e(0xdc)]=_0x229244?_0x229244:0x258:_0x1c79a6[_0xa86a5e(0x12d)]=_0x229244?_0x229244:0x258:(_0x1c79a6[_0xa86a5e(0xdc)]=_0x229244,_0x1c79a6[_0xa86a5e(0x12d)]=_0x229244),sharpImg(_0x2ef5f8,_0x1c79a6,_0x3d4211,_0x4413a3,_0x2c1fdc);}else{if(_0xd4c36=='video'){let _0x303860=FFmpeg(transCodeUtil['dealFFmpegPath'](_0x2ef5f8),{'timeout':0x3c});_0x303860['on'](_0xa86a5e(0x108),()=>{_0x303860['kill'](),_0x4413a3(path['join'](_0x24ea64,_0x310f79));}),_0x303860['on'](_0xa86a5e(0xe7),function(_0x571e21,_0x3b2354,_0x1150df){_0x303860['kill'](),_0x2c1fdc&&_0x2c1fdc();}),_0x303860[_0xa86a5e(0xe8)]({'timestamps':[_0xa86a5e(0xef)],'filename':_0x310f79,'folder':_0x24ea64,'size':_0xa86a5e(0x12f)});}}},sharpUtil[_0x5e76f9(0xea)]=function(_0x3ed990){return new Promise((_0x5e7de3,_0x762782)=>{const _0x549179=_0x98f7;let _0x30bd22=new Worker(path['resolve'](__dirname,_0x549179(0x121)),{'workerData':{'inputBuffer':_0x3ed990}}),_0x395c7e=setTimeout(()=>{const _0x5770dd=_0x549179;_0x30bd22&&(console['log'](_0x5770dd(0x123)),_0x30bd22[_0x5770dd(0x128)](),_0x30bd22=null,_0x762782());},0x3a98);_0x30bd22['on'](_0x549179(0xdd),_0x501f22=>{const _0x979644=_0x549179;_0x501f22[_0x979644(0x118)]==0x0&&(_0x395c7e&&clearTimeout(_0x395c7e),_0x5e7de3(_0x501f22[_0x979644(0xd3)]));}),_0x30bd22['on']('error',_0x25dc3c=>{const _0x5a9de4=_0x549179;console[_0x5a9de4(0xe7)]('Worker\x20error:',_0x25dc3c),_0x30bd22&&(_0x30bd22[_0x5a9de4(0x128)](),_0x30bd22=null),_0x762782();}),_0x30bd22['on'](_0x549179(0xd5),_0x1fce25=>{const _0x3b55c4=_0x549179;if(_0x1fce25!==0x0)console[_0x3b55c4(0xe7)](_0x3b55c4(0x12e),_0x1fce25);else{}});});},sharpUtil[_0x5e76f9(0x112)]=function(_0x2e62cf,_0x579458,_0x28c9fb){const _0x346783=_0x5e76f9;if(_0x2e62cf)_0x2e62cf=_0x2e62cf[_0x346783(0x12c)]();if(_0x2e62cf&&(_0x2e62cf==_0x346783(0xda)||_0x2e62cf==_0x346783(0x10d)||_0x2e62cf==_0x346783(0xd4)))sharpUtil['runTransHeicWorker'](_0x579458)[_0x346783(0x11b)](_0x37fd2d=>{_0x37fd2d?_0x28c9fb(_0x37fd2d):_0x28c9fb(_0x579458);})['catch'](()=>{_0x28c9fb(_0x579458);});else{if(_0x2e62cf&&_0x2e62cf==_0x346783(0x101))try{const _0x19b3f7=sharpBmp[_0x346783(0x124)](_0x579458);_0x28c9fb(_0x19b3f7);}catch(_0x28dd49){_0x28c9fb(_0x579458);}else _0x2e62cf&&config['rawImgTypeList']['includes'](_0x2e62cf[_0x346783(0x12c)]())?extractThumbnailFromRaw(_0x579458,_0x2e62cf)[_0x346783(0x11b)](_0x20b958=>{_0x28c9fb(_0x20b958);})[_0x346783(0x106)](_0x48446a=>{const _0xf824cd=_0x346783;console[_0xf824cd(0x10c)]('raw\x20err1',_0x48446a),_0x28c9fb(_0x579458);}):_0x28c9fb(_0x579458);}},sharpUtil[_0x5e76f9(0xdf)]=function(_0x54ac64,_0x2c4738){const _0x107515=_0x5e76f9;let _0x36c20d=path[_0x107515(0x114)](_0x54ac64);if(_0x36c20d)_0x36c20d=_0x36c20d[_0x107515(0x12c)]();if(_0x36c20d&&(_0x36c20d==_0x107515(0xda)||_0x36c20d=='.heif'||_0x36c20d=='.hif'))fs['readFile'](_0x54ac64,(_0x38bf09,_0x4284f9)=>{const _0x4542df=_0x107515;if(_0x38bf09)return _0x2c4738(_0x54ac64);sharpUtil[_0x4542df(0xea)](_0x4284f9)[_0x4542df(0x11b)](_0x229544=>{_0x229544?_0x2c4738(_0x229544):_0x2c4738(_0x4284f9);})[_0x4542df(0x106)](()=>{_0x2c4738(_0x4284f9);});});else{if(_0x36c20d&&_0x36c20d=='.bmp')console[_0x107515(0x10c)](_0x107515(0xd7),_0x54ac64),fs['readFile'](_0x54ac64,(_0x3a23f8,_0x7f5c8d)=>{const _0x3c2876=_0x107515;if(_0x3a23f8)console['log'](_0x3a23f8),_0x2c4738(_0x54ac64);else try{const _0xd7e901=sharpBmp[_0x3c2876(0x124)](_0x7f5c8d);_0x2c4738(_0xd7e901);}catch(_0x4c25aa){_0x2c4738(_0x54ac64);}});else{if(_0x36c20d&&config['rawImgTypeList'][_0x107515(0xfb)](_0x36c20d[_0x107515(0x12c)]()))try{extractThumbnailFromRaw(_0x54ac64,_0x36c20d)[_0x107515(0x11b)](_0x105a01=>{_0x2c4738(_0x105a01);})['catch'](_0x208f98=>{const _0x29e5cf=_0x107515;console[_0x29e5cf(0x10c)](_0x208f98),_0x2c4738(_0x54ac64);});}catch(_0x562cb0){console[_0x107515(0x10c)](_0x562cb0),_0x2c4738(_0x54ac64);}else _0x2c4738(_0x54ac64);}}},sharpUtil['returnDealedImage']=function(_0x339445,_0x1ac42b,_0x4b6c8d,_0x506130){const _0x492a50=_0x5e76f9;sharpUtil[_0x492a50(0xdf)](_0x1ac42b,(_0x36ce81,_0x147007,_0x5ebbe2)=>{const _0x168645=_0x492a50;sharpUtil[_0x168645(0x129)](_0x36ce81,_0x168645(0x113),!![],_0x4b6c8d,_0x168645(0x100),null,_0x33b03a=>{const _0x30ac55=_0x168645;_0x339445[_0x30ac55(0xe6)](Buffer[_0x30ac55(0x125)](_0x33b03a));},()=>{const _0x3245b7=_0x168645;_0x339445[_0x3245b7(0xe2)](0x194)[_0x3245b7(0x108)]();},_0x147007,_0x5ebbe2,_0x506130);});},sharpUtil[_0x5e76f9(0xfa)]=function(_0x792fda){const _0x270fbd=_0x5e76f9;return config['heicExt']['includes'](_0x792fda)||config[_0x270fbd(0xf5)][_0x270fbd(0xfb)](_0x792fda['toLowerCase']())||_0x792fda==_0x270fbd(0x101)||_0x792fda==_0x270fbd(0xf6)?!![]:![];},sharpUtil[_0x5e76f9(0x110)]=function(_0x408ef6){const _0x5cc17f=_0x5e76f9;let _0x134895=path['extname'](_0x408ef6)?path['extname'](_0x408ef6)[_0x5cc17f(0x12c)]():null;if(!_0x134895)return![];return sharpUtil[_0x5cc17f(0xfa)](_0x134895);},sharpUtil[_0x5e76f9(0xf3)]=function(_0x58a1e0,_0x205152,_0x4f0966,_0x3cc7a8,_0x207289){const _0x452721=_0x5e76f9;if(sharpUtil[_0x452721(0x110)](_0x205152)||_0x3cc7a8||_0x207289){let _0x4fba13=null,_0x52905e=null;return _0x3cc7a8&&_0x3cc7a8>=0x64&&_0x3cc7a8<=0x186a0&&(_0x4fba13={'fit':_0x452721(0x11c),'width':parseInt(_0x3cc7a8),'height':parseInt(_0x3cc7a8),'withoutEnlargement':!![]}),_0x207289&&_0x207289>=0x1e&&_0x207289<=0x64&&(_0x52905e={'quality':parseInt(_0x207289)}),sharpUtil[_0x452721(0x105)](_0x58a1e0,_0x205152,_0x4fba13,_0x52905e);}else{if(_0x4f0966){const _0x4d9e68=encodeURIComponent(path['basename'](_0x205152))['replace'](/%([0-9A-F]{2})/g,(_0x50b533,_0x228ad2)=>'%'+_0x228ad2[_0x452721(0xf9)]());_0x58a1e0[_0x452721(0x116)]('Content-Disposition',_0x452721(0xe5)+_0x4d9e68);}_0x58a1e0['sendFile'](_0x205152);}},module[_0x5e76f9(0xfc)]=sharpUtil;