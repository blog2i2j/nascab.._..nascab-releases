const _0x5c584e=_0x4559;(function(_0x4ea75f,_0xef4c4a){const _0x22ff79=_0x4559,_0x5cd0c4=_0x4ea75f();while(!![]){try{const _0x2bc8fe=-parseInt(_0x22ff79(0x16a))/0x1+-parseInt(_0x22ff79(0x185))/0x2*(parseInt(_0x22ff79(0x19e))/0x3)+-parseInt(_0x22ff79(0x17f))/0x4*(parseInt(_0x22ff79(0x162))/0x5)+parseInt(_0x22ff79(0x192))/0x6*(-parseInt(_0x22ff79(0x179))/0x7)+-parseInt(_0x22ff79(0x195))/0x8*(parseInt(_0x22ff79(0x186))/0x9)+parseInt(_0x22ff79(0x19c))/0xa*(parseInt(_0x22ff79(0x159))/0xb)+parseInt(_0x22ff79(0x1aa))/0xc;if(_0x2bc8fe===_0xef4c4a)break;else _0x5cd0c4['push'](_0x5cd0c4['shift']());}catch(_0x1b960e){_0x5cd0c4['push'](_0x5cd0c4['shift']());}}}(_0x21cd,0xe8612));let express=require('express'),router=express[_0x5c584e(0x1a3)](),path=require(_0x5c584e(0x19b));function _0x4559(_0xb899d3,_0x495584){const _0x21cd5e=_0x21cd();return _0x4559=function(_0x4559a0,_0xa051c1){_0x4559a0=_0x4559a0-0x155;let _0x5c04e3=_0x21cd5e[_0x4559a0];return _0x5c04e3;},_0x4559(_0xb899d3,_0x495584);}const dbUserTable=require(_0x5c584e(0x18d)),dbFileIndexTable=require(_0x5c584e(0x194));let fs=require('fs'),nasAccountUtil=require(_0x5c584e(0x155)),piexif=require('piexifjs'),geohash=require(_0x5c584e(0x16b));function getWaitAddGpsIndex(_0x3a2be3,_0x2d7e4d){const _0x5bb1ec=_0x5c584e;let _0x21e988=0x7d0,_0xe9c09f=dbFileIndexTable['getByWhere'](_0x3a2be3,_0x5bb1ec(0x17c)+_0x21e988+_0x5bb1ec(0x1a4)+_0x21e988+')\x20'+_0x2d7e4d,'*',dbFileIndexTable[_0x5bb1ec(0x177)]);if(_0xe9c09f){let _0x5d9977=_0xe9c09f[_0x5bb1ec(0x15c)]-0xe10*0x3e8*0xc,_0x3e1f70=_0xe9c09f[_0x5bb1ec(0x15c)]+0xe10*0x3e8*0xc,_0x143b0a='\x20\x20latitude\x20is\x20not\x20null\x20and\x20latitude!=\x27undefined\x27\x20and\x20geohash5\x20!=\x27undefined\x27\x20and\x20original_time\x20between\x20'+_0x5d9977+_0x5bb1ec(0x181)+_0x3e1f70+_0x5bb1ec(0x15f)+_0x21e988+_0x5bb1ec(0x19d)+_0x21e988+_0x5bb1ec(0x16e)+_0x2d7e4d+_0x5bb1ec(0x193)+_0xe9c09f[_0x5bb1ec(0x15c)]+')\x20asc\x20limit\x2050',_0x800d9e=dbFileIndexTable[_0x5bb1ec(0x1b1)](_0x3a2be3,_0x143b0a,'*',dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']);if(_0x800d9e&&_0x800d9e[_0x5bb1ec(0x1b0)]>0x0){let _0x40e1c1=[];if(_0xe9c09f[_0x5bb1ec(0x191)]&&_0xe9c09f['mode']!=_0x5bb1ec(0x16c)){let _0x17b228=0x32,_0x592c23=_0xe9c09f[_0x5bb1ec(0x15c)]-0xe10*0x3e8*0x3,_0x2ff224=_0xe9c09f['original_time']+0xe10*0x3e8*0x3;_0xe9c09f[_0x5bb1ec(0x191)]&&_0xe9c09f[_0x5bb1ec(0x191)]!='undefined'&&(_0x40e1c1=dbFileIndexTable[_0x5bb1ec(0x1b1)](_0x3a2be3,_0x5bb1ec(0x1a9)+_0xe9c09f[_0x5bb1ec(0x191)]+'\x27\x20and\x20original_time\x20between\x20'+_0x592c23+_0x5bb1ec(0x181)+_0x2ff224+'\x20\x20'+_0x2d7e4d+'\x20order\x20by\x20original_time\x20limit\x20'+_0x17b228,'*',dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']));}else _0x40e1c1['push'](_0xe9c09f);for(let _0x4e7cdc in _0x40e1c1){_0x40e1c1[_0x4e7cdc][_0x5bb1ec(0x164)]=path['join'](_0x40e1c1[_0x4e7cdc][_0x5bb1ec(0x19b)],_0x40e1c1[_0x4e7cdc][_0x5bb1ec(0x1ab)]);}if(_0x40e1c1[_0x5bb1ec(0x1b0)]==0x1)return dbFileIndexTable['updateById'](_0x3a2be3,_0x40e1c1[0x0]['id'],_0x5bb1ec(0x161),0x1,dbFileIndexTable[_0x5bb1ec(0x177)]),getWaitAddGpsIndex(_0x3a2be3,_0x2d7e4d);return{'dealList':_0x40e1c1,'nearIndex':_0x800d9e};}else return dbFileIndexTable[_0x5bb1ec(0x198)](_0x3a2be3,_0xe9c09f['id'],_0x5bb1ec(0x161),0x1,dbFileIndexTable['INDEX_TABLE_NAME_PHOTO']),getWaitAddGpsIndex(_0x3a2be3,_0x2d7e4d);}else return![];}router[_0x5c584e(0x1ad)](_0x5c584e(0x17b),(_0x1f15ed,_0x9669a1,_0x5b29c5)=>{const _0x166d9f=_0x5c584e;let _0x5caa44={'code':0x0,'data':''};if(dbUserTable[_0x166d9f(0x167)](_0x1f15ed,_0x9669a1,_0x166d9f(0x184),_0x166d9f(0x180))==!![]){let _0xfc926b='';_0x1f15ed[_0x166d9f(0x15e)]['is_admin']!=0x1&&(_0xfc926b=dbUserTable[_0x166d9f(0x1af)](_0x1f15ed,_0x166d9f(0x184),_0x166d9f(0x180),!![]));let _0x1fdca9=getWaitAddGpsIndex(_0x1f15ed[_0x166d9f(0x156)]['dbFileIndex'],_0xfc926b);return _0x1fdca9&&(_0x5caa44[_0x166d9f(0x15b)]=_0x1fdca9),_0x9669a1[_0x166d9f(0x172)](_0x5caa44);}}),router['post']('/confirmAddGps',(_0x1eb144,_0x3deac5,_0x3f57c9)=>{const _0x55949b=_0x5c584e;let _0x30dd04=_0x1eb144[_0x55949b(0x15a)]['type'],_0x4cc14d=_0x1eb144[_0x55949b(0x15a)][_0x55949b(0x1a6)];if(_0x4cc14d[_0x55949b(0x1b0)]<0x1)return _0x3deac5[_0x55949b(0x172)]({'code':0x0});nasAccountUtil[_0x55949b(0x1a1)](null,_0x1eb144[_0x55949b(0x156)][_0x55949b(0x1ae)])[_0x55949b(0x163)](_0x70bcfe=>{const _0x170767=_0x55949b;if(!_0x70bcfe)return _0x1eb144[_0x170767(0x156)][_0x170767(0x160)](_0x3deac5,_0x3deac5['__']('proxy.isntVip'));else _0x3eb611();});function _0x3eb611(){const _0x2fb2ae=_0x55949b;if(dbUserTable[_0x2fb2ae(0x167)](_0x1eb144,_0x3deac5,'photo','power_change')==!![]){let _0x52499a='(';for(let _0x532408 in _0x4cc14d){_0x52499a+=_0x4cc14d[_0x532408],_0x532408!=_0x4cc14d[_0x2fb2ae(0x1b0)]-0x1&&(_0x52499a+=',');}_0x52499a+=')';if(_0x30dd04==_0x2fb2ae(0x18a))return _0x1eb144[_0x2fb2ae(0x156)]['dbFileIndex'][_0x2fb2ae(0x174)](_0x2fb2ae(0x18b)+_0x52499a+'\x20')[_0x2fb2ae(0x17e)](),_0x3deac5[_0x2fb2ae(0x172)]({'code':0x0});else{if(_0x30dd04=='CONFIRM'){let _0x52b75b=_0x1eb144[_0x2fb2ae(0x15a)][_0x2fb2ae(0x18f)],_0x246d42=_0x1eb144[_0x2fb2ae(0x15a)][_0x2fb2ae(0x157)];if(!_0x52b75b||!_0x246d42)return _0x3deac5['json']({'code':0x0});_0x1eb144[_0x2fb2ae(0x156)]['dbFileIndex']['prepare']('UPDATE\x20file_index_photo\x20set\x20add_gps_status=1\x20WHERE\x20id\x20IN\x20'+_0x52499a+'\x20')['run']();let _0x5397d3=0x0,_0x18a4d9=0x0;for(let _0x18f9cb in _0x4cc14d){let _0x552774=dbFileIndexTable[_0x2fb2ae(0x171)](_0x1eb144[_0x2fb2ae(0x156)][_0x2fb2ae(0x190)],_0x4cc14d[_0x18f9cb]);if(!_0x552774)continue;let _0x227406=path['join'](_0x552774[_0x2fb2ae(0x19b)],path[_0x2fb2ae(0x18c)],_0x552774[_0x2fb2ae(0x1ab)]),_0x4a2192=fs[_0x2fb2ae(0x197)](_0x227406);if(!_0x4a2192[_0x2fb2ae(0x166)]()){_0x18a4d9+=0x1,_0x4a013a();continue;}fs[_0x2fb2ae(0x176)](_0x227406,(_0x46b51e,_0x15c4e4)=>{const _0xb3cb4=_0x2fb2ae;if(_0x46b51e)return _0x18a4d9+=0x1,_0x4a013a();var _0xf0f520=piexif[_0xb3cb4(0x18e)](_0x15c4e4['toString']('binary'));if(_0x52b75b&&_0x246d42){function _0x550b99(_0x45700c){const _0x44475c=_0xb3cb4;try{_0x45700c=Number(_0x45700c);let _0x4b8995=Math[_0x44475c(0x1a5)](Math[_0x44475c(0x189)](_0x45700c)),_0x35e348=(Math['abs'](_0x45700c)-_0x4b8995)*0x3c,_0x3dffe0=Math[_0x44475c(0x1a5)](_0x35e348),_0xf312f9=Math[_0x44475c(0x158)]((_0x35e348-_0x3dffe0)*0x3c*0x64);return[[_0x4b8995,0x1],[_0x3dffe0,0x1],[_0xf312f9,0x64]];}catch(_0x5afb4a){return'';}}_0xf0f520[_0xb3cb4(0x19a)][piexif[_0xb3cb4(0x178)][_0xb3cb4(0x16d)]]=_0x52b75b<0x0?'S':'N',_0xf0f520[_0xb3cb4(0x19a)][piexif[_0xb3cb4(0x178)][_0xb3cb4(0x196)]]=_0x550b99(_0x52b75b),_0xf0f520[_0xb3cb4(0x19a)][piexif[_0xb3cb4(0x178)][_0xb3cb4(0x1a8)]]=_0x246d42<0x0?'W':'E',_0xf0f520[_0xb3cb4(0x19a)][piexif['GPSIFD'][_0xb3cb4(0x169)]]=_0x550b99(_0x246d42);let _0x7e241a=geohash['encode'](_0x52b75b,_0x246d42,0x8),_0x547810=_0x7e241a['substring'](0x0,0x5),_0x523a8a=_0x7e241a[_0xb3cb4(0x173)](0x0,0x4),_0x384865=_0x7e241a[_0xb3cb4(0x173)](0x0,0x3),_0x15b3f7=_0x7e241a[_0xb3cb4(0x173)](0x0,0x2);dbFileIndexTable[_0xb3cb4(0x16f)](_0x1eb144[_0xb3cb4(0x156)][_0xb3cb4(0x190)],_0x552774['id'],_0xb3cb4(0x1a0)+_0x52b75b+'\x27,longitude=\x27'+_0x246d42+_0xb3cb4(0x1ac)+_0x7e241a+'\x27,geohash5=\x27'+_0x547810+_0xb3cb4(0x165)+_0x523a8a+'\x27,geohash3=\x27'+_0x384865+_0xb3cb4(0x187)+_0x15b3f7+'\x27\x20');}try{var _0x5d6896=piexif[_0xb3cb4(0x17d)](_0xf0f520),_0x417e80=piexif[_0xb3cb4(0x199)](_0x5d6896,_0x15c4e4[_0xb3cb4(0x168)](_0xb3cb4(0x188)));let _0x1cfb69=path[_0xb3cb4(0x183)](_0x552774['path'],_0x552774[_0xb3cb4(0x1ab)]);fs[_0xb3cb4(0x182)](_0x1cfb69,Buffer['from'](_0x417e80,'binary'),{},_0xcfd625=>{const _0x44f0ea=_0xb3cb4;if(_0xcfd625)return _0x18a4d9+=0x1,_0x4a013a();fs[_0x44f0ea(0x19f)](_0x1cfb69,new Date(_0x552774[_0x44f0ea(0x1a2)]),new Date(_0x552774[_0x44f0ea(0x1a2)]),_0x581000=>{const _0x36747a=_0x44f0ea;_0x581000&&console[_0x36747a(0x175)](_0x581000),fs[_0x36747a(0x17a)](_0x1cfb69,(_0x4296c1,_0x4a8d2f)=>{const _0x476195=_0x36747a;if(_0x4296c1)return _0x18a4d9+=0x1,_0x4a013a();dbFileIndexTable[_0x476195(0x16f)](_0x1eb144[_0x476195(0x156)][_0x476195(0x190)],_0x552774['id'],'\x20size='+_0x4a8d2f['size']+_0x476195(0x170)+_0x4a8d2f[_0x476195(0x15d)]+'\x20'),_0x5397d3+=0x1,_0x4a013a();});});});}catch(_0x1c17f5){return _0x18a4d9+=0x1,_0x4a013a();}});}function _0x4a013a(){const _0x5291ad=_0x2fb2ae;if(_0x5397d3+_0x18a4d9>=_0x4cc14d[_0x5291ad(0x1b0)])return _0x3deac5[_0x5291ad(0x172)]({'code':0x0,'sucCount':_0x5397d3,'errorCount':_0x18a4d9}),!![];}}}}}}),module[_0x5c584e(0x1a7)]=router;function _0x21cd(){const _0x4d7f22=['53190492oQDStw','filename','\x27,geohash=\x27','post','dbOther','getUserPathWhere','length','getAllByWhere','../../express-server/utils/nasAccountUtils','app','longitude','round','5545826nkzJIL','body','data','original_time','ctimeMs','currentUser','\x20\x20and\x20(width>=','returnErrMsg','add_gps_status','95dBRPYG','then','fullPath','\x27,geohash4=\x27','isFile','doUserCanGet','toString','GPSLongitude','852711ggPASo','ngeohash','undefined','GPSLatitudeRef',')\x20\x20','updateBySql',',ctime=','getById','json','substring','prepare','log','readFile','INDEX_TABLE_NAME_PHOTO','GPSIFD','7asyVIp','stat','/getWaitAddGpsIndex','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20(width>=','dump','run','229248FHeTJS','power_get','\x20and\x20','writeFile','join','photo','1002jZeudo','18bYZSos','\x27,geohash2=\x27','binary','abs','SKIP','UPDATE\x20file_index_photo\x20set\x20add_gps_status=2\x20WHERE\x20id\x20IN\x20','sep','../../db/dbUserTable','load','latitude','dbFileIndex','mode','8284314ebCfNV','\x20order\x20by\x20abs(original_time-','../../db/dbFileIndexTable','6681416gfWirL','GPSLatitude','statSync','updateById','insert','GPS','path','30nqiYLn','\x20or\x20height>=','3dEmwUR','utimes','\x20latitude=\x27','isVip','mtime','Router','\x20and\x20height>=','floor','indexIdList','exports','GPSLongitudeRef','\x20add_gps_status=0\x20and\x20type=1\x20and\x20ext\x20in\x20(\x27.jpg\x27,\x27.jpeg\x27,\x27.JPG\x27,\x27.JPEG\x27)\x20and\x20(latitude\x20is\x20null\x20or\x20latitude=\x27undefined\x27)\x20and\x20mode=\x27'];_0x21cd=function(){return _0x4d7f22;};return _0x21cd();}