const _0x30fb4f=_0x2834;(function(_0x517d4a,_0x538820){const _0x14c205=_0x2834,_0x17e04f=_0x517d4a();while(!![]){try{const _0x465494=-parseInt(_0x14c205(0x1f4))/0x1*(parseInt(_0x14c205(0x2a6))/0x2)+-parseInt(_0x14c205(0x20e))/0x3*(-parseInt(_0x14c205(0x1f7))/0x4)+-parseInt(_0x14c205(0x289))/0x5*(parseInt(_0x14c205(0x297))/0x6)+parseInt(_0x14c205(0x26a))/0x7+parseInt(_0x14c205(0x280))/0x8*(parseInt(_0x14c205(0x2ae))/0x9)+parseInt(_0x14c205(0x28f))/0xa*(parseInt(_0x14c205(0x21f))/0xb)+parseInt(_0x14c205(0x272))/0xc*(-parseInt(_0x14c205(0x1a4))/0xd);if(_0x465494===_0x538820)break;else _0x17e04f['push'](_0x17e04f['shift']());}catch(_0x54898b){_0x17e04f['push'](_0x17e04f['shift']());}}}(_0x25af,0xc10e6));let express=require(_0x30fb4f(0x252)),router=express[_0x30fb4f(0x1a7)](),path=require(_0x30fb4f(0x2ce));function _0x2834(_0x32180c,_0x369249){const _0x25af31=_0x25af();return _0x2834=function(_0x2834c2,_0x413a66){_0x2834c2=_0x2834c2-0x181;let _0x319103=_0x25af31[_0x2834c2];return _0x319103;},_0x2834(_0x32180c,_0x369249);}const sharp=require(_0x30fb4f(0x192)),config=require(_0x30fb4f(0x1cf)),dbFileIndexTable=require(_0x30fb4f(0x29a)),dbSourceFolderTable=require(_0x30fb4f(0x2ad)),dbFileOperationRecord=require(_0x30fb4f(0x185));let checkUtil=require(_0x30fb4f(0x292));const sqliteUtil=require(_0x30fb4f(0x251)),exifUtils=require(_0x30fb4f(0x215)),dbUserTable=require(_0x30fb4f(0x1bc)),dbAlbumTable=require(_0x30fb4f(0x1f3));let geohash=require('ngeohash'),fs=require('fs');const dbConfigTable=require(_0x30fb4f(0x1ab));let sharpUtil=require('../utils/sharpUtils'),nasAccountUtil=require(_0x30fb4f(0x182)),fileUtil=require(_0x30fb4f(0x278));const photoApiUtil=require(_0x30fb4f(0x23b)),platform=require('os')[_0x30fb4f(0x2c5)](),photoIndexUtil=require(_0x30fb4f(0x290));function _0x25af(){const _0x1fc52a=['Router','ordinaryAlbumId','SELECT\x20*\x20FROM\x20photo_library\x20','error\x20pathList','../../db/dbConfigTable','editId','size','sourceFolderList','stringify','\x27,geohash2=\x27','update\x20file_index_photo\x20set\x20ai_face_detect_state=0','\x20type=2\x20\x20','shareUidList','chi','searchMode','UPDATE\x20photo_faces\x20SET\x20disabled=?\x20where\x20','update','GPS','\x20AND\x20(filename\x20LIKE\x20?\x20OR\x20mode\x20\x20LIKE\x20?)','then','delete\x20from\x20photo_phash_similar\x20where\x20index_id=','../../db/dbUserTable','writeFile','/switchFaceId','resize','returnErrMsg','face_id','power_get','STATE_FAIL','parse','putInSystemTrash','extract','/getBoundsPhoto','type','all','load','delete\x20from\x20photo_faces2index\x20where\x201=1','photo_index_id','faceapi','dbOther','../../myConfig/config','/getFileTreePhoto','dataPreview','existsSync','sendFile','faceApiWaitCompareCount','parent','trash','showFileType','TYPE_DELETE','end','GPSDateStamp','/editExifByIndexId','geoInfoWriteErr','UPDATE\x20photo_faces\x20SET\x20disabled=?\x20where\x20id\x20=\x20?','getList','getFullYear','transSpcielFormat','/clearTrashBin','\x20path=\x27','\x20id,latitude,longitude,geohash,tiny_path','UPDATE\x20photo_faces\x20SET\x20belong_face_id=?\x20where\x20id\x20=\x20?','latitude','close','\x27,longitude=\x27','create','query','\x20and\x20a.is_face_poster=1\x20limit\x201','abs','readFile','findByTitle','substring','prepare','defaultTranscodeResolution','mtime','raw_filename','../../db/dbAlbumTable','491653ZPvkLd','shell','\x20WHERE\x20id\x20=\x20','4916QtwDgd','getAlbumWhereStr','mkdir','f2x','includes','\x20SET\x20in_trash=0\x20WHERE\x20in_trash=1','newDate','create_time','/getTimeLineDateList','excludeFilenamePhoto','original_time','GET','.HEIC','floor','SELECT\x20*\x20FROM\x20file_index_photo\x20WHERE\x20in_trash=1\x20AND\x20is_file=1\x20AND\x20raw_filename\x20is\x20not\x20null\x20AND\x20raw_filename!=\x27\x27\x20AND\x20type=1','\x20\x20AND\x20filename\x20LIKE\x20\x27%','updateBySql','run','/getPhotoByTime','UPDATE\x20photo_faces2index\x20SET\x20is_face_poster=1\x20where\x20photo_index_id\x20=\x20','app','isIndexing','getAllByWhereAndField','2145KDpMjD','\x20LIMIT\x20?\x20OFFSET\x20?','/resetFaceAi','indexId','.jpeg','DELETE\x20FROM\x20photo_library\x20\x20WHERE\x20id=?','\x20WHERE\x20title\x20like\x20?','../../utils/exifUtils','photo','dbFileIndex','\x20order\x20by\x20score\x20desc','startFaceAiWork','getFileHashName','%\x27\x20OR\x20mode\x20\x20LIKE\x20\x27%','%\x27)\x20','startSimilarPhotoWork','delete\x20from\x20photo_faces\x20where\x201=1','29337Tzlfso','toLowerCase','\x20AND\x20geohash\x20LIKE\x20?\x20','asc','status','sep','aiClassesEnable','getAllByWhereAndFieldFromOrdinaryAlbum','SELECT\x20*\x20FROM\x20photo_faces\x20WHERE\x20face_name=?\x20and\x20belong_face_id\x20is\x20null','getUserPathWhere','disabled','\x20size=','error\x20data','aiSimilarPhotoEnable','body','geohash5\x20=\x20','\x20AND\x20','\x20is_file=1\x20','toFile','timeOrder','currentUser','get','LEVEL_MAIN_OPERATION','SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20file_index_photo\x20WHERE\x20ai_face_detect_state=0\x20and\x20(type=1\x20or\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20','Exif','aiClassId','getMonth','findWithField','./photoApiUtils','getByName','\x20ORDER\x20BY\x20is_file\x20asc,\x20','index_id','aiFaceEnable','faceName','addFileOperationRecord','zoom','/setFacePoster','operationFail','excludeIds','f2y','binary','geohash3\x20=\x20','minLng','.jpg','/updatePhotoFace','is_admin','getById','basename','serverType','path_list','../utils/sqliteUtil','express','SELECT\x20f.id\x20as\x20photo_index_id\x20FROM\x20ai_classes2index\x20as\x20a\x20INNER\x20JOIN\x20file_index_photo\x20as\x20f\x20ON\x20a.photo_index_id=f.id\x20WHERE\x20a.class_id=?\x20and\x20score>?\x20and\x20\x20f.in_trash=0\x20\x20and\x20f.tiny_path\x20is\x20not\x20null\x20AND\x20f.tiny_path\x20!=\x20\x270\x27\x20\x20','id,username','facesPath','maxLng','deleteList','face_img_path','\x20original_time=\x27','power_delete','geohash4\x20=\x20','filename','EDIT','excludePathPhoto','%\x27\x20','/deleteAlbum','DELETE','minIndexId','libraryId','geohash2\x20=\x20','/getSimilarPhoto','\x20\x20AND\x20(filename\x20LIKE\x20\x27%','faceId','targetFaceId','operation\x20fail','1643684UbkpYD','round','changes','power_change','getAllByWhereAndFieldFromOrdinaryAlbumCount','indexObj','title','getPathWhere','305496HGbMaN','faceApiWaitDealCount','post','is_file','getAllByWhere','GPSLatitude','../utils/fileUtils','replace','imgList','/getFaceImg/*','SELECT\x20*\x20FROM\x20photo_library\x20WHERE\x20share_for_subuser=1','/resetSimilarPhotoAi','SELECT\x20*\x20FROM\x20photo_library\x20WHERE\x20id=?','class_id','5896664yHhfbY','file_index_photo-indexing','cachePath','getPhotoByParams','searchStr','photoIndexId','offset','\x20is_file,id,path,filename,ext,type,width,height,duration,size,original_date,original_time,latitude,longitude\x20','join','1115tiJjzS','noPermission','SELECT\x20*\x20FROM\x20ai_classes\x20where\x20\x20class_name\x20not\x20in\x20','getPathByType','music','dialog','4770awuQVj','../../myWorkers/index/photoIndexUtil','INDEX_TABLE_NAME_MUSIC','../utils/checkUtil','/getPhotoFaces','keepIndexList','\x20AND\x20(type=1\x20or\x20type=2)\x20AND\x20in_trash=0','searchValue','3624KaLbVb','filename_number','/mergeFace','../../db/dbFileIndexTable','SELECT\x20*\x20from\x20photo_phash_similar\x20where\x20index_id=','data','\x27,geohash4=\x27','GPSLatitudeRef','ERROR\x20GPS\x20LOCATION','name','/getAiDealState','getSharpInstanceFromInput','isVip','from','stat','2SHQdHC','operation','f2height','aiFaceMinPhotoCount','GPSLongitudeRef','serveType','.MOV','../../db/dbSourceFolderTable','9vzjNey','/addAlbum','\x27\x20AND\x20','similar_index_id','checkSqlInjection','is_livephoto','cocossd','delete\x20from\x20photo_phash_similar\x20where\x201=1','fileType','GPSIFD','movie','key','desc','INDEX_TABLE_NAME_PHOTO','video','minLat','\x27,geohash=\x27','SELECT\x20f.id\x20FROM\x20photo_faces2index\x20as\x20p\x20INNER\x20JOIN\x20file_index_photo\x20as\x20f\x20ON\x20p.photo_index_id=f.id\x20WHERE\x20p.face_id=?\x20','\x20ORDER\x20BY\x20','.JPG','send','UPDATE\x20photo_library\x20SET\x20title=?,path_list=?,share_for_subuser=?,share_uid=?\x20WHERE\x20id=?','username','platform','\x27\x20where\x20id=','存在livephoto','rotate','getIndexTableNameByType','GPSLongitude','f2width','getTime','folderNotExist','path','UPDATE\x20photo_faces\x20SET\x20face_img_path=\x27\x27\x20where\x20id=','getExcludePathWhereStr','.MP4','piexifjs','dump','length','similar','utimes','json','/getPhotoClasses','rawFaceIndexIdList','trim',',ctime=','UPDATE\x20file_index_photo\x20SET\x20is_show=0\x20WHERE\x20path=?\x20AND\x20filename\x20=?','SELECT\x20index_id\x20FROM\x20photo_phash_similar\x20group\x20by\x20index_id','value','dealList','INDEX_TABLE_NAME_MOVIE','getTimeLineDateList','getByWhere','\x20LIMIT\x20','getFaceInSql','ctimeMs','UPDATE\x20','delete','SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20photo_faces2index\x20WHERE\x20compare_state=0','timeType','pathList','moviePlaylongPressRate','\x20SET\x20in_trash=1,in_trash_time=','/getIndexDetail','count','fileExist','udpateName','similarWaitDealCount','search','albumId','../utils/nasAccountUtils','log','dirname','../../db/dbFileOperationRecord','f2id','UPDATE\x20photo_faces2index\x20SET\x20is_face_poster=0\x20where\x20is_face_poster=1\x20and\x20face_id\x20in\x20','sortField','SELECT\x20*\x20FROM\x20photo_faces\x20where\x20id\x20=?','indexFullPath','rawFaceId','similarIndexList','sortType','doUserCanGet','\x20is_file,id,path,filename,ext,type,width,height,duration,size,original_date,original_time\x20','orderType','\x20AND\x20geohash4!=\x27undefined\x27\x20GROUP\x20BY\x20geohash4','sharp','ADD','\x20latitude=\x27','album.sameNameExist','SELECT\x20*\x20FROM\x20photo_faces\x20WHERE\x20disabled=0\x20and\x20belong_face_id\x20is\x20null\x20and\x20face_photo_count>=?\x20order\x20by\x20face_photo_count\x20desc\x20limit\x20500','\x20LIMIT\x201','getRotateFromTags','deleteRawTempFile','timestamp','SELECT\x20*\x20FROM\x20photo_faces\x20WHERE\x20id=?','UPDATE\x20photo_faces\x20SET\x20belong_face_id=?\x20where\x20id\x20=\x20?\x20or\x20belong_face_id=?','moviePreferLanguage','transaction','push','orderField','\x27,geohash3=\x27','book','\x20AND\x20in_trash=0\x20\x20\x20AND\x20is_file=1\x20\x20\x20AND\x20tiny_path\x20!=\x20\x270\x27\x20limit\x201','871AKyWWz','INDEX_TABLE_NAME_BOOK','\x20(((type=1\x20or\x20type=2)\x20\x20)\x20OR\x20is_file=0\x20)\x20'];_0x25af=function(){return _0x1fc52a;};return _0x25af();}let piexif=require(_0x30fb4f(0x2d2));router[_0x30fb4f(0x274)](_0x30fb4f(0x1ff),(_0x363745,_0x38de3d,_0x475b15)=>{const _0xc83761=_0x30fb4f;if(dbUserTable[_0xc83761(0x18e)](_0x363745,_0x38de3d,'photo','power_get')==!![]){let _0x422322=_0x363745[_0xc83761(0x22d)]['year'],_0x81e22=_0x363745['body']['type'],_0x55bb04=_0x363745['body']['geohash'],_0x5a1879=_0x363745[_0xc83761(0x22d)][_0xc83761(0x181)],_0xe20204=_0x363745[_0xc83761(0x22d)]['searchStr'],_0x187fdd=_0x363745[_0xc83761(0x22d)]['ordinaryAlbumId'],_0x77d914=_0x363745['body'][_0xc83761(0x238)],_0x17afa2=_0x363745[_0xc83761(0x22d)][_0xc83761(0x263)],_0x3245fd=_0x363745[_0xc83761(0x22d)][_0xc83761(0x267)],_0x42ed48=_0x363745['body'][_0xc83761(0x232)],_0x14193d=_0x363745[_0xc83761(0x22d)][_0xc83761(0x1ae)],_0x29eeaf=dbUserTable[_0xc83761(0x228)](_0x363745,'photo','power_get',!![],_0x14193d),_0x3179ba=_0x29eeaf,_0x529216=[];_0x55bb04&&(_0x3179ba+=_0xc83761(0x221),_0x529216[_0xc83761(0x19f)](_0x55bb04+'%'));let _0x57f4a5=dbSourceFolderTable[_0xc83761(0x2d0)](_0x363745[_0xc83761(0x20b)][_0xc83761(0x1ce)],'path',_0xc83761(0x25e));_0x57f4a5&&(_0x3179ba+=_0xc83761(0x22f)+_0x57f4a5);let _0xc45f4f=dbSourceFolderTable[_0xc83761(0x2d0)](_0x363745[_0xc83761(0x20b)][_0xc83761(0x1ce)],_0xc83761(0x25c),_0xc83761(0x200));_0xc45f4f&&(_0x3179ba+=_0xc83761(0x22f)+_0xc45f4f);if(_0x17afa2){let _0x57ea7e=_0x363745['app'][_0xc83761(0x217)][_0xc83761(0x1ef)](_0xc83761(0x27e))[_0xc83761(0x234)](_0x17afa2);if(_0x57ea7e)try{let _0x509e97=JSON[_0xc83761(0x1c4)](_0x57ea7e[_0xc83761(0x250)]),_0x2b89b9=dbUserTable[_0xc83761(0x271)](!![],_0x509e97);_0x3179ba+=_0x2b89b9;}catch(_0x52ea61){console['log'](_0x52ea61);}}if(_0x5a1879){let _0x1a393a=dbAlbumTable[_0xc83761(0x1f8)](_0x363745['app'][_0xc83761(0x1ce)],_0x5a1879);_0x1a393a&&(_0x3179ba+=_0xc83761(0x22f)+_0x1a393a);}_0xe20204&&(_0x3179ba+=_0xc83761(0x1b9),_0x529216['push']('%'+_0xe20204+'%'),_0x529216[_0xc83761(0x19f)]('%'+_0xe20204+'%'));_0x3179ba+='\x20\x20\x20AND\x20in_trash!=1\x20';let _0x1f0a18=dbFileIndexTable[_0xc83761(0x2e1)](_0x363745[_0xc83761(0x20b)]['dbFileIndex'],_0x422322,_0x81e22,_0x3179ba,_0x187fdd,_0x77d914,_0x3245fd,_0x529216,_0x42ed48);_0x38de3d[_0xc83761(0x2d7)]({'code':0x0,'data':_0x1f0a18});}}),router['post'](_0x30fb4f(0x209),(_0x3aa9ea,_0x51be03,_0x4ebeb2)=>{const _0x60a462=_0x30fb4f;dbUserTable['doUserCanGet'](_0x3aa9ea,_0x51be03,_0x60a462(0x216),_0x60a462(0x1c2))==!![]&&(result=photoApiUtil[_0x60a462(0x283)](_0x3aa9ea,_0x51be03),_0x51be03[_0x60a462(0x2d7)]({'code':0x0,'data':result}));}),router['post']('/getAlbumPhotoForMap',(_0x4ff4a3,_0x480717,_0x58d573)=>{const _0x234346=_0x30fb4f;let _0x32ebd2=dbUserTable[_0x234346(0x228)](_0x4ff4a3,_0x234346(0x216),'power_get',!![]),_0x221cdf=_0x234346(0x1e3),_0x8313d5='\x20in_trash=0\x20AND\x20latitude!=\x27undefined\x27\x20AND\x20longitude!=\x27undefined\x27\x20AND\x20latitude\x20is\x20not\x20null',_0x39bb30=_0x4ff4a3[_0x234346(0x22d)][_0x234346(0x263)];if(_0x4ff4a3[_0x234346(0x22d)]['albumId']){let _0x30ca41=dbAlbumTable['getAlbumWhereStr'](_0x4ff4a3[_0x234346(0x20b)][_0x234346(0x1ce)],_0x4ff4a3['body']['albumId']);_0x30ca41&&(_0x8313d5+=_0x234346(0x22f)+_0x30ca41);}if(_0x39bb30){let _0x54dc4f=_0x4ff4a3['app'][_0x234346(0x217)][_0x234346(0x1ef)](_0x234346(0x27e))['get'](_0x39bb30);if(_0x54dc4f)try{let _0x427b4c=JSON[_0x234346(0x1c4)](_0x54dc4f[_0x234346(0x250)]),_0x14bf45=dbUserTable[_0x234346(0x271)](!![],_0x427b4c);_0x8313d5+=_0x14bf45;}catch(_0x4d1867){console[_0x234346(0x183)](_0x4d1867);}}function _0x140026(_0x534ae5,_0x26c4b3,_0xbc4a57){const _0x18c836=_0x234346;if(_0xbc4a57){let _0x145b5b=0x0;if(_0x4ff4a3['body'][_0x18c836(0x1a8)]){let _0x458080=dbFileIndexTable[_0x18c836(0x26e)](_0x4ff4a3[_0x18c836(0x20b)][_0x18c836(0x217)],_0x4ff4a3[_0x18c836(0x22d)][_0x18c836(0x1a8)],_0x534ae5);_0x145b5b=_0x458080[_0x18c836(0x2ee)];}else{let _0x3b5c5c=dbFileIndexTable['getCountByWhere'](_0x4ff4a3['app']['dbFileIndex'],_0x534ae5);_0x145b5b=_0x3b5c5c['count'];}return _0x145b5b;}else{let _0x58b15b=[];return _0x4ff4a3[_0x18c836(0x22d)][_0x18c836(0x1a8)]?_0x58b15b=dbFileIndexTable[_0x18c836(0x226)](_0x4ff4a3['app'][_0x18c836(0x217)],_0x4ff4a3[_0x18c836(0x22d)][_0x18c836(0x1a8)],_0x534ae5,_0x26c4b3):_0x58b15b=dbFileIndexTable[_0x18c836(0x20d)](_0x4ff4a3[_0x18c836(0x20b)][_0x18c836(0x217)],_0x534ae5,_0x26c4b3,dbFileIndexTable[_0x18c836(0x2bb)]),_0x58b15b;}}_0x8313d5+=_0x32ebd2,_0x8313d5+='\x20AND\x20\x20is_file=1\x20';let _0x242d4d=0xc8,_0x205e44=[],_0x247514=_0x140026(_0x8313d5,null,!![]);if(_0x247514<_0x242d4d)_0x205e44=_0x140026(_0x8313d5,'*');else{let _0x103606=_0x8313d5+'\x20AND\x20geohash5!=\x27undefined\x27\x20GROUP\x20BY\x20geohash5',_0x2cbefa=_0x140026(_0x103606,'*');if(_0x2cbefa&&_0x2cbefa[_0x234346(0x2d4)]<_0x242d4d)_0x205e44=_0x2cbefa;else{let _0x140285=_0x8313d5+_0x234346(0x191),_0x537ea8=_0x140026(_0x140285,'*');if(_0x537ea8&&_0x537ea8['length']<_0x242d4d)_0x205e44=_0x537ea8;else{let _0x121fdd=_0x8313d5+'\x20AND\x20geohash3!=\x27undefined\x27\x20GROUP\x20BY\x20geohash3',_0xad116f=_0x140026(_0x121fdd,'*');if(_0xad116f&&_0xad116f[_0x234346(0x2d4)]<_0x242d4d)_0x205e44=_0xad116f;else{let _0x35b34b=_0x8313d5+'\x20AND\x20geohash2!=\x27undefined\x27\x20GROUP\x20BY\x20geohash2';_0x205e44=_0x140026(_0x35b34b,'*');}}}}return _0x480717['json']({'code':0x0,'mapPhoto':_0x205e44});}),router[_0x30fb4f(0x274)](_0x30fb4f(0x1c7),(_0x1d8dc6,_0x4d0cb5,_0x2a7db0)=>{const _0x4d37f8=_0x30fb4f;if(dbUserTable[_0x4d37f8(0x18e)](_0x1d8dc6,_0x4d0cb5,_0x4d37f8(0x216),_0x4d37f8(0x1c2))==!![]){let _0x4dcd54=dbUserTable['getUserPathWhere'](_0x1d8dc6,_0x4d37f8(0x216),'power_get',!![]),_0x367418=_0x1d8dc6[_0x4d37f8(0x22d)][_0x4d37f8(0x2bd)],_0x3a050f=_0x1d8dc6[_0x4d37f8(0x22d)][_0x4d37f8(0x249)],_0x5ab341=_0x1d8dc6[_0x4d37f8(0x22d)]['maxLat'],_0xf15684=_0x1d8dc6['body'][_0x4d37f8(0x256)],_0x32a898=_0x1d8dc6[_0x4d37f8(0x22d)][_0x4d37f8(0x242)],_0x13fcef='',_0x53c44a=0x2;if(_0x32a898<=0x4)_0x53c44a=0x2,_0x13fcef=_0x4d37f8(0x264);else{if(_0x32a898<=0x6)_0x53c44a=0x3,_0x13fcef=_0x4d37f8(0x248);else{if(_0x32a898<=0x8)_0x53c44a=0x4,_0x13fcef=_0x4d37f8(0x25b);else _0x32a898<=0xc&&(_0x53c44a=0x5,_0x13fcef=_0x4d37f8(0x22e));}}let _0x5d5acf=geohash['bboxes'](_0x367418,_0x3a050f,_0x5ab341,_0xf15684,_0x53c44a),_0x1b43c8=[];for(let _0x1f4f55=0x0;_0x1f4f55<_0x5d5acf[_0x4d37f8(0x2d4)];_0x1f4f55++){let _0x1c277e=_0x5d5acf[_0x1f4f55],_0x4c3d86='\x20'+_0x13fcef+'\x20\x27'+_0x1c277e+'\x27\x20'+_0x4dcd54+_0x4d37f8(0x1a3),_0x16bb1e=dbFileIndexTable[_0x4d37f8(0x2e2)](_0x1d8dc6[_0x4d37f8(0x20b)]['dbFileIndex'],_0x4c3d86,'\x20id,geohash,latitude,longitude\x20');_0x16bb1e&&_0x1b43c8['push'](_0x16bb1e);}_0x4d0cb5['json']({'code':0x0,'mapPhoto':_0x1b43c8});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x2af),(_0x11126,_0x5904ff,_0x530ced)=>{const _0x47d2cc=_0x30fb4f;if(dbUserTable[_0x47d2cc(0x18e)](_0x11126,_0x5904ff,_0x47d2cc(0x216),'power_add')==!![]){let _0x3c2a0f=_0x11126[_0x47d2cc(0x22d)][_0x47d2cc(0x1c8)],_0x318581=_0x11126[_0x47d2cc(0x22d)][_0x47d2cc(0x29c)],_0x388f51=_0x11126['body']['data_value'],_0x5c3fd2=_0x11126[_0x47d2cc(0x22d)][_0x47d2cc(0x2a0)],_0x4829da=_0x11126[_0x47d2cc(0x22d)][_0x47d2cc(0x1ac)];if(!_0x318581||!_0x318581[_0x47d2cc(0x296)]||sqliteUtil[_0x47d2cc(0x2b2)](_0x318581[_0x47d2cc(0x296)])==!![])return _0x11126[_0x47d2cc(0x20b)][_0x47d2cc(0x1c0)](_0x5904ff,_0x47d2cc(0x22b));if(!_0x4829da){let _0x59bbef=dbAlbumTable['getByName'](_0x11126['app'][_0x47d2cc(0x1ce)],_0x5c3fd2);if(_0x59bbef)return _0x11126[_0x47d2cc(0x20b)][_0x47d2cc(0x1c0)](_0x5904ff,_0x5904ff['__'](_0x47d2cc(0x195)));}let _0xb66d31=null;_0x4829da?_0xb66d31=dbAlbumTable[_0x47d2cc(0x1b7)](_0x11126[_0x47d2cc(0x20b)][_0x47d2cc(0x1ce)],{'type':_0x3c2a0f,'data':_0x318581,'data_value':_0x388f51,'name':_0x5c3fd2},_0x4829da):_0xb66d31=dbAlbumTable[_0x47d2cc(0x1e8)](_0x11126[_0x47d2cc(0x20b)]['dbOther'],{'type':_0x3c2a0f,'data':_0x318581,'data_value':_0x388f51,'name':_0x5c3fd2}),_0x5904ff[_0x47d2cc(0x2d7)]({'code':0x0,'result':_0xb66d31});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x260),(_0x2b739c,_0x43dc72,_0x27156e)=>{const _0x8ea0d1=_0x30fb4f;if(dbUserTable[_0x8ea0d1(0x18e)](_0x2b739c,_0x43dc72,_0x8ea0d1(0x216),_0x8ea0d1(0x25a))==!![]){let _0x5019d2=_0x2b739c['body']['id'],_0x575f54=dbAlbumTable[_0x8ea0d1(0x2e7)](_0x2b739c['app']['dbOther'],_0x5019d2);_0x575f54[_0x8ea0d1(0x26c)]>0x0?_0x43dc72[_0x8ea0d1(0x2d7)]({'code':0x0,'result':_0x575f54}):_0x43dc72[_0x8ea0d1(0x2d7)]({'code':0x1,'message':'operation\x20fail'});}}),router[_0x30fb4f(0x274)]('/updateAlbum',(_0x452040,_0x2039a5,_0x375534)=>{const _0x3f5c9a=_0x30fb4f;if(dbUserTable[_0x3f5c9a(0x18e)](_0x452040,_0x2039a5,'photo',_0x3f5c9a(0x26d))==!![]){let _0x29d060=_0x452040[_0x3f5c9a(0x22d)]['id'],_0xceb59e=_0x452040['body']['name'],_0x4afd49=dbAlbumTable[_0x3f5c9a(0x23c)](_0x452040['app'][_0x3f5c9a(0x1ce)],_0xceb59e);if(_0x4afd49)return _0x452040[_0x3f5c9a(0x20b)]['returnErrMsg'](_0x2039a5,_0x2039a5['__'](_0x3f5c9a(0x195)));let _0x3fd8ca=dbAlbumTable[_0x3f5c9a(0x2f0)](_0x452040[_0x3f5c9a(0x20b)]['dbOther'],_0x29d060,_0xceb59e);_0x3fd8ca[_0x3f5c9a(0x26c)]>0x0?_0x2039a5['json']({'code':0x0,'result':_0x3fd8ca}):_0x2039a5[_0x3f5c9a(0x2d7)]({'code':0x1,'message':_0x3f5c9a(0x269)});}}),router[_0x30fb4f(0x274)]('/getAllAlbum',(_0x114770,_0x55f07a,_0x2ae23c)=>{const _0x16451e=_0x30fb4f;if(dbUserTable[_0x16451e(0x18e)](_0x114770,_0x55f07a,_0x16451e(0x216),_0x16451e(0x1c2))==!![]){let _0x3707a9=dbUserTable[_0x16451e(0x228)](_0x114770,'photo',_0x16451e(0x1c2),!![]),_0x5cdc59=_0x114770[_0x16451e(0x22d)]['count']||0x32,_0x524e99=_0x114770['body'][_0x16451e(0x286)]||0x0,_0x549a06=_0x114770[_0x16451e(0x22d)]['orderField']||'id',_0x4492da=_0x114770['body'][_0x16451e(0x190)]||_0x16451e(0x2ba),_0x4bd4b2=_0x114770[_0x16451e(0x22d)]['search'];(![_0x16451e(0x2a0),'id']['includes'](_0x549a06)||![_0x16451e(0x222),_0x16451e(0x2ba)]['includes'](_0x4492da))&&_0x55f07a[_0x16451e(0x2d7)]({'code':0x0,'data':[]});let _0x2aeac5=dbAlbumTable[_0x16451e(0x1de)](_0x114770[_0x16451e(0x20b)][_0x16451e(0x1ce)],_0x5cdc59,_0x524e99,_0x549a06,_0x4492da,_0x4bd4b2);for(let _0x2e3f12=0x0;_0x2e3f12<_0x2aeac5[_0x16451e(0x2d4)];_0x2e3f12++){let _0x2252b5=_0x16451e(0x230);_0x2252b5+=_0x3707a9;let _0x45713f=dbAlbumTable['getAlbumWhereStr'](_0x114770[_0x16451e(0x20b)][_0x16451e(0x1ce)],_0x2aeac5[_0x2e3f12]['id']);_0x45713f&&(_0x2252b5+=_0x16451e(0x22f)+_0x45713f);_0x2252b5+=_0x16451e(0x295),_0x2252b5+='\x20ORDER\x20BY\x20original_time\x20DESC\x20LIMIT\x201';try{let _0x2a6885=dbFileIndexTable[_0x16451e(0x276)](_0x114770[_0x16451e(0x20b)][_0x16451e(0x217)],_0x2252b5);_0x2aeac5[_0x2e3f12][_0x16451e(0x27a)]=_0x2a6885;}catch(_0x5bd2dd){console['log'](_0x5bd2dd),_0x2aeac5[_0x2e3f12][_0x16451e(0x27a)]=[];}}_0x55f07a[_0x16451e(0x2d7)]({'code':0x0,'data':_0x2aeac5});}}),router['post']('/searchMode',(_0x3d515a,_0x513b7e,_0x322fc1)=>{const _0x19d106=_0x30fb4f;let _0x134196=_0x3d515a['body'][_0x19d106(0x2b9)],_0x2c7749=dbFileIndexTable[_0x19d106(0x1b5)](_0x3d515a['app'][_0x19d106(0x217)],_0x134196),_0x24c6dd=[];for(let _0x286199=0x0;_0x286199<_0x2c7749['length'];_0x286199++){_0x24c6dd['push'](_0x2c7749[_0x286199]['mode']);}_0x513b7e['json']({'code':0x0,'data':_0x24c6dd});}),router[_0x30fb4f(0x274)](_0x30fb4f(0x1d0),(_0x51a2f0,_0x233318,_0x2a55b2)=>{const _0x32b147=_0x30fb4f;let _0x2a3e31=_0x51a2f0[_0x32b147(0x22d)][_0x32b147(0x1d5)],_0x26c14e=_0x51a2f0['body'][_0x32b147(0x2ab)],_0x488daa=_0x51a2f0[_0x32b147(0x22d)]['count'],_0xae1bcb=_0x51a2f0['body'][_0x32b147(0x286)]||0x0;_0xae1bcb=parseInt(_0xae1bcb);let _0x4fe932=parseInt(_0x51a2f0[_0x32b147(0x22d)][_0x32b147(0x1d7)]),_0x477e82=_0x51a2f0['body'][_0x32b147(0x284)],_0xf07b61=[_0x32b147(0x25c),_0x32b147(0x201),_0x32b147(0x1ad),_0x32b147(0x1fe),_0x32b147(0x298)],_0x515003=[_0x32b147(0x222),_0x32b147(0x2ba)],_0x1b96f5=_0x51a2f0['body'][_0x32b147(0x1a0)]||'id',_0x2badef=_0x51a2f0[_0x32b147(0x22d)]['orderType']||_0x32b147(0x2ba);!_0xf07b61[_0x32b147(0x1fb)](_0x1b96f5)&&(_0x1b96f5='id');!_0x515003[_0x32b147(0x1fb)](_0x2badef)&&(_0x1b96f5=_0x32b147(0x2ba));if(dbUserTable[_0x32b147(0x18e)](_0x51a2f0,_0x233318,_0x26c14e,'power_get')==!![]){let _0x1ba579=[];if(!_0x2a3e31){let _0x3bbc7b=[];_0x51a2f0[_0x32b147(0x233)][_0x32b147(0x24c)]==0x1?_0x3bbc7b=dbSourceFolderTable[_0x32b147(0x28c)](_0x51a2f0[_0x32b147(0x20b)][_0x32b147(0x1ce)],_0x26c14e):_0x3bbc7b=dbUserTable['getUserPower'](_0x51a2f0[_0x32b147(0x20b)][_0x32b147(0x1ce)],_0x51a2f0[_0x32b147(0x233)][_0x32b147(0x2c4)],_0x26c14e);if(_0x3bbc7b)for(let _0x28d66c=0x0;_0x28d66c<_0x3bbc7b['length'];_0x28d66c++){_0x1ba579['push']({'path':_0x3bbc7b[_0x28d66c][_0x32b147(0x2ce)],'is_file':0x0,'filename':path[_0x32b147(0x24e)](_0x3bbc7b[_0x28d66c]['path']),'root':!![]});}}else{if(_0x51a2f0[_0x32b147(0x233)][_0x32b147(0x24c)]!=0x1){if(dbUserTable[_0x32b147(0x18e)](_0x51a2f0,_0x233318,_0x26c14e,_0x32b147(0x1c2),_0x2a3e31)!==!![])return;}_0x2a3e31=path[_0x32b147(0x288)](_0x2a3e31),_0x2a3e31=_0x2a3e31[_0x32b147(0x279)](/\'/g,'\x27\x27');let _0x1dafb6=_0x32b147(0x1e2)+_0x2a3e31+_0x32b147(0x2b0);if(_0x4fe932==0x0)_0x1dafb6+=_0x32b147(0x1a6);else{if(_0x4fe932==0x1)_0x1dafb6+='\x20type=1\x20';else{if(_0x4fe932==0x2)_0x1dafb6+=_0x32b147(0x1b2);else _0x4fe932==0x3&&(_0x1dafb6+='\x20is_file=0\x20');}}if(_0x477e82){let _0x19c388=_0x32b147(0x266)+_0x477e82+_0x32b147(0x21b)+_0x477e82+_0x32b147(0x21c);_0x26c14e==_0x32b147(0x2b8)&&(_0x19c388=_0x32b147(0x206)+_0x477e82+_0x32b147(0x25f)),_0x1dafb6+=_0x19c388;}let _0x16e998=_0x32b147(0x287),_0xc69ebb=dbFileIndexTable[_0x32b147(0x2c9)](_0x26c14e);if(_0x26c14e=='movie')_0x16e998=_0x32b147(0x18f);else _0x26c14e==_0x32b147(0x28d)&&(_0x16e998='\x20is_file,id,path,filename,ext,duration,size\x20');_0x1dafb6+=_0x32b147(0x23d)+_0x1b96f5+'\x20'+_0x2badef+_0x32b147(0x2e3)+_0x488daa+'\x20OFFSET\x20'+_0xae1bcb,_0x1ba579=dbFileIndexTable['getAllByWhere'](_0x51a2f0[_0x32b147(0x20b)][_0x32b147(0x217)],_0x1dafb6,_0x16e998,_0xc69ebb);}let _0xe50d73=path[_0x32b147(0x224)],_0x238e38={'platform':platform,'code':0x0,'data':_0x1ba579,'sep':_0xe50d73};return _0x233318[_0x32b147(0x2d7)](_0x238e38);}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x2ed),(_0x54b6b3,_0x282a14,_0x5e1ae8)=>{const _0x405d3c=_0x30fb4f;let _0x22b0ee=_0x54b6b3['body']['id'],_0x45ec1a=_0x54b6b3[_0x405d3c(0x22d)][_0x405d3c(0x24f)],_0x178936=dbFileIndexTable[_0x405d3c(0x2bb)];if(_0x45ec1a==_0x405d3c(0x2b8))_0x178936=dbFileIndexTable[_0x405d3c(0x2e0)];else{if(_0x45ec1a=='music')_0x178936=dbFileIndexTable[_0x405d3c(0x291)];else _0x45ec1a==_0x405d3c(0x1a2)&&(_0x178936=dbFileIndexTable[_0x405d3c(0x1a5)]);}let _0x46877c=dbFileIndexTable[_0x405d3c(0x24d)](_0x54b6b3[_0x405d3c(0x20b)][_0x405d3c(0x217)],_0x22b0ee,_0x178936);if(!_0x46877c)return _0x282a14[_0x405d3c(0x223)](0x194)[_0x405d3c(0x1d9)]();if(dbUserTable['doUserCanGet'](_0x54b6b3,_0x282a14,'',_0x405d3c(0x1c2),_0x46877c[_0x405d3c(0x2ce)])==!![]){let _0x329470={'code':0x0,'data':_0x46877c};if(_0x45ec1a==_0x405d3c(0x2b8)){let _0x379631=dbConfigTable[_0x405d3c(0x1ed)](_0x54b6b3[_0x405d3c(0x20b)][_0x405d3c(0x1ce)],_0x405d3c(0x19d));_0x329470['moviePreferLanguage']=_0x379631?_0x379631[_0x405d3c(0x2de)]:_0x405d3c(0x1b4),_0x329470['data'][_0x405d3c(0x19d)]=_0x329470[_0x405d3c(0x19d)];let _0x2af3d0=dbConfigTable[_0x405d3c(0x1ed)](_0x54b6b3[_0x405d3c(0x20b)][_0x405d3c(0x1ce)],_0x405d3c(0x2eb));_0x329470[_0x405d3c(0x2eb)]=_0x2af3d0?_0x2af3d0[_0x405d3c(0x2de)]:'2',_0x329470[_0x405d3c(0x29c)]['moviePlaylongPressRate']=_0x329470[_0x405d3c(0x2eb)];let _0x466ae2=dbConfigTable['findByTitle'](_0x54b6b3[_0x405d3c(0x20b)]['dbOther'],_0x405d3c(0x1f0));_0x329470[_0x405d3c(0x1f0)]=_0x466ae2?_0x466ae2[_0x405d3c(0x2de)]:'3';let _0x4e2bcb=path[_0x405d3c(0x288)](_0x46877c[_0x405d3c(0x2ce)],_0x46877c[_0x405d3c(0x25c)]);fs[_0x405d3c(0x2a5)](_0x4e2bcb,(_0x4a27f2,_0x28c883)=>{const _0x309a22=_0x405d3c;return _0x4a27f2?(_0x329470[_0x309a22(0x2ef)]=0x0,_0x329470[_0x309a22(0x18a)]=_0x4e2bcb):(_0x329470[_0x309a22(0x2ef)]=0x1,_0x329470[_0x309a22(0x18a)]=_0x4e2bcb),_0x282a14['json'](_0x329470);});}else return _0x282a14['json'](_0x329470);}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x1db),(_0x56e99f,_0x899e33,_0x45cafb)=>{const _0x51bb95=_0x30fb4f;if(dbUserTable[_0x51bb95(0x18e)](_0x56e99f,_0x899e33,'photo',_0x51bb95(0x26d))==!![]){let _0x18bf18=_0x56e99f[_0x51bb95(0x22d)]['id'],_0x8f78ce=_0x56e99f[_0x51bb95(0x22d)][_0x51bb95(0x1e5)],_0x4570b0=_0x56e99f[_0x51bb95(0x22d)]['longitude'],_0x153771=_0x56e99f[_0x51bb95(0x22d)][_0x51bb95(0x1fd)],_0x41985d=dbFileIndexTable[_0x51bb95(0x24d)](_0x56e99f[_0x51bb95(0x20b)][_0x51bb95(0x217)],_0x18bf18);if(!_0x41985d)return _0x56e99f['app'][_0x51bb95(0x1c0)](_0x899e33,_0x899e33['__']('photoSavedAsNewFile'));let _0x268657=path[_0x51bb95(0x288)](_0x41985d[_0x51bb95(0x2ce)],path['sep'],_0x41985d[_0x51bb95(0x25c)]),_0x257ba9=path['extname'](_0x268657)?path['extname'](_0x268657)[_0x51bb95(0x220)]():'';if(_0x257ba9!=_0x51bb95(0x24a)&&_0x257ba9!=_0x51bb95(0x212))return _0x56e99f[_0x51bb95(0x20b)][_0x51bb95(0x1c0)](_0x899e33,'Image\x20format\x20not\x20support');fs[_0x51bb95(0x2a5)](_0x268657,(_0x4a1c00,_0x1ca12b)=>{const _0x242f09=_0x51bb95;if(_0x4a1c00||!_0x1ca12b['isFile']())return _0x56e99f['app'][_0x242f09(0x1c0)](_0x899e33,_0x899e33['__'](_0x242f09(0x2cd)));if(_0x4a1c00||!_0x1ca12b['isFile']())return _0x56e99f[_0x242f09(0x20b)][_0x242f09(0x1c0)](_0x899e33,_0x899e33['__']('folderNotExist'));fs[_0x242f09(0x1ec)](_0x268657,(_0x48f71f,_0x7b0024)=>{const _0x345ee6=_0x242f09;if(_0x48f71f)return _0x56e99f[_0x345ee6(0x20b)][_0x345ee6(0x1c0)](_0x899e33,_0x899e33['__'](_0x345ee6(0x244)));var _0x3d4d7d=piexif[_0x345ee6(0x1ca)](_0x7b0024['toString'](_0x345ee6(0x247)));if(_0x8f78ce&&_0x4570b0){function _0x2f9fd2(_0x8eefd){const _0x2e2a53=_0x345ee6;try{_0x8eefd=Number(_0x8eefd);let _0x472fa8=Math[_0x2e2a53(0x204)](Math[_0x2e2a53(0x1eb)](_0x8eefd)),_0x2c8377=(Math[_0x2e2a53(0x1eb)](_0x8eefd)-_0x472fa8)*0x3c,_0x2c0b07=Math['floor'](_0x2c8377),_0x4b325d=Math[_0x2e2a53(0x26b)]((_0x2c8377-_0x2c0b07)*0x3c*0x64);return[[_0x472fa8,0x1],[_0x2c0b07,0x1],[_0x4b325d,0x64]];}catch(_0x3165d0){return'';}}let _0x161cc3=_0x2f9fd2(_0x8f78ce),_0x1982f6=_0x2f9fd2(_0x4570b0);if(!_0x1982f6||!_0x161cc3)return _0x56e99f['app'][_0x345ee6(0x1c0)](_0x899e33,_0x345ee6(0x29f));_0x3d4d7d[_0x345ee6(0x1b8)][piexif['GPSIFD'][_0x345ee6(0x29e)]]=_0x8f78ce>=0x0?'N':'S',_0x3d4d7d['GPS'][piexif[_0x345ee6(0x2b7)][_0x345ee6(0x277)]]=_0x161cc3,(_0x3d4d7d['GPS'][piexif['GPSIFD'][_0x345ee6(0x2aa)]]=_0x4570b0>=0x0?'E':'W',_0x3d4d7d['GPS'][piexif['GPSIFD'][_0x345ee6(0x2ca)]]=_0x1982f6);let _0xffeae4=geohash['encode'](_0x8f78ce,_0x4570b0,0x8),_0x1f7d52=_0xffeae4[_0x345ee6(0x1ee)](0x0,0x5),_0x28634e=_0xffeae4[_0x345ee6(0x1ee)](0x0,0x4),_0x1dbb04=_0xffeae4[_0x345ee6(0x1ee)](0x0,0x3),_0x214e40=_0xffeae4[_0x345ee6(0x1ee)](0x0,0x2);dbFileIndexTable[_0x345ee6(0x207)](_0x56e99f[_0x345ee6(0x20b)][_0x345ee6(0x217)],_0x41985d['id'],_0x345ee6(0x194)+_0x8f78ce+_0x345ee6(0x1e7)+_0x4570b0+_0x345ee6(0x2be)+_0xffeae4+'\x27,geohash5=\x27'+_0x1f7d52+_0x345ee6(0x29d)+_0x28634e+_0x345ee6(0x1a1)+_0x1dbb04+_0x345ee6(0x1b0)+_0x214e40+'\x27\x20');}if(_0x153771){_0x3d4d7d[_0x345ee6(0x237)][piexif['ExifIFD']['DateTimeOriginal']]=_0x153771,_0x3d4d7d[_0x345ee6(0x1b8)][piexif[_0x345ee6(0x2b7)][_0x345ee6(0x1da)]]=_0x153771;let _0x2c17fb=new Date(_0x153771),_0x503c26=_0x2c17fb[_0x345ee6(0x2cc)](),_0x33b712=_0x2c17fb[_0x345ee6(0x1df)](),_0x5843a8=_0x2c17fb[_0x345ee6(0x239)]()+0x1;_0x5843a8=_0x5843a8>=0xa?_0x5843a8:'0'+_0x5843a8;let _0x57acf0=_0x2c17fb['getDate']();_0x57acf0=_0x57acf0>=0xa?_0x57acf0:'0'+_0x57acf0;let _0x378aca=_0x33b712+'-'+_0x5843a8+'-'+_0x57acf0;dbFileIndexTable[_0x345ee6(0x207)](_0x56e99f['app'][_0x345ee6(0x217)],_0x41985d['id'],_0x345ee6(0x259)+_0x503c26+'\x27,original_date=\x27'+_0x378aca+'\x27\x20');}try{var _0x523b9a=piexif[_0x345ee6(0x2d3)](_0x3d4d7d),_0x1830cd=piexif['insert'](_0x523b9a,_0x7b0024['toString']('binary'));let _0xae3a95=path[_0x345ee6(0x288)](_0x41985d['path'],_0x41985d[_0x345ee6(0x25c)]);fs[_0x345ee6(0x1bd)](_0xae3a95,Buffer[_0x345ee6(0x2a4)](_0x1830cd,_0x345ee6(0x247)),{},_0x40c889=>{const _0x24b581=_0x345ee6;if(_0x40c889)return console[_0x24b581(0x183)](_0x40c889),_0x56e99f[_0x24b581(0x20b)][_0x24b581(0x1c0)](_0x899e33,_0x899e33['__'](_0x24b581(0x244)));console['log']('文件写入成功'),fs[_0x24b581(0x2d6)](_0xae3a95,new Date(_0x41985d[_0x24b581(0x1f1)]),new Date(_0x41985d[_0x24b581(0x1f1)]),_0x3ce2de=>{const _0x3fcc1a=_0x24b581;_0x3ce2de&&console[_0x3fcc1a(0x183)](_0x3ce2de),fs['stat'](_0xae3a95,(_0x20682e,_0x3aa8f6)=>{const _0x5a3ec=_0x3fcc1a;if(_0x20682e)return _0x56e99f['app'][_0x5a3ec(0x1c0)](_0x899e33,_0x899e33['__'](_0x5a3ec(0x244)));return dbFileIndexTable[_0x5a3ec(0x207)](_0x56e99f['app']['dbFileIndex'],_0x41985d['id'],_0x5a3ec(0x22a)+_0x3aa8f6[_0x5a3ec(0x1ad)]+_0x5a3ec(0x2db)+_0x3aa8f6[_0x5a3ec(0x2e5)]+'\x20'),_0x899e33[_0x5a3ec(0x2d7)]({'code':0x0,'newIndex':dbFileIndexTable[_0x5a3ec(0x24d)](_0x56e99f[_0x5a3ec(0x20b)][_0x5a3ec(0x217)],_0x41985d['id'])});});});});}catch(_0x2984c5){return console[_0x345ee6(0x183)](_0x2984c5),_0x56e99f[_0x345ee6(0x20b)]['returnErrMsg'](_0x899e33,_0x899e33['__'](_0x345ee6(0x1dc)));}});});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x2d8),(_0x34e562,_0xbbece9,_0x309468)=>{const _0xfd9edf=_0x30fb4f;if(dbUserTable[_0xfd9edf(0x18e)](_0x34e562,_0xbbece9,_0xfd9edf(0x216),'power_get')==!![]){let _0x4a3359=dbConfigTable[_0xfd9edf(0x1ed)](_0x34e562[_0xfd9edf(0x20b)][_0xfd9edf(0x1ce)],_0xfd9edf(0x225));if(!_0x4a3359||_0x4a3359[_0xfd9edf(0x2de)]!='1')return _0xbbece9['json']({'code':0x0,'data':[],'enable':![]});let _0x13ba1a='(\x27mouse\x27,\x27person\x27,\x27traffic\x20light\x27,\x27stop\x20sign\x27,\x27parking\x20meter\x27,\x27fire\x20hydrant\x27)',_0x53dda2=dbUserTable[_0xfd9edf(0x228)](_0x34e562,_0xfd9edf(0x216),_0xfd9edf(0x1c2),!![]),_0x540b98=_0x34e562[_0xfd9edf(0x20b)][_0xfd9edf(0x217)][_0xfd9edf(0x1ef)](_0xfd9edf(0x28b)+_0x13ba1a)[_0xfd9edf(0x1c9)](),_0x2b60a6=[];for(let _0x3c0f1e in _0x540b98){let _0x50c04c=_0x540b98[_0x3c0f1e],_0x2ebd1e=_0x34e562['app'][_0xfd9edf(0x217)]['prepare'](_0xfd9edf(0x253)+_0x53dda2+_0xfd9edf(0x218))[_0xfd9edf(0x234)](_0x50c04c['id'],dbFileIndexTable['COCO_CLASS_MIN_SCORE']);if(_0x2ebd1e)_0x540b98[_0x3c0f1e][_0xfd9edf(0x1cc)]=_0x2ebd1e[_0xfd9edf(0x1cc)],_0x540b98[_0x3c0f1e][_0xfd9edf(0x27f)]=_0x540b98[_0x3c0f1e]['id'],_0x2b60a6['push'](_0x540b98[_0x3c0f1e]);else continue;}_0xbbece9['json']({'code':0x0,'data':_0x2b60a6,'enable':!![]});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x293),(_0x875524,_0x347a01,_0x13407a)=>{const _0x4df643=_0x30fb4f;if(dbUserTable[_0x4df643(0x18e)](_0x875524,_0x347a01,_0x4df643(0x216),_0x4df643(0x1c2))==!![]){let _0x4d0330=dbConfigTable[_0x4df643(0x1ed)](_0x875524[_0x4df643(0x20b)][_0x4df643(0x1ce)],_0x4df643(0x23f));if(!_0x4d0330||_0x4d0330[_0x4df643(0x2de)]!='1')return _0x347a01[_0x4df643(0x2d7)]({'code':0x0,'data':[],'enable':![]});let _0x38d31e=0x5,_0x5ebd84=dbConfigTable[_0x4df643(0x1ed)](_0x875524['app']['dbOther'],_0x4df643(0x2a9));_0x5ebd84&&_0x5ebd84['value']&&(_0x5ebd84['value']>0x0&&(_0x38d31e=_0x5ebd84[_0x4df643(0x2de)]));let _0x2a2b1a=_0x875524[_0x4df643(0x20b)][_0x4df643(0x217)][_0x4df643(0x1ef)](_0x4df643(0x196))[_0x4df643(0x1c9)](parseInt(_0x38d31e)),_0x2c32f9=[];if(_0x875524[_0x4df643(0x233)]['is_admin']==0x1)_0x2c32f9=_0x2a2b1a;else{let _0x53735b=dbUserTable['getUserPathWhere'](_0x875524,_0x4df643(0x216),'power_get',!![]);for(let _0x1cc734 of _0x2a2b1a){try{let _0x348f57=_0x875524[_0x4df643(0x20b)][_0x4df643(0x217)][_0x4df643(0x1ef)](_0x4df643(0x2bf)+_0x53735b+_0x4df643(0x197))[_0x4df643(0x234)](_0x1cc734['id']);_0x348f57&&_0x2c32f9[_0x4df643(0x19f)](_0x1cc734);}catch(_0xf494){console[_0x4df643(0x183)](_0xf494),_0x2c32f9[_0x4df643(0x19f)](_0x1cc734);}}}_0x347a01[_0x4df643(0x2d7)]({'code':0x0,'data':_0x2c32f9,'enable':!![]});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x243),(_0x305037,_0x32004b,_0x16539f)=>{const _0xc169c2=_0x30fb4f;let _0x25c368=_0x305037[_0xc169c2(0x22d)]['setFaceId'],_0x3694a2=_0x305037[_0xc169c2(0x22d)][_0xc169c2(0x18b)],_0x4665b9=_0x305037[_0xc169c2(0x22d)][_0xc169c2(0x285)];if(dbUserTable['doUserCanGet'](_0x305037,_0x32004b,'photo',_0xc169c2(0x26d))==!![]){let _0xadd899=dbFileIndexTable[_0xc169c2(0x2e4)](_0x305037['app'][_0xc169c2(0x217)],_0x25c368);_0x305037[_0xc169c2(0x20b)]['dbFileIndex'][_0xc169c2(0x1ef)](_0xc169c2(0x187)+_0xadd899)[_0xc169c2(0x208)](),_0x305037[_0xc169c2(0x20b)][_0xc169c2(0x217)][_0xc169c2(0x1ef)](_0xc169c2(0x20a)+_0x4665b9+'\x20and\x20face_id='+_0x3694a2)[_0xc169c2(0x208)](),_0x305037['app']['dbFileIndex'][_0xc169c2(0x1ef)](_0xc169c2(0x2cf)+_0x25c368)['run'](),_0x32004b[_0xc169c2(0x2d7)]({'code':0x0});}}),router[_0x30fb4f(0x274)]('/removeFromFace',(_0x4f2443,_0x2c8748,_0x4bde67)=>{const _0x14e082=_0x30fb4f;let _0x578877=_0x4f2443[_0x14e082(0x22d)][_0x14e082(0x257)];try{_0x578877=JSON[_0x14e082(0x1c4)](_0x578877);}catch(_0x1518e9){console[_0x14e082(0x183)](_0x1518e9);}if(dbUserTable[_0x14e082(0x18e)](_0x4f2443,_0x2c8748,'photo','power_change')==!![]){for(let _0x482834 of _0x578877){_0x4f2443[_0x14e082(0x20b)]['dbFileIndex']['prepare']('DELETE\x20FROM\x20photo_faces2index\x20where\x20face_id=?\x20and\x20photo_index_id\x20=?')[_0x14e082(0x208)](parseInt(_0x482834[_0x14e082(0x267)]),parseInt(_0x482834[_0x14e082(0x211)]));}_0x2c8748['json']({'code':0x0});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x24b),(_0x218be7,_0x24d4fd,_0x5d1a7b)=>{const _0x4b8859=_0x30fb4f;if(dbUserTable['doUserCanGet'](_0x218be7,_0x24d4fd,'photo',_0x4b8859(0x26d))==!![]){let _0x511167=_0x218be7[_0x4b8859(0x22d)][_0x4b8859(0x240)],_0x31a556=_0x218be7['body'][_0x4b8859(0x229)],_0x34d700=_0x218be7[_0x4b8859(0x22d)][_0x4b8859(0x267)],_0x3fe8c2=_0x218be7[_0x4b8859(0x22d)]['faceIdList'];if(_0x511167){_0x511167=_0x511167[_0x4b8859(0x2da)]();let _0x18aa09=_0x218be7['app']['dbFileIndex']['prepare'](_0x4b8859(0x227))[_0x4b8859(0x234)](_0x511167);_0x18aa09&&_0x18aa09['id']!=_0x34d700?_0x218be7[_0x4b8859(0x20b)]['dbFileIndex']['prepare'](_0x4b8859(0x1e4))[_0x4b8859(0x208)](_0x18aa09['id'],_0x34d700):(_0x218be7[_0x4b8859(0x20b)][_0x4b8859(0x217)][_0x4b8859(0x1ef)]('UPDATE\x20photo_faces\x20SET\x20face_name=null\x20where\x20face_name\x20=\x20?')[_0x4b8859(0x208)](_0x511167),_0x218be7['app'][_0x4b8859(0x217)][_0x4b8859(0x1ef)]('UPDATE\x20photo_faces\x20SET\x20face_name=?\x20where\x20id\x20=\x20?')[_0x4b8859(0x208)](_0x511167,_0x34d700));}if(parseInt(_0x31a556)==0x0||parseInt(_0x31a556)==0x1){if(_0x3fe8c2){let _0x5f2952='\x20id\x20in\x20(';for(let _0x5a2031 in _0x3fe8c2){_0x5f2952+=_0x3fe8c2[_0x5a2031],_0x5a2031!=_0x3fe8c2['length']-0x1&&(_0x5f2952+=',');}_0x5f2952+=')';let _0x1fb780=_0x4b8859(0x1b6)+_0x5f2952;_0x218be7[_0x4b8859(0x20b)][_0x4b8859(0x217)][_0x4b8859(0x1ef)](_0x1fb780)[_0x4b8859(0x208)](_0x31a556);}else _0x218be7[_0x4b8859(0x20b)][_0x4b8859(0x217)][_0x4b8859(0x1ef)](_0x4b8859(0x1dd))['run'](_0x31a556,_0x34d700);}return _0x24d4fd[_0x4b8859(0x2d7)]({'code':0x0});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x299),(_0x56689e,_0x36d927,_0x4f189a)=>{const _0x243b02=_0x30fb4f;if(dbUserTable[_0x243b02(0x18e)](_0x56689e,_0x36d927,_0x243b02(0x216),_0x243b02(0x26d))==!![]){let _0x324eac=_0x56689e[_0x243b02(0x22d)]['faceIdList'];if(!_0x324eac||_0x324eac[_0x243b02(0x2d4)]<0x2)return _0x56689e[_0x243b02(0x20b)][_0x243b02(0x1c0)](_0x36d927,_0x36d927['__']('atleastChooseTwoFaces'));let _0x3ec885=_0x56689e[_0x243b02(0x20b)][_0x243b02(0x217)][_0x243b02(0x1ef)](_0x243b02(0x19b))[_0x243b02(0x234)](_0x324eac[0x0]);if(!_0x3ec885)return _0x56689e[_0x243b02(0x20b)][_0x243b02(0x1c0)](_0x36d927,_0x36d927['__'](_0x243b02(0x244)));for(let _0x5c06a0=0x1;_0x5c06a0<_0x324eac[_0x243b02(0x2d4)];_0x5c06a0++){let _0x452c03=_0x324eac[_0x5c06a0];_0x56689e[_0x243b02(0x20b)][_0x243b02(0x217)][_0x243b02(0x1ef)](_0x243b02(0x19c))[_0x243b02(0x208)](_0x3ec885['id'],_0x452c03,_0x452c03);}return process[_0x243b02(0x2c2)]({'type':'startFaceAiWork'}),_0x36d927[_0x243b02(0x2d7)]({'code':0x0});}}),router[_0x30fb4f(0x234)](_0x30fb4f(0x27b),(_0x455f61,_0x47a8d1,_0x2d831d)=>{const _0x26f101=_0x30fb4f;let _0x188313=_0x455f61[_0x26f101(0x1e9)][_0x26f101(0x267)];if(dbUserTable['doUserCanGet'](_0x455f61,_0x47a8d1,_0x26f101(0x216),_0x26f101(0x1c2))==!![]){let _0x5a968a=_0x455f61[_0x26f101(0x20b)][_0x26f101(0x217)][_0x26f101(0x1ef)](_0x26f101(0x189))[_0x26f101(0x234)](_0x188313);if(!_0x5a968a)return _0x47a8d1['status'](0x194)['end']();_0x455f61['currentUser'][_0x26f101(0x24c)]!=0x1?_0x563012(![]):!_0x5a968a[_0x26f101(0x258)]?_0x563012(!![]):fs[_0x26f101(0x2a5)](_0x5a968a[_0x26f101(0x258)],(_0x219346,_0x198e03)=>{const _0x1dd18c=_0x26f101;if(!_0x219346){let _0x26dfe6=new Date()[_0x1dd18c(0x2cc)](),_0x1fccfe=0x48*0xe10*0x3e8;if(_0x198e03[_0x1dd18c(0x2e5)]){let _0x49b1fd=_0x26dfe6-_0x198e03[_0x1dd18c(0x2e5)];if(_0x49b1fd>_0x1fccfe)return _0x563012(!![]);}return _0x47a8d1[_0x1dd18c(0x1d3)](_0x5a968a['face_img_path']);}_0x563012(!![]);});function _0x563012(_0x99a103){const _0x6dc325=_0x26f101;let _0x3a34d7=dbFileIndexTable[_0x6dc325(0x2e4)](_0x455f61[_0x6dc325(0x20b)][_0x6dc325(0x217)],_0x188313),_0x5f4c39='SELECT\x20f.*,a.id\x20as\x20f2id,a.width\x20as\x20f2width,a.height\x20as\x20f2height,a.x\x20as\x20f2x,a.y\x20as\x20f2y\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x20photo_faces2index\x20as\x20a\x20INNER\x20JOIN\x20file_index_photo\x20as\x20f\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20a.photo_index_id=f.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20a.face_id\x20in\x20'+_0x3a34d7+'\x20';if(_0x455f61[_0x6dc325(0x233)][_0x6dc325(0x24c)]!=0x1){let _0x36683e=dbUserTable['getUserPathWhere'](_0x455f61,'photo',_0x6dc325(0x1c2),!![]);_0x5f4c39+=_0x36683e;}let _0x9140b1=_0x455f61['app'][_0x6dc325(0x217)][_0x6dc325(0x1ef)](_0x5f4c39+_0x6dc325(0x1ea))[_0x6dc325(0x234)]();if(!_0x9140b1){_0x9140b1=_0x455f61[_0x6dc325(0x20b)]['dbFileIndex'][_0x6dc325(0x1ef)](_0x5f4c39+'\x20order\x20by\x20f.original_time\x20desc\x20limit\x201')[_0x6dc325(0x234)]();if(!_0x9140b1)return _0x47a8d1[_0x6dc325(0x223)](0x194)[_0x6dc325(0x1d9)]();}if(!_0x9140b1)return _0x47a8d1['status'](0x194)[_0x6dc325(0x1d9)]();let _0x37dabf=path[_0x6dc325(0x288)](_0x9140b1['path'],_0x9140b1[_0x6dc325(0x25c)]);if(parseInt(_0x9140b1[_0x6dc325(0x1c8)])==0x2){let _0x4ac625=config[_0x6dc325(0x21a)](_0x9140b1),_0x347b21=path[_0x6dc325(0x288)](config[_0x6dc325(0x282)],_0x4ac625);sharpUtil['genTinyFile'](_0x37dabf,path[_0x6dc325(0x184)](_0x347b21),path[_0x6dc325(0x24e)](_0x347b21),_0x6dc325(0x2bc),_0x9140b1,_0x469676=>{_0x37dabf=_0x347b21,_0x5da1bc();},_0x26c56c=>{const _0x18ff77=_0x6dc325;return _0x47a8d1[_0x18ff77(0x223)](0x194)[_0x18ff77(0x1d9)]();});}else _0x5da1bc();function _0x5da1bc(){const _0x5af492=_0x6dc325;let _0x325666=path[_0x5af492(0x288)](config[_0x5af492(0x255)],_0x9140b1[_0x5af492(0x186)]+new Date()[_0x5af492(0x2cc)]()+'.jpg'),_0x129e24=0x7d0;sharpUtil[_0x5af492(0x1e0)](_0x37dabf,(_0xc683d6,_0x3bd8ca,_0x3a1fe8)=>{const _0x5dc24f=_0x5af492;let _0x5c4962=parseInt(_0x9140b1[_0x5dc24f(0x2cb)]*1.4),_0x3e8bf3=parseInt(_0x9140b1[_0x5dc24f(0x2a8)]*1.4),_0x10d0e7=parseInt(_0x9140b1[_0x5dc24f(0x1fa)]-_0x5c4962*0.2),_0x79e9d7=parseInt(_0x9140b1[_0x5dc24f(0x246)]-_0x3e8bf3*0.2);if(_0x79e9d7<0x0)_0x79e9d7=0x0;if(_0x10d0e7<0x0)_0x10d0e7=0x0;_0x5b06f5(_0xc683d6,_0x3bd8ca,_0x3a1fe8,_0x10d0e7,_0x79e9d7,_0x5c4962,_0x3e8bf3,()=>{const _0x2b60ca=_0x5dc24f;let _0x3103d4=parseInt(_0x9140b1[_0x2b60ca(0x2cb)]),_0x196f28=parseInt(_0x9140b1[_0x2b60ca(0x2a8)]),_0x1c0e0d=parseInt(_0x9140b1['f2x']),_0x5603b2=parseInt(_0x9140b1[_0x2b60ca(0x246)]);if(_0x5603b2<0x0)_0x5603b2=0x0;if(_0x1c0e0d<0x0)_0x1c0e0d=0x0;_0x5b06f5(_0xc683d6,_0x3bd8ca,_0x3a1fe8,_0x1c0e0d,_0x5603b2,_0x3103d4,_0x196f28);});});function _0x5b06f5(_0x5de86d,_0x1bd56a,_0x5a56eb,_0x2a86c7,_0x5acb43,_0x20ffe9,_0x128741,_0x5eb81a){const _0x1fada5=_0x5af492;let _0xf44c51=sharpUtil[_0x1fada5(0x2a2)](_0x5de86d),_0x422a2b=exifUtils[_0x1fada5(0x198)](_0x5a56eb);_0x422a2b?_0xf44c51=_0xf44c51[_0x1fada5(0x2c8)](_0x422a2b):_0xf44c51=_0xf44c51[_0x1fada5(0x2c8)](),_0xf44c51[_0x1fada5(0x1bf)]({'width':_0x129e24,'height':_0x129e24,'withoutEnlargement':!![]})['jpeg']()[_0x1fada5(0x1c6)]({'left':_0x2a86c7,'top':_0x5acb43,'width':_0x20ffe9,'height':_0x128741})[_0x1fada5(0x231)](_0x325666,function(_0x417757){const _0xff5dd5=_0x1fada5;if(_0x417757){_0x1bd56a&&sharpUtil[_0xff5dd5(0x199)](_0x5de86d);if(_0x5eb81a)_0x5eb81a();else return _0x47a8d1['status'](0x194)[_0xff5dd5(0x1d9)]();}else{_0x1bd56a&&sharpUtil[_0xff5dd5(0x199)](_0x5de86d);if(_0x99a103)return _0x455f61[_0xff5dd5(0x20b)][_0xff5dd5(0x217)][_0xff5dd5(0x1ef)]('UPDATE\x20photo_faces\x20SET\x20face_img_path=\x27'+_0x325666+_0xff5dd5(0x2c6)+_0x188313)[_0xff5dd5(0x208)](),_0x47a8d1[_0xff5dd5(0x1d3)](_0x325666);else _0x47a8d1['sendFile'](_0x325666),_0x47a8d1['on'](_0xff5dd5(0x1e6),()=>{fs['rm'](_0x325666,_0x4bd820=>{});});}});}}}}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x1be),(_0x59ebdb,_0x5105e6,_0x6cc202)=>{const _0x429e58=_0x30fb4f;let _0x4d2e70=_0x59ebdb[_0x429e58(0x22d)][_0x429e58(0x268)],_0x4481ba=_0x59ebdb['body'][_0x429e58(0x2d9)],_0x7feae1=[];if(!_0x4d2e70||!_0x4481ba)return _0x5105e6[_0x429e58(0x2d7)]({'code':0x0,'sucIdList':_0x7feae1});try{_0x4481ba=JSON['parse'](_0x4481ba);for(let _0x2b583a in _0x4481ba){let _0x5ca817=_0x4481ba[_0x2b583a],_0x1aee45=_0x59ebdb[_0x429e58(0x20b)][_0x429e58(0x217)]['prepare']('UPDATE\x20photo_faces2index\x20SET\x20face_id=?\x20WHERE\x20face_id=?\x20and\x20photo_index_id=?')[_0x429e58(0x208)](parseInt(_0x4d2e70),parseInt(_0x5ca817[_0x429e58(0x1c1)]),parseInt(_0x5ca817[_0x429e58(0x1cc)]));_0x7feae1[_0x429e58(0x19f)](_0x5ca817[_0x429e58(0x1cc)]);}return _0x5105e6[_0x429e58(0x2d7)]({'code':0x0,'sucIdList':_0x7feae1});}catch(_0x327a9d){return console[_0x429e58(0x183)](_0x327a9d),_0x5105e6[_0x429e58(0x2d7)]({'code':0x0,'sucIdList':_0x7feae1});}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x2a1),(_0x2f687b,_0x14d0fd,_0x2dc7b3)=>{const _0x23f6f6=_0x30fb4f;let _0xfb2aa5=_0x2f687b[_0x23f6f6(0x22d)][_0x23f6f6(0x1c8)],_0x38d79e={};if(_0x2f687b[_0x23f6f6(0x233)]['is_admin']==0x1){if(!_0xfb2aa5||_0xfb2aa5==_0x23f6f6(0x1cd)){let _0x314f17=_0x2f687b[_0x23f6f6(0x20b)]['dbFileIndex'][_0x23f6f6(0x1ef)](_0x23f6f6(0x236))[_0x23f6f6(0x234)]();_0x38d79e[_0x23f6f6(0x273)]=_0x314f17[_0x23f6f6(0x2ee)];if(_0x314f17[_0x23f6f6(0x2ee)]<0x1){let _0x20128f=_0x2f687b[_0x23f6f6(0x20b)][_0x23f6f6(0x217)][_0x23f6f6(0x1ef)](_0x23f6f6(0x2e8))['get']();_0x38d79e[_0x23f6f6(0x1d4)]=_0x20128f[_0x23f6f6(0x2ee)];}}if(!_0xfb2aa5||_0xfb2aa5==_0x23f6f6(0x2b4)){let _0x3947f3=_0x2f687b['app'][_0x23f6f6(0x217)]['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20file_index_photo\x20WHERE\x20ai_class_state=0\x20and\x20(type=1\x20or\x20type=2)\x20and\x20tiny_path\x20is\x20not\x20null\x20AND\x20tiny_path\x20!=\x20\x270\x27')[_0x23f6f6(0x234)]();_0x38d79e['cocossdWaitDealCount']=_0x3947f3['count'];}if(!_0xfb2aa5||_0xfb2aa5==_0x23f6f6(0x2d5)){let _0x4d7722=_0x2f687b[_0x23f6f6(0x20b)][_0x23f6f6(0x217)][_0x23f6f6(0x1ef)]('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20file_index_photo\x20WHERE\x20phash\x20is\x20null\x20and\x20type=1')[_0x23f6f6(0x234)]();_0x38d79e[_0x23f6f6(0x2f1)]=_0x4d7722[_0x23f6f6(0x2ee)];}}let _0x11c556=dbConfigTable[_0x23f6f6(0x1ed)](_0x2f687b[_0x23f6f6(0x20b)]['dbOther'],_0x23f6f6(0x281)),_0x5ee874=0x0;return!_0x11c556?_0x5ee874=0x0:_0x5ee874=_0x11c556[_0x23f6f6(0x2de)],_0x38d79e[_0x23f6f6(0x20c)]=_0x5ee874,_0x14d0fd[_0x23f6f6(0x2d7)]({'code':0x0,'data':_0x38d79e});}),router[_0x30fb4f(0x274)](_0x30fb4f(0x210),(_0xf89c31,_0x139604,_0x364dc3)=>{const _0x479f09=_0x30fb4f;if(dbUserTable[_0x479f09(0x18e)](_0xf89c31,_0x139604,'photo','power_change')==!![])try{fs['rm'](config[_0x479f09(0x255)],{'recursive':!![]},_0x1422ce=>{const _0x6fc773=_0x479f09;if(_0x1422ce)return console[_0x6fc773(0x183)](_0x1422ce),_0xf89c31[_0x6fc773(0x20b)][_0x6fc773(0x1c0)](_0x139604,_0x139604['__']('cacheDeleteFail')+':'+config[_0x6fc773(0x255)],_0x6fc773(0x28e));fs[_0x6fc773(0x1f9)](config['facesPath'],_0x415723=>{const _0x5ed073=_0x6fc773;if(_0x415723)return _0xf89c31[_0x5ed073(0x20b)]['returnErrMsg'](_0x139604,_0x139604['__']('operationFail'),'dialog');let _0xa7cc26=_0xf89c31['app'][_0x5ed073(0x217)][_0x5ed073(0x19e)](()=>{const _0x4c1013=_0x5ed073;return _0xf89c31[_0x4c1013(0x20b)]['dbFileIndex'][_0x4c1013(0x1ef)](_0x4c1013(0x21e))[_0x4c1013(0x208)](),_0xf89c31[_0x4c1013(0x20b)][_0x4c1013(0x217)]['prepare'](_0x4c1013(0x1cb))[_0x4c1013(0x208)](),_0xf89c31[_0x4c1013(0x20b)][_0x4c1013(0x217)][_0x4c1013(0x1ef)](_0x4c1013(0x1b1))[_0x4c1013(0x208)](),process[_0x4c1013(0x2c2)]({'type':_0x4c1013(0x219)}),_0x139604[_0x4c1013(0x2d7)]({'code':0x0});});_0xa7cc26();});});}catch(_0x105279){return _0xf89c31[_0x479f09(0x20b)]['returnErrMsg'](_0x139604,_0x139604['__'](_0x479f09(0x244)),_0x479f09(0x28e));}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x27d),(_0xe3a774,_0x50ade8,_0x298d6b)=>{const _0x185088=_0x30fb4f;if(dbUserTable['doUserCanGet'](_0xe3a774,_0x50ade8,_0x185088(0x216),_0x185088(0x26d))==!![])try{let _0x40d773=_0xe3a774['app'][_0x185088(0x217)]['transaction'](()=>{const _0x5e4f6b=_0x185088;return _0xe3a774[_0x5e4f6b(0x20b)][_0x5e4f6b(0x217)]['prepare'](_0x5e4f6b(0x2b5))[_0x5e4f6b(0x208)](),_0xe3a774[_0x5e4f6b(0x20b)][_0x5e4f6b(0x217)]['prepare']('update\x20file_index_photo\x20set\x20phash=null,phash_compare=0')[_0x5e4f6b(0x208)](),process[_0x5e4f6b(0x2c2)]({'type':_0x5e4f6b(0x21d)}),_0x50ade8[_0x5e4f6b(0x2d7)]({'code':0x0});});_0x40d773();}catch(_0xfba6f2){return _0xe3a774['app']['returnErrMsg'](_0x50ade8,_0x50ade8['__'](_0x185088(0x244)),_0x185088(0x28e));}}),router[_0x30fb4f(0x274)](_0x30fb4f(0x265),(_0x15d6aa,_0x4c14e1,_0xd11d00)=>{const _0x46a0bc=_0x30fb4f;if(dbUserTable['isAdmin'](_0x15d6aa,_0x4c14e1)!==!![])return;let _0x34edd2=dbConfigTable['findByTitle'](_0x15d6aa[_0x46a0bc(0x20b)][_0x46a0bc(0x1ce)],_0x46a0bc(0x22c));if(!_0x34edd2||_0x34edd2[_0x46a0bc(0x2de)]!='1')return _0x4c14e1[_0x46a0bc(0x2d7)]({'code':0x0,'data':[],'enable':![]});let _0x2aff86=_0x15d6aa['body'][_0x46a0bc(0x262)];if(!_0x2aff86)_0x2aff86=0x0;let _0x1c0a18=_0x15d6aa[_0x46a0bc(0x22d)][_0x46a0bc(0x2ee)];if(!_0x1c0a18||_0x1c0a18>0x64)_0x1c0a18=0x64;let _0xc847d1=[],_0x89a0b7=_0x15d6aa[_0x46a0bc(0x20b)]['dbFileIndex'][_0x46a0bc(0x1ef)](_0x46a0bc(0x2dd))[_0x46a0bc(0x1c9)](),_0x366077=_0x15d6aa['app'][_0x46a0bc(0x217)][_0x46a0bc(0x1ef)]('SELECT\x20index_id\x20FROM\x20photo_phash_similar\x20group\x20by\x20index_id\x20limit\x20'+_0x1c0a18)[_0x46a0bc(0x1c9)]();for(let _0x5df2a3 in _0x366077){let _0x944dbe=_0x366077[_0x5df2a3],_0x3b8755=_0x15d6aa['app'][_0x46a0bc(0x217)][_0x46a0bc(0x1ef)]('SELECT\x20id,path,filename,original_date,size\x20FROM\x20file_index_photo\x20where\x20id='+_0x944dbe[_0x46a0bc(0x23e)])[_0x46a0bc(0x234)](),_0x382b88=_0x15d6aa[_0x46a0bc(0x20b)][_0x46a0bc(0x217)][_0x46a0bc(0x1ef)]('SELECT\x20f.id,f.path,f.filename,f.original_date,f.size\x20FROM\x20photo_phash_similar\x20as\x20a\x20inner\x20join\x20file_index_photo\x20as\x20f\x20on\x20a.similar_index_id=f.id\x20where\x20a.index_id='+_0x944dbe[_0x46a0bc(0x23e)])[_0x46a0bc(0x1c9)]();_0x366077[_0x5df2a3][_0x46a0bc(0x26f)]=_0x3b8755,_0x366077[_0x5df2a3][_0x46a0bc(0x18c)]=[_0x3b8755],_0x366077[_0x5df2a3][_0x46a0bc(0x18c)][_0x46a0bc(0x19f)](..._0x382b88),_0x366077[_0x5df2a3]['similarIndexList'][_0x46a0bc(0x2d4)]>0x1?_0xc847d1[_0x46a0bc(0x19f)](_0x366077[_0x5df2a3]):_0x15d6aa[_0x46a0bc(0x20b)]['dbFileIndex']['prepare']('DELETE\x20FROM\x20photo_phash_similar\x20where\x20index_id=?')[_0x46a0bc(0x208)](_0x944dbe[_0x46a0bc(0x23e)]);}return _0x4c14e1[_0x46a0bc(0x2d7)]({'code':0x0,'data':_0xc847d1,'enable':!![],'waitDealCount':_0x89a0b7[_0x46a0bc(0x2d4)]});}),router[_0x30fb4f(0x274)]('/dealSimilarPhoto',(_0x4d4fd2,_0x1ac13f,_0x1d7240)=>{const _0x1cc786=_0x30fb4f;if(dbUserTable['isAdmin'](_0x4d4fd2,_0x1ac13f)!==!![])return;nasAccountUtil[_0x1cc786(0x2a3)](_0x1ac13f,_0x4d4fd2[_0x1cc786(0x20b)]['dbOther'])[_0x1cc786(0x1ba)](_0x319ec5=>{const _0x30364d=_0x1cc786;if(!_0x319ec5)return;let _0x4098ed=_0x4d4fd2['body'][_0x30364d(0x2df)];for(let _0x29c7a8 in _0x4098ed){let _0x4df572=_0x4d4fd2['app']['dbFileIndex'][_0x30364d(0x1ef)](_0x30364d(0x29b)+_0x4098ed[_0x29c7a8]['index_id'])[_0x30364d(0x1c9)]();for(let _0x81f456 in _0x4df572){if(!_0x4098ed[_0x29c7a8][_0x30364d(0x294)][_0x30364d(0x1fb)](parseInt(_0x4df572[_0x81f456][_0x30364d(0x2b1)]))){let _0x171154=new Date()['getTime']();_0x4d4fd2[_0x30364d(0x20b)][_0x30364d(0x217)][_0x30364d(0x1ef)](_0x30364d(0x2e6)+dbFileIndexTable[_0x30364d(0x2bb)]+'\x20SET\x20in_trash=1,in_trash_time='+_0x171154+'\x20WHERE\x20id\x20=\x20'+_0x4df572[_0x81f456][_0x30364d(0x2b1)])[_0x30364d(0x208)]();}}if(!_0x4098ed[_0x29c7a8][_0x30364d(0x294)][_0x30364d(0x1fb)](parseInt(_0x4098ed[_0x29c7a8][_0x30364d(0x23e)]))){let _0x4d10c7=new Date()[_0x30364d(0x2cc)]();_0x4d4fd2[_0x30364d(0x20b)]['dbFileIndex'][_0x30364d(0x1ef)](_0x30364d(0x2e6)+dbFileIndexTable[_0x30364d(0x2bb)]+_0x30364d(0x2ec)+_0x4d10c7+_0x30364d(0x1f6)+_0x4098ed[_0x29c7a8][_0x30364d(0x23e)])[_0x30364d(0x208)]();}_0x4d4fd2[_0x30364d(0x20b)]['dbFileIndex'][_0x30364d(0x1ef)](_0x30364d(0x1bb)+_0x4098ed[_0x29c7a8][_0x30364d(0x23e)])['run']();}return _0x1ac13f[_0x30364d(0x2d7)]({'code':0x0});});}),router[_0x30fb4f(0x274)]('/restoreTrashBinFiles',(_0x11c2bd,_0x12203b,_0x3a89b)=>{const _0x35fe53=_0x30fb4f;if(dbUserTable[_0x35fe53(0x18e)](_0x11c2bd,_0x12203b,'photo',_0x35fe53(0x26d),'')==!![]){let _0xd7c8ff=_0x11c2bd[_0x35fe53(0x20b)][_0x35fe53(0x217)][_0x35fe53(0x1ef)](_0x35fe53(0x205))[_0x35fe53(0x1c9)]();for(let _0x1eb4ac of _0xd7c8ff){_0x11c2bd[_0x35fe53(0x20b)][_0x35fe53(0x217)][_0x35fe53(0x1ef)](_0x35fe53(0x2dc))[_0x35fe53(0x208)](_0x1eb4ac[_0x35fe53(0x2ce)],_0x1eb4ac[_0x35fe53(0x1f2)]);}return _0x11c2bd[_0x35fe53(0x20b)]['dbFileIndex']['prepare']('UPDATE\x20'+dbFileIndexTable[_0x35fe53(0x2bb)]+_0x35fe53(0x1fc))[_0x35fe53(0x208)](),_0x12203b[_0x35fe53(0x2d7)]({'code':0x0});}}),router['post'](_0x30fb4f(0x1e1),(_0x334cef,_0xe3f752,_0xd258c5)=>{const _0x111845=_0x30fb4f;let _0x4a50ae=_0x334cef['body'][_0x111845(0x1c5)],_0x226656=dbFileIndexTable[_0x111845(0x276)](_0x334cef[_0x111845(0x20b)][_0x111845(0x217)],'\x20in_trash=1\x20and\x20is_file=1\x20','id,is_file,is_livephoto,path,filename,raw_filename,is_raw',dbFileIndexTable[_0x111845(0x2bb)]),_0x2c08e3=dbFileIndexTable['INDEX_TABLE_NAME_PHOTO'];console['log']('Cleaning\x20out\x20the\x20recycle\x20bin\x20:\x20'+_0x226656[_0x111845(0x2d4)]);function _0x43595a(_0x5eb049,_0x5ff276){const _0x1acc26=_0x111845;dbFileOperationRecord[_0x1acc26(0x241)](_0x334cef[_0x1acc26(0x20b)][_0x1acc26(0x1ce)],{'username':_0x334cef[_0x1acc26(0x233)]['username'],'targetPath':_0x5eb049,'level':dbFileOperationRecord[_0x1acc26(0x235)],'type':dbFileOperationRecord[_0x1acc26(0x1d8)],'state':_0x5ff276?dbFileOperationRecord['STATE_SUC']:dbFileOperationRecord[_0x1acc26(0x1c3)]});}function _0x47b87f(_0x5b5191){const _0x37077b=_0x111845;if(_0x5b5191[_0x37077b(0x275)]==0x1&&_0x5b5191[_0x37077b(0x2b3)]==0x1){let _0x47578c=path[_0x37077b(0x288)](_0x5b5191[_0x37077b(0x2ce)],_0x5b5191[_0x37077b(0x25c)][_0x37077b(0x279)](_0x37077b(0x2ac),'')+_0x37077b(0x203));_0x5b5191[_0x37077b(0x25c)]['endsWith'](_0x37077b(0x2d1))&&(_0x47578c=path[_0x37077b(0x288)](_0x5b5191['path'],_0x5b5191[_0x37077b(0x25c)][_0x37077b(0x279)](_0x37077b(0x2d1),'')+_0x37077b(0x2c1))),fs[_0x37077b(0x1d2)](_0x47578c)&&(console['log'](_0x37077b(0x2c7),_0x47578c),_0x36d532(_0x5b5191,_0x47578c,![]));}}function _0x36d532(_0x595711,_0x18e45e,_0x4c17da){const _0xf567fa=_0x111845;_0x4a50ae==0x1?(process['send']({'type':_0xf567fa(0x1f5),'shellType':'trash','path':_0x18e45e}),_0x43595a(_0x18e45e,!![])):fs['rm'](_0x18e45e,{'recursive':!![]},_0x1a47d4=>{_0x1a47d4?_0x43595a(_0x18e45e,![]):_0x43595a(_0x18e45e,!![]);}),_0x4c17da&&_0x47b87f(_0x595711);}function _0x3541bf(_0x2c0785){const _0x6edd90=_0x111845;dbFileIndexTable[_0x6edd90(0x2e7)](_0x334cef[_0x6edd90(0x20b)][_0x6edd90(0x217)],_0x2c0785['id'],_0x2c08e3);}for(let _0x2f28f9 in _0x226656){let _0x5aaa35=_0x226656[_0x2f28f9];if(_0x5aaa35){if(dbUserTable[_0x111845(0x18e)](_0x334cef,_0xe3f752,'photo',_0x111845(0x25a),_0x5aaa35[_0x111845(0x2ce)])==!![]){let _0x446622=path[_0x111845(0x288)](_0x5aaa35[_0x111845(0x2ce)],path[_0x111845(0x224)],_0x5aaa35[_0x111845(0x25c)]);_0x3541bf(_0x5aaa35),_0x36d532(_0x5aaa35,_0x446622,!![]);}}}return _0xe3f752[_0x111845(0x2d7)]({'code':0x0});}),router[_0x30fb4f(0x274)]('/operationLibrary',(_0x184cf2,_0x5e24a0,_0x45e280)=>{const _0x3f8712=_0x30fb4f;let _0x39605f=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x270)],_0x103092=_0x184cf2[_0x3f8712(0x22d)]['libraryId'],_0x1a9530=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2ea)],_0x4eca40=_0x184cf2['body'][_0x3f8712(0x1b3)],_0x273804=_0x184cf2[_0x3f8712(0x22d)]['shareForSubUser'],_0x380501=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2a7)];if(_0x380501==_0x3f8712(0x202)){let _0x133950=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x286)]||0x0,_0x593402=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2ee)]||0x32,_0x462db4=_0x184cf2['body'][_0x3f8712(0x2f2)]||'',_0x418a94=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x1a0)]||_0x3f8712(0x1fe),_0x2b8806=_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x190)]||_0x3f8712(0x2ba);if(![_0x3f8712(0x1fe),'title'][_0x3f8712(0x1fb)](_0x418a94))return console[_0x3f8712(0x183)]('order\x20field\x20error',_0x418a94),[];let _0x62bc10=[],_0x2141d7=[],_0x1dc706=_0x3f8712(0x1a9);_0x184cf2['currentUser'][_0x3f8712(0x24c)]==0x1?_0x462db4&&(_0x1dc706+=_0x3f8712(0x214),_0x2141d7[_0x3f8712(0x19f)]('%'+_0x462db4+'%')):(_0x1dc706=_0x3f8712(0x27c),_0x462db4&&(_0x1dc706+='\x20and\x20title\x20like\x20?',_0x2141d7[_0x3f8712(0x19f)]('%'+_0x462db4+'%')));_0x1dc706+=_0x3f8712(0x2c0)+_0x418a94+'\x20'+_0x2b8806+_0x3f8712(0x20f),_0x2141d7[_0x3f8712(0x19f)](_0x593402),_0x2141d7[_0x3f8712(0x19f)](_0x133950),_0x62bc10=_0x184cf2['app'][_0x3f8712(0x217)][_0x3f8712(0x1ef)](_0x1dc706)[_0x3f8712(0x1c9)](_0x2141d7);if(_0x62bc10['length']<0x1)return _0x5e24a0[_0x3f8712(0x2d7)]({'code':0x0,'data':[]});for(let _0x85b1df in _0x62bc10){let _0x371e6b=_0x62bc10[_0x85b1df];try{let _0x15ec1d=JSON[_0x3f8712(0x1c4)](_0x371e6b['share_uid']),_0x3d6b2f=[];for(let _0x3d12e9 of _0x15ec1d){let _0xf8ee88=dbUserTable[_0x3f8712(0x23a)](_0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x1ce)],_0x3d12e9,_0x3f8712(0x254));_0x3d6b2f[_0x3f8712(0x19f)](_0xf8ee88);}_0x62bc10[_0x85b1df]['user_list']=_0x3d6b2f;}catch(_0x462ee7){console['log'](_0x462ee7);}_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2ee)]=0x4,_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x245)]=[],_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2b6)]=0x0,_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x188)]=_0x3f8712(0x201),_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x18d)]=_0x3f8712(0x2ba),_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x2e9)]=0x1,_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x19a)]=0x9184e729fff,_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x1d6)]=0x0,_0x184cf2[_0x3f8712(0x22d)][_0x3f8712(0x263)]=_0x62bc10[_0x85b1df]['id'],_0x62bc10[_0x85b1df][_0x3f8712(0x1d1)]=photoApiUtil[_0x3f8712(0x283)](_0x184cf2,_0x5e24a0);}return _0x5e24a0[_0x3f8712(0x2d7)]({'code':0x0,'data':_0x62bc10});}else{if(_0x184cf2['currentUser']['is_admin']!=0x1)return _0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x1c0)](_0x5e24a0,_0x5e24a0['__']('noPermission'));if(_0x380501==_0x3f8712(0x193)||_0x380501==_0x3f8712(0x25d)){if(!_0x1a9530||!_0x1a9530 instanceof Array||_0x1a9530[_0x3f8712(0x2d4)]<0x1)return _0x184cf2['app']['returnErrMsg'](_0x5e24a0,_0x5e24a0['__'](_0x3f8712(0x244)));if(_0x273804){if(_0x4eca40!=null&&!_0x4eca40 instanceof Array)return _0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x1c0)](_0x5e24a0,_0x5e24a0['__'](_0x3f8712(0x244)));}if(sqliteUtil['checkSqlInjection'](JSON[_0x3f8712(0x1af)](_0x1a9530))==!![])return _0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x1c0)](_0x5e24a0,_0x3f8712(0x1aa));}if(_0x380501==_0x3f8712(0x25d)&&_0x103092)_0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x217)][_0x3f8712(0x1ef)](_0x3f8712(0x2c3))['run'](_0x39605f,JSON['stringify'](_0x1a9530),_0x273804,JSON['stringify'](_0x4eca40),_0x103092);else{if(_0x380501==_0x3f8712(0x261)&&_0x103092)_0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x217)][_0x3f8712(0x1ef)](_0x3f8712(0x213))[_0x3f8712(0x208)](_0x103092);else{if(_0x380501==_0x3f8712(0x193))_0x184cf2[_0x3f8712(0x20b)]['dbFileIndex'][_0x3f8712(0x1ef)]('REPLACE\x20INTO\x20photo_library(title,path_list,share_for_subuser,share_uid,user_id)\x20VALUES(\x20?,?,?,?,?)')[_0x3f8712(0x208)](_0x39605f,JSON['stringify'](_0x1a9530),_0x273804,JSON[_0x3f8712(0x1af)](_0x4eca40),_0x184cf2[_0x3f8712(0x233)]['id']);else return _0x184cf2[_0x3f8712(0x20b)][_0x3f8712(0x1c0)](_0x5e24a0,_0x5e24a0['__'](_0x3f8712(0x28a)));}}return _0x5e24a0[_0x3f8712(0x2d7)]({'code':0x0});}}),module['exports']=router;