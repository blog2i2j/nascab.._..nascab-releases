const _0x4c7922=_0x20dd;(function(_0x85160f,_0x51af33){const _0x275705=_0x20dd,_0x13a135=_0x85160f();while(!![]){try{const _0x2a5af8=-parseInt(_0x275705(0xff))/0x1+-parseInt(_0x275705(0x13b))/0x2+parseInt(_0x275705(0x126))/0x3*(parseInt(_0x275705(0x139))/0x4)+parseInt(_0x275705(0x138))/0x5*(parseInt(_0x275705(0x137))/0x6)+parseInt(_0x275705(0x15d))/0x7*(parseInt(_0x275705(0x101))/0x8)+-parseInt(_0x275705(0x11e))/0x9*(parseInt(_0x275705(0x124))/0xa)+-parseInt(_0x275705(0x133))/0xb*(parseInt(_0x275705(0x10d))/0xc);if(_0x2a5af8===_0x51af33)break;else _0x13a135['push'](_0x13a135['shift']());}catch(_0x38161b){_0x13a135['push'](_0x13a135['shift']());}}}(_0x2bfd,0x78c7f));var express=require('express'),router=express['Router']();function _0x2bfd(){const _0x457c6f=['operationFail','ALL','app','json','updateByWhere','startScanPath','clearAiToIndex','movie','scan_when_start','sourceId','497fsvfeU','(\x20\x27\x20”\x20)','transaction','prepare','PATH\x20DO\x20NOT\x20EXIST','exist','isAdmin','sep','book','DirectoryNoExist','../../db/dbSourceFolderTable','find','342312AzHMms','run','71920sGNxKz','deletePathAll','\x20id!=','currentUser','join','clearTable','isDirectory','stat','addScanTask','doUserCanGet','media_type','indexOf','157656iRMzKL','dialog','create','stopIndexWorker','scan_interval_ms','../../db/dbUserTable','deletePowerPath','\x20SET\x20path\x20=\x20\x27','saveLastMatchTime','getPathByType','../../utils/videoStreamUtil','getAll','test','/%\x27','../../db/dbConfigTable','/updateSource','photo','17037PhJmGe','length','\x27\x20)\x20WHERE\x20path\x20LIKE\x20\x27','../../db/dbScanTaskTable','exports','getIndexTableNameByType','5090lMTxNJ','getCount','3cTyshr','photo_faces','returnErrMsg','value','message','读取超时','/addPath','post','\x20SET\x20path\x20=\x20replace(\x20path,\x20\x27','headersSent','deleteSourceAndChilden','sourceType','AlreadyHasParentPath','77owvLuu','scan_interval','INDEX_TABLE_NAME_MOVIE','source\x20id\x20error','5876556yFTboq','5XkzlzB','2894312JVSoPk','music','897520AcnjGt','path','scan_when_change','pathCannotHasSign','\x27,\x20\x27','dbFileIndex','getById','includes','log','\x27\x20WHERE\x20path\x20=\x20\x27','/getPathByType','delete','../../db/dbFileIndexTable','trim','/getAll','scanPath','cannotUseRootPathAsSource','dbOther','send','body','type','INDEX_TABLE_NAME_PHOTO','add','cacheParentPath'];_0x2bfd=function(){return _0x457c6f;};return _0x2bfd();}function _0x20dd(_0x223055,_0x3d2e9f){const _0x2bfdc4=_0x2bfd();return _0x20dd=function(_0x20dd8b,_0x2b5cfc){_0x20dd8b=_0x20dd8b-0xf6;let _0x1e437c=_0x2bfdc4[_0x20dd8b];return _0x1e437c;},_0x20dd(_0x223055,_0x3d2e9f);}let path=require('path');const dbSourceFolderTable=require(_0x4c7922(0xfd)),dbFileIndexTable=require(_0x4c7922(0x147)),dbUserTable=require(_0x4c7922(0x112));var fs=require('fs');const videoStreamUtil=require(_0x4c7922(0x117)),dbConfigTable=require(_0x4c7922(0x11b)),dbScanTaskTable=require(_0x4c7922(0x121));router[_0x4c7922(0x12d)](_0x4c7922(0x145),(_0x28957a,_0x3d2b2b,_0x4c93c3)=>{const _0x5efdaa=_0x4c7922;let _0x2c4fbf=_0x28957a[_0x5efdaa(0x14e)]['type'];if(dbUserTable['isAdmin'](_0x28957a,null)===!![]){let _0x1f53e4=dbSourceFolderTable[_0x5efdaa(0x116)](_0x28957a[_0x5efdaa(0x155)][_0x5efdaa(0x14c)],_0x2c4fbf),_0x18e5f9=0x0;if(_0x1f53e4['length']<0x1)return _0x3d2b2b[_0x5efdaa(0x156)]({'code':0x0,'data':_0x1f53e4});let _0xbb07b8='',_0xa5c0c0=setTimeout(()=>{const _0xd5409b=_0x5efdaa;!_0x3d2b2b['headersSent']&&(console['log'](_0xd5409b(0x12b),_0xbb07b8),_0x3d2b2b['json']({'code':0x0,'data':_0x1f53e4}));},0x1f40),_0x36e0b2=dbConfigTable['findByTitle'](_0x28957a[_0x5efdaa(0x155)][_0x5efdaa(0x14c)],_0x5efdaa(0x152));try{_0x36e0b2&&(_0x36e0b2=path['join'](_0x36e0b2[_0x5efdaa(0x129)]));}catch(_0x31e36){console['log'](_0x31e36);}for(let _0x351868=0x0;_0x351868<_0x1f53e4[_0x5efdaa(0x11f)];_0x351868++){let _0x444114=_0x1f53e4[_0x351868][_0x5efdaa(0x13c)];_0xbb07b8=_0x444114,_0x1f53e4[_0x351868][_0x5efdaa(0xf8)]=0x0,fs[_0x5efdaa(0x108)](_0x444114,(_0x40cb4c,_0x1533b2)=>{const _0x2b2ba5=_0x5efdaa;_0x18e5f9+=0x1,_0x40cb4c?_0x1f53e4[_0x351868][_0x2b2ba5(0xf8)]=0x0:_0x1f53e4[_0x351868]['exist']=0x1,_0x18e5f9>=_0x1f53e4['length']&&(clearTimeout(_0xa5c0c0),!_0x3d2b2b[_0x2b2ba5(0x12f)]&&_0x3d2b2b['json']({'code':0x0,'data':_0x1f53e4,'cacheParentPath':_0x36e0b2?_0x36e0b2:''}));});}}else{let _0x383c32=dbUserTable[_0x5efdaa(0xfe)](_0x28957a[_0x5efdaa(0x155)]['dbOther'],_0x28957a[_0x5efdaa(0x104)]['id']),_0x3446b9=dbUserTable['getUserPower'](_0x28957a[_0x5efdaa(0x155)]['dbOther'],_0x383c32['username'],_0x2c4fbf,'power_get');_0x3d2b2b['json']({'code':0x0,'data':_0x3446b9});}}),router['post'](_0x4c7922(0x149),(_0x3387e2,_0x4c5d00,_0x2d1324)=>{const _0x376e73=_0x4c7922;let _0x2b5f7e=dbSourceFolderTable[_0x376e73(0x118)](_0x3387e2['app']['dbOther']);_0x4c5d00[_0x376e73(0x156)]({'code':0x0,'hasAdmin':_0x2b5f7e?'1':'0'});}),router[_0x4c7922(0x12d)](_0x4c7922(0x11c),(_0xf14050,_0x5e247a,_0x2e0ba8)=>{const _0x164e49=_0x4c7922;let _0x451a10=_0xf14050['body'][_0x164e49(0x15b)]==0x1?0x1:0x0,_0xc6967c=_0xf14050[_0x164e49(0x14e)]['scan_when_change']==0x1?0x1:0x0,_0x58f007=_0xf14050['body'][_0x164e49(0x134)]==0x1?0x1:0x0,_0x27af17=_0xf14050[_0x164e49(0x14e)][_0x164e49(0x111)]||0x0,_0x109b58=_0xf14050[_0x164e49(0x14e)][_0x164e49(0x15c)],_0x512a14=dbSourceFolderTable[_0x164e49(0x141)](_0xf14050[_0x164e49(0x155)][_0x164e49(0x14c)],_0x109b58);if(!_0x512a14)return _0xf14050[_0x164e49(0x155)][_0x164e49(0x128)](_0x5e247a,_0x164e49(0x136));if(dbUserTable[_0x164e49(0xf9)](_0xf14050,null)===!![]){let _0x47b2fc=dbSourceFolderTable[_0x164e49(0x141)](_0xf14050['app'][_0x164e49(0x14c)],_0x109b58);dbSourceFolderTable[_0x164e49(0x157)](_0xf14050[_0x164e49(0x155)][_0x164e49(0x14c)],_0x164e49(0x15b),_0x451a10,_0x109b58),dbSourceFolderTable['updateByWhere'](_0xf14050[_0x164e49(0x155)][_0x164e49(0x14c)],_0x164e49(0x13d),_0xc6967c,_0x109b58),dbSourceFolderTable[_0x164e49(0x157)](_0xf14050[_0x164e49(0x155)][_0x164e49(0x14c)],'scan_interval',_0x58f007,_0x109b58),dbSourceFolderTable[_0x164e49(0x157)](_0xf14050[_0x164e49(0x155)]['dbOther'],'scan_interval_ms',_0x27af17,_0x109b58),_0x512a14=dbSourceFolderTable[_0x164e49(0x141)](_0xf14050[_0x164e49(0x155)][_0x164e49(0x14c)],_0x109b58),_0x47b2fc[_0x164e49(0x13d)]!=_0xc6967c&&process[_0x164e49(0x14d)]({'type':'startScanPath','restartWatcher':!![]}),_0x5e247a[_0x164e49(0x156)]({'code':0x0,'data':_0x512a14});}}),router[_0x4c7922(0x12d)]('/scanPath',(_0x2b3bf9,_0x4e35ab,_0x35f5b6)=>{const _0x548a10=_0x4c7922;let _0x19d3cd=_0x2b3bf9[_0x548a10(0x14e)][_0x548a10(0x14a)],_0x4b2645=_0x2b3bf9[_0x548a10(0x14e)][_0x548a10(0x131)];if(dbUserTable[_0x548a10(0x10a)](_0x2b3bf9,_0x4e35ab,'','power_change',_0x19d3cd)==!![]){if(_0x19d3cd==_0x548a10(0x154)){let _0x124c05=dbSourceFolderTable[_0x548a10(0x116)](_0x2b3bf9['app'][_0x548a10(0x14c)],_0x4b2645);for(let _0x48c62b of _0x124c05){dbScanTaskTable[_0x548a10(0x109)](_0x2b3bf9[_0x548a10(0x155)][_0x548a10(0x14c)],_0x48c62b[_0x548a10(0x14f)],_0x48c62b['path']);}}else dbScanTaskTable['addScanTask'](_0x2b3bf9[_0x548a10(0x155)][_0x548a10(0x14c)],_0x4b2645,_0x19d3cd);return process[_0x548a10(0x14d)]({'type':_0x548a10(0x158),'source_type':_0x4b2645,'restartWatcher':![]}),_0x4e35ab['json']({'code':0x0});}}),router[_0x4c7922(0x12d)]('/relocatePath',(_0x41f396,_0x18d308,_0x1532ad)=>{const _0x475447=_0x4c7922;if(dbUserTable[_0x475447(0xf9)](_0x41f396,_0x18d308)===!![]){let _0x21b279=_0x41f396[_0x475447(0x14e)]['rawPathId'],_0x33ca05=path['join'](_0x41f396[_0x475447(0x14e)][_0x475447(0x13c)]['trim']()),_0x52edd0=_0x41f396[_0x475447(0x14e)][_0x475447(0x14f)][_0x475447(0x148)](),_0x5bbaa7=dbFileIndexTable[_0x475447(0x150)];if(_0x52edd0==_0x475447(0x15a))_0x5bbaa7=dbFileIndexTable[_0x475447(0x135)];else{if(_0x52edd0==_0x475447(0x13a))_0x5bbaa7=dbFileIndexTable['INDEX_TABLE_NAME_MUSIC'];else _0x52edd0==_0x475447(0xfb)&&(_0x5bbaa7=dbFileIndexTable['INDEX_TABLE_NAME_BOOK']);}if(_0x33ca05[_0x475447(0x10c)]('\x27')>0x0||_0x33ca05[_0x475447(0x10c)]('\x22')>0x0)return _0x41f396['app']['returnErrMsg'](_0x18d308,_0x18d308['__'](_0x475447(0x13e))+_0x475447(0x15e),'dialog');if(/^\w\:\\$/[_0x475447(0x119)](_0x33ca05))return _0x41f396['app']['returnErrMsg'](_0x18d308,_0x18d308['__'](_0x475447(0x14b)),_0x475447(0x10e));let _0x48a8f9=dbSourceFolderTable['getPathByTypeAndWhere'](_0x41f396[_0x475447(0x155)][_0x475447(0x14c)],_0x52edd0,_0x475447(0x103)+_0x21b279);for(let _0x2e350a=0x0;_0x2e350a<_0x48a8f9[_0x475447(0x11f)];_0x2e350a++){let _0x2591ae=path[_0x475447(0x105)](_0x48a8f9[_0x2e350a]['path'][_0x475447(0x148)]());if(_0x33ca05==_0x2591ae)return _0x41f396[_0x475447(0x155)]['returnErrMsg'](_0x18d308,_0x18d308['__']('PathAlreadyExists'),'dialog');else{if(_0x33ca05['indexOf'](path[_0x475447(0x105)](_0x48a8f9[_0x2e350a][_0x475447(0x13c)],path[_0x475447(0xfa)]))!=-0x1)return _0x41f396[_0x475447(0x155)]['returnErrMsg'](_0x18d308,_0x18d308['__'](_0x475447(0x132)),_0x475447(0x10e));else{if(_0x48a8f9[_0x2e350a][_0x475447(0x13c)][_0x475447(0x10c)](path[_0x475447(0x105)](_0x33ca05,path['sep']))!=-0x1)return _0x41f396[_0x475447(0x155)][_0x475447(0x128)](_0x18d308,_0x18d308['__']('AlreadyHasParentPath'),_0x475447(0x10e));}}}let _0x32543c=dbSourceFolderTable['getById'](_0x41f396['app'][_0x475447(0x14c)],_0x21b279);if(!_0x32543c)return _0x41f396['app'][_0x475447(0x128)](_0x18d308,_0x475447(0xf7),_0x475447(0x10e));fs['stat'](_0x33ca05,(_0x14771a,_0x58d1a1)=>{const _0x4257d3=_0x475447;if(_0x14771a||!_0x58d1a1[_0x4257d3(0x107)]())return _0x41f396[_0x4257d3(0x155)][_0x4257d3(0x128)](_0x18d308,_0x18d308['__'](_0x4257d3(0xfc)),_0x4257d3(0x12a));const _0x12de8d=_0x41f396['app'][_0x4257d3(0x140)][_0x4257d3(0x15f)](()=>{const _0x784230=_0x4257d3;let _0x4da742='UPDATE\x20'+_0x5bbaa7+'\x20SET\x20path\x20=\x20replace(\x20path,\x20\x27'+_0x32543c[_0x784230(0x13c)]+_0x784230(0x13f)+_0x33ca05+_0x784230(0x120)+_0x32543c['path']+_0x784230(0x11a),_0x2092e9='UPDATE\x20'+_0x5bbaa7+_0x784230(0x114)+_0x33ca05+_0x784230(0x144)+_0x32543c[_0x784230(0x13c)]+'\x27',_0x5cce9d='UPDATE\x20'+_0x5bbaa7+_0x784230(0x12e)+_0x32543c[_0x784230(0x13c)]+'\x27,\x20\x27'+_0x33ca05+'\x27\x20)\x20WHERE\x20path\x20LIKE\x20\x27'+_0x32543c[_0x784230(0x13c)]+'\x5c%\x27';_0x41f396[_0x784230(0x155)][_0x784230(0x140)]['prepare'](_0x4da742)[_0x784230(0x100)](),_0x41f396['app']['dbFileIndex'][_0x784230(0xf6)](_0x2092e9)['run'](),_0x41f396[_0x784230(0x155)][_0x784230(0x140)][_0x784230(0xf6)](_0x5cce9d)[_0x784230(0x100)]();});return _0x12de8d(),dbSourceFolderTable[_0x4257d3(0x157)](_0x41f396[_0x4257d3(0x155)]['dbOther'],'path',_0x33ca05,_0x21b279),dbScanTaskTable['addScanTask'](_0x41f396['app'][_0x4257d3(0x14c)],_0x52edd0,_0x33ca05),process[_0x4257d3(0x14d)]({'type':_0x4257d3(0x158),'path':_0x33ca05,'operate':_0x4257d3(0x151),'source_type':_0x52edd0,'restartWatcher':!![]}),_0x18d308[_0x4257d3(0x156)]({'code':0x0});});}});let allowSourceTypeList=[_0x4c7922(0x11d),'movie',_0x4c7922(0x13a),_0x4c7922(0xfb)];router[_0x4c7922(0x12d)](_0x4c7922(0x12c),(_0x498d62,_0x388efb,_0x46d198)=>{const _0x3028dd=_0x4c7922;if(dbUserTable['isAdmin'](_0x498d62,_0x388efb)===!![]){let _0x19db0f=path[_0x3028dd(0x105)](_0x498d62['body'][_0x3028dd(0x13c)]['trim']()),_0x46da23=_0x498d62[_0x3028dd(0x14e)][_0x3028dd(0x14f)][_0x3028dd(0x148)](),_0x5f586f=_0x498d62[_0x3028dd(0x14e)][_0x3028dd(0x10b)];if(!allowSourceTypeList[_0x3028dd(0x142)](_0x46da23))return _0x498d62[_0x3028dd(0x155)][_0x3028dd(0x128)](_0x388efb,'Need\x20type',_0x3028dd(0x10e));if(_0x19db0f[_0x3028dd(0x10c)]('\x27')>0x0||_0x19db0f[_0x3028dd(0x10c)]('\x22')>0x0)return _0x498d62['app'][_0x3028dd(0x128)](_0x388efb,_0x388efb['__'](_0x3028dd(0x13e))+_0x3028dd(0x15e),_0x3028dd(0x10e));if(/^\w\:\\$/[_0x3028dd(0x119)](_0x19db0f)||_0x19db0f==path['sep'])return _0x498d62[_0x3028dd(0x155)][_0x3028dd(0x128)](_0x388efb,_0x388efb['__'](_0x3028dd(0x14b)),'dialog');let _0x4e9c08=dbSourceFolderTable['getPathByType'](_0x498d62[_0x3028dd(0x155)][_0x3028dd(0x14c)],_0x46da23);for(let _0xb7acf0=0x0;_0xb7acf0<_0x4e9c08[_0x3028dd(0x11f)];_0xb7acf0++){let _0x246ebf=path[_0x3028dd(0x105)](_0x4e9c08[_0xb7acf0][_0x3028dd(0x13c)]['trim']());if(_0x19db0f==_0x246ebf)return _0x498d62[_0x3028dd(0x155)][_0x3028dd(0x128)](_0x388efb,_0x388efb['__']('PathAlreadyExists'),_0x3028dd(0x10e));else{if(_0x19db0f[_0x3028dd(0x10c)](path[_0x3028dd(0x105)](_0x4e9c08[_0xb7acf0]['path'],path[_0x3028dd(0xfa)]))!=-0x1)return _0x498d62['app'][_0x3028dd(0x128)](_0x388efb,_0x388efb['__']('AlreadyHasParentPath'),_0x3028dd(0x10e));else{if(_0x4e9c08[_0xb7acf0]['path'][_0x3028dd(0x10c)](path[_0x3028dd(0x105)](_0x19db0f,path['sep']))!=-0x1)return _0x498d62['app'][_0x3028dd(0x128)](_0x388efb,_0x388efb['__'](_0x3028dd(0x132)),_0x3028dd(0x10e));}}}fs[_0x3028dd(0x108)](_0x19db0f,(_0x166729,_0x3f9c6c)=>{const _0x50a01d=_0x3028dd;if(_0x166729||!_0x3f9c6c[_0x50a01d(0x107)]())return _0x498d62[_0x50a01d(0x155)][_0x50a01d(0x128)](_0x388efb,_0x388efb['__'](_0x50a01d(0xfc)),_0x50a01d(0x12a));dbSourceFolderTable[_0x50a01d(0x10f)](_0x498d62[_0x50a01d(0x155)][_0x50a01d(0x14c)],{'media_type':_0x5f586f,'path':_0x19db0f,'type':_0x46da23,'ctime':0x0,'ignore_match_info':0x1}),dbScanTaskTable[_0x50a01d(0x109)](_0x498d62[_0x50a01d(0x155)][_0x50a01d(0x14c)],_0x46da23,_0x19db0f),process[_0x50a01d(0x14d)]({'type':_0x50a01d(0x158),'path':_0x19db0f,'operate':'add','source_type':_0x46da23,'restartWatcher':!![]}),_0x388efb[_0x50a01d(0x156)]({'code':0x0}),videoStreamUtil[_0x50a01d(0x115)](_0x498d62[_0x50a01d(0x155)][_0x50a01d(0x14c)]);});}}),router['post']('/deletePath',(_0x23ea26,_0x3e5bcf,_0x338f92)=>{const _0x3479d4=_0x4c7922;if(dbUserTable['isAdmin'](_0x23ea26,_0x3e5bcf)===!![]){let _0x132141=_0x23ea26[_0x3479d4(0x14e)]['id'],_0x315ea1=dbSourceFolderTable[_0x3479d4(0x141)](_0x23ea26['app'][_0x3479d4(0x14c)],_0x132141);if(!_0x315ea1)return _0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x128)](_0x3e5bcf,_0x3e5bcf['__']('sourcePathNotExist'),'dialog');_0x3e5bcf[_0x3479d4(0x156)]({'code':0x0});let _0x9dbeab=dbFileIndexTable[_0x3479d4(0x123)](_0x315ea1[_0x3479d4(0x14f)]);try{process['send']({'type':_0x3479d4(0x110),'path':_0x315ea1[_0x3479d4(0x13c)],'source_type':_0x315ea1[_0x3479d4(0x14f)]});let _0x2692c0=dbSourceFolderTable[_0x3479d4(0x125)](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x14c)],_0x315ea1['type']);_0x2692c0<=0x1?(_0x315ea1[_0x3479d4(0x14f)]==_0x3479d4(0x11d)&&(dbFileIndexTable[_0x3479d4(0x106)](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x140)],_0x3479d4(0x127)),dbFileIndexTable[_0x3479d4(0x159)](_0x23ea26['app']['dbFileIndex'])),dbFileIndexTable['clearTable'](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x140)],_0x9dbeab)):(dbFileIndexTable[_0x3479d4(0x102)](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x140)],_0x315ea1[_0x3479d4(0x13c)],_0x9dbeab),videoStreamUtil['saveLastMatchTime'](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x14c)])),dbSourceFolderTable[_0x3479d4(0x130)](_0x23ea26[_0x3479d4(0x155)][_0x3479d4(0x14c)],_0x315ea1[_0x3479d4(0x13c)],_0x315ea1[_0x3479d4(0x14f)]),dbUserTable[_0x3479d4(0x113)](_0x23ea26[_0x3479d4(0x155)]['dbOther'],_0x315ea1[_0x3479d4(0x13c)],_0x315ea1[_0x3479d4(0x14f)]),setTimeout(()=>{const _0x4ddfd8=_0x3479d4;process[_0x4ddfd8(0x14d)]({'type':_0x4ddfd8(0x158),'path':_0x315ea1['path'],'operate':_0x4ddfd8(0x146),'source_type':_0x315ea1['type'],'restartWatcher':!![]});},0xbb8);}catch(_0x42d4cf){return console[_0x3479d4(0x143)](_0x42d4cf),setTimeout(()=>{const _0x318400=_0x3479d4;process[_0x318400(0x14d)]({'type':_0x318400(0x158),'path':_0x315ea1['path'],'operate':_0x318400(0x146),'source_type':_0x315ea1[_0x318400(0x14f)],'restartWatcher':!![]});},0xbb8),_0x23ea26['app'][_0x3479d4(0x128)](_0x3e5bcf,_0x3e5bcf['__'](_0x3479d4(0x153)),_0x3479d4(0x10e));}}}),module[_0x4c7922(0x122)]=router;