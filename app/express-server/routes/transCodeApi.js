const _0x5b8232=_0x400c;(function(_0x3db8fc,_0x45c92b){const _0x1cc71e=_0x400c,_0x565ec9=_0x3db8fc();while(!![]){try{const _0x3c4a9d=parseInt(_0x1cc71e(0x226))/0x1+parseInt(_0x1cc71e(0x1e1))/0x2*(-parseInt(_0x1cc71e(0x1fe))/0x3)+-parseInt(_0x1cc71e(0x1b2))/0x4+parseInt(_0x1cc71e(0x1bf))/0x5*(parseInt(_0x1cc71e(0x1a0))/0x6)+parseInt(_0x1cc71e(0x1d0))/0x7*(parseInt(_0x1cc71e(0x1df))/0x8)+-parseInt(_0x1cc71e(0x1b7))/0x9*(parseInt(_0x1cc71e(0x243))/0xa)+parseInt(_0x1cc71e(0x20f))/0xb*(parseInt(_0x1cc71e(0x1a2))/0xc);if(_0x3c4a9d===_0x45c92b)break;else _0x565ec9['push'](_0x565ec9['shift']());}catch(_0x18402b){_0x565ec9['push'](_0x565ec9['shift']());}}}(_0x5ceb,0x332e6));function _0x400c(_0x1d825a,_0x5f52c4){const _0x5cebb6=_0x5ceb();return _0x400c=function(_0x400c3b,_0x3496de){_0x400c3b=_0x400c3b-0x1a0;let _0x4def62=_0x5cebb6[_0x400c3b];return _0x4def62;},_0x400c(_0x1d825a,_0x5f52c4);}let express=require('express'),router=express[_0x5b8232(0x213)](),path=require('path'),fs=require('fs'),transCodeUtil=require('../../utils/transCodeUtil'),fileUtil=require(_0x5b8232(0x222));const config=require('../../myConfig/config');let videoStreamUtil=require(_0x5b8232(0x1bd)),FFmpeg=require('../../libs/nasTrans')['FFmpeg'],cryptoUtils=require(_0x5b8232(0x1c8)),sha256=require(_0x5b8232(0x21a));require('events')[_0x5b8232(0x1f3)]['defaultMaxListeners']=0x0;function _0x5ceb(){const _0x4ba749=['stream','Content-disposition','&size=','jschardet','encoding','spaceId','addInputOption','token','stringify','videoCodec','EventEmitter','access','\x0a#EXT-X-ENDLIST\x0a','pipe','.ts','encoderName','dbFileIndex','videobit','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','&seq=','&spaceIndexId=','51xkSgSO','outputOptions','&spaceToken=','audioCodec','生成字幕文件','seq','sendStatus','streams','Content-type','../../db/dbConfigTable','webvtt','send','path','-map\x200:v:0?','stat','stype','prepare','143ggERdX','getCoderConfig','application/octet-stream','decodePath','Router','duration','app','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','&indexId=','\x0a#EXTINF:','.ts?playId=','sha256','startsWith','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?','error','spaceToken','output','json','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','../utils/fileUtils','run','confidence','m3u8TmpPath','133710uZvaDe','filename','M3u8Transcode','mp4','join','close','outputFormat','size','serverType','waiting','decoderCommand','cannotReadFile','../../db/dbFileIndexTable','readFile','/subtitle*','floor','status','&spaceId=','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','ts_name','stop','spaceIndexId','index\x20no\x20permission','filePath','videoBitrate','message','decryptFileGetStream','vtt','&token=','52570FIcdJF','inputOption','format','index\x20does\x20not\x20exist','kill','/getVideoInfoByPath','moviePreferLanguage','killed','23466FszPAN','lastIndexOf','181296NDRCsw','replace','parseVideoFullPath','then','-map\x200:s:','subtitlePath','gen','m3u8segmentDuration','playId','get','-movflags\x20frag_keyframe+empty_moov','value','returnErrMsg','indexId','faidLoadSubtitle','addOption','1281032ATURwu','body','catch','constants','doUserCanGet','36OPfFSg','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','subtitleIndex','seekInput','query','detect','../../utils/videoStreamUtil','dbOther','135AxCIRL','power_get','&subtitleIndex=','&serverType=','audioIndex','&filePath=','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','end','input','../utils/cryptoUtils','start','sendFile','getDurationFromStream','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','burn',',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET=','setHeader','2233658Rwfoml','exports','currentUser','noAudio','dealFFmpegPath','endsWith','getById','&ac=','R_OK','noContent','/stopPlay','log','.m3u8','.0,\x0astream','length','8GBNyRn','indexOf','23986VPfeVi','noVideo','substring','aac','seek','getVideoMeta','m3u8','getVideoBitrate'];_0x5ceb=function(){return _0x4ba749;};return _0x5ceb();}const dbUserTable=require('../../db/dbUserTable'),dbFileIndexTable=require(_0x5b8232(0x232)),dbConfigTable=require(_0x5b8232(0x207));var jschardet=require(_0x5b8232(0x1ec));function MP4FfmpegTrans(_0x5ae375,_0x47df31,_0x4132e,_0x4f79a2,_0x129cd9,_0x1426db){const _0x488f9c=_0x5b8232;let _0x2b404d=_0x5ae375[_0x488f9c(0x1bb)],_0x1aed68=FFmpeg(),_0x2b81ae;if(_0x129cd9)_0x2b81ae=cryptoUtils[_0x488f9c(0x240)](_0x1426db,_0x4132e);let _0x254e07=_0x129cd9?_0x2b81ae:_0x4132e,{videoStream:_0x11ca45,videoWidth:_0x39c7fb,videoHeight:_0x171724}=transCodeUtil['parseStreamList'](_0x4f79a2);_0x1aed68[_0x488f9c(0x1c7)](transCodeUtil[_0x488f9c(0x1d4)](_0x254e07));try{_0x1aed68['on'](_0x488f9c(0x1c9),function(_0x5d9692){const _0x111474=_0x488f9c;console[_0x111474(0x1db)](_0x5d9692);}),_0x1aed68['on'](_0x488f9c(0x21d),function(_0x12abb0){const _0x21a860=_0x488f9c;if(_0x12abb0[_0x21a860(0x23f)]&&_0x12abb0['message'][_0x21a860(0x1e0)](_0x21a860(0x24a))==-0x1)_0x1aed68[_0x21a860(0x247)](),_0x1aed68=null,_0x47df31[_0x21a860(0x236)](0x1f4)[_0x21a860(0x1c6)]();else{}}),_0x1aed68['on'](_0x488f9c(0x1c6),function(_0x44418c){const _0x35a034=_0x488f9c;_0x1aed68&&(_0x1aed68['kill'](),_0x1aed68=null);if(_0x47df31)_0x47df31[_0x35a034(0x236)](0xc8)[_0x35a034(0x1c6)]();}),_0x47df31['on']('close',function(){});let _0x2f6aa7=transCodeUtil[_0x488f9c(0x210)](_0x5ae375[_0x488f9c(0x215)][_0x488f9c(0x1be)],_0x11ca45);_0x2f6aa7[_0x488f9c(0x230)]&&_0x1aed68[_0x488f9c(0x1ef)](_0x2f6aa7[_0x488f9c(0x230)]);let _0x337408=_0x2b404d[_0x488f9c(0x203)]*config['m3u8segmentDuration'];_0x337408&&!_0x129cd9&&_0x1aed68[_0x488f9c(0x1ba)](''+parseInt(_0x337408));_0x2f6aa7[_0x488f9c(0x1f8)]&&_0x1aed68[_0x488f9c(0x1f2)](_0x2f6aa7[_0x488f9c(0x1f8)]);let _0x3fd0f=transCodeUtil[_0x488f9c(0x1e8)](_0x11ca45,_0x2b404d[_0x488f9c(0x1fa)]);!_0x3fd0f&&(_0x3fd0f=0x1800),_0x1aed68[_0x488f9c(0x23e)](''+_0x3fd0f),_0x1aed68[_0x488f9c(0x1b1)](_0x488f9c(0x20b)),_0x1aed68[_0x488f9c(0x1b1)]('-map\x200:a:'+(_0x2b404d[_0x488f9c(0x1c3)]?_0x2b404d['audioIndex']:0x0)+'?'),_0x1aed68[_0x488f9c(0x22c)]('mp4'),_0x1aed68[_0x488f9c(0x201)](_0x488f9c(0x1e4)),_0x1aed68[_0x488f9c(0x1ff)]([_0x488f9c(0x1ac)]),_0x1aed68[_0x488f9c(0x22c)](_0x488f9c(0x229)),_0x1aed68[_0x488f9c(0x1f6)](_0x47df31,{'end':!![]});}catch(_0x288bfc){console[_0x488f9c(0x1db)](_0x288bfc),_0x1aed68[_0x488f9c(0x247)](),_0x47df31[_0x488f9c(0x204)](0x1f4);}}router['all'](_0x5b8232(0x1da),(_0x265530,_0x316450,_0x5097c3)=>{const _0x47f9ff=_0x5b8232;let _0x4548f7=_0x265530['query'][_0x47f9ff(0x1aa)]||_0x265530[_0x47f9ff(0x1b3)][_0x47f9ff(0x1aa)];process[_0x47f9ff(0x209)]({'type':_0x47f9ff(0x228),'playId':_0x4548f7,'action':_0x47f9ff(0x23a)});let _0x27899c=path[_0x47f9ff(0x22a)](config[_0x47f9ff(0x225)],_0x4548f7);return fs['rm'](_0x27899c,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x22ca19=>{const _0x4ff6b3=_0x47f9ff;if(_0x22ca19)console[_0x4ff6b3(0x1db)](_0x22ca19);}),_0x265530[_0x47f9ff(0x215)][_0x47f9ff(0x1be)]['prepare'](_0x47f9ff(0x1cc))[_0x47f9ff(0x223)](_0x265530[_0x47f9ff(0x1bb)]['playId']),_0x316450[_0x47f9ff(0x220)]({'code':0x0});}),router[_0x5b8232(0x1ab)](_0x5b8232(0x234),(_0xf0d443,_0x305ca4,_0x3f56e7)=>{const _0x53d893=_0x5b8232;let _0x4ea074=_0xf0d443[_0x53d893(0x1bb)],_0x5b2511=_0x4ea074[_0x53d893(0x1b9)],_0x40c52a=_0x4ea074['subtitleFile'];if(_0x40c52a&&_0x40c52a[_0x53d893(0x1de)]>0x2){let _0x2a9ac0=fileUtil[_0x53d893(0x212)](_0x40c52a);fs[_0x53d893(0x1f4)](_0x2a9ac0,fs['constants'][_0x53d893(0x1d8)],_0x1b2792=>{const _0xbe4c9b=_0x53d893;if(_0x1b2792)return _0xf0d443[_0xbe4c9b(0x215)][_0xbe4c9b(0x1ae)](_0x305ca4,_0x305ca4['__'](_0xbe4c9b(0x231)));path['extname'](_0x2a9ac0)=='.vtt'&&_0x305ca4['sendFile'](_0x2a9ac0),fs[_0xbe4c9b(0x233)](_0x2a9ac0,(_0x1272c2,_0x6f448c)=>{const _0x2b65e6=_0xbe4c9b;if(_0x1272c2)return _0xf0d443[_0x2b65e6(0x215)][_0x2b65e6(0x1ae)](_0x305ca4,_0x305ca4['__']('cannotReadFile'));try{let _0x3ddac8=jschardet[_0x2b65e6(0x1bc)](_0x6f448c);!_0x3ddac8[_0x2b65e6(0x1ed)][_0x2b65e6(0x21b)]('UTF-')&&_0x3ddac8[_0x2b65e6(0x224)]>0.95?_0x977725(_0x3ddac8['encoding']):_0x977725();}catch(_0x485fb9){console['log'](_0x485fb9),_0x977725();}function _0x977725(_0x2fc0f2){const _0x21836e=_0x2b65e6;let _0xc08b6b=FFmpeg();_0xc08b6b[_0x21836e(0x1c7)](transCodeUtil[_0x21836e(0x1d4)](_0x2a9ac0))[_0x21836e(0x1d3)]()[_0x21836e(0x1e2)]()[_0x21836e(0x245)](_0x21836e(0x208)),_0x2fc0f2&&_0xc08b6b[_0x21836e(0x244)]('-sub_charenc\x20'+_0x2fc0f2),_0xc08b6b['on'](_0x21836e(0x1c9),function(_0x41bbbe){const _0x1e2dbc=_0x21836e;console[_0x1e2dbc(0x1db)](_0x41bbbe);})['on'](_0x21836e(0x21d),function(_0x2da632){const _0x848630=_0x21836e;_0xc08b6b[_0x848630(0x247)]();})['on'](_0x21836e(0x1c6),function(){const _0x1e1420=_0x21836e;_0xc08b6b[_0x1e1420(0x247)]();})['pipe'](_0x305ca4);}});});}else{let _0x7e6913=_0x4ea074[_0x53d893(0x20d)];transCodeUtil[_0x53d893(0x1a4)](_0xf0d443[_0x53d893(0x215)][_0x53d893(0x1f9)],_0xf0d443[_0x53d893(0x215)][_0x53d893(0x1be)],_0x4ea074)[_0x53d893(0x1a5)](_0xc97265=>{const _0x2839f3=_0x53d893;let {fullpath:_0x43635f,needDecrypt:_0x49b17f,pwd:_0xa9f906,streamList:_0x34e60d}=_0xc97265;fs[_0x2839f3(0x1f4)](_0x43635f,fs[_0x2839f3(0x1b5)][_0x2839f3(0x1d8)],_0xee6636=>{const _0xb40947=_0x2839f3;if(_0xee6636)return _0xf0d443[_0xb40947(0x215)][_0xb40947(0x1ae)](_0x305ca4,_0x305ca4['__'](_0xb40947(0x231)));if(!_0x7e6913)_0x7e6913=_0xb40947(0x241);let _0x5266e1=path[_0xb40947(0x22a)](config[_0xb40947(0x1a7)],sha256(_0x43635f+_0x5b2511)+'.'+_0x7e6913);fs[_0xb40947(0x20c)](_0x5266e1,(_0x981ce2,_0xcb7083)=>{const _0x374796=_0xb40947;if(_0x981ce2||_0xcb7083['size']<0x3e8){console[_0x374796(0x1db)](_0x374796(0x202),_0x5266e1);let _0x347db7=_0x49b17f?cryptoUtils[_0x374796(0x240)](_0xa9f906,_0x43635f):_0x43635f,_0x4addd3=FFmpeg({'timeout':0x258});_0x4addd3['input'](transCodeUtil['dealFFmpegPath'](_0x347db7))[_0x374796(0x1d3)]()[_0x374796(0x1e2)]()[_0x374796(0x1ff)]([_0x374796(0x1a6)+_0x5b2511])[_0x374796(0x21f)](_0x5266e1)['on']('start',function(_0x22dd32){console['log'](_0x22dd32);})['on'](_0x374796(0x21d),function(_0x2d967e){const _0x40377c=_0x374796;console[_0x40377c(0x1db)](_0x2d967e),_0x4addd3[_0x40377c(0x247)](),fs['rm'](_0x5266e1,_0x1a2fff=>{}),_0xf0d443[_0x40377c(0x215)][_0x40377c(0x1ae)](_0x305ca4,_0x305ca4['__'](_0x40377c(0x1b0)));})['on']('end',function(){const _0x4d690a=_0x374796;return _0x4addd3[_0x4d690a(0x247)](),_0x4ea074[_0x4d690a(0x1d9)]?_0x305ca4[_0x4d690a(0x220)]({'code':0x0}):_0x305ca4['sendFile'](_0x5266e1);}),_0x4addd3[_0x374796(0x223)](),_0x305ca4['on'](_0x374796(0x22b),function(){const _0x2c79e2=_0x374796;_0x4addd3[_0x2c79e2(0x247)]();});}else{console['log']('字幕文件存在缓存',_0x5266e1);if(_0x4ea074[_0x374796(0x1d9)])return _0x305ca4[_0x374796(0x220)]({'code':0x0});return _0x305ca4['sendFile'](_0x5266e1);}});});})['catch'](_0x440fe3=>{const _0x45a24e=_0x53d893;console[_0x45a24e(0x1db)](_0x440fe3),_0xf0d443['app'][_0x45a24e(0x1ae)](_0x305ca4,_0x440fe3);});}});function sendTsFile(_0x105c2a,_0x30c427,_0x1bc608,_0x3d2053,_0x5855f9,_0x587940=0x1){const _0x17c1f4=_0x5b8232;if(_0x587940>0x28)return;let _0x22af10=_0x1bc608[_0x17c1f4(0x1aa)];if(!_0x22af10)return;let _0x40ffb5=_0x105c2a[_0x17c1f4(0x215)][_0x17c1f4(0x1be)][_0x17c1f4(0x20e)](_0x17c1f4(0x1b8))[_0x17c1f4(0x1ab)](_0x22af10,_0x5855f9,'gen');if(_0x40ffb5)fs[_0x17c1f4(0x20c)](_0x3d2053,(_0x2f3097,_0x313f95)=>{const _0x5482b7=_0x17c1f4;_0x2f3097?(_0x105c2a[_0x5482b7(0x215)][_0x5482b7(0x1be)][_0x5482b7(0x20e)]('DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?')[_0x5482b7(0x223)](_0x22af10,_0x5855f9),sendTsFile(_0x105c2a,_0x30c427,_0x1bc608,_0x3d2053,_0x5855f9,_0x587940+0x1)):(_0x105c2a[_0x5482b7(0x215)][_0x5482b7(0x1be)][_0x5482b7(0x20e)](_0x5482b7(0x1fb))[_0x5482b7(0x223)](_0x22af10),_0x30c427[_0x5482b7(0x1ca)](_0x3d2053));});else{function _0x53e2b0(){const _0x8d3b59=_0x17c1f4;let _0x2d221a=setTimeout(()=>{clearTimeout(_0x2d221a),sendTsFile(_0x105c2a,_0x30c427,_0x1bc608,_0x3d2053,_0x5855f9,_0x587940+0x1);},0x1f4);_0x30c427['on'](_0x8d3b59(0x22b),()=>clearTimeout(_0x2d221a));}let _0x1f63e9=_0x105c2a['app'][_0x17c1f4(0x1be)][_0x17c1f4(0x20e)](_0x17c1f4(0x1c5))[_0x17c1f4(0x1ab)](_0x22af10,_0x17c1f4(0x1a8));if(!_0x1f63e9)return _0x53e2b0();else{let _0x1f23f5=_0x105c2a[_0x17c1f4(0x215)][_0x17c1f4(0x1be)][_0x17c1f4(0x20e)](_0x17c1f4(0x21c))[_0x17c1f4(0x1ab)](_0x22af10,_0x5855f9,_0x17c1f4(0x22f));if(_0x1f23f5)return _0x53e2b0();else{let _0x1328a9=parseInt(_0x1f63e9[_0x17c1f4(0x239)][_0x17c1f4(0x1a3)](_0x17c1f4(0x1e9),'')[_0x17c1f4(0x1a3)](_0x17c1f4(0x1f7),''));return _0x1bc608[_0x17c1f4(0x203)]>_0x1328a9+0xf||_0x1bc608['seq']<_0x1328a9?(process[_0x17c1f4(0x209)]({'type':_0x17c1f4(0x228),'playId':_0x22af10,'action':_0x17c1f4(0x23a)}),process['send']({'type':'M3u8Transcode','playId':_0x22af10,'args':_0x1bc608,'action':_0x17c1f4(0x1c9)}),_0x105c2a['app'][_0x17c1f4(0x1be)][_0x17c1f4(0x20e)](_0x17c1f4(0x216))[_0x17c1f4(0x223)](_0x22af10,_0x5855f9,_0x17c1f4(0x22f)),_0x53e2b0()):_0x53e2b0();}}}}function hasPermission(_0x3f3af8,_0x29ede9,_0x2dc9f7){const _0x3306c0=_0x5b8232;if(_0x2dc9f7[_0x3306c0(0x1af)]&&!_0x2dc9f7[_0x3306c0(0x1ee)]){let _0xa28f8e=dbFileIndexTable['getIndexTableNameByType'](_0x2dc9f7['serverType']),_0x4ed6d4=dbFileIndexTable[_0x3306c0(0x1d6)](_0x3f3af8['app'][_0x3306c0(0x1f9)],_0x2dc9f7[_0x3306c0(0x1af)],_0xa28f8e);if(!_0x4ed6d4)return reject(_0x3306c0(0x246));let _0x570688=_0x4ed6d4[_0x3306c0(0x20a)]+path['sep']+_0x4ed6d4[_0x3306c0(0x227)];if(dbUserTable[_0x3306c0(0x1b6)](_0x3f3af8,_0x29ede9,_0x2dc9f7[_0x3306c0(0x22e)],_0x3306c0(0x1c0),_0x570688,!![])!==!![])return console[_0x3306c0(0x1db)]('index\x20no\x20permission'),![];return!![];}else{if(_0x2dc9f7[_0x3306c0(0x23d)]&&!_0x2dc9f7[_0x3306c0(0x1ee)]){let _0xeda0f7=fileUtil[_0x3306c0(0x212)](_0x2dc9f7['filePath']);if(dbUserTable['doUserCanGet'](_0x3f3af8,_0x29ede9,'',_0x3306c0(0x1c0),_0xeda0f7,!![])!==!![])return console[_0x3306c0(0x1db)](_0x3306c0(0x23c)),![];return!![];}else return!![];}}router['get']('/play*',(_0x47cdd3,_0x1aeeae,_0x52353e)=>{const _0x18e6ec=_0x5b8232;let _0x53c8e2=_0x47cdd3[_0x18e6ec(0x1bb)];if(_0x47cdd3[_0x18e6ec(0x20a)]['endsWith']('ts')){let _0x23ace7=_0x47cdd3[_0x18e6ec(0x20a)][_0x18e6ec(0x1e3)](_0x47cdd3[_0x18e6ec(0x20a)][_0x18e6ec(0x1a1)]('/')+0x1),_0x18b8a1=_0x53c8e2[_0x18e6ec(0x1aa)],_0x3b5e18=path[_0x18e6ec(0x22a)](config[_0x18e6ec(0x225)],_0x18b8a1,_0x23ace7),_0x4db498=_0x47cdd3[_0x18e6ec(0x215)]['dbOther'][_0x18e6ec(0x20e)]('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')[_0x18e6ec(0x1ab)](_0x18b8a1);!_0x4db498&&(_0x53c8e2[_0x18e6ec(0x1e5)]=_0x53c8e2[_0x18e6ec(0x203)]*config['m3u8segmentDuration'],_0x47cdd3['app']['dbOther']['prepare'](_0x18e6ec(0x238))[_0x18e6ec(0x223)](_0x18b8a1,JSON['stringify'](_0x53c8e2),_0x47cdd3[_0x18e6ec(0x1d2)]['id']));if(!hasPermission(_0x47cdd3,_0x1aeeae,_0x53c8e2))return _0x1aeeae['json']({'code':0x66});return process[_0x18e6ec(0x209)]({'type':_0x18e6ec(0x228),'playId':_0x18b8a1,'args':_0x53c8e2,'action':_0x18e6ec(0x1c9)}),sendTsFile(_0x47cdd3,_0x1aeeae,_0x53c8e2,_0x3b5e18,_0x23ace7);}else{if(_0x47cdd3[_0x18e6ec(0x20a)][_0x18e6ec(0x1d5)](_0x18e6ec(0x1e7))){let _0x261de0=_0x53c8e2[_0x18e6ec(0x1aa)];if(!_0x261de0)return _0x47cdd3[_0x18e6ec(0x215)][_0x18e6ec(0x1ae)](_0x1aeeae,'need\x20play\x20id');if(!hasPermission(_0x47cdd3,_0x1aeeae,_0x53c8e2))return _0x1aeeae[_0x18e6ec(0x220)]({'code':0x66});transCodeUtil['parseVideoFullPath'](_0x47cdd3[_0x18e6ec(0x215)]['dbFileIndex'],_0x47cdd3['app'][_0x18e6ec(0x1be)],_0x53c8e2)[_0x18e6ec(0x1a5)](_0x38ec4d=>{const _0x2d0cb7=_0x18e6ec;let {fullpath:_0xa4767,duration:_0x40dd06}=_0x38ec4d;fs['access'](_0xa4767,fs[_0x2d0cb7(0x1b5)]['R_OK'],_0x58429b=>{const _0x2d41f9=_0x2d0cb7;if(_0x58429b)return _0x47cdd3['app'][_0x2d41f9(0x1ae)](_0x1aeeae,_0x1aeeae['__'](_0x2d41f9(0x231)));_0x47cdd3[_0x2d41f9(0x215)][_0x2d41f9(0x1be)][_0x2d41f9(0x20e)]('REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)')[_0x2d41f9(0x223)](_0x261de0,JSON[_0x2d41f9(0x1f1)](_0x53c8e2),_0x47cdd3[_0x2d41f9(0x1d2)]['id']),process['send']({'type':_0x2d41f9(0x228),'playId':_0x261de0,'args':_0x53c8e2,'action':_0x2d41f9(0x1c9)}),getM3U8(_0x53c8e2,_0x40dd06,_0x1aeeae);});})[_0x18e6ec(0x1b4)](_0x71e483=>{const _0x3da072=_0x18e6ec;console['log'](_0x3da072(0x21d),_0x71e483),_0x47cdd3[_0x3da072(0x215)][_0x3da072(0x1ae)](_0x1aeeae,_0x71e483);});}else{if(_0x47cdd3['path']['endsWith']('mp4')){if(!hasPermission(_0x47cdd3,_0x1aeeae,_0x53c8e2))return _0x1aeeae[_0x18e6ec(0x220)]({'code':0x66});transCodeUtil['parseVideoFullPath'](_0x47cdd3[_0x18e6ec(0x215)]['dbFileIndex'],_0x47cdd3[_0x18e6ec(0x215)][_0x18e6ec(0x1be)],_0x53c8e2)[_0x18e6ec(0x1a5)](_0x2c2363=>{const _0x2fdc52=_0x18e6ec;let {fullpath:_0x4a5f72,streamList:_0x315a49,needDecrypt:_0x5b568e,pwd:_0x2594ad}=_0x2c2363;fs['access'](_0x4a5f72,fs[_0x2fdc52(0x1b5)][_0x2fdc52(0x1d8)],_0xf916dd=>{const _0x206a34=_0x2fdc52;if(_0xf916dd)return _0x47cdd3[_0x206a34(0x215)]['returnErrMsg'](_0x1aeeae,_0x1aeeae['__'](_0x206a34(0x231)));MP4FfmpegTrans(_0x47cdd3,_0x1aeeae,_0x4a5f72,_0x315a49,_0x5b568e,_0x2594ad);});})[_0x18e6ec(0x1b4)](_0x117edd=>{const _0x2ab06b=_0x18e6ec;console[_0x2ab06b(0x1db)](_0x2ab06b(0x21d),_0x117edd),_0x47cdd3[_0x2ab06b(0x215)][_0x2ab06b(0x1ae)](_0x1aeeae,_0x117edd);});}}}}),router['post'](_0x5b8232(0x248),(_0x6094b,_0x37de9f,_0x5033d9)=>{const _0x2ee1fd=_0x5b8232;if(!_0x6094b['body']['filePath'])return _0x37de9f[_0x2ee1fd(0x204)](0x1f4);let _0x46c582=fileUtil[_0x2ee1fd(0x212)](_0x6094b[_0x2ee1fd(0x1b3)]['filePath']),_0x4a8f0d={'code':0x0,'streams':[],'duration':0x0},_0x8049c9=dbConfigTable['findByTitle'](_0x6094b[_0x2ee1fd(0x215)]['dbOther'],_0x2ee1fd(0x249));_0x4a8f0d['moviePreferLanguage']=_0x8049c9?_0x8049c9[_0x2ee1fd(0x1ad)]:'chi',_0x46c582=transCodeUtil[_0x2ee1fd(0x1d4)](_0x46c582),videoStreamUtil[_0x2ee1fd(0x1e6)](_0x46c582)[_0x2ee1fd(0x1a5)](_0x4a921c=>{const _0x35d4ae=_0x2ee1fd;_0x4a8f0d[_0x35d4ae(0x205)]=_0x4a921c[_0x35d4ae(0x205)],_0x4a8f0d[_0x35d4ae(0x214)]=videoStreamUtil[_0x35d4ae(0x1cb)](_0x4a921c),_0x37de9f[_0x35d4ae(0x220)](_0x4a8f0d);})[_0x2ee1fd(0x1b4)](_0x5401ac=>{return console['log'](_0x5401ac),_0x6094b['app']['returnErrMsg'](_0x37de9f,_0x5401ac);});});function getM3U8(_0x33e828,_0xdbe665,_0x38e5af){const _0x2e8d7b=_0x5b8232;let _0xa662c4=Math[_0x2e8d7b(0x235)](_0xdbe665/config['m3u8segmentDuration']),_0x51d7a4=_0xdbe665-_0xa662c4*_0xdbe665;if(_0x51d7a4>0x0){try{_0x51d7a4=parseInt(_0x51d7a4);}catch(_0x5c35b5){console[_0x2e8d7b(0x1db)](_0x5c35b5);}_0xa662c4+=0x1;}let _0x5c8aa5=_0x2e8d7b(0x221)+config[_0x2e8d7b(0x1a9)]+_0x2e8d7b(0x1ce)+_0x33e828['seek']+'\x0a';_0x33e828['seek']&&(segmentStartNum=parseInt(_0x33e828['seek']/config['m3u8segmentDuration']));for(let _0x33d0b8=0x0;_0x33d0b8<_0xa662c4;_0x33d0b8++){let _0x26fddd=_0x2e8d7b(0x218)+(_0x33d0b8==_0xa662c4-0x1&&_0x51d7a4>0x0?_0x51d7a4:config[_0x2e8d7b(0x1a9)])+_0x2e8d7b(0x1dd)+_0x33d0b8+_0x2e8d7b(0x219)+_0x33e828[_0x2e8d7b(0x1aa)]+_0x2e8d7b(0x242)+_0x33e828[_0x2e8d7b(0x1f0)]+_0x2e8d7b(0x1fc)+_0x33d0b8;_0x33e828[_0x2e8d7b(0x22d)]&&(_0x26fddd+=_0x2e8d7b(0x1eb)+_0x33e828[_0x2e8d7b(0x22d)]),_0x33e828[_0x2e8d7b(0x1fa)]&&(_0x26fddd+='&videobit='+_0x33e828[_0x2e8d7b(0x1fa)]),_0x33e828['subtitleIndex']&&(_0x26fddd+=_0x2e8d7b(0x1c1)+_0x33e828[_0x2e8d7b(0x1b9)]),_0x33e828[_0x2e8d7b(0x22e)]&&(_0x26fddd+=_0x2e8d7b(0x1c2)+_0x33e828[_0x2e8d7b(0x22e)]),_0x33e828[_0x2e8d7b(0x1c3)]&&(_0x26fddd+='&audioIndex='+_0x33e828[_0x2e8d7b(0x1c3)]),_0x33e828['indexId']&&(_0x26fddd+=_0x2e8d7b(0x217)+_0x33e828[_0x2e8d7b(0x1af)]),_0x33e828['ac']&&(_0x26fddd+=_0x2e8d7b(0x1d7)+_0x33e828['ac']),_0x33e828[_0x2e8d7b(0x23d)]&&(_0x26fddd+=_0x2e8d7b(0x1c4)+_0x33e828[_0x2e8d7b(0x23d)]),_0x33e828['spaceId']&&(_0x26fddd+=_0x2e8d7b(0x237)+_0x33e828[_0x2e8d7b(0x1ee)]),_0x33e828[_0x2e8d7b(0x21e)]&&(_0x26fddd+=_0x2e8d7b(0x200)+_0x33e828['spaceToken']),_0x33e828[_0x2e8d7b(0x23b)]&&(_0x26fddd+=_0x2e8d7b(0x1fd)+_0x33e828['spaceIndexId']),_0x33e828[_0x2e8d7b(0x1cd)]&&(_0x26fddd+='&burn='+_0x33e828[_0x2e8d7b(0x1cd)]),_0x5c8aa5+=_0x26fddd;}_0x5c8aa5+=_0x2e8d7b(0x1f5),_0x38e5af[_0x2e8d7b(0x1cf)](_0x2e8d7b(0x206),_0x2e8d7b(0x211));let _0x52a565=new Date()['getTime']()+_0x2e8d7b(0x1dc);_0x38e5af[_0x2e8d7b(0x1cf)](_0x2e8d7b(0x1ea),'attachment;\x20filename='+_0x52a565),_0x38e5af[_0x2e8d7b(0x209)](_0x5c8aa5);}module[_0x5b8232(0x1d1)]=router;