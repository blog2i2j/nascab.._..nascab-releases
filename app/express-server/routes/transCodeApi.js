const _0x29c457=_0xed9f;(function(_0x5d1574,_0x150553){const _0x517c25=_0xed9f,_0x3ef9a8=_0x5d1574();while(!![]){try{const _0x2191cc=parseInt(_0x517c25(0x113))/0x1*(parseInt(_0x517c25(0x111))/0x2)+-parseInt(_0x517c25(0x19d))/0x3*(parseInt(_0x517c25(0x155))/0x4)+-parseInt(_0x517c25(0x16c))/0x5+parseInt(_0x517c25(0x121))/0x6+-parseInt(_0x517c25(0x18c))/0x7*(parseInt(_0x517c25(0x139))/0x8)+parseInt(_0x517c25(0x1a6))/0x9+parseInt(_0x517c25(0x159))/0xa;if(_0x2191cc===_0x150553)break;else _0x3ef9a8['push'](_0x3ef9a8['shift']());}catch(_0x5b4e6f){_0x3ef9a8['push'](_0x3ef9a8['shift']());}}}(_0x41cb,0xaeb31));let express=require(_0x29c457(0x14d)),router=express[_0x29c457(0x1ab)](),path=require(_0x29c457(0x130)),fs=require('fs'),transCodeUtil=require(_0x29c457(0x189)),fileUtil=require(_0x29c457(0x1a0));const config=require(_0x29c457(0x161));let videoStreamUtil=require(_0x29c457(0x11a)),FFmpeg=require(_0x29c457(0x184))['FFmpeg'],cryptoUtils=require(_0x29c457(0x140)),sha256=require('sha256');require(_0x29c457(0x192))[_0x29c457(0x156)][_0x29c457(0x17b)]=0x0;const dbUserTable=require(_0x29c457(0x1af)),dbFileIndexTable=require(_0x29c457(0x16a)),dbConfigTable=require(_0x29c457(0x127));var jschardet=require(_0x29c457(0x179));function MP4FfmpegTrans(_0x5bd99c,_0x93a089,_0x264650,_0x54d42a,_0x2a8bf7,_0x2901b2){const _0x405c0b=_0x29c457;let _0x45f3cd=_0x5bd99c[_0x405c0b(0x12c)],_0x99f572=FFmpeg(),_0x3c05dd;if(_0x2a8bf7)_0x3c05dd=cryptoUtils[_0x405c0b(0x1b7)](_0x2901b2,_0x264650);let _0x55ccc8=_0x2a8bf7?_0x3c05dd:_0x264650,{videoStream:_0x3879a0,videoWidth:_0x1b0cba,videoHeight:_0x44905d}=transCodeUtil[_0x405c0b(0x143)](_0x54d42a);_0x99f572[_0x405c0b(0x178)](transCodeUtil[_0x405c0b(0x10f)](_0x55ccc8));try{_0x99f572['on'](_0x405c0b(0x114),function(_0x59383d){const _0x124057=_0x405c0b;console[_0x124057(0x122)](_0x59383d);}),_0x99f572['on'](_0x405c0b(0x138),function(_0x2d4eb4){const _0x1154ed=_0x405c0b;if(_0x2d4eb4['message']&&_0x2d4eb4[_0x1154ed(0x124)][_0x1154ed(0x1b3)](_0x1154ed(0x123))==-0x1)_0x99f572[_0x1154ed(0x14b)](),_0x99f572=null,_0x93a089[_0x1154ed(0x194)](0x1f4)[_0x1154ed(0x150)]();else{}}),_0x99f572['on']('end',function(_0xbdc1fd){const _0x435d96=_0x405c0b;_0x99f572&&(_0x99f572['kill'](),_0x99f572=null);if(_0x93a089)_0x93a089['status'](0xc8)[_0x435d96(0x150)]();}),_0x93a089['on'](_0x405c0b(0x12b),function(){});let _0x4b596f=transCodeUtil['getCoderConfig'](_0x5bd99c[_0x405c0b(0x1ae)]['dbOther'],_0x3879a0);_0x4b596f[_0x405c0b(0x14f)]&&_0x99f572[_0x405c0b(0x14c)](_0x4b596f[_0x405c0b(0x14f)]);let _0x512584=_0x45f3cd['seq']*config[_0x405c0b(0x187)];_0x512584&&!_0x2a8bf7&&_0x99f572[_0x405c0b(0x193)](''+parseInt(_0x512584));_0x4b596f['encoderName']&&_0x99f572['videoCodec'](_0x4b596f[_0x405c0b(0x173)]);let _0x19ffbc=transCodeUtil[_0x405c0b(0x171)](_0x3879a0,_0x45f3cd[_0x405c0b(0x11e)]);!_0x19ffbc&&(_0x19ffbc=0x1800),_0x99f572[_0x405c0b(0x175)](''+_0x19ffbc),_0x99f572[_0x405c0b(0x118)]('-map\x200:v:0?'),_0x99f572['addOption']('-map\x200:a:'+(_0x45f3cd[_0x405c0b(0x11c)]?_0x45f3cd[_0x405c0b(0x11c)]:0x0)+'?'),_0x99f572[_0x405c0b(0x169)](_0x405c0b(0x1a4)),_0x99f572[_0x405c0b(0x1b1)](_0x405c0b(0x148)),_0x99f572[_0x405c0b(0x1b5)]([_0x405c0b(0x19c)]),_0x99f572['outputFormat']('mp4'),_0x99f572['pipe'](_0x93a089,{'end':!![]});}catch(_0x4c8489){console[_0x405c0b(0x122)](_0x4c8489),_0x99f572[_0x405c0b(0x14b)](),_0x93a089[_0x405c0b(0x190)](0x1f4);}}function _0x41cb(){const _0x40629a=['&subtitleIndex=','m3u8segmentDuration','substring','../../utils/transCodeUtil','subtitleFile','spaceId','1435924btpiVX','index\x20does\x20not\x20exist','spaceIndexId','extname','sendStatus','webvtt','events','seekInput','status','noVideo','&spaceId=','&filePath=','getVideoMeta','detect','filename','spaceToken','-movflags\x20frag_keyframe+empty_moov','21621iFImfj','body','currentUser','../utils/fileUtils','UTF-','Content-disposition','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','mp4','stat','8929017EVkmSb','all','serverType','seek','Content-type','Router','power_get','endsWith','app','../../db/dbUserTable','then','audioCodec','streams','indexOf','-sub_charenc\x20','outputOptions','decodePath','decryptFileGetStream','dealFFmpegPath','json','2XzjbjY','size','1188667pltkaQ','start','-map\x200:s:','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?','&size=','addOption','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','../../utils/videoStreamUtil','.vtt','audioIndex','duration','videobit','constants','m3u8','5321490sRNuew','log','killed','message','join','filePath','../../db/dbConfigTable','waiting','returnErrMsg','sendFile','close','query','pipe','catch','m3u8TmpPath','path','faidLoadSubtitle','playId','M3u8Transcode','setHeader','length','chi','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','error','40pDuWKf','confidence','index\x20no\x20permission','&videobit=','R_OK','stringify','getTime','../utils/cryptoUtils','exports','noAudio','parseStreamList','noContent','.m3u8','output','dbOther','aac','parseVideoFullPath','indexId','kill','addInputOption','express','run','decoderCommand','end','moviePreferLanguage','生成字幕文件','&spaceIndexId=','burn','504xoQagA','EventEmitter','prepare',',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET=','3920890skAxoz','need\x20play\x20id','attachment;\x20filename=','doUserCanGet','access','get','cannotReadFile','\x0a#EXTINF:','../../myConfig/config','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','&spaceToken=','getDurationFromStream','dbFileIndex','\x0a#EXT-X-ENDLIST\x0a','.ts?playId=','inputOption','outputFormat','../../db/dbFileIndexTable','subtitleIndex','4052365SEudqH','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','send','gen','&audioIndex=','getVideoBitrate','format','encoderName','ts_name','videoBitrate','replace','post','input','jschardet','&burn=','defaultMaxListeners','&indexId=','getById','findByTitle','/subtitle*','/play*','getIndexTableNameByType','seq','stop','../../libs/nasTrans','value'];_0x41cb=function(){return _0x40629a;};return _0x41cb();}router[_0x29c457(0x1a7)]('/stopPlay',(_0x24601e,_0x5f303b,_0x35dc79)=>{const _0x401fe2=_0x29c457;let _0x414228=_0x24601e[_0x401fe2(0x12c)]['playId']||_0x24601e[_0x401fe2(0x19e)]['playId'];process[_0x401fe2(0x16e)]({'type':_0x401fe2(0x133),'playId':_0x414228,'action':_0x401fe2(0x183)});let _0x23d2b4=path[_0x401fe2(0x125)](config[_0x401fe2(0x12f)],_0x414228);return fs['rm'](_0x23d2b4,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x1d88b2=>{const _0x514758=_0x401fe2;if(_0x1d88b2)console[_0x514758(0x122)](_0x1d88b2);}),_0x24601e[_0x401fe2(0x1ae)][_0x401fe2(0x147)]['prepare'](_0x401fe2(0x119))[_0x401fe2(0x14e)](_0x24601e[_0x401fe2(0x12c)][_0x401fe2(0x132)]),_0x5f303b[_0x401fe2(0x110)]({'code':0x0});}),router[_0x29c457(0x15e)](_0x29c457(0x17f),(_0x526401,_0x51decd,_0x39f3b0)=>{const _0x3a3f13=_0x29c457;let _0x1debf6=_0x526401[_0x3a3f13(0x12c)],_0x94f936=_0x1debf6[_0x3a3f13(0x16b)],_0x112148=_0x1debf6[_0x3a3f13(0x18a)];if(_0x112148&&_0x112148[_0x3a3f13(0x135)]>0x2){let _0x111cd6=fileUtil[_0x3a3f13(0x1b6)](_0x112148);fs[_0x3a3f13(0x15d)](_0x111cd6,fs[_0x3a3f13(0x11f)]['R_OK'],_0x5241e8=>{const _0x437ef8=_0x3a3f13;if(_0x5241e8)return _0x526401[_0x437ef8(0x1ae)][_0x437ef8(0x129)](_0x51decd,_0x51decd['__'](_0x437ef8(0x15f)));path[_0x437ef8(0x18f)](_0x111cd6)==_0x437ef8(0x11b)&&_0x51decd['sendFile'](_0x111cd6),fs['readFile'](_0x111cd6,(_0xc2dc89,_0x141ef2)=>{const _0x1ef546=_0x437ef8;if(_0xc2dc89)return _0x526401['app'][_0x1ef546(0x129)](_0x51decd,_0x51decd['__']('cannotReadFile'));try{let _0x46980e=jschardet[_0x1ef546(0x199)](_0x141ef2);!_0x46980e['encoding']['startsWith'](_0x1ef546(0x1a1))&&_0x46980e[_0x1ef546(0x13a)]>0.95?_0x3ec1b3(_0x46980e['encoding']):_0x3ec1b3();}catch(_0x3797f3){console[_0x1ef546(0x122)](_0x3797f3),_0x3ec1b3();}function _0x3ec1b3(_0x132667){const _0x1c5b09=_0x1ef546;let _0x508edd=FFmpeg();_0x508edd['input'](transCodeUtil[_0x1c5b09(0x10f)](_0x111cd6))[_0x1c5b09(0x142)]()[_0x1c5b09(0x195)]()[_0x1c5b09(0x172)](_0x1c5b09(0x191)),_0x132667&&_0x508edd[_0x1c5b09(0x168)](_0x1c5b09(0x1b4)+_0x132667),_0x508edd['on'](_0x1c5b09(0x114),function(_0x4613ab){const _0x1d2e2a=_0x1c5b09;console[_0x1d2e2a(0x122)](_0x4613ab);})['on'](_0x1c5b09(0x138),function(_0x19c062){const _0x4e9df2=_0x1c5b09;_0x508edd[_0x4e9df2(0x14b)]();})['on']('end',function(){const _0xfb0bb0=_0x1c5b09;_0x508edd[_0xfb0bb0(0x14b)]();})[_0x1c5b09(0x12d)](_0x51decd);}});});}else{let _0x19638a=_0x1debf6['stype'];transCodeUtil[_0x3a3f13(0x149)](_0x526401[_0x3a3f13(0x1ae)]['dbFileIndex'],_0x526401['app'][_0x3a3f13(0x147)],_0x1debf6)['then'](_0x430faf=>{const _0x3a559d=_0x3a3f13;let {fullpath:_0x3d912e,needDecrypt:_0x5df881,pwd:_0x653c0b,streamList:_0x688a63}=_0x430faf;fs['access'](_0x3d912e,fs['constants'][_0x3a559d(0x13d)],_0x4fdfc3=>{const _0x3b234f=_0x3a559d;if(_0x4fdfc3)return _0x526401['app']['returnErrMsg'](_0x51decd,_0x51decd['__'](_0x3b234f(0x15f)));if(!_0x19638a)_0x19638a='vtt';let _0x4fa0ed=path[_0x3b234f(0x125)](config['subtitlePath'],sha256(_0x3d912e+_0x94f936)+'.'+_0x19638a);fs[_0x3b234f(0x1a5)](_0x4fa0ed,(_0x1d5378,_0xa21bed)=>{const _0xc49261=_0x3b234f;if(_0x1d5378||_0xa21bed['size']<0x3e8){console[_0xc49261(0x122)](_0xc49261(0x152),_0x4fa0ed);let _0x317f3e=_0x5df881?cryptoUtils['decryptFileGetStream'](_0x653c0b,_0x3d912e):_0x3d912e,_0x38c0ce=FFmpeg({'timeout':0x258});_0x38c0ce[_0xc49261(0x178)](transCodeUtil[_0xc49261(0x10f)](_0x317f3e))[_0xc49261(0x142)]()[_0xc49261(0x195)]()[_0xc49261(0x1b5)]([_0xc49261(0x115)+_0x94f936])[_0xc49261(0x146)](_0x4fa0ed)['on'](_0xc49261(0x114),function(_0x3c2255){const _0x4b8169=_0xc49261;console[_0x4b8169(0x122)](_0x3c2255);})['on'](_0xc49261(0x138),function(_0x28103b){const _0x5e404b=_0xc49261;console[_0x5e404b(0x122)](_0x28103b),_0x38c0ce['kill'](),fs['rm'](_0x4fa0ed,_0x466747=>{}),_0x526401[_0x5e404b(0x1ae)][_0x5e404b(0x129)](_0x51decd,_0x51decd['__'](_0x5e404b(0x131)));})['on'](_0xc49261(0x150),function(){const _0x3b85b0=_0xc49261;return _0x38c0ce[_0x3b85b0(0x14b)](),_0x1debf6[_0x3b85b0(0x144)]?_0x51decd[_0x3b85b0(0x110)]({'code':0x0}):_0x51decd[_0x3b85b0(0x12a)](_0x4fa0ed);}),_0x38c0ce[_0xc49261(0x14e)](),_0x51decd['on'](_0xc49261(0x12b),function(){const _0x548255=_0xc49261;_0x38c0ce[_0x548255(0x14b)]();});}else{console[_0xc49261(0x122)]('字幕文件存在缓存',_0x4fa0ed);if(_0x1debf6[_0xc49261(0x144)])return _0x51decd[_0xc49261(0x110)]({'code':0x0});return _0x51decd['sendFile'](_0x4fa0ed);}});});})[_0x3a3f13(0x12e)](_0x1debd7=>{const _0x5d42fe=_0x3a3f13;console['log'](_0x1debd7),_0x526401[_0x5d42fe(0x1ae)]['returnErrMsg'](_0x51decd,_0x1debd7);});}});function sendTsFile(_0x1f9a12,_0x5c63a8,_0x513967,_0x51083d,_0x333180,_0x44d59e=0x1){const _0x43b80d=_0x29c457;if(_0x44d59e>0x28)return;let _0x105d70=_0x513967[_0x43b80d(0x132)];if(!_0x105d70)return;let _0x595c4e=_0x1f9a12[_0x43b80d(0x1ae)][_0x43b80d(0x147)]['prepare']('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC')[_0x43b80d(0x15e)](_0x105d70,_0x333180,_0x43b80d(0x16f));if(_0x595c4e)fs[_0x43b80d(0x1a5)](_0x51083d,(_0x329e8e,_0x152ad7)=>{const _0x3dface=_0x43b80d;_0x329e8e?(_0x1f9a12[_0x3dface(0x1ae)][_0x3dface(0x147)]['prepare'](_0x3dface(0x116))[_0x3dface(0x14e)](_0x105d70,_0x333180),sendTsFile(_0x1f9a12,_0x5c63a8,_0x513967,_0x51083d,_0x333180,_0x44d59e+0x1)):(_0x1f9a12[_0x3dface(0x1ae)][_0x3dface(0x147)][_0x3dface(0x157)](_0x3dface(0x16d))[_0x3dface(0x14e)](_0x105d70),_0x5c63a8[_0x3dface(0x12a)](_0x51083d));});else{function _0xe617cf(){const _0x3e6c41=_0x43b80d;let _0x1a8ba8=setTimeout(()=>{clearTimeout(_0x1a8ba8),sendTsFile(_0x1f9a12,_0x5c63a8,_0x513967,_0x51083d,_0x333180,_0x44d59e+0x1);},0x1f4);_0x5c63a8['on'](_0x3e6c41(0x12b),()=>clearTimeout(_0x1a8ba8));}let _0x41dad9=_0x1f9a12[_0x43b80d(0x1ae)]['dbOther'][_0x43b80d(0x157)]('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC')[_0x43b80d(0x15e)](_0x105d70,'gen');if(!_0x41dad9)return _0xe617cf();else{let _0xdd87f5=_0x1f9a12[_0x43b80d(0x1ae)][_0x43b80d(0x147)][_0x43b80d(0x157)]('SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?')[_0x43b80d(0x15e)](_0x105d70,_0x333180,'waiting');if(_0xdd87f5)return _0xe617cf();else{let _0x257399=parseInt(_0x41dad9[_0x43b80d(0x174)][_0x43b80d(0x176)]('stream','')[_0x43b80d(0x176)]('.ts',''));return _0x513967['seq']>_0x257399+0xf||_0x513967[_0x43b80d(0x182)]<_0x257399?(process['send']({'type':'M3u8Transcode','playId':_0x105d70,'action':_0x43b80d(0x183)}),process['send']({'type':_0x43b80d(0x133),'playId':_0x105d70,'args':_0x513967,'action':_0x43b80d(0x114)}),_0x1f9a12[_0x43b80d(0x1ae)]['dbOther'][_0x43b80d(0x157)](_0x43b80d(0x137))['run'](_0x105d70,_0x333180,_0x43b80d(0x128)),_0xe617cf()):_0xe617cf();}}}}function _0xed9f(_0x57ee34,_0x274ed9){const _0x41cb69=_0x41cb();return _0xed9f=function(_0xed9f5c,_0xd9b366){_0xed9f5c=_0xed9f5c-0x10f;let _0x17cadb=_0x41cb69[_0xed9f5c];return _0x17cadb;},_0xed9f(_0x57ee34,_0x274ed9);}function hasPermission(_0x99e81f,_0x2f78f1,_0x4480c7){const _0x113a9b=_0x29c457;if(_0x4480c7[_0x113a9b(0x14a)]&&!_0x4480c7['spaceId']){let _0x501dde=dbFileIndexTable[_0x113a9b(0x181)](_0x4480c7['serverType']),_0x5cc83a=dbFileIndexTable[_0x113a9b(0x17d)](_0x99e81f[_0x113a9b(0x1ae)]['dbFileIndex'],_0x4480c7['indexId'],_0x501dde);if(!_0x5cc83a)return reject(_0x113a9b(0x18d));let _0x705fa0=_0x5cc83a[_0x113a9b(0x130)]+path['sep']+_0x5cc83a[_0x113a9b(0x19a)];if(dbUserTable[_0x113a9b(0x15c)](_0x99e81f,_0x2f78f1,_0x4480c7[_0x113a9b(0x1a8)],'power_get',_0x705fa0,!![])!==!![])return console['log'](_0x113a9b(0x13b)),![];return!![];}else{if(_0x4480c7[_0x113a9b(0x126)]&&!_0x4480c7['spaceId']){let _0x2a5dae=fileUtil[_0x113a9b(0x1b6)](_0x4480c7[_0x113a9b(0x126)]);if(dbUserTable[_0x113a9b(0x15c)](_0x99e81f,_0x2f78f1,'',_0x113a9b(0x1ac),_0x2a5dae,!![])!==!![])return console[_0x113a9b(0x122)](_0x113a9b(0x13b)),![];return!![];}else return!![];}}router[_0x29c457(0x15e)](_0x29c457(0x180),(_0x55f455,_0x3262b9,_0x4c047e)=>{const _0x37b797=_0x29c457;let _0x5f3aef=_0x55f455[_0x37b797(0x12c)];if(_0x55f455[_0x37b797(0x130)][_0x37b797(0x1ad)]('ts')){let _0x1d8ded=_0x55f455[_0x37b797(0x130)][_0x37b797(0x188)](_0x55f455[_0x37b797(0x130)]['lastIndexOf']('/')+0x1),_0x221c77=_0x5f3aef[_0x37b797(0x132)],_0x68a0b7=path[_0x37b797(0x125)](config[_0x37b797(0x12f)],_0x221c77,_0x1d8ded),_0x47fe65=_0x55f455[_0x37b797(0x1ae)]['dbOther']['prepare']('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')['get'](_0x221c77);!_0x47fe65&&(_0x5f3aef['seek']=_0x5f3aef['seq']*config[_0x37b797(0x187)],_0x55f455['app'][_0x37b797(0x147)]['prepare']('REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)')[_0x37b797(0x14e)](_0x221c77,JSON[_0x37b797(0x13e)](_0x5f3aef),_0x55f455[_0x37b797(0x19f)]['id']));if(!hasPermission(_0x55f455,_0x3262b9,_0x5f3aef))return _0x3262b9[_0x37b797(0x110)]({'code':0x66});return process['send']({'type':'M3u8Transcode','playId':_0x221c77,'args':_0x5f3aef,'action':'start'}),sendTsFile(_0x55f455,_0x3262b9,_0x5f3aef,_0x68a0b7,_0x1d8ded);}else{if(_0x55f455[_0x37b797(0x130)][_0x37b797(0x1ad)](_0x37b797(0x120))){let _0x1b5dcf=_0x5f3aef[_0x37b797(0x132)];if(!_0x1b5dcf)return _0x55f455[_0x37b797(0x1ae)][_0x37b797(0x129)](_0x3262b9,_0x37b797(0x15a));if(!hasPermission(_0x55f455,_0x3262b9,_0x5f3aef))return _0x3262b9[_0x37b797(0x110)]({'code':0x66});transCodeUtil[_0x37b797(0x149)](_0x55f455[_0x37b797(0x1ae)][_0x37b797(0x165)],_0x55f455[_0x37b797(0x1ae)][_0x37b797(0x147)],_0x5f3aef)['then'](_0x25b7be=>{const _0x3ff7cf=_0x37b797;let {fullpath:_0x3c4a68,duration:_0x2b3e43}=_0x25b7be;fs[_0x3ff7cf(0x15d)](_0x3c4a68,fs[_0x3ff7cf(0x11f)][_0x3ff7cf(0x13d)],_0x2fea86=>{const _0x37241f=_0x3ff7cf;if(_0x2fea86)return _0x55f455[_0x37241f(0x1ae)][_0x37241f(0x129)](_0x3262b9,_0x3262b9['__']('cannotReadFile'));_0x55f455[_0x37241f(0x1ae)]['dbOther'][_0x37241f(0x157)](_0x37241f(0x162))['run'](_0x1b5dcf,JSON['stringify'](_0x5f3aef),_0x55f455[_0x37241f(0x19f)]['id']),process[_0x37241f(0x16e)]({'type':'M3u8Transcode','playId':_0x1b5dcf,'args':_0x5f3aef,'action':_0x37241f(0x114)}),getM3U8(_0x5f3aef,_0x2b3e43,_0x3262b9);});})[_0x37b797(0x12e)](_0x13e8cf=>{const _0x2f2c4f=_0x37b797;console[_0x2f2c4f(0x122)](_0x2f2c4f(0x138),_0x13e8cf),_0x55f455['app'][_0x2f2c4f(0x129)](_0x3262b9,_0x13e8cf);});}else{if(_0x55f455[_0x37b797(0x130)][_0x37b797(0x1ad)](_0x37b797(0x1a4))){if(!hasPermission(_0x55f455,_0x3262b9,_0x5f3aef))return _0x3262b9[_0x37b797(0x110)]({'code':0x66});transCodeUtil[_0x37b797(0x149)](_0x55f455[_0x37b797(0x1ae)][_0x37b797(0x165)],_0x55f455[_0x37b797(0x1ae)][_0x37b797(0x147)],_0x5f3aef)[_0x37b797(0x1b0)](_0x5aac01=>{const _0x6a838=_0x37b797;let {fullpath:_0x900a,streamList:_0x39d3b7,needDecrypt:_0x338e8d,pwd:_0x3d2297}=_0x5aac01;fs[_0x6a838(0x15d)](_0x900a,fs[_0x6a838(0x11f)]['R_OK'],_0x102790=>{if(_0x102790)return _0x55f455['app']['returnErrMsg'](_0x3262b9,_0x3262b9['__']('cannotReadFile'));MP4FfmpegTrans(_0x55f455,_0x3262b9,_0x900a,_0x39d3b7,_0x338e8d,_0x3d2297);});})[_0x37b797(0x12e)](_0x1177c1=>{const _0x13eda9=_0x37b797;console[_0x13eda9(0x122)](_0x13eda9(0x138),_0x1177c1),_0x55f455['app'][_0x13eda9(0x129)](_0x3262b9,_0x1177c1);});}}}}),router[_0x29c457(0x177)]('/getVideoInfoByPath',(_0x288aa6,_0x34773b,_0x673f24)=>{const _0x5881cb=_0x29c457;if(!_0x288aa6['body'][_0x5881cb(0x126)])return _0x34773b[_0x5881cb(0x190)](0x1f4);let _0x22660b=fileUtil[_0x5881cb(0x1b6)](_0x288aa6[_0x5881cb(0x19e)][_0x5881cb(0x126)]),_0x9cde2d={'code':0x0,'streams':[],'duration':0x0},_0x4d3ef8=dbConfigTable[_0x5881cb(0x17e)](_0x288aa6[_0x5881cb(0x1ae)]['dbOther'],_0x5881cb(0x151));_0x9cde2d[_0x5881cb(0x151)]=_0x4d3ef8?_0x4d3ef8[_0x5881cb(0x185)]:_0x5881cb(0x136),_0x22660b=transCodeUtil[_0x5881cb(0x10f)](_0x22660b),videoStreamUtil[_0x5881cb(0x198)](_0x22660b)['then'](_0x47beec=>{const _0x1d6f54=_0x5881cb;_0x9cde2d[_0x1d6f54(0x1b2)]=_0x47beec[_0x1d6f54(0x1b2)],_0x9cde2d[_0x1d6f54(0x11d)]=videoStreamUtil[_0x1d6f54(0x164)](_0x47beec),_0x34773b[_0x1d6f54(0x110)](_0x9cde2d);})['catch'](_0xecca1f=>{const _0x1469ef=_0x5881cb;return console[_0x1469ef(0x122)](_0xecca1f),_0x288aa6['app'][_0x1469ef(0x129)](_0x34773b,_0xecca1f);});});function getM3U8(_0x10b14e,_0x3d12a4,_0xd49c3){const _0x4bdcb4=_0x29c457;let _0x4c5af5=Math['floor'](_0x3d12a4/config[_0x4bdcb4(0x187)]),_0x4d663c=_0x3d12a4-_0x4c5af5*_0x3d12a4;if(_0x4d663c>0x0){try{_0x4d663c=parseInt(_0x4d663c);}catch(_0x2ae4be){console[_0x4bdcb4(0x122)](_0x2ae4be);}_0x4c5af5+=0x1;}let _0x2bed4a=_0x4bdcb4(0x1a3)+config[_0x4bdcb4(0x187)]+_0x4bdcb4(0x158)+_0x10b14e[_0x4bdcb4(0x1a9)]+'\x0a';_0x10b14e[_0x4bdcb4(0x1a9)]&&(segmentStartNum=parseInt(_0x10b14e[_0x4bdcb4(0x1a9)]/config[_0x4bdcb4(0x187)]));for(let _0x3c2a54=0x0;_0x3c2a54<_0x4c5af5;_0x3c2a54++){let _0x28b43e=_0x4bdcb4(0x160)+(_0x3c2a54==_0x4c5af5-0x1&&_0x4d663c>0x0?_0x4d663c:config[_0x4bdcb4(0x187)])+'.0,\x0astream'+_0x3c2a54+_0x4bdcb4(0x167)+_0x10b14e[_0x4bdcb4(0x132)]+'&token='+_0x10b14e['token']+'&seq='+_0x3c2a54;_0x10b14e['size']&&(_0x28b43e+=_0x4bdcb4(0x117)+_0x10b14e[_0x4bdcb4(0x112)]),_0x10b14e[_0x4bdcb4(0x11e)]&&(_0x28b43e+=_0x4bdcb4(0x13c)+_0x10b14e[_0x4bdcb4(0x11e)]),_0x10b14e[_0x4bdcb4(0x16b)]&&(_0x28b43e+=_0x4bdcb4(0x186)+_0x10b14e[_0x4bdcb4(0x16b)]),_0x10b14e[_0x4bdcb4(0x1a8)]&&(_0x28b43e+='&serverType='+_0x10b14e['serverType']),_0x10b14e[_0x4bdcb4(0x11c)]&&(_0x28b43e+=_0x4bdcb4(0x170)+_0x10b14e[_0x4bdcb4(0x11c)]),_0x10b14e[_0x4bdcb4(0x14a)]&&(_0x28b43e+=_0x4bdcb4(0x17c)+_0x10b14e[_0x4bdcb4(0x14a)]),_0x10b14e['ac']&&(_0x28b43e+='&ac='+_0x10b14e['ac']),_0x10b14e[_0x4bdcb4(0x126)]&&(_0x28b43e+=_0x4bdcb4(0x197)+_0x10b14e[_0x4bdcb4(0x126)]),_0x10b14e[_0x4bdcb4(0x18b)]&&(_0x28b43e+=_0x4bdcb4(0x196)+_0x10b14e[_0x4bdcb4(0x18b)]),_0x10b14e[_0x4bdcb4(0x19b)]&&(_0x28b43e+=_0x4bdcb4(0x163)+_0x10b14e[_0x4bdcb4(0x19b)]),_0x10b14e[_0x4bdcb4(0x18e)]&&(_0x28b43e+=_0x4bdcb4(0x153)+_0x10b14e['spaceIndexId']),_0x10b14e['burn']&&(_0x28b43e+=_0x4bdcb4(0x17a)+_0x10b14e[_0x4bdcb4(0x154)]),_0x2bed4a+=_0x28b43e;}_0x2bed4a+=_0x4bdcb4(0x166),_0xd49c3['setHeader'](_0x4bdcb4(0x1aa),'application/octet-stream');let _0x3f335f=new Date()[_0x4bdcb4(0x13f)]()+_0x4bdcb4(0x145);_0xd49c3[_0x4bdcb4(0x134)](_0x4bdcb4(0x1a2),_0x4bdcb4(0x15b)+_0x3f335f),_0xd49c3[_0x4bdcb4(0x16e)](_0x2bed4a);}module[_0x29c457(0x141)]=router;