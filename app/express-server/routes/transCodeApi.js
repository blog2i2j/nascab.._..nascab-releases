const _0x3f1da6=_0x4b64;function _0x4b64(_0x2cf8d4,_0x44c590){const _0x481c38=_0x481c();return _0x4b64=function(_0x4b6413,_0x188527){_0x4b6413=_0x4b6413-0xd7;let _0x3d8ce3=_0x481c38[_0x4b6413];return _0x3d8ce3;},_0x4b64(_0x2cf8d4,_0x44c590);}(function(_0x2787be,_0x27b16c){const _0x2e5f01=_0x4b64,_0xebfa70=_0x2787be();while(!![]){try{const _0x3e3f60=parseInt(_0x2e5f01(0xe2))/0x1*(-parseInt(_0x2e5f01(0x11c))/0x2)+-parseInt(_0x2e5f01(0x15a))/0x3+-parseInt(_0x2e5f01(0x175))/0x4+-parseInt(_0x2e5f01(0x169))/0x5+-parseInt(_0x2e5f01(0x11e))/0x6+parseInt(_0x2e5f01(0xf8))/0x7*(parseInt(_0x2e5f01(0xf0))/0x8)+parseInt(_0x2e5f01(0x167))/0x9*(parseInt(_0x2e5f01(0x14d))/0xa);if(_0x3e3f60===_0x27b16c)break;else _0xebfa70['push'](_0xebfa70['shift']());}catch(_0x4c25c5){_0xebfa70['push'](_0xebfa70['shift']());}}}(_0x481c,0x65d56));let express=require('express'),router=express['Router'](),path=require(_0x3f1da6(0x161)),fs=require('fs'),transCodeUtil=require(_0x3f1da6(0x12c)),fileUtil=require(_0x3f1da6(0x106));const config=require(_0x3f1da6(0x178));function _0x481c(){const _0x2cfaf6=['&serverType=','chi','detect','spaceIndexId','sendStatus','run','8746NSnwxB','start','2722452OgrkFh','log','constants','indexOf','stop','&token=','FFmpeg','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','events','cannotReadFile','noContent','get','catch','audioIndex','../../utils/transCodeUtil','post','getCoderConfig','audioCodec','&seq=','aac','encoding','join','getTime','readFile','&subtitleIndex=','&indexId=','then','filePath','indexId','body','decoderCommand','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?','&audioIndex=','floor','moviePreferLanguage','getVideoBitrate','ts_name','videoBitrate','Content-disposition','webvtt','pipe','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','-map\x200:v:0?','duration','doUserCanGet','need\x20play\x20id','findByTitle','22644890SdsoeQ','-movflags\x20frag_keyframe+empty_moov','.ts','&spaceId=','EventEmitter','json','/getVideoInfoByPath','sendFile','burn','videobit','index\x20no\x20permission','addInputOption','length','2225910RyJfKN','error','endsWith','dbFileIndex','spaceId','stream','生成字幕文件','path','returnErrMsg','-map\x200:s:','#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:','../../db/dbConfigTable','output','9OkJLJe','R_OK','47020TxMilK','&size=','.m3u8','serverType','message','&ac=','SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?','access','vtt','close','sep','&burn=','550968yYtPLD','noVideo','send','../../myConfig/config','/stopPlay','query','getDurationFromStream','encoderName','power_get','m3u8segmentDuration','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','app','lastIndexOf','m3u8TmpPath','sha256','streams','token','\x0a#EXTINF:','outputOptions','.0,\x0astream','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?','format','167XTRPBG','字幕文件存在缓存','getVideoMeta','M3u8Transcode','playId','.ts?playId=','status','stat','parseVideoFullPath','setHeader','&videobit=','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27','end','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','3376NLFnUc','startsWith','../../db/dbFileIndexTable','substring','../../libs/nasTrans','dealFFmpegPath','prepare','kill','3745hntTvS','subtitleIndex','gen','all','waiting','seek','size','getById','noAudio','dbOther','decodePath','spaceToken','&filePath=','subtitlePath','../utils/fileUtils','input','\x0a#EXT-X-ENDLIST\x0a','replace','seq','currentUser','index\x20does\x20not\x20exist','killed','mp4','m3u8','stringify','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','../utils/cryptoUtils','faidLoadSubtitle','decryptFileGetStream','videoCodec'];_0x481c=function(){return _0x2cfaf6;};return _0x481c();}let videoStreamUtil=require('../../utils/videoStreamUtil'),FFmpeg=require(_0x3f1da6(0xf4))[_0x3f1da6(0x124)],cryptoUtils=require(_0x3f1da6(0x112)),sha256=require(_0x3f1da6(0xda));require(_0x3f1da6(0x126))[_0x3f1da6(0x151)]['defaultMaxListeners']=0x0;const dbUserTable=require('../../db/dbUserTable'),dbFileIndexTable=require(_0x3f1da6(0xf2)),dbConfigTable=require(_0x3f1da6(0x165));var jschardet=require('jschardet');function MP4FfmpegTrans(_0x196cb3,_0x14b13b,_0x18e0b3,_0x45ba5e,_0x4dfadf,_0x51d549){const _0x371a00=_0x3f1da6;let _0x4ecb9a=_0x196cb3[_0x371a00(0x17a)],_0x187e25=FFmpeg(),_0xe9eaeb;if(_0x4dfadf)_0xe9eaeb=cryptoUtils[_0x371a00(0x114)](_0x51d549,_0x18e0b3);let _0x51b6a1=_0x4dfadf?_0xe9eaeb:_0x18e0b3,{videoStream:_0x4cf051,videoWidth:_0x280582,videoHeight:_0x1a6f8c}=transCodeUtil['parseStreamList'](_0x45ba5e);_0x187e25[_0x371a00(0x107)](transCodeUtil[_0x371a00(0xf5)](_0x51b6a1));try{_0x187e25['on'](_0x371a00(0x11d),function(_0x96992a){const _0x1f55a5=_0x371a00;console[_0x1f55a5(0x11f)](_0x96992a);}),_0x187e25['on'](_0x371a00(0x15b),function(_0x3bbdf6){const _0x5c229b=_0x371a00;if(_0x3bbdf6[_0x5c229b(0x16d)]&&_0x3bbdf6[_0x5c229b(0x16d)][_0x5c229b(0x121)](_0x5c229b(0x10d))==-0x1)_0x187e25[_0x5c229b(0xf7)](),_0x187e25=null,_0x14b13b[_0x5c229b(0xe8)](0x1f4)[_0x5c229b(0xee)]();else{}}),_0x187e25['on'](_0x371a00(0xee),function(_0x424953){const _0x300b12=_0x371a00;_0x187e25&&(_0x187e25[_0x300b12(0xf7)](),_0x187e25=null);if(_0x14b13b)_0x14b13b[_0x300b12(0xe8)](0xc8)[_0x300b12(0xee)]();}),_0x14b13b['on'](_0x371a00(0x172),function(){});let _0x257905=transCodeUtil[_0x371a00(0x12e)](_0x196cb3[_0x371a00(0xd7)]['dbOther'],_0x4cf051);_0x257905[_0x371a00(0x13c)]&&_0x187e25[_0x371a00(0x158)](_0x257905['decoderCommand']);let _0x4ff0cc=_0x4ecb9a[_0x371a00(0x10a)]*config['m3u8segmentDuration'];_0x4ff0cc&&!_0x4dfadf&&_0x187e25['seekInput'](''+parseInt(_0x4ff0cc));_0x257905[_0x371a00(0x17c)]&&_0x187e25[_0x371a00(0x115)](_0x257905[_0x371a00(0x17c)]);let _0x4dc084=transCodeUtil[_0x371a00(0x141)](_0x4cf051,_0x4ecb9a[_0x371a00(0x156)]);!_0x4dc084&&(_0x4dc084=0x1800),_0x187e25[_0x371a00(0x143)](''+_0x4dc084),_0x187e25['addOption'](_0x371a00(0x148)),_0x187e25['addOption']('-map\x200:a:'+(_0x4ecb9a[_0x371a00(0x12b)]?_0x4ecb9a[_0x371a00(0x12b)]:0x0)+'?'),_0x187e25['outputFormat'](_0x371a00(0x10e)),_0x187e25[_0x371a00(0x12f)](_0x371a00(0x131)),_0x187e25['outputOptions']([_0x371a00(0x14e)]),_0x187e25['outputFormat'](_0x371a00(0x10e)),_0x187e25[_0x371a00(0x146)](_0x14b13b,{'end':!![]});}catch(_0x1eeb14){console[_0x371a00(0x11f)](_0x1eeb14),_0x187e25['kill'](),_0x14b13b[_0x371a00(0x11a)](0x1f4);}}router[_0x3f1da6(0xfb)](_0x3f1da6(0x179),(_0x195148,_0x16a659,_0x2a01ce)=>{const _0x57ad8f=_0x3f1da6;let _0xfbd748=_0x195148['query']['playId']||_0x195148[_0x57ad8f(0x13b)]['playId'];process[_0x57ad8f(0x177)]({'type':_0x57ad8f(0xe5),'playId':_0xfbd748,'action':_0x57ad8f(0x122)});let _0x29f19b=path['join'](config['m3u8TmpPath'],_0xfbd748);return fs['rm'](_0x29f19b,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x25d43d=>{const _0x41820c=_0x57ad8f;if(_0x25d43d)console[_0x41820c(0x11f)](_0x25d43d);}),_0x195148[_0x57ad8f(0xd7)][_0x57ad8f(0x101)][_0x57ad8f(0xf6)](_0x57ad8f(0x125))[_0x57ad8f(0x11b)](_0x195148[_0x57ad8f(0x17a)]['playId']),_0x16a659[_0x57ad8f(0x152)]({'code':0x0});}),router['get']('/subtitle*',(_0x3b5991,_0x1313de,_0x1abd5f)=>{const _0xc6f042=_0x3f1da6;let _0x377333=_0x3b5991[_0xc6f042(0x17a)],_0x411011=_0x377333[_0xc6f042(0xf9)],_0x2823a1=_0x377333['subtitleFile'];if(_0x2823a1&&_0x2823a1[_0xc6f042(0x159)]>0x2){let _0x332eb3=fileUtil[_0xc6f042(0x102)](_0x2823a1);fs['access'](_0x332eb3,fs['constants'][_0xc6f042(0x168)],_0x42b49d=>{const _0x4b4656=_0xc6f042;if(_0x42b49d)return _0x3b5991[_0x4b4656(0xd7)]['returnErrMsg'](_0x1313de,_0x1313de['__']('cannotReadFile'));path['extname'](_0x332eb3)=='.vtt'&&_0x1313de[_0x4b4656(0x154)](_0x332eb3),fs[_0x4b4656(0x135)](_0x332eb3,(_0x2a8369,_0x58e62a)=>{const _0x739e61=_0x4b4656;if(_0x2a8369)return _0x3b5991[_0x739e61(0xd7)][_0x739e61(0x162)](_0x1313de,_0x1313de['__'](_0x739e61(0x127)));try{let _0x397fbd=jschardet[_0x739e61(0x118)](_0x58e62a);!_0x397fbd[_0x739e61(0x132)][_0x739e61(0xf1)]('UTF-')&&_0x397fbd['confidence']>0.95?_0x509f1d(_0x397fbd['encoding']):_0x509f1d();}catch(_0x4a3989){console[_0x739e61(0x11f)](_0x4a3989),_0x509f1d();}function _0x509f1d(_0xacfb69){const _0x584ef8=_0x739e61;let _0x4ffd33=FFmpeg();_0x4ffd33[_0x584ef8(0x107)](transCodeUtil[_0x584ef8(0xf5)](_0x332eb3))[_0x584ef8(0x100)]()[_0x584ef8(0x176)]()[_0x584ef8(0xe1)](_0x584ef8(0x145)),_0xacfb69&&_0x4ffd33['inputOption']('-sub_charenc\x20'+_0xacfb69),_0x4ffd33['on'](_0x584ef8(0x11d),function(_0x2aca14){console['log'](_0x2aca14);})['on']('error',function(_0x1335e2){const _0x3e7ed3=_0x584ef8;_0x4ffd33[_0x3e7ed3(0xf7)]();})['on'](_0x584ef8(0xee),function(){_0x4ffd33['kill']();})[_0x584ef8(0x146)](_0x1313de);}});});}else{let _0x2e1944=_0x377333['stype'];transCodeUtil[_0xc6f042(0xea)](_0x3b5991[_0xc6f042(0xd7)][_0xc6f042(0x15d)],_0x3b5991['app']['dbOther'],_0x377333)['then'](_0x32e282=>{const _0x5d2cd9=_0xc6f042;let {fullpath:_0x493fda,needDecrypt:_0x36d082,pwd:_0x49c1c7,streamList:_0x4d5602}=_0x32e282;fs[_0x5d2cd9(0x170)](_0x493fda,fs[_0x5d2cd9(0x120)]['R_OK'],_0x257307=>{const _0x2fbc7b=_0x5d2cd9;if(_0x257307)return _0x3b5991[_0x2fbc7b(0xd7)][_0x2fbc7b(0x162)](_0x1313de,_0x1313de['__'](_0x2fbc7b(0x127)));if(!_0x2e1944)_0x2e1944=_0x2fbc7b(0x171);let _0x2545f7=path[_0x2fbc7b(0x133)](config[_0x2fbc7b(0x105)],sha256(_0x493fda+_0x411011)+'.'+_0x2e1944);fs[_0x2fbc7b(0xe9)](_0x2545f7,(_0x34b7c1,_0x5dac42)=>{const _0x2d217e=_0x2fbc7b;if(_0x34b7c1||_0x5dac42[_0x2d217e(0xfe)]<0x3e8){console['log'](_0x2d217e(0x160),_0x2545f7);let _0x428173=_0x36d082?cryptoUtils[_0x2d217e(0x114)](_0x49c1c7,_0x493fda):_0x493fda,_0x28f8db=FFmpeg({'timeout':0x258});_0x28f8db[_0x2d217e(0x107)](transCodeUtil[_0x2d217e(0xf5)](_0x428173))[_0x2d217e(0x100)]()[_0x2d217e(0x176)]()[_0x2d217e(0xde)]([_0x2d217e(0x163)+_0x411011])[_0x2d217e(0x166)](_0x2545f7)['on'](_0x2d217e(0x11d),function(_0xfc55f0){const _0x66fd17=_0x2d217e;console[_0x66fd17(0x11f)](_0xfc55f0);})['on'](_0x2d217e(0x15b),function(_0x27bc0e){const _0x3e13b4=_0x2d217e;console[_0x3e13b4(0x11f)](_0x27bc0e),_0x28f8db['kill'](),fs['rm'](_0x2545f7,_0x4b8982=>{}),_0x3b5991['app'][_0x3e13b4(0x162)](_0x1313de,_0x1313de['__'](_0x3e13b4(0x113)));})['on'](_0x2d217e(0xee),function(){const _0x4c92d5=_0x2d217e;return _0x28f8db[_0x4c92d5(0xf7)](),_0x377333[_0x4c92d5(0x128)]?_0x1313de['json']({'code':0x0}):_0x1313de['sendFile'](_0x2545f7);}),_0x28f8db[_0x2d217e(0x11b)](),_0x1313de['on'](_0x2d217e(0x172),function(){_0x28f8db['kill']();});}else{console[_0x2d217e(0x11f)](_0x2d217e(0xe3),_0x2545f7);if(_0x377333[_0x2d217e(0x128)])return _0x1313de[_0x2d217e(0x152)]({'code':0x0});return _0x1313de['sendFile'](_0x2545f7);}});});})[_0xc6f042(0x12a)](_0x1ea061=>{const _0x128c9b=_0xc6f042;console[_0x128c9b(0x11f)](_0x1ea061),_0x3b5991['app'][_0x128c9b(0x162)](_0x1313de,_0x1ea061);});}});function sendTsFile(_0xa1637b,_0x403ca3,_0x4212cc,_0x496330,_0x3359a3,_0x17798b=0x1){const _0x3db054=_0x3f1da6;if(_0x17798b>0x28)return;let _0x40f25a=_0x4212cc[_0x3db054(0xe6)];if(!_0x40f25a)return;let _0x39fbf9=_0xa1637b[_0x3db054(0xd7)][_0x3db054(0x101)][_0x3db054(0xf6)](_0x3db054(0xef))[_0x3db054(0x129)](_0x40f25a,_0x3359a3,_0x3db054(0xfa));if(_0x39fbf9)fs[_0x3db054(0xe9)](_0x496330,(_0x43a355,_0x1eefcc)=>{const _0x5d8692=_0x3db054;_0x43a355?(_0xa1637b[_0x5d8692(0xd7)][_0x5d8692(0x101)][_0x5d8692(0xf6)](_0x5d8692(0xe0))[_0x5d8692(0x11b)](_0x40f25a,_0x3359a3),sendTsFile(_0xa1637b,_0x403ca3,_0x4212cc,_0x496330,_0x3359a3,_0x17798b+0x1)):(_0xa1637b[_0x5d8692(0xd7)][_0x5d8692(0x101)][_0x5d8692(0xf6)](_0x5d8692(0xed))[_0x5d8692(0x11b)](_0x40f25a),_0x403ca3[_0x5d8692(0x154)](_0x496330));});else{function _0x3ae884(){const _0x21e1e0=_0x3db054;let _0x1a0c3=setTimeout(()=>{clearTimeout(_0x1a0c3),sendTsFile(_0xa1637b,_0x403ca3,_0x4212cc,_0x496330,_0x3359a3,_0x17798b+0x1);},0x1f4);_0x403ca3['on'](_0x21e1e0(0x172),()=>clearTimeout(_0x1a0c3));}let _0x14db92=_0xa1637b[_0x3db054(0xd7)]['dbOther'][_0x3db054(0xf6)](_0x3db054(0x111))[_0x3db054(0x129)](_0x40f25a,_0x3db054(0xfa));if(!_0x14db92)return _0x3ae884();else{let _0x8d6b3f=_0xa1637b['app']['dbOther'][_0x3db054(0xf6)](_0x3db054(0x13d))[_0x3db054(0x129)](_0x40f25a,_0x3359a3,'waiting');if(_0x8d6b3f)return _0x3ae884();else{let _0x3f886e=parseInt(_0x14db92[_0x3db054(0x142)][_0x3db054(0x109)](_0x3db054(0x15f),'')[_0x3db054(0x109)](_0x3db054(0x14f),''));return _0x4212cc['seq']>_0x3f886e+0xf||_0x4212cc[_0x3db054(0x10a)]<_0x3f886e?(process[_0x3db054(0x177)]({'type':_0x3db054(0xe5),'playId':_0x40f25a,'action':_0x3db054(0x122)}),process[_0x3db054(0x177)]({'type':_0x3db054(0xe5),'playId':_0x40f25a,'args':_0x4212cc,'action':_0x3db054(0x11d)}),_0xa1637b[_0x3db054(0xd7)]['dbOther']['prepare'](_0x3db054(0x147))['run'](_0x40f25a,_0x3359a3,_0x3db054(0xfc)),_0x3ae884()):_0x3ae884();}}}}function hasPermission(_0xc4635f,_0x10d766,_0x1a1da5){const _0x47b86f=_0x3f1da6;if(_0x1a1da5[_0x47b86f(0x13a)]&&!_0x1a1da5['spaceId']){let _0x1012c9=dbFileIndexTable['getIndexTableNameByType'](_0x1a1da5[_0x47b86f(0x16c)]),_0x1c54aa=dbFileIndexTable[_0x47b86f(0xff)](_0xc4635f[_0x47b86f(0xd7)][_0x47b86f(0x15d)],_0x1a1da5[_0x47b86f(0x13a)],_0x1012c9);if(!_0x1c54aa)return reject(_0x47b86f(0x10c));let _0x457097=_0x1c54aa[_0x47b86f(0x161)]+path[_0x47b86f(0x173)]+_0x1c54aa['filename'];if(dbUserTable[_0x47b86f(0x14a)](_0xc4635f,_0x10d766,_0x1a1da5['serverType'],'power_get',_0x457097,!![])!==!![])return console[_0x47b86f(0x11f)](_0x47b86f(0x157)),![];return!![];}else{if(_0x1a1da5[_0x47b86f(0x139)]&&!_0x1a1da5[_0x47b86f(0x15e)]){let _0x469b8d=fileUtil[_0x47b86f(0x102)](_0x1a1da5[_0x47b86f(0x139)]);if(dbUserTable[_0x47b86f(0x14a)](_0xc4635f,_0x10d766,'',_0x47b86f(0x17d),_0x469b8d,!![])!==!![])return console[_0x47b86f(0x11f)](_0x47b86f(0x157)),![];return!![];}else return!![];}}router[_0x3f1da6(0x129)]('/play*',(_0x225871,_0x265f7d,_0x3488a6)=>{const _0x324287=_0x3f1da6;let _0x45c613=_0x225871[_0x324287(0x17a)];if(_0x225871[_0x324287(0x161)][_0x324287(0x15c)]('ts')){let _0x255b4e=_0x225871[_0x324287(0x161)][_0x324287(0xf3)](_0x225871['path'][_0x324287(0xd8)]('/')+0x1),_0x35869c=_0x45c613[_0x324287(0xe6)],_0x27583c=path[_0x324287(0x133)](config[_0x324287(0xd9)],_0x35869c,_0x255b4e),_0x20715c=_0x225871[_0x324287(0xd7)][_0x324287(0x101)]['prepare'](_0x324287(0x16f))[_0x324287(0x129)](_0x35869c);!_0x20715c&&(_0x45c613['seek']=_0x45c613[_0x324287(0x10a)]*config[_0x324287(0x17e)],_0x225871[_0x324287(0xd7)][_0x324287(0x101)][_0x324287(0xf6)](_0x324287(0x17f))[_0x324287(0x11b)](_0x35869c,JSON[_0x324287(0x110)](_0x45c613),_0x225871[_0x324287(0x10b)]['id']));if(!hasPermission(_0x225871,_0x265f7d,_0x45c613))return _0x265f7d['json']({'code':0x66});return process['send']({'type':'M3u8Transcode','playId':_0x35869c,'args':_0x45c613,'action':_0x324287(0x11d)}),sendTsFile(_0x225871,_0x265f7d,_0x45c613,_0x27583c,_0x255b4e);}else{if(_0x225871[_0x324287(0x161)][_0x324287(0x15c)](_0x324287(0x10f))){let _0x17380f=_0x45c613[_0x324287(0xe6)];if(!_0x17380f)return _0x225871[_0x324287(0xd7)][_0x324287(0x162)](_0x265f7d,_0x324287(0x14b));if(!hasPermission(_0x225871,_0x265f7d,_0x45c613))return _0x265f7d[_0x324287(0x152)]({'code':0x66});transCodeUtil['parseVideoFullPath'](_0x225871['app'][_0x324287(0x15d)],_0x225871['app']['dbOther'],_0x45c613)[_0x324287(0x138)](_0x43227c=>{const _0x23827a=_0x324287;let {fullpath:_0x462231,duration:_0x3e5aa1}=_0x43227c;fs[_0x23827a(0x170)](_0x462231,fs[_0x23827a(0x120)][_0x23827a(0x168)],_0x3c0b58=>{const _0x5d416d=_0x23827a;if(_0x3c0b58)return _0x225871[_0x5d416d(0xd7)][_0x5d416d(0x162)](_0x265f7d,_0x265f7d['__'](_0x5d416d(0x127)));_0x225871['app'][_0x5d416d(0x101)][_0x5d416d(0xf6)](_0x5d416d(0x17f))[_0x5d416d(0x11b)](_0x17380f,JSON[_0x5d416d(0x110)](_0x45c613),_0x225871[_0x5d416d(0x10b)]['id']),process['send']({'type':_0x5d416d(0xe5),'playId':_0x17380f,'args':_0x45c613,'action':_0x5d416d(0x11d)}),getM3U8(_0x45c613,_0x3e5aa1,_0x265f7d);});})[_0x324287(0x12a)](_0x1a2d2b=>{const _0x1ed520=_0x324287;console[_0x1ed520(0x11f)](_0x1ed520(0x15b),_0x1a2d2b),_0x225871['app'][_0x1ed520(0x162)](_0x265f7d,_0x1a2d2b);});}else{if(_0x225871[_0x324287(0x161)]['endsWith'](_0x324287(0x10e))){if(!hasPermission(_0x225871,_0x265f7d,_0x45c613))return _0x265f7d[_0x324287(0x152)]({'code':0x66});transCodeUtil['parseVideoFullPath'](_0x225871[_0x324287(0xd7)][_0x324287(0x15d)],_0x225871[_0x324287(0xd7)][_0x324287(0x101)],_0x45c613)[_0x324287(0x138)](_0x5a1bf8=>{const _0x4b2a8f=_0x324287;let {fullpath:_0x131dfb,streamList:_0x461622,needDecrypt:_0x58cd07,pwd:_0x39de20}=_0x5a1bf8;fs[_0x4b2a8f(0x170)](_0x131dfb,fs[_0x4b2a8f(0x120)][_0x4b2a8f(0x168)],_0x5167aa=>{const _0xb6e6fd=_0x4b2a8f;if(_0x5167aa)return _0x225871['app'][_0xb6e6fd(0x162)](_0x265f7d,_0x265f7d['__'](_0xb6e6fd(0x127)));MP4FfmpegTrans(_0x225871,_0x265f7d,_0x131dfb,_0x461622,_0x58cd07,_0x39de20);});})[_0x324287(0x12a)](_0x1f2c51=>{const _0x559423=_0x324287;console[_0x559423(0x11f)](_0x559423(0x15b),_0x1f2c51),_0x225871[_0x559423(0xd7)][_0x559423(0x162)](_0x265f7d,_0x1f2c51);});}}}}),router[_0x3f1da6(0x12d)](_0x3f1da6(0x153),(_0x459cb2,_0x24fa99,_0x113279)=>{const _0x35c055=_0x3f1da6;if(!_0x459cb2[_0x35c055(0x13b)][_0x35c055(0x139)])return _0x24fa99[_0x35c055(0x11a)](0x1f4);let _0x2571ea=fileUtil[_0x35c055(0x102)](_0x459cb2[_0x35c055(0x13b)][_0x35c055(0x139)]),_0x423842={'code':0x0,'streams':[],'duration':0x0},_0x2ff020=dbConfigTable[_0x35c055(0x14c)](_0x459cb2[_0x35c055(0xd7)][_0x35c055(0x101)],_0x35c055(0x140));_0x423842[_0x35c055(0x140)]=_0x2ff020?_0x2ff020['value']:_0x35c055(0x117),_0x2571ea=transCodeUtil[_0x35c055(0xf5)](_0x2571ea),videoStreamUtil[_0x35c055(0xe4)](_0x2571ea)['then'](_0x13c98e=>{const _0x3c68e5=_0x35c055;_0x423842['streams']=_0x13c98e[_0x3c68e5(0xdb)],_0x423842[_0x3c68e5(0x149)]=videoStreamUtil[_0x3c68e5(0x17b)](_0x13c98e),_0x24fa99['json'](_0x423842);})[_0x35c055(0x12a)](_0x2b3839=>{const _0x308647=_0x35c055;return console[_0x308647(0x11f)](_0x2b3839),_0x459cb2[_0x308647(0xd7)][_0x308647(0x162)](_0x24fa99,_0x2b3839);});});function getM3U8(_0x4199dc,_0x341c87,_0x529cfd){const _0x198ebc=_0x3f1da6;let _0xa43791=Math[_0x198ebc(0x13f)](_0x341c87/config[_0x198ebc(0x17e)]),_0x20bc28=_0x341c87-_0xa43791*_0x341c87;if(_0x20bc28>0x0){try{_0x20bc28=parseInt(_0x20bc28);}catch(_0x398706){console[_0x198ebc(0x11f)](_0x398706);}_0xa43791+=0x1;}let _0x2ae2c6=_0x198ebc(0x164)+config[_0x198ebc(0x17e)]+',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET='+_0x4199dc[_0x198ebc(0xfd)]+'\x0a';_0x4199dc['seek']&&(segmentStartNum=parseInt(_0x4199dc[_0x198ebc(0xfd)]/config[_0x198ebc(0x17e)]));for(let _0x497833=0x0;_0x497833<_0xa43791;_0x497833++){let _0x596d5d=_0x198ebc(0xdd)+(_0x497833==_0xa43791-0x1&&_0x20bc28>0x0?_0x20bc28:config['m3u8segmentDuration'])+_0x198ebc(0xdf)+_0x497833+_0x198ebc(0xe7)+_0x4199dc['playId']+_0x198ebc(0x123)+_0x4199dc[_0x198ebc(0xdc)]+_0x198ebc(0x130)+_0x497833;_0x4199dc['size']&&(_0x596d5d+=_0x198ebc(0x16a)+_0x4199dc['size']),_0x4199dc[_0x198ebc(0x156)]&&(_0x596d5d+=_0x198ebc(0xec)+_0x4199dc['videobit']),_0x4199dc[_0x198ebc(0xf9)]&&(_0x596d5d+=_0x198ebc(0x136)+_0x4199dc[_0x198ebc(0xf9)]),_0x4199dc[_0x198ebc(0x16c)]&&(_0x596d5d+=_0x198ebc(0x116)+_0x4199dc[_0x198ebc(0x16c)]),_0x4199dc[_0x198ebc(0x12b)]&&(_0x596d5d+=_0x198ebc(0x13e)+_0x4199dc[_0x198ebc(0x12b)]),_0x4199dc['indexId']&&(_0x596d5d+=_0x198ebc(0x137)+_0x4199dc[_0x198ebc(0x13a)]),_0x4199dc['ac']&&(_0x596d5d+=_0x198ebc(0x16e)+_0x4199dc['ac']),_0x4199dc[_0x198ebc(0x139)]&&(_0x596d5d+=_0x198ebc(0x104)+_0x4199dc[_0x198ebc(0x139)]),_0x4199dc[_0x198ebc(0x15e)]&&(_0x596d5d+=_0x198ebc(0x150)+_0x4199dc['spaceId']),_0x4199dc[_0x198ebc(0x103)]&&(_0x596d5d+='&spaceToken='+_0x4199dc[_0x198ebc(0x103)]),_0x4199dc[_0x198ebc(0x119)]&&(_0x596d5d+='&spaceIndexId='+_0x4199dc[_0x198ebc(0x119)]),_0x4199dc[_0x198ebc(0x155)]&&(_0x596d5d+=_0x198ebc(0x174)+_0x4199dc[_0x198ebc(0x155)]),_0x2ae2c6+=_0x596d5d;}_0x2ae2c6+=_0x198ebc(0x108),_0x529cfd[_0x198ebc(0xeb)]('Content-type','application/octet-stream');let _0x5926d1=new Date()[_0x198ebc(0x134)]()+_0x198ebc(0x16b);_0x529cfd['setHeader'](_0x198ebc(0x144),'attachment;\x20filename='+_0x5926d1),_0x529cfd[_0x198ebc(0x177)](_0x2ae2c6);}module['exports']=router;