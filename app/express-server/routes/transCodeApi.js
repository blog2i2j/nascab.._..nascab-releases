const _0x19c486=_0x19d1;(function(_0x71ef52,_0x333628){const _0x5668d9=_0x19d1,_0x3c540f=_0x71ef52();while(!![]){try{const _0x34f11b=parseInt(_0x5668d9(0x1a6))/0x1*(parseInt(_0x5668d9(0x1d4))/0x2)+parseInt(_0x5668d9(0x1fa))/0x3+-parseInt(_0x5668d9(0x17d))/0x4+parseInt(_0x5668d9(0x20f))/0x5+parseInt(_0x5668d9(0x1fc))/0x6*(-parseInt(_0x5668d9(0x174))/0x7)+parseInt(_0x5668d9(0x208))/0x8+-parseInt(_0x5668d9(0x206))/0x9;if(_0x34f11b===_0x333628)break;else _0x3c540f['push'](_0x3c540f['shift']());}catch(_0x339dcf){_0x3c540f['push'](_0x3c540f['shift']());}}}(_0x577a,0x517e5));let express=require(_0x19c486(0x1ef)),router=express[_0x19c486(0x1b4)](),path=require(_0x19c486(0x218)),fs=require('fs'),transCodeUtil=require(_0x19c486(0x1ff)),fileUtil=require(_0x19c486(0x1d2));const config=require('../../myConfig/config');let videoStreamUtil=require('../../utils/videoStreamUtil'),FFmpeg=require(_0x19c486(0x1c0))[_0x19c486(0x1b5)],cryptoUtils=require('../utils/cryptoUtils'),sha256=require(_0x19c486(0x1c3));require(_0x19c486(0x1f0))[_0x19c486(0x1e5)][_0x19c486(0x1b1)]=0x0;function _0x19d1(_0x1dc1df,_0x47dcc9){const _0x577a40=_0x577a();return _0x19d1=function(_0x19d12d,_0x2e59c3){_0x19d12d=_0x19d12d-0x172;let _0x401339=_0x577a40[_0x19d12d];return _0x401339;},_0x19d1(_0x1dc1df,_0x47dcc9);}const dbUserTable=require('../../db/dbUserTable'),dbFileIndexTable=require(_0x19c486(0x1d3)),dbConfigTable=require('../../db/dbConfigTable');var jschardet=require(_0x19c486(0x1c8));function MP4FfmpegTrans(_0x2aaf61,_0x28febe,_0x55dccf,_0x999cc0,_0x3950fe,_0x2dd107){const _0x352963=_0x19c486;let _0x5e06a2=_0x2aaf61[_0x352963(0x1bc)],_0x236bb7=FFmpeg(),_0x4148be;if(_0x3950fe)_0x4148be=cryptoUtils[_0x352963(0x200)](_0x2dd107,_0x55dccf);let _0x67cd95=_0x3950fe?_0x4148be:_0x55dccf,{videoStream:_0x562858,videoWidth:_0x1c27d5,videoHeight:_0x8c22ec}=transCodeUtil['parseStreamList'](_0x999cc0);_0x236bb7[_0x352963(0x175)](transCodeUtil[_0x352963(0x1b0)](_0x67cd95));try{_0x236bb7['on'](_0x352963(0x1c5),function(_0x1c2299){const _0x496af5=_0x352963;console[_0x496af5(0x19a)](_0x1c2299);}),_0x236bb7['on']('error',function(_0x3ccdd6){const _0x5b982b=_0x352963;if(_0x3ccdd6[_0x5b982b(0x1a1)]&&_0x3ccdd6[_0x5b982b(0x1a1)]['indexOf'](_0x5b982b(0x18e))==-0x1)_0x236bb7[_0x5b982b(0x1a3)](),_0x236bb7=null,_0x28febe['status'](0x1f4)[_0x5b982b(0x182)]();else{}}),_0x236bb7['on'](_0x352963(0x182),function(_0x2ab507){const _0x3634bc=_0x352963;_0x236bb7&&(_0x236bb7[_0x3634bc(0x1a3)](),_0x236bb7=null);if(_0x28febe)_0x28febe[_0x3634bc(0x1e8)](0xc8)[_0x3634bc(0x182)]();}),_0x28febe['on']('close',function(){});let _0xdace7b=transCodeUtil['getCoderConfig'](_0x2aaf61[_0x352963(0x172)][_0x352963(0x178)],_0x562858);_0xdace7b['decoderCommand']&&_0x236bb7[_0x352963(0x1df)](_0xdace7b[_0x352963(0x187)]);let _0x5c548b=_0x5e06a2['seq']*config[_0x352963(0x1ea)];_0x5c548b&&!_0x3950fe&&_0x236bb7[_0x352963(0x1e3)](''+parseInt(_0x5c548b));_0xdace7b[_0x352963(0x1c2)]&&_0x236bb7[_0x352963(0x1ed)](_0xdace7b[_0x352963(0x1c2)]);let _0x53a6d9=transCodeUtil['getVideoBitrate'](_0x562858,_0x5e06a2[_0x352963(0x1dc)]);!_0x53a6d9&&(_0x53a6d9=0x1800),_0x236bb7['videoBitrate'](''+_0x53a6d9),_0x236bb7[_0x352963(0x1e0)](_0x352963(0x1dd)),_0x236bb7[_0x352963(0x1e0)]('-map\x200:a:'+(_0x5e06a2[_0x352963(0x17e)]?_0x5e06a2[_0x352963(0x17e)]:0x0)+'?'),_0x236bb7['outputFormat'](_0x352963(0x1f1)),_0x236bb7[_0x352963(0x1f7)](_0x352963(0x1f4)),_0x236bb7[_0x352963(0x1a8)]([_0x352963(0x1d0)]),_0x236bb7[_0x352963(0x1f2)](_0x352963(0x1f1)),_0x236bb7[_0x352963(0x17a)](_0x28febe,{'end':!![]});}catch(_0x34b425){console[_0x352963(0x19a)](_0x34b425),_0x236bb7[_0x352963(0x1a3)](),_0x28febe['sendStatus'](0x1f4);}}router[_0x19c486(0x1da)](_0x19c486(0x1b3),(_0x220bfe,_0xcf48db,_0x2db56d)=>{const _0x47e112=_0x19c486;let _0x271eef=_0x220bfe['query'][_0x47e112(0x1fe)]||_0x220bfe[_0x47e112(0x1a4)][_0x47e112(0x1fe)];process[_0x47e112(0x1d5)]({'type':_0x47e112(0x1aa),'playId':_0x271eef,'action':_0x47e112(0x1f5)});let _0x3e9070=path['join'](config['m3u8TmpPath'],_0x271eef);return fs['rm'](_0x3e9070,{'recursive':!![],'force':!![],'maxRetries':0xa},_0x4c67eb=>{const _0x22580f=_0x47e112;if(_0x4c67eb)console[_0x22580f(0x19a)](_0x4c67eb);}),_0x220bfe[_0x47e112(0x172)][_0x47e112(0x178)]['prepare'](_0x47e112(0x1bd))[_0x47e112(0x1c4)](_0x220bfe['query'][_0x47e112(0x1fe)]),_0xcf48db[_0x47e112(0x183)]({'code':0x0});}),router[_0x19c486(0x19e)](_0x19c486(0x1e7),(_0x2d8434,_0x3c36d9,_0x254835)=>{const _0x579122=_0x19c486;let _0x4af234=_0x2d8434['query'],_0x44a2ef=_0x4af234[_0x579122(0x1cf)],_0x3b9c31=_0x4af234['subtitleFile'];if(_0x3b9c31&&_0x3b9c31[_0x579122(0x1b2)]>0x2){let _0xf0f8e2=fileUtil['decodePath'](_0x3b9c31);fs['access'](_0xf0f8e2,fs[_0x579122(0x1eb)][_0x579122(0x196)],_0x452a20=>{const _0xc3d46c=_0x579122;if(_0x452a20)return _0x2d8434['app']['returnErrMsg'](_0x3c36d9,_0x3c36d9['__']('cannotReadFile'));path['extname'](_0xf0f8e2)==_0xc3d46c(0x17b)&&_0x3c36d9[_0xc3d46c(0x192)](_0xf0f8e2),fs[_0xc3d46c(0x188)](_0xf0f8e2,(_0x5a6bbc,_0x1319c2)=>{const _0x45150c=_0xc3d46c;if(_0x5a6bbc)return _0x2d8434[_0x45150c(0x172)][_0x45150c(0x1ad)](_0x3c36d9,_0x3c36d9['__']('cannotReadFile'));try{let _0x406dea=jschardet[_0x45150c(0x177)](_0x1319c2);!_0x406dea[_0x45150c(0x1b6)][_0x45150c(0x1b7)](_0x45150c(0x19d))&&_0x406dea[_0x45150c(0x213)]>0.95?_0x5a6756(_0x406dea[_0x45150c(0x1b6)]):_0x5a6756();}catch(_0x49b575){console[_0x45150c(0x19a)](_0x49b575),_0x5a6756();}function _0x5a6756(_0x2137b2){const _0x292e54=_0x45150c;let _0x5a0d02=FFmpeg();_0x5a0d02[_0x292e54(0x175)](transCodeUtil[_0x292e54(0x1b0)](_0xf0f8e2))[_0x292e54(0x186)]()['noVideo']()[_0x292e54(0x1c6)]('webvtt'),_0x2137b2&&_0x5a0d02[_0x292e54(0x181)]('-sub_charenc\x20'+_0x2137b2),_0x5a0d02['on'](_0x292e54(0x1c5),function(_0x2474a9){const _0x3005f9=_0x292e54;console[_0x3005f9(0x19a)](_0x2474a9);})['on'](_0x292e54(0x1ec),function(_0x1ba568){_0x5a0d02['kill']();})['on']('end',function(){_0x5a0d02['kill']();})['pipe'](_0x3c36d9);}});});}else{let _0x382e00=_0x4af234[_0x579122(0x1fd)];transCodeUtil[_0x579122(0x1e2)](_0x2d8434[_0x579122(0x172)][_0x579122(0x1a9)],_0x2d8434['app'][_0x579122(0x178)],_0x4af234)['then'](_0x4f70f3=>{const _0x4d30c6=_0x579122;let {fullpath:_0x2c53dd,needDecrypt:_0x361139,pwd:_0x19726e,streamList:_0x2de47a}=_0x4f70f3;fs[_0x4d30c6(0x216)](_0x2c53dd,fs[_0x4d30c6(0x1eb)]['R_OK'],_0x13387e=>{const _0x4bab22=_0x4d30c6;if(_0x13387e)return _0x2d8434[_0x4bab22(0x172)][_0x4bab22(0x1ad)](_0x3c36d9,_0x3c36d9['__']('cannotReadFile'));if(!_0x382e00)_0x382e00='vtt';let _0x29d0f9=path[_0x4bab22(0x1d1)](config[_0x4bab22(0x1e9)],sha256(_0x2c53dd+_0x44a2ef)+'.'+_0x382e00);fs[_0x4bab22(0x1de)](_0x29d0f9,(_0x20a73a,_0xbbff5f)=>{const _0x5d69d7=_0x4bab22;if(_0x20a73a||_0xbbff5f[_0x5d69d7(0x18d)]<0x3e8){console['log'](_0x5d69d7(0x214),_0x29d0f9);let _0x3c8278=_0x361139?cryptoUtils[_0x5d69d7(0x200)](_0x19726e,_0x2c53dd):_0x2c53dd,_0x577782=FFmpeg({'timeout':0x258});_0x577782[_0x5d69d7(0x175)](transCodeUtil[_0x5d69d7(0x1b0)](_0x3c8278))['noAudio']()[_0x5d69d7(0x219)]()[_0x5d69d7(0x1a8)]([_0x5d69d7(0x1cc)+_0x44a2ef])[_0x5d69d7(0x1f9)](_0x29d0f9)['on'](_0x5d69d7(0x1c5),function(_0x26572c){const _0xbbf521=_0x5d69d7;console[_0xbbf521(0x19a)](_0x26572c);})['on'](_0x5d69d7(0x1ec),function(_0x47a84b){const _0x47dda8=_0x5d69d7;console['log'](_0x47a84b),_0x577782['kill'](),fs['rm'](_0x29d0f9,_0x381710=>{}),_0x2d8434[_0x47dda8(0x172)][_0x47dda8(0x1ad)](_0x3c36d9,_0x3c36d9['__'](_0x47dda8(0x1e6)));})['on'](_0x5d69d7(0x182),function(){const _0x4ee50f=_0x5d69d7;return _0x577782[_0x4ee50f(0x1a3)](),_0x4af234[_0x4ee50f(0x1ce)]?_0x3c36d9[_0x4ee50f(0x183)]({'code':0x0}):_0x3c36d9['sendFile'](_0x29d0f9);}),_0x577782[_0x5d69d7(0x1c4)](),_0x3c36d9['on'](_0x5d69d7(0x1cb),function(){_0x577782['kill']();});}else{console[_0x5d69d7(0x19a)](_0x5d69d7(0x204),_0x29d0f9);if(_0x4af234[_0x5d69d7(0x1ce)])return _0x3c36d9[_0x5d69d7(0x183)]({'code':0x0});return _0x3c36d9[_0x5d69d7(0x192)](_0x29d0f9);}});});})[_0x579122(0x1a5)](_0x5e6f9e=>{const _0x4b7c70=_0x579122;console['log'](_0x5e6f9e),_0x2d8434[_0x4b7c70(0x172)]['returnErrMsg'](_0x3c36d9,_0x5e6f9e);});}});function sendTsFile(_0x1ee55c,_0x14e5b7,_0x366424,_0x303ae7,_0x5a3013,_0x2734ca=0x1){const _0x581c2b=_0x19c486;if(_0x2734ca>0x28)return;let _0x2a695e=_0x366424[_0x581c2b(0x1fe)];if(!_0x2a695e)return;let _0x20620d=_0x1ee55c[_0x581c2b(0x172)][_0x581c2b(0x178)][_0x581c2b(0x19b)](_0x581c2b(0x1a2))[_0x581c2b(0x19e)](_0x2a695e,_0x5a3013,'gen');if(_0x20620d)fs[_0x581c2b(0x1de)](_0x303ae7,(_0xcbbb67,_0x167fd7)=>{const _0x48b4dc=_0x581c2b;_0xcbbb67?(_0x1ee55c['app'][_0x48b4dc(0x178)][_0x48b4dc(0x19b)](_0x48b4dc(0x189))[_0x48b4dc(0x1c4)](_0x2a695e,_0x5a3013),sendTsFile(_0x1ee55c,_0x14e5b7,_0x366424,_0x303ae7,_0x5a3013,_0x2734ca+0x1)):(_0x1ee55c['app']['dbOther'][_0x48b4dc(0x19b)]('DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=\x27waiting\x27')[_0x48b4dc(0x1c4)](_0x2a695e),_0x14e5b7[_0x48b4dc(0x192)](_0x303ae7));});else{function _0x86b7fb(){const _0x3c41e0=_0x581c2b;let _0x549a75=setTimeout(()=>{clearTimeout(_0x549a75),sendTsFile(_0x1ee55c,_0x14e5b7,_0x366424,_0x303ae7,_0x5a3013,_0x2734ca+0x1);},0x1f4);_0x14e5b7['on'](_0x3c41e0(0x1cb),()=>clearTimeout(_0x549a75));}let _0x1a079c=_0x1ee55c[_0x581c2b(0x172)][_0x581c2b(0x178)][_0x581c2b(0x19b)](_0x581c2b(0x215))[_0x581c2b(0x19e)](_0x2a695e,'gen');if(!_0x1a079c)return _0x86b7fb();else{let _0x18e0d5=_0x1ee55c['app'][_0x581c2b(0x178)][_0x581c2b(0x19b)](_0x581c2b(0x180))['get'](_0x2a695e,_0x5a3013,_0x581c2b(0x1fb));if(_0x18e0d5)return _0x86b7fb();else{let _0xcfed50=parseInt(_0x1a079c['ts_name'][_0x581c2b(0x212)](_0x581c2b(0x1af),'')[_0x581c2b(0x212)]('.ts',''));return _0x366424[_0x581c2b(0x1c7)]>_0xcfed50+0xf||_0x366424[_0x581c2b(0x1c7)]<_0xcfed50?(process[_0x581c2b(0x1d5)]({'type':_0x581c2b(0x1aa),'playId':_0x2a695e,'action':_0x581c2b(0x1f5)}),process[_0x581c2b(0x1d5)]({'type':_0x581c2b(0x1aa),'playId':_0x2a695e,'args':_0x366424,'action':'start'}),_0x1ee55c[_0x581c2b(0x172)][_0x581c2b(0x178)][_0x581c2b(0x19b)](_0x581c2b(0x198))[_0x581c2b(0x1c4)](_0x2a695e,_0x5a3013,_0x581c2b(0x1fb)),_0x86b7fb()):_0x86b7fb();}}}}function hasPermission(_0xeec598,_0x56973f,_0x40ddf2){const _0x40429d=_0x19c486;if(_0x40ddf2[_0x40429d(0x1cd)]&&!_0x40ddf2['spaceId']){let _0x2249ec=dbFileIndexTable[_0x40429d(0x179)](_0x40ddf2['serverType']),_0x4fdcd5=dbFileIndexTable[_0x40429d(0x1db)](_0xeec598['app'][_0x40429d(0x1a9)],_0x40ddf2[_0x40429d(0x1cd)],_0x2249ec);if(!_0x4fdcd5)return reject(_0x40429d(0x194));let _0x2447a5=_0x4fdcd5[_0x40429d(0x218)]+path[_0x40429d(0x1bf)]+_0x4fdcd5[_0x40429d(0x20e)];if(dbUserTable[_0x40429d(0x1ac)](_0xeec598,_0x56973f,_0x40ddf2['serverType'],_0x40429d(0x1b9),_0x2447a5,!![])!==!![])return console[_0x40429d(0x19a)](_0x40429d(0x1ab)),![];return!![];}else{if(_0x40ddf2[_0x40429d(0x19c)]&&!_0x40ddf2[_0x40429d(0x1f6)]){let _0x50eb89=fileUtil[_0x40429d(0x184)](_0x40ddf2[_0x40429d(0x19c)]);if(dbUserTable['doUserCanGet'](_0xeec598,_0x56973f,'',_0x40429d(0x1b9),_0x50eb89,!![])!==!![])return console[_0x40429d(0x19a)](_0x40429d(0x1ab)),![];return!![];}else return!![];}}function _0x577a(){const _0x2a57a4=['access','/play*','path','noVideo','spaceIndexId','app','&spaceIndexId=','21ZXFPUj','input','seek','detect','dbOther','getIndexTableNameByType','pipe','.vtt','.m3u8','1309520VFQZte','audioIndex','stringify','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?','inputOption','end','json','decodePath','floor','noAudio','decoderCommand','readFile','DELETE\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?','serverType','m3u8','setHeader','size','killed','.0,\x0astream','&burn=','moviePreferLanguage','sendFile','.ts?playId=','index\x20does\x20not\x20exist','then','R_OK','sendStatus','REPLACE\x20INTO\x20play_record_ts(play_id,ts_name,ts_type)\x20VALUES(?,?,?)','REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)','log','prepare','filePath','UTF-','get','\x0a#EXT-X-ENDLIST\x0a','value','message','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_name=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC','kill','body','catch','5501nDewfj','burn','outputOptions','dbFileIndex','M3u8Transcode','index\x20no\x20permission','doUserCanGet','returnErrMsg','&videobit=','stream','dealFFmpegPath','defaultMaxListeners','length','/stopPlay','Router','FFmpeg','encoding','startsWith','getTime','power_get','&spaceId=','attachment;\x20filename=','query','DELETE\x20FROM\x20play_record\x20WHERE\x20play_id=?','&seq=','sep','../../libs/nasTrans','&size=','encoderName','sha256','run','start','format','seq','jschardet','spaceToken','chi','close','-map\x200:s:','indexId','noContent','subtitleIndex','-movflags\x20frag_keyframe+empty_moov','join','../utils/fileUtils','../../db/dbFileIndexTable','226OhRZCf','send','exports','/getVideoInfoByPath','endsWith','Content-type','all','getById','videobit','-map\x200:v:0?','stat','addInputOption','addOption','application/octet-stream','parseVideoFullPath','seekInput','streams','EventEmitter','faidLoadSubtitle','/subtitle*','status','subtitlePath','m3u8segmentDuration','constants','error','videoCodec','&indexId=','express','events','mp4','outputFormat','\x0a#EXTINF:','aac','stop','spaceId','audioCodec','&ac=','output','636627cyrDjc','waiting','105402xZBlhd','stype','playId','../../utils/transCodeUtil','decryptFileGetStream','findByTitle',',\x0a#EXT-X-MEDIA-SEQUENCE:0\x0a#EXT-X-ALLOW-CACHE:YES\x0a#EXT-X-START:TIME-OFFSET=','&filePath=','字幕文件存在缓存','currentUser','5895135irbGdk','&subtitleIndex=','1244920UmPtYt','token','getDurationFromStream','cannotReadFile','m3u8TmpPath','getVideoMeta','filename','1897280vApCng','&serverType=','Content-disposition','replace','confidence','生成字幕文件','SELECT\x20*\x20FROM\x20play_record_ts\x20WHERE\x20play_id=?\x20and\x20ts_type=?\x20ORDER\x20BY\x20create_time\x20DESC'];_0x577a=function(){return _0x2a57a4;};return _0x577a();}router[_0x19c486(0x19e)](_0x19c486(0x217),(_0x42aa58,_0x4ec176,_0x117a3d)=>{const _0x2a2d76=_0x19c486;let _0x263763=_0x42aa58[_0x2a2d76(0x1bc)];if(_0x42aa58[_0x2a2d76(0x218)]['endsWith']('ts')){let _0x55411d=_0x42aa58['path']['substring'](_0x42aa58[_0x2a2d76(0x218)]['lastIndexOf']('/')+0x1),_0x30d872=_0x263763[_0x2a2d76(0x1fe)],_0x38dbeb=path[_0x2a2d76(0x1d1)](config[_0x2a2d76(0x20c)],_0x30d872,_0x55411d),_0xb60210=_0x42aa58[_0x2a2d76(0x172)][_0x2a2d76(0x178)][_0x2a2d76(0x19b)]('SELECT\x20*\x20FROM\x20play_record\x20WHERE\x20play_id=?')[_0x2a2d76(0x19e)](_0x30d872);!_0xb60210&&(_0x263763[_0x2a2d76(0x176)]=_0x263763[_0x2a2d76(0x1c7)]*config[_0x2a2d76(0x1ea)],_0x42aa58[_0x2a2d76(0x172)][_0x2a2d76(0x178)][_0x2a2d76(0x19b)](_0x2a2d76(0x199))[_0x2a2d76(0x1c4)](_0x30d872,JSON[_0x2a2d76(0x17f)](_0x263763),_0x42aa58['currentUser']['id']));if(!hasPermission(_0x42aa58,_0x4ec176,_0x263763))return _0x4ec176[_0x2a2d76(0x183)]({'code':0x66});return process['send']({'type':'M3u8Transcode','playId':_0x30d872,'args':_0x263763,'action':'start'}),sendTsFile(_0x42aa58,_0x4ec176,_0x263763,_0x38dbeb,_0x55411d);}else{if(_0x42aa58[_0x2a2d76(0x218)][_0x2a2d76(0x1d8)](_0x2a2d76(0x18b))){let _0x9c1b19=_0x263763[_0x2a2d76(0x1fe)];if(!_0x9c1b19)return _0x42aa58['app'][_0x2a2d76(0x1ad)](_0x4ec176,'need\x20play\x20id');if(!hasPermission(_0x42aa58,_0x4ec176,_0x263763))return _0x4ec176[_0x2a2d76(0x183)]({'code':0x66});transCodeUtil['parseVideoFullPath'](_0x42aa58['app'][_0x2a2d76(0x1a9)],_0x42aa58['app'][_0x2a2d76(0x178)],_0x263763)['then'](_0x3f2061=>{const _0x253e4f=_0x2a2d76;let {fullpath:_0x3cd711,duration:_0x5e9de5}=_0x3f2061;fs[_0x253e4f(0x216)](_0x3cd711,fs['constants'][_0x253e4f(0x196)],_0x539c58=>{const _0x158adb=_0x253e4f;if(_0x539c58)return _0x42aa58[_0x158adb(0x172)][_0x158adb(0x1ad)](_0x4ec176,_0x4ec176['__'](_0x158adb(0x20b)));_0x42aa58['app'][_0x158adb(0x178)][_0x158adb(0x19b)]('REPLACE\x20INTO\x20play_record(play_id,args,uid)\x20VALUES(?,?,?)')[_0x158adb(0x1c4)](_0x9c1b19,JSON[_0x158adb(0x17f)](_0x263763),_0x42aa58[_0x158adb(0x205)]['id']),process[_0x158adb(0x1d5)]({'type':_0x158adb(0x1aa),'playId':_0x9c1b19,'args':_0x263763,'action':_0x158adb(0x1c5)}),getM3U8(_0x263763,_0x5e9de5,_0x4ec176);});})[_0x2a2d76(0x1a5)](_0xf7d7db=>{const _0x5bde6b=_0x2a2d76;console[_0x5bde6b(0x19a)](_0x5bde6b(0x1ec),_0xf7d7db),_0x42aa58[_0x5bde6b(0x172)][_0x5bde6b(0x1ad)](_0x4ec176,_0xf7d7db);});}else{if(_0x42aa58['path'][_0x2a2d76(0x1d8)](_0x2a2d76(0x1f1))){if(!hasPermission(_0x42aa58,_0x4ec176,_0x263763))return _0x4ec176['json']({'code':0x66});transCodeUtil[_0x2a2d76(0x1e2)](_0x42aa58['app'][_0x2a2d76(0x1a9)],_0x42aa58[_0x2a2d76(0x172)][_0x2a2d76(0x178)],_0x263763)[_0x2a2d76(0x195)](_0x3b8583=>{const _0x3de584=_0x2a2d76;let {fullpath:_0x1f33a5,streamList:_0x349ebf,needDecrypt:_0x2d5b59,pwd:_0x3956fe}=_0x3b8583;fs[_0x3de584(0x216)](_0x1f33a5,fs['constants']['R_OK'],_0x4fee0d=>{const _0x4dac3b=_0x3de584;if(_0x4fee0d)return _0x42aa58[_0x4dac3b(0x172)]['returnErrMsg'](_0x4ec176,_0x4ec176['__'](_0x4dac3b(0x20b)));MP4FfmpegTrans(_0x42aa58,_0x4ec176,_0x1f33a5,_0x349ebf,_0x2d5b59,_0x3956fe);});})['catch'](_0x489441=>{const _0x20406e=_0x2a2d76;console[_0x20406e(0x19a)](_0x20406e(0x1ec),_0x489441),_0x42aa58[_0x20406e(0x172)][_0x20406e(0x1ad)](_0x4ec176,_0x489441);});}}}}),router['post'](_0x19c486(0x1d7),(_0x28d61f,_0x5a94ff,_0x4929f8)=>{const _0x585ee0=_0x19c486;if(!_0x28d61f[_0x585ee0(0x1a4)][_0x585ee0(0x19c)])return _0x5a94ff[_0x585ee0(0x197)](0x1f4);let _0x5218e3=fileUtil['decodePath'](_0x28d61f['body'][_0x585ee0(0x19c)]),_0x2922ca={'code':0x0,'streams':[],'duration':0x0},_0x95941e=dbConfigTable[_0x585ee0(0x201)](_0x28d61f['app']['dbOther'],'moviePreferLanguage');_0x2922ca[_0x585ee0(0x191)]=_0x95941e?_0x95941e[_0x585ee0(0x1a0)]:_0x585ee0(0x1ca),_0x5218e3=transCodeUtil[_0x585ee0(0x1b0)](_0x5218e3),videoStreamUtil[_0x585ee0(0x20d)](_0x5218e3)['then'](_0x136def=>{const _0x252860=_0x585ee0;_0x2922ca[_0x252860(0x1e4)]=_0x136def['streams'],_0x2922ca['duration']=videoStreamUtil[_0x252860(0x20a)](_0x136def),_0x5a94ff[_0x252860(0x183)](_0x2922ca);})['catch'](_0x40acee=>{const _0x2a7b86=_0x585ee0;return console[_0x2a7b86(0x19a)](_0x40acee),_0x28d61f[_0x2a7b86(0x172)][_0x2a7b86(0x1ad)](_0x5a94ff,_0x40acee);});});function getM3U8(_0x542edd,_0x3c7dc9,_0x492862){const _0x15d490=_0x19c486;let _0x356de0=Math[_0x15d490(0x185)](_0x3c7dc9/config['m3u8segmentDuration']),_0x2c4217=_0x3c7dc9-_0x356de0*_0x3c7dc9;if(_0x2c4217>0x0){try{_0x2c4217=parseInt(_0x2c4217);}catch(_0x3d0416){console[_0x15d490(0x19a)](_0x3d0416);}_0x356de0+=0x1;}let _0x6b6338='#EXTM3U\x0a#EXT-X-PLAYLIST-TYPE:VOD\x20\x20\x20\x20\x20\x20\x20\x20\x0a#EXT-X-VERSION:3\x0a#EXT-X-TARGETDURATION:'+config['m3u8segmentDuration']+_0x15d490(0x202)+_0x542edd[_0x15d490(0x176)]+'\x0a';_0x542edd[_0x15d490(0x176)]&&(segmentStartNum=parseInt(_0x542edd[_0x15d490(0x176)]/config[_0x15d490(0x1ea)]));for(let _0x27e947=0x0;_0x27e947<_0x356de0;_0x27e947++){let _0x1241ca=_0x15d490(0x1f3)+(_0x27e947==_0x356de0-0x1&&_0x2c4217>0x0?_0x2c4217:config[_0x15d490(0x1ea)])+_0x15d490(0x18f)+_0x27e947+_0x15d490(0x193)+_0x542edd[_0x15d490(0x1fe)]+'&token='+_0x542edd[_0x15d490(0x209)]+_0x15d490(0x1be)+_0x27e947;_0x542edd[_0x15d490(0x18d)]&&(_0x1241ca+=_0x15d490(0x1c1)+_0x542edd['size']),_0x542edd[_0x15d490(0x1dc)]&&(_0x1241ca+=_0x15d490(0x1ae)+_0x542edd[_0x15d490(0x1dc)]),_0x542edd[_0x15d490(0x1cf)]&&(_0x1241ca+=_0x15d490(0x207)+_0x542edd['subtitleIndex']),_0x542edd[_0x15d490(0x18a)]&&(_0x1241ca+=_0x15d490(0x210)+_0x542edd[_0x15d490(0x18a)]),_0x542edd[_0x15d490(0x17e)]&&(_0x1241ca+='&audioIndex='+_0x542edd[_0x15d490(0x17e)]),_0x542edd['indexId']&&(_0x1241ca+=_0x15d490(0x1ee)+_0x542edd[_0x15d490(0x1cd)]),_0x542edd['ac']&&(_0x1241ca+=_0x15d490(0x1f8)+_0x542edd['ac']),_0x542edd[_0x15d490(0x19c)]&&(_0x1241ca+=_0x15d490(0x203)+_0x542edd[_0x15d490(0x19c)]),_0x542edd[_0x15d490(0x1f6)]&&(_0x1241ca+=_0x15d490(0x1ba)+_0x542edd[_0x15d490(0x1f6)]),_0x542edd[_0x15d490(0x1c9)]&&(_0x1241ca+='&spaceToken='+_0x542edd['spaceToken']),_0x542edd['spaceIndexId']&&(_0x1241ca+=_0x15d490(0x173)+_0x542edd[_0x15d490(0x21a)]),_0x542edd['burn']&&(_0x1241ca+=_0x15d490(0x190)+_0x542edd[_0x15d490(0x1a7)]),_0x6b6338+=_0x1241ca;}_0x6b6338+=_0x15d490(0x19f),_0x492862[_0x15d490(0x18c)](_0x15d490(0x1d9),_0x15d490(0x1e1));let _0xb40234=new Date()[_0x15d490(0x1b8)]()+_0x15d490(0x17c);_0x492862[_0x15d490(0x18c)](_0x15d490(0x211),_0x15d490(0x1bb)+_0xb40234),_0x492862[_0x15d490(0x1d5)](_0x6b6338);}module[_0x19c486(0x1d6)]=router;