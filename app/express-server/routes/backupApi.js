const _0x1060b1=_0xbddc;(function(_0x3207fb,_0x1f9327){const _0x5c27f7=_0xbddc,_0xd5f8d5=_0x3207fb();while(!![]){try{const _0x3a475b=parseInt(_0x5c27f7(0x110))/0x1*(-parseInt(_0x5c27f7(0x10a))/0x2)+-parseInt(_0x5c27f7(0x125))/0x3+parseInt(_0x5c27f7(0x11b))/0x4+-parseInt(_0x5c27f7(0x147))/0x5+-parseInt(_0x5c27f7(0x102))/0x6+parseInt(_0x5c27f7(0x128))/0x7*(parseInt(_0x5c27f7(0x132))/0x8)+-parseInt(_0x5c27f7(0x10c))/0x9*(-parseInt(_0x5c27f7(0x143))/0xa);if(_0x3a475b===_0x1f9327)break;else _0xd5f8d5['push'](_0xd5f8d5['shift']());}catch(_0x137cdb){_0xd5f8d5['push'](_0xd5f8d5['shift']());}}}(_0x5138,0xba89c));var express=require('express'),router=express['Router']();let path=require('path'),fs=require('fs');function _0xbddc(_0x1fd1b1,_0x3ae032){const _0x5138cb=_0x5138();return _0xbddc=function(_0xbddcb,_0x264b0c){_0xbddcb=_0xbddcb-0x100;let _0x50a6ed=_0x5138cb[_0xbddcb];return _0x50a6ed;},_0xbddc(_0x1fd1b1,_0x3ae032);}const dbBackupTask=require('../../db/dbBackupTask');let moment=require(_0x1060b1(0x12d));function _0x5138(){const _0x323f4b=['\x20task_id=?\x20order\x20by\x20id\x20desc\x20limit\x201','is_admin','\x20task_id=?\x20and\x20(status=\x27stop\x27\x20or\x20status=\x27waiting\x27\x20or\x20status=\x27running\x27)','createRecord','status','3061708WoafcK','noWritePermission','dbOther','create','access','update','\x20status=\x27running\x27\x20or\x20status=\x27waiting\x27','noReadPermission','W_OK','\x20task_id=?\x20and\x20status=\x27running\x27','4453818LmvWzm','initBackupWorker','updateRecord','1554721ulmsyH','delete','returnErrMsg','sourceList','\x20status=\x27waiting\x27','moment','format','taskType','task\x20id\x20is\x20error','taskAlreadyRunning','16oIMPQd','getAllRecordByWhere','getRecordByWhere','json','send','isDirectory','taskAlreadQueued','waiting','post','taskId','/deleteTask','join','cannotUseRootPathAsBackupTarget','stop','body','app','recordId','13688590aeFIgT','constants','test','getAll','2780880nzjrFT','\x20task_id=?\x20and\x20status=\x27done\x27\x20order\x20by\x20id\x20desc\x20limit\x20100','/getTaskRecords','2540988irnPjS','getById','YYYY-MM-DD\x20HH:mm:ss','log','taskName','dialog','targetPath','currentUser','2FheVsU','taskDay','18HrRdEr','\x20task_record_id=?\x20order\x20by\x20id\x20desc\x20limit\x20100','R_OK','getAllByTaskType','719011opQlUk','/createTask','/getRunningTaskList','noGetFolderStat','stringify','/operationTask'];_0x5138=function(){return _0x323f4b;};return _0x5138();}router[_0x1060b1(0x13a)](_0x1060b1(0x111),(_0x5987bb,_0x2bd483,_0xde0296)=>{const _0x5f5677=_0x1060b1;if(_0x5987bb[_0x5f5677(0x109)][_0x5f5677(0x117)]!=0x1)return _0x2bd483[_0x5f5677(0x135)]({'code':0x66});let _0x1d1aa2=_0x5987bb[_0x5f5677(0x140)]['type'],_0x1d234e=_0x5987bb[_0x5f5677(0x140)][_0x5f5677(0x106)],_0x8f2dc0=_0x5987bb[_0x5f5677(0x140)][_0x5f5677(0x12b)],_0x1376cb=_0x5987bb[_0x5f5677(0x140)]['excludeList'],_0x1e361e=path[_0x5f5677(0x13d)](_0x5987bb[_0x5f5677(0x140)][_0x5f5677(0x108)]),_0x1fa1d8=_0x5987bb[_0x5f5677(0x140)][_0x5f5677(0x12f)],_0x4931ca=_0x5987bb['body'][_0x5f5677(0x10b)],_0x48bdbb=_0x5987bb[_0x5f5677(0x140)]['taskTime'];if(/^\w\:\\$/[_0x5f5677(0x145)](_0x1e361e))return _0x5987bb[_0x5f5677(0x141)]['returnErrMsg'](_0x2bd483,_0x2bd483['__'](_0x5f5677(0x13e)),_0x5f5677(0x107));let _0xef12e8=0x0;for(let _0x111d4f in _0x8f2dc0){_0x8f2dc0[_0x111d4f]=path[_0x5f5677(0x13d)](_0x8f2dc0[_0x111d4f]);if(/^\w\:\\$/[_0x5f5677(0x145)](_0x8f2dc0[_0x111d4f]))return _0x5987bb[_0x5f5677(0x141)][_0x5f5677(0x12a)](_0x2bd483,_0x2bd483['__']('cannotUseRootPathAsBackupTarget'),_0x5f5677(0x107));fs[_0x5f5677(0x11f)](_0x8f2dc0[_0x111d4f],fs[_0x5f5677(0x144)][_0x5f5677(0x10e)],_0x26e882=>{const _0xd4a731=_0x5f5677;if(_0x26e882)return _0x5987bb[_0xd4a731(0x141)][_0xd4a731(0x12a)](_0x2bd483,_0x2bd483['__'](_0xd4a731(0x122))+':'+_0x8f2dc0[_0x111d4f]);_0xef12e8+=0x1,_0xef12e8==_0x8f2dc0['length']&&_0x1a5d9d();});}function _0x1a5d9d(){const _0x5f1d8f=_0x5f5677;fs[_0x5f1d8f(0x11f)](_0x1e361e,fs[_0x5f1d8f(0x144)][_0x5f1d8f(0x123)]|fs[_0x5f1d8f(0x144)][_0x5f1d8f(0x10e)],_0x49d57e=>{const _0x9ab432=_0x5f1d8f;if(_0x49d57e)return console[_0x9ab432(0x105)](_0x49d57e),_0x5987bb[_0x9ab432(0x141)]['returnErrMsg'](_0x2bd483,_0x2bd483['__'](_0x9ab432(0x11c))+':'+_0x1e361e);fs['stat'](_0x1e361e,(_0x278589,_0x539992)=>{const _0x10816e=_0x9ab432;if(_0x278589||!_0x539992[_0x10816e(0x137)]())return _0x5987bb[_0x10816e(0x141)][_0x10816e(0x12a)](_0x2bd483,_0x2bd483['__'](_0x10816e(0x113)));let _0x50ad6a={'task_name':_0x1d234e,'source_list':JSON[_0x10816e(0x114)](_0x8f2dc0),'exclude_list':JSON[_0x10816e(0x114)](_0x1376cb),'target_path':_0x1e361e,'task_type':_0x1fa1d8,'task_day':_0x4931ca,'task_time':_0x48bdbb};if(_0x1d1aa2==_0x10816e(0x11e))dbBackupTask[_0x10816e(0x11e)](_0x5987bb['app'][_0x10816e(0x11d)],_0x50ad6a);else{if(_0x1d1aa2==_0x10816e(0x120)){let _0x40dffa=_0x5987bb[_0x10816e(0x140)]['id'];dbBackupTask[_0x10816e(0x120)](_0x5987bb[_0x10816e(0x141)]['dbOther'],_0x50ad6a,_0x40dffa);}}return process[_0x10816e(0x136)]({'type':_0x10816e(0x126)}),_0x2bd483[_0x10816e(0x135)]({'code':0x0});});});}}),router[_0x1060b1(0x13a)](_0x1060b1(0x13c),(_0x13c9c5,_0x416ed1,_0x152081)=>{const _0x55e481=_0x1060b1;if(_0x13c9c5[_0x55e481(0x109)][_0x55e481(0x117)]!=0x1)return _0x416ed1['json']({'code':0x66});let _0x4b4ffe=_0x13c9c5[_0x55e481(0x140)]['id'];dbBackupTask[_0x55e481(0x129)](_0x13c9c5[_0x55e481(0x141)][_0x55e481(0x11d)],_0x4b4ffe),process['send']({'type':_0x55e481(0x126)}),_0x416ed1[_0x55e481(0x135)]({'code':0x0});}),router[_0x1060b1(0x13a)](_0x1060b1(0x115),(_0xa9950,_0x4b7eb8,_0x1a714f)=>{const _0x5b97f5=_0x1060b1;if(_0xa9950['currentUser'][_0x5b97f5(0x117)]!=0x1)return _0x4b7eb8[_0x5b97f5(0x135)]({'code':0x66});let _0xc21a6=_0xa9950['body']['type'],_0x19400d=_0xa9950['body'][_0x5b97f5(0x13b)],_0x287da9=dbBackupTask[_0x5b97f5(0x103)](_0xa9950[_0x5b97f5(0x141)][_0x5b97f5(0x11d)],_0x19400d);if(!_0x287da9)return _0x4b7eb8[_0x5b97f5(0x135)]({'code':0x1,'message':_0x5b97f5(0x130)});if(_0xc21a6=='start'){let _0x10abaa=dbBackupTask[_0x5b97f5(0x134)](_0xa9950[_0x5b97f5(0x141)][_0x5b97f5(0x11d)],_0x5b97f5(0x118),[_0x19400d]);if(_0x10abaa){if(_0x10abaa[_0x5b97f5(0x11a)]==_0x5b97f5(0x139))return _0x4b7eb8[_0x5b97f5(0x135)]({'code':0x1,'message':_0x4b7eb8['__'](_0x5b97f5(0x138)),'task_record':_0x10abaa});else{if(_0x10abaa['status']=='running')return _0x4b7eb8['json']({'code':0x1,'message':_0x4b7eb8['__'](_0x5b97f5(0x131)),'task_record':_0x10abaa});else _0x10abaa[_0x5b97f5(0x11a)]==_0x5b97f5(0x13f)&&dbBackupTask['updateRecord'](_0xa9950[_0x5b97f5(0x141)]['dbOther'],_0x10abaa['id'],_0x5b97f5(0x12c));}}else{let _0x160510=moment()[_0x5b97f5(0x12e)](_0x5b97f5(0x104));dbBackupTask[_0x5b97f5(0x119)](_0xa9950[_0x5b97f5(0x141)][_0x5b97f5(0x11d)],_0x19400d,_0x5b97f5(0x139),_0x160510);}}else{if(_0xc21a6==_0x5b97f5(0x13f)){let _0x145f75=dbBackupTask[_0x5b97f5(0x134)](_0xa9950[_0x5b97f5(0x141)][_0x5b97f5(0x11d)],_0x5b97f5(0x124),[_0x19400d]);if(!_0x145f75)return _0x4b7eb8['json']({'code':0x1,'message':_0x4b7eb8['__']('noRunningTasks'),'task_record':_0x145f75});else dbBackupTask[_0x5b97f5(0x127)](_0xa9950[_0x5b97f5(0x141)][_0x5b97f5(0x11d)],_0x145f75['id'],'\x20status=\x27stop\x27');}}process[_0x5b97f5(0x136)]({'type':_0x5b97f5(0x126)}),_0x4b7eb8[_0x5b97f5(0x135)]({'code':0x0});}),router[_0x1060b1(0x13a)]('/getAllTask',(_0x2bdaaa,_0x212afb,_0x833645)=>{const _0x27adae=_0x1060b1;if(_0x2bdaaa[_0x27adae(0x109)][_0x27adae(0x117)]!=0x1)return _0x212afb[_0x27adae(0x135)]({'code':0x66});let _0x8ff692=_0x2bdaaa[_0x27adae(0x140)]['taskType'],_0x1a846e=[];_0x8ff692=parseInt(_0x8ff692);_0x8ff692?_0x1a846e=dbBackupTask[_0x27adae(0x10f)](_0x2bdaaa['app']['dbOther'],_0x8ff692):_0x1a846e=dbBackupTask[_0x27adae(0x146)](_0x2bdaaa['app'][_0x27adae(0x11d)]);for(let _0x403abe in _0x1a846e){let _0x13a79d=dbBackupTask[_0x27adae(0x134)](_0x2bdaaa[_0x27adae(0x141)][_0x27adae(0x11d)],_0x27adae(0x116),[_0x1a846e[_0x403abe]['id']]);_0x1a846e[_0x403abe]['lastRecord']=_0x13a79d;}_0x212afb['json']({'code':0x0,'data':_0x1a846e});}),router[_0x1060b1(0x13a)]('/getTaskById',(_0x26087d,_0x1ba77f,_0x202ddc)=>{const _0x1bc74e=_0x1060b1;if(_0x26087d[_0x1bc74e(0x109)][_0x1bc74e(0x117)]!=0x1)return _0x1ba77f[_0x1bc74e(0x135)]({'code':0x66});let _0x29e0ec=_0x26087d[_0x1bc74e(0x140)]['id'],_0x21832e=dbBackupTask[_0x1bc74e(0x103)](_0x26087d[_0x1bc74e(0x141)]['dbOther'],_0x29e0ec);_0x1ba77f[_0x1bc74e(0x135)]({'code':0x0,'data':_0x21832e});}),router[_0x1060b1(0x13a)](_0x1060b1(0x101),(_0x568032,_0x31f8c7,_0x2b2b0a)=>{const _0x3809ee=_0x1060b1;if(_0x568032[_0x3809ee(0x109)]['is_admin']!=0x1)return _0x31f8c7[_0x3809ee(0x135)]({'code':0x66});let _0x21d752=_0x568032[_0x3809ee(0x140)]['id'],_0x48f694=dbBackupTask[_0x3809ee(0x133)](_0x568032[_0x3809ee(0x141)][_0x3809ee(0x11d)],_0x3809ee(0x100),[_0x21d752]);_0x31f8c7[_0x3809ee(0x135)]({'code':0x0,'data':_0x48f694});}),router['post']('/getTaskRecordMsg',(_0x19c56e,_0x2dd5cd,_0x24fd91)=>{const _0x255773=_0x1060b1;if(_0x19c56e['currentUser'][_0x255773(0x117)]!=0x1)return _0x2dd5cd[_0x255773(0x135)]({'code':0x66});let _0x101366=_0x19c56e[_0x255773(0x140)][_0x255773(0x142)],_0x41de0e=dbBackupTask['getAllRecordMsgByWhere'](_0x19c56e['app']['dbOther'],_0x255773(0x10d),[_0x101366]);_0x2dd5cd['json']({'code':0x0,'data':_0x41de0e});}),router['post'](_0x1060b1(0x112),(_0x14ce97,_0x24d5a0,_0x4831cb)=>{const _0x4ce990=_0x1060b1;if(_0x14ce97[_0x4ce990(0x109)][_0x4ce990(0x117)]!=0x1)return _0x24d5a0[_0x4ce990(0x135)]({'code':0x66});let _0x3c86ea=_0x14ce97['body'][_0x4ce990(0x142)],_0x467c9d=dbBackupTask[_0x4ce990(0x133)](_0x14ce97[_0x4ce990(0x141)]['dbOther'],_0x4ce990(0x121),[]);_0x24d5a0[_0x4ce990(0x135)]({'code':0x0,'data':_0x467c9d});}),module['exports']=router;